
/home/opus/.pm2/logs/newfacilities-error.log last 15 lines:
0|newfacil |     at ModuleJob._link (node:internal/modules/esm/module_job:130:49) {
0|newfacil |   code: 'ERR_MODULE_NOT_FOUND'
0|newfacil | }
0|newfacil | Error [ERR_MODULE_NOT_FOUND]: Cannot find package 'vite' imported from /home/opus/apps/newfacilities/dist/index.js
0|newfacil |     at packageResolve (node:internal/modules/esm/resolve:873:9)
0|newfacil |     at moduleResolve (node:internal/modules/esm/resolve:946:18)
0|newfacil |     at defaultResolve (node:internal/modules/esm/resolve:1188:11)
0|newfacil |     at ModuleLoader.defaultResolve (node:internal/modules/esm/loader:642:12)
0|newfacil |     at #cachedDefaultResolve (node:internal/modules/esm/loader:591:25)
0|newfacil |     at ModuleLoader.resolve (node:internal/modules/esm/loader:574:38)
0|newfacil |     at ModuleLoader.getModuleJobForImport (node:internal/modules/esm/loader:236:38)
0|newfacil |     at ModuleJob._link (node:internal/modules/esm/module_job:130:49) {
0|newfacil |   code: 'ERR_MODULE_NOT_FOUND'
0|newfacil | }
0|newfacil | Error: ENOENT: no such file or directory, stat '/home/opus/apps/newfacilities/client/dist/index.html'

/home/opus/.pm2/logs/newfacilities-out.log last 15 lines:
0|newfacil | 9:11:44 PM [express] serving on port 3007
0|newfacil | 9:11:47 PM [express] serving on port 3007
0|newfacil | 9:12:53 PM [express] serving on port 3007
0|newfacil | 9:12:58 PM [express] serving on port 3007
0|newfacil | 9:14:09 PM [express] serving on port 3007
0|newfacil | 9:15:16 PM [express] serving on port 3007
0|newfacil | 9:16:22 PM [express] serving on port 3007
0|newfacil | 9:16:46 PM [express] serving on port 3007
0|newfacil | 9:16:48 PM [express] serving on port 3007
0|newfacil | 9:18:45 PM [express] serving on port 3007
0|newfacil | 9:19:21 PM [express] serving on port 3007
0|newfacil | 9:20:19 PM [express] serving on port 3007
0|newfacil | 9:25:22 PM [express] serving on port 3007
0|newfacil | [express] serving on port 3007
0|newfacil | [express] serving on port 3007

^C
opus@opus-virtual-machine:~/apps/newfacilities$ set -euo pipefail
APP_DIR="/home/opus/apps/newfacilities"
cd "$APP_DIR"

echo "==> 0) Garantindo .env com porta e NODE_ENV"
grep -q '^PORT=' .env || echo 'PORT=3007' >> .env
sed -i 's/^PORT=.*/PORT=3007/' .env
grep -q '^NODE_ENV=' .env || echo 'NODE_ENV=production' >> .env
sed -i 's/^NODE_ENV=.*/NODE_ENV=production/' .env

echo "==> 1) Instala deps (inclui dev, pq o build usa vite/esbuild)"
npm ci

echo "==> 2) Ajustes do FRONT (Vite)"
# 2.1 alias @ e @assets no vite.config.ts
if [ -f client/vite.config.ts ]; then
  node - <<'JS'
const fs = require('fs'); const p = 'client/vite.config.ts'
let s = fs.readFileSync(p,'utf8')
if(!s.includes("alias:{'@'") && !s.includes('alias: { "@":')){
  s = s.replace(/defineConfig\(\{([\s\S]*?)\}\)/m, (m) =>
    m.replace(/\}\)\s*$/, `  ,resolve:{ alias:{ "@": new URL('./src', import.meta.url).pathname,
                                               "@assets": new URL('./src/assets', import.meta.url).pathname } }\n})`)
  )
  s = s.replace(/from 'vite'/, "from 'vite'\nimport { fileURLToPath } from 'node:url'")
}
fs.writeFileSync(p,s)
JS
fi

# 2.2 cria componente Toaster se faltar (shadcn/sonner)
if [ ! -f client/src/components/ui/toaster.tsx ]; then
  mkdir -p client/src/components/ui
  cat > client/src/components/ui/toaster.tsx <<'TSX'
import { Toaster as Sonner } from "sonner";
export default function Toaster() {
  return <Sonner richColors closeButton />;
}
TSX
echo "==> FIM. Abra o site e teste."load nginx\.1\|localhost\):[0-9]\+#proxy_pass http://127.0.0.1:3007#' "$NGX_FILE")
==> 0) Garantindo .env com porta e NODE_ENV
==> 1) Instala deps (inclui dev, pq o build usa vite/esbuild)
npm warn deprecated @esbuild-kit/esm-loader@2.6.5: Merged into tsx: https://tsx.is
npm warn deprecated @esbuild-kit/core-utils@3.3.2: Merged into tsx: https://tsx.is

added 596 packages, and audited 597 packages in 13s

73 packages are looking for funding
  run `npm fund` for details

10 vulnerabilities (3 low, 6 moderate, 1 high)

To address issues that do not require attention, run:
  npm audit fix

To address all issues possible (including breaking changes), run:
  npm audit fix --force

Some issues need review, and may require choosing
a different dependency.

Run `npm audit` for details.
==> 2) Ajustes do FRONT (Vite)
==> 3) Build do FRONT
npm warn deprecated @esbuild-kit/esm-loader@2.6.5: Merged into tsx: https://tsx.is
npm warn deprecated @esbuild-kit/core-utils@3.3.2: Merged into tsx: https://tsx.is

added 596 packages, and audited 597 packages in 13s

73 packages are looking for funding
  run `npm fund` for details

10 vulnerabilities (3 low, 6 moderate, 1 high)

To address issues that do not require attention, run:
  npm audit fix

To address all issues possible (including breaking changes), run:
  npm audit fix --force

Some issues need review, and may require choosing
a different dependency.

Run `npm audit` for details.

> rest-express@1.0.0 build
> vite build && esbuild server/index.ts --platform=node --packages=external --bundle --format=esm --outdir=dist

vite v5.4.20 building for production...
transforming (3) src/main.tsxBrowserslist: browsers data (caniuse-lite) is 12 months old. Please run:
  npx update-browserslist-db@latest
  Why you should do it regularly: https://github.com/browserslist/update-db#readme
✓ 3856 modules transformed.
dist/index.html                                    2.18 kB │ gzip:   0.85 kB
dist/assets/index-D39V0s_1.css                   117.59 kB │ gzip:  17.92 kB
dist/assets/purify.es-BFmuJLeH.js                 21.93 kB │ gzip:   8.62 kB
dist/assets/qr-scanner-worker.min-D85Z9gVD.js     43.95 kB │ gzip:  10.46 kB
dist/assets/index.es-BtLytKSp.js                 150.53 kB │ gzip:  51.48 kB
dist/assets/html2canvas.esm-CBrSDip1.js          201.42 kB │ gzip:  48.03 kB
dist/assets/index-mJDw4-tr.js                  2,143.61 kB │ gzip: 609.30 kB

(!) Some chunks are larger than 500 kB after minification. Consider:
- Using dynamic import() to code-split the application
- Use build.rollupOptions.output.manualChunks to improve chunking: https://rollupjs.org/configuration-options/#output-manualchunks
- Adjust chunk size limit for this warning via build.chunkSizeWarningLimit.
✓ built in 22.86s

  dist/index.js  905b

⚡ Done in 4ms

> rest-express@1.0.0 postbuild
> npm run db:push && npm run db:seed


> rest-express@1.0.0 db:push
> drizzle-kit push

No config path provided, using default 'drizzle.config.ts'
Reading config file '/home/opus/apps/newfacilities/drizzle.config.ts'
Using 'pg' driver for database querying
[✓] Pulling schema from database...
[✓] Changes applied

> rest-express@1.0.0 db:seed
> tsx server/seed.ts

/home/opus/apps/newfacilities/server/db.ts:6
  throw new Error(
        ^


Error: DATABASE_URL must be set. Did you forget to provision a database?
    at <anonymous> (/home/opus/apps/newfacilities/server/db.ts:6:9)
    at ModuleJob.run (node:internal/modules/esm/module_job:263:25)
    at async ModuleLoader.import (node:internal/modules/esm/loader:540:24)
    at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)

Node.js v20.19.4
Connection to 192.168.13.80 closed.

C:\Users\Lacerda>ssh opus@192.168.13.80
opus@192.168.13.80's password:
Welcome to Ubuntu 22.04.5 LTS (GNU/Linux 6.8.0-84-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/pro

Manutenção de Segurança Expandida para Applications não está ativa.

25 as atualizações podem ser aplicadas imediatamente.
Para ver as actualizações adicionais corre o comando: apt list --upgradable

11 atualizações de segurança adicionais podem ser aplicadas com ESM Apps.
Saiba mais sobre como ativar o serviço ESM Apps at https://ubuntu.com/esm

New release '24.04.3 LTS' available.
Run 'do-release-upgrade' to upgrade to it.

*** System restart required ***
Last login: Wed Oct  8 21:42:21 2025 from 192.168.13.37
opus@opus-virtual-machine:~$ set -euo pipefail
APP_DIR="/home/opus/apps/newfacilities"
cd "$APP_DIR"

# 1) garanta que .env existe e contém PORT e DATABASE_URL
grep -n '^PORT=' .env || echo "PORT=3007" >> .env
sed -i 's/^PORT=.*/PORT=3007/' .env
grep -n '^DATABASE_URL=' .env || { echo "Faltou DATABASE_URL no .env!"; exit 1; }
grep -n '^NODE_ENV=' .env || echo "NODE_ENV=production" >> .env
sed -i 's/^NODE_ENV=.*/NODE_ENV=production/' .env

# 2) instalar dependências (pode manter dev deps; precisamos de vite)
npm ci

# 3) BUILD do FRONT end (gera client/dist)
cd client
npm ci
npx vite build
cd ..

# 4) BUILD do SERVER direto (sem disparar 'postbuild')
rm -rf dist
npx esbuild server/index.ts --platform=node --packages=external --bundle --format=esm --outdir=dist

# 5) subir pelo PM2 (production, porta 3007)
cat > ecosystem.config.cjs <<'CJS'
module.exports = {
  apps: [{
    name: "newfacilities",
    script: "./dist/index.js",
    cwd: "/home/opus/apps/newfacilities",
    env: { NODE_ENV: "production", PORT: "3007" }
  }]
}
CJS

pm2 delete newfacilities || true
pm2 start ecosystem.config.cjs --update-env
 nginx -t && sudo systemctl reload nginx; }y_pass http://\(127\.0\.0\.1\|localhost\):[0-9]\+#proxy_pass http://127.0.0.1:3007#' "$NGX_FILE"; sudo
1:PORT=3007
3:DATABASE_URL=postgresql://opus_app:Opus%402025@127.0.0.1:5432/opusclean?options=-c%20TimeZone%3DAmerica%2FSao_Paulo
2:NODE_ENV=production
npm warn deprecated @esbuild-kit/esm-loader@2.6.5: Merged into tsx: https://tsx.is
npm warn deprecated @esbuild-kit/core-utils@3.3.2: Merged into tsx: https://tsx.is

added 596 packages, and audited 597 packages in 13s

73 packages are looking for funding
  run `npm fund` for details

10 vulnerabilities (3 low, 6 moderate, 1 high)

To address issues that do not require attention, run:
  npm audit fix

To address all issues possible (including breaking changes), run:
  npm audit fix --force

Some issues need review, and may require choosing
a different dependency.

Run `npm audit` for details.
npm warn deprecated @esbuild-kit/esm-loader@2.6.5: Merged into tsx: https://tsx.is
npm warn deprecated @esbuild-kit/core-utils@3.3.2: Merged into tsx: https://tsx.is

added 596 packages, and audited 597 packages in 12s

73 packages are looking for funding
  run `npm fund` for details

10 vulnerabilities (3 low, 6 moderate, 1 high)

To address issues that do not require attention, run:
  npm audit fix

To address all issues possible (including breaking changes), run:
  npm audit fix --force

Some issues need review, and may require choosing
a different dependency.

Run `npm audit` for details.
vite v5.4.20 building for production...
✓ 4 modules transformed.
x Build failed in 489ms
error during build:
[vite]: Rollup failed to resolve import "@/components/ui/toaster" from "/home/opus/apps/newfacilities/client/src/App.tsx".
This is most likely unintended because it can break your application at runtime.
If you do want to externalize this module explicitly add it to
`build.rollupOptions.external`
    at viteWarn (file:///home/opus/apps/newfacilities/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:65854:17)
    at onRollupWarning (file:///home/opus/apps/newfacilities/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:65886:5)
    at onwarn (file:///home/opus/apps/newfacilities/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:65549:7)
    at file:///home/opus/apps/newfacilities/node_modules/rollup/dist/es/shared/node-entry.js:19452:13
    at Object.logger [as onLog] (file:///home/opus/apps/newfacilities/node_modules/rollup/dist/es/shared/node-entry.js:21178:9)
    at ModuleLoader.handleInvalidResolvedId (file:///home/opus/apps/newfacilities/node_modules/rollup/dist/es/shared/node-entry.js:20067:26)
    at file:///home/opus/apps/newfacilities/node_modules/rollup/dist/es/shared/node-entry.js:20025:26