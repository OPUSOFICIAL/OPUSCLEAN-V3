{"file_contents":{"client/src/components/ui/menubar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as MenubarPrimitive from \"@radix-ui/react-menubar\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction MenubarMenu({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {\n  return <MenubarPrimitive.Menu {...props} />\n}\n\nfunction MenubarGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Group>) {\n  return <MenubarPrimitive.Group {...props} />\n}\n\nfunction MenubarPortal({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {\n  return <MenubarPrimitive.Portal {...props} />\n}\n\nfunction MenubarRadioGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {\n  return <MenubarPrimitive.RadioGroup {...props} />\n}\n\nfunction MenubarSub({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {\n  return <MenubarPrimitive.Sub data-slot=\"menubar-sub\" {...props} />\n}\n\nconst Menubar = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"flex h-10 items-center space-x-1 rounded-md border bg-background p-1\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubar.displayName = MenubarPrimitive.Root.displayName\n\nconst MenubarTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName\n\nconst MenubarSubTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <MenubarPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </MenubarPrimitive.SubTrigger>\n))\nMenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName\n\nconst MenubarSubContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName\n\nconst MenubarContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>\n>(\n  (\n    { className, align = \"start\", alignOffset = -4, sideOffset = 8, ...props },\n    ref\n  ) => (\n    <MenubarPrimitive.Portal>\n      <MenubarPrimitive.Content\n        ref={ref}\n        align={align}\n        alignOffset={alignOffset}\n        sideOffset={sideOffset}\n        className={cn(\n          \"z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n          className\n        )}\n        {...props}\n      />\n    </MenubarPrimitive.Portal>\n  )\n)\nMenubarContent.displayName = MenubarPrimitive.Content.displayName\n\nconst MenubarItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarItem.displayName = MenubarPrimitive.Item.displayName\n\nconst MenubarCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <MenubarPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.CheckboxItem>\n))\nMenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName\n\nconst MenubarRadioItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <MenubarPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.RadioItem>\n))\nMenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName\n\nconst MenubarLabel = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarLabel.displayName = MenubarPrimitive.Label.displayName\n\nconst MenubarSeparator = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nMenubarSeparator.displayName = MenubarPrimitive.Separator.displayName\n\nconst MenubarShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nMenubarShortcut.displayname = \"MenubarShortcut\"\n\nexport {\n  Menubar,\n  MenubarMenu,\n  MenubarTrigger,\n  MenubarContent,\n  MenubarItem,\n  MenubarSeparator,\n  MenubarLabel,\n  MenubarCheckboxItem,\n  MenubarRadioGroup,\n  MenubarRadioItem,\n  MenubarPortal,\n  MenubarSubContent,\n  MenubarSubTrigger,\n  MenubarGroup,\n  MenubarSub,\n  MenubarShortcut,\n}\n","size_bytes":8605},"shared/schema.ts":{"content":"import { sql } from \"drizzle-orm\";\nimport { pgTable, text, varchar, integer, timestamp, boolean, decimal, jsonb, pgEnum, uniqueIndex, unique, date, time } from \"drizzle-orm/pg-core\";\nimport { relations } from \"drizzle-orm\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\n\n// Enums baseados no backup real\nexport const userRoleEnum = pgEnum('user_role', ['admin', 'gestor_cliente', 'supervisor_site', 'operador', 'auditor']);\nexport const userTypeEnum = pgEnum('user_type', ['opus_user', 'customer_user']);\nexport const authProviderEnum = pgEnum('auth_provider', ['local', 'microsoft']);\nexport const workOrderStatusEnum = pgEnum('work_order_status', ['aberta', 'em_execucao', 'pausada', 'vencida', 'concluida', 'cancelada']);\nexport const workOrderTypeEnum = pgEnum('work_order_type', ['programada', 'corretiva_interna', 'corretiva_publica']);\nexport const priorityEnum = pgEnum('priority', ['baixa', 'media', 'alta', 'critica']);\nexport const qrCodeTypeEnum = pgEnum('qr_code_type', ['execucao', 'atendimento']);\nexport const frequencyEnum = pgEnum('frequency', ['diaria', 'semanal', 'mensal', 'trimestral', 'semestral', 'anual', 'turno', 'custom']);\nexport const bathroomCounterActionEnum = pgEnum('bathroom_counter_action', ['increment', 'decrement', 'reset']);\nexport const moduleEnum = pgEnum('module', ['clean', 'maintenance']);\nexport const equipmentStatusEnum = pgEnum('equipment_status', ['operacional', 'em_manutencao', 'inoperante', 'aposentado']);\n\n// Sistema de permissões granulares\nexport const permissionKeyEnum = pgEnum('permission_key', [\n  'dashboard_view',\n  'workorders_view',\n  'workorders_create', \n  'workorders_edit',\n  'workorders_delete',\n  'workorders_comment',\n  'workorders_evaluate',\n  'schedule_view',\n  'schedule_create',\n  'schedule_edit', \n  'schedule_delete',\n  'checklists_view',\n  'checklists_create',\n  'checklists_edit',\n  'checklists_delete',\n  'qrcodes_view',\n  'qrcodes_create',\n  'qrcodes_edit',\n  'qrcodes_delete',\n  'floor_plan_view',\n  'floor_plan_edit',\n  'heatmap_view',\n  'sites_view',\n  'sites_create',\n  'sites_edit',\n  'sites_delete',\n  'users_view',\n  'users_create',\n  'users_edit',\n  'users_delete',\n  'customers_view',\n  'customers_create',\n  'customers_edit',\n  'customers_delete',\n  'reports_view',\n  'audit_logs_view',\n  'service_settings_view',\n  'service_settings_edit',\n  'roles_manage',\n  'opus_users_view',\n  'opus_users_create',\n  'opus_users_edit',\n  'opus_users_delete',\n  'client_users_view',\n  'client_users_create',\n  'client_users_edit',\n  'client_users_delete'\n]);\n\n// 1. TABELA: companies (Empresas)\nexport const companies = pgTable(\"companies\", {\n  id: varchar(\"id\").primaryKey(),\n  name: varchar(\"name\").notNull(),\n  cnpj: varchar(\"cnpj\"),\n  email: varchar(\"email\"),\n  phone: varchar(\"phone\"),\n  address: varchar(\"address\"),\n  isActive: boolean(\"is_active\").default(true),\n  createdAt: timestamp(\"created_at\").default(sql`now()`),\n  updatedAt: timestamp(\"updated_at\").default(sql`now()`),\n});\n\n// 2. TABELA: customers (Clientes/Contratantes)\nexport const customers = pgTable(\"customers\", {\n  id: varchar(\"id\").primaryKey(),\n  companyId: varchar(\"company_id\").notNull().references(() => companies.id),\n  name: varchar(\"name\").notNull(),\n  email: varchar(\"email\"),\n  phone: varchar(\"phone\"),\n  document: varchar(\"document\"),\n  address: varchar(\"address\"),\n  city: varchar(\"city\"),\n  state: varchar(\"state\"),\n  zipCode: varchar(\"zip_code\"),\n  contactPerson: varchar(\"contact_person\"),\n  notes: text(\"notes\"),\n  modules: text(\"modules\").array().notNull().default(sql`ARRAY['clean']::text[]`),\n  isActive: boolean(\"is_active\").default(true),\n  createdAt: timestamp(\"created_at\").default(sql`now()`),\n  updatedAt: timestamp(\"updated_at\").default(sql`now()`),\n});\n\n// 3. TABELA: sites (Locais)\nexport const sites = pgTable(\"sites\", {\n  id: varchar(\"id\").primaryKey(),\n  companyId: varchar(\"company_id\").notNull().references(() => companies.id),\n  customerId: varchar(\"customer_id\").references(() => customers.id),\n  module: moduleEnum(\"module\").notNull().default('clean'),\n  name: varchar(\"name\").notNull(),\n  address: varchar(\"address\"),\n  description: text(\"description\"),\n  floorPlanImageUrl: varchar(\"floor_plan_image_url\"),\n  isActive: boolean(\"is_active\").default(true),\n  createdAt: timestamp(\"created_at\").default(sql`now()`),\n  updatedAt: timestamp(\"updated_at\").default(sql`now()`),\n});\n\n// 4. TABELA: zones (Zonas/Áreas)\nexport const zones = pgTable(\"zones\", {\n  id: varchar(\"id\").primaryKey(),\n  siteId: varchar(\"site_id\").notNull().references(() => sites.id),\n  module: moduleEnum(\"module\").notNull().default('clean'),\n  name: varchar(\"name\").notNull(),\n  description: text(\"description\"),\n  areaM2: decimal(\"area_m2\", { precision: 10, scale: 2 }),\n  capacity: integer(\"capacity\"),\n  category: varchar(\"category\"),\n  positionX: decimal(\"position_x\", { precision: 5, scale: 2 }),\n  positionY: decimal(\"position_y\", { precision: 5, scale: 2 }),\n  sizeScale: decimal(\"size_scale\", { precision: 3, scale: 2 }),\n  color: varchar(\"color\"),\n  isActive: boolean(\"is_active\").default(true),\n  createdAt: timestamp(\"created_at\").default(sql`now()`),\n  updatedAt: timestamp(\"updated_at\").default(sql`now()`),\n});\n\n// 5. TABELA: users (Usuários do Sistema)\nexport const users = pgTable(\"users\", {\n  id: varchar(\"id\").primaryKey(),\n  companyId: varchar(\"company_id\").references(() => companies.id),\n  customerId: varchar(\"customer_id\").references(() => customers.id),\n  username: varchar(\"username\").notNull().unique(),\n  email: varchar(\"email\").notNull().unique(),\n  password: varchar(\"password\"),\n  name: varchar(\"name\").notNull(),\n  role: userRoleEnum(\"role\").notNull(),\n  userType: userTypeEnum(\"user_type\").notNull().default('opus_user'),\n  assignedClientId: varchar(\"assigned_client_id\"),\n  authProvider: authProviderEnum(\"auth_provider\").default('local'),\n  externalId: varchar(\"external_id\"),\n  msTenantId: varchar(\"ms_tenant_id\"),\n  modules: text(\"modules\").array().notNull().default(sql`ARRAY['clean']::text[]`),\n  isActive: boolean(\"is_active\").default(true),\n  createdAt: timestamp(\"created_at\").default(sql`now()`),\n  updatedAt: timestamp(\"updated_at\").default(sql`now()`),\n});\n\n// 6. TABELA: service_types (Tipos de Serviço)\nexport const serviceTypes = pgTable(\"service_types\", {\n  id: varchar(\"id\").primaryKey(),\n  name: varchar(\"name\").notNull(),\n  description: text(\"description\"),\n  code: varchar(\"code\").notNull().unique(),\n  module: moduleEnum(\"module\").notNull().default('clean'),\n  isActive: boolean(\"is_active\").default(true),\n  createdAt: timestamp(\"created_at\").default(sql`now()`),\n  updatedAt: timestamp(\"updated_at\").default(sql`now()`),\n  customerId: varchar(\"customer_id\").references(() => customers.id),\n});\n\n// 7. TABELA: service_categories (Categorias de Serviço)\nexport const serviceCategories = pgTable(\"service_categories\", {\n  id: varchar(\"id\").primaryKey(),\n  typeId: varchar(\"type_id\").references(() => serviceTypes.id),\n  name: varchar(\"name\").notNull(),\n  description: text(\"description\"),\n  code: varchar(\"code\").notNull().unique(),\n  module: moduleEnum(\"module\").notNull().default('clean'),\n  isActive: boolean(\"is_active\").default(true),\n  createdAt: timestamp(\"created_at\").default(sql`now()`),\n  updatedAt: timestamp(\"updated_at\").default(sql`now()`),\n  customerId: varchar(\"customer_id\").references(() => customers.id),\n});\n\n// 8. TABELA: services (Serviços Disponíveis)\nexport const services = pgTable(\"services\", {\n  id: varchar(\"id\").primaryKey(),\n  name: varchar(\"name\").notNull(),\n  description: text(\"description\"),\n  estimatedDurationMinutes: integer(\"estimated_duration_minutes\"),\n  priority: priorityEnum(\"priority\").default('media'),\n  requirements: text(\"requirements\"),\n  module: moduleEnum(\"module\").notNull().default('clean'),\n  isActive: boolean(\"is_active\").default(true),\n  createdAt: timestamp(\"created_at\").default(sql`now()`),\n  updatedAt: timestamp(\"updated_at\").default(sql`now()`),\n  customerId: varchar(\"customer_id\").references(() => customers.id),\n  categoryId: varchar(\"category_id\").references(() => serviceCategories.id),\n  typeId: varchar(\"type_id\").references(() => serviceTypes.id),\n});\n\n// 9. TABELA: cleaning_activities (Atividades de Limpeza)\nexport const cleaningActivities = pgTable(\"cleaning_activities\", {\n  id: varchar(\"id\").primaryKey(),\n  companyId: varchar(\"company_id\").notNull().references(() => companies.id),\n  serviceId: varchar(\"service_id\").references(() => services.id),\n  siteId: varchar(\"site_id\").references(() => sites.id),\n  zoneId: varchar(\"zone_id\").references(() => zones.id),\n  name: varchar(\"name\").notNull(),\n  description: text(\"description\"),\n  frequency: frequencyEnum(\"frequency\").notNull(),\n  frequencyConfig: jsonb(\"frequency_config\"),\n  module: moduleEnum(\"module\").notNull().default('clean'),\n  checklistTemplateId: varchar(\"checklist_template_id\").references(() => checklistTemplates.id),\n  slaConfigId: varchar(\"sla_config_id\").references(() => slaConfigs.id),\n  isActive: boolean(\"is_active\").default(true),\n  createdAt: timestamp(\"created_at\").default(sql`now()`),\n  updatedAt: timestamp(\"updated_at\").default(sql`now()`),\n  startTime: time(\"start_time\"),\n  endTime: time(\"end_time\"),\n});\n\n// 10. TABELA: checklist_templates (Templates de Checklist)\nexport const checklistTemplates = pgTable(\"checklist_templates\", {\n  id: varchar(\"id\").primaryKey(),\n  companyId: varchar(\"company_id\").notNull().references(() => companies.id),\n  serviceId: varchar(\"service_id\").references(() => services.id),\n  siteId: varchar(\"site_id\").references(() => sites.id),\n  name: varchar(\"name\").notNull(),\n  description: text(\"description\"),\n  items: jsonb(\"items\").notNull(),\n  module: moduleEnum(\"module\").notNull().default('clean'),\n  createdAt: timestamp(\"created_at\").default(sql`now()`),\n  updatedAt: timestamp(\"updated_at\").default(sql`now()`),\n  zoneId: varchar(\"zone_id\").references(() => zones.id),\n});\n\n// 11. TABELA: work_orders (Ordens de Trabalho)\nexport const workOrders = pgTable(\"work_orders\", {\n  id: varchar(\"id\").primaryKey(),\n  number: integer(\"number\").notNull(),\n  companyId: varchar(\"company_id\").notNull().references(() => companies.id),\n  module: moduleEnum(\"module\").notNull().default('clean'),\n  zoneId: varchar(\"zone_id\").references(() => zones.id),\n  serviceId: varchar(\"service_id\").references(() => services.id),\n  cleaningActivityId: varchar(\"cleaning_activity_id\").references(() => cleaningActivities.id),\n  maintenanceActivityId: varchar(\"maintenance_activity_id\").references(() => maintenanceActivities.id),\n  checklistTemplateId: varchar(\"checklist_template_id\").references(() => checklistTemplates.id),\n  maintenanceChecklistTemplateId: varchar(\"maintenance_checklist_template_id\").references(() => maintenanceChecklistTemplates.id),\n  equipmentId: varchar(\"equipment_id\").references(() => equipment.id),\n  maintenancePlanEquipmentId: varchar(\"maintenance_plan_equipment_id\").references(() => maintenancePlanEquipments.id),\n  type: workOrderTypeEnum(\"type\").notNull(),\n  status: workOrderStatusEnum(\"status\").notNull().default('aberta'),\n  priority: priorityEnum(\"priority\").notNull().default('media'),\n  title: varchar(\"title\").notNull(),\n  description: text(\"description\"),\n  assignedUserId: varchar(\"assigned_user_id\").references(() => users.id),\n  origin: varchar(\"origin\"),\n  qrCodePointId: varchar(\"qr_code_point_id\").references(() => qrCodePoints.id),\n  requesterName: varchar(\"requester_name\"),\n  requesterContact: varchar(\"requester_contact\"),\n  scheduledDate: date(\"scheduled_date\"),\n  dueDate: date(\"due_date\"),\n  scheduledStartAt: timestamp(\"scheduled_start_at\"),\n  scheduledEndAt: timestamp(\"scheduled_end_at\"),\n  startedAt: timestamp(\"started_at\"),\n  completedAt: timestamp(\"completed_at\"),\n  estimatedHours: decimal(\"estimated_hours\", { precision: 5, scale: 2 }),\n  slaStartMinutes: integer(\"sla_start_minutes\"),\n  slaCompleteMinutes: integer(\"sla_complete_minutes\"),\n  observations: text(\"observations\"),\n  checklistData: jsonb(\"checklist_data\"),\n  attachments: jsonb(\"attachments\"),\n  customerRating: integer(\"customer_rating\"),\n  customerRatingComment: text(\"customer_rating_comment\"),\n  ratedAt: timestamp(\"rated_at\"),\n  ratedBy: varchar(\"rated_by\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").default(sql`now()`),\n  updatedAt: timestamp(\"updated_at\").default(sql`now()`),\n}, (table) => ({\n  uniqueWorkOrderNumber: uniqueIndex(\"work_orders_company_number_unique\").on(table.companyId, table.number),\n}));\n\n// 12. TABELA: audit_logs (Logs de Auditoria)\nexport const auditLogs = pgTable(\"audit_logs\", {\n  id: varchar(\"id\").primaryKey(),\n  companyId: varchar(\"company_id\").references(() => companies.id),\n  userId: varchar(\"user_id\").references(() => users.id),\n  entityType: varchar(\"entity_type\").notNull(),\n  entityId: varchar(\"entity_id\").notNull(),\n  action: varchar(\"action\").notNull(),\n  changes: jsonb(\"changes\"),\n  metadata: jsonb(\"metadata\"),\n  timestamp: timestamp(\"timestamp\").default(sql`now()`),\n  createdAt: timestamp(\"created_at\").default(sql`now()`),\n});\n\n// 13. TABELA: dashboard_goals (Metas do Dashboard)\nexport const dashboardGoals = pgTable(\"dashboard_goals\", {\n  id: varchar(\"id\").primaryKey(),\n  companyId: varchar(\"company_id\").notNull().references(() => companies.id),\n  module: moduleEnum(\"module\").notNull().default('clean'),\n  goalType: varchar(\"goal_type\").notNull(),\n  goalValue: decimal(\"goal_value\", { precision: 10, scale: 2 }).notNull(),\n  currentPeriod: varchar(\"current_period\").notNull(),\n  isActive: boolean(\"is_active\").default(true),\n  createdAt: timestamp(\"created_at\").default(sql`now()`),\n  updatedAt: timestamp(\"updated_at\").default(sql`now()`),\n});\n\n// 14. TABELA: custom_roles (Roles Customizados)\nexport const customRoles = pgTable(\"custom_roles\", {\n  id: varchar(\"id\").primaryKey(),\n  companyId: varchar(\"company_id\").notNull().references(() => companies.id),\n  name: varchar(\"name\").notNull(),\n  description: text(\"description\"),\n  isSystemRole: boolean(\"is_system_role\").default(false),\n  isActive: boolean(\"is_active\").default(true),\n  createdAt: timestamp(\"created_at\").default(sql`now()`),\n  updatedAt: timestamp(\"updated_at\").default(sql`now()`),\n});\n\n// 15. TABELA: role_permissions (Permissões por Role)\nexport const rolePermissions = pgTable(\"role_permissions\", {\n  id: varchar(\"id\").primaryKey(),\n  roleId: varchar(\"role_id\").notNull().references(() => customRoles.id),\n  permission: permissionKeyEnum(\"permission\").notNull(),\n  createdAt: timestamp(\"created_at\").default(sql`now()`),\n});\n\n// 16. TABELA: user_role_assignments (Usuários x Roles)\nexport const userRoleAssignments = pgTable(\"user_role_assignments\", {\n  id: varchar(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  roleId: varchar(\"role_id\").notNull().references(() => customRoles.id),\n  customerId: varchar(\"customer_id\").references(() => customers.id),\n  createdAt: timestamp(\"created_at\").default(sql`now()`),\n});\n\n// 17. TABELA: user_site_assignments (Usuários x Locais)\nexport const userSiteAssignments = pgTable(\"user_site_assignments\", {\n  id: varchar(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  siteId: varchar(\"site_id\").notNull().references(() => sites.id),\n  createdAt: timestamp(\"created_at\").default(sql`now()`),\n  updatedAt: timestamp(\"updated_at\").default(sql`now()`),\n});\n\n// 18. TABELA: site_shifts (Turnos por Local)\nexport const siteShifts = pgTable(\"site_shifts\", {\n  id: varchar(\"id\").primaryKey(),\n  siteId: varchar(\"site_id\").notNull().references(() => sites.id),\n  name: varchar(\"name\").notNull(),\n  startTime: time(\"start_time\").notNull(),\n  endTime: time(\"end_time\").notNull(),\n  isActive: boolean(\"is_active\").default(true),\n  createdAt: timestamp(\"created_at\").default(sql`now()`),\n  updatedAt: timestamp(\"updated_at\").default(sql`now()`),\n});\n\n// 19. TABELA: sla_configs (Configurações de SLA)\nexport const slaConfigs = pgTable(\"sla_configs\", {\n  id: varchar(\"id\").primaryKey(),\n  companyId: varchar(\"company_id\").notNull().references(() => companies.id),\n  name: varchar(\"name\").notNull(),\n  category: varchar(\"category\"),\n  module: moduleEnum(\"module\").notNull().default('clean'),\n  timeToStartMinutes: integer(\"time_to_start_minutes\").notNull(),\n  timeToCompleteMinutes: integer(\"time_to_complete_minutes\").notNull(),\n  createdAt: timestamp(\"created_at\").default(sql`now()`),\n  updatedAt: timestamp(\"updated_at\").default(sql`now()`),\n});\n\n// 20. TABELA: webhook_configs (Configurações de Webhooks)\nexport const webhookConfigs = pgTable(\"webhook_configs\", {\n  id: varchar(\"id\").primaryKey(),\n  companyId: varchar(\"company_id\").notNull().references(() => companies.id),\n  name: varchar(\"name\").notNull(),\n  url: varchar(\"url\").notNull(),\n  events: jsonb(\"events\").notNull(),\n  isActive: boolean(\"is_active\").default(true),\n  createdAt: timestamp(\"created_at\").default(sql`now()`),\n  updatedAt: timestamp(\"updated_at\").default(sql`now()`),\n});\n\n// 21. TABELA: company_counters (Contadores da Empresa)\nexport const companyCounters = pgTable(\"company_counters\", {\n  id: varchar(\"id\").primaryKey(),\n  companyId: varchar(\"company_id\").notNull().references(() => companies.id),\n  key: varchar(\"key\").notNull(),\n  nextNumber: integer(\"next_number\").notNull().default(1),\n  updatedAt: timestamp(\"updated_at\").default(sql`now()`),\n});\n\n// 22. TABELA: qr_code_points (Pontos de QR Code)\nexport const qrCodePoints = pgTable(\"qr_code_points\", {\n  id: varchar(\"id\").primaryKey(),\n  zoneId: varchar(\"zone_id\").references(() => zones.id),\n  equipmentId: varchar(\"equipment_id\").references(() => equipment.id),\n  serviceId: varchar(\"service_id\").references(() => services.id),\n  code: varchar(\"code\").notNull().unique(),\n  type: qrCodeTypeEnum(\"type\").notNull(),\n  name: varchar(\"name\").notNull(),\n  description: text(\"description\"),\n  sizeCm: integer(\"size_cm\").default(5), // Tamanho em centímetros (padrão 5cm)\n  module: moduleEnum(\"module\").notNull().default('clean'),\n  isActive: boolean(\"is_active\").default(true),\n  createdAt: timestamp(\"created_at\").default(sql`now()`),\n  updatedAt: timestamp(\"updated_at\").default(sql`now()`),\n});\n\n// 23. TABELA: service_zones (Serviços x Zonas)\nexport const serviceZones = pgTable(\"service_zones\", {\n  id: varchar(\"id\").primaryKey(),\n  serviceId: varchar(\"service_id\").notNull().references(() => services.id),\n  zoneId: varchar(\"zone_id\").notNull().references(() => zones.id),\n  isActive: boolean(\"is_active\").default(true),\n  createdAt: timestamp(\"created_at\").default(sql`now()`),\n  updatedAt: timestamp(\"updated_at\").default(sql`now()`),\n}, (table) => ({\n  uniqueServiceZone: unique(\"unique_service_zone\").on(table.serviceId, table.zoneId),\n}));\n\n// 24. TABELA: bathroom_counters (Contadores de Banheiro)\nexport const bathroomCounters = pgTable(\"bathroom_counters\", {\n  id: varchar(\"id\").primaryKey(),\n  zoneId: varchar(\"zone_id\").notNull().references(() => zones.id),\n  currentCount: integer(\"current_count\").default(0),\n  limitCount: integer(\"limit_count\").notNull(),\n  lastReset: timestamp(\"last_reset\").default(sql`now()`),\n  autoResetTurn: boolean(\"auto_reset_turn\").default(true),\n  createdAt: timestamp(\"created_at\").default(sql`now()`),\n  updatedAt: timestamp(\"updated_at\").default(sql`now()`),\n});\n\n// 25. TABELA: bathroom_counter_logs (Logs dos Contadores)\nexport const bathroomCounterLogs = pgTable(\"bathroom_counter_logs\", {\n  id: varchar(\"id\").primaryKey(),\n  counterId: varchar(\"counter_id\").notNull().references(() => bathroomCounters.id),\n  userId: varchar(\"user_id\").references(() => users.id),\n  delta: integer(\"delta\").notNull(),\n  action: bathroomCounterActionEnum(\"action\").notNull(),\n  previousValue: integer(\"previous_value\").notNull(),\n  newValue: integer(\"new_value\").notNull(),\n  workOrderId: varchar(\"work_order_id\").references(() => workOrders.id),\n  createdAt: timestamp(\"created_at\").default(sql`now()`),\n});\n\n// 26. TABELA: public_request_logs (Logs de Solicitações Públicas)\nexport const publicRequestLogs = pgTable(\"public_request_logs\", {\n  id: varchar(\"id\").primaryKey(),\n  qrCodePointId: varchar(\"qr_code_point_id\").references(() => qrCodePoints.id),\n  ipHash: varchar(\"ip_hash\").notNull(),\n  userAgent: text(\"user_agent\"),\n  requestData: jsonb(\"request_data\"),\n  createdAt: timestamp(\"created_at\").default(sql`now()`),\n});\n\n// 27. TABELA: work_order_comments (Comentários em Work Orders)\nexport const workOrderComments = pgTable(\"work_order_comments\", {\n  id: varchar(\"id\").primaryKey(),\n  workOrderId: varchar(\"work_order_id\").notNull().references(() => workOrders.id),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  comment: text(\"comment\").notNull(),\n  attachments: jsonb(\"attachments\"),\n  isReopenRequest: boolean(\"is_reopen_request\").default(false),\n  createdAt: timestamp(\"created_at\").default(sql`now()`),\n  updatedAt: timestamp(\"updated_at\").default(sql`now()`),\n});\n\n// ============================================================================\n// MÓDULO DE MANUTENÇÃO - Tabelas Específicas\n// ============================================================================\n\n// 28. TABELA: equipment_types (Tipos de Equipamento)\nexport const equipmentTypes = pgTable(\"equipment_types\", {\n  id: varchar(\"id\").primaryKey(),\n  companyId: varchar(\"company_id\").notNull().references(() => companies.id),\n  name: varchar(\"name\").notNull(),\n  description: text(\"description\"),\n  module: moduleEnum(\"module\").notNull().default('maintenance'),\n  isActive: boolean(\"is_active\").default(true),\n  createdAt: timestamp(\"created_at\").default(sql`now()`),\n  updatedAt: timestamp(\"updated_at\").default(sql`now()`),\n});\n\n// 29. TABELA: equipment (Equipamentos)\nexport const equipment = pgTable(\"equipment\", {\n  id: varchar(\"id\").primaryKey(),\n  companyId: varchar(\"company_id\").notNull().references(() => companies.id),\n  customerId: varchar(\"customer_id\").notNull().references(() => customers.id),\n  siteId: varchar(\"site_id\").notNull().references(() => sites.id),\n  zoneId: varchar(\"zone_id\").notNull().references(() => zones.id),\n  equipmentTypeId: varchar(\"equipment_type_id\").references(() => equipmentTypes.id),\n  name: varchar(\"name\").notNull(),\n  internalCode: varchar(\"internal_code\"),\n  manufacturer: varchar(\"manufacturer\"),\n  model: varchar(\"model\"),\n  serialNumber: varchar(\"serial_number\"),\n  purchaseDate: date(\"purchase_date\"),\n  warrantyExpiry: date(\"warranty_expiry\"),\n  installationDate: date(\"installation_date\"),\n  status: equipmentStatusEnum(\"status\").notNull().default('operacional'),\n  technicalSpecs: jsonb(\"technical_specs\"),\n  maintenanceNotes: text(\"maintenance_notes\"),\n  qrCodeUrl: varchar(\"qr_code_url\"),\n  module: moduleEnum(\"module\").notNull().default('maintenance'),\n  isActive: boolean(\"is_active\").default(true),\n  createdAt: timestamp(\"created_at\").default(sql`now()`),\n  updatedAt: timestamp(\"updated_at\").default(sql`now()`),\n});\n\n// 30. TABELA: maintenance_checklist_templates (Templates de Checklist de Manutenção)\nexport const maintenanceChecklistTemplates = pgTable(\"maintenance_checklist_templates\", {\n  id: varchar(\"id\").primaryKey(),\n  companyId: varchar(\"company_id\").notNull().references(() => companies.id),\n  customerId: varchar(\"customer_id\").notNull().references(() => customers.id),\n  name: varchar(\"name\").notNull(),\n  description: text(\"description\"),\n  version: varchar(\"version\").notNull().default('1.0'),\n  serviceId: varchar(\"service_id\").notNull().references(() => services.id),\n  siteIds: varchar(\"site_ids\").array(),\n  zoneIds: varchar(\"zone_ids\").array(),\n  equipmentIds: varchar(\"equipment_ids\").array(),\n  items: jsonb(\"items\").notNull(),\n  module: moduleEnum(\"module\").notNull().default('maintenance'),\n  isActive: boolean(\"is_active\").default(true),\n  createdAt: timestamp(\"created_at\").default(sql`now()`),\n  updatedAt: timestamp(\"updated_at\").default(sql`now()`),\n});\n\n// 30. TABELA: maintenance_checklist_executions (Execuções de Checklist de Manutenção)\nexport const maintenanceChecklistExecutions = pgTable(\"maintenance_checklist_executions\", {\n  id: varchar(\"id\").primaryKey(),\n  checklistTemplateId: varchar(\"checklist_template_id\").notNull().references(() => maintenanceChecklistTemplates.id),\n  equipmentId: varchar(\"equipment_id\").notNull().references(() => equipment.id),\n  workOrderId: varchar(\"work_order_id\").references(() => workOrders.id),\n  executedByUserId: varchar(\"executed_by_user_id\").notNull().references(() => users.id),\n  startedAt: timestamp(\"started_at\").notNull(),\n  finishedAt: timestamp(\"finished_at\"),\n  status: varchar(\"status\").notNull().default('in_progress'),\n  checklistData: jsonb(\"checklist_data\"),\n  observations: text(\"observations\"),\n  attachments: jsonb(\"attachments\"),\n  createdAt: timestamp(\"created_at\").default(sql`now()`),\n  updatedAt: timestamp(\"updated_at\").default(sql`now()`),\n});\n\n// 31. TABELA: maintenance_plans (Planos de Manutenção)\nexport const maintenancePlans = pgTable(\"maintenance_plans\", {\n  id: varchar(\"id\").primaryKey(),\n  companyId: varchar(\"company_id\").notNull().references(() => companies.id),\n  customerId: varchar(\"customer_id\").notNull().references(() => customers.id),\n  name: varchar(\"name\").notNull(),\n  description: text(\"description\"),\n  type: varchar(\"type\").notNull().default('preventiva'),\n  module: moduleEnum(\"module\").notNull().default('maintenance'),\n  isActive: boolean(\"is_active\").default(true),\n  createdAt: timestamp(\"created_at\").default(sql`now()`),\n  updatedAt: timestamp(\"updated_at\").default(sql`now()`),\n});\n\n// 32. TABELA: maintenance_plan_equipments (Equipamentos no Plano de Manutenção)\nexport const maintenancePlanEquipments = pgTable(\"maintenance_plan_equipments\", {\n  id: varchar(\"id\").primaryKey(),\n  planId: varchar(\"plan_id\").notNull().references(() => maintenancePlans.id),\n  equipmentId: varchar(\"equipment_id\").notNull().references(() => equipment.id),\n  checklistTemplateId: varchar(\"checklist_template_id\").references(() => maintenanceChecklistTemplates.id),\n  frequency: frequencyEnum(\"frequency\").notNull(),\n  frequencyConfig: jsonb(\"frequency_config\"),\n  nextExecutionAt: timestamp(\"next_execution_at\"),\n  lastExecutionAt: timestamp(\"last_execution_at\"),\n  isActive: boolean(\"is_active\").default(true),\n  createdAt: timestamp(\"created_at\").default(sql`now()`),\n  updatedAt: timestamp(\"updated_at\").default(sql`now()`),\n}, (table) => ({\n  uniquePlanEquipment: unique(\"unique_plan_equipment\").on(table.planId, table.equipmentId),\n}));\n\n// 33. TABELA: maintenance_activities (Atividades de Manutenção Programadas)\nexport const maintenanceActivities = pgTable(\"maintenance_activities\", {\n  id: varchar(\"id\").primaryKey(),\n  companyId: varchar(\"company_id\").notNull().references(() => companies.id),\n  customerId: varchar(\"customer_id\").notNull().references(() => customers.id),\n  \n  // Múltiplos locais/zonas\n  siteIds: varchar(\"site_ids\").array().notNull(),\n  zoneIds: varchar(\"zone_ids\").array().notNull(),\n  \n  // Múltiplos equipamentos\n  equipmentIds: varchar(\"equipment_ids\").array(), // Array de IDs de equipamentos\n  \n  // Campos antigos mantidos para compatibilidade (deprecated) - agora nullable\n  siteId: varchar(\"site_id\"),\n  zoneId: varchar(\"zone_id\"),\n  \n  name: varchar(\"name\").notNull(),\n  description: text(\"description\"),\n  type: varchar(\"type\").notNull().default('preventiva'), // preventiva, preditiva, corretiva\n  frequency: frequencyEnum(\"frequency\").notNull(),\n  frequencyConfig: jsonb(\"frequency_config\"),\n  module: moduleEnum(\"module\").notNull().default('maintenance'),\n  checklistTemplateId: varchar(\"checklist_template_id\").references(() => maintenanceChecklistTemplates.id),\n  slaConfigId: varchar(\"sla_config_id\").references(() => slaConfigs.id),\n  assignedUserId: varchar(\"assigned_user_id\").references(() => users.id),\n  estimatedHours: decimal(\"estimated_hours\", { precision: 5, scale: 2 }),\n  slaMinutes: integer(\"sla_minutes\"),\n  startDate: date(\"start_date\"),\n  lastExecutedAt: timestamp(\"last_executed_at\"),\n  isActive: boolean(\"is_active\").default(true),\n  createdAt: timestamp(\"created_at\").default(sql`now()`),\n  updatedAt: timestamp(\"updated_at\").default(sql`now()`),\n  startTime: time(\"start_time\"),\n  endTime: time(\"end_time\"),\n});\n\n// Relations\nexport const companiesRelations = relations(companies, ({ many }) => ({\n  customers: many(customers),\n  sites: many(sites),\n  users: many(users),\n  auditLogs: many(auditLogs),\n  dashboardGoals: many(dashboardGoals),\n  customRoles: many(customRoles),\n  slaConfigs: many(slaConfigs),\n  webhookConfigs: many(webhookConfigs),\n  companyCounters: many(companyCounters),\n  cleaningActivities: many(cleaningActivities),\n  workOrders: many(workOrders),\n  checklistTemplates: many(checklistTemplates),\n}));\n\nexport const customersRelations = relations(customers, ({ one, many }) => ({\n  company: one(companies, {\n    fields: [customers.companyId],\n    references: [companies.id],\n  }),\n  sites: many(sites),\n  users: many(users),\n  serviceTypes: many(serviceTypes),\n  serviceCategories: many(serviceCategories),\n  services: many(services),\n  userRoleAssignments: many(userRoleAssignments),\n}));\n\nexport const sitesRelations = relations(sites, ({ one, many }) => ({\n  company: one(companies, {\n    fields: [sites.companyId],\n    references: [companies.id],\n  }),\n  customer: one(customers, {\n    fields: [sites.customerId],\n    references: [customers.id],\n  }),\n  zones: many(zones),\n  siteShifts: many(siteShifts),\n  userSiteAssignments: many(userSiteAssignments),\n  checklistTemplates: many(checklistTemplates),\n  cleaningActivities: many(cleaningActivities),\n}));\n\nexport const zonesRelations = relations(zones, ({ one, many }) => ({\n  site: one(sites, {\n    fields: [zones.siteId],\n    references: [sites.id],\n  }),\n  qrCodePoints: many(qrCodePoints),\n  serviceZones: many(serviceZones),\n  bathroomCounters: many(bathroomCounters),\n  cleaningActivities: many(cleaningActivities),\n  workOrders: many(workOrders),\n  checklistTemplates: many(checklistTemplates),\n}));\n\nexport const usersRelations = relations(users, ({ one, many }) => ({\n  company: one(companies, {\n    fields: [users.companyId],\n    references: [companies.id],\n  }),\n  customer: one(customers, {\n    fields: [users.customerId],\n    references: [customers.id],\n  }),\n  auditLogs: many(auditLogs),\n  userRoleAssignments: many(userRoleAssignments),\n  userSiteAssignments: many(userSiteAssignments),\n  assignedWorkOrders: many(workOrders),\n  bathroomCounterLogs: many(bathroomCounterLogs),\n  workOrderComments: many(workOrderComments),\n}));\n\nexport const serviceTypesRelations = relations(serviceTypes, ({ one, many }) => ({\n  customer: one(customers, {\n    fields: [serviceTypes.customerId],\n    references: [customers.id],\n  }),\n  serviceCategories: many(serviceCategories),\n  services: many(services),\n}));\n\nexport const serviceCategoriesRelations = relations(serviceCategories, ({ one, many }) => ({\n  customer: one(customers, {\n    fields: [serviceCategories.customerId],\n    references: [customers.id],\n  }),\n  serviceType: one(serviceTypes, {\n    fields: [serviceCategories.typeId],\n    references: [serviceTypes.id],\n  }),\n  services: many(services),\n}));\n\nexport const servicesRelations = relations(services, ({ one, many }) => ({\n  customer: one(customers, {\n    fields: [services.customerId],\n    references: [customers.id],\n  }),\n  category: one(serviceCategories, {\n    fields: [services.categoryId],\n    references: [serviceCategories.id],\n  }),\n  type: one(serviceTypes, {\n    fields: [services.typeId],\n    references: [serviceTypes.id],\n  }),\n  qrCodePoints: many(qrCodePoints),\n  serviceZones: many(serviceZones),\n  cleaningActivities: many(cleaningActivities),\n  workOrders: many(workOrders),\n  checklistTemplates: many(checklistTemplates),\n}));\n\nexport const workOrdersRelations = relations(workOrders, ({ one, many }) => ({\n  company: one(companies, {\n    fields: [workOrders.companyId],\n    references: [companies.id],\n  }),\n  zone: one(zones, {\n    fields: [workOrders.zoneId],\n    references: [zones.id],\n  }),\n  service: one(services, {\n    fields: [workOrders.serviceId],\n    references: [services.id],\n  }),\n  cleaningActivity: one(cleaningActivities, {\n    fields: [workOrders.cleaningActivityId],\n    references: [cleaningActivities.id],\n  }),\n  checklistTemplate: one(checklistTemplates, {\n    fields: [workOrders.checklistTemplateId],\n    references: [checklistTemplates.id],\n  }),\n  assignedUser: one(users, {\n    fields: [workOrders.assignedUserId],\n    references: [users.id],\n  }),\n  qrCodePoint: one(qrCodePoints, {\n    fields: [workOrders.qrCodePointId],\n    references: [qrCodePoints.id],\n  }),\n  comments: many(workOrderComments),\n}));\n\nexport const cleaningActivitiesRelations = relations(cleaningActivities, ({ one, many }) => ({\n  company: one(companies, {\n    fields: [cleaningActivities.companyId],\n    references: [companies.id],\n  }),\n  service: one(services, {\n    fields: [cleaningActivities.serviceId],\n    references: [services.id],\n  }),\n  site: one(sites, {\n    fields: [cleaningActivities.siteId],\n    references: [sites.id],\n  }),\n  zone: one(zones, {\n    fields: [cleaningActivities.zoneId],\n    references: [zones.id],\n  }),\n  checklistTemplate: one(checklistTemplates, {\n    fields: [cleaningActivities.checklistTemplateId],\n    references: [checklistTemplates.id],\n  }),\n  slaConfig: one(slaConfigs, {\n    fields: [cleaningActivities.slaConfigId],\n    references: [slaConfigs.id],\n  }),\n  workOrders: many(workOrders),\n}));\n\nexport const checklistTemplatesRelations = relations(checklistTemplates, ({ one, many }) => ({\n  company: one(companies, {\n    fields: [checklistTemplates.companyId],\n    references: [companies.id],\n  }),\n  service: one(services, {\n    fields: [checklistTemplates.serviceId],\n    references: [services.id],\n  }),\n  site: one(sites, {\n    fields: [checklistTemplates.siteId],\n    references: [sites.id],\n  }),\n  zone: one(zones, {\n    fields: [checklistTemplates.zoneId],\n    references: [zones.id],\n  }),\n  cleaningActivities: many(cleaningActivities),\n  workOrders: many(workOrders),\n}));\n\nexport const auditLogsRelations = relations(auditLogs, ({ one }) => ({\n  company: one(companies, {\n    fields: [auditLogs.companyId],\n    references: [companies.id],\n  }),\n  user: one(users, {\n    fields: [auditLogs.userId],\n    references: [users.id],\n  }),\n}));\n\nexport const qrCodePointsRelations = relations(qrCodePoints, ({ one, many }) => ({\n  zone: one(zones, {\n    fields: [qrCodePoints.zoneId],\n    references: [zones.id],\n  }),\n  service: one(services, {\n    fields: [qrCodePoints.serviceId],\n    references: [services.id],\n  }),\n  workOrders: many(workOrders),\n  publicRequestLogs: many(publicRequestLogs),\n}));\n\nexport const customRolesRelations = relations(customRoles, ({ one, many }) => ({\n  company: one(companies, {\n    fields: [customRoles.companyId],\n    references: [companies.id],\n  }),\n  rolePermissions: many(rolePermissions),\n  userRoleAssignments: many(userRoleAssignments),\n}));\n\nexport const rolePermissionsRelations = relations(rolePermissions, ({ one }) => ({\n  role: one(customRoles, {\n    fields: [rolePermissions.roleId],\n    references: [customRoles.id],\n  }),\n}));\n\nexport const userRoleAssignmentsRelations = relations(userRoleAssignments, ({ one }) => ({\n  user: one(users, {\n    fields: [userRoleAssignments.userId],\n    references: [users.id],\n  }),\n  role: one(customRoles, {\n    fields: [userRoleAssignments.roleId],\n    references: [customRoles.id],\n  }),\n  customer: one(customers, {\n    fields: [userRoleAssignments.customerId],\n    references: [customers.id],\n  }),\n}));\n\nexport const userSiteAssignmentsRelations = relations(userSiteAssignments, ({ one }) => ({\n  user: one(users, {\n    fields: [userSiteAssignments.userId],\n    references: [users.id],\n  }),\n  site: one(sites, {\n    fields: [userSiteAssignments.siteId],\n    references: [sites.id],\n  }),\n}));\n\nexport const siteShiftsRelations = relations(siteShifts, ({ one }) => ({\n  site: one(sites, {\n    fields: [siteShifts.siteId],\n    references: [sites.id],\n  }),\n}));\n\nexport const slaConfigsRelations = relations(slaConfigs, ({ one, many }) => ({\n  company: one(companies, {\n    fields: [slaConfigs.companyId],\n    references: [companies.id],\n  }),\n  cleaningActivities: many(cleaningActivities),\n}));\n\nexport const webhookConfigsRelations = relations(webhookConfigs, ({ one }) => ({\n  company: one(companies, {\n    fields: [webhookConfigs.companyId],\n    references: [companies.id],\n  }),\n}));\n\nexport const companyCountersRelations = relations(companyCounters, ({ one }) => ({\n  company: one(companies, {\n    fields: [companyCounters.companyId],\n    references: [companies.id],\n  }),\n}));\n\nexport const dashboardGoalsRelations = relations(dashboardGoals, ({ one }) => ({\n  company: one(companies, {\n    fields: [dashboardGoals.companyId],\n    references: [companies.id],\n  }),\n}));\n\nexport const serviceZonesRelations = relations(serviceZones, ({ one }) => ({\n  service: one(services, {\n    fields: [serviceZones.serviceId],\n    references: [services.id],\n  }),\n  zone: one(zones, {\n    fields: [serviceZones.zoneId],\n    references: [zones.id],\n  }),\n}));\n\nexport const bathroomCountersRelations = relations(bathroomCounters, ({ one, many }) => ({\n  zone: one(zones, {\n    fields: [bathroomCounters.zoneId],\n    references: [zones.id],\n  }),\n  logs: many(bathroomCounterLogs),\n}));\n\nexport const bathroomCounterLogsRelations = relations(bathroomCounterLogs, ({ one }) => ({\n  counter: one(bathroomCounters, {\n    fields: [bathroomCounterLogs.counterId],\n    references: [bathroomCounters.id],\n  }),\n  user: one(users, {\n    fields: [bathroomCounterLogs.userId],\n    references: [users.id],\n  }),\n  workOrder: one(workOrders, {\n    fields: [bathroomCounterLogs.workOrderId],\n    references: [workOrders.id],\n  }),\n}));\n\nexport const publicRequestLogsRelations = relations(publicRequestLogs, ({ one }) => ({\n  qrCodePoint: one(qrCodePoints, {\n    fields: [publicRequestLogs.qrCodePointId],\n    references: [qrCodePoints.id],\n  }),\n}));\n\nexport const workOrderCommentsRelations = relations(workOrderComments, ({ one }) => ({\n  workOrder: one(workOrders, {\n    fields: [workOrderComments.workOrderId],\n    references: [workOrders.id],\n  }),\n  user: one(users, {\n    fields: [workOrderComments.userId],\n    references: [users.id],\n  }),\n}));\n\n// Maintenance Relations\nexport const equipmentRelations = relations(equipment, ({ one, many }) => ({\n  company: one(companies, {\n    fields: [equipment.companyId],\n    references: [companies.id],\n  }),\n  customer: one(customers, {\n    fields: [equipment.customerId],\n    references: [customers.id],\n  }),\n  site: one(sites, {\n    fields: [equipment.siteId],\n    references: [sites.id],\n  }),\n  zone: one(zones, {\n    fields: [equipment.zoneId],\n    references: [zones.id],\n  }),\n  equipmentType: one(equipmentTypes, {\n    fields: [equipment.equipmentTypeId],\n    references: [equipmentTypes.id],\n  }),\n  maintenanceChecklistExecutions: many(maintenanceChecklistExecutions),\n  maintenancePlanEquipments: many(maintenancePlanEquipments),\n  workOrders: many(workOrders),\n  qrCodePoints: many(qrCodePoints),\n}));\n\nexport const equipmentTypesRelations = relations(equipmentTypes, ({ one, many }) => ({\n  company: one(companies, {\n    fields: [equipmentTypes.companyId],\n    references: [companies.id],\n  }),\n  equipment: many(equipment),\n}));\n\nexport const maintenanceChecklistTemplatesRelations = relations(maintenanceChecklistTemplates, ({ one, many }) => ({\n  company: one(companies, {\n    fields: [maintenanceChecklistTemplates.companyId],\n    references: [companies.id],\n  }),\n  customer: one(customers, {\n    fields: [maintenanceChecklistTemplates.customerId],\n    references: [customers.id],\n  }),\n  maintenanceChecklistExecutions: many(maintenanceChecklistExecutions),\n  maintenancePlanEquipments: many(maintenancePlanEquipments),\n}));\n\nexport const maintenanceChecklistExecutionsRelations = relations(maintenanceChecklistExecutions, ({ one }) => ({\n  checklistTemplate: one(maintenanceChecklistTemplates, {\n    fields: [maintenanceChecklistExecutions.checklistTemplateId],\n    references: [maintenanceChecklistTemplates.id],\n  }),\n  equipment: one(equipment, {\n    fields: [maintenanceChecklistExecutions.equipmentId],\n    references: [equipment.id],\n  }),\n  workOrder: one(workOrders, {\n    fields: [maintenanceChecklistExecutions.workOrderId],\n    references: [workOrders.id],\n  }),\n  executedBy: one(users, {\n    fields: [maintenanceChecklistExecutions.executedByUserId],\n    references: [users.id],\n  }),\n}));\n\nexport const maintenancePlansRelations = relations(maintenancePlans, ({ one, many }) => ({\n  company: one(companies, {\n    fields: [maintenancePlans.companyId],\n    references: [companies.id],\n  }),\n  customer: one(customers, {\n    fields: [maintenancePlans.customerId],\n    references: [customers.id],\n  }),\n  maintenancePlanEquipments: many(maintenancePlanEquipments),\n}));\n\nexport const maintenancePlanEquipmentsRelations = relations(maintenancePlanEquipments, ({ one }) => ({\n  plan: one(maintenancePlans, {\n    fields: [maintenancePlanEquipments.planId],\n    references: [maintenancePlans.id],\n  }),\n  equipment: one(equipment, {\n    fields: [maintenancePlanEquipments.equipmentId],\n    references: [equipment.id],\n  }),\n  checklistTemplate: one(maintenanceChecklistTemplates, {\n    fields: [maintenancePlanEquipments.checklistTemplateId],\n    references: [maintenanceChecklistTemplates.id],\n  }),\n}));\n\n// Insert schemas\nexport const insertCompanySchema = createInsertSchema(companies).omit({ id: true });\nexport const insertCustomerSchema = createInsertSchema(customers).omit({ id: true });\nexport const insertSiteSchema = createInsertSchema(sites).omit({ id: true });\nexport const insertZoneSchema = createInsertSchema(zones).omit({ id: true });\nexport const insertUserSchema = createInsertSchema(users).omit({ id: true }).extend({\n  modules: z.array(z.enum(['clean', 'maintenance'])).min(1, 'Selecione pelo menos um módulo').default(['clean']),\n});\nexport const insertServiceTypeSchema = createInsertSchema(serviceTypes).omit({ id: true });\nexport const insertServiceCategorySchema = createInsertSchema(serviceCategories).omit({ id: true });\nexport const insertServiceSchema = createInsertSchema(services).omit({ id: true });\nexport const insertCleaningActivitySchema = createInsertSchema(cleaningActivities).omit({ id: true });\nexport const insertChecklistTemplateSchema = createInsertSchema(checklistTemplates).omit({ id: true });\nexport const insertWorkOrderSchema = createInsertSchema(workOrders).omit({ id: true, number: true }).extend({\n  completedAt: z.union([z.date(), z.string().datetime(), z.null()]).optional(),\n  startedAt: z.union([z.date(), z.string().datetime(), z.null()]).optional(),\n  scheduledStartAt: z.union([z.date(), z.string().datetime(), z.null()]).optional(),\n  scheduledEndAt: z.union([z.date(), z.string().datetime(), z.null()]).optional(),\n  scheduledDate: z.union([z.string(), z.date(), z.null()]).optional().transform((val) => {\n    if (!val) return null;\n    if (typeof val === 'string' && val.match(/^\\d{4}-\\d{2}-\\d{2}$/)) {\n      return val;\n    }\n    if (val instanceof Date) {\n      const year = val.getFullYear();\n      const month = String(val.getMonth() + 1).padStart(2, '0');\n      const day = String(val.getDate()).padStart(2, '0');\n      return `${year}-${month}-${day}`;\n    }\n    return val;\n  }),\n  dueDate: z.union([z.string(), z.date(), z.null()]).optional().transform((val) => {\n    if (!val) return null;\n    if (typeof val === 'string' && val.match(/^\\d{4}-\\d{2}-\\d{2}$/)) {\n      return val;\n    }\n    if (val instanceof Date) {\n      const year = val.getFullYear();\n      const month = String(val.getMonth() + 1).padStart(2, '0');\n      const day = String(val.getDate()).padStart(2, '0');\n      return `${year}-${month}-${day}`;\n    }\n    return val;\n  }),\n});\nexport const insertAuditLogSchema = createInsertSchema(auditLogs).omit({ id: true });\nexport const insertDashboardGoalSchema = createInsertSchema(dashboardGoals).omit({ id: true });\nexport const insertCustomRoleSchema = createInsertSchema(customRoles);\nexport const insertRolePermissionSchema = createInsertSchema(rolePermissions);\nexport const insertUserRoleAssignmentSchema = createInsertSchema(userRoleAssignments);\nexport const insertUserSiteAssignmentSchema = createInsertSchema(userSiteAssignments);\nexport const insertSiteShiftSchema = createInsertSchema(siteShifts);\nexport const insertSlaConfigSchema = createInsertSchema(slaConfigs);\nexport const insertWebhookConfigSchema = createInsertSchema(webhookConfigs);\nexport const insertCompanyCounterSchema = createInsertSchema(companyCounters);\nexport const insertQrCodePointSchema = createInsertSchema(qrCodePoints).omit({ \n  id: true,\n  createdAt: true,\n  updatedAt: true\n}).partial({\n  code: true,\n  serviceId: true,\n  description: true,\n  sizeCm: true,\n  isActive: true\n});\nexport const insertServiceZoneSchema = createInsertSchema(serviceZones);\nexport const insertBathroomCounterSchema = createInsertSchema(bathroomCounters);\nexport const insertBathroomCounterLogSchema = createInsertSchema(bathroomCounterLogs);\nexport const insertPublicRequestLogSchema = createInsertSchema(publicRequestLogs);\nexport const insertWorkOrderCommentSchema = createInsertSchema(workOrderComments);\n\n// Maintenance insert schemas\nexport const insertEquipmentSchema = createInsertSchema(equipment).omit({ id: true });\nexport const insertMaintenanceChecklistTemplateSchema = createInsertSchema(maintenanceChecklistTemplates).omit({ id: true });\nexport const insertMaintenanceChecklistExecutionSchema = createInsertSchema(maintenanceChecklistExecutions).omit({ id: true });\nexport const insertMaintenancePlanSchema = createInsertSchema(maintenancePlans).omit({ id: true });\nexport const insertMaintenancePlanEquipmentSchema = createInsertSchema(maintenancePlanEquipments).omit({ id: true });\nexport const insertMaintenanceActivitySchema = createInsertSchema(maintenanceActivities).omit({ id: true });\n\n// Types\nexport type Company = typeof companies.$inferSelect;\nexport type InsertCompany = z.infer<typeof insertCompanySchema>;\n\nexport type Customer = typeof customers.$inferSelect;\nexport type InsertCustomer = z.infer<typeof insertCustomerSchema>;\n\nexport type Site = typeof sites.$inferSelect;\nexport type InsertSite = z.infer<typeof insertSiteSchema>;\n\nexport type Zone = typeof zones.$inferSelect;\nexport type InsertZone = z.infer<typeof insertZoneSchema>;\n\nexport type User = typeof users.$inferSelect;\nexport type InsertUser = z.infer<typeof insertUserSchema>;\n\nexport type ServiceType = typeof serviceTypes.$inferSelect;\nexport type InsertServiceType = z.infer<typeof insertServiceTypeSchema>;\n\nexport type ServiceCategory = typeof serviceCategories.$inferSelect;\nexport type InsertServiceCategory = z.infer<typeof insertServiceCategorySchema>;\n\nexport type Service = typeof services.$inferSelect;\nexport type InsertService = z.infer<typeof insertServiceSchema>;\n\nexport type CleaningActivity = typeof cleaningActivities.$inferSelect;\nexport type InsertCleaningActivity = z.infer<typeof insertCleaningActivitySchema>;\n\nexport type ChecklistTemplate = typeof checklistTemplates.$inferSelect;\nexport type InsertChecklistTemplate = z.infer<typeof insertChecklistTemplateSchema>;\n\nexport type WorkOrder = typeof workOrders.$inferSelect;\nexport type InsertWorkOrder = z.infer<typeof insertWorkOrderSchema>;\n\nexport type AuditLog = typeof auditLogs.$inferSelect;\nexport type InsertAuditLog = z.infer<typeof insertAuditLogSchema>;\n\nexport type DashboardGoal = typeof dashboardGoals.$inferSelect;\nexport type InsertDashboardGoal = z.infer<typeof insertDashboardGoalSchema>;\n\nexport type CustomRole = typeof customRoles.$inferSelect;\nexport type CustomRoleWithPermissions = CustomRole & { permissions: string[] };\nexport type InsertCustomRole = z.infer<typeof insertCustomRoleSchema>;\n\nexport type RolePermission = typeof rolePermissions.$inferSelect;\nexport type InsertRolePermission = z.infer<typeof insertRolePermissionSchema>;\n\nexport type UserRoleAssignment = typeof userRoleAssignments.$inferSelect;\nexport type InsertUserRoleAssignment = z.infer<typeof insertUserRoleAssignmentSchema>;\n\nexport type UserSiteAssignment = typeof userSiteAssignments.$inferSelect;\nexport type InsertUserSiteAssignment = z.infer<typeof insertUserSiteAssignmentSchema>;\n\nexport type SiteShift = typeof siteShifts.$inferSelect;\nexport type InsertSiteShift = z.infer<typeof insertSiteShiftSchema>;\n\nexport type SlaConfig = typeof slaConfigs.$inferSelect;\nexport type InsertSlaConfig = z.infer<typeof insertSlaConfigSchema>;\n\nexport type WebhookConfig = typeof webhookConfigs.$inferSelect;\nexport type InsertWebhookConfig = z.infer<typeof insertWebhookConfigSchema>;\n\nexport type CompanyCounter = typeof companyCounters.$inferSelect;\nexport type InsertCompanyCounter = z.infer<typeof insertCompanyCounterSchema>;\n\nexport type QrCodePoint = typeof qrCodePoints.$inferSelect;\nexport type InsertQrCodePoint = z.infer<typeof insertQrCodePointSchema>;\n\nexport type ServiceZone = typeof serviceZones.$inferSelect;\nexport type InsertServiceZone = z.infer<typeof insertServiceZoneSchema>;\n\nexport type BathroomCounter = typeof bathroomCounters.$inferSelect;\nexport type InsertBathroomCounter = z.infer<typeof insertBathroomCounterSchema>;\n\nexport type BathroomCounterLog = typeof bathroomCounterLogs.$inferSelect;\nexport type InsertBathroomCounterLog = z.infer<typeof insertBathroomCounterLogSchema>;\n\nexport type PublicRequestLog = typeof publicRequestLogs.$inferSelect;\nexport type InsertPublicRequestLog = z.infer<typeof insertPublicRequestLogSchema>;\n\nexport type WorkOrderComment = typeof workOrderComments.$inferSelect;\nexport type InsertWorkOrderComment = z.infer<typeof insertWorkOrderCommentSchema>;\n\n// Maintenance types\nexport type Equipment = typeof equipment.$inferSelect;\nexport type InsertEquipment = z.infer<typeof insertEquipmentSchema>;\n\nexport type MaintenanceChecklistTemplate = typeof maintenanceChecklistTemplates.$inferSelect;\nexport type InsertMaintenanceChecklistTemplate = z.infer<typeof insertMaintenanceChecklistTemplateSchema>;\n\nexport type MaintenanceChecklistExecution = typeof maintenanceChecklistExecutions.$inferSelect;\nexport type InsertMaintenanceChecklistExecution = z.infer<typeof insertMaintenanceChecklistExecutionSchema>;\n\nexport type MaintenancePlan = typeof maintenancePlans.$inferSelect;\nexport type InsertMaintenancePlan = z.infer<typeof insertMaintenancePlanSchema>;\n\nexport type MaintenancePlanEquipment = typeof maintenancePlanEquipments.$inferSelect;\nexport type InsertMaintenancePlanEquipment = z.infer<typeof insertMaintenancePlanEquipmentSchema>;\n\nexport type MaintenanceActivity = typeof maintenanceActivities.$inferSelect;\nexport type InsertMaintenanceActivity = z.infer<typeof insertMaintenanceActivitySchema>;","size_bytes":50788},"client/src/components/ui/alert-dialog.tsx":{"content":"import * as React from \"react\"\nimport * as AlertDialogPrimitive from \"@radix-ui/react-alert-dialog\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nconst AlertDialog = AlertDialogPrimitive.Root\n\nconst AlertDialogTrigger = AlertDialogPrimitive.Trigger\n\nconst AlertDialogPortal = AlertDialogPrimitive.Portal\n\nconst AlertDialogOverlay = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nAlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName\n\nconst AlertDialogContent = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPortal>\n    <AlertDialogOverlay />\n    <AlertDialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    />\n  </AlertDialogPortal>\n))\nAlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName\n\nconst AlertDialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogHeader.displayName = \"AlertDialogHeader\"\n\nconst AlertDialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogFooter.displayName = \"AlertDialogFooter\"\n\nconst AlertDialogTitle = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold\", className)}\n    {...props}\n  />\n))\nAlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName\n\nconst AlertDialogDescription = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nAlertDialogDescription.displayName =\n  AlertDialogPrimitive.Description.displayName\n\nconst AlertDialogAction = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Action>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Action\n    ref={ref}\n    className={cn(buttonVariants(), className)}\n    {...props}\n  />\n))\nAlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName\n\nconst AlertDialogCancel = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Cancel\n    ref={ref}\n    className={cn(\n      buttonVariants({ variant: \"outline\" }),\n      \"mt-2 sm:mt-0\",\n      className\n    )}\n    {...props}\n  />\n))\nAlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName\n\nexport {\n  AlertDialog,\n  AlertDialogPortal,\n  AlertDialogOverlay,\n  AlertDialogTrigger,\n  AlertDialogContent,\n  AlertDialogHeader,\n  AlertDialogFooter,\n  AlertDialogTitle,\n  AlertDialogDescription,\n  AlertDialogAction,\n  AlertDialogCancel,\n}\n","size_bytes":4420},"client/src/pages/qr-execution.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useState, useEffect } from \"react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useParams, useLocation } from \"wouter\";\nimport { useModule } from \"@/contexts/ModuleContext\";\nimport { \n  QrCode, \n  Camera, \n  CheckCircle, \n  AlertTriangle, \n  Clock, \n  Upload,\n  ArrowLeft,\n  User,\n  MapPin,\n  FileText\n} from \"lucide-react\";\n\nexport default function QrExecution() {\n  const { currentModule } = useModule();\n  const { code } = useParams<{ code: string }>();\n  const [, setLocation] = useLocation();\n  const [observations, setObservations] = useState(\"\");\n  const [checklistItems, setChecklistItems] = useState<Record<string, any>>({});\n  const [photos, setPhotos] = useState<File[]>([]);\n  const [isCompleting, setIsCompleting] = useState(false);\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  // Get QR point data and check for scheduled activities\n  const { data: qrData, isLoading, error } = useQuery({\n    queryKey: [\"/api/qr-execution\", code],\n    enabled: !!code,\n  });\n\n  // Get zone details\n  const { data: zone } = useQuery({\n    queryKey: [\"/api/zones\", (qrData as any)?.point?.zoneId, { module: currentModule }],\n    enabled: !!(qrData as any)?.point?.zoneId,\n  });\n\n  // Mock current user - in real app this would come from auth context\n  const currentUser = {\n    id: \"user-1\",\n    name: \"Carlos Oliveira\",\n    role: \"operador\"\n  };\n\n  const createWorkOrderMutation = useMutation({\n    mutationFn: async (data: any) => {\n      return await apiRequest(\"POST\", \"/api/work-orders\", data);\n    },\n    onSuccess: () => {\n      toast({ title: \"Ordem de serviço criada com sucesso\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/work-orders\"] });\n    },\n    onError: () => {\n      toast({ \n        title: \"Erro ao criar ordem de serviço\", \n        variant: \"destructive\" \n      });\n    },\n  });\n\n  const updateWorkOrderMutation = useMutation({\n    mutationFn: async (data: any) => {\n      return await apiRequest(\"PUT\", `/api/work-orders/${data.id}`, data);\n    },\n    onSuccess: () => {\n      toast({ title: \"Ordem de serviço atualizada com sucesso\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/work-orders\"] });\n      setLocation(\"/mobile\");\n    },\n    onError: () => {\n      toast({ \n        title: \"Erro ao atualizar ordem de serviço\", \n        variant: \"destructive\" \n      });\n    },\n  });\n\n  const handleChecklistChange = (itemId: string, value: any) => {\n    setChecklistItems(prev => ({\n      ...prev,\n      [itemId]: value\n    }));\n  };\n\n  const handlePhotoUpload = (event: React.ChangeEvent<HTMLInputElement>) => {\n    const files = Array.from(event.target.files || []);\n    setPhotos(prev => [...prev, ...files]);\n  };\n\n  const handleCreateCorrectiveOrder = () => {\n    if (!zone || !(qrData as any)?.point) return;\n\n    createWorkOrderMutation.mutate({\n      companyId: (qrData as any)?.company?.id || 'company-opus-default', // Use company ID from QR context\n      zoneId: zone?.id,\n      type: \"corretiva_interna\",\n      priority: \"media\",\n      title: `Limpeza Corretiva - ${zone?.name || 'Local'}`,\n      description: observations || \"Solicitação via QR Code de execução\",\n      assignedUserId: currentUser.id,\n      origin: \"QR Execução\"\n    });\n  };\n\n  const handleCompleteWorkOrder = () => {\n    if (!(qrData as any)?.scheduledWorkOrder) return;\n\n    setIsCompleting(true);\n    updateWorkOrderMutation.mutate({\n      id: (qrData as any).scheduledWorkOrder.id,\n      status: \"concluida\",\n      completedAt: new Date().toISOString(),\n      checklistData: checklistItems,\n      attachments: photos.map(p => p.name) // In real app, upload photos first\n    });\n  };\n\n  useEffect(() => {\n    // Store QR scan data for offline sync\n    if (qrData) {\n      localStorage.setItem(`qr-scan-${code}`, JSON.stringify({\n        timestamp: new Date().toISOString(),\n        userId: currentUser.id,\n        qrData\n      }));\n      \n      // Store current location context for work order filtering\n      const locationContext = {\n        zoneId: (qrData as any).point?.zoneId,\n        zoneName: zone?.name || (qrData as any)?.point?.name,\n        siteName: (qrData as any).site?.name,\n        timestamp: new Date().toISOString()\n      };\n      localStorage.setItem('current-location', JSON.stringify(locationContext));\n    }\n  }, [qrData, code, currentUser.id, zone]);\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen bg-background flex items-center justify-center\">\n        <div className=\"text-center\">\n          <QrCode className=\"w-12 h-12 text-muted-foreground mx-auto mb-4 animate-pulse\" />\n          <p className=\"text-muted-foreground\">Carregando informações do QR Code...</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (error || !(qrData as any)?.point) {\n    return (\n      <div className=\"min-h-screen bg-background flex items-center justify-center p-4\">\n        <Card className=\"w-full max-w-md\">\n          <CardContent className=\"pt-6 text-center\">\n            <AlertTriangle className=\"w-12 h-12 text-destructive mx-auto mb-4\" />\n            <h1 className=\"text-xl font-bold text-foreground mb-2\">QR Code Inválido</h1>\n            <p className=\"text-muted-foreground mb-4\">\n              Este QR Code não foi encontrado ou não é válido para execução.\n            </p>\n            <Button onClick={() => setLocation(\"/mobile\")} data-testid=\"button-back-to-mobile\">\n              <ArrowLeft className=\"w-4 h-4 mr-2\" />\n              Voltar ao App\n            </Button>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      {/* Mobile Header */}\n      <div className=\"bg-card border-b border-border p-4 sticky top-0 z-10\">\n        <div className=\"flex items-center justify-between\">\n          <Button \n            variant=\"ghost\" \n            size=\"sm\"\n            onClick={() => setLocation(\"/mobile\")}\n            data-testid=\"button-back\"\n          >\n            <ArrowLeft className=\"w-4 h-4 mr-2\" />\n            Voltar\n          </Button>\n          <div className=\"text-center\">\n            <h1 className=\"text-lg font-bold text-foreground\">QR Execução</h1>\n            <p className=\"text-xs text-muted-foreground\">#{code}</p>\n          </div>\n          <div className=\"w-16\"></div>\n        </div>\n      </div>\n\n      <div className=\"p-4 space-y-6\">\n        {/* Location Info */}\n        <Card>\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-start space-x-3\">\n              <MapPin className=\"w-5 h-5 text-primary mt-1\" />\n              <div className=\"flex-1\">\n                <h2 className=\"text-lg font-semibold text-foreground\">{zone?.name || (qrData as any)?.point?.name}</h2>\n                <p className=\"text-sm text-muted-foreground\">{(qrData as any)?.point?.description}</p>\n                {zone?.areaM2 && (\n                  <p className=\"text-xs text-muted-foreground mt-1\">Área: {zone?.areaM2}m²</p>\n                )}\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Operator Info */}\n        <Card>\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center space-x-3\">\n              <User className=\"w-5 h-5 text-muted-foreground\" />\n              <div>\n                <p className=\"text-sm font-medium text-foreground\">{currentUser.name}</p>\n                <p className=\"text-xs text-muted-foreground\">Operador • {new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Scheduled Activity or Corrective Option */}\n        {(qrData as any).hasScheduledActivity && (qrData as any).scheduledWorkOrder ? (\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center space-x-2\">\n                <CheckCircle className=\"w-5 h-5 text-chart-2\" />\n                <span>Atividade Programada</span>\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"bg-chart-2/5 border border-chart-2/20 rounded-lg p-3\">\n                <h3 className=\"font-medium text-foreground mb-1\">{(qrData as any).scheduledWorkOrder.title}</h3>\n                <p className=\"text-sm text-muted-foreground\">{(qrData as any).scheduledWorkOrder.description}</p>\n                <div className=\"flex items-center space-x-4 mt-2 text-xs text-muted-foreground\">\n                  <span className=\"flex items-center space-x-1\">\n                    <Clock className=\"w-3 h-3\" />\n                    <span>SLA: {(qrData as any).scheduledWorkOrder.slaCompleteMinutes || 60} min</span>\n                  </span>\n                  <Badge className=\"bg-chart-4/10 text-chart-4\">\n                    {(qrData as any).scheduledWorkOrder.priority || 'Média'}\n                  </Badge>\n                </div>\n              </div>\n\n              {/* Checklist */}\n              {(qrData as any).checklist && (\n                <div className=\"space-y-3\">\n                  <h4 className=\"font-medium text-foreground\">Checklist</h4>\n                  {(qrData as any).checklist.map((item: any, index: number) => (\n                    <div key={index} className=\"flex items-center space-x-3 p-3 border border-border rounded-lg\">\n                      <Checkbox \n                        checked={checklistItems[item.id] || false}\n                        onCheckedChange={(checked) => handleChecklistChange(item.id, checked)}\n                        data-testid={`checkbox-${item.id}`}\n                      />\n                      <span className=\"flex-1 text-sm text-foreground\">{item.label}</span>\n                      {item.required && (\n                        <span className=\"text-xs text-destructive\">*</span>\n                      )}\n                    </div>\n                  ))}\n                </div>\n              )}\n\n              {/* Photo Upload */}\n              <div className=\"border-2 border-dashed border-border rounded-lg p-4\">\n                <input\n                  type=\"file\"\n                  accept=\"image/*\"\n                  multiple\n                  onChange={handlePhotoUpload}\n                  className=\"hidden\"\n                  id=\"photo-upload\"\n                />\n                <label htmlFor=\"photo-upload\" className=\"cursor-pointer\">\n                  <div className=\"text-center\">\n                    <Camera className=\"w-8 h-8 text-muted-foreground mx-auto mb-2\" />\n                    <p className=\"text-sm text-muted-foreground\">Anexar fotos</p>\n                    <p className=\"text-xs text-muted-foreground mt-1\">\n                      {photos.length > 0 ? `${photos.length} foto(s) selecionada(s)` : \"Toque para adicionar fotos\"}\n                    </p>\n                  </div>\n                </label>\n              </div>\n\n              {/* Complete Button */}\n              <Button \n                onClick={handleCompleteWorkOrder}\n                disabled={updateWorkOrderMutation.isPending || isCompleting}\n                className=\"w-full h-12\"\n                data-testid=\"button-complete-work-order\"\n              >\n                {isCompleting ? (\n                  \"Concluindo...\"\n                ) : (\n                  <>\n                    <CheckCircle className=\"w-4 h-4 mr-2\" />\n                    Concluir Atividade\n                  </>\n                )}\n              </Button>\n            </CardContent>\n          </Card>\n        ) : (\n          // No scheduled activity - offer corrective option\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center space-x-2\">\n                <AlertTriangle className=\"w-5 h-5 text-chart-4\" />\n                <span>Nenhuma Atividade Programada</span>\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <p className=\"text-sm text-muted-foreground\">\n                Não há atividades programadas para este local no momento. \n                Você pode abrir uma ordem de serviço corretiva se necessário.\n              </p>\n\n              {/* Observations for corrective */}\n              <div>\n                <label className=\"block text-sm font-medium text-foreground mb-2\">\n                  Motivo da Limpeza Corretiva\n                </label>\n                <Textarea\n                  placeholder=\"Descreva o que foi observado que requer limpeza...\"\n                  value={observations}\n                  onChange={(e) => setObservations(e.target.value)}\n                  className=\"min-h-[120px] max-h-[200px] overflow-y-auto resize-none\"\n                  data-testid=\"textarea-corrective-reason\"\n                />\n              </div>\n\n              {/* Photo Upload for corrective */}\n              <div className=\"border-2 border-dashed border-border rounded-lg p-4\">\n                <input\n                  type=\"file\"\n                  accept=\"image/*\"\n                  multiple\n                  onChange={handlePhotoUpload}\n                  className=\"hidden\"\n                  id=\"corrective-photo-upload\"\n                />\n                <label htmlFor=\"corrective-photo-upload\" className=\"cursor-pointer\">\n                  <div className=\"text-center\">\n                    <Camera className=\"w-8 h-8 text-muted-foreground mx-auto mb-2\" />\n                    <p className=\"text-sm text-muted-foreground\">Anexar fotos (opcional)</p>\n                    <p className=\"text-xs text-muted-foreground mt-1\">\n                      {photos.length > 0 ? `${photos.length} foto(s) selecionada(s)` : \"Evidências da necessidade de limpeza\"}\n                    </p>\n                  </div>\n                </label>\n              </div>\n\n              {/* Create Corrective Button */}\n              <Button \n                onClick={handleCreateCorrectiveOrder}\n                disabled={!observations.trim() || createWorkOrderMutation.isPending}\n                className=\"w-full h-12\"\n                variant=\"outline\"\n                data-testid=\"button-create-corrective\"\n              >\n                {createWorkOrderMutation.isPending ? (\n                  \"Criando...\"\n                ) : (\n                  <>\n                    <FileText className=\"w-4 h-4 mr-2\" />\n                    Abrir OS Corretiva\n                  </>\n                )}\n              </Button>\n            </CardContent>\n          </Card>\n        )}\n\n        {/* Quick Actions */}\n        <div className=\"grid grid-cols-2 gap-3\">\n          <Button \n            variant=\"outline\"\n            onClick={() => setLocation(\"/mobile\")}\n            data-testid=\"button-back-to-app\"\n          >\n            <ArrowLeft className=\"w-4 h-4 mr-2\" />\n            Voltar ao App\n          </Button>\n          \n          <Button \n            variant=\"outline\"\n            onClick={() => {\n              // In real app, would open QR scanner\n              toast({ title: \"Scanner QR aberto\" });\n            }}\n            data-testid=\"button-scan-another\"\n          >\n            <QrCode className=\"w-4 h-4 mr-2\" />\n            Escanear Outro\n          </Button>\n        </div>\n      </div>\n    </div>\n  );\n}\n","size_bytes":15665},"client/src/components/ui/scroll-area.tsx":{"content":"import * as React from \"react\"\nimport * as ScrollAreaPrimitive from \"@radix-ui/react-scroll-area\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ScrollArea = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <ScrollAreaPrimitive.Root\n    ref={ref}\n    className={cn(\"relative overflow-hidden\", className)}\n    {...props}\n  >\n    <ScrollAreaPrimitive.Viewport className=\"h-full w-full rounded-[inherit]\">\n      {children}\n    </ScrollAreaPrimitive.Viewport>\n    <ScrollBar />\n    <ScrollAreaPrimitive.Corner />\n  </ScrollAreaPrimitive.Root>\n))\nScrollArea.displayName = ScrollAreaPrimitive.Root.displayName\n\nconst ScrollBar = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>\n>(({ className, orientation = \"vertical\", ...props }, ref) => (\n  <ScrollAreaPrimitive.ScrollAreaScrollbar\n    ref={ref}\n    orientation={orientation}\n    className={cn(\n      \"flex touch-none select-none transition-colors\",\n      orientation === \"vertical\" &&\n        \"h-full w-2.5 border-l border-l-transparent p-[1px]\",\n      orientation === \"horizontal\" &&\n        \"h-2.5 flex-col border-t border-t-transparent p-[1px]\",\n      className\n    )}\n    {...props}\n  >\n    <ScrollAreaPrimitive.ScrollAreaThumb className=\"relative flex-1 rounded-full bg-border\" />\n  </ScrollAreaPrimitive.ScrollAreaScrollbar>\n))\nScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName\n\nexport { ScrollArea, ScrollBar }\n","size_bytes":1642},"server/seed.ts":{"content":"import { db } from \"./db\";\nimport { companies, customers, users } from \"@shared/schema\";\nimport { eq } from \"drizzle-orm\";\nimport bcrypt from \"bcryptjs\";\n\nasync function seed() {\n  try {\n    console.log(\"🌱 Iniciando seed do banco de dados...\");\n\n    // Verificar se já existe o admin\n    const existingAdmin = await db.select().from(users).where(\n      eq(users.email, 'admin@opusclean.com')\n    ).limit(1);\n    \n    if (existingAdmin.length > 0) {\n      console.log(\"✅ Usuário admin já existe. Seed não é necessário.\");\n      console.log(\"📋 Credenciais: admin / admin123\");\n      return;\n    }\n\n    // Criar Company\n    console.log(\"📦 Criando empresa...\");\n    const [company] = await db.insert(companies).values({\n      id: 'company-opus-default',\n      name: 'Grupo OPUS',\n      address: 'Av. Paulista, 1000 - São Paulo, SP',\n      cnpj: '12.345.678/0001-90',\n      email: 'contato@grupoopus.com.br',\n      phone: '(11) 3000-0000',\n      isActive: true\n    }).returning();\n    console.log(`✅ Empresa criada: ${company.name}`);\n\n    // Criar Customer\n    console.log(\"👤 Criando cliente...\");\n    const [customer] = await db.insert(customers).values({\n      id: 'customer-teste-default',\n      name: 'Cliente Teste',\n      companyId: company.id,\n      isActive: true\n    }).returning();\n    console.log(`✅ Cliente criado: ${customer.name}`);\n\n    // Criar Admin User\n    console.log(\"🔐 Criando usuário admin...\");\n    // Hash pré-calculado para 'admin123' para evitar delay no deploy\n    const hashedPassword = '$2b$12$OysqfXqxwvfxZvr9GZnYFOMLIoiTYcMfAa6QJLEHbmC7R5Ikvl8V6';\n    const [admin] = await db.insert(users).values({\n      id: 'user-admin-' + Date.now(),\n      role: 'admin',\n      name: 'Admin Teste',\n      email: 'admin@opusclean.com',\n      username: 'admin',\n      password: hashedPassword,\n      companyId: company.id,\n      isActive: true,\n      authProvider: 'local',\n      userType: 'opus_user'\n    }).returning();\n    console.log(`✅ Admin criado: ${admin.username}`);\n\n    console.log(\"\\n🎉 Seed concluído com sucesso!\");\n    console.log(\"\\n📋 Credenciais de acesso:\");\n    console.log(\"   Usuário: admin\");\n    console.log(\"   Senha: admin123\");\n    \n  } catch (error) {\n    console.error(\"❌ Erro ao fazer seed:\", error);\n    throw error;\n  }\n}\n\nseed()\n  .then(() => process.exit(0))\n  .catch((error) => {\n    console.error(error);\n    process.exit(1);\n  });\n","size_bytes":2421},"client/src/pages/service-settings.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { \n  Plus, \n  Settings as SettingsIcon, \n  Edit, \n  Trash2,\n  Layers,\n  Building,\n  Users as UsersIcon,\n  Cog,\n  Target,\n  Bookmark\n} from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport Header from \"@/components/layout/header\";\nimport Sites from \"./sites\";\nimport Users from \"./users\";\nimport Services from \"./services\";\nimport { useClient } from \"@/contexts/ClientContext\";\nimport { useModule } from \"@/contexts/ModuleContext\";\nimport { useEffect } from \"react\";\n\n// Schemas para validação\nconst serviceTypeSchema = z.object({\n  name: z.string().min(1, \"Nome é obrigatório\"),\n  description: z.string().optional(),\n  code: z.string().min(1, \"Código é obrigatório\"),\n});\n\n// CATEGORIAS DE SERVIÇOS - FUNCIONALIDADE COMENTADA (MANTER PARA REFERÊNCIA FUTURA)\n/* const serviceCategorySchema = z.object({\n  name: z.string().min(1, \"Nome é obrigatório\"),\n  description: z.string().optional(),\n  code: z.string().min(1, \"Código é obrigatório\"),\n  typeId: z.string().min(1, \"Tipo é obrigatório\"),\n}); */\n\nconst dashboardGoalSchema = z.object({\n  goalType: z.string().min(1, \"Tipo de meta é obrigatório\"),\n  goalValue: z.string().min(1, \"Valor da meta é obrigatório\"),\n  currentPeriod: z.string().min(1, \"Período é obrigatório\"),\n});\n\nexport default function Settings() {\n  const [isTypeDialogOpen, setIsTypeDialogOpen] = useState(false);\n  // const [isCategoryDialogOpen, setIsCategoryDialogOpen] = useState(false); // CATEGORIAS - COMENTADO\n  const [isGoalDialogOpen, setIsGoalDialogOpen] = useState(false);\n  const [editingType, setEditingType] = useState<any>(null);\n  // const [editingCategory, setEditingCategory] = useState<any>(null); // CATEGORIAS - COMENTADO\n  const [editingGoal, setEditingGoal] = useState<any>(null);\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const { activeClientId: customerId } = useClient();\n  const { currentModule } = useModule();\n\n  // Invalidate cache when customer changes\n  useEffect(() => {\n    if (customerId) {\n      queryClient.invalidateQueries({ queryKey: [\"/api/customers\"] });\n    }\n  }, [customerId, queryClient]);\n\n  // Queries\n  const { data: serviceTypes = [], isLoading: loadingTypes } = useQuery({\n    queryKey: [\"/api/customers\", customerId, \"service-types\"],\n    enabled: !!customerId,\n  });\n\n  // CATEGORIAS - COMENTADO\n  /* const { data: serviceCategories = [], isLoading: loadingCategories } = useQuery({\n    queryKey: [\"/api/customers\", customerId, \"service-categories\", { module: currentModule }],\n    enabled: !!customerId,\n  }); */\n\n  const { data: dashboardGoals = [], isLoading: loadingGoals } = useQuery({\n    queryKey: [\"/api/customers\", customerId, \"dashboard-goals\"],\n    enabled: !!customerId,\n  });\n\n  const { data: customer } = useQuery({\n    queryKey: [`/api/customers/${customerId}`],\n    enabled: !!customerId,\n  });\n\n  // Forms\n  const typeForm = useForm({\n    resolver: zodResolver(serviceTypeSchema),\n    defaultValues: {\n      name: \"\",\n      description: \"\",\n      code: \"\",\n    },\n  });\n\n  // CATEGORIAS - COMENTADO\n  /* const categoryForm = useForm({\n    resolver: zodResolver(serviceCategorySchema),\n    defaultValues: {\n      name: \"\",\n      description: \"\",\n      code: \"\",\n      typeId: \"\",\n    },\n  }); */\n\n  const goalForm = useForm({\n    resolver: zodResolver(dashboardGoalSchema),\n    defaultValues: {\n      goalType: \"\",\n      goalValue: \"\",\n      currentPeriod: new Date().toISOString().slice(0, 7), // YYYY-MM format\n    },\n  });\n\n  // Mutations\n  const createTypeMutation = useMutation({\n    mutationFn: (data: any) => apiRequest(\"POST\", `/api/customers/${customerId}/service-types`, data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/customers\", customerId, \"service-types\"] });\n      setIsTypeDialogOpen(false);\n      typeForm.reset();\n      toast({ title: \"Tipo de serviço criado com sucesso!\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro ao criar tipo de serviço\", variant: \"destructive\" });\n    },\n  });\n\n  const updateTypeMutation = useMutation({\n    mutationFn: ({ id, data }: { id: string; data: any }) => \n      apiRequest(\"PUT\", `/api/customers/${customerId}/service-types/${id}`, data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/customers\", customerId, \"service-types\"] });\n      setIsTypeDialogOpen(false);\n      setEditingType(null);\n      typeForm.reset();\n      toast({ title: \"Tipo de serviço atualizado com sucesso!\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro ao atualizar tipo de serviço\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteTypeMutation = useMutation({\n    mutationFn: (id: string) => apiRequest(\"DELETE\", `/api/customers/${customerId}/service-types/${id}`),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/customers\", customerId, \"service-types\"] });\n      toast({ title: \"Tipo de serviço excluído com sucesso!\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro ao excluir tipo de serviço\", variant: \"destructive\" });\n    },\n  });\n\n  // CATEGORIAS - MUTATIONS COMENTADAS\n  /* const createCategoryMutation = useMutation({\n    mutationFn: (data: any) => apiRequest(\"POST\", `/api/customers/${customerId}/service-categories`, data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/customers\", customerId, \"service-categories\"] });\n      setIsCategoryDialogOpen(false);\n      categoryForm.reset();\n      toast({ title: \"Categoria criada com sucesso!\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro ao criar categoria\", variant: \"destructive\" });\n    },\n  });\n\n  const updateCategoryMutation = useMutation({\n    mutationFn: ({ id, data }: { id: string; data: any }) => \n      apiRequest(\"PUT\", `/api/customers/${customerId}/service-categories/${id}`, data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/customers\", customerId, \"service-categories\"] });\n      setIsCategoryDialogOpen(false);\n      setEditingCategory(null);\n      categoryForm.reset();\n      toast({ title: \"Categoria atualizada com sucesso!\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro ao atualizar categoria\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteCategoryMutation = useMutation({\n    mutationFn: (id: string) => apiRequest(\"DELETE\", `/api/customers/${customerId}/service-categories/${id}`),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/customers\", customerId, \"service-categories\"] });\n      toast({ title: \"Categoria excluída com sucesso!\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro ao excluir categoria\", variant: \"destructive\" });\n    },\n  }); */\n\n  const createGoalMutation = useMutation({\n    mutationFn: (data: any) => apiRequest(\"POST\", `/api/customers/${customerId}/dashboard-goals`, data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/customers\", customerId, \"dashboard-goals\"] });\n      setIsGoalDialogOpen(false);\n      goalForm.reset();\n      toast({ title: \"Meta criada com sucesso!\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro ao criar meta\", variant: \"destructive\" });\n    },\n  });\n\n  const updateGoalMutation = useMutation({\n    mutationFn: ({ id, data }: { id: string; data: any }) => \n      apiRequest(\"PUT\", `/api/customers/${customerId}/dashboard-goals/${id}`, data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/customers\", customerId, \"dashboard-goals\"] });\n      setIsGoalDialogOpen(false);\n      setEditingGoal(null);\n      goalForm.reset();\n      toast({ title: \"Meta atualizada com sucesso!\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro ao atualizar meta\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteGoalMutation = useMutation({\n    mutationFn: (id: string) => apiRequest(\"DELETE\", `/api/customers/${customerId}/dashboard-goals/${id}`),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/customers\", customerId, \"dashboard-goals\"] });\n      toast({ title: \"Meta excluída com sucesso!\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro ao excluir meta\", variant: \"destructive\" });\n    },\n  });\n\n  // Handlers\n  const onSubmitType = (data: any) => {\n    if (editingType) {\n      updateTypeMutation.mutate({ id: editingType.id, data });\n    } else {\n      // Incluir o módulo atual ao criar tipo de serviço\n      createTypeMutation.mutate({ ...data, module: currentModule });\n    }\n  };\n\n  // CATEGORIAS - HANDLER COMENTADO\n  /* const onSubmitCategory = (data: any) => {\n    if (editingCategory) {\n      updateCategoryMutation.mutate({ id: editingCategory.id, data });\n    } else {\n      // Incluir o módulo atual ao criar categoria\n      createCategoryMutation.mutate({ ...data, module: currentModule });\n    }\n  }; */\n\n  const onSubmitGoal = (data: any) => {\n    if (editingGoal) {\n      updateGoalMutation.mutate({ id: editingGoal.id, data });\n    } else {\n      createGoalMutation.mutate(data);\n    }\n  };\n\n  const handleEditType = (type: any) => {\n    setEditingType(type);\n    typeForm.reset({\n      name: type.name,\n      description: type.description || \"\",\n      code: type.code,\n    });\n    setIsTypeDialogOpen(true);\n  };\n\n  // CATEGORIAS - HANDLER COMENTADO\n  /* const handleEditCategory = (category: any) => {\n    setEditingCategory(category);\n    categoryForm.reset({\n      name: category.name,\n      description: category.description || \"\",\n      code: category.code,\n      typeId: category.typeId,\n    });\n    setIsCategoryDialogOpen(true);\n  }; */\n\n  const handleEditGoal = (goal: any) => {\n    setEditingGoal(goal);\n    goalForm.reset({\n      goalType: goal.goalType,\n      goalValue: goal.goalValue,\n      currentPeriod: goal.currentPeriod,\n    });\n    setIsGoalDialogOpen(true);\n  };\n\n  const getTypeName = (typeId: string) => {\n    const type = (serviceTypes as any[]).find(t => t.id === typeId);\n    return type?.name || \"Tipo não encontrado\";\n  };\n\n  if (loadingTypes || /* loadingCategories || */ loadingGoals) { // CATEGORIAS - LOADING COMENTADO\n    return (\n      <div className=\"p-4 space-y-4 bg-gray-50 min-h-screen\">\n        <div className=\"animate-pulse\">\n          <div className=\"h-6 bg-gray-200 rounded mb-4\"></div>\n          <div className=\"grid grid-cols-2 gap-3\">\n            {[1,2,3,4].map(i => (\n              <div key={i} className=\"h-24 bg-gray-200 rounded-xl\"></div>\n            ))}\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"bg-gray-50 min-h-screen pb-20\">\n      {/* Header Moderno Mobile */}\n      <div className=\"bg-gradient-to-r from-purple-600 to-indigo-600 rounded-b-3xl p-4 shadow-lg mb-4\">\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <h1 className=\"text-lg font-bold text-white\">Configurações do Sistema</h1>\n            <p className=\"text-xs text-purple-100 mt-0.5\">Gerencie configurações gerais</p>\n          </div>\n          <div className=\"w-10 h-10 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center\">\n            <Cog className=\"w-5 h-5 text-white\" />\n          </div>\n        </div>\n      </div>\n      \n      <div className=\"px-3\">\n        <Tabs defaultValue=\"types\" className=\"space-y-3\">\n          {/* Tabs Responsivas - Scroll horizontal em mobile */}\n          <div className=\"bg-white rounded-2xl p-2 shadow-sm overflow-x-auto\">\n            <TabsList className=\"flex gap-1 bg-transparent w-max min-w-full\">\n              <TabsTrigger value=\"types\" className=\"flex items-center gap-1.5 text-xs rounded-xl px-3 py-2 data-[state=active]:bg-purple-100 data-[state=active]:text-purple-900 whitespace-nowrap\">\n                <Bookmark className=\"w-3.5 h-3.5\" />\n                Tipos\n              </TabsTrigger>\n              {/* CATEGORIAS - ABA COMENTADA */}\n              {/* <TabsTrigger value=\"categories\" className=\"flex items-center gap-1.5 text-xs rounded-xl px-3 py-2 data-[state=active]:bg-purple-100 data-[state=active]:text-purple-900 whitespace-nowrap\">\n                <Layers className=\"w-3.5 h-3.5\" />\n                Categorias\n              </TabsTrigger> */}\n              <TabsTrigger value=\"services\" className=\"flex items-center gap-1.5 text-xs rounded-xl px-3 py-2 data-[state=active]:bg-purple-100 data-[state=active]:text-purple-900 whitespace-nowrap\">\n                <SettingsIcon className=\"w-3.5 h-3.5\" />\n                Serviços\n              </TabsTrigger>\n              <TabsTrigger value=\"goals\" className=\"flex items-center gap-1.5 text-xs rounded-xl px-3 py-2 data-[state=active]:bg-purple-100 data-[state=active]:text-purple-900 whitespace-nowrap\">\n                <Target className=\"w-3.5 h-3.5\" />\n                Metas\n              </TabsTrigger>\n              <TabsTrigger value=\"sites\" className=\"flex items-center gap-1.5 text-xs rounded-xl px-3 py-2 data-[state=active]:bg-purple-100 data-[state=active]:text-purple-900 whitespace-nowrap\">\n                <Building className=\"w-3.5 h-3.5\" />\n                Locais\n              </TabsTrigger>\n              <TabsTrigger value=\"users\" className=\"flex items-center gap-1.5 text-xs rounded-xl px-3 py-2 data-[state=active]:bg-purple-100 data-[state=active]:text-purple-900 whitespace-nowrap\">\n                <UsersIcon className=\"w-3.5 h-3.5\" />\n                Usuários\n              </TabsTrigger>\n            </TabsList>\n          </div>\n\n          <TabsContent value=\"types\" className=\"space-y-6\">\n            <Card>\n              <CardHeader>\n                <div className=\"flex items-center justify-between\">\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <Bookmark className=\"w-5 h-5\" />\n                    Tipos de Serviços\n                  </CardTitle>\n                  <Dialog open={isTypeDialogOpen} onOpenChange={setIsTypeDialogOpen}>\n                    <DialogTrigger asChild>\n                      <Button \n                        onClick={() => {\n                          setEditingType(null);\n                          typeForm.reset({ name: \"\", description: \"\", code: \"\" });\n                        }}\n                        data-testid=\"button-create-type\"\n                      >\n                        <Plus className=\"w-4 h-4 mr-2\" />\n                        Novo Tipo\n                      </Button>\n                    </DialogTrigger>\n                    <DialogContent>\n                      <DialogHeader>\n                        <DialogTitle>\n                          {editingType ? \"Editar Tipo de Serviço\" : \"Novo Tipo de Serviço\"}\n                        </DialogTitle>\n                      </DialogHeader>\n                      <Form {...typeForm}>\n                        <form onSubmit={typeForm.handleSubmit(onSubmitType)} className=\"space-y-4\">\n                          <FormField\n                            control={typeForm.control}\n                            name=\"name\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>Nome</FormLabel>\n                                <FormControl>\n                                  <Input placeholder=\"Ex: Hard Service\" {...field} data-testid=\"input-type-name\" />\n                                </FormControl>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n                          <FormField\n                            control={typeForm.control}\n                            name=\"code\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>Código</FormLabel>\n                                <FormControl>\n                                  <Input placeholder=\"Ex: hard_service\" {...field} data-testid=\"input-type-code\" />\n                                </FormControl>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n                          <FormField\n                            control={typeForm.control}\n                            name=\"description\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>Descrição</FormLabel>\n                                <FormControl>\n                                  <Textarea \n                                    placeholder=\"Descrição do tipo de serviço\" \n                                    {...field} \n                                    data-testid=\"input-type-description\"\n                                  />\n                                </FormControl>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n                          <div className=\"flex justify-end space-x-2\">\n                            <Button \n                              type=\"button\" \n                              variant=\"outline\" \n                              onClick={() => setIsTypeDialogOpen(false)}\n                            >\n                              Cancelar\n                            </Button>\n                            <Button \n                              type=\"submit\" \n                              disabled={createTypeMutation.isPending || updateTypeMutation.isPending}\n                              data-testid=\"button-save-type\"\n                            >\n                              {editingType ? \"Atualizar\" : \"Criar\"}\n                            </Button>\n                          </div>\n                        </form>\n                      </Form>\n                    </DialogContent>\n                  </Dialog>\n                </div>\n              </CardHeader>\n              <CardContent>\n                {(serviceTypes as any[]).length === 0 ? (\n                  <div className=\"text-center py-8\">\n                    <Bookmark className=\"w-12 h-12 text-muted-foreground mx-auto mb-4\" />\n                    <p className=\"text-muted-foreground\">Nenhum tipo de serviço cadastrado</p>\n                    <p className=\"text-sm text-muted-foreground mt-2\">\n                      Crie tipos de serviços para organizar melhor seu sistema\n                    </p>\n                  </div>\n                ) : (\n                  <div className=\"space-y-3\">\n                    {(serviceTypes as any[]).map((type: any) => (\n                      <div key={type.id} className=\"border border-border rounded-lg p-4 hover:bg-muted/30 transition-colors\">\n                        <div className=\"flex items-start justify-between\">\n                          <div className=\"flex-1\">\n                            <div className=\"flex items-center space-x-3 mb-2\">\n                              <h3 className=\"text-lg font-semibold text-foreground\">{type.name}</h3>\n                              <Badge variant=\"outline\">{type.code}</Badge>\n                              {type.isActive ? (\n                                <Badge className=\"bg-green-100 text-green-800\">Ativo</Badge>\n                              ) : (\n                                <Badge variant=\"outline\">Inativo</Badge>\n                              )}\n                            </div>\n                            {type.description && (\n                              <p className=\"text-sm text-muted-foreground mb-2\">{type.description}</p>\n                            )}\n                            {/* CATEGORIAS - CONTAGEM COMENTADA */}\n                            {/* <p className=\"text-xs text-muted-foreground\">\n                              Categorias: {(serviceCategories as any[]).filter(c => c.typeId === type.id).length}\n                            </p> */}\n                          </div>\n                          <div className=\"flex items-center space-x-2\">\n                            <Button \n                              variant=\"ghost\" \n                              size=\"sm\"\n                              onClick={() => handleEditType(type)}\n                              data-testid={`button-edit-type-${type.id}`}\n                            >\n                              <Edit className=\"w-4 h-4\" />\n                            </Button>\n                            <Button \n                              variant=\"ghost\" \n                              size=\"sm\"\n                              onClick={() => deleteTypeMutation.mutate(type.id)}\n                              data-testid={`button-delete-type-${type.id}`}\n                            >\n                              <Trash2 className=\"w-4 h-4\" />\n                            </Button>\n                          </div>\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          </TabsContent>\n\n          {/* CATEGORIAS - TODO O CONTEÚDO DA ABA COMENTADO */}\n          {/* <TabsContent value=\"categories\" className=\"space-y-6\">\n            <Card>\n              <CardHeader>\n                <div className=\"flex items-center justify-between\">\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <Layers className=\"w-5 h-5\" />\n                    Categorias de Serviços\n                  </CardTitle>\n                  <Dialog open={isCategoryDialogOpen} onOpenChange={setIsCategoryDialogOpen}>\n                    <DialogTrigger asChild>\n                      <Button \n                        onClick={() => {\n                          setEditingCategory(null);\n                          categoryForm.reset({ name: \"\", description: \"\", code: \"\", typeId: \"\" });\n                        }}\n                        data-testid=\"button-create-category\"\n                      >\n                        <Plus className=\"w-4 h-4 mr-2\" />\n                        Nova Categoria\n                      </Button>\n                    </DialogTrigger>\n                    <DialogContent>\n                      <DialogHeader>\n                        <DialogTitle>\n                          {editingCategory ? \"Editar Categoria\" : \"Nova Categoria\"}\n                        </DialogTitle>\n                      </DialogHeader>\n                      <Form {...categoryForm}>\n                        <form onSubmit={categoryForm.handleSubmit(onSubmitCategory)} className=\"space-y-4\">\n                          <FormField\n                            control={categoryForm.control}\n                            name=\"typeId\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>Tipo de Serviço</FormLabel>\n                                <Select onValueChange={field.onChange} value={field.value}>\n                                  <FormControl>\n                                    <SelectTrigger data-testid=\"select-category-type\">\n                                      <SelectValue placeholder=\"Selecione o tipo\" />\n                                    </SelectTrigger>\n                                  </FormControl>\n                                  <SelectContent>\n                                    {(serviceTypes as any[]).map((type: any) => (\n                                      <SelectItem key={type.id} value={type.id}>\n                                        {type.name}\n                                      </SelectItem>\n                                    ))}\n                                  </SelectContent>\n                                </Select>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n                          <FormField\n                            control={categoryForm.control}\n                            name=\"name\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>Nome</FormLabel>\n                                <FormControl>\n                                  <Input placeholder=\"Ex: Manutenção Elétrica\" {...field} data-testid=\"input-category-name\" />\n                                </FormControl>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n                          <FormField\n                            control={categoryForm.control}\n                            name=\"code\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>Código</FormLabel>\n                                <FormControl>\n                                  <Input placeholder=\"Ex: manutencao_eletrica\" {...field} data-testid=\"input-category-code\" />\n                                </FormControl>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n                          <FormField\n                            control={categoryForm.control}\n                            name=\"description\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>Descrição</FormLabel>\n                                <FormControl>\n                                  <Textarea \n                                    placeholder=\"Descrição da categoria\" \n                                    {...field} \n                                    data-testid=\"input-category-description\"\n                                  />\n                                </FormControl>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n                          <div className=\"flex justify-end space-x-2\">\n                            <Button \n                              type=\"button\" \n                              variant=\"outline\" \n                              onClick={() => setIsCategoryDialogOpen(false)}\n                            >\n                              Cancelar\n                            </Button>\n                            <Button \n                              type=\"submit\" \n                              disabled={createCategoryMutation.isPending || updateCategoryMutation.isPending}\n                              data-testid=\"button-save-category\"\n                            >\n                              {editingCategory ? \"Atualizar\" : \"Criar\"}\n                            </Button>\n                          </div>\n                        </form>\n                      </Form>\n                    </DialogContent>\n                  </Dialog>\n                </div>\n              </CardHeader>\n              <CardContent>\n                {(serviceCategories as any[]).length === 0 ? (\n                  <div className=\"text-center py-8\">\n                    <Layers className=\"w-12 h-12 text-muted-foreground mx-auto mb-4\" />\n                    <p className=\"text-muted-foreground\">Nenhuma categoria cadastrada</p>\n                    <p className=\"text-sm text-muted-foreground mt-2\">\n                      Crie categorias para classificar seus serviços\n                    </p>\n                  </div>\n                ) : (\n                  <div className=\"space-y-3\">\n                    {(serviceCategories as any[]).map((category: any) => (\n                      <div key={category.id} className=\"border border-border rounded-lg p-4 hover:bg-muted/30 transition-colors\">\n                        <div className=\"flex items-start justify-between\">\n                          <div className=\"flex-1\">\n                            <div className=\"flex items-center space-x-3 mb-2\">\n                              <h3 className=\"text-lg font-semibold text-foreground\">{category.name}</h3>\n                              <Badge variant=\"outline\">{category.code}</Badge>\n                              {category.isActive ? (\n                                <Badge className=\"bg-green-100 text-green-800\">Ativa</Badge>\n                              ) : (\n                                <Badge variant=\"outline\">Inativa</Badge>\n                              )}\n                            </div>\n                            {category.description && (\n                              <p className=\"text-sm text-muted-foreground mb-2\">{category.description}</p>\n                            )}\n                            <p className=\"text-xs text-muted-foreground\">\n                              Tipo: {getTypeName(category.typeId)}\n                            </p>\n                          </div>\n                          <div className=\"flex items-center space-x-2\">\n                            <Button \n                              variant=\"ghost\" \n                              size=\"sm\"\n                              onClick={() => handleEditCategory(category)}\n                              data-testid={`button-edit-category-${category.id}`}\n                            >\n                              <Edit className=\"w-4 h-4\" />\n                            </Button>\n                            <Button \n                              variant=\"ghost\" \n                              size=\"sm\"\n                              onClick={() => deleteCategoryMutation.mutate(category.id)}\n                              data-testid={`button-delete-category-${category.id}`}\n                            >\n                              <Trash2 className=\"w-4 h-4\" />\n                            </Button>\n                          </div>\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          </TabsContent> */}\n\n          <TabsContent value=\"services\" className=\"space-y-6\">\n            <Services customerId={customerId} />\n          </TabsContent>\n\n          <TabsContent value=\"goals\" className=\"space-y-6\">\n            <Card>\n              <CardHeader>\n                <div className=\"flex items-center justify-between\">\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <Target className=\"w-5 h-5\" />\n                    Metas do Dashboard\n                  </CardTitle>\n                  <Dialog open={isGoalDialogOpen} onOpenChange={setIsGoalDialogOpen}>\n                    <DialogTrigger asChild>\n                      <Button \n                        onClick={() => {\n                          setEditingGoal(null);\n                          goalForm.reset({ \n                            goalType: \"\", \n                            goalValue: \"\", \n                            currentPeriod: new Date().toISOString().slice(0, 7) \n                          });\n                        }}\n                        data-testid=\"button-create-goal\"\n                      >\n                        <Plus className=\"w-4 h-4 mr-2\" />\n                        Nova Meta\n                      </Button>\n                    </DialogTrigger>\n                    <DialogContent>\n                      <DialogHeader>\n                        <DialogTitle>\n                          {editingGoal ? \"Editar Meta\" : \"Nova Meta\"}\n                        </DialogTitle>\n                      </DialogHeader>\n                      <Form {...goalForm}>\n                        <form onSubmit={goalForm.handleSubmit(onSubmitGoal)} className=\"space-y-4\">\n                          <FormField\n                            control={goalForm.control}\n                            name=\"goalType\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>Tipo de Meta</FormLabel>\n                                <Select onValueChange={field.onChange} value={field.value}>\n                                  <FormControl>\n                                    <SelectTrigger data-testid=\"select-goal-type\">\n                                      <SelectValue placeholder=\"Selecione o tipo de meta\" />\n                                    </SelectTrigger>\n                                  </FormControl>\n                                  <SelectContent>\n                                    <SelectItem value=\"eficiencia_operacional\">\n                                      <div className=\"flex items-center gap-2\">\n                                        <div className=\"w-2 h-2 rounded-full bg-emerald-500\"></div>\n                                        <span>Eficiência Operacional (%)</span>\n                                      </div>\n                                    </SelectItem>\n                                    <SelectItem value=\"sla_compliance\">\n                                      <div className=\"flex items-center gap-2\">\n                                        <div className=\"w-2 h-2 rounded-full bg-blue-500\"></div>\n                                        <span>SLA Compliance (%)</span>\n                                      </div>\n                                    </SelectItem>\n                                    <SelectItem value=\"os_concluidas_mes\">\n                                      <div className=\"flex items-center gap-2\">\n                                        <div className=\"w-2 h-2 rounded-full bg-purple-500\"></div>\n                                        <span>OS Concluídas no Mês</span>\n                                      </div>\n                                    </SelectItem>\n                                    <SelectItem value=\"indice_qualidade\">\n                                      <div className=\"flex items-center gap-2\">\n                                        <div className=\"w-2 h-2 rounded-full bg-orange-500\"></div>\n                                        <span>Índice de Qualidade (0-10)</span>\n                                      </div>\n                                    </SelectItem>\n                                    <SelectItem value=\"performance_mensal\">\n                                      <div className=\"flex items-center gap-2\">\n                                        <div className=\"w-2 h-2 rounded-full bg-indigo-500\"></div>\n                                        <span>Performance Mensal (%)</span>\n                                      </div>\n                                    </SelectItem>\n                                  </SelectContent>\n                                </Select>\n                                {field.value && (\n                                  <p className=\"text-xs text-muted-foreground mt-2\">\n                                    📊 Esta meta aparecerá {field.value === 'performance_mensal' ? 'como linha no gráfico de Performance ao longo do tempo' : 'no card'} <strong>\n                                      {field.value === 'eficiencia_operacional' && 'verde (Eficiência Operacional)'}\n                                      {field.value === 'sla_compliance' && 'azul (SLA Compliance)'}\n                                      {field.value === 'os_concluidas_mes' && 'roxo (OS Concluídas)'}\n                                      {field.value === 'indice_qualidade' && 'laranja (Índice de Qualidade)'}\n                                      {field.value === 'performance_mensal' && 'índigo (Performance Mensal)'}\n                                    </strong> {field.value !== 'performance_mensal' && 'do dashboard'}\n                                  </p>\n                                )}\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n                          <FormField\n                            control={goalForm.control}\n                            name=\"goalValue\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>Valor da Meta</FormLabel>\n                                <FormControl>\n                                  <Input \n                                    type=\"number\" \n                                    placeholder=\"Ex: 100\" \n                                    {...field} \n                                    data-testid=\"input-goal-value\" \n                                  />\n                                </FormControl>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n                          <FormField\n                            control={goalForm.control}\n                            name=\"currentPeriod\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>Período</FormLabel>\n                                <FormControl>\n                                  <Input \n                                    type=\"month\" \n                                    {...field} \n                                    data-testid=\"input-goal-period\"\n                                  />\n                                </FormControl>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n                          <div className=\"flex justify-end space-x-2\">\n                            <Button \n                              type=\"button\" \n                              variant=\"outline\" \n                              onClick={() => setIsGoalDialogOpen(false)}\n                            >\n                              Cancelar\n                            </Button>\n                            <Button \n                              type=\"submit\" \n                              disabled={createGoalMutation.isPending || updateGoalMutation.isPending}\n                              data-testid=\"button-save-goal\"\n                            >\n                              {editingGoal ? \"Atualizar\" : \"Criar\"}\n                            </Button>\n                          </div>\n                        </form>\n                      </Form>\n                    </DialogContent>\n                  </Dialog>\n                </div>\n              </CardHeader>\n              <CardContent>\n                {(dashboardGoals as any[]).length === 0 ? (\n                  <div className=\"text-center py-8\">\n                    <Target className=\"w-12 h-12 text-muted-foreground mx-auto mb-4\" />\n                    <p className=\"text-muted-foreground\">Nenhuma meta configurada</p>\n                    <p className=\"text-sm text-muted-foreground mt-2\">\n                      Configure metas para acompanhar o desempenho no dashboard\n                    </p>\n                  </div>\n                ) : (\n                  <div className=\"space-y-3\">\n                    {(dashboardGoals as any[]).map((goal: any) => (\n                      <div key={goal.id} className=\"border border-border rounded-lg p-4 hover:bg-muted/30 transition-colors\">\n                        <div className=\"flex items-start justify-between\">\n                          <div className=\"flex-1\">\n                            <div className=\"flex items-center space-x-3 mb-2\">\n                              {goal.goalType === 'eficiencia_operacional' && <div className=\"w-3 h-3 rounded-full bg-emerald-500\"></div>}\n                              {goal.goalType === 'sla_compliance' && <div className=\"w-3 h-3 rounded-full bg-blue-500\"></div>}\n                              {goal.goalType === 'os_concluidas_mes' && <div className=\"w-3 h-3 rounded-full bg-purple-500\"></div>}\n                              {goal.goalType === 'indice_qualidade' && <div className=\"w-3 h-3 rounded-full bg-orange-500\"></div>}\n                              {goal.goalType === 'performance_mensal' && <div className=\"w-3 h-3 rounded-full bg-indigo-500\"></div>}\n                              <h3 className=\"text-lg font-semibold text-foreground\">\n                                {goal.goalType === 'eficiencia_operacional' && 'Eficiência Operacional'}\n                                {goal.goalType === 'sla_compliance' && 'SLA Compliance'}\n                                {goal.goalType === 'os_concluidas_mes' && 'OS Concluídas no Mês'}\n                                {goal.goalType === 'indice_qualidade' && 'Índice de Qualidade'}\n                                {goal.goalType === 'performance_mensal' && 'Performance Mensal'}\n                              </h3>\n                              <Badge variant=\"outline\">\n                                Meta: {goal.goalValue}{goal.goalType === 'os_concluidas_mes' ? ' OS' : goal.goalType === 'indice_qualidade' ? '/10' : '%'}\n                              </Badge>\n                              {goal.isActive ? (\n                                <Badge className=\"bg-green-100 text-green-800\">Ativa</Badge>\n                              ) : (\n                                <Badge variant=\"outline\">Inativa</Badge>\n                              )}\n                            </div>\n                            <p className=\"text-sm text-muted-foreground\">\n                              📅 Período: {goal.currentPeriod} • 📊 {\n                                goal.goalType === 'performance_mensal' \n                                  ? 'Aparece como linha no gráfico de Performance ao longo do tempo'\n                                  : `Aparece no card ${\n                                      goal.goalType === 'eficiencia_operacional' ? 'verde' : \n                                      goal.goalType === 'sla_compliance' ? 'azul' : \n                                      goal.goalType === 'os_concluidas_mes' ? 'roxo' : \n                                      'laranja'\n                                    } do dashboard`\n                              }\n                            </p>\n                          </div>\n                          <div className=\"flex items-center space-x-2\">\n                            <Button \n                              variant=\"ghost\" \n                              size=\"sm\"\n                              onClick={() => handleEditGoal(goal)}\n                              data-testid={`button-edit-goal-${goal.id}`}\n                            >\n                              <Edit className=\"w-4 h-4\" />\n                            </Button>\n                            <Button \n                              variant=\"ghost\" \n                              size=\"sm\"\n                              onClick={() => deleteGoalMutation.mutate(goal.id)}\n                              data-testid={`button-delete-goal-${goal.id}`}\n                            >\n                              <Trash2 className=\"w-4 h-4\" />\n                            </Button>\n                          </div>\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          </TabsContent>\n\n\n          <TabsContent value=\"sites\" className=\"space-y-6\">\n            <Sites customerId={customerId} />\n          </TabsContent>\n\n          <TabsContent value=\"users\" className=\"space-y-6\">\n            <Users customerId={customerId} />\n          </TabsContent>\n        </Tabs>\n      </div>\n    </div>\n  );\n}","size_bytes":44608},"client/src/components/ui/aspect-ratio.tsx":{"content":"import * as AspectRatioPrimitive from \"@radix-ui/react-aspect-ratio\"\n\nconst AspectRatio = AspectRatioPrimitive.Root\n\nexport { AspectRatio }\n","size_bytes":140},"client/src/components/ui/checkbox.tsx":{"content":"import * as React from \"react\"\nimport * as CheckboxPrimitive from \"@radix-ui/react-checkbox\"\nimport { Check } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Checkbox = React.forwardRef<\n  React.ElementRef<typeof CheckboxPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <CheckboxPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground\",\n      className\n    )}\n    {...props}\n  >\n    <CheckboxPrimitive.Indicator\n      className={cn(\"flex items-center justify-center text-current\")}\n    >\n      <Check className=\"h-4 w-4\" />\n    </CheckboxPrimitive.Indicator>\n  </CheckboxPrimitive.Root>\n))\nCheckbox.displayName = CheckboxPrimitive.Root.displayName\n\nexport { Checkbox }\n","size_bytes":1056},"client/src/App.tsx":{"content":"import { Switch, Route, useLocation, Redirect } from \"wouter\";\nimport { queryClient } from \"./lib/queryClient\";\nimport { QueryClientProvider } from \"@tanstack/react-query\";\nimport { Toaster } from \"@/components/ui/toaster\";\nimport { TooltipProvider } from \"@/components/ui/tooltip\";\nimport { ClientProvider, useClient } from \"@/contexts/ClientContext\";\nimport { ModuleProvider, useModule } from \"@/contexts/ModuleContext\";\nimport NotFound from \"@/pages/not-found\";\nimport Dashboard from \"@/pages/dashboard\";\nimport WorkOrders from \"@/pages/work-orders\";\nimport CleaningSchedule from \"@/pages/cleaning-schedule\";\nimport QrCodes from \"@/pages/qr-codes\";\nimport Sites from \"@/pages/sites\";\nimport FloorPlan from \"@/pages/floor-plan\";\nimport SystemUsers from \"@/pages/system-users\";\nimport Reports from \"@/pages/reports\";\nimport Checklists from \"@/pages/checklists\";\nimport Services from \"@/pages/services\";\nimport ServiceSettings from \"@/pages/service-settings\";\nimport AuditLogs from \"@/pages/audit-logs\";\nimport AdminMobile from \"@/pages/admin-mobile\";\nimport Customers from \"@/pages/customers\";\nimport Roles from \"@/pages/roles\";\nimport Equipment from \"@/pages/equipment\";\nimport MaintenancePlans from \"@/pages/maintenance-plans\";\nimport MaintenanceChecklistTemplates from \"@/pages/maintenance-checklist-templates\";\nimport { useIsMobile } from \"@/hooks/use-mobile\";\nimport QrExecution from \"@/pages/qr-execution\";\nimport QrPublic from \"@/pages/qr-public\";\nimport Login from \"@/pages/login\";\nimport LoginMobile from \"@/pages/login-mobile\";\nimport ModuleSelection from \"@/pages/module-selection\";\nimport MobileDashboard from \"@/pages/mobile-dashboard\";\nimport MobileQrScanner from \"@/pages/mobile-qr-scanner\";\nimport MobileWorkOrderExecute from \"@/pages/mobile-work-order-execute\";\nimport MobileWorkOrderDetails from \"@/pages/mobile-work-order-details\";\nimport QrTest from \"@/pages/qr-test\";\nimport Sidebar from \"@/components/layout/sidebar\";\nimport { useState } from \"react\";\nimport { useAuth, getAuthState } from \"@/hooks/useAuth\";\nimport { ProtectedRoute } from \"@/components/ProtectedRoute\";\nimport { usePermissions } from \"@/hooks/usePermissions\";\nimport { ErrorBoundary } from \"@/components/ErrorBoundary\";\n\nfunction AuthenticatedAdminRouter() {\n  const { activeClientId, isLoading } = useClient();\n  const [sidebarCollapsed, setSidebarCollapsed] = useState<boolean>(false);\n  const isMobile = useIsMobile();\n  const { user } = useAuth();\n  \n  const companyId = user?.companyId || \"company-opus-default\";\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-screen\">\n        <div>Carregando...</div>\n      </div>\n    );\n  }\n\n  if (isMobile) {\n    return <AdminMobile companyId={companyId} />;\n  }\n\n  return (\n    <div className=\"flex min-h-screen bg-background\">\n      <Sidebar \n        isCollapsed={sidebarCollapsed}\n        onToggleCollapse={() => setSidebarCollapsed(!sidebarCollapsed)}\n      />\n      <div className=\"flex-1 flex flex-col min-h-screen overflow-y-auto\">\n        <Switch>\n          <Route path=\"/\" component={() => <Dashboard />} />\n          <Route path=\"/workorders\" component={() => <WorkOrders />} />\n          <Route path=\"/schedule\" component={() => <CleaningSchedule />} />\n          <Route path=\"/checklists\" component={() => <Checklists />} />\n          <Route path=\"/services\" component={() => <Services customerId={activeClientId} />} />\n          <Route path=\"/service-settings\" component={() => <ServiceSettings />} />\n          <Route path=\"/qrcodes\" component={() => <QrCodes />} />\n          <Route path=\"/sites\" component={() => <Sites customerId={activeClientId} />} />\n          <Route path=\"/floor-plan\" component={() => <FloorPlan />} />\n          <Route path=\"/users\" component={() => <SystemUsers />} />\n          <Route path=\"/customers\" component={() => <Customers companyId={companyId} />} />\n          <Route path=\"/roles\" component={() => <Roles />} />\n          <Route path=\"/reports\" component={() => <Reports />} />\n          <Route path=\"/audit-logs\" component={() => <AuditLogs companyId={companyId} />} />\n          \n          {/* Maintenance Module Routes */}\n          <Route path=\"/equipment\" component={() => <Equipment customerId={activeClientId} />} />\n          <Route path=\"/maintenance-plans\" component={() => <MaintenancePlans />} />\n          <Route path=\"/maintenance-checklist-templates\" component={() => <MaintenanceChecklistTemplates customerId={activeClientId} />} />\n          \n          {/* Redirecionar rotas de login para dashboard se já autenticado */}\n          <Route path=\"/login\">\n            <Redirect to=\"/\" />\n          </Route>\n          <Route path=\"/login-mobile\">\n            <Redirect to=\"/\" />\n          </Route>\n          \n          {/* Redirecionar qualquer outra rota inválida para home */}\n          <Route>\n            <Redirect to=\"/\" />\n          </Route>\n        </Switch>\n      </div>\n    </div>\n  );\n}\n\nfunction MobileRouter() {\n  return (\n    <Switch>\n      <Route path=\"/mobile\" component={MobileDashboard} />\n      <Route path=\"/mobile/qr-scanner\" component={MobileQrScanner} />\n      <Route path=\"/mobile/qr-test\" component={QrTest} />\n      <Route path=\"/mobile/work-order-details/:id\" component={MobileWorkOrderDetails} />\n      <Route path=\"/mobile/work-order/:id\" component={MobileWorkOrderExecute} />\n      <Route path=\"/qr-public/:code\" component={QrPublic} />\n      <Route component={() => <MobileDashboard />} />\n    </Switch>\n  );\n}\n\nfunction Router() {\n  const { user, isAuthenticated } = useAuth();\n  const { isMobileOnlyUser, isLoading } = usePermissions();\n  const [location] = useLocation();\n\n  // Se não está autenticado, mostrar login\n  if (!isAuthenticated || !user) {\n    return (\n      <Switch>\n        <Route path=\"/qr-public/:code\" component={QrPublic} />\n        <Route path=\"/mobile/qr-scanner\" component={MobileQrScanner} />\n        <Route path=\"/module-selection\" component={ModuleSelection} />\n        <Route path=\"/login-mobile\" component={LoginMobile} />\n        <Route path=\"/login\" component={Login} />\n        <Route component={Login} />\n      </Switch>\n    );\n  }\n\n  // Module selection page - no sidebar, accessible when authenticated\n  if (location === \"/module-selection\") {\n    return <ModuleSelection />;\n  }\n\n  // Aguardar carregamento das permissões antes de rotear\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-screen\">\n        <div>Carregando permissões...</div>\n      </div>\n    );\n  }\n\n  // Se é colaborador (operador com apenas permissões mobile), mostrar interface móvel\n  if (isMobileOnlyUser) {\n    return <MobileRouter />;\n  }\n\n  // Se é admin/supervisor/cliente, mostrar interface administrativa web\n  return <AuthenticatedAdminRouter />;\n}\n\nfunction App() {\n  return (\n    <ErrorBoundary>\n      <QueryClientProvider client={queryClient}>\n        <ClientProvider>\n          <ModuleProvider>\n            <TooltipProvider>\n              <Toaster />\n              <Router />\n            </TooltipProvider>\n          </ModuleProvider>\n        </ClientProvider>\n      </QueryClientProvider>\n    </ErrorBoundary>\n  );\n}\n\nexport default App;\n","size_bytes":7178},"client/src/components/ui/badge.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst badgeVariants = cva(\n  \"inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"border-transparent bg-primary text-primary-foreground hover:bg-primary/80\",\n        secondary:\n          \"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80\",\n        destructive:\n          \"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80\",\n        outline: \"text-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nexport interface BadgeProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof badgeVariants> {}\n\nfunction Badge({ className, variant, ...props }: BadgeProps) {\n  return (\n    <div className={cn(badgeVariants({ variant }), className)} {...props} />\n  )\n}\n\nexport { Badge, badgeVariants }\n","size_bytes":1128},"client/src/pages/sites.tsx":{"content":"import Header from \"@/components/layout/header\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useState } from \"react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useModule } from \"@/contexts/ModuleContext\";\nimport { \n  Plus, \n  Building, \n  MapPin, \n  Eye, \n  Edit, \n  Trash2,\n  Settings,\n  QrCode,\n  Thermometer\n} from \"lucide-react\";\nimport CleaningHeatmap from \"@/components/heatmap/CleaningHeatmap\";\n\ninterface SitesProps {\n  customerId: string;\n}\n\nexport default function Sites({ customerId }: SitesProps) {\n  const { currentModule } = useModule();\n  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);\n  const [isCreateZoneDialogOpen, setIsCreateZoneDialogOpen] = useState(false);\n  const [isEditZoneDialogOpen, setIsEditZoneDialogOpen] = useState(false);\n  const [isEditSiteDialogOpen, setIsEditSiteDialogOpen] = useState(false);\n  const [selectedSiteId, setSelectedSiteId] = useState<string>(\"\");\n  const [editingZone, setEditingZone] = useState<any>(null);\n  const [editingSite, setEditingSite] = useState<any>(null);\n  const [siteName, setSiteName] = useState(\"\");\n  const [siteAddress, setSiteAddress] = useState(\"\");\n  const [siteDescription, setSiteDescription] = useState(\"\");\n  const [zoneName, setZoneName] = useState(\"\");\n  const [zoneDescription, setZoneDescription] = useState(\"\");\n  const [zoneAreaM2, setZoneAreaM2] = useState(\"\");\n  const [zoneCapacity, setZoneCapacity] = useState(\"\");\n  const [zoneCategory, setZoneCategory] = useState(\"\");\n  const [editZoneAreaM2, setEditZoneAreaM2] = useState(\"\");\n  const [editZoneName, setEditZoneName] = useState(\"\");\n  const [editZoneDescription, setEditZoneDescription] = useState(\"\");\n  const [editZoneCapacity, setEditZoneCapacity] = useState(\"\");\n  const [editZoneCategory, setEditZoneCategory] = useState(\"\");\n  const [editSiteName, setEditSiteName] = useState(\"\");\n  const [editSiteAddress, setEditSiteAddress] = useState(\"\");\n  const [editSiteDescription, setEditSiteDescription] = useState(\"\");\n\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  const { data: sites, isLoading } = useQuery({\n    queryKey: [\"/api/customers\", customerId, \"sites\", { module: currentModule }],\n    enabled: !!customerId,\n  });\n\n  // Buscar dados do cliente para obter companyId\n  const { data: customer } = useQuery({\n    queryKey: [\"/api/customers\", customerId],\n    enabled: !!customerId,\n  });\n\n  const { data: zones } = useQuery({\n    queryKey: [\"/api/sites\", selectedSiteId, \"zones\", { module: currentModule }],\n    enabled: !!selectedSiteId,\n  });\n\n  const createSiteMutation = useMutation({\n    mutationFn: async (data: any) => {\n      return await apiRequest(\"POST\", `/api/customers/${customerId}/sites`, { ...data, customerId });\n    },\n    onSuccess: () => {\n      toast({ title: \"Local criado com sucesso\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/customers\", customerId, \"sites\"] });\n      setIsCreateDialogOpen(false);\n      setSiteName(\"\");\n      setSiteAddress(\"\");\n      setSiteDescription(\"\");\n    },\n    onError: () => {\n      toast({ \n        title: \"Erro ao criar local\", \n        variant: \"destructive\" \n      });\n    },\n  });\n\n  const createZoneMutation = useMutation({\n    mutationFn: async (data: any) => {\n      return await apiRequest(\"POST\", \"/api/zones\", data);\n    },\n    onSuccess: () => {\n      toast({ title: \"Zona criada com sucesso\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/sites\", selectedSiteId, \"zones\"] });\n      setIsCreateZoneDialogOpen(false);\n      setZoneName(\"\");\n      setZoneDescription(\"\");\n      setZoneAreaM2(\"\");\n      setZoneCapacity(\"\");\n      setZoneCategory(\"\");\n    },\n    onError: (error: any) => {\n      toast({ \n        title: \"Erro ao criar zona\", \n        description: error.message || \"Erro desconhecido\",\n        variant: \"destructive\" \n      });\n    },\n  });\n\n  const updateZoneMutation = useMutation({\n    mutationFn: async (data: any) => {\n      return await apiRequest(\"PATCH\", `/api/zones/${data.id}`, data);\n    },\n    onSuccess: () => {\n      toast({ title: \"Zona atualizada com sucesso\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/sites\", selectedSiteId, \"zones\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/customers\", customerId, \"dashboard-stats\"] });\n      setIsEditZoneDialogOpen(false);\n      setEditingZone(null);\n      setEditZoneName(\"\");\n      setEditZoneDescription(\"\");\n      setEditZoneAreaM2(\"\");\n      setEditZoneCapacity(\"\");\n      setEditZoneCategory(\"\");\n    },\n    onError: () => {\n      toast({ \n        title: \"Erro ao atualizar zona\", \n        variant: \"destructive\" \n      });\n    },\n  });\n\n  const updateSiteMutation = useMutation({\n    mutationFn: async (data: any) => {\n      return await apiRequest(\"PUT\", `/api/sites/${data.id}`, data);\n    },\n    onSuccess: () => {\n      toast({ title: \"Local atualizado com sucesso\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/customers\", customerId, \"sites\"] });\n      setIsEditSiteDialogOpen(false);\n      setEditingSite(null);\n      setEditSiteName(\"\");\n      setEditSiteAddress(\"\");\n      setEditSiteDescription(\"\");\n    },\n    onError: () => {\n      toast({ \n        title: \"Erro ao atualizar local\", \n        variant: \"destructive\" \n      });\n    },\n  });\n\n  const deleteSiteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return await apiRequest(\"DELETE\", `/api/sites/${id}`);\n    },\n    onSuccess: () => {\n      toast({ title: \"Local excluído com sucesso\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/customers\", customerId, \"sites\"] });\n      setSelectedSiteId(\"\");\n    },\n    onError: () => {\n      toast({ \n        title: \"Erro ao excluir local\", \n        variant: \"destructive\" \n      });\n    },\n  });\n\n  const deleteZoneMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return await apiRequest(\"DELETE\", `/api/zones/${id}`);\n    },\n    onSuccess: () => {\n      toast({ title: \"Zona excluída com sucesso\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/sites\", selectedSiteId, \"zones\"] });\n    },\n    onError: () => {\n      toast({ \n        title: \"Erro ao excluir zona\", \n        variant: \"destructive\" \n      });\n    },\n  });\n\n  const handleCreateSite = () => {\n    if (!siteName.trim()) {\n      toast({ \n        title: \"Erro de validação\",\n        description: \"Nome do local é obrigatório\", \n        variant: \"destructive\" \n      });\n      return;\n    }\n    \n    if (!siteAddress.trim()) {\n      toast({ \n        title: \"Erro de validação\",\n        description: \"Endereço é obrigatório para identificação do local\", \n        variant: \"destructive\" \n      });\n      return;\n    }\n\n    if (!customer || !(customer as any).companyId) {\n      toast({ \n        title: \"Erro\",\n        description: \"Dados do cliente não carregados. Tente novamente.\", \n        variant: \"destructive\" \n      });\n      return;\n    }\n\n    createSiteMutation.mutate({\n      companyId: (customer as any).companyId,\n      customerId,\n      module: currentModule,\n      name: siteName.trim(),\n      address: siteAddress.trim(),\n      description: siteDescription.trim() || null,\n    });\n  };\n\n  const handleCreateZone = () => {\n    if (!zoneName.trim() || !selectedSiteId) {\n      toast({ \n        title: \"Nome da zona é obrigatório\", \n        variant: \"destructive\" \n      });\n      return;\n    }\n\n    // Generate random initial position for floor plan\n    const randomX = Math.random() * 60 + 20; // 20-80% range  \n    const randomY = Math.random() * 60 + 20; // 20-80% range\n\n    const dataToSend = {\n      siteId: selectedSiteId,\n      module: currentModule,\n      name: zoneName.trim(),\n      description: zoneDescription?.trim() || null,\n      areaM2: zoneAreaM2 ? zoneAreaM2 : null,\n      capacity: zoneCapacity ? parseInt(zoneCapacity) : null,\n      category: zoneCategory || null,\n      // Auto-generate floor plan positioning\n      positionX: randomX.toFixed(2),\n      positionY: randomY.toFixed(2),\n      sizeScale: \"1.00\",\n    };\n    \n    createZoneMutation.mutate(dataToSend);\n  };\n\n  const handleEditZone = (zone: any) => {\n    setEditingZone(zone);\n    setEditZoneName(zone.name || \"\");\n    setEditZoneDescription(zone.description || \"\");\n    setEditZoneAreaM2(zone.areaM2 || \"\");\n    setEditZoneCapacity(zone.capacity || \"\");\n    setEditZoneCategory(zone.category || \"\");\n    setIsEditZoneDialogOpen(true);\n  };\n\n  const handleUpdateZone = () => {\n    if (!editingZone || !editZoneName.trim()) {\n      toast({ \n        title: \"Nome é obrigatório\", \n        variant: \"destructive\" \n      });\n      return;\n    }\n\n    updateZoneMutation.mutate({\n      id: editingZone.id,\n      name: editZoneName.trim(),\n      description: editZoneDescription.trim() || null,\n      areaM2: editZoneAreaM2 ? editZoneAreaM2 : null,\n      capacity: editZoneCapacity ? parseInt(editZoneCapacity) : null,\n      category: editZoneCategory || null,\n    });\n  };\n\n  const handleEditSite = (site: any) => {\n    setEditingSite(site);\n    setEditSiteName(site.name);\n    setEditSiteAddress(site.address || \"\");\n    setEditSiteDescription(site.description || \"\");\n    setIsEditSiteDialogOpen(true);\n  };\n\n  const handleUpdateSite = () => {\n    if (!editingSite || !editSiteName.trim()) {\n      toast({ \n        title: \"Nome do local é obrigatório\", \n        variant: \"destructive\" \n      });\n      return;\n    }\n\n    updateSiteMutation.mutate({\n      id: editingSite.id,\n      name: editSiteName,\n      address: editSiteAddress,\n      description: editSiteDescription,\n    });\n  };\n\n  const handleDeleteSite = (site: any) => {\n    if (confirm(`Tem certeza que deseja excluir o local \"${site.name}\"?`)) {\n      deleteSiteMutation.mutate(site.id);\n    }\n  };\n\n  const getCategoryBadge = (category: string) => {\n    switch (category) {\n      case \"banheiro\":\n        return <Badge className=\"bg-blue-100 text-blue-800\">Banheiro</Badge>;\n      case \"escritorio\":\n        return <Badge className=\"bg-green-100 text-green-800\">Escritório</Badge>;\n      case \"producao\":\n        return <Badge className=\"bg-orange-100 text-orange-800\">Produção</Badge>;\n      case \"externo\":\n        return <Badge className=\"bg-purple-100 text-purple-800\">Externo</Badge>;\n      case \"jardim\":\n        return <Badge className=\"bg-emerald-100 text-emerald-800\">Jardim</Badge>;\n      default:\n        return <Badge variant=\"outline\">{category || \"Sem categoria\"}</Badge>;\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"flex-1 flex items-center justify-center\">\n        <div>Carregando locais...</div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h2 className=\"text-2xl font-bold text-foreground\">Locais e Zonas</h2>\n          <p className=\"text-muted-foreground\">Gerenciamento de locais da empresa e suas zonas</p>\n        </div>\n        <div className=\"flex items-center space-x-2\">\n          <Dialog open={isCreateDialogOpen} onOpenChange={setIsCreateDialogOpen}>\n            <DialogTrigger asChild>\n              <Button data-testid=\"button-create-site\">\n                <Plus className=\"w-4 h-4 mr-2\" />\n                Novo Local\n              </Button>\n            </DialogTrigger>\n            <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n              <DialogHeader>\n                <DialogTitle className=\"text-xl font-bold flex items-center gap-2\">\n                  <Building className=\"w-5 h-5\" />\n                  Criar Novo Local\n                </DialogTitle>\n                <DialogDescription>\n                  Adicione um novo local de trabalho com todas as informações necessárias para gestão de facilities\n                </DialogDescription>\n              </DialogHeader>\n              <div className=\"space-y-6\">\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                  <div>\n                    <label className=\"block text-sm font-medium text-foreground mb-2\">\n                      Nome do Local *\n                    </label>\n                    <Input\n                      placeholder=\"Ex: Fábrica Principal\"\n                      value={siteName}\n                      onChange={(e) => setSiteName(e.target.value)}\n                      data-testid=\"input-site-name\"\n                      className=\"border-2\"\n                    />\n                    <p className=\"text-xs text-muted-foreground mt-1\">Nome identificador único do local</p>\n                  </div>\n                </div>\n                \n                <div>\n                  <label className=\"block text-sm font-medium text-foreground mb-2\">\n                    Endereço Completo *\n                  </label>\n                  <Input\n                    placeholder=\"Rua, número, bairro, cidade - CEP\"\n                    value={siteAddress}\n                    onChange={(e) => setSiteAddress(e.target.value)}\n                    data-testid=\"input-site-address\"\n                    className=\"border-2\"\n                  />\n                  <p className=\"text-xs text-muted-foreground mt-1\">Endereço completo para localização e entregas</p>\n                </div>\n                \n                <div>\n                  <label className=\"block text-sm font-medium text-foreground mb-2\">\n                    Descrição e Observações\n                  </label>\n                  <Textarea\n                    placeholder=\"Detalhes sobre o local: horário de funcionamento, responsável, características especiais...\"\n                    value={siteDescription}\n                    onChange={(e) => setSiteDescription(e.target.value)}\n                    data-testid=\"textarea-site-description\"\n                    rows={3}\n                  />\n                </div>\n                <div className=\"flex justify-end space-x-2\">\n                  <Button \n                    variant=\"outline\" \n                    onClick={() => setIsCreateDialogOpen(false)}\n                    data-testid=\"button-cancel-site\"\n                  >\n                    Cancelar\n                  </Button>\n                  <Button \n                    onClick={handleCreateSite}\n                    disabled={createSiteMutation.isPending}\n                    data-testid=\"button-save-site\"\n                  >\n                    {createSiteMutation.isPending ? \"Criando...\" : \"Criar Local\"}\n                  </Button>\n                </div>\n              </div>\n            </DialogContent>\n          </Dialog>\n        </div>\n      </div>\n      \n      <div className=\"space-y-6\">\n        {/* Sites List */}\n        <Card className=\"mb-6\">\n          <CardHeader>\n            <CardTitle>Locais da Empresa</CardTitle>\n          </CardHeader>\n          <CardContent>\n            {!sites || (sites as any[]).length === 0 ? (\n              <div className=\"text-center py-8\">\n                <Building className=\"w-12 h-12 text-muted-foreground mx-auto mb-4\" />\n                <p className=\"text-muted-foreground\">Nenhum local cadastrado</p>\n                <p className=\"text-sm text-muted-foreground mt-2\">\n                  Crie seu primeiro local para começar\n                </p>\n                <Button \n                  className=\"mt-4\"\n                  onClick={() => setIsCreateDialogOpen(true)}\n                  data-testid=\"button-create-first-site\"\n                >\n                  <Plus className=\"w-4 h-4 mr-2\" />\n                  Criar Primeiro Local\n                </Button>\n              </div>\n            ) : (\n              <div className=\"space-y-4\">\n                {(sites as any[]).map((site: any) => (\n                  <div \n                    key={site.id} \n                    className={`border border-border rounded-lg p-4 hover:bg-muted/30 transition-colors cursor-pointer ${\n                      selectedSiteId === site.id ? \"bg-muted/50 border-primary\" : \"\"\n                    }`}\n                    onClick={() => setSelectedSiteId(site.id)}\n                  >\n                    <div className=\"flex items-start justify-between\">\n                      <div className=\"flex-1\">\n                        <div className=\"flex items-center space-x-3 mb-2\">\n                          <Building className=\"w-5 h-5 text-primary\" />\n                          <h3 className=\"text-lg font-semibold text-foreground\">\n                            {site.name}\n                          </h3>\n                          {site.isActive ? (\n                            <Badge className=\"bg-chart-2/10 text-chart-2\">Ativo</Badge>\n                          ) : (\n                            <Badge variant=\"outline\">Inativo</Badge>\n                          )}\n                        </div>\n                        \n                        {site.address && (\n                          <div className=\"flex items-center space-x-2 text-sm text-muted-foreground mb-2\">\n                            <MapPin className=\"w-4 h-4\" />\n                            <span>{site.address}</span>\n                          </div>\n                        )}\n                        \n                        {site.description && (\n                          <p className=\"text-sm text-muted-foreground\">{site.description}</p>\n                        )}\n                      </div>\n                      \n                      <div className=\"flex items-center space-x-1 md:space-x-2\">\n                        <Button \n                          variant=\"ghost\" \n                          size=\"sm\"\n                          className=\"h-8 w-8 md:h-9 md:w-9\"\n                          data-testid={`button-view-site-${site.id}`}\n                        >\n                          <Eye className=\"w-3 h-3 md:w-4 md:h-4\" />\n                        </Button>\n                        <Button \n                          variant=\"ghost\" \n                          size=\"sm\"\n                          className=\"h-8 w-8 md:h-9 md:w-9\"\n                          onClick={(e) => {\n                            e.stopPropagation();\n                            handleEditSite(site);\n                          }}\n                          data-testid={`button-edit-site-${site.id}`}\n                        >\n                          <Edit className=\"w-3 h-3 md:w-4 md:h-4\" />\n                        </Button>\n                        <Button \n                          variant=\"ghost\" \n                          size=\"sm\"\n                          className=\"h-8 w-8 md:h-9 md:w-9\"\n                          onClick={(e) => {\n                            e.stopPropagation();\n                            handleDeleteSite(site);\n                          }}\n                          data-testid={`button-delete-site-${site.id}`}\n                        >\n                          <Trash2 className=\"w-3 h-3 md:w-4 md:h-4\" />\n                        </Button>\n                      </div>\n                    </div>\n                  </div>\n                ))}\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        {/* Zones List for Selected Site */}\n        {selectedSiteId && (\n          <Card>\n            <CardHeader>\n              <div className=\"flex items-center justify-between\">\n                <CardTitle>\n                  Zonas do Local: {(sites as any[])?.find((s: any) => s.id === selectedSiteId)?.name}\n                </CardTitle>\n                <Dialog open={isCreateZoneDialogOpen} onOpenChange={setIsCreateZoneDialogOpen}>\n                  <DialogTrigger asChild>\n                    <Button size=\"sm\" data-testid=\"button-create-zone\">\n                      <Plus className=\"w-4 h-4 mr-2\" />\n                      Nova Zona\n                    </Button>\n                  </DialogTrigger>\n                  <DialogContent className=\"max-h-[90vh] overflow-y-auto\">\n                    <DialogHeader>\n                      <DialogTitle>Criar Nova Zona</DialogTitle>\n                    </DialogHeader>\n                    <div className=\"space-y-4\">\n                      <div>\n                        <label className=\"block text-sm font-medium text-foreground mb-2\">\n                          Nome da Zona *\n                        </label>\n                        <Input\n                          placeholder=\"Ex: Banheiro Administrativo\"\n                          value={zoneName}\n                          onChange={(e) => setZoneName(e.target.value)}\n                          data-testid=\"input-zone-name\"\n                        />\n                      </div>\n                      <div>\n                        <label className=\"block text-sm font-medium text-foreground mb-2\">\n                          Categoria\n                        </label>\n                        <select \n                          className=\"w-full p-2 border border-input rounded-md bg-background text-foreground\"\n                          value={zoneCategory}\n                          onChange={(e) => setZoneCategory(e.target.value)}\n                          data-testid=\"select-zone-category\"\n                        >\n                          <option value=\"\">Selecione uma categoria</option>\n                          <option value=\"banheiro\">Banheiro</option>\n                          <option value=\"escritorio\">Escritório</option>\n                          <option value=\"producao\">Produção</option>\n                          <option value=\"externo\">Externo</option>\n                          <option value=\"jardim\">Jardim</option>\n                        </select>\n                      </div>\n                      <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                        <div>\n                          <label className=\"block text-sm font-medium text-foreground mb-2\">\n                            Área (m²)\n                          </label>\n                          <Input\n                            type=\"number\"\n                            placeholder=\"0.00\"\n                            value={zoneAreaM2}\n                            onChange={(e) => setZoneAreaM2(e.target.value)}\n                            data-testid=\"input-zone-area\"\n                          />\n                        </div>\n                        <div>\n                          <label className=\"block text-sm font-medium text-foreground mb-2\">\n                            Capacidade\n                          </label>\n                          <Input\n                            type=\"number\"\n                            placeholder=\"0\"\n                            value={zoneCapacity}\n                            onChange={(e) => setZoneCapacity(e.target.value)}\n                            data-testid=\"input-zone-capacity\"\n                          />\n                        </div>\n                      </div>\n                      <div>\n                        <label className=\"block text-sm font-medium text-foreground mb-2\">\n                          Descrição\n                        </label>\n                        <Textarea\n                          placeholder=\"Descrição opcional do local\"\n                          value={zoneDescription}\n                          onChange={(e) => setZoneDescription(e.target.value)}\n                          data-testid=\"textarea-zone-description\"\n                        />\n                      </div>\n                      <div className=\"flex justify-end space-x-2\">\n                        <Button \n                          variant=\"outline\" \n                          onClick={() => setIsCreateZoneDialogOpen(false)}\n                          data-testid=\"button-cancel-zone\"\n                        >\n                          Cancelar\n                        </Button>\n                        <Button \n                          onClick={handleCreateZone}\n                          disabled={createZoneMutation.isPending}\n                          data-testid=\"button-save-zone\"\n                        >\n                          {createZoneMutation.isPending ? \"Criando...\" : \"Criar Zona\"}\n                        </Button>\n                      </div>\n                    </div>\n                  </DialogContent>\n                </Dialog>\n              </div>\n            </CardHeader>\n            <CardContent>\n              {!zones || (zones as any[]).length === 0 ? (\n                <div className=\"text-center py-8\">\n                  <MapPin className=\"w-12 h-12 text-muted-foreground mx-auto mb-4\" />\n                  <p className=\"text-muted-foreground\">Nenhuma zona cadastrada neste local</p>\n                  <p className=\"text-sm text-muted-foreground mt-2\">\n                    Crie a primeira zona para este local\n                  </p>\n                  <Button \n                    className=\"mt-4\"\n                    onClick={() => setIsCreateZoneDialogOpen(true)}\n                    data-testid=\"button-create-first-zone\"\n                  >\n                    <Plus className=\"w-4 h-4 mr-2\" />\n                    Criar Primeiro Local\n                  </Button>\n                </div>\n              ) : (\n                <Table>\n                  <TableHeader>\n                    <TableRow>\n                      <TableHead>Nome</TableHead>\n                      <TableHead>Categoria</TableHead>\n                      <TableHead>Área (m²)</TableHead>\n                      <TableHead>Capacidade</TableHead>\n                      <TableHead>Status</TableHead>\n                      <TableHead>Ações</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {(zones as any[])?.map((zone: any) => (\n                      <TableRow key={zone.id}>\n                        <TableCell className=\"font-medium\">{zone.name}</TableCell>\n                        <TableCell>{getCategoryBadge(zone.category)}</TableCell>\n                        <TableCell>{zone.areaM2 ? `${zone.areaM2} m²` : \"N/A\"}</TableCell>\n                        <TableCell>{zone.capacity || \"N/A\"}</TableCell>\n                        <TableCell>\n                          {zone.isActive ? (\n                            <Badge className=\"bg-chart-2/10 text-chart-2\">Ativo</Badge>\n                          ) : (\n                            <Badge variant=\"outline\">Inativo</Badge>\n                          )}\n                        </TableCell>\n                        <TableCell>\n                          <div className=\"flex items-center space-x-2\">\n                            <Button \n                              variant=\"ghost\" \n                              size=\"sm\"\n                              onClick={() => handleEditZone(zone)}\n                              data-testid={`button-edit-zone-${zone.id}`}\n                            >\n                              <Edit className=\"w-4 h-4\" />\n                            </Button>\n                            <Button \n                              variant=\"ghost\" \n                              size=\"sm\"\n                              onClick={() => {\n                                if (confirm(`Deseja realmente excluir a zona \"${zone.name}\"?`)) {\n                                  deleteZoneMutation.mutate(zone.id);\n                                }\n                              }}\n                              data-testid={`button-delete-zone-${zone.id}`}\n                            >\n                              <Trash2 className=\"w-4 h-4 text-destructive\" />\n                            </Button>\n                          </div>\n                        </TableCell>\n                      </TableRow>\n                    ))}\n                  </TableBody>\n                </Table>\n              )}\n            </CardContent>\n          </Card>\n        )}\n\n\n        {/* Edit Site Modal */}\n        <Dialog open={isEditSiteDialogOpen} onOpenChange={setIsEditSiteDialogOpen}>\n          <DialogContent className=\"max-h-[90vh] overflow-y-auto\">\n            <DialogHeader>\n              <DialogTitle>Editar Local - {editingSite?.name}</DialogTitle>\n            </DialogHeader>\n            <div className=\"space-y-4\">\n              <div>\n                <label className=\"block text-sm font-medium text-foreground mb-2\">\n                  Nome do Local *\n                </label>\n                <Input\n                  placeholder=\"Ex: Fábrica Principal\"\n                  value={editSiteName}\n                  onChange={(e) => setEditSiteName(e.target.value)}\n                  data-testid=\"input-edit-site-name\"\n                />\n              </div>\n              <div>\n                <label className=\"block text-sm font-medium text-foreground mb-2\">\n                  Endereço\n                </label>\n                <Input\n                  placeholder=\"Ex: Av. Industrial, 500\"\n                  value={editSiteAddress}\n                  onChange={(e) => setEditSiteAddress(e.target.value)}\n                  data-testid=\"input-edit-site-address\"\n                />\n              </div>\n              <div>\n                <label className=\"block text-sm font-medium text-foreground mb-2\">\n                  Descrição\n                </label>\n                <Textarea\n                  placeholder=\"Descrição opcional do local\"\n                  value={editSiteDescription}\n                  onChange={(e) => setEditSiteDescription(e.target.value)}\n                  data-testid=\"textarea-edit-site-description\"\n                />\n              </div>\n              <div className=\"flex justify-end space-x-2\">\n                <Button \n                  variant=\"outline\" \n                  onClick={() => setIsEditSiteDialogOpen(false)}\n                  data-testid=\"button-cancel-edit-site\"\n                >\n                  Cancelar\n                </Button>\n                <Button \n                  onClick={handleUpdateSite}\n                  disabled={updateSiteMutation.isPending}\n                  data-testid=\"button-save-edit-site\"\n                >\n                  {updateSiteMutation.isPending ? \"Salvando...\" : \"Salvar Local\"}\n                </Button>\n              </div>\n            </div>\n          </DialogContent>\n        </Dialog>\n\n        {/* Edit Zone Modal */}\n        <Dialog open={isEditZoneDialogOpen} onOpenChange={setIsEditZoneDialogOpen}>\n          <DialogContent className=\"max-h-[90vh] overflow-y-auto\">\n            <DialogHeader>\n              <DialogTitle>Editar Zona - {editingZone?.name}</DialogTitle>\n            </DialogHeader>\n            <div className=\"space-y-4\">\n              <div>\n                <label className=\"block text-sm font-medium text-foreground mb-2\">\n                  Nome da Zona *\n                </label>\n                <Input\n                  placeholder=\"Ex: Banheiro 1\"\n                  value={editZoneName}\n                  onChange={(e) => setEditZoneName(e.target.value)}\n                  data-testid=\"input-edit-zone-name\"\n                />\n              </div>\n              <div>\n                <label className=\"block text-sm font-medium text-foreground mb-2\">\n                  Categoria\n                </label>\n                <Select value={editZoneCategory} onValueChange={setEditZoneCategory}>\n                  <SelectTrigger data-testid=\"select-edit-zone-category\">\n                    <SelectValue placeholder=\"Selecione a categoria\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"banheiro\">🚻 Banheiro</SelectItem>\n                    <SelectItem value=\"escritorio\">🏢 Escritório</SelectItem>\n                    <SelectItem value=\"producao\">🏭 Produção</SelectItem>\n                    <SelectItem value=\"externo\">🌿 Externo</SelectItem>\n                    <SelectItem value=\"jardim\">🌱 Jardim</SelectItem>\n                    <SelectItem value=\"outro\">📦 Outro</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <label className=\"block text-sm font-medium text-foreground mb-2\">\n                    Área (m²)\n                  </label>\n                  <Input\n                    type=\"number\"\n                    step=\"0.01\"\n                    placeholder=\"0.00\"\n                    value={editZoneAreaM2}\n                    onChange={(e) => setEditZoneAreaM2(e.target.value)}\n                    data-testid=\"input-edit-zone-area\"\n                  />\n                </div>\n                <div>\n                  <label className=\"block text-sm font-medium text-foreground mb-2\">\n                    Capacidade\n                  </label>\n                  <Input\n                    type=\"number\"\n                    placeholder=\"0\"\n                    value={editZoneCapacity}\n                    onChange={(e) => setEditZoneCapacity(e.target.value)}\n                    data-testid=\"input-edit-zone-capacity\"\n                  />\n                </div>\n              </div>\n              <div>\n                <label className=\"block text-sm font-medium text-foreground mb-2\">\n                  Descrição\n                </label>\n                <Textarea\n                  placeholder=\"Descrição opcional do local\"\n                  value={editZoneDescription}\n                  onChange={(e) => setEditZoneDescription(e.target.value)}\n                  data-testid=\"textarea-edit-zone-description\"\n                />\n              </div>\n              <div className=\"flex justify-end space-x-2\">\n                <Button \n                  variant=\"outline\" \n                  onClick={() => setIsEditZoneDialogOpen(false)}\n                  data-testid=\"button-cancel-edit-zone\"\n                >\n                  Cancelar\n                </Button>\n                <Button \n                  onClick={handleUpdateZone}\n                  disabled={updateZoneMutation.isPending}\n                  data-testid=\"button-save-edit-zone\"\n                >\n                  {updateZoneMutation.isPending ? \"Salvando...\" : \"Salvar Zona\"}\n                </Button>\n              </div>\n            </div>\n          </DialogContent>\n        </Dialog>\n      </div>\n    </div>\n  );\n}\n","size_bytes":34923},"client/src/components/ui/dialog.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Dialog = DialogPrimitive.Root\n\nconst DialogTrigger = DialogPrimitive.Trigger\n\nconst DialogPortal = DialogPrimitive.Portal\n\nconst DialogClose = DialogPrimitive.Close\n\nconst DialogOverlay = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Overlay\n    ref={ref}\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogOverlay.displayName = DialogPrimitive.Overlay.displayName\n\nconst DialogContent = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DialogPortal>\n    <DialogOverlay />\n    <DialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <DialogPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </DialogPrimitive.Close>\n    </DialogPrimitive.Content>\n  </DialogPortal>\n))\nDialogContent.displayName = DialogPrimitive.Content.displayName\n\nconst DialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-1.5 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogHeader.displayName = \"DialogHeader\"\n\nconst DialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogFooter.displayName = \"DialogFooter\"\n\nconst DialogTitle = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogTitle.displayName = DialogPrimitive.Title.displayName\n\nconst DialogDescription = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDialogDescription.displayName = DialogPrimitive.Description.displayName\n\nexport {\n  Dialog,\n  DialogPortal,\n  DialogOverlay,\n  DialogClose,\n  DialogTrigger,\n  DialogContent,\n  DialogHeader,\n  DialogFooter,\n  DialogTitle,\n  DialogDescription,\n}\n","size_bytes":3848},"client/src/components/ui/radio-group.tsx":{"content":"import * as React from \"react\"\nimport * as RadioGroupPrimitive from \"@radix-ui/react-radio-group\"\nimport { Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst RadioGroup = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Root\n      className={cn(\"grid gap-2\", className)}\n      {...props}\n      ref={ref}\n    />\n  )\n})\nRadioGroup.displayName = RadioGroupPrimitive.Root.displayName\n\nconst RadioGroupItem = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        \"aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    >\n      <RadioGroupPrimitive.Indicator className=\"flex items-center justify-center\">\n        <Circle className=\"h-2.5 w-2.5 fill-current text-current\" />\n      </RadioGroupPrimitive.Indicator>\n    </RadioGroupPrimitive.Item>\n  )\n})\nRadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName\n\nexport { RadioGroup, RadioGroupItem }\n","size_bytes":1467},"client/src/pages/mobile-work-order-execute.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useRoute, useLocation } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from \"@/components/ui/dialog\";\nimport { Label } from \"@/components/ui/label\";\nimport { ArrowLeft, CheckCircle, MapPin, Building2, AlertCircle, Camera, X, PauseCircle } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\n\nexport default function MobileWorkOrderExecute() {\n  const [, params] = useRoute(\"/mobile/work-order/:id\");\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  \n  const [workOrder, setWorkOrder] = useState<any>(null);\n  const [checklist, setChecklist] = useState<any>(null);\n  const [answers, setAnswers] = useState<Record<string, any>>({});\n  const [isLoading, setIsLoading] = useState(true);\n  const [isSubmitting, setIsSubmitting] = useState(false);\n  const [isPauseModalOpen, setIsPauseModalOpen] = useState(false);\n  const [pauseReason, setPauseReason] = useState(\"\");\n  const [pausePhoto, setPausePhoto] = useState<any>(null);\n  const [isPausing, setIsPausing] = useState(false);\n  const [currentUser, setCurrentUser] = useState<any>(null);\n\n  useEffect(() => {\n    // Carregar usuário do localStorage\n    const authStr = localStorage.getItem('opus_clean_auth');\n    if (authStr) {\n      const authData = JSON.parse(authStr);\n      setCurrentUser(authData.user);\n    }\n    \n    if (params?.id) {\n      loadWorkOrder(params.id);\n    }\n  }, [params?.id]);\n\n  const loadWorkOrder = async (id: string) => {\n    setIsLoading(true);\n    try {\n      // Buscar work order\n      console.log('[MOBILE] Loading work order:', id);\n      const woResponse = await fetch(`/api/work-orders/${id}`);\n      console.log('[MOBILE] Work order response status:', woResponse.status);\n      if (!woResponse.ok) throw new Error('Work order não encontrada');\n      const woData = await woResponse.json();\n      console.log('[MOBILE] Work order data COMPLETA:', JSON.stringify(woData, null, 2));\n      console.log('[MOBILE] workOrder.number:', woData.number);\n      console.log('[MOBILE] workOrder.site:', woData.site);\n      console.log('[MOBILE] workOrder.zone:', woData.zone);\n      \n      // Se a OS está aberta ou pausada, iniciar execução\n      if (woData.status === 'aberta' || woData.status === 'pausada') {\n        try {\n          const authStr = localStorage.getItem('opus_clean_auth');\n          if (authStr) {\n            const authData = JSON.parse(authStr);\n            const user = authData.user;\n            \n            if (user?.id) {\n              // Mudar status para em_execucao e registrar início\n              const updateResponse = await fetch(`/api/work-orders/${id}`, {\n                method: 'PATCH',\n                headers: { 'Content-Type': 'application/json' },\n                body: JSON.stringify({\n                  assignedUserId: user.id,\n                  status: 'em_execucao',\n                  startedAt: woData.status === 'aberta' ? new Date().toISOString() : woData.startedAt,\n                }),\n              });\n              \n              if (updateResponse.ok) {\n                const updatedWo = await updateResponse.json();\n                woData.assignedUserId = updatedWo.assignedUserId;\n                woData.status = updatedWo.status;\n                woData.startedAt = updatedWo.startedAt;\n                \n                // Buscar comentários anteriores para determinar se é \"iniciou\" ou \"retomou\"\n                let actionText = 'iniciou'; // Padrão: primeira vez\n                try {\n                  const commentsResponse = await fetch(`/api/work-orders/${id}/comments`);\n                  if (commentsResponse.ok) {\n                    const existingComments = await commentsResponse.json();\n                    // Verificar se já existe comentário de início/retomada anterior\n                    const hasStartedBefore = existingComments.some((c: any) => \n                      c.comment.includes('iniciou a execução') || \n                      c.comment.includes('retomou a execução')\n                    );\n                    // Se já foi iniciada antes, usar \"retomou\"\n                    if (hasStartedBefore) {\n                      actionText = 'retomou';\n                    }\n                  }\n                } catch (err) {\n                  console.error('Erro ao verificar histórico:', err);\n                }\n                \n                // Criar comentário de início/retomada\n                await fetch(`/api/work-orders/${id}/comments`, {\n                  method: 'POST',\n                  headers: { 'Content-Type': 'application/json' },\n                  body: JSON.stringify({\n                    userId: user.id,\n                    comment: `⏯️ ${user.name} ${actionText} a execução da OS`,\n                  }),\n                });\n              }\n            }\n          }\n        } catch (assignError) {\n          console.error('Erro ao iniciar OS:', assignError);\n        }\n      }\n      \n      setWorkOrder(woData);\n\n      // Buscar checklist - rota diferente para Clean vs Maintenance\n      let checklistData = null;\n      \n      if (woData.module === 'maintenance' && woData.maintenanceChecklistTemplateId) {\n        // Para manutenção: buscar do maintenance_checklist_templates\n        const checklistResponse = await fetch(`/api/maintenance-checklist-templates/${woData.maintenanceChecklistTemplateId}`);\n        if (checklistResponse.ok) {\n          checklistData = await checklistResponse.json();\n        }\n      } else if (woData.module === 'clean' && woData.serviceId) {\n        // Para clean: buscar do service_types\n        const checklistResponse = await fetch(`/api/services/${woData.serviceId}/checklist`);\n        if (checklistResponse.ok) {\n          checklistData = await checklistResponse.json();\n        }\n      }\n      \n      if (checklistData) {\n        setChecklist(checklistData);\n        \n        // Inicializar respostas\n        const initialAnswers: Record<string, any> = {};\n        if (checklistData?.items) {\n          checklistData.items.forEach((item: any) => {\n            if (item.type === 'boolean') {\n              initialAnswers[item.id] = undefined;\n            } else if (item.type === 'photo') {\n              initialAnswers[item.id] = [];\n            } else if (item.type === 'checkbox') {\n              initialAnswers[item.id] = [];\n            } else {\n              initialAnswers[item.id] = '';\n            }\n          });\n        }\n        setAnswers(initialAnswers);\n      }\n    } catch (error) {\n      console.error('Erro ao carregar work order:', error);\n      toast({\n        title: \"Erro\",\n        description: \"Não foi possível carregar a ordem de serviço.\",\n        variant: \"destructive\",\n      });\n      setLocation('/mobile');\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const handlePhotoUpload = (itemId: string, files: FileList | null) => {\n    if (!files || files.length === 0) return;\n    \n    const currentPhotos = answers[itemId] || [];\n    const newPhotos = Array.from(files).map(file => ({\n      file,\n      preview: URL.createObjectURL(file),\n      name: file.name\n    }));\n    \n    setAnswers(prev => ({\n      ...prev,\n      [itemId]: [...currentPhotos, ...newPhotos]\n    }));\n  };\n\n  const removePhoto = (itemId: string, index: number) => {\n    const currentPhotos = answers[itemId] || [];\n    const updatedPhotos = currentPhotos.filter((_: any, i: number) => i !== index);\n    \n    // Liberar URL do preview\n    if (currentPhotos[index]?.preview) {\n      URL.revokeObjectURL(currentPhotos[index].preview);\n    }\n    \n    setAnswers(prev => ({\n      ...prev,\n      [itemId]: updatedPhotos\n    }));\n  };\n\n  const validateChecklist = () => {\n    if (!checklist?.items) return true;\n    \n    for (const item of checklist.items) {\n      if (item.required) {\n        const answer = answers[item.id];\n        \n        if (item.type === 'boolean' && answer === undefined) {\n          return false;\n        }\n        if (item.type === 'text' && (!answer || answer.trim() === '')) {\n          return false;\n        }\n        if (item.type === 'photo') {\n          const photos = answer || [];\n          const minCount = item.validation?.photoMinCount || 0;\n          if (photos.length < minCount) {\n            return false;\n          }\n        }\n        if (item.type === 'checkbox') {\n          const selected = answer || [];\n          const minChecked = item.validation?.minChecked || 0;\n          if (selected.length < minChecked) {\n            return false;\n          }\n        }\n      }\n      \n      // Validar limites mesmo se não for required\n      if (item.type === 'checkbox' && answers[item.id]) {\n        const selected = answers[item.id] || [];\n        const minChecked = item.validation?.minChecked || 0;\n        const maxChecked = item.validation?.maxChecked;\n        \n        if (selected.length < minChecked || (maxChecked && selected.length > maxChecked)) {\n          return false;\n        }\n      }\n    }\n    return true;\n  };\n\n  const convertPhotosToBase64 = async (photos: any[]): Promise<string[]> => {\n    const promises = photos.map((photo) => {\n      return new Promise<string>((resolve, reject) => {\n        const reader = new FileReader();\n        reader.onloadend = () => resolve(reader.result as string);\n        reader.onerror = reject;\n        reader.readAsDataURL(photo.file);\n      });\n    });\n    return Promise.all(promises);\n  };\n\n  const handlePausePhotoUpload = (files: FileList | null) => {\n    if (!files || files.length === 0) return;\n    \n    const file = files[0];\n    setPausePhoto({\n      file,\n      preview: URL.createObjectURL(file),\n      name: file.name\n    });\n  };\n\n  const handlePause = async () => {\n    if (!pauseReason.trim()) {\n      toast({\n        title: \"Motivo obrigatório\",\n        description: \"Por favor, informe o motivo da pausa.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setIsPausing(true);\n    try {\n      // Converter foto para base64 se houver\n      let photoBase64 = null;\n      if (pausePhoto) {\n        photoBase64 = await new Promise<string>((resolve, reject) => {\n          const reader = new FileReader();\n          reader.onloadend = () => resolve(reader.result as string);\n          reader.onerror = reject;\n          reader.readAsDataURL(pausePhoto.file);\n        });\n      }\n\n      // Atualizar status da OS para pausada\n      const response = await fetch(`/api/work-orders/${workOrder.id}`, {\n        method: 'PATCH',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          status: 'pausada',\n        }),\n      });\n\n      if (!response.ok) {\n        throw new Error('Erro ao pausar ordem de serviço');\n      }\n\n      // Criar comentário com motivo e foto\n      await fetch(`/api/work-orders/${workOrder.id}/comments`, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          userId: currentUser?.id,\n          comment: `⏸️ ${currentUser?.name || 'Operador'} pausou a OS\\n\\n📝 Motivo: ${pauseReason}`,\n          attachments: photoBase64 ? [photoBase64] : null,\n        }),\n      });\n\n      toast({\n        title: \"✅ OS Pausada\",\n        description: \"A ordem de serviço foi pausada com sucesso.\",\n      });\n\n      // Voltar para o scanner\n      setTimeout(() => {\n        setLocation('/mobile/qr-scanner');\n      }, 1500);\n    } catch (error) {\n      console.error('Erro ao pausar OS:', error);\n      toast({\n        title: \"Erro\",\n        description: \"Não foi possível pausar a ordem de serviço.\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsPausing(false);\n      setIsPauseModalOpen(false);\n      setPauseReason(\"\");\n      setPausePhoto(null);\n    }\n  };\n\n  const handleFinish = async () => {\n    if (!validateChecklist()) {\n      toast({\n        title: \"Checklist incompleto\",\n        description: \"Preencha todos os itens obrigatórios antes de finalizar.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setIsSubmitting(true);\n    try {\n      // Converter fotos para base64 para salvar\n      const checklistAnswers: Record<string, any> = {};\n      \n      if (checklist?.items) {\n        for (const item of checklist.items) {\n          if (item.type === 'photo' && answers[item.id]?.length > 0) {\n            // Converter fotos para base64\n            const base64Photos = await convertPhotosToBase64(answers[item.id]);\n            checklistAnswers[item.id] = {\n              type: 'photo',\n              photos: base64Photos,\n              count: base64Photos.length\n            };\n          } else {\n            // Outros tipos de resposta\n            checklistAnswers[item.id] = answers[item.id];\n          }\n        }\n      }\n\n      // Atualizar work order para concluída\n      console.log('[FINISH] Enviando PATCH para finalizar OS:', workOrder.id);\n      console.log('[FINISH] Dados do checklist:', checklistAnswers);\n      \n      const response = await fetch(`/api/work-orders/${workOrder.id}`, {\n        method: 'PATCH',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          status: 'concluida',\n          completedAt: new Date().toISOString(),\n          checklistData: checklist ? checklistAnswers : null,\n        }),\n      });\n\n      console.log('[FINISH] Response status:', response.status);\n      \n      if (!response.ok) {\n        const errorText = await response.text();\n        console.error('[FINISH] Erro na resposta:', errorText);\n        throw new Error(`Erro ao finalizar: ${response.status} - ${errorText}`);\n      }\n\n      // Criar comentário automático com resumo da finalização e fotos\n      try {\n        // Coletar todas as fotos do checklist\n        const allPhotos: string[] = [];\n        let checklistSummary = '✅ OS Finalizada!\\n\\n📋 Checklist:\\n';\n        \n        if (checklist?.items) {\n          for (const item of checklist.items) {\n            if (item.type === 'photo' && checklistAnswers[item.id]?.photos) {\n              allPhotos.push(...checklistAnswers[item.id].photos);\n              checklistSummary += `• ${item.label}: ${checklistAnswers[item.id].count} foto(s) anexada(s)\\n`;\n            } else if (item.type === 'checkbox') {\n              const selectedOptions = checklistAnswers[item.id] || [];\n              if (selectedOptions.length > 0) {\n                checklistSummary += `✓ ${item.label}: ${selectedOptions.join(', ')}\\n`;\n              } else {\n                checklistSummary += `○ ${item.label}: Nenhuma opção selecionada\\n`;\n              }\n            } else if (item.type === 'boolean') {\n              const answer = checklistAnswers[item.id];\n              const symbol = answer === true ? '✓' : answer === false ? '✗' : '○';\n              const text = answer === true ? 'SIM' : answer === false ? 'NÃO' : 'Não respondido';\n              checklistSummary += `${symbol} ${item.label}: ${text}\\n`;\n            } else if (item.type === 'text' && checklistAnswers[item.id]) {\n              checklistSummary += `• ${item.label}: ${checklistAnswers[item.id]}\\n`;\n            }\n          }\n        }\n\n        // Criar comentário com o resumo e fotos\n        await fetch(`/api/work-orders/${workOrder.id}/comments`, {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({\n            userId: currentUser?.id,\n            comment: checklistSummary,\n            attachments: allPhotos,\n          }),\n        });\n      } catch (commentError) {\n        console.error('Erro ao criar comentário de finalização:', commentError);\n        // Não bloquear a finalização se comentário falhar\n      }\n\n      toast({\n        title: \"✅ OS Finalizada!\",\n        description: `OS #${workOrder.number} foi concluída com sucesso. Fotos e dados salvos.`,\n      });\n\n      // Voltar para a página inicial do colaborador\n      setTimeout(() => {\n        setLocation('/mobile');\n      }, 1500);\n    } catch (error) {\n      console.error('Erro ao finalizar work order:', error);\n      console.error('Tipo do erro:', typeof error);\n      console.error('Erro stringified:', JSON.stringify(error));\n      console.error('Erro message:', error instanceof Error ? error.message : 'Sem mensagem');\n      console.error('Erro stack:', error instanceof Error ? error.stack : 'Sem stack');\n      \n      toast({\n        title: \"Erro\",\n        description: error instanceof Error ? error.message : \"Não foi possível finalizar a ordem de serviço.\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsSubmitting(false);\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 flex items-center justify-center\">\n        <div className=\"text-center\">\n          <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4\"></div>\n          <p className=\"text-slate-600\">Carregando ordem de serviço...</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (!workOrder) {\n    return (\n      <div className=\"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4\">\n        <Card className=\"max-w-md mx-auto mt-8\">\n          <CardContent className=\"p-6 text-center\">\n            <AlertCircle className=\"w-16 h-16 text-red-500 mx-auto mb-4\" />\n            <h3 className=\"text-lg font-semibold mb-2\">Ordem não encontrada</h3>\n            <Button onClick={() => setLocation('/mobile')} className=\"mt-4\">\n              Voltar\n            </Button>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100\">\n      {/* Header */}\n      <div className=\"bg-white shadow-sm sticky top-0 z-10\">\n        <div className=\"max-w-4xl mx-auto px-4 py-4\">\n          <div className=\"flex items-center justify-between\">\n            <Button \n              variant=\"ghost\" \n              onClick={() => setLocation('/mobile/qr-scanner')}\n              className=\"p-2\"\n              data-testid=\"button-back\"\n            >\n              <ArrowLeft className=\"w-6 h-6\" />\n            </Button>\n            <div className=\"flex-1 text-center\">\n              <h1 className=\"text-xl font-bold text-slate-900\">Executar OS</h1>\n              <p className=\"text-sm text-slate-600\">OS #{workOrder.number}</p>\n            </div>\n            <div className=\"w-10\"></div>\n          </div>\n        </div>\n      </div>\n\n      {/* Content */}\n      <div className=\"max-w-4xl mx-auto p-4 space-y-4\">\n        {/* Informações da OS */}\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"text-lg\">Detalhes da Ordem</CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-3\">\n            <div>\n              <p className=\"text-sm text-slate-600 mb-1\">Título</p>\n              <p className=\"font-semibold text-slate-900\">{workOrder.title}</p>\n            </div>\n            \n            {workOrder.description && (\n              <div>\n                <p className=\"text-sm text-slate-600 mb-1\">Descrição</p>\n                <p className=\"text-slate-700\">{workOrder.description}</p>\n              </div>\n            )}\n\n            <div className=\"flex flex-wrap gap-2\">\n              {workOrder.site?.name && (\n                <Badge variant=\"outline\" className=\"flex items-center gap-1\">\n                  <Building2 className=\"w-3 h-3\" />\n                  {workOrder.site.name}\n                </Badge>\n              )}\n              {workOrder.zone?.name && (\n                <Badge variant=\"outline\" className=\"flex items-center gap-1\">\n                  <MapPin className=\"w-3 h-3\" />\n                  {workOrder.zone.name}\n                </Badge>\n              )}\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Checklist */}\n        {checklist && checklist.items && checklist.items.length > 0 ? (\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-lg flex items-center gap-2\">\n                <CheckCircle className=\"w-5 h-5 text-blue-600\" />\n                Checklist de Execução\n              </CardTitle>\n              <p className=\"text-sm text-slate-600 mt-1\">\n                {checklist.description || 'Preencha todos os itens obrigatórios'}\n              </p>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              {checklist.items.map((item: any, index: number) => (\n                <div \n                  key={item.id} \n                  className=\"p-4 border rounded-lg bg-slate-50\"\n                  data-testid={`checklist-item-${index}`}\n                >\n                  <div className=\"flex items-start gap-3\">\n                    <div className=\"flex-shrink-0 w-6 h-6 rounded-full bg-blue-600 text-white flex items-center justify-center text-sm font-semibold\">\n                      {index + 1}\n                    </div>\n                    <div className=\"flex-1 space-y-2\">\n                      <div className=\"flex items-start justify-between gap-2\">\n                        <div className=\"flex-1\">\n                          <p className=\"font-medium text-slate-900\">\n                            {item.label}\n                            {item.required && (\n                              <span className=\"text-red-500 ml-1\">*</span>\n                            )}\n                          </p>\n                          {item.description && (\n                            <p className=\"text-sm text-slate-600 mt-1\">{item.description}</p>\n                          )}\n                        </div>\n                      </div>\n\n                      {item.type === 'boolean' ? (\n                        <div className=\"flex gap-3 mt-2\">\n                          <Button\n                            type=\"button\"\n                            variant={answers[item.id] === true ? \"default\" : \"outline\"}\n                            className={`flex-1 ${\n                              answers[item.id] === true \n                                ? 'bg-green-600 hover:bg-green-700' \n                                : 'border-slate-300'\n                            }`}\n                            onClick={() => setAnswers(prev => ({ ...prev, [item.id]: true }))}\n                            data-testid={`button-yes-${item.id}`}\n                          >\n                            SIM\n                          </Button>\n                          <Button\n                            type=\"button\"\n                            variant={answers[item.id] === false ? \"default\" : \"outline\"}\n                            className={`flex-1 ${\n                              answers[item.id] === false \n                                ? 'bg-red-600 hover:bg-red-700' \n                                : 'border-slate-300'\n                            }`}\n                            onClick={() => setAnswers(prev => ({ ...prev, [item.id]: false }))}\n                            data-testid={`button-no-${item.id}`}\n                          >\n                            NÃO\n                          </Button>\n                        </div>\n                      ) : item.type === 'photo' ? (\n                        <div className=\"mt-2 space-y-3\">\n                          {/* Info sobre requisitos */}\n                          <div className=\"text-xs text-slate-600 flex items-center gap-2\">\n                            <Camera className=\"w-4 h-4\" />\n                            <span>\n                              {item.validation?.photoMinCount && item.validation?.photoMaxCount \n                                ? `Envie entre ${item.validation.photoMinCount} e ${item.validation.photoMaxCount} fotos`\n                                : item.validation?.photoMinCount\n                                ? `Envie no mínimo ${item.validation.photoMinCount} foto(s)`\n                                : item.validation?.photoMaxCount\n                                ? `Envie no máximo ${item.validation.photoMaxCount} foto(s)`\n                                : 'Envie suas fotos'\n                              }\n                            </span>\n                          </div>\n\n                          {/* Preview das fotos */}\n                          {answers[item.id] && answers[item.id].length > 0 && (\n                            <div className=\"grid grid-cols-3 gap-2\">\n                              {answers[item.id].map((photo: any, photoIndex: number) => (\n                                <div key={photoIndex} className=\"relative aspect-square\">\n                                  <img \n                                    src={photo.preview} \n                                    alt={`Foto ${photoIndex + 1}`}\n                                    className=\"w-full h-full object-cover rounded-lg border-2 border-slate-200\"\n                                  />\n                                  <Button\n                                    type=\"button\"\n                                    variant=\"destructive\"\n                                    size=\"icon\"\n                                    className=\"absolute -top-2 -right-2 h-6 w-6 rounded-full\"\n                                    onClick={() => removePhoto(item.id, photoIndex)}\n                                  >\n                                    <X className=\"w-3 h-3\" />\n                                  </Button>\n                                </div>\n                              ))}\n                            </div>\n                          )}\n\n                          {/* Botão de upload */}\n                          {(!item.validation?.photoMaxCount || \n                            (answers[item.id]?.length || 0) < item.validation.photoMaxCount) && (\n                            <label className=\"block\">\n                              <input\n                                type=\"file\"\n                                accept=\"image/*\"\n                                multiple\n                                capture=\"environment\"\n                                className=\"hidden\"\n                                onChange={(e) => handlePhotoUpload(item.id, e.target.files)}\n                                data-testid={`photo-input-${item.id}`}\n                              />\n                              <div className=\"flex items-center justify-center gap-2 p-4 border-2 border-dashed border-blue-300 rounded-lg bg-blue-50 hover:bg-blue-100 cursor-pointer transition-colors\">\n                                <Camera className=\"w-5 h-5 text-blue-600\" />\n                                <span className=\"text-sm font-medium text-blue-600\">\n                                  {answers[item.id]?.length > 0 ? 'Adicionar mais fotos' : 'Tirar/Selecionar fotos'}\n                                </span>\n                              </div>\n                            </label>\n                          )}\n\n                          {/* Contador */}\n                          <p className=\"text-xs text-center text-slate-500\">\n                            {answers[item.id]?.length || 0} foto(s) adicionada(s)\n                          </p>\n                        </div>\n                      ) : item.type === 'checkbox' ? (\n                        <div className=\"mt-2 space-y-2\">\n                          {item.options && item.options.length > 0 ? (\n                            item.options.map((option: string, optIdx: number) => (\n                              <div key={optIdx} className=\"flex items-center gap-3 p-3 border rounded-lg bg-white hover:bg-slate-50 transition-colors\">\n                                <Checkbox\n                                  id={`${item.id}-${optIdx}`}\n                                  checked={(answers[item.id] || []).includes(option)}\n                                  onCheckedChange={(checked) => {\n                                    setAnswers(prev => {\n                                      const current = prev[item.id] || [];\n                                      if (checked) {\n                                        // Verificar maxChecked se configurado\n                                        if (item.validation?.maxChecked && current.length >= item.validation.maxChecked) {\n                                          return prev;\n                                        }\n                                        return { ...prev, [item.id]: [...current, option] };\n                                      } else {\n                                        return { ...prev, [item.id]: current.filter((o: string) => o !== option) };\n                                      }\n                                    });\n                                  }}\n                                  data-testid={`checkbox-${item.id}-${optIdx}`}\n                                />\n                                <Label \n                                  htmlFor={`${item.id}-${optIdx}`}\n                                  className=\"flex-1 cursor-pointer text-sm\"\n                                >\n                                  {option}\n                                </Label>\n                              </div>\n                            ))\n                          ) : (\n                            <p className=\"text-sm text-slate-500 italic\">Nenhuma opção configurada</p>\n                          )}\n                          \n                          {/* Info de validação */}\n                          {(item.validation?.minChecked || item.validation?.maxChecked) && (\n                            <p className=\"text-xs text-slate-600 mt-2\">\n                              {item.validation?.minChecked && item.validation?.maxChecked\n                                ? `Selecione entre ${item.validation.minChecked} e ${item.validation.maxChecked} opções`\n                                : item.validation?.minChecked\n                                ? `Selecione no mínimo ${item.validation.minChecked} opção(ões)`\n                                : `Selecione no máximo ${item.validation.maxChecked} opção(ões)`\n                              }\n                            </p>\n                          )}\n                          \n                          {/* Contador de selecionados */}\n                          <p className=\"text-xs text-center text-slate-500 mt-1\">\n                            {(answers[item.id] || []).length} opção(ões) selecionada(s)\n                          </p>\n                        </div>\n                      ) : (\n                        <Textarea\n                          placeholder=\"Digite sua resposta...\"\n                          value={answers[item.id] || ''}\n                          onChange={(e) => \n                            setAnswers(prev => ({ ...prev, [item.id]: e.target.value }))\n                          }\n                          className=\"mt-2\"\n                          rows={3}\n                          data-testid={`textarea-${item.id}`}\n                        />\n                      )}\n                    </div>\n                  </div>\n                </div>\n              ))}\n            </CardContent>\n          </Card>\n        ) : (\n          <Card>\n            <CardContent className=\"p-6 text-center text-slate-600\">\n              <CheckCircle className=\"w-12 h-12 text-slate-400 mx-auto mb-2\" />\n              <p>Esta ordem não possui checklist</p>\n            </CardContent>\n          </Card>\n        )}\n\n        {/* Botões de Ação */}\n        <Card className=\"sticky bottom-4 shadow-lg\">\n          <CardContent className=\"p-4 space-y-3\">\n            <Button\n              onClick={() => setIsPauseModalOpen(true)}\n              disabled={isSubmitting || isPausing}\n              variant=\"outline\"\n              className=\"w-full border-orange-500 text-orange-600 hover:bg-orange-50 py-6 text-lg font-semibold\"\n              data-testid=\"button-pause-wo\"\n            >\n              <PauseCircle className=\"w-5 h-5 mr-2\" />\n              Pausar Ordem de Serviço\n            </Button>\n            \n            <Button\n              onClick={handleFinish}\n              disabled={isSubmitting || isPausing}\n              className=\"w-full bg-green-600 hover:bg-green-700 text-white py-6 text-lg font-semibold\"\n              data-testid=\"button-finish-wo\"\n            >\n              {isSubmitting ? (\n                <>\n                  <div className=\"animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-2\"></div>\n                  Finalizando...\n                </>\n              ) : (\n                <>\n                  <CheckCircle className=\"w-5 h-5 mr-2\" />\n                  Finalizar Ordem de Serviço\n                </>\n              )}\n            </Button>\n          </CardContent>\n        </Card>\n\n        {/* Modal de Pausa */}\n        <Dialog open={isPauseModalOpen} onOpenChange={setIsPauseModalOpen}>\n          <DialogContent className=\"max-w-md\">\n            <DialogHeader>\n              <DialogTitle className=\"flex items-center gap-2\">\n                <PauseCircle className=\"w-5 h-5 text-orange-600\" />\n                Pausar Ordem de Serviço\n              </DialogTitle>\n              <DialogDescription>\n                Informe o motivo da pausa. Você ou outro operador poderá retomar depois.\n              </DialogDescription>\n            </DialogHeader>\n            \n            <div className=\"space-y-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"pause-reason\">Motivo da Pausa *</Label>\n                <Textarea\n                  id=\"pause-reason\"\n                  placeholder=\"Ex: Falta de material, equipamento quebrado, intervalo...\"\n                  value={pauseReason}\n                  onChange={(e) => setPauseReason(e.target.value)}\n                  rows={4}\n                  data-testid=\"textarea-pause-reason\"\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"pause-photo\">Foto (opcional)</Label>\n                {pausePhoto ? (\n                  <div className=\"relative\">\n                    <img \n                      src={pausePhoto.preview} \n                      alt=\"Foto da pausa\"\n                      className=\"w-full h-48 object-cover rounded-lg border\"\n                    />\n                    <Button\n                      type=\"button\"\n                      variant=\"destructive\"\n                      size=\"icon\"\n                      className=\"absolute top-2 right-2\"\n                      onClick={() => {\n                        URL.revokeObjectURL(pausePhoto.preview);\n                        setPausePhoto(null);\n                      }}\n                    >\n                      <X className=\"w-4 h-4\" />\n                    </Button>\n                  </div>\n                ) : (\n                  <label className=\"block\">\n                    <input\n                      type=\"file\"\n                      accept=\"image/*\"\n                      capture=\"environment\"\n                      className=\"hidden\"\n                      onChange={(e) => handlePausePhotoUpload(e.target.files)}\n                      data-testid=\"input-pause-photo\"\n                    />\n                    <div className=\"flex items-center justify-center gap-2 p-6 border-2 border-dashed border-slate-300 rounded-lg bg-slate-50 hover:bg-slate-100 cursor-pointer\">\n                      <Camera className=\"w-5 h-5 text-slate-600\" />\n                      <span className=\"text-sm text-slate-600\">Tirar/Anexar Foto</span>\n                    </div>\n                  </label>\n                )}\n              </div>\n\n              <div className=\"flex gap-2 pt-2\">\n                <Button\n                  type=\"button\"\n                  variant=\"outline\"\n                  onClick={() => {\n                    setIsPauseModalOpen(false);\n                    setPauseReason(\"\");\n                    if (pausePhoto) {\n                      URL.revokeObjectURL(pausePhoto.preview);\n                      setPausePhoto(null);\n                    }\n                  }}\n                  disabled={isPausing}\n                  className=\"flex-1\"\n                  data-testid=\"button-cancel-pause\"\n                >\n                  Cancelar\n                </Button>\n                <Button\n                  onClick={handlePause}\n                  disabled={isPausing || !pauseReason.trim()}\n                  className=\"flex-1 bg-orange-600 hover:bg-orange-700\"\n                  data-testid=\"button-confirm-pause\"\n                >\n                  {isPausing ? (\n                    <>\n                      <div className=\"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2\"></div>\n                      Pausando...\n                    </>\n                  ) : (\n                    \"Confirmar Pausa\"\n                  )}\n                </Button>\n              </div>\n            </div>\n          </DialogContent>\n        </Dialog>\n      </div>\n    </div>\n  );\n}\n","size_bytes":37375},"client/src/components/ui/sheet.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SheetPrimitive from \"@radix-ui/react-dialog\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Sheet = SheetPrimitive.Root\n\nconst SheetTrigger = SheetPrimitive.Trigger\n\nconst SheetClose = SheetPrimitive.Close\n\nconst SheetPortal = SheetPrimitive.Portal\n\nconst SheetOverlay = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nSheetOverlay.displayName = SheetPrimitive.Overlay.displayName\n\nconst sheetVariants = cva(\n  \"fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500\",\n  {\n    variants: {\n      side: {\n        top: \"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top\",\n        bottom:\n          \"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom\",\n        left: \"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm\",\n        right:\n          \"inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm\",\n      },\n    },\n    defaultVariants: {\n      side: \"right\",\n    },\n  }\n)\n\ninterface SheetContentProps\n  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,\n    VariantProps<typeof sheetVariants> {}\n\nconst SheetContent = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Content>,\n  SheetContentProps\n>(({ side = \"right\", className, children, ...props }, ref) => (\n  <SheetPortal>\n    <SheetOverlay />\n    <SheetPrimitive.Content\n      ref={ref}\n      className={cn(sheetVariants({ side }), className)}\n      {...props}\n    >\n      {children}\n      <SheetPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </SheetPrimitive.Close>\n    </SheetPrimitive.Content>\n  </SheetPortal>\n))\nSheetContent.displayName = SheetPrimitive.Content.displayName\n\nconst SheetHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetHeader.displayName = \"SheetHeader\"\n\nconst SheetFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetFooter.displayName = \"SheetFooter\"\n\nconst SheetTitle = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold text-foreground\", className)}\n    {...props}\n  />\n))\nSheetTitle.displayName = SheetPrimitive.Title.displayName\n\nconst SheetDescription = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nSheetDescription.displayName = SheetPrimitive.Description.displayName\n\nexport {\n  Sheet,\n  SheetPortal,\n  SheetOverlay,\n  SheetTrigger,\n  SheetClose,\n  SheetContent,\n  SheetHeader,\n  SheetFooter,\n  SheetTitle,\n  SheetDescription,\n}\n","size_bytes":4281},"client/src/components/mobile/WorkOrdersMobile.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Popover, PopoverContent, PopoverTrigger } from \"@/components/ui/popover\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Clock, AlertTriangle, CheckCircle2, Search, Plus, Eye, Filter, RefreshCw, ChevronDown, X } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\n\n// Helper para parsear data local sem conversão de timezone\nconst parseLocalDate = (dateString: string | null): Date | null => {\n  if (!dateString) return null;\n  \n  // Se a data já tem horário, usar como está\n  if (dateString.includes('T') || dateString.includes(' ')) {\n    return new Date(dateString);\n  }\n  \n  // Para datas sem horário (YYYY-MM-DD), criar data local\n  const [year, month, day] = dateString.split('-').map(Number);\n  return new Date(year, month - 1, day);\n};\n\ninterface MultiSelectOption {\n  value: string;\n  label: string;\n}\n\ninterface MultiSelectProps {\n  options: MultiSelectOption[];\n  selected: string[];\n  onChange: (selected: string[]) => void;\n  placeholder: string;\n  testId?: string;\n}\n\nfunction MultiSelect({ options, selected, onChange, placeholder, testId }: MultiSelectProps) {\n  const [open, setOpen] = useState(false);\n  \n  const toggleOption = (value: string) => {\n    if (selected.includes(value)) {\n      onChange(selected.filter(v => v !== value));\n    } else {\n      onChange([...selected, value]);\n    }\n  };\n\n  const clearAll = () => {\n    onChange([]);\n  };\n\n  const getDisplayText = () => {\n    if (selected.length === 0) return placeholder;\n    if (selected.length === 1) {\n      const option = options.find(o => o.value === selected[0]);\n      return option?.label || placeholder;\n    }\n    return `${selected.length} selecionados`;\n  };\n\n  return (\n    <Popover open={open} onOpenChange={setOpen}>\n      <PopoverTrigger asChild>\n        <Button\n          variant=\"outline\"\n          role=\"combobox\"\n          aria-expanded={open}\n          className=\"w-full justify-between font-normal\"\n          data-testid={testId}\n        >\n          <span className=\"truncate\">{getDisplayText()}</span>\n          <div className=\"flex items-center gap-1\">\n            {selected.length > 0 && (\n              <X \n                className=\"h-4 w-4 opacity-50 hover:opacity-100\" \n                onClick={(e) => {\n                  e.stopPropagation();\n                  clearAll();\n                }}\n              />\n            )}\n            <ChevronDown className=\"h-4 w-4 opacity-50\" />\n          </div>\n        </Button>\n      </PopoverTrigger>\n      <PopoverContent className=\"w-full p-2\" align=\"start\">\n        <div className=\"space-y-2\">\n          {options.map((option) => (\n            <div\n              key={option.value}\n              className=\"flex items-center space-x-2 hover:bg-gray-100 p-2 rounded cursor-pointer\"\n              onClick={() => toggleOption(option.value)}\n              data-testid={`${testId}-option-${option.value}`}\n            >\n              <Checkbox\n                checked={selected.includes(option.value)}\n                onCheckedChange={() => toggleOption(option.value)}\n              />\n              <label className=\"text-sm cursor-pointer flex-1\">\n                {option.label}\n              </label>\n            </div>\n          ))}\n        </div>\n      </PopoverContent>\n    </Popover>\n  );\n}\n\ninterface WorkOrdersMobileProps {\n  customerId: string;\n}\n\nexport default function WorkOrdersMobile({ customerId }: WorkOrdersMobileProps) {\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const [statusFilter, setStatusFilter] = useState<string[]>([]);\n  const [zoneFilter, setZoneFilter] = useState<string[]>([]);\n  const [lastUpdate, setLastUpdate] = useState(new Date());\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  const { data: workOrders, isLoading, refetch } = useQuery({\n    queryKey: [\"/api/customers\", customerId, \"work-orders\"],\n    enabled: !!customerId,\n  });\n\n  const { data: zones } = useQuery({\n    queryKey: [\"/api/customers\", customerId, \"zones\"],\n    enabled: !!customerId,\n  });\n\n  const handleRefresh = () => {\n    refetch();\n    setLastUpdate(new Date());\n    toast({ title: \"Atualizado!\" });\n  };\n\n  const filteredWorkOrders = (workOrders as any[])?.filter((wo: any) => {\n    const matchesStatus = statusFilter.length === 0 || statusFilter.includes(wo.status);\n    const matchesZone = zoneFilter.length === 0 || zoneFilter.includes(wo.zoneId);\n    const matchesSearch = wo.title?.toLowerCase().includes(searchTerm.toLowerCase()) ||\n                         wo.number?.toString().includes(searchTerm);\n    return matchesStatus && matchesZone && matchesSearch;\n  }) || [];\n\n  const totalAbertas = (workOrders as any[])?.filter((wo: any) => \n    wo.status === 'aberta' || wo.status === 'atrasada'\n  ).length || 0;\n  \n  const totalVencidas = (workOrders as any[])?.filter((wo: any) => \n    wo.status === 'vencida'\n  ).length || 0;\n  \n  const totalConcluidas = (workOrders as any[])?.filter((wo: any) => \n    wo.status === 'concluida'\n  ).length || 0;\n\n  const getZoneName = (zoneId: string) => {\n    const zone = (zones as any[])?.find((z: any) => z.id === zoneId);\n    return zone?.name || \"N/A\";\n  };\n\n  const getStatusBadge = (status: string, id?: string) => {\n    const testId = id ? `badge-status-${status}-${id}` : `badge-status-${status}`;\n    switch (status) {\n      case \"vencida\":\n        return <Badge className=\"bg-red-500 text-white text-xs\" data-testid={testId}>Vencida</Badge>;\n      case \"concluida\":\n        return <Badge className=\"bg-green-500 text-white text-xs\" data-testid={testId}>Concluída</Badge>;\n      case \"cancelada\":\n        return <Badge className=\"bg-gray-500 text-white text-xs\" data-testid={testId}>Cancelada</Badge>;\n      default:\n        return <Badge className=\"bg-blue-500 text-white text-xs\" data-testid={testId}>Aberta</Badge>;\n    }\n  };\n\n  const getPriorityBadge = (priority: string, id?: string) => {\n    const testId = id ? `badge-priority-${priority}-${id}` : `badge-priority-${priority}`;\n    switch (priority) {\n      case \"critica\":\n        return <Badge variant=\"outline\" className=\"bg-red-50 text-red-700 border-red-200 text-xs\" data-testid={testId}>Crítica</Badge>;\n      case \"alta\":\n        return <Badge variant=\"outline\" className=\"bg-orange-50 text-orange-700 border-orange-200 text-xs\" data-testid={testId}>Alta</Badge>;\n      case \"media\":\n        return <Badge variant=\"outline\" className=\"bg-yellow-50 text-yellow-700 border-yellow-200 text-xs\" data-testid={testId}>Média</Badge>;\n      default:\n        return <Badge variant=\"outline\" className=\"bg-gray-50 text-gray-700 border-gray-200 text-xs\" data-testid={testId}>Baixa</Badge>;\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"p-4 space-y-4\">\n        <div className=\"animate-pulse space-y-3\">\n          {[1,2,3].map(i => (\n            <div key={i} className=\"h-24 bg-gray-200 rounded-lg\"></div>\n          ))}\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gray-50 pb-20\">\n      {/* Header com atualização */}\n      <div className=\"bg-white border-b p-4 space-y-3 sticky top-0 z-10\">\n        <div className=\"flex items-center justify-between\">\n          <div className=\"text-sm text-gray-600\" data-testid=\"text-last-update\">\n            Última atualização: {lastUpdate.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}\n          </div>\n          <Button \n            variant=\"ghost\" \n            size=\"sm\" \n            onClick={handleRefresh}\n            className=\"flex items-center gap-2\"\n            data-testid=\"button-refresh\"\n          >\n            <RefreshCw className=\"w-4 h-4\" />\n            Atualizar\n          </Button>\n        </div>\n\n        {/* Busca */}\n        <div className=\"relative\">\n          <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4\" />\n          <Input\n            placeholder=\"Buscar por ID ou descrição...\"\n            value={searchTerm}\n            onChange={(e) => setSearchTerm(e.target.value)}\n            className=\"pl-10\"\n            data-testid=\"input-search\"\n          />\n        </div>\n\n        {/* Filtros */}\n        <div className=\"grid grid-cols-2 gap-2\">\n          <MultiSelect\n            options={[\n              { value: \"aberta\", label: \"Abertas\" },\n              { value: \"vencida\", label: \"Vencidas\" },\n              { value: \"concluida\", label: \"Concluídas\" },\n              { value: \"cancelada\", label: \"Canceladas\" }\n            ]}\n            selected={statusFilter}\n            onChange={setStatusFilter}\n            placeholder=\"Todos os Status\"\n            testId=\"select-status-filter\"\n          />\n\n          <MultiSelect\n            options={(zones as any[] || []).map((zone: any) => ({\n              value: zone.id,\n              label: zone.name\n            }))}\n            selected={zoneFilter}\n            onChange={setZoneFilter}\n            placeholder=\"Todas as Zonas\"\n            testId=\"select-zone-filter\"\n          />\n        </div>\n      </div>\n\n      {/* Stats Cards */}\n      <div className=\"p-4 grid grid-cols-3 gap-3\">\n        <Card className=\"bg-gradient-to-br from-blue-500 to-blue-600 border-0 shadow-lg\" data-testid=\"card-stats-abertas\">\n          <CardContent className=\"p-4 text-center\">\n            <Clock className=\"w-6 h-6 text-white mx-auto mb-2\" />\n            <p className=\"text-2xl font-bold text-white\" data-testid=\"text-count-abertas\">{totalAbertas}</p>\n            <p className=\"text-xs text-white/80\">Abertas</p>\n          </CardContent>\n        </Card>\n\n        <Card className=\"bg-gradient-to-br from-red-500 to-red-600 border-0 shadow-lg\" data-testid=\"card-stats-vencidas\">\n          <CardContent className=\"p-4 text-center\">\n            <AlertTriangle className=\"w-6 h-6 text-white mx-auto mb-2\" />\n            <p className=\"text-2xl font-bold text-white\" data-testid=\"text-count-vencidas\">{totalVencidas}</p>\n            <p className=\"text-xs text-white/80\">Vencidas</p>\n          </CardContent>\n        </Card>\n\n        <Card className=\"bg-gradient-to-br from-green-500 to-green-600 border-0 shadow-lg\" data-testid=\"card-stats-concluidas\">\n          <CardContent className=\"p-4 text-center\">\n            <CheckCircle2 className=\"w-6 h-6 text-white mx-auto mb-2\" />\n            <p className=\"text-2xl font-bold text-white\" data-testid=\"text-count-concluidas\">{totalConcluidas}</p>\n            <p className=\"text-xs text-white/80\">Concluídas</p>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Lista de OS */}\n      <div className=\"p-4 space-y-3\">\n        <h2 className=\"text-lg font-semibold mb-3\">Ordens de Serviço</h2>\n        {filteredWorkOrders.length === 0 ? (\n          <Card>\n            <CardContent className=\"p-8 text-center text-gray-500\">\n              Nenhuma ordem de serviço encontrada\n            </CardContent>\n          </Card>\n        ) : (\n          filteredWorkOrders.map((wo: any) => (\n            <Card key={wo.id} className=\"hover:shadow-md transition-shadow\" data-testid={`card-workorder-${wo.id}`}>\n              <CardContent className=\"p-4\">\n                <div className=\"space-y-3\">\n                  {/* Header */}\n                  <div className=\"flex items-start justify-between\">\n                    <div>\n                      <p className=\"font-mono text-sm font-semibold text-blue-600\" data-testid={`text-workorder-number-${wo.id}`}>\n                        #{wo.number || wo.id?.slice(0, 3)}\n                      </p>\n                      <p className=\"font-medium text-gray-900 mt-1\" data-testid={`text-workorder-title-${wo.id}`}>\n                        {wo.title || 'Sem título'}\n                      </p>\n                    </div>\n                    <div className=\"flex gap-1\">\n                      {getStatusBadge(wo.status, wo.id)}\n                    </div>\n                  </div>\n\n                  {/* Detalhes */}\n                  <div className=\"grid grid-cols-2 gap-2 text-sm\">\n                    <div>\n                      <p className=\"text-gray-500 text-xs\">Tipo</p>\n                      <p className=\"font-medium\" data-testid={`text-workorder-type-${wo.id}`}>\n                        {wo.orderType === 'programada' ? 'Programada' : \n                         wo.orderType === 'corretiva_interna' ? 'Corretiva' : 'Pública'}\n                      </p>\n                    </div>\n                    <div>\n                      <p className=\"text-gray-500 text-xs\">Prioridade</p>\n                      <div className=\"mt-0.5\">\n                        {getPriorityBadge(wo.priority, wo.id)}\n                      </div>\n                    </div>\n                    <div>\n                      <p className=\"text-gray-500 text-xs\">Local</p>\n                      <p className=\"font-medium\" data-testid={`text-workorder-zone-${wo.id}`}>\n                        {getZoneName(wo.zoneId)}\n                      </p>\n                    </div>\n                    <div>\n                      <p className=\"text-gray-500 text-xs\">Agendado</p>\n                      <p className=\"font-medium text-blue-600\" data-testid={`text-workorder-date-${wo.id}`}>\n                        {wo.scheduledDate ? parseLocalDate(wo.scheduledDate)?.toLocaleDateString('pt-BR') : '-'}\n                      </p>\n                    </div>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          ))\n        )}\n      </div>\n    </div>\n  );\n}\n","size_bytes":13806},"client/src/pages/mobile-work-order-details.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useRoute, useLocation } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { ArrowLeft, MapPin, Building2, Clock, CheckCircle, AlertCircle, Calendar, User, QrCode, Flag, PlayCircle, PauseCircle } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\n\nexport default function MobileWorkOrderDetails() {\n  const [, params] = useRoute(\"/mobile/work-order-details/:id\");\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  \n  const [workOrder, setWorkOrder] = useState<any>(null);\n  const [isLoading, setIsLoading] = useState(true);\n  const [comments, setComments] = useState<any[]>([]);\n\n  useEffect(() => {\n    if (params?.id) {\n      loadWorkOrder(params.id);\n    }\n  }, [params?.id]);\n\n  const loadWorkOrder = async (id: string) => {\n    setIsLoading(true);\n    try {\n      const response = await fetch(`/api/work-orders/${id}`);\n      if (!response.ok) throw new Error('Work order não encontrada');\n      const data = await response.json();\n      setWorkOrder(data);\n\n      // Buscar comentários para histórico\n      try {\n        const commentsResponse = await fetch(`/api/work-orders/${id}/comments`);\n        if (commentsResponse.ok) {\n          const commentsData = await commentsResponse.json();\n          setComments(commentsData);\n        }\n      } catch (err) {\n        console.error('Erro ao buscar comentários:', err);\n      }\n    } catch (error) {\n      console.error('Erro ao carregar work order:', error);\n      toast({\n        title: \"Erro\",\n        description: \"Não foi possível carregar a ordem de serviço.\",\n        variant: \"destructive\",\n      });\n      setLocation('/mobile');\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const getStatusColor = (status: string) => {\n    switch (status) {\n      case 'open': return 'bg-blue-500';\n      case 'in_progress': return 'bg-yellow-500';\n      case 'completed': return 'bg-green-500';\n      case 'cancelled': return 'bg-gray-500';\n      default: return 'bg-gray-500';\n    }\n  };\n\n  const getStatusLabel = (status: string) => {\n    switch (status) {\n      case 'open': return 'Disponível';\n      case 'in_progress': return 'Em Andamento';\n      case 'completed': return 'Concluída';\n      case 'cancelled': return 'Cancelada';\n      default: return status;\n    }\n  };\n\n  const getPriorityColor = (priority: string) => {\n    switch (priority) {\n      case 'urgent': return 'bg-red-500';\n      case 'high': return 'bg-orange-500';\n      case 'medium': return 'bg-yellow-500';\n      case 'low': return 'bg-green-500';\n      default: return 'bg-gray-500';\n    }\n  };\n\n  const getPriorityLabel = (priority: string) => {\n    switch (priority) {\n      case 'urgent': return 'Urgente';\n      case 'high': return 'Alta';\n      case 'medium': return 'Média';\n      case 'low': return 'Baixa';\n      default: return priority;\n    }\n  };\n\n  // Formata DATE (scheduledDate, dueDate) - apenas data, sem hora\n  const formatDate = (dateString: string) => {\n    if (!dateString) return '-';\n    const match = dateString.match(/^(\\d{4})-(\\d{2})-(\\d{2})/);\n    if (match) {\n      const [, year, month, day] = match;\n      return `${day}/${month}/${year}`;\n    }\n    return dateString;\n  };\n\n  // Formata TIMESTAMP (createdAt, completedAt, startedAt) - data e hora\n  const formatDateTime = (dateString: string) => {\n    if (!dateString) return '-';\n    return new Date(dateString).toLocaleString('pt-BR', {\n      day: '2-digit',\n      month: '2-digit',\n      year: 'numeric',\n      hour: '2-digit',\n      minute: '2-digit'\n    });\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center\">\n        <div className=\"text-center\">\n          <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto\"></div>\n          <p className=\"mt-4 text-gray-600\">Carregando...</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (!workOrder) {\n    return (\n      <div className=\"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center\">\n        <div className=\"text-center\">\n          <AlertCircle className=\"h-12 w-12 text-red-500 mx-auto mb-4\" />\n          <p className=\"text-gray-600\">Ordem de serviço não encontrada</p>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 pb-20\">\n      {/* Header */}\n      <div className=\"bg-gradient-to-r from-blue-600 to-blue-700 text-white p-6 shadow-lg\">\n        <div className=\"flex items-center mb-4\">\n          <Button\n            variant=\"ghost\"\n            size=\"icon\"\n            className=\"text-white hover:bg-white/20\"\n            onClick={() => setLocation('/mobile')}\n            data-testid=\"button-back\"\n          >\n            <ArrowLeft className=\"h-6 w-6\" />\n          </Button>\n          <h1 className=\"text-2xl font-bold ml-4\">Detalhes da OS</h1>\n        </div>\n      </div>\n\n      <div className=\"p-6 space-y-4\">\n        {/* Work Order Info */}\n        <Card>\n          <CardHeader>\n            <div className=\"flex items-start justify-between\">\n              <div className=\"space-y-2\">\n                <CardTitle className=\"text-xl\">{workOrder.title}</CardTitle>\n                <div className=\"flex items-center gap-2 text-sm text-gray-600\">\n                  <span className=\"font-semibold\">OS #{workOrder.workOrderNumber}</span>\n                </div>\n              </div>\n              <Badge className={`${getStatusColor(workOrder.status)} text-white`}>\n                {getStatusLabel(workOrder.status)}\n              </Badge>\n            </div>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            {/* Description */}\n            {workOrder.description && (\n              <div>\n                <p className=\"text-sm font-medium text-gray-700 mb-1\">Descrição:</p>\n                <p className=\"text-sm text-gray-600\">{workOrder.description}</p>\n              </div>\n            )}\n\n            {/* Location */}\n            <div className=\"flex items-center gap-2 text-sm text-gray-600\">\n              <Building2 className=\"w-4 h-4\" />\n              <span>{workOrder.site?.name || 'Local não especificado'}</span>\n            </div>\n\n            {workOrder.zone && (\n              <div className=\"flex items-center gap-2 text-sm text-gray-600\">\n                <MapPin className=\"w-4 h-4\" />\n                <span>{workOrder.zone.name}</span>\n              </div>\n            )}\n\n            {/* Priority */}\n            <div className=\"flex items-center gap-2\">\n              <span className=\"text-sm text-gray-700\">Prioridade:</span>\n              <Badge className={`${getPriorityColor(workOrder.priority)} text-white`}>\n                {getPriorityLabel(workOrder.priority)}\n              </Badge>\n            </div>\n\n            {/* Dates */}\n            <div className=\"space-y-2\">\n              <div className=\"flex items-center gap-2 text-sm\">\n                <Calendar className=\"w-4 h-4 text-gray-500\" />\n                <span className=\"text-gray-700\">Criada em:</span>\n                <span className=\"text-gray-600\">{formatDateTime(workOrder.createdAt)}</span>\n              </div>\n              \n              <div className=\"flex items-center gap-2 text-sm\">\n                <Clock className=\"w-4 h-4 text-gray-500\" />\n                <span className=\"text-gray-700\">Prazo:</span>\n                <span className=\"text-gray-600\">{formatDate(workOrder.dueDate)}</span>\n              </div>\n\n              {workOrder.completedAt && (\n                <div className=\"flex items-center gap-2 text-sm\">\n                  <CheckCircle className=\"w-4 h-4 text-green-500\" />\n                  <span className=\"text-gray-700\">Concluída em:</span>\n                  <span className=\"text-gray-600\">{formatDateTime(workOrder.completedAt)}</span>\n                </div>\n              )}\n            </div>\n\n            {/* Operator */}\n            {workOrder.assignedOperator && (\n              <div className=\"flex items-center gap-2 text-sm\">\n                <User className=\"w-4 h-4 text-gray-500\" />\n                <span className=\"text-gray-700\">Operador:</span>\n                <span className=\"text-gray-600\">{workOrder.assignedOperator.name}</span>\n              </div>\n            )}\n\n            {/* Type */}\n            <div className=\"flex items-center gap-2 text-sm\">\n              <span className=\"text-gray-700\">Tipo:</span>\n              <span className=\"text-gray-600 capitalize\">{workOrder.type.replace('_', ' ')}</span>\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Histórico da Ordem */}\n        <Card className=\"bg-gradient-to-br from-blue-50 to-indigo-50 border-blue-200\">\n          <CardHeader>\n            <CardTitle className=\"text-lg flex items-center gap-2 text-blue-900\">\n              <Clock className=\"w-5 h-5\" />\n              Histórico da Ordem\n            </CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-3\">\n            {/* Abertura da OS */}\n            <div className=\"flex gap-3\">\n              <div className=\"flex flex-col items-center\">\n                <div className=\"w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center\">\n                  <Flag className=\"w-4 h-4 text-white\" />\n                </div>\n                {comments.length > 0 && <div className=\"w-0.5 h-full bg-blue-300 mt-1\"></div>}\n              </div>\n              <div className={`flex-1 ${comments.length > 0 ? 'pb-4' : ''}`}>\n                <p className=\"font-semibold text-slate-900\">OS Criada</p>\n                <p className=\"text-sm text-slate-600\">\n                  {formatDateTime(workOrder.createdAt)}\n                </p>\n              </div>\n            </div>\n\n            {/* Histórico de comentários (mudanças de status) */}\n            {comments.map((comment, index) => {\n              const isLastItem = index === comments.length - 1;\n              let icon = <PlayCircle className=\"w-4 h-4 text-white\" />;\n              let bgColor = \"bg-green-500\";\n              \n              if (comment.comment.includes('pausou')) {\n                icon = <PauseCircle className=\"w-4 h-4 text-white\" />;\n                bgColor = \"bg-orange-500\";\n              } else if (comment.comment.includes('retomou') || comment.comment.includes('iniciou')) {\n                icon = <PlayCircle className=\"w-4 h-4 text-white\" />;\n                bgColor = \"bg-blue-500\";\n              } else if (comment.comment.includes('finalizou') || comment.comment.includes('concluiu')) {\n                icon = <CheckCircle className=\"w-4 h-4 text-white\" />;\n                bgColor = \"bg-green-600\";\n              }\n\n              return (\n                <div key={comment.id} className=\"flex gap-3\">\n                  <div className=\"flex flex-col items-center\">\n                    <div className={`w-8 h-8 rounded-full ${bgColor} flex items-center justify-center`}>\n                      {icon}\n                    </div>\n                    {!isLastItem && <div className=\"w-0.5 h-full bg-blue-300 mt-1\"></div>}\n                  </div>\n                  <div className={`flex-1 ${!isLastItem ? 'pb-4' : ''}`}>\n                    <p className=\"font-semibold text-slate-900\">{comment.comment.split('\\n')[0]}</p>\n                    <p className=\"text-sm text-slate-600\">\n                      {formatDateTime(comment.createdAt)}\n                    </p>\n                    {comment.user?.name && (\n                      <p className=\"text-xs text-slate-500 mt-1\">Por: {comment.user.name}</p>\n                    )}\n                  </div>\n                </div>\n              );\n            })}\n          </CardContent>\n        </Card>\n\n        {/* QR Scanner Button */}\n        <Card className=\"bg-gradient-to-r from-blue-600 to-indigo-700 text-white border-0 shadow-xl\">\n          <CardContent className=\"p-6\">\n            <Button \n              onClick={() => setLocation('/mobile/qr-scanner')}\n              data-testid=\"button-qr-scanner\"\n              className=\"w-full bg-white/20 hover:bg-white/30 text-white border-white/30 h-16 text-lg font-semibold\"\n              size=\"lg\"\n            >\n              <div className=\"flex items-center space-x-3 justify-center\">\n                <div className=\"w-10 h-10 bg-white/30 rounded-full flex items-center justify-center\">\n                  <QrCode className=\"w-6 h-6\" />\n                </div>\n                <div className=\"text-left\">\n                  <div className=\"text-lg font-bold\">Escanear QR Code</div>\n                  <div className=\"text-sm opacity-90\">Iniciar execução da ordem</div>\n                </div>\n              </div>\n            </Button>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","size_bytes":12999},"client/src/components/ErrorBoundary.tsx":{"content":"import { Component, ErrorInfo, ReactNode } from 'react';\n\ninterface Props {\n  children: ReactNode;\n}\n\ninterface State {\n  hasError: boolean;\n  error?: Error;\n}\n\nexport class ErrorBoundary extends Component<Props, State> {\n  public state: State = {\n    hasError: false\n  };\n\n  public static getDerivedStateFromError(error: Error): State {\n    return { hasError: true, error };\n  }\n\n  public componentDidCatch(error: Error, errorInfo: ErrorInfo) {\n    console.error('Erro capturado pelo Error Boundary:', error, errorInfo);\n  }\n\n  public render() {\n    if (this.state.hasError) {\n      return (\n        <div className=\"flex items-center justify-center min-h-screen bg-background\">\n          <div className=\"max-w-md p-6 bg-card rounded-lg border border-border\">\n            <h2 className=\"text-2xl font-bold text-destructive mb-4\">Ops! Algo deu errado</h2>\n            <p className=\"text-muted-foreground mb-4\">\n              {this.state.error?.message || 'Ocorreu um erro inesperado'}\n            </p>\n            <button\n              onClick={() => window.location.reload()}\n              className=\"px-4 py-2 bg-primary text-primary-foreground rounded-md hover:bg-primary/90\"\n            >\n              Recarregar Página\n            </button>\n          </div>\n        </div>\n      );\n    }\n\n    return this.props.children;\n  }\n}\n","size_bytes":1333},"client/src/components/ui/separator.tsx":{"content":"import * as React from \"react\"\nimport * as SeparatorPrimitive from \"@radix-ui/react-separator\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Separator = React.forwardRef<\n  React.ElementRef<typeof SeparatorPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>\n>(\n  (\n    { className, orientation = \"horizontal\", decorative = true, ...props },\n    ref\n  ) => (\n    <SeparatorPrimitive.Root\n      ref={ref}\n      decorative={decorative}\n      orientation={orientation}\n      className={cn(\n        \"shrink-0 bg-border\",\n        orientation === \"horizontal\" ? \"h-[1px] w-full\" : \"h-full w-[1px]\",\n        className\n      )}\n      {...props}\n    />\n  )\n)\nSeparator.displayName = SeparatorPrimitive.Root.displayName\n\nexport { Separator }\n","size_bytes":756},"client/src/pages/mobile-qr-scanner.tsx":{"content":"import { useState, useRef, useEffect } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { ArrowLeft, Camera, Flashlight, FlashlightOff, RotateCcw } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport QrScanner from \"qr-scanner\";\nimport ServiceSelectionModal from \"@/components/ServiceSelectionModal\";\n\nconst COMPANY_ID = \"company-opus-default\";\n\nexport default function MobileQrScanner() {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  \n  // QR Scanner States\n  const videoRef = useRef<HTMLVideoElement>(null);\n  const qrScannerRef = useRef<QrScanner | null>(null);\n  const [hasCamera, setHasCamera] = useState(true);\n  const [isScanning, setIsScanning] = useState(false);\n  const [cameras, setCameras] = useState<QrScanner.Camera[]>([]);\n  const [selectedCameraId, setSelectedCameraId] = useState<string>(\"\");\n  const [flashOn, setFlashOn] = useState(false);\n  const [isProcessing, setIsProcessing] = useState(false);\n\n  // Modal States\n  const [showServiceModal, setShowServiceModal] = useState(false);\n  const [resolvedContext, setResolvedContext] = useState<any>(null);\n  const [scannedQrCode, setScannedQrCode] = useState<string>(\"\");\n\n  useEffect(() => {\n    initializeCamera();\n    return () => {\n      stopScanner();\n    };\n  }, []);\n\n  const initializeCamera = async () => {\n    try {\n      const hasPermission = await QrScanner.hasCamera();\n      setHasCamera(hasPermission);\n      \n      if (hasPermission) {\n        const availableCameras = await QrScanner.listCameras();\n        setCameras(availableCameras);\n        \n        const backCamera = availableCameras.find(camera => \n          camera.label.toLowerCase().includes('back') || \n          camera.label.toLowerCase().includes('rear') ||\n          camera.label.toLowerCase().includes('environment')\n        );\n        \n        const cameraToUse = backCamera || availableCameras[0];\n        if (cameraToUse) {\n          setSelectedCameraId(cameraToUse.id);\n          await startScanner(cameraToUse.id);\n        }\n      }\n    } catch (error) {\n      console.error(\"Erro ao inicializar câmera:\", error);\n      setHasCamera(false);\n    }\n  };\n\n  const startScanner = async (cameraId?: string) => {\n    if (!videoRef.current) return;\n\n    try {\n      stopScanner();\n\n      const scanner = new QrScanner(\n        videoRef.current,\n        (result) => {\n          if (!isProcessing) {\n            handleQrCodeDetected(result.data);\n          }\n        },\n        {\n          preferredCamera: cameraId || selectedCameraId,\n          highlightScanRegion: true,\n          highlightCodeOutline: true,\n          maxScansPerSecond: 1,\n          returnDetailedScanResult: true,\n        }\n      );\n\n      qrScannerRef.current = scanner;\n      await scanner.start();\n      setIsScanning(true);\n    } catch (error) {\n      console.error(\"Erro ao iniciar scanner:\", error);\n      setHasCamera(false);\n      toast({\n        title: \"Erro no scanner\",\n        description: \"Não foi possível iniciar o scanner QR.\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const stopScanner = () => {\n    if (qrScannerRef.current) {\n      qrScannerRef.current.stop();\n      qrScannerRef.current.destroy();\n      qrScannerRef.current = null;\n    }\n    setIsScanning(false);\n  };\n\n  const handleQrCodeDetected = async (qrCode: string) => {\n    if (isProcessing) return;\n    \n    setIsProcessing(true);\n    stopScanner();\n    setScannedQrCode(qrCode);\n    \n    // Extrair código da URL se necessário\n    let extractedCode = qrCode;\n    if (qrCode.includes('replit.dev/qr-execution/') || qrCode.includes('/qr-execution/')) {\n      const match = qrCode.match(/\\/qr-execution\\/([^\\/\\?]+)/);\n      if (match) {\n        extractedCode = match[1];\n      }\n    }\n\n    try {\n      const response = await fetch(`/api/qr-scan/resolve?code=${encodeURIComponent(extractedCode)}`, {\n        cache: 'no-store',\n        headers: {\n          'Cache-Control': 'no-cache',\n          'Pragma': 'no-cache'\n        }\n      });\n      \n      if (response.ok) {\n        const resolved = await response.json();\n        \n        // Verificar se tem customer\n        if (!resolved.customer) {\n          throw new Error('QR code sem cliente associado');\n        }\n        \n        setResolvedContext(resolved);\n        setShowServiceModal(true);\n        \n        toast({\n          title: \"QR Code detectado!\",\n          description: `${resolved.zone.name} - ${resolved.site.name}`,\n        });\n      } else {\n        throw new Error('QR code não encontrado ou inativo');\n      }\n    } catch (error) {\n      console.error(\"Erro ao processar QR code:\", error);\n      toast({\n        title: \"QR Code inválido\",\n        description: \"O QR code não pôde ser processado. Tente novamente.\",\n        variant: \"destructive\",\n      });\n      \n      setIsProcessing(false);\n      setTimeout(() => startScanner(), 2000);\n    }\n  };\n\n  const handleServiceSelection = async (serviceId: string, checklistAnswers?: any, workOrderId?: string) => {\n    console.log('[QR SCANNER] handleServiceSelection chamado:', { serviceId, workOrderId, hasResolvedContext: !!resolvedContext });\n    \n    if (!resolvedContext) {\n      console.error('[QR SCANNER] Erro: resolvedContext está vazio!');\n      return;\n    }\n\n    try {\n      // Se está selecionando uma work order existente\n      if (workOrderId) {\n        console.log('[QR SCANNER] Selecionando work order existente:', workOrderId);\n        setShowServiceModal(false);\n        setLocation(`/mobile/work-order/${workOrderId}`);\n        return;\n      }\n\n      // Criar nova work order\n      const customerId = resolvedContext.customer.id;\n      const qrModule = resolvedContext.qrPoint?.module || 'clean';\n      const workOrderData = {\n        companyId: COMPANY_ID,\n        module: qrModule,\n        siteId: resolvedContext.site.id,\n        zoneId: resolvedContext.zone.id,\n        serviceId: serviceId,\n        orderType: 'corretiva_interna',\n        priority: 'media',\n        title: `Serviço via QR - ${resolvedContext.zone.name}`,\n        description: `Work order criada via QR Code: ${scannedQrCode}`,\n        origin: 'QR Scanner Mobile',\n        qrCodePointId: resolvedContext.qrPoint?.id,\n        checklistData: checklistAnswers || null\n      };\n      \n      console.log('[QR SCANNER] Criando work order com módulo:', qrModule);\n\n      console.log('[QR SCANNER] Criando nova work order para customer:', customerId, workOrderData);\n\n      const response = await fetch(`/api/customers/${customerId}/work-orders`, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify(workOrderData),\n      });\n\n      console.log('[QR SCANNER] Response status:', response.status);\n\n      if (response.ok) {\n        const workOrder = await response.json();\n        console.log('[QR SCANNER] Work order criada:', workOrder);\n        \n        toast({\n          title: \"Work Order Criada!\",\n          description: `OS #${workOrder.number} criada com sucesso`,\n        });\n\n        setShowServiceModal(false);\n        console.log('[QR SCANNER] Navegando para:', `/mobile/work-order/${workOrder.id}`);\n        setLocation(`/mobile/work-order/${workOrder.id}`);\n      } else {\n        const errorData = await response.text();\n        console.error('[QR SCANNER] Erro na resposta:', response.status, errorData);\n        throw new Error(`Erro ao criar work order: ${response.status}`);\n      }\n    } catch (error) {\n      console.error(\"[QR SCANNER] Erro ao processar serviço:\", error);\n      toast({\n        title: \"Erro\",\n        description: \"Não foi possível criar a work order.\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const handleModalClose = () => {\n    setShowServiceModal(false);\n    setResolvedContext(null);\n    setScannedQrCode(\"\");\n    setIsProcessing(false);\n    setTimeout(() => startScanner(), 500);\n  };\n\n  const toggleFlash = async () => {\n    if (qrScannerRef.current) {\n      try {\n        if (flashOn) {\n          await qrScannerRef.current.turnFlashOff();\n          setFlashOn(false);\n        } else {\n          await qrScannerRef.current.turnFlashOn();\n          setFlashOn(true);\n        }\n      } catch (error) {\n        toast({\n          title: \"Flash não disponível\",\n          description: \"O flash não está disponível neste dispositivo.\",\n          variant: \"destructive\",\n        });\n      }\n    }\n  };\n\n  const switchCamera = async () => {\n    if (cameras.length <= 1) return;\n    \n    const currentIndex = cameras.findIndex(camera => camera.id === selectedCameraId);\n    const nextIndex = (currentIndex + 1) % cameras.length;\n    const nextCamera = cameras[nextIndex];\n    \n    setSelectedCameraId(nextCamera.id);\n    await startScanner(nextCamera.id);\n    \n    toast({\n      title: \"Câmera alterada\",\n      description: nextCamera.label,\n    });\n  };\n\n  if (!hasCamera) {\n    return (\n      <div className=\"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4\">\n        <div className=\"max-w-md mx-auto\">\n          <div className=\"flex items-center justify-between mb-6\">\n            <Button \n              variant=\"ghost\" \n              onClick={() => setLocation(\"/mobile\")}\n              className=\"p-2\"\n              data-testid=\"button-back\"\n            >\n              <ArrowLeft className=\"w-6 h-6\" />\n            </Button>\n            <h1 className=\"text-xl font-bold\">Scanner QR</h1>\n            <div></div>\n          </div>\n\n          <Card className=\"bg-white/80 backdrop-blur-sm border-white/20\">\n            <CardContent className=\"p-6 text-center\">\n              <Camera className=\"w-16 h-16 text-slate-400 mx-auto mb-4\" />\n              <h3 className=\"text-lg font-semibold text-slate-900 mb-2\">\n                Câmera não disponível\n              </h3>\n              <p className=\"text-slate-600 mb-4\">\n                Não foi possível acessar a câmera do dispositivo. Verifique as permissões.\n              </p>\n              <Button onClick={initializeCamera} className=\"w-full\" data-testid=\"button-retry-camera\">\n                Tentar Novamente\n              </Button>\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-black relative\">\n      {/* Header */}\n      <div className=\"absolute top-0 left-0 right-0 z-50 bg-black/50 backdrop-blur-sm\">\n        <div className=\"flex items-center justify-between p-4\">\n          <Button \n            variant=\"ghost\" \n            onClick={() => setLocation(\"/mobile\")}\n            className=\"p-2 text-white hover:bg-white/20\"\n            data-testid=\"button-back-scanner\"\n          >\n            <ArrowLeft className=\"w-6 h-6\" />\n          </Button>\n          <h1 className=\"text-xl font-bold text-white\">Scanner QR</h1>\n          <div className=\"flex space-x-2\">\n            {cameras.length > 1 && (\n              <Button \n                variant=\"ghost\" \n                onClick={switchCamera}\n                className=\"p-2 text-white hover:bg-white/20\"\n                data-testid=\"button-switch-camera\"\n              >\n                <RotateCcw className=\"w-6 h-6\" />\n              </Button>\n            )}\n            <Button \n              variant=\"ghost\" \n              onClick={toggleFlash}\n              className=\"p-2 text-white hover:bg-white/20\"\n              data-testid=\"button-toggle-flash\"\n            >\n              {flashOn ? <FlashlightOff className=\"w-6 h-6\" /> : <Flashlight className=\"w-6 h-6\" />}\n            </Button>\n          </div>\n        </div>\n      </div>\n\n      {/* Camera View */}\n      <div className=\"relative w-full h-screen\">\n        <video \n          ref={videoRef}\n          className=\"w-full h-full object-cover\"\n          playsInline\n          muted\n        />\n        \n        {/* Scanning Overlay */}\n        <div className=\"absolute inset-0 flex items-center justify-center pointer-events-none\">\n          <div className=\"relative\">\n            {/* Scanning frame */}\n            <div className=\"w-64 h-64 border-2 border-white/50 rounded-2xl relative\">\n              {/* Corner indicators */}\n              <div className=\"absolute top-0 left-0 w-8 h-8 border-t-4 border-l-4 border-white rounded-tl-2xl\"></div>\n              <div className=\"absolute top-0 right-0 w-8 h-8 border-t-4 border-r-4 border-white rounded-tr-2xl\"></div>\n              <div className=\"absolute bottom-0 left-0 w-8 h-8 border-b-4 border-l-4 border-white rounded-bl-2xl\"></div>\n              <div className=\"absolute bottom-0 right-0 w-8 h-8 border-b-4 border-r-4 border-white rounded-br-2xl\"></div>\n              \n              {/* Scanning line animation */}\n              {isScanning && !isProcessing && (\n                <div className=\"absolute top-0 left-0 right-0 h-1 bg-white animate-pulse\"></div>\n              )}\n            </div>\n            \n            {/* Instructions */}\n            <p className=\"text-white text-center mt-6 bg-black/50 px-4 py-2 rounded-lg\">\n              {isProcessing ? \"Processando QR...\" : isScanning ? \"Posicione o QR code dentro da área\" : \"Iniciando scanner...\"}\n            </p>\n          </div>\n        </div>\n      </div>\n\n      {/* Service Selection Modal */}\n      {showServiceModal && resolvedContext && (\n        <ServiceSelectionModal\n          isOpen={showServiceModal}\n          onClose={handleModalClose}\n          resolvedContext={resolvedContext}\n          scannedQrCode={scannedQrCode}\n          onServiceSelect={handleServiceSelection}\n        />\n      )}\n    </div>\n  );\n}\n","size_bytes":13628},"client/src/components/ui/alert.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst alertVariants = cva(\n  \"relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-background text-foreground\",\n        destructive:\n          \"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Alert = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>\n>(({ className, variant, ...props }, ref) => (\n  <div\n    ref={ref}\n    role=\"alert\"\n    className={cn(alertVariants({ variant }), className)}\n    {...props}\n  />\n))\nAlert.displayName = \"Alert\"\n\nconst AlertTitle = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLHeadingElement>\n>(({ className, ...props }, ref) => (\n  <h5\n    ref={ref}\n    className={cn(\"mb-1 font-medium leading-none tracking-tight\", className)}\n    {...props}\n  />\n))\nAlertTitle.displayName = \"AlertTitle\"\n\nconst AlertDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm [&_p]:leading-relaxed\", className)}\n    {...props}\n  />\n))\nAlertDescription.displayName = \"AlertDescription\"\n\nexport { Alert, AlertTitle, AlertDescription }\n","size_bytes":1584},"client/src/components/mobile/SettingsMobile.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { \n  Settings, \n  Building, \n  Users, \n  QrCode, \n  Calendar, \n  List, \n  BarChart3, \n  ChevronRight,\n  Cog,\n  Bell,\n  Shield,\n  Database,\n  Globe,\n  Palette\n} from \"lucide-react\";\n\ninterface SettingsMobileProps {\n  onNavigate: (page: string) => void;\n}\n\nexport default function SettingsMobile({ onNavigate }: SettingsMobileProps) {\n  const mainSettings = [\n    { \n      icon: Users, \n      label: \"Usuários e Permissões\", \n      description: \"Gerenciar usuários, perfis e acessos\",\n      page: \"users\", \n      color: \"text-blue-600\", \n      bg: \"bg-blue-50\",\n      badge: null\n    },\n    { \n      icon: Building, \n      label: \"Locais e Zonas\", \n      description: \"Locais, plantas e áreas de limpeza\",\n      page: \"sites\", \n      color: \"text-green-600\", \n      bg: \"bg-green-50\",\n      badge: null\n    },\n    { \n      icon: List, \n      label: \"Tipos de Serviço\", \n      description: \"Categorias e tipos de serviços\",\n      page: \"services\", \n      color: \"text-purple-600\", \n      bg: \"bg-purple-50\",\n      badge: null\n    },\n  ];\n\n  const operationalSettings = [\n    { \n      icon: Calendar, \n      label: \"Cronograma de Limpeza\", \n      description: \"Programação e frequências\",\n      page: \"schedule\", \n      color: \"text-pink-600\", \n      bg: \"bg-pink-50\",\n      badge: null\n    },\n    { \n      icon: QrCode, \n      label: \"QR Codes\", \n      description: \"Pontos de execução e atendimento\",\n      page: \"qrcodes\", \n      color: \"text-orange-600\", \n      bg: \"bg-orange-50\",\n      badge: null\n    },\n    { \n      icon: List, \n      label: \"Checklists\", \n      description: \"Templates de checklist\",\n      page: \"checklists\", \n      color: \"text-indigo-600\", \n      bg: \"bg-indigo-50\",\n      badge: null\n    },\n  ];\n\n  const systemSettings = [\n    { \n      icon: Cog, \n      label: \"Configurações do Sistema\", \n      description: \"Parâmetros gerais\",\n      page: \"service-settings\", \n      color: \"text-slate-600\", \n      bg: \"bg-slate-50\",\n      badge: null\n    },\n    { \n      icon: Bell, \n      label: \"Notificações\", \n      description: \"Alertas e avisos\",\n      page: \"notifications\", \n      color: \"text-yellow-600\", \n      bg: \"bg-yellow-50\",\n      badge: \"Em breve\"\n    },\n    { \n      icon: Database, \n      label: \"Backup e Dados\", \n      description: \"Gerenciar backups\",\n      page: \"backup\", \n      color: \"text-cyan-600\", \n      bg: \"bg-cyan-50\",\n      badge: \"Em breve\"\n    },\n  ];\n\n  const analyticsSettings = [\n    { \n      icon: BarChart3, \n      label: \"Relatórios\", \n      description: \"Métricas e análises\",\n      page: \"reports\", \n      color: \"text-violet-600\", \n      bg: \"bg-violet-50\",\n      badge: null\n    },\n    { \n      icon: BarChart3, \n      label: \"Dashboards BI\", \n      description: \"Painéis de controle\",\n      page: \"dashboards\", \n      color: \"text-teal-600\", \n      bg: \"bg-teal-50\",\n      badge: null\n    },\n  ];\n\n  const renderSettingButton = (item: any) => (\n    <Button\n      key={item.page}\n      variant=\"ghost\"\n      onClick={() => onNavigate(item.page)}\n      className=\"w-full justify-start p-0 h-auto hover:bg-transparent group\"\n      data-testid={`button-navigate-${item.page}`}\n      disabled={!!item.badge}\n    >\n      <Card className=\"w-full border-0 shadow-sm hover:shadow-md transition-all group-hover:scale-[1.01]\">\n        <CardContent className=\"p-4\">\n          <div className=\"flex items-center gap-4\">\n            <div className={`w-14 h-14 ${item.bg} rounded-2xl flex items-center justify-center shrink-0 group-hover:scale-110 transition-transform`}>\n              <item.icon className={`w-7 h-7 ${item.color}`} />\n            </div>\n            <div className=\"flex-1 text-left\">\n              <div className=\"flex items-center gap-2 mb-1\">\n                <p className=\"font-semibold text-gray-900 text-base\" data-testid={`text-setting-label-${item.page}`}>\n                  {item.label}\n                </p>\n                {item.badge && (\n                  <span className=\"px-2 py-0.5 bg-amber-100 text-amber-700 text-xs font-medium rounded-full\">\n                    {item.badge}\n                  </span>\n                )}\n              </div>\n              <p className=\"text-sm text-gray-600\">{item.description}</p>\n            </div>\n            <ChevronRight className=\"w-5 h-5 text-gray-400 group-hover:text-gray-600 group-hover:translate-x-1 transition-all\" />\n          </div>\n        </CardContent>\n      </Card>\n    </Button>\n  );\n\n  return (\n    <div className=\"min-h-screen bg-gray-50 pb-20\">\n      {/* Header Moderno */}\n      <div className=\"bg-gradient-to-br from-blue-600 via-indigo-600 to-purple-600 p-6 pb-8\">\n        <div className=\"flex items-center gap-4 mb-4\">\n          <div className=\"w-16 h-16 bg-white/20 backdrop-blur-sm rounded-2xl flex items-center justify-center ring-4 ring-white/20\">\n            <Settings className=\"w-8 h-8 text-white\" />\n          </div>\n          <div>\n            <h1 className=\"text-2xl font-bold text-white\">Configurações</h1>\n            <p className=\"text-sm text-white/80\">Gerenciar sistema OPUS CLEAN</p>\n          </div>\n        </div>\n      </div>\n\n      {/* Conteúdo com margem negativa para sobrepor o header */}\n      <div className=\"px-4 -mt-4 space-y-6\">\n        {/* Configurações Principais */}\n        <div>\n          <Card className=\"border-0 shadow-lg\">\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"text-lg flex items-center gap-2\">\n                <Shield className=\"w-5 h-5 text-blue-600\" />\n                Gerenciamento Principal\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-2 px-2 pb-2\">\n              {mainSettings.map((item, index) => (\n                <div key={item.page}>\n                  {renderSettingButton(item)}\n                  {index < mainSettings.length - 1 && <Separator className=\"my-2\" />}\n                </div>\n              ))}\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* Configurações Operacionais */}\n        <div>\n          <Card className=\"border-0 shadow-lg\">\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"text-lg flex items-center gap-2\">\n                <Cog className=\"w-5 h-5 text-green-600\" />\n                Operações\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-2 px-2 pb-2\">\n              {operationalSettings.map((item, index) => (\n                <div key={item.page}>\n                  {renderSettingButton(item)}\n                  {index < operationalSettings.length - 1 && <Separator className=\"my-2\" />}\n                </div>\n              ))}\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* Análises e Relatórios */}\n        <div>\n          <Card className=\"border-0 shadow-lg\">\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"text-lg flex items-center gap-2\">\n                <BarChart3 className=\"w-5 h-5 text-purple-600\" />\n                Análises\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-2 px-2 pb-2\">\n              {analyticsSettings.map((item, index) => (\n                <div key={item.page}>\n                  {renderSettingButton(item)}\n                  {index < analyticsSettings.length - 1 && <Separator className=\"my-2\" />}\n                </div>\n              ))}\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* Configurações do Sistema */}\n        <div>\n          <Card className=\"border-0 shadow-lg\">\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"text-lg flex items-center gap-2\">\n                <Globe className=\"w-5 h-5 text-slate-600\" />\n                Sistema\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-2 px-2 pb-2\">\n              {systemSettings.map((item, index) => (\n                <div key={item.page}>\n                  {renderSettingButton(item)}\n                  {index < systemSettings.length - 1 && <Separator className=\"my-2\" />}\n                </div>\n              ))}\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* Card Informativo */}\n        <Card className=\"bg-gradient-to-br from-blue-50 to-indigo-50 border-blue-200\">\n          <CardContent className=\"p-5\">\n            <div className=\"flex items-start gap-3\">\n              <div className=\"w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center shrink-0\">\n                <Palette className=\"w-5 h-5 text-white\" />\n              </div>\n              <div>\n                <p className=\"font-semibold text-gray-900 mb-1\">Sistema OPUS CLEAN</p>\n                <p className=\"text-sm text-gray-600\">\n                  Gerencie todos os aspectos do sistema de limpeza e facilities em um só lugar.\n                </p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","size_bytes":9201},"check-vm-opusclean.sh":{"content":"#!/bin/bash\nset -euo pipefail\n\n# ====== CONFIGURÁVEIS ======\nDB_NAME=\"opusclean\"\n# Empresa principal (pelos teus dados, é esta)\nCOMPANY_ID=\"company-admin-default\"\n# Usuários principais para validar roles\nUSERS=(\"user-admin-opus\" \"user-manoel.mariano-1759521589871\")\n# Domínio público do site\nDOMAIN=\"opusclean.grupoopus.com\"\n# ===========================\n\nPSQL=\"sudo -u postgres psql -d ${DB_NAME} -v ON_ERROR_STOP=1\"\n\necho \"🔍 VERIFICANDO BANCO ${DB_NAME}\"\necho \"==============================\"\n\necho \"\"\necho \"1️⃣ Totais de registros:\"\n$PSQL -t -c \"SELECT COUNT(*) FROM companies;\"  | xargs | sed 's/^/   Companies: /'\n$PSQL -t -c \"SELECT COUNT(*) FROM customers;\"  | xargs | sed 's/^/   Customers: /'\n$PSQL -t -c \"SELECT COUNT(*) FROM users;\"      | xargs | sed 's/^/   Users: /'\n$PSQL -t -c \"SELECT COUNT(*) FROM custom_roles;\"    | xargs | sed 's/^/   Custom Roles: /'\n$PSQL -t -c \"SELECT COUNT(*) FROM role_permissions;\"| xargs | sed 's/^/   Role Permissions: /'\n$PSQL -t -c \"SELECT COUNT(*) FROM user_role_assignments;\"| xargs | sed 's/^/   User↔Role Assignments: /'\n\necho \"\"\necho \"2️⃣ CUSTOMERS (empresa ${COMPANY_ID}):\"\n$PSQL -c \"SELECT id, name, company_id, is_active FROM customers WHERE company_id='${COMPANY_ID}' ORDER BY name;\"\n\necho \"\"\necho \"3️⃣ COMPANIES:\"\n$PSQL -c \"SELECT id, name FROM companies ORDER BY id;\"\n\necho \"\"\necho \"4️⃣ ROLES por empresa:\"\n$PSQL -c \"SELECT company_id, id AS role_id, name FROM custom_roles ORDER BY company_id, name;\"\n\necho \"\"\necho \"5️⃣ PERMISSÕES por role (contagem):\"\n$PSQL -c \"SELECT role_id, COUNT(*) AS perms FROM role_permissions GROUP BY role_id ORDER BY role_id;\"\n\necho \"\"\necho \"6️⃣ VÍNCULOS usuário ↔ role:\"\n$PSQL -c \"SELECT user_id, role_id FROM user_role_assignments ORDER BY user_id, role_id;\"\n\necho \"\"\necho \"7️⃣ Roles efetivos dos usuários-alvo:\"\nfor U in \"${USERS[@]}\"; do\n  echo \"   • $U\"\n  $PSQL -c \"SELECT r.id, r.name, r.company_id\n            FROM custom_roles r\n            JOIN user_role_assignments ura ON ura.role_id = r.id\n            WHERE ura.user_id = '$U';\"\ndone\n\necho \"\"\necho \"8️⃣ Sanidade de schema/donos (top 10 tabelas):\"\n$PSQL -c \"SELECT schemaname, tablename, tableowner\n          FROM pg_tables\n          WHERE schemaname='public'\n          ORDER BY tablename\n          LIMIT 10;\"\n\necho \"\"\necho \"9️⃣ API LOCAL (Node/Express na 3007):\"\ncurl -sS http://127.0.0.1:3007/api/companies/${COMPANY_ID}/customers | head -c 400; echo\ncurl -sSI http://127.0.0.1:3007/ | head -n 15\n\necho \"\"\necho \"🔟 API via NGINX/HTTPS (${DOMAIN}):\"\ncurl -sS https://${DOMAIN}/api/companies/${COMPANY_ID}/customers | head -c 400; echo\ncurl -sSI https://${DOMAIN}/ | head -n 15\n\necho \"\"\necho \"✅ PRONTO.\"\necho \"==============================\"\n","size_bytes":2748},"client/src/components/ui/tooltip.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as TooltipPrimitive from \"@radix-ui/react-tooltip\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst TooltipProvider = TooltipPrimitive.Provider\n\nconst Tooltip = TooltipPrimitive.Root\n\nconst TooltipTrigger = TooltipPrimitive.Trigger\n\nconst TooltipContent = React.forwardRef<\n  React.ElementRef<typeof TooltipPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <TooltipPrimitive.Content\n    ref={ref}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nTooltipContent.displayName = TooltipPrimitive.Content.displayName\n\nexport { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }\n","size_bytes":1209},"client/src/components/ui/toggle-group.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ToggleGroupPrimitive from \"@radix-ui/react-toggle-group\"\nimport { type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { toggleVariants } from \"@/components/ui/toggle\"\n\nconst ToggleGroupContext = React.createContext<\n  VariantProps<typeof toggleVariants>\n>({\n  size: \"default\",\n  variant: \"default\",\n})\n\nconst ToggleGroup = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, children, ...props }, ref) => (\n  <ToggleGroupPrimitive.Root\n    ref={ref}\n    className={cn(\"flex items-center justify-center gap-1\", className)}\n    {...props}\n  >\n    <ToggleGroupContext.Provider value={{ variant, size }}>\n      {children}\n    </ToggleGroupContext.Provider>\n  </ToggleGroupPrimitive.Root>\n))\n\nToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName\n\nconst ToggleGroupItem = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &\n    VariantProps<typeof toggleVariants>\n>(({ className, children, variant, size, ...props }, ref) => {\n  const context = React.useContext(ToggleGroupContext)\n\n  return (\n    <ToggleGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        toggleVariants({\n          variant: context.variant || variant,\n          size: context.size || size,\n        }),\n        className\n      )}\n      {...props}\n    >\n      {children}\n    </ToggleGroupPrimitive.Item>\n  )\n})\n\nToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName\n\nexport { ToggleGroup, ToggleGroupItem }\n","size_bytes":1753},"client/src/hooks/use-mobile.ts":{"content":"import { useState, useEffect } from 'react';\n\nexport function useIsMobile() {\n  const [isMobile, setIsMobile] = useState(false);\n\n  useEffect(() => {\n    const checkDevice = () => {\n      const userAgent = navigator.userAgent;\n      const isMobileDevice = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent);\n      const isSmallScreen = window.innerWidth <= 768;\n      setIsMobile(isMobileDevice || isSmallScreen);\n    };\n\n    checkDevice();\n    window.addEventListener('resize', checkDevice);\n\n    return () => {\n      window.removeEventListener('resize', checkDevice);\n    };\n  }, []);\n\n  return isMobile;\n}","size_bytes":638},"client/src/components/layout/header.tsx":{"content":"import { Button } from \"@/components/ui/button\";\n\ninterface HeaderProps {\n  title: string;\n  description?: string;\n  children?: React.ReactNode;\n}\n\nexport default function Header({ title, description, children }: HeaderProps) {\n  return (\n    <header className=\"bg-card border-b border-border p-4 flex items-center justify-between\">\n      <div>\n        <h2 className=\"text-2xl font-bold text-foreground\">{title}</h2>\n        {description && (\n          <p className=\"text-sm text-muted-foreground\">{description}</p>\n        )}\n      </div>\n      <div className=\"flex items-center space-x-4\">\n        <div className=\"text-sm text-muted-foreground\">\n          Última atualização: {new Date().toLocaleTimeString('pt-BR', { \n            hour: '2-digit', \n            minute: '2-digit' \n          })}\n        </div>\n        {children}\n      </div>\n    </header>\n  );\n}\n","size_bytes":867},"client/src/hooks/useAuth.ts":{"content":"import { useState, useEffect } from 'react';\n\nexport interface User {\n  id: string;\n  companyId: string;\n  username: string;\n  email: string;\n  name: string;\n  role: 'admin' | 'gestor_cliente' | 'supervisor_site' | 'operador' | 'auditor';\n  isActive: boolean;\n}\n\n// Funções de permissão baseadas no role\nexport function isAdmin(user: User | null): boolean {\n  return user?.role === 'admin';\n}\n\nexport function canManageClients(user: User | null): boolean {\n  return user?.role === 'admin'; // Apenas admin pode gerenciar clientes\n}\n\nexport function canViewAllCompanies(user: User | null): boolean {\n  return user?.role === 'admin'; // Apenas admin vê todos os clientes\n}\n\nexport function canManageUsers(user: User | null): boolean {\n  return user?.role === 'admin' || user?.role === 'gestor_cliente';\n}\n\nexport function canOnlyViewOwnWorkOrders(user: User | null): boolean {\n  return user?.role === 'operador';\n}\n\nexport function canManageWorkOrders(user: User | null): boolean {\n  return user?.role === 'admin' || \n         user?.role === 'gestor_cliente' || \n         user?.role === 'supervisor_site';\n}\n\nexport function canViewReports(user: User | null): boolean {\n  return user?.role === 'admin' || \n         user?.role === 'gestor_cliente' || \n         user?.role === 'auditor';\n}\n\nexport function getAuthState() {\n  try {\n    const authStr = localStorage.getItem('opus_clean_auth');\n    if (!authStr) {\n      return { isAuthenticated: false, user: null };\n    }\n    \n    const authData = JSON.parse(authStr);\n    return { isAuthenticated: !!authData.user, user: authData.user };\n  } catch (error) {\n    console.error('Erro ao ler estado de autenticação:', error);\n    return { isAuthenticated: false, user: null };\n  }\n}\n\nexport function useAuth() {\n  const [authState, setAuthState] = useState(() => getAuthState());\n\n  useEffect(() => {\n    const checkAuth = () => {\n      const newState = getAuthState();\n      if (newState.isAuthenticated !== authState.isAuthenticated ||\n          newState.user?.id !== authState.user?.id) {\n        setAuthState(newState);\n      }\n    };\n\n    // Verificar mudanças a cada 5 segundos\n    const interval = setInterval(checkAuth, 5000);\n    \n    return () => clearInterval(interval);\n  }, [authState]);\n\n  return {\n    user: authState.user,\n    isAuthenticated: authState.isAuthenticated,\n    isAdmin: isAdmin(authState.user),\n    canManageClients: canManageClients(authState.user),\n    canViewAllCompanies: canViewAllCompanies(authState.user),\n    canManageUsers: canManageUsers(authState.user),\n    canOnlyViewOwnWorkOrders: canOnlyViewOwnWorkOrders(authState.user),\n    canManageWorkOrders: canManageWorkOrders(authState.user),\n    canViewReports: canViewReports(authState.user),\n  };\n}","size_bytes":2738},"client/src/components/ManualSelectionModal.tsx":{"content":"import { Dialog, DialogContent, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Label } from \"@/components/ui/label\";\nimport { AlertCircle, MapPin, Wrench, X } from \"lucide-react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { useState } from \"react\";\nimport type { Zone, Site, CleaningActivity } from \"@shared/schema\";\n\ninterface ManualSelectionModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  onLocationServiceSelect: (zoneId: string, serviceId: string) => void;\n  companyId: string;\n}\n\nexport default function ManualSelectionModal({\n  isOpen,\n  onClose,\n  onLocationServiceSelect,\n  companyId,\n}: ManualSelectionModalProps) {\n  const [selectedSiteId, setSelectedSiteId] = useState<string>(\"\");\n  const [selectedZoneId, setSelectedZoneId] = useState<string>(\"\");\n  const [selectedServiceId, setSelectedServiceId] = useState<string>(\"\");\n\n  // Fetch sites for the company\n  const { data: sites = [], isLoading: sitesLoading } = useQuery<Site[]>({\n    queryKey: [`/api/companies/${companyId}/sites`],\n    enabled: isOpen && !!companyId,\n  });\n\n  // Fetch zones for selected site\n  const { data: zones = [], isLoading: zonesLoading } = useQuery<Zone[]>({\n    queryKey: [`/api/sites/${selectedSiteId}/zones`],\n    enabled: !!selectedSiteId,\n  });\n\n  // Fetch services for selected zone\n  const { data: services = [], isLoading: servicesLoading } = useQuery<CleaningActivity[]>({\n    queryKey: [`/api/companies/${companyId}/zones/${selectedZoneId}/services`],\n    enabled: !!selectedZoneId && !!companyId,\n  });\n\n  const handleSiteChange = (siteId: string) => {\n    setSelectedSiteId(siteId);\n    setSelectedZoneId(\"\");\n    setSelectedServiceId(\"\");\n  };\n\n  const handleZoneChange = (zoneId: string) => {\n    setSelectedZoneId(zoneId);\n    setSelectedServiceId(\"\");\n  };\n\n  const handleServiceChange = (serviceId: string) => {\n    setSelectedServiceId(serviceId);\n  };\n\n  const handleConfirm = () => {\n    if (selectedZoneId && selectedServiceId) {\n      onLocationServiceSelect(selectedZoneId, selectedServiceId);\n      handleClose();\n    }\n  };\n\n  const handleClose = () => {\n    setSelectedSiteId(\"\");\n    setSelectedZoneId(\"\");\n    setSelectedServiceId(\"\");\n    onClose();\n  };\n\n  const canConfirm = selectedZoneId && selectedServiceId;\n\n  return (\n    <Dialog open={isOpen} onOpenChange={handleClose}>\n      <DialogContent className=\"w-[95vw] max-w-md mx-auto bg-white rounded-xl shadow-xl\">\n        <DialogHeader className=\"space-y-3\">\n          <div className=\"flex items-center justify-between\">\n            <DialogTitle className=\"text-xl font-bold text-navy-600 flex items-center gap-2\">\n              <MapPin className=\"w-5 h-5\" />\n              Seleção Manual\n            </DialogTitle>\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={handleClose}\n              className=\"p-1 h-8 w-8 text-gray-500 hover:text-gray-700\"\n              data-testid=\"button-close-manual-modal\"\n            >\n              <X className=\"w-4 h-4\" />\n            </Button>\n          </div>\n          <div className=\"flex items-center gap-2 text-sm text-gray-600 bg-blue-50 p-3 rounded-lg\">\n            <AlertCircle className=\"w-4 h-4 text-blue-600 flex-shrink-0\" />\n            <span>Selecione o local e serviço que você deseja executar.</span>\n          </div>\n        </DialogHeader>\n\n        <div className=\"space-y-6 py-4\">\n          {/* Site Selection */}\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"site-select\" className=\"text-sm font-medium text-gray-700\">\n              1. Selecione o Local\n            </Label>\n            {sitesLoading ? (\n              <div className=\"text-sm text-gray-500 p-3 text-center\">Carregando locais...</div>\n            ) : (\n              <Select\n                value={selectedSiteId}\n                onValueChange={handleSiteChange}\n                disabled={sites.length === 0}\n              >\n                <SelectTrigger \n                  id=\"site-select\"\n                  className=\"w-full\"\n                  data-testid=\"select-site\"\n                >\n                  <SelectValue placeholder=\"Escolha um local...\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {sites.map((site) => (\n                    <SelectItem key={site.id} value={site.id}>\n                      {site.name}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            )}\n          </div>\n\n          {/* Zone Selection */}\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"zone-select\" className=\"text-sm font-medium text-gray-700\">\n              2. Selecione a Zona\n            </Label>\n            {!selectedSiteId ? (\n              <div className=\"text-sm text-gray-400 p-3 text-center bg-gray-50 rounded-md\">\n                Primeiro selecione um local\n              </div>\n            ) : zonesLoading ? (\n              <div className=\"text-sm text-gray-500 p-3 text-center\">Carregando zonas...</div>\n            ) : zones.length === 0 ? (\n              <div className=\"text-sm text-orange-600 p-3 text-center bg-orange-50 rounded-md\">\n                Nenhuma zona encontrada para este local\n              </div>\n            ) : (\n              <Select\n                value={selectedZoneId}\n                onValueChange={handleZoneChange}\n              >\n                <SelectTrigger \n                  id=\"zone-select\"\n                  className=\"w-full\"\n                  data-testid=\"select-zone\"\n                >\n                  <SelectValue placeholder=\"Escolha uma zona...\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {zones.map((zone) => (\n                    <SelectItem key={zone.id} value={zone.id}>\n                      {zone.name}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            )}\n          </div>\n\n          {/* Service Selection */}\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"service-select\" className=\"text-sm font-medium text-gray-700\">\n              3. Selecione o Serviço\n            </Label>\n            {!selectedZoneId ? (\n              <div className=\"text-sm text-gray-400 p-3 text-center bg-gray-50 rounded-md\">\n                Primeiro selecione uma zona\n              </div>\n            ) : servicesLoading ? (\n              <div className=\"text-sm text-gray-500 p-3 text-center\">Carregando serviços...</div>\n            ) : services.length === 0 ? (\n              <div className=\"text-sm text-orange-600 p-3 text-center bg-orange-50 rounded-md\">\n                Nenhum serviço encontrado para esta zona\n              </div>\n            ) : (\n              <Select\n                value={selectedServiceId}\n                onValueChange={handleServiceChange}\n              >\n                <SelectTrigger \n                  id=\"service-select\"\n                  className=\"w-full\"\n                  data-testid=\"select-service\"\n                >\n                  <SelectValue placeholder=\"Escolha um serviço...\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {services.map((service) => (\n                    <SelectItem key={service.id} value={service.id}>\n                      <div className=\"flex items-center gap-2\">\n                        <Wrench className=\"w-4 h-4 text-gray-500\" />\n                        <span>{service.name}</span>\n                      </div>\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            )}\n          </div>\n        </div>\n\n        {/* Action Buttons */}\n        <div className=\"flex gap-3 pt-4 border-t\">\n          <Button\n            variant=\"outline\"\n            onClick={handleClose}\n            className=\"flex-1\"\n            data-testid=\"button-cancel-manual-selection\"\n          >\n            Cancelar\n          </Button>\n          <Button\n            onClick={handleConfirm}\n            disabled={!canConfirm}\n            className=\"flex-1 bg-navy-600 hover:bg-navy-700 text-white\"\n            data-testid=\"button-confirm-manual-selection\"\n          >\n            {canConfirm ? \"Confirmar\" : \"Selecione local e serviço\"}\n          </Button>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}","size_bytes":8545},"client/src/components/ui/toaster.tsx":{"content":"import { useToast } from \"@/hooks/use-toast\"\nimport {\n  Toast,\n  ToastClose,\n  ToastDescription,\n  ToastProvider,\n  ToastTitle,\n  ToastViewport,\n} from \"@/components/ui/toast\"\n\nexport function Toaster() {\n  const { toasts } = useToast()\n\n  return (\n    <ToastProvider>\n      {toasts.map(function ({ id, title, description, action, ...props }) {\n        return (\n          <Toast key={id} {...props}>\n            <div className=\"grid gap-1\">\n              {title && <ToastTitle>{title}</ToastTitle>}\n              {description && (\n                <ToastDescription>{description}</ToastDescription>\n              )}\n            </div>\n            {action}\n            <ToastClose />\n          </Toast>\n        )\n      })}\n      <ToastViewport />\n    </ToastProvider>\n  )\n}\n","size_bytes":772},"client/src/components/ui/hover-card.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as HoverCardPrimitive from \"@radix-ui/react-hover-card\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst HoverCard = HoverCardPrimitive.Root\n\nconst HoverCardTrigger = HoverCardPrimitive.Trigger\n\nconst HoverCardContent = React.forwardRef<\n  React.ElementRef<typeof HoverCardPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <HoverCardPrimitive.Content\n    ref={ref}\n    align={align}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-hover-card-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nHoverCardContent.displayName = HoverCardPrimitive.Content.displayName\n\nexport { HoverCard, HoverCardTrigger, HoverCardContent }\n","size_bytes":1251},"client/src/components/ui/form.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport {\n  Controller,\n  FormProvider,\n  useFormContext,\n  type ControllerProps,\n  type FieldPath,\n  type FieldValues,\n} from \"react-hook-form\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Label } from \"@/components/ui/label\"\n\nconst Form = FormProvider\n\ntype FormFieldContextValue<\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n> = {\n  name: TName\n}\n\nconst FormFieldContext = React.createContext<FormFieldContextValue>(\n  {} as FormFieldContextValue\n)\n\nconst FormField = <\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n>({\n  ...props\n}: ControllerProps<TFieldValues, TName>) => {\n  return (\n    <FormFieldContext.Provider value={{ name: props.name }}>\n      <Controller {...props} />\n    </FormFieldContext.Provider>\n  )\n}\n\nconst useFormField = () => {\n  const fieldContext = React.useContext(FormFieldContext)\n  const itemContext = React.useContext(FormItemContext)\n  const { getFieldState, formState } = useFormContext()\n\n  const fieldState = getFieldState(fieldContext.name, formState)\n\n  if (!fieldContext) {\n    throw new Error(\"useFormField should be used within <FormField>\")\n  }\n\n  const { id } = itemContext\n\n  return {\n    id,\n    name: fieldContext.name,\n    formItemId: `${id}-form-item`,\n    formDescriptionId: `${id}-form-item-description`,\n    formMessageId: `${id}-form-item-message`,\n    ...fieldState,\n  }\n}\n\ntype FormItemContextValue = {\n  id: string\n}\n\nconst FormItemContext = React.createContext<FormItemContextValue>(\n  {} as FormItemContextValue\n)\n\nconst FormItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const id = React.useId()\n\n  return (\n    <FormItemContext.Provider value={{ id }}>\n      <div ref={ref} className={cn(\"space-y-2\", className)} {...props} />\n    </FormItemContext.Provider>\n  )\n})\nFormItem.displayName = \"FormItem\"\n\nconst FormLabel = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  const { error, formItemId } = useFormField()\n\n  return (\n    <Label\n      ref={ref}\n      className={cn(error && \"text-destructive\", className)}\n      htmlFor={formItemId}\n      {...props}\n    />\n  )\n})\nFormLabel.displayName = \"FormLabel\"\n\nconst FormControl = React.forwardRef<\n  React.ElementRef<typeof Slot>,\n  React.ComponentPropsWithoutRef<typeof Slot>\n>(({ ...props }, ref) => {\n  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()\n\n  return (\n    <Slot\n      ref={ref}\n      id={formItemId}\n      aria-describedby={\n        !error\n          ? `${formDescriptionId}`\n          : `${formDescriptionId} ${formMessageId}`\n      }\n      aria-invalid={!!error}\n      {...props}\n    />\n  )\n})\nFormControl.displayName = \"FormControl\"\n\nconst FormDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => {\n  const { formDescriptionId } = useFormField()\n\n  return (\n    <p\n      ref={ref}\n      id={formDescriptionId}\n      className={cn(\"text-sm text-muted-foreground\", className)}\n      {...props}\n    />\n  )\n})\nFormDescription.displayName = \"FormDescription\"\n\nconst FormMessage = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, children, ...props }, ref) => {\n  const { error, formMessageId } = useFormField()\n  const body = error ? String(error?.message ?? \"\") : children\n\n  if (!body) {\n    return null\n  }\n\n  return (\n    <p\n      ref={ref}\n      id={formMessageId}\n      className={cn(\"text-sm font-medium text-destructive\", className)}\n      {...props}\n    >\n      {body}\n    </p>\n  )\n})\nFormMessage.displayName = \"FormMessage\"\n\nexport {\n  useFormField,\n  Form,\n  FormItem,\n  FormLabel,\n  FormControl,\n  FormDescription,\n  FormMessage,\n  FormField,\n}\n","size_bytes":4120},"client/src/components/ui/dropdown-menu.tsx":{"content":"import * as React from \"react\"\nimport * as DropdownMenuPrimitive from \"@radix-ui/react-dropdown-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst DropdownMenu = DropdownMenuPrimitive.Root\n\nconst DropdownMenuTrigger = DropdownMenuPrimitive.Trigger\n\nconst DropdownMenuGroup = DropdownMenuPrimitive.Group\n\nconst DropdownMenuPortal = DropdownMenuPrimitive.Portal\n\nconst DropdownMenuSub = DropdownMenuPrimitive.Sub\n\nconst DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup\n\nconst DropdownMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto\" />\n  </DropdownMenuPrimitive.SubTrigger>\n))\nDropdownMenuSubTrigger.displayName =\n  DropdownMenuPrimitive.SubTrigger.displayName\n\nconst DropdownMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuSubContent.displayName =\n  DropdownMenuPrimitive.SubContent.displayName\n\nconst DropdownMenuContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <DropdownMenuPrimitive.Portal>\n    <DropdownMenuPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </DropdownMenuPrimitive.Portal>\n))\nDropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName\n\nconst DropdownMenuItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName\n\nconst DropdownMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <DropdownMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.CheckboxItem>\n))\nDropdownMenuCheckboxItem.displayName =\n  DropdownMenuPrimitive.CheckboxItem.displayName\n\nconst DropdownMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.RadioItem>\n))\nDropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName\n\nconst DropdownMenuLabel = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName\n\nconst DropdownMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nDropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName\n\nconst DropdownMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\"ml-auto text-xs tracking-widest opacity-60\", className)}\n      {...props}\n    />\n  )\n}\nDropdownMenuShortcut.displayName = \"DropdownMenuShortcut\"\n\nexport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuCheckboxItem,\n  DropdownMenuRadioItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuShortcut,\n  DropdownMenuGroup,\n  DropdownMenuPortal,\n  DropdownMenuSub,\n  DropdownMenuSubContent,\n  DropdownMenuSubTrigger,\n  DropdownMenuRadioGroup,\n}\n","size_bytes":7609},"server/routes.ts":{"content":"import type { Express } from \"express\";\nimport { createServer, type Server } from \"http\";\nimport { storage } from \"./storage\";\nimport bcrypt from \"bcryptjs\";\nimport jwt from \"jsonwebtoken\";\nimport rateLimit from \"express-rate-limit\";\nimport { \n  insertCompanySchema, insertSiteSchema, insertZoneSchema, insertQrCodePointSchema,\n  insertUserSchema, insertChecklistTemplateSchema, insertSlaConfigSchema,\n  insertCleaningActivitySchema, insertWorkOrderSchema, insertBathroomCounterSchema,\n  insertWebhookConfigSchema, insertServiceSchema, insertServiceTypeSchema, insertServiceCategorySchema,\n  insertDashboardGoalSchema, insertCustomerSchema,\n  insertCustomRoleSchema, insertRolePermissionSchema, insertUserRoleAssignmentSchema,\n  insertUserSiteAssignmentSchema, insertPublicRequestLogSchema, insertSiteShiftSchema,\n  insertBathroomCounterLogSchema, insertCompanyCounterSchema,\n  insertEquipmentSchema, insertMaintenanceChecklistTemplateSchema,\n  insertMaintenanceChecklistExecutionSchema, insertMaintenancePlanSchema,\n  insertMaintenancePlanEquipmentSchema, insertMaintenanceActivitySchema,\n  type User\n} from \"@shared/schema\";\nimport { z } from \"zod\";\nimport crypto from \"crypto\";\nimport {\n  requireAuth,\n  requireAdmin,\n  requireManageClients,\n  requireManageUsers,\n  requireManageWorkOrders,\n  requireViewReports,\n  requireOwnCustomer\n} from \"./middleware/auth\";\nimport { sanitizeUser, sanitizeUsers } from \"./utils/security\";\n\nconst JWT_SECRET = process.env.JWT_SECRET || 'kJsXXrXanldoNcZJG/iHeTEI8WdMch4PFWNIao1llTU=';\n\nconst loginLimiter = rateLimit({\n  windowMs: 15 * 60 * 1000,\n  max: 10,\n  message: { message: \"Muitas tentativas de login. Tente novamente em 15 minutos.\" },\n  standardHeaders: true,\n  legacyHeaders: false,\n});\n\nexport async function registerRoutes(app: Express): Promise<Server> {\n  \n  // Companies\n  app.get(\"/api/companies\", async (req, res) => {\n    try {\n      const companies = await storage.getCompanies();\n      res.json(companies);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get companies\" });\n    }\n  });\n\n  app.get(\"/api/companies/:id\", async (req, res) => {\n    try {\n      const company = await storage.getCompany(req.params.id);\n      if (!company) {\n        return res.status(404).json({ message: \"Company not found\" });\n      }\n      res.json(company);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get company\" });\n    }\n  });\n\n  app.post(\"/api/companies\", async (req, res) => {\n    try {\n      const company = insertCompanySchema.parse(req.body);\n      const newCompany = await storage.createCompany(company);\n      res.status(201).json(newCompany);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to create company\" });\n    }\n  });\n\n  app.put(\"/api/companies/:id\", async (req, res) => {\n    try {\n      const company = insertCompanySchema.partial().parse(req.body);\n      const updatedCompany = await storage.updateCompany(req.params.id, company);\n      res.json(updatedCompany);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to update company\" });\n    }\n  });\n\n  // Sites\n  app.get(\"/api/companies/:companyId/sites\", async (req, res) => {\n    try {\n      const module = req.query.module as 'clean' | 'maintenance' | undefined;\n      const sites = await storage.getSitesByCompany(req.params.companyId, module);\n      res.json(sites);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get sites\" });\n    }\n  });\n\n  // Get sites by customer\n  app.get(\"/api/customers/:customerId/sites\", async (req, res) => {\n    try {\n      const module = req.query.module as 'clean' | 'maintenance' | undefined;\n      const sites = await storage.getSitesByCustomer(req.params.customerId, module);\n      res.json(sites);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get sites\" });\n    }\n  });\n\n  // Create site for customer (new route for customer filtering)\n  app.post(\"/api/customers/:customerId/sites\", requireManageWorkOrders, async (req, res) => {\n    try {\n      console.log(\"Creating site with data:\", req.body, \"customerId:\", req.params.customerId);\n      \n      // Get the customer to find their companyId\n      const customer = await storage.getCustomer(req.params.customerId);\n      if (!customer) {\n        return res.status(404).json({ message: \"Customer not found\" });\n      }\n      \n      const dataToValidate = {\n        ...req.body,\n        customerId: req.params.customerId,\n        companyId: customer.companyId\n      };\n      \n      console.log(\"Site data to validate:\", dataToValidate);\n      \n      const site = insertSiteSchema.parse(dataToValidate);\n      const newSite = await storage.createSite(site);\n      res.status(201).json(newSite);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        console.error(\"Validation error creating site:\", error.errors);\n        return res.status(400).json({ message: \"Dados inválidos\", errors: error.errors });\n      }\n      console.error(\"Error creating site:\", error);\n      res.status(500).json({ message: \"Erro ao criar local\" });\n    }\n  });\n\n  app.get(\"/api/sites/:id\", async (req, res) => {\n    try {\n      const site = await storage.getSite(req.params.id);\n      if (!site) {\n        return res.status(404).json({ message: \"Site not found\" });\n      }\n      res.json(site);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get site\" });\n    }\n  });\n\n  app.post(\"/api/sites\", async (req, res) => {\n    try {\n      const site = insertSiteSchema.parse({\n        ...req.body,\n        module: req.body.module || 'clean'\n      });\n      const newSite = await storage.createSite(site);\n      res.status(201).json(newSite);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to create site\" });\n    }\n  });\n\n  app.put(\"/api/sites/:id\", async (req, res) => {\n    try {\n      const site = insertSiteSchema.partial().parse(req.body);\n      const updatedSite = await storage.updateSite(req.params.id, site);\n      res.json(updatedSite);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to update site\" });\n    }\n  });\n\n  app.delete(\"/api/sites/:id\", async (req, res) => {\n    try {\n      await storage.deleteSite(req.params.id);\n      res.json({ message: \"Site excluído com sucesso\" });\n    } catch (error) {\n      console.error(\"Erro ao excluir site:\", error);\n      res.status(500).json({ \n        message: error instanceof Error ? error.message : \"Falha ao excluir site\" \n      });\n    }\n  });\n\n  // Zones\n  app.get(\"/api/companies/:companyId/zones\", async (req, res) => {\n    try {\n      const module = req.query.module as 'clean' | 'maintenance' | undefined;\n      const zones = await storage.getZonesByCompany(req.params.companyId, module);\n      res.json(zones);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get zones\" });\n    }\n  });\n\n  // QR Code Points by Company\n  app.get(\"/api/companies/:companyId/qr-points\", async (req, res) => {\n    try {\n      const module = req.query.module as 'clean' | 'maintenance' | undefined;\n      const qrPoints = await storage.getQrCodePointsByCompany(req.params.companyId, module);\n      res.json(qrPoints);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get QR code points\" });\n    }\n  });\n\n  // QR Points by Customer (filtrado por cliente)\n  app.get(\"/api/customers/:customerId/qr-points\", async (req, res) => {\n    try {\n      const module = req.query.module as 'clean' | 'maintenance' | undefined;\n      const qrPoints = await storage.getQrCodePointsByCustomer(req.params.customerId, module);\n      res.json(qrPoints);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get customer QR code points\" });\n    }\n  });\n\n  // Zones by Customer (filtrado por cliente)\n  app.get(\"/api/customers/:customerId/zones\", async (req, res) => {\n    try {\n      const module = req.query.module as 'clean' | 'maintenance' | undefined;\n      const zones = await storage.getZonesByCustomer(req.params.customerId, module);\n      res.json(zones);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get customer zones\" });\n    }\n  });\n\n  // Cleaning Activities by Customer (filtrado por cliente)\n  app.get(\"/api/customers/:customerId/cleaning-activities\", async (req, res) => {\n    try {\n      const module = req.query.module as 'clean' | 'maintenance' | undefined;\n      const activities = await storage.getCleaningActivitiesByCustomer(req.params.customerId, module);\n      res.json(activities);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get customer cleaning activities\" });\n    }\n  });\n\n  // Services by Customer (filtrado por cliente)\n  app.get(\"/api/customers/:customerId/services\", async (req, res) => {\n    try {\n      const module = req.query.module as 'clean' | 'maintenance' | undefined;\n      const services = await storage.getServicesByCustomer(req.params.customerId, module);\n      res.json(services);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get customer services\" });\n    }\n  });\n\n  // Users by Customer (filtrado por cliente)\n  app.get(\"/api/customers/:customerId/users\", async (req, res) => {\n    try {\n      const users = await storage.getUsersByCustomer(req.params.customerId);\n      \n      // Para cada usuário, buscar seus roles customizados e remover senha\n      const usersWithRoles = await Promise.all(\n        users.map(async (user) => {\n          const roleAssignments = await storage.getUserRoleAssignments(user.id);\n          const sanitized = sanitizeUser(user);\n          return {\n            ...sanitized,\n            customRoles: roleAssignments\n          };\n        })\n      );\n      \n      res.json(usersWithRoles);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get customer users\" });\n    }\n  });\n\n  // Checklist Templates by Customer (filtrado por cliente)  \n  app.get(\"/api/customers/:customerId/checklist-templates\", async (req, res) => {\n    try {\n      const module = req.query.module as 'clean' | 'maintenance' | undefined;\n      const templates = await storage.getChecklistTemplatesByCustomer(req.params.customerId, module);\n      res.json(templates);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get customer checklist templates\" });\n    }\n  });\n\n  app.post(\"/api/customers/:customerId/checklist-templates\", async (req, res) => {\n    try {\n      // Validate that the checklist belongs to the customer\n      const customerSites = await storage.getSitesByCustomer(req.params.customerId);\n      if (customerSites.length === 0) {\n        return res.status(404).json({ message: \"Customer not found\" });\n      }\n      \n      // Use the first site's company for the checklist template\n      const companyId = customerSites[0].companyId;\n      const checklistData = { ...req.body, companyId };\n      \n      console.log(\"[CHECKLIST CREATE] Data:\", JSON.stringify(checklistData, null, 2));\n      \n      const template = await storage.createChecklistTemplate(checklistData);\n      res.json(template);\n    } catch (error: any) {\n      console.error(\"Error creating checklist template:\", error?.message || error);\n      console.error(\"Stack:\", error?.stack);\n      res.status(500).json({ message: error?.message || \"Failed to create customer checklist template\" });\n    }\n  });\n\n  app.put(\"/api/customers/:customerId/checklist-templates/:id\", async (req, res) => {\n    try {\n      // Validate that the customer exists and get their company\n      const customerSites = await storage.getSitesByCustomer(req.params.customerId);\n      if (customerSites.length === 0) {\n        return res.status(404).json({ message: \"Customer not found\" });\n      }\n\n      const companyId = customerSites[0].companyId;\n      \n      // Verify the template belongs to this customer's company\n      const existingTemplate = await storage.getChecklistTemplate(req.params.id);\n      if (!existingTemplate || existingTemplate.companyId !== companyId) {\n        return res.status(403).json({ message: \"Checklist template not found or access denied\" });\n      }\n\n      const checklistData = { ...req.body, companyId };\n      const template = await storage.updateChecklistTemplate(req.params.id, checklistData);\n      res.json(template);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to update customer checklist template\" });\n    }\n  });\n\n  app.delete(\"/api/customers/:customerId/checklist-templates/:id\", async (req, res) => {\n    try {\n      // Validate that the customer exists and get their company\n      const customerSites = await storage.getSitesByCustomer(req.params.customerId);\n      if (customerSites.length === 0) {\n        return res.status(404).json({ message: \"Customer not found\" });\n      }\n\n      const companyId = customerSites[0].companyId;\n      \n      // Verify the template belongs to this customer's company\n      const existingTemplate = await storage.getChecklistTemplate(req.params.id);\n      if (!existingTemplate || existingTemplate.companyId !== companyId) {\n        return res.status(403).json({ message: \"Checklist template not found or access denied\" });\n      }\n\n      // Check if checklist is being used by work orders\n      const workOrdersUsingChecklist = await storage.getWorkOrdersByChecklistTemplate(req.params.id);\n      if (workOrdersUsingChecklist.length > 0) {\n        return res.status(409).json({ \n          message: \"Checklist não pode ser excluído pois está sendo usado por ordens de serviço\",\n          workOrdersCount: workOrdersUsingChecklist.length\n        });\n      }\n\n      await storage.deleteChecklistTemplate(req.params.id);\n      res.json({ success: true });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to delete customer checklist template\" });\n    }\n  });\n\n  // Work Orders by Customer - List (filtrado por cliente)\n  app.get(\"/api/customers/:customerId/work-orders\", async (req, res) => {\n    try {\n      // Validate that the customer exists\n      const customerSites = await storage.getSitesByCustomer(req.params.customerId);\n      if (customerSites.length === 0) {\n        return res.status(404).json({ message: \"Customer not found\" });\n      }\n\n      // Get all work orders for this customer\n      const module = req.query.module as 'clean' | 'maintenance' | undefined;\n      let workOrders = await storage.getWorkOrdersByCustomer(req.params.customerId, module);\n      \n      // Apply filters from query params\n      const { zoneId, assignedTo, status, serviceId } = req.query;\n      \n      // Filter by zone if provided\n      if (zoneId) {\n        workOrders = workOrders.filter(wo => wo.zoneId === zoneId);\n      }\n      \n      // Filter by assignedTo if provided (include unassigned work orders too)\n      if (assignedTo) {\n        workOrders = workOrders.filter(wo => wo.assignedUserId === assignedTo || wo.assignedUserId === null);\n      }\n      \n      // Filter by status if provided\n      if (status) {\n        workOrders = workOrders.filter(wo => wo.status === status);\n      }\n      \n      // Filter by serviceId if provided\n      if (serviceId) {\n        workOrders = workOrders.filter(wo => wo.serviceId === serviceId);\n      }\n      \n      res.json(workOrders);\n    } catch (error) {\n      console.error(\"Error fetching customer work orders:\", error);\n      res.status(500).json({ message: \"Failed to fetch customer work orders\" });\n    }\n  });\n\n  // Dashboard stats by Customer\n  app.get(\"/api/customers/:customerId/dashboard-stats/:period/:siteId\", async (req, res) => {\n    try {\n      const { customerId, period, siteId } = req.params;\n      const module = req.query.module as 'clean' | 'maintenance' | undefined;\n      \n      // Verify customer exists\n      const customer = await storage.getCustomer(customerId);\n      if (!customer) {\n        return res.status(404).json({ message: \"Customer not found\" });\n      }\n      \n      // Get stats filtered by customer's sites (pode ser vazio se não houver sites)\n      const stats = await storage.getDashboardStatsByCustomer(customerId, period, siteId === 'todos' ? '' : siteId, module);\n      res.json(stats);\n    } catch (error) {\n      console.error(\"Error fetching customer dashboard stats:\", error);\n      res.status(500).json({ message: \"Failed to get dashboard stats\" });\n    }\n  });\n\n  // Analytics by Customer\n  app.get(\"/api/customers/:customerId/analytics/:period/:siteId\", async (req, res) => {\n    try {\n      const { customerId, period, siteId } = req.params;\n      const module = req.query.module as 'clean' | 'maintenance' | undefined;\n      \n      // Verify customer exists\n      const customer = await storage.getCustomer(customerId);\n      if (!customer) {\n        return res.status(404).json({ message: \"Customer not found\" });\n      }\n      \n      // Get analytics filtered by customer (pode ser vazio se não houver sites/work orders)\n      const analytics = await storage.getAnalyticsByCustomer(customerId, period, siteId === 'todos' ? '' : siteId, module);\n      res.json(analytics);\n    } catch (error) {\n      console.error(\"Error fetching customer analytics:\", error);\n      res.status(500).json({ message: \"Failed to get performance analytics\" });\n    }\n  });\n\n  // Work Orders by Customer - Create (filtrado por cliente)\n  app.post(\"/api/customers/:customerId/work-orders\", async (req, res) => {\n    try {\n      // Validate that the customer exists\n      const customerSites = await storage.getSitesByCustomer(req.params.customerId);\n      if (customerSites.length === 0) {\n        return res.status(404).json({ message: \"Customer not found\" });\n      }\n      \n      // Validate that site belongs to customer\n      if (req.body.siteId) {\n        const site = await storage.getSite(req.body.siteId);\n        if (!site || site.customerId !== req.params.customerId) {\n          return res.status(403).json({ message: \"Site does not belong to customer\" });\n        }\n      }\n\n      // Validate that zone belongs to customer (via site)\n      if (req.body.zoneId) {\n        const zone = await storage.getZone(req.body.zoneId);\n        if (zone) {\n          const zoneSite = await storage.getSite(zone.siteId);\n          if (!zoneSite || zoneSite.customerId !== req.params.customerId) {\n            return res.status(403).json({ message: \"Zone does not belong to customer\" });\n          }\n        }\n      }\n      \n      const workOrder = await storage.createWorkOrder(req.body);\n      res.json(workOrder);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to create customer work order\" });\n    }\n  });\n\n  // Work Orders by Customer - Delete (filtrado por cliente)\n  app.delete(\"/api/customers/:customerId/work-orders/:id\", async (req, res) => {\n    try {\n      // Validate that the customer exists\n      const customerSites = await storage.getSitesByCustomer(req.params.customerId);\n      if (customerSites.length === 0) {\n        return res.status(404).json({ message: \"Customer not found\" });\n      }\n\n      // Verify the work order belongs to this customer by checking its site\n      const workOrder = await storage.getWorkOrder(req.params.id);\n      if (!workOrder) {\n        return res.status(404).json({ message: \"Work order not found\" });\n      }\n\n      // Get zone first, then site\n      if (!workOrder.zoneId) {\n        return res.status(400).json({ message: \"Work order has no zone\" });\n      }\n      const zone = await storage.getZone(workOrder.zoneId);\n      if (!zone) {\n        return res.status(404).json({ message: \"Zone not found\" });\n      }\n      const workOrderSite = await storage.getSite(zone.siteId);\n      if (!workOrderSite || workOrderSite.customerId !== req.params.customerId) {\n        return res.status(403).json({ message: \"Work order not found or access denied\" });\n      }\n\n      await storage.deleteWorkOrder(req.params.id);\n      res.json({ success: true });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to delete customer work order\" });\n    }\n  });\n\n  // QR Points by Customer - Create (filtrado por cliente)\n  app.post(\"/api/customers/:customerId/qr-points\", async (req, res) => {\n    try {\n      // Validate that the customer exists\n      const customerSites = await storage.getSitesByCustomer(req.params.customerId);\n      if (customerSites.length === 0) {\n        return res.status(404).json({ message: \"Customer not found\" });\n      }\n      \n      // Validate that zone belongs to customer\n      if (req.body.zoneId) {\n        const zone = await storage.getZone(req.body.zoneId);\n        if (zone) {\n          const zoneSite = await storage.getSite(zone.siteId);\n          if (!zoneSite || zoneSite.customerId !== req.params.customerId) {\n            return res.status(403).json({ message: \"Zone does not belong to customer\" });\n          }\n        }\n      }\n      \n      // Parse and validate the request body\n      const qrPointData = insertQrCodePointSchema.parse(req.body);\n      const qrPoint = await storage.createQrCodePoint(qrPointData);\n      res.json(qrPoint);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to create customer QR point\" });\n    }\n  });\n\n\n  // Reports by Customer (filtrado por cliente)\n  app.get(\"/api/customers/:customerId/reports/metrics\", async (req, res) => {\n    try {\n      const period = req.query.period as string || \"30\";\n      const analytics = await storage.getAnalyticsByCustomer(req.params.customerId, period, \"todos\");\n      res.json(analytics);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get customer metrics\" });\n    }\n  });\n\n  app.get(\"/api/customers/:customerId/reports/work-orders-status\", async (req, res) => {\n    try {\n      const period = req.query.period as string || \"30\";\n      const analytics = await storage.getAnalyticsByCustomer(req.params.customerId, period, \"todos\");\n      res.json(analytics?.workOrdersStatus || []);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get customer work orders status\" });\n    }\n  });\n\n  app.get(\"/api/customers/:customerId/reports/sla-performance\", async (req, res) => {\n    try {\n      const period = req.query.period as string || \"30\";\n      const analytics = await storage.getAnalyticsByCustomer(req.params.customerId, period, \"todos\");\n      res.json(analytics?.slaPerformance || {});\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get customer SLA performance\" });\n    }\n  });\n\n  // NOVOS ENDPOINTS ESPECÍFICOS PARA CADA TIPO DE RELATÓRIO\n\n  // 1. Relatório Geral - Visão completa das operações com todos os KPIs principais  \n  app.get(\"/api/customers/:customerId/reports/general\", async (req, res) => {\n    try {\n      const { customerId } = req.params;\n      const period = req.query.period as string || '30';\n      const generalReport = await storage.getGeneralReport(customerId, period);\n      res.json(generalReport);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get general report\" });\n    }\n  });\n\n  // 2. Análise de SLA - Performance detalhada de cumprimento de prazos\n  app.get(\"/api/customers/:customerId/reports/sla-analysis\", async (req, res) => {\n    try {\n      const { customerId } = req.params;\n      const period = req.query.period as string || '30';\n      const slaAnalysis = await storage.getSLAAnalysis(customerId, period);\n      res.json(slaAnalysis);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get SLA analysis\" });\n    }\n  });\n\n  // 3. Produtividade - Métricas de eficiência e produtividade operacional\n  app.get(\"/api/customers/:customerId/reports/productivity\", async (req, res) => {\n    try {\n      const { customerId } = req.params;\n      const period = req.query.period as string || '30';\n      const module = req.query.module as 'clean' | 'maintenance' | undefined;\n      const productivityReport = await storage.getProductivityReport(customerId, period, module);\n      res.json(productivityReport);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get productivity report\" });\n    }\n  });\n\n  // 4. Performance de Operadores - Análise individual e comparativa\n  app.get(\"/api/customers/:customerId/reports/operators\", async (req, res) => {\n    try {\n      const { customerId } = req.params;\n      const period = req.query.period as string || '30';\n      const operatorPerformance = await storage.getOperatorPerformance(customerId, period);\n      res.json(operatorPerformance);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get operator performance\" });\n    }\n  });\n\n  // 5. Análise por Locais - Distribuição e performance por zona e site\n  app.get(\"/api/customers/:customerId/reports/locations\", async (req, res) => {\n    try {\n      const { customerId } = req.params;\n      const period = req.query.period as string || '30';\n      const locationAnalysis = await storage.getLocationAnalysis(customerId, period);\n      res.json(locationAnalysis);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get location analysis\" });\n    }\n  });\n\n  // 6. Análise Temporal - Tendências e padrões ao longo do tempo\n  app.get(\"/api/customers/:customerId/reports/temporal\", async (req, res) => {\n    try {\n      const { customerId } = req.params;\n      const period = req.query.period as string || '30';\n      const temporalAnalysis = await storage.getTemporalAnalysis(customerId, period);\n      res.json(temporalAnalysis);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get temporal analysis\" });\n    }\n  });\n\n  app.get(\"/api/sites/:siteId/zones\", async (req, res) => {\n    try {\n      const module = req.query.module as 'clean' | 'maintenance' | undefined;\n      const zones = await storage.getZonesBySite(req.params.siteId, module);\n      res.json(zones);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get zones\" });\n    }\n  });\n\n  // Get zones by multiple sites\n  app.get(\"/api/zones\", async (req, res) => {\n    try {\n      const { siteIds } = req.query;\n      if (!siteIds) {\n        return res.status(400).json({ message: \"siteIds parameter is required\" });\n      }\n      \n      const siteIdArray = typeof siteIds === 'string' ? siteIds.split(',') : [];\n      const allZones = [];\n      \n      for (const siteId of siteIdArray) {\n        const zones = await storage.getZonesBySite(siteId.trim());\n        allZones.push(...zones);\n      }\n      \n      res.json(allZones);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get zones\" });\n    }\n  });\n\n  app.get(\"/api/zones/:id\", async (req, res) => {\n    try {\n      const zone = await storage.getZone(req.params.id);\n      if (!zone) {\n        return res.status(404).json({ message: \"Zone not found\" });\n      }\n      res.json(zone);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get zone\" });\n    }\n  });\n\n  app.post(\"/api/zones\", async (req, res) => {\n    try {\n      const zone = insertZoneSchema.parse({\n        ...req.body,\n        module: req.body.module || 'clean'\n      });\n      const newZone = await storage.createZone(zone);\n      res.status(201).json(newZone);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to create zone\" });\n    }\n  });\n\n  app.put(\"/api/zones/:id\", async (req, res) => {\n    try {\n      const zone = insertZoneSchema.partial().parse(req.body);\n      const updatedZone = await storage.updateZone(req.params.id, zone);\n      res.json(updatedZone);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to update zone\" });\n    }\n  });\n\n  app.patch(\"/api/zones/:id\", async (req, res) => {\n    try {\n      const zone = insertZoneSchema.partial().parse(req.body);\n      const updatedZone = await storage.updateZone(req.params.id, zone);\n      res.json(updatedZone);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to update zone\" });\n    }\n  });\n\n  app.delete(\"/api/zones/:id\", async (req, res) => {\n    try {\n      await storage.deleteZone(req.params.id);\n      res.json({ message: \"Zone deleted successfully\" });\n    } catch (error) {\n      console.error(\"Error deleting zone:\", error);\n      res.status(500).json({ message: \"Failed to delete zone\" });\n    }\n  });\n\n  // QR Code Points\n  app.get(\"/api/zones/:zoneId/qr-points\", async (req, res) => {\n    try {\n      const points = await storage.getQrCodePointsByZone(req.params.zoneId);\n      res.json(points);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get QR code points\" });\n    }\n  });\n\n  // List all QR points (debug endpoint)  \n  app.get(\"/api/qr-points\", async (req, res) => {\n    try {\n      // Lista todos os QR points da empresa padrão\n      const points = await storage.getQrCodePointsByCompany(\"company-opus-default\");\n      res.json(points || []);\n    } catch (error) {\n      console.error(\"Error getting QR points:\", error);\n      res.status(500).json({ message: \"Failed to get QR points\" });\n    }\n  });\n\n  app.get(\"/api/qr-points/:id\", async (req, res) => {\n    try {\n      const point = await storage.getQrCodePoint(req.params.id);\n      if (!point) {\n        return res.status(404).json({ message: \"QR code point not found\" });\n      }\n      res.json(point);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get QR code point\" });\n    }\n  });\n\n  app.get(\"/api/qr-points/code/:code\", async (req, res) => {\n    try {\n      const point = await storage.getQrCodePointByCode(req.params.code);\n      if (!point) {\n        return res.status(404).json({ message: \"QR code point not found\" });\n      }\n      res.json(point);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get QR code point\" });\n    }\n  });\n\n  // QR Code Resolution - Returns all context in one call\n  app.get(\"/api/qr-scan/resolve\", async (req, res) => {\n    try {\n      const code = req.query.code as string;\n      \n      if (!code) {\n        return res.status(400).json({ message: \"QR code parameter is required\" });\n      }\n\n      const resolved = await storage.resolveQrCode(code);\n      \n      if (!resolved) {\n        return res.status(404).json({ message: \"QR code not found or inactive\" });\n      }\n\n      // Disable caching for dynamic QR resolution\n      res.set({\n        'Cache-Control': 'no-store, no-cache, must-revalidate, max-age=0',\n        'Pragma': 'no-cache',\n        'Expires': '0'\n      });\n      \n      res.json(resolved);\n    } catch (error) {\n      console.error(\"Error resolving QR code:\", error);\n      res.status(500).json({ message: \"Failed to resolve QR code\" });\n    }\n  });\n\n  // QR Code Resolution - NEW correct endpoint format\n  app.get(\"/api/qrs/:code/resolve\", async (req, res) => {\n    try {\n      const code = req.params.code;\n      \n      if (!code) {\n        return res.status(400).json({ message: \"QR code parameter is required\" });\n      }\n\n      const resolved = await storage.resolveQrCode(code);\n      \n      if (!resolved) {\n        return res.status(404).json({ message: \"QR code not found or inactive\" });\n      }\n\n      res.json(resolved);\n    } catch (error) {\n      console.error(\"Error resolving QR code:\", error);\n      res.status(500).json({ message: \"Failed to resolve QR code\" });\n    }\n  });\n\n  app.post(\"/api/qr-points\", async (req, res) => {\n    try {\n      const qrPoint = insertQrCodePointSchema.parse({\n        ...req.body,\n        module: req.body.module || 'clean'\n      });\n      // Generate unique code if not provided\n      if (!qrPoint.code) {\n        qrPoint.code = crypto.randomUUID();\n      }\n      const newPoint = await storage.createQrCodePoint(qrPoint);\n      res.status(201).json(newPoint);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to create QR code point\" });\n    }\n  });\n\n  app.put(\"/api/qr-points/:id\", async (req, res) => {\n    try {\n      const qrPoint = insertQrCodePointSchema.partial().parse(req.body);\n      const updatedPoint = await storage.updateQrCodePoint(req.params.id, qrPoint);\n      res.json(updatedPoint);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to update QR code point\" });\n    }\n  });\n\n  app.delete(\"/api/qr-points/:id\", async (req, res) => {\n    try {\n      await storage.deleteQrCodePoint(req.params.id);\n      res.json({ message: \"QR code point deleted successfully\" });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to delete QR code point\" });\n    }\n  });\n\n  // Users - PROTEGIDO: Apenas admin e gestor_cliente podem gerenciar usuários\n  app.get(\"/api/users\", requireManageUsers, async (req, res) => {\n    try {\n      const users = await storage.getUsers();\n      res.json(sanitizeUsers(users));\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get users\" });\n    }\n  });\n\n  app.get(\"/api/companies/:companyId/users\", requireManageUsers, async (req, res) => {\n    try {\n      const users = await storage.getUsersByCompany(req.params.companyId);\n      res.json(sanitizeUsers(users));\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get users\" });\n    }\n  });\n\n  app.get(\"/api/users/:id\", requireAuth, async (req, res) => {\n    try {\n      const user = await storage.getUser(req.params.id);\n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n      res.json(sanitizeUser(user));\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get user\" });\n    }\n  });\n\n  app.post(\"/api/users\", requireManageUsers, async (req, res) => {\n    try {\n      const { role: customRoleId, ...userData } = req.body;\n      \n      // Validar dados do usuário (sem o role que vem como customRoleId)\n      const validatedData = insertUserSchema.omit({ role: true }).parse(userData);\n      \n      // VALIDAÇÃO DE MÓDULOS: Verificar se os módulos solicitados são compatíveis com o cliente\n      if (validatedData.userType === 'customer_user' && validatedData.customerId) {\n        const customer = await storage.getCustomer(validatedData.customerId);\n        \n        if (!customer) {\n          return res.status(400).json({\n            message: \"Cliente não encontrado\",\n            details: \"O cliente selecionado não existe no sistema.\"\n          });\n        }\n        \n        const customerModules = customer.modules || ['clean'];\n        const requestedModules = validatedData.modules || ['clean'];\n        \n        // Verificar se todos os módulos solicitados estão disponíveis no cliente\n        const invalidModules = requestedModules.filter(m => !customerModules.includes(m));\n        \n        if (invalidModules.length > 0) {\n          return res.status(400).json({\n            message: \"Módulos incompatíveis\",\n            details: `Os módulos ${invalidModules.join(', ')} não estão disponíveis para o cliente \"${customer.name}\". Módulos disponíveis: ${customerModules.join(', ')}`\n          });\n        }\n      }\n      \n      // Generate unique user ID\n      const userId = `user-${validatedData.username}-${Date.now()}`;\n      \n      // Hash password if provided (for local auth users)\n      if (validatedData.password && validatedData.authProvider === 'local') {\n        validatedData.password = await bcrypt.hash(validatedData.password, 12);\n      }\n      \n      // Criar usuário com role padrão \"operador\" (será sobrescrito pelas permissões do custom role)\n      const newUser = await storage.createUser({\n        ...validatedData,\n        id: userId,\n        role: 'operador', // Role padrão, as permissões virão do custom role\n      } as any);\n\n      // Se foi enviado um customRoleId, criar userRoleAssignment via storage\n      if (customRoleId && customRoleId.startsWith('role-')) {\n        await storage.createUserRoleAssignment({\n          id: `ura-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\n          userId: newUser.id,\n          roleId: customRoleId,\n          customerId: validatedData.customerId || null,\n        });\n      }\n      \n      res.status(201).json(sanitizeUser(newUser));\n    } catch (error: any) {\n      // Tratamento de erros do Zod (validação)\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ \n          message: \"Dados inválidos\",\n          details: error.errors.map(e => `${e.path.join('.')}: ${e.message}`).join(', '),\n          errors: error.errors \n        });\n      }\n      \n      // Tratamento de erros do PostgreSQL\n      if (error.code === '23505') {\n        // Unique constraint violation\n        if (error.constraint === 'users_email_unique') {\n          return res.status(400).json({ \n            message: \"Email já cadastrado\",\n            details: `O email \"${error.detail?.match(/\\(([^)]+)\\)/)?.[1] || 'informado'}\" já está sendo usado por outro usuário. Por favor, use um email diferente.`\n          });\n        }\n        if (error.constraint === 'users_username_unique') {\n          return res.status(400).json({ \n            message: \"Nome de usuário já existe\",\n            details: `O nome de usuário \"${error.detail?.match(/\\(([^)]+)\\)/)?.[1] || 'informado'}\" já está em uso. Por favor, escolha outro nome de usuário.`\n          });\n        }\n        // Outras violações de unique constraint\n        return res.status(400).json({ \n          message: \"Valor duplicado\",\n          details: \"Um campo único já possui esse valor no sistema. Verifique os dados e tente novamente.\"\n        });\n      }\n      \n      if (error.code === '23503') {\n        // Foreign key violation\n        return res.status(400).json({ \n          message: \"Referência inválida\",\n          details: \"Um dos campos referencia um registro que não existe. Verifique cliente, empresa ou outros relacionamentos.\"\n        });\n      }\n      \n      if (error.code === '23502') {\n        // Not null violation\n        return res.status(400).json({ \n          message: \"Campo obrigatório faltando\",\n          details: `O campo \"${error.column || 'desconhecido'}\" é obrigatório e não pode ser vazio.`\n        });\n      }\n      \n      // Erro genérico\n      console.error(\"Error creating user:\", error);\n      res.status(500).json({ \n        message: \"Erro ao criar usuário\",\n        details: process.env.NODE_ENV === 'development' ? error.message : \"Ocorreu um erro inesperado. Tente novamente ou contate o suporte.\"\n      });\n    }\n  });\n\n  app.put(\"/api/users/:id\", requireManageUsers, async (req, res) => {\n    try {\n      const user = insertUserSchema.partial().parse(req.body);\n      \n      // VALIDAÇÃO DE MÓDULOS: Verificar se os módulos solicitados são compatíveis com o cliente\n      if (user.modules && user.customerId) {\n        const existingUser = await storage.getUser(req.params.id);\n        \n        if (existingUser && existingUser.userType === 'customer_user') {\n          const customer = await storage.getCustomer(user.customerId);\n          \n          if (!customer) {\n            return res.status(400).json({\n              message: \"Cliente não encontrado\",\n              details: \"O cliente selecionado não existe no sistema.\"\n            });\n          }\n          \n          const customerModules = customer.modules || ['clean'];\n          const requestedModules = user.modules;\n          \n          // Verificar se todos os módulos solicitados estão disponíveis no cliente\n          const invalidModules = requestedModules.filter(m => !customerModules.includes(m));\n          \n          if (invalidModules.length > 0) {\n            return res.status(400).json({\n              message: \"Módulos incompatíveis\",\n              details: `Os módulos ${invalidModules.join(', ')} não estão disponíveis para o cliente \"${customer.name}\". Módulos disponíveis: ${customerModules.join(', ')}`\n            });\n          }\n        }\n      }\n      \n      const updatedUser = await storage.updateUser(req.params.id, user);\n      res.json(sanitizeUser(updatedUser));\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to update user\" });\n    }\n  });\n\n  app.patch(\"/api/users/:id\", requireManageUsers, async (req, res) => {\n    try {\n      const user = insertUserSchema.partial().parse(req.body);\n      \n      // VALIDAÇÃO DE MÓDULOS: Verificar se os módulos solicitados são compatíveis com o cliente\n      if (user.modules && user.customerId) {\n        const existingUser = await storage.getUser(req.params.id);\n        \n        if (existingUser && existingUser.userType === 'customer_user') {\n          const customer = await storage.getCustomer(user.customerId);\n          \n          if (!customer) {\n            return res.status(400).json({\n              message: \"Cliente não encontrado\",\n              details: \"O cliente selecionado não existe no sistema.\"\n            });\n          }\n          \n          const customerModules = customer.modules || ['clean'];\n          const requestedModules = user.modules;\n          \n          // Verificar se todos os módulos solicitados estão disponíveis no cliente\n          const invalidModules = requestedModules.filter(m => !customerModules.includes(m));\n          \n          if (invalidModules.length > 0) {\n            return res.status(400).json({\n              message: \"Módulos incompatíveis\",\n              details: `Os módulos ${invalidModules.join(', ')} não estão disponíveis para o cliente \"${customer.name}\". Módulos disponíveis: ${customerModules.join(', ')}`\n            });\n          }\n        }\n      }\n      \n      const updatedUser = await storage.updateUser(req.params.id, user);\n      res.json(sanitizeUser(updatedUser));\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to update user\" });\n    }\n  });\n\n  app.delete(\"/api/users/:id\", requireManageUsers, async (req, res) => {\n    try {\n      await storage.deleteUser(req.params.id);\n      res.json({ message: \"User deleted successfully\" });\n    } catch (error) {\n      console.error(\"Error deleting user:\", error);\n      res.status(500).json({ message: \"Failed to delete user\" });\n    }\n  });\n\n  // Services\n  app.get(\"/api/customers/:customerId/services\", async (req, res) => {\n    try {\n      const module = req.query.module as 'clean' | 'maintenance' | undefined;\n      const services = await storage.getServicesByCustomer(req.params.customerId, module);\n      res.json(services);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get services\" });\n    }\n  });\n\n  app.get(\"/api/services/:id\", async (req, res) => {\n    try {\n      const service = await storage.getService(req.params.id);\n      if (!service) {\n        return res.status(404).json({ message: \"Service not found\" });\n      }\n      res.json(service);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get service\" });\n    }\n  });\n\n  app.post(\"/api/services\", async (req, res) => {\n    try {\n      const dataWithModule = {\n        ...req.body,\n        module: req.body.module || 'clean'\n      };\n      console.log(\"Creating service with data:\", dataWithModule);\n      const service = insertServiceSchema.parse(dataWithModule);\n      console.log(\"Validated service:\", service);\n      const newService = await storage.createService(service);\n      res.status(201).json(newService);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        console.error(\"Service validation error:\", error.errors);\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      console.error(\"Error creating service:\", error);\n      res.status(500).json({ message: \"Failed to create service\" });\n    }\n  });\n\n  app.put(\"/api/services/:id\", async (req, res) => {\n    try {\n      const service = insertServiceSchema.partial().parse(req.body);\n      const updatedService = await storage.updateService(req.params.id, service);\n      res.json(updatedService);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to update service\" });\n    }\n  });\n\n  app.delete(\"/api/services/:id\", async (req, res) => {\n    try {\n      await storage.deleteService(req.params.id);\n      res.json({ message: \"Service deleted successfully\" });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to delete service\" });\n    }\n  });\n\n  // Checklist Templates\n  app.get(\"/api/companies/:companyId/checklist-templates\", async (req, res) => {\n    try {\n      const module = req.query.module as 'clean' | 'maintenance' | undefined;\n      const templates = await storage.getChecklistTemplatesByCompany(req.params.companyId, module);\n      res.json(templates);\n    } catch (error) {\n      console.error(\"Error getting checklist templates:\", error);\n      res.status(500).json({ message: \"Failed to get checklist templates\" });\n    }\n  });\n\n  // Create checklist template\n  app.post(\"/api/companies/:companyId/checklist-templates\", async (req, res) => {\n    try {\n      const template = insertChecklistTemplateSchema.parse({\n        ...req.body,\n        companyId: req.params.companyId\n      });\n      const newTemplate = await storage.createChecklistTemplate(template);\n      res.status(201).json(newTemplate);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      console.error(\"Error creating checklist template:\", error);\n      res.status(500).json({ message: \"Failed to create checklist template\" });\n    }\n  });\n\n  // Update checklist template\n  app.put(\"/api/companies/:companyId/checklist-templates/:id\", async (req, res) => {\n    try {\n      const template = insertChecklistTemplateSchema.partial().parse(req.body);\n      const updatedTemplate = await storage.updateChecklistTemplate(req.params.id, template);\n      res.json(updatedTemplate);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      console.error(\"Error updating checklist template:\", error);\n      res.status(500).json({ message: \"Failed to update checklist template\" });\n    }\n  });\n\n  // Delete checklist template\n  app.delete(\"/api/companies/:companyId/checklist-templates/:id\", async (req, res) => {\n    try {\n      await storage.deleteChecklistTemplate(req.params.id);\n      res.json({ message: \"Checklist template deleted successfully\" });\n    } catch (error) {\n      console.error(\"Error deleting checklist template:\", error);\n      res.status(500).json({ message: \"Failed to delete checklist template\" });\n    }\n  });\n\n  // Get checklist template for a specific service\n  app.get(\"/api/services/:serviceId/checklist\", async (req, res) => {\n    try {\n      const checklist = await storage.getChecklistTemplateByServiceId(req.params.serviceId);\n      if (!checklist) {\n        return res.status(404).json({ message: \"No checklist found for this service\" });\n      }\n      res.json(checklist);\n    } catch (error) {\n      console.error(\"Error getting checklist for service:\", error);\n      res.status(500).json({ message: \"Failed to get service checklist\" });\n    }\n  });\n\n  // Services by Zone\n  app.get(\"/api/customers/:customerId/zones/:zoneId/services\", async (req, res) => {\n    try {\n      const services = await storage.getServicesByZone(req.params.customerId, req.params.zoneId);\n      res.json(services);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get services for zone\" });\n    }\n  });\n\n  // Service Types\n  app.get(\"/api/customers/:customerId/service-types\", async (req, res) => {\n    try {\n      const module = req.query.module as 'clean' | 'maintenance' | undefined;\n      const serviceTypes = await storage.getServiceTypesByCustomer(req.params.customerId, module);\n      res.json(serviceTypes);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get service types\" });\n    }\n  });\n\n  app.post(\"/api/customers/:customerId/service-types\", async (req, res) => {\n    try {\n      console.log(\"Creating service type with data:\", req.body, \"customerId:\", req.params.customerId);\n      \n      // Generate code from name if not provided\n      const code = req.body.code || req.body.name.toUpperCase().replace(/\\s+/g, '_').replace(/[^A-Z0-9_]/g, '');\n      \n      const dataToValidate = {\n        ...req.body,\n        code,\n        customerId: req.params.customerId,\n        module: req.body.module || 'clean'\n      };\n      \n      console.log(\"Data to validate:\", dataToValidate);\n      \n      const serviceType = insertServiceTypeSchema.parse(dataToValidate);\n      const newServiceType = await storage.createServiceType(serviceType);\n      res.status(201).json(newServiceType);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        console.error(\"Validation error creating service type:\", error.errors);\n        return res.status(400).json({ message: \"Dados inválidos\", errors: error.errors });\n      }\n      console.error(\"Error creating service type:\", error);\n      res.status(500).json({ message: \"Erro ao criar tipo de serviço\" });\n    }\n  });\n\n  app.delete(\"/api/customers/:customerId/service-types/:id\", async (req, res) => {\n    try {\n      await storage.deleteServiceType(req.params.id);\n      res.json({ message: \"Service type deleted successfully\" });\n    } catch (error: any) {\n      console.error(\"Error deleting service type:\", error);\n      \n      // Check if it's a foreign key constraint error\n      if (error.code === '23503' && error.constraint?.includes('service_categories')) {\n        return res.status(400).json({ \n          message: \"Não é possível excluir este tipo de serviço porque existem categorias vinculadas a ele. Exclua primeiro as categorias relacionadas.\" \n        });\n      }\n      \n      res.status(500).json({ message: \"Failed to delete service type\" });\n    }\n  });\n\n  app.put(\"/api/service-types/:id\", async (req, res) => {\n    try {\n      const serviceType = insertServiceTypeSchema.partial().parse(req.body);\n      const updatedServiceType = await storage.updateServiceType(req.params.id, serviceType);\n      res.json(updatedServiceType);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to update service type\" });\n    }\n  });\n\n  app.delete(\"/api/service-types/:id\", async (req, res) => {\n    try {\n      await storage.deleteServiceType(req.params.id);\n      res.json({ message: \"Service type deleted successfully\" });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to delete service type\" });\n    }\n  });\n\n  // CATEGORIAS - TODAS AS ROTAS COMENTADAS (MANTER PARA REFERÊNCIA FUTURA)\n  /* app.get(\"/api/customers/:customerId/service-categories\", async (req, res) => {\n    try {\n      const module = req.query.module as 'clean' | 'maintenance' | undefined;\n      const serviceCategories = await storage.getServiceCategoriesByCustomer(req.params.customerId, module);\n      res.json(serviceCategories);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get service categories\" });\n    }\n  });\n\n  app.delete(\"/api/customers/:customerId/service-categories/:id\", async (req, res) => {\n    try {\n      await storage.deleteServiceCategory(req.params.id);\n      res.json({ message: \"Service category deleted successfully\" });\n    } catch (error) {\n      console.error(\"Error deleting service category:\", error);\n      res.status(500).json({ message: \"Failed to delete service category\" });\n    }\n  });\n\n  app.get(\"/api/service-types/:typeId/categories\", async (req, res) => {\n    try {\n      const serviceCategories = await storage.getServiceCategoriesByType(req.params.typeId);\n      res.json(serviceCategories);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get service categories by type\" });\n    }\n  });\n\n  app.post(\"/api/customers/:customerId/service-categories\", async (req, res) => {\n    try {\n      // Generate code from name if not provided\n      const code = req.body.code || req.body.name.toUpperCase().replace(/\\s+/g, '_').replace(/[^A-Z0-9_]/g, '');\n      \n      const serviceCategory = insertServiceCategorySchema.parse({\n        ...req.body,\n        code,\n        customerId: req.params.customerId\n      });\n      const newServiceCategory = await storage.createServiceCategory(serviceCategory);\n      res.status(201).json(newServiceCategory);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to create service category\" });\n    }\n  });\n\n  app.put(\"/api/service-categories/:id\", async (req, res) => {\n    try {\n      const serviceCategory = insertServiceCategorySchema.partial().parse(req.body);\n      const updatedServiceCategory = await storage.updateServiceCategory(req.params.id, serviceCategory);\n      res.json(updatedServiceCategory);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to update service category\" });\n    }\n  });\n\n  app.delete(\"/api/service-categories/:id\", async (req, res) => {\n    try {\n      await storage.deleteServiceCategory(req.params.id);\n      res.json({ message: \"Service category deleted successfully\" });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to delete service category\" });\n    }\n  }); */\n\n  // Work Orders\n  app.get(\"/api/companies/:companyId/work-orders\", async (req, res) => {\n    try {\n      const { zoneId, assignedTo } = req.query;\n      const module = req.query.module as 'clean' | 'maintenance' | undefined;\n      let workOrders = await storage.getWorkOrdersByCompany(req.params.companyId, module);\n      \n      // Filter by zone if provided\n      if (zoneId) {\n        workOrders = workOrders.filter(wo => wo.zoneId === zoneId);\n      }\n      \n      // Filter by assignedTo if provided (include unassigned work orders too)\n      if (assignedTo) {\n        workOrders = workOrders.filter(wo => wo.assignedUserId === assignedTo || wo.assignedUserId === null);\n      }\n      \n      res.json(workOrders);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get work orders\" });\n    }\n  });\n\n  app.get(\"/api/users/:userId/work-orders\", async (req, res) => {\n    try {\n      const workOrders = await storage.getWorkOrdersByUser(req.params.userId);\n      res.json(workOrders);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get work orders\" });\n    }\n  });\n\n  app.get(\"/api/work-orders/:id\", async (req, res) => {\n    try {\n      const workOrder = await storage.getWorkOrder(req.params.id);\n      if (!workOrder) {\n        return res.status(404).json({ message: \"Work order not found\" });\n      }\n      res.json(workOrder);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get work order\" });\n    }\n  });\n\n  app.post(\"/api/work-orders\", async (req, res) => {\n    try {\n      const dataWithModule = {\n        ...req.body,\n        module: req.body.module || 'clean'\n      };\n      const workOrder = insertWorkOrderSchema.parse(dataWithModule);\n      const newWorkOrder = await storage.createWorkOrder(workOrder);\n      \n      // Send webhook notification if configured\n      // TODO: Implement webhook sending logic\n      \n      res.status(201).json(newWorkOrder);\n    } catch (error: any) {\n      // Tratamento de erros do Zod (validação)\n      if (error instanceof z.ZodError) {\n        const fieldErrors = error.errors.map(e => {\n          const field = e.path.join('.');\n          const fieldNames: Record<string, string> = {\n            'title': 'Título',\n            'description': 'Descrição',\n            'type': 'Tipo',\n            'status': 'Status',\n            'priority': 'Prioridade',\n            'zoneId': 'Zona/Local',\n            'serviceId': 'Serviço',\n            'companyId': 'Empresa',\n            'scheduledDate': 'Data agendada',\n            'dueDate': 'Data de vencimento',\n          };\n          const friendlyField = fieldNames[field] || field;\n          return `${friendlyField}: ${e.message}`;\n        });\n        \n        return res.status(400).json({ \n          message: \"Dados inválidos na ordem de serviço\",\n          details: fieldErrors.join('; '),\n          errors: error.errors \n        });\n      }\n      \n      // Tratamento de erros do PostgreSQL\n      if (error.code === '23505') {\n        return res.status(400).json({ \n          message: \"Registro duplicado\",\n          details: \"Já existe uma ordem de serviço com esses dados.\"\n        });\n      }\n      \n      if (error.code === '23503') {\n        return res.status(400).json({ \n          message: \"Referência inválida\",\n          details: \"A zona, serviço ou usuário selecionado não existe. Por favor, verifique os dados e tente novamente.\"\n        });\n      }\n      \n      console.error('Erro ao criar ordem de serviço:', error);\n      res.status(500).json({ \n        message: \"Erro ao criar ordem de serviço\",\n        details: \"Ocorreu um erro inesperado. Por favor, tente novamente.\"\n      });\n    }\n  });\n\n  app.put(\"/api/work-orders/:id\", async (req, res) => {\n    try {\n      const workOrder = insertWorkOrderSchema.partial().parse(req.body);\n      const updatedWorkOrder = await storage.updateWorkOrder(req.params.id, workOrder);\n      \n      // Send webhook notification if configured\n      // TODO: Implement webhook sending logic\n      \n      res.json(updatedWorkOrder);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to update work order\" });\n    }\n  });\n\n  app.patch(\"/api/work-orders/:id\", async (req, res) => {\n    try {\n      const workOrder = insertWorkOrderSchema.partial().parse(req.body);\n      const updatedWorkOrder = await storage.updateWorkOrder(req.params.id, workOrder);\n      \n      // Send webhook notification if configured\n      // TODO: Implement webhook sending logic\n      \n      res.json(updatedWorkOrder);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to update work order\" });\n    }\n  });\n\n  app.delete(\"/api/work-orders/:id\", async (req, res) => {\n    try {\n      await storage.deleteWorkOrder(req.params.id);\n      res.json({ message: \"Work order deleted successfully\" });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to delete work order\" });\n    }\n  });\n\n  // Work Order Comments\n  app.get(\"/api/work-orders/:workOrderId/comments\", async (req, res) => {\n    try {\n      const comments = await storage.getWorkOrderComments(req.params.workOrderId);\n      res.json(comments);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get comments\" });\n    }\n  });\n\n  // Work Order Execution Time - Calcula tempo real de execução (pausas descontadas)\n  app.get(\"/api/work-orders/:workOrderId/execution-time\", async (req, res) => {\n    try {\n      const workOrder = await storage.getWorkOrder(req.params.workOrderId);\n      if (!workOrder) {\n        return res.status(404).json({ message: \"Work order not found\" });\n      }\n\n      if (!workOrder.startedAt) {\n        return res.json({ \n          milliseconds: 0, \n          formatted: \"Não iniciada\",\n          periods: []\n        });\n      }\n\n      const comments = await storage.getWorkOrderComments(req.params.workOrderId);\n      const executionPeriods: { start: Date; end: Date | null }[] = [];\n      let currentPeriodStart: Date | null = new Date(workOrder.startedAt);\n\n      // Processar comentários em ordem cronológica\n      for (const comment of comments) {\n        const text = comment.comment || \"\";\n        const timestamp = new Date(comment.createdAt as Date);\n\n        // Detectar PAUSA - finaliza período atual\n        if ((text.includes(\"pausou a OS\") || text.includes(\"pausou o OS\")) && currentPeriodStart) {\n          executionPeriods.push({\n            start: currentPeriodStart,\n            end: timestamp\n          });\n          currentPeriodStart = null;\n        }\n\n        // Detectar RETOMADA ou INÍCIO - inicia novo período\n        if ((text.includes(\"iniciou a execução\") || text.includes(\"retomou a execução\")) && !currentPeriodStart) {\n          currentPeriodStart = timestamp;\n        }\n      }\n\n      // Se ainda está em execução\n      if (currentPeriodStart && workOrder.status === 'em_execucao') {\n        executionPeriods.push({\n          start: currentPeriodStart,\n          end: null // null indica \"em execução agora\"\n        });\n      }\n\n      // Se foi concluída, finaliza o último período\n      if (currentPeriodStart && workOrder.status === 'concluida' && workOrder.completedAt) {\n        executionPeriods.push({\n          start: currentPeriodStart,\n          end: new Date(workOrder.completedAt)\n        });\n      }\n\n      // Calcular tempo total\n      let totalMs = 0;\n      const now = new Date();\n      \n      for (const period of executionPeriods) {\n        const endTime = period.end || now;\n        const duration = endTime.getTime() - period.start.getTime();\n        totalMs += duration;\n      }\n\n      // Formatar tempo\n      const hours = Math.floor(totalMs / (1000 * 60 * 60));\n      const minutes = Math.floor((totalMs % (1000 * 60 * 60)) / (1000 * 60));\n      const seconds = Math.floor((totalMs % (1000 * 60)) / 1000);\n\n      let formatted = \"\";\n      if (hours > 0) {\n        formatted = `${hours}h ${minutes}min`;\n      } else if (minutes > 0) {\n        formatted = `${minutes}min ${seconds}s`;\n      } else {\n        formatted = `${seconds}s`;\n      }\n\n      res.json({\n        milliseconds: totalMs,\n        formatted,\n        periods: executionPeriods.map(p => ({\n          start: p.start.toISOString(),\n          end: p.end ? p.end.toISOString() : null,\n          durationMs: p.end ? p.end.getTime() - p.start.getTime() : now.getTime() - p.start.getTime()\n        }))\n      });\n    } catch (error) {\n      console.error(\"Error calculating execution time:\", error);\n      res.status(500).json({ message: \"Failed to calculate execution time\" });\n    }\n  });\n\n  app.post(\"/api/work-orders/:workOrderId/comments\", async (req, res) => {\n    try {\n      const comment = {\n        id: crypto.randomUUID(),\n        workOrderId: req.params.workOrderId,\n        userId: req.body.userId,\n        comment: req.body.comment,\n        attachments: req.body.attachments,\n        isReopenRequest: req.body.isReopenRequest || false,\n      };\n      const newComment = await storage.createWorkOrderComment(comment);\n      res.status(201).json(newComment);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to create comment\" });\n    }\n  });\n\n  app.delete(\"/api/work-orders/:workOrderId/comments/:commentId\", async (req, res) => {\n    try {\n      await storage.deleteWorkOrderComment(req.params.commentId);\n      res.json({ message: \"Comment deleted successfully\" });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to delete comment\" });\n    }\n  });\n\n  // Work Order Rating (Customer Feedback)\n  app.post(\"/api/work-orders/:workOrderId/rating\", async (req, res) => {\n    try {\n      const { rating, comment, userId } = req.body;\n      \n      if (!rating || rating < 1 || rating > 10) {\n        return res.status(400).json({ message: \"Rating must be between 1 and 10\" });\n      }\n      \n      const updatedWorkOrder = await storage.updateWorkOrder(req.params.workOrderId, {\n        customerRating: rating,\n        customerRatingComment: comment || null,\n        ratedAt: new Date(),\n        ratedBy: userId,\n      });\n      \n      res.json(updatedWorkOrder);\n    } catch (error) {\n      console.error(\"Error rating work order:\", error);\n      res.status(500).json({ message: \"Failed to rate work order\" });\n    }\n  });\n\n  // Work Order Reopen\n  app.post(\"/api/work-orders/:workOrderId/reopen\", async (req, res) => {\n    try {\n      const { userId, reason, attachments } = req.body;\n      const reopenedWorkOrder = await storage.reopenWorkOrder(\n        req.params.workOrderId,\n        userId,\n        reason,\n        attachments\n      );\n      res.json(reopenedWorkOrder);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to reopen work order\" });\n    }\n  });\n\n  // Dashboard stats\n  app.get(\"/api/companies/:companyId/dashboard-stats\", async (req, res) => {\n    try {\n      const stats = await storage.getDashboardStats(req.params.companyId);\n      res.json(stats);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get dashboard stats\" });\n    }\n  });\n\n  // Dashboard stats with filters\n  app.get(\"/api/companies/:companyId/dashboard-stats/:period/:siteId\", async (req, res) => {\n    try {\n      const { companyId, period, siteId } = req.params;\n      const stats = await storage.getDashboardStats(companyId, period, siteId === 'todos' ? undefined : siteId);\n      res.json(stats);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get dashboard stats\" });\n    }\n  });\n\n  // Performance analytics\n  app.get(\"/api/companies/:companyId/analytics\", async (req, res) => {\n    try {\n      const period = req.query.period as string || '7d';\n      const analytics = await storage.getPerformanceAnalytics(req.params.companyId, period);\n      res.json(analytics);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get performance analytics\" });\n    }\n  });\n\n  // Reports metrics endpoint\n  app.get(\"/api/companies/:companyId/reports/metrics\", async (req, res) => {\n    try {\n      const { companyId } = req.params;\n      const period = req.query.period as string || '30';\n      const metrics = await storage.getReportsMetrics(companyId, period);\n      res.json(metrics);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get reports metrics\" });\n    }\n  });\n\n  // Work orders status distribution\n  app.get(\"/api/companies/:companyId/reports/work-orders-status\", async (req, res) => {\n    try {\n      const { companyId } = req.params;\n      const period = req.query.period as string || '30';\n      const statusData = await storage.getWorkOrdersStatusDistribution(companyId, period);\n      res.json(statusData);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get work orders status distribution\" });\n    }\n  });\n\n  // SLA performance breakdown\n  app.get(\"/api/companies/:companyId/reports/sla-performance\", async (req, res) => {\n    try {\n      const { companyId } = req.params;\n      const period = req.query.period as string || '30';\n      const slaData = await storage.getSLAPerformanceBreakdown(companyId, period);\n      res.json(slaData);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get SLA performance breakdown\" });\n    }\n  });\n\n  // Performance analytics with filters\n  app.get(\"/api/companies/:companyId/analytics/:period/:siteId\", async (req, res) => {\n    try {\n      const { companyId, period, siteId } = req.params;\n      const analytics = await storage.getPerformanceAnalytics(companyId, period, siteId === 'todos' ? undefined : siteId);\n      res.json(analytics);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get performance analytics\" });\n    }\n  });\n\n  // QR Code scanning endpoints\n  app.get(\"/api/qr-execution/:code\", async (req, res) => {\n    try {\n      const point = await storage.getQrCodePointByCode(req.params.code);\n      if (!point || point.type !== 'execucao') {\n        return res.status(404).json({ message: \"QR code not found or invalid type\" });\n      }\n      \n      // TODO: Check for scheduled activities at this time/location\n      // TODO: Return appropriate work order or option to create corrective one\n      \n      res.json({ point, hasScheduledActivity: false });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to process QR scan\" });\n    }\n  });\n\n  app.get(\"/api/qr-public/:code\", async (req, res) => {\n    try {\n      const point = await storage.getQrCodePointByCode(req.params.code);\n      if (!point || point.type !== 'atendimento') {\n        return res.status(404).json({ message: \"QR code not found or invalid type\" });\n      }\n      \n      res.json({ point });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to process QR scan\" });\n    }\n  });\n\n  app.post(\"/api/qr-public/:code/service-request\", async (req, res) => {\n    try {\n      const point = await storage.getQrCodePointByCode(req.params.code);\n      if (!point || point.type !== 'atendimento') {\n        return res.status(404).json({ message: \"QR code not found or invalid type\" });\n      }\n\n      const { description, photo, requesterName, requesterContact } = req.body;\n      \n      // Create IP hash for spam control\n      const clientIp = req.ip || req.connection.remoteAddress || 'unknown';\n      const ipHash = crypto.createHash('sha256').update(clientIp).digest('hex');\n      \n      // Check for recent requests from this IP for spam control\n      const recentRequests = await storage.checkRecentPublicRequests(ipHash, point.id, 24);\n      if (recentRequests >= 5) {\n        return res.status(429).json({ \n          message: \"Muitas solicitações. Tente novamente em algumas horas.\",\n          code: \"TOO_MANY_REQUESTS\" \n        });\n      }\n      \n      // Get zone and company info\n      if (!point.zoneId) {\n        return res.status(400).json({ message: \"QR code point has no zone associated\" });\n      }\n      const zone = await storage.getZone(point.zoneId);\n      if (!zone) {\n        return res.status(404).json({ message: \"Zone not found\" });\n      }\n\n      const site = await storage.getSite(zone.siteId);\n      if (!site) {\n        return res.status(404).json({ message: \"Site not found\" });\n      }\n\n      // Create corrective work order\n      const workOrder = await storage.createWorkOrder({\n        companyId: site.companyId,\n        zoneId: zone.id,\n        qrCodePointId: point.id,\n        requesterName,\n        requesterContact,\n        type: 'corretiva_publica',\n        priority: 'media',\n        title: `Solicitação de Atendimento - ${zone.name}`,\n        description: description || 'Solicitação via QR Code público',\n        origin: 'QR Atendimento',\n        attachments: photo ? [photo] : undefined,\n        scheduledDate: null,\n        dueDate: null\n      });\n\n      // Log the public request for spam control\n      await storage.createPublicRequestLog({\n        id: crypto.randomUUID(),\n        ipHash,\n        qrCodePointId: point.id,\n        userAgent: req.get('User-Agent') || 'unknown',\n        requestData: { workOrderId: workOrder.id }\n      });\n\n      // TODO: Send webhook notification for WhatsApp integration\n      \n      res.status(201).json({ \n        message: \"Solicitação criada com sucesso\",\n        workOrderNumber: workOrder.number \n      });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to create service request\" });\n    }\n  });\n\n  // Bathroom counter endpoints\n  app.post(\"/api/zones/:zoneId/bathroom-counter/increment\", async (req, res) => {\n    try {\n      const counter = await storage.incrementBathroomCounter(req.params.zoneId);\n      res.json(counter);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to increment bathroom counter\" });\n    }\n  });\n\n  app.get(\"/api/zones/:zoneId/bathroom-counter\", async (req, res) => {\n    try {\n      const counter = await storage.getBathroomCounterByZone(req.params.zoneId);\n      if (!counter) {\n        return res.status(404).json({ message: \"Bathroom counter not found\" });\n      }\n      res.json(counter);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get bathroom counter\" });\n    }\n  });\n\n  app.post(\"/api/bathroom-counters\", async (req, res) => {\n    try {\n      const counter = insertBathroomCounterSchema.parse(req.body);\n      const newCounter = await storage.createBathroomCounter(counter);\n      res.status(201).json(newCounter);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to create bathroom counter\" });\n    }\n  });\n\n  // Dashboard Goals Configuration\n  app.get(\"/api/companies/:companyId/dashboard-goals\", async (req, res) => {\n    try {\n      const module = req.query.module as 'clean' | 'maintenance' | undefined;\n      const goals = await storage.getDashboardGoals(req.params.companyId, module);\n      res.json(goals);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get dashboard goals\" });\n    }\n  });\n\n  app.post(\"/api/companies/:companyId/dashboard-goals\", async (req, res) => {\n    try {\n      const goal = insertDashboardGoalSchema.parse({\n        ...req.body,\n        companyId: req.params.companyId,\n        module: req.body.module || 'clean'\n      });\n      const newGoal = await storage.createDashboardGoal(goal);\n      res.status(201).json(newGoal);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to create dashboard goal\" });\n    }\n  });\n\n  app.put(\"/api/dashboard-goals/:id\", async (req, res) => {\n    try {\n      const goal = insertDashboardGoalSchema.partial().parse(req.body);\n      const updatedGoal = await storage.updateDashboardGoal(req.params.id, goal);\n      res.json(updatedGoal);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to update dashboard goal\" });\n    }\n  });\n\n  app.delete(\"/api/dashboard-goals/:id\", async (req, res) => {\n    try {\n      await storage.deleteDashboardGoal(req.params.id);\n      res.status(204).send();\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to delete dashboard goal\" });\n    }\n  });\n\n  // Customer dashboard goals (delegates to company goals)\n  app.get(\"/api/customers/:customerId/dashboard-goals\", async (req, res) => {\n    try {\n      const customer = await storage.getCustomer(req.params.customerId);\n      if (!customer) {\n        return res.status(404).json({ message: \"Customer not found\" });\n      }\n      const module = req.query.module as 'clean' | 'maintenance' | undefined;\n      const goals = await storage.getDashboardGoals(customer.companyId, module);\n      res.json(goals);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get dashboard goals\" });\n    }\n  });\n\n  app.post(\"/api/customers/:customerId/dashboard-goals\", async (req, res) => {\n    try {\n      console.log(\"Creating dashboard goal with data:\", req.body, \"customerId:\", req.params.customerId);\n      \n      const customer = await storage.getCustomer(req.params.customerId);\n      if (!customer) {\n        return res.status(404).json({ message: \"Customer not found\" });\n      }\n      \n      const dataToValidate = {\n        ...req.body,\n        companyId: customer.companyId,\n        module: req.body.module || 'clean'\n      };\n      \n      console.log(\"Dashboard goal data to validate:\", dataToValidate);\n      \n      const goal = insertDashboardGoalSchema.parse(dataToValidate);\n      const newGoal = await storage.createDashboardGoal(goal);\n      res.status(201).json(newGoal);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        console.error(\"Validation error creating dashboard goal:\", error.errors);\n        return res.status(400).json({ message: \"Dados inválidos\", errors: error.errors });\n      }\n      console.error(\"Error creating dashboard goal:\", error);\n      res.status(500).json({ message: \"Erro ao criar meta\" });\n    }\n  });\n\n  app.delete(\"/api/customers/:customerId/dashboard-goals/:id\", async (req, res) => {\n    try {\n      await storage.deleteDashboardGoal(req.params.id);\n      res.json({ message: \"Meta excluída com sucesso\" });\n    } catch (error) {\n      console.error(\"Error deleting dashboard goal:\", error);\n      res.status(500).json({ message: \"Erro ao excluir meta\" });\n    }\n  });\n\n  // Audit Logs routes - PROTEGIDO: Apenas admin pode acessar\n  app.get(\"/api/companies/:companyId/audit-logs\", requireAdmin, async (req, res) => {\n    try {\n      const { companyId } = req.params;\n      const { limit } = req.query;\n      const logs = await storage.getAuditLogsByCompany(companyId, limit ? parseInt(limit as string) : undefined);\n      res.json(logs);\n    } catch (error) {\n      console.error(\"Error fetching audit logs:\", error);\n      res.status(500).json({ error: \"Failed to fetch audit logs\" });\n    }\n  });\n\n  app.get(\"/api/audit-logs/:entityType/:entityId\", requireAdmin, async (req, res) => {\n    try {\n      const { entityType, entityId } = req.params;\n      const logs = await storage.getAuditLogsByEntity(entityType, entityId);\n      res.json(logs);\n    } catch (error) {\n      console.error(\"Error fetching entity audit logs:\", error);\n      res.status(500).json({ error: \"Failed to fetch entity audit logs\" });\n    }\n  });\n\n  // Heatmap for cleaning performance by zone\n  app.get(\"/api/companies/:companyId/heatmap/:siteId\", async (req, res) => {\n    try {\n      const { companyId, siteId } = req.params;\n      const heatmapData = await storage.getCleaningHeatmapData(companyId, siteId);\n      res.json(heatmapData);\n    } catch (error) {\n      console.error(\"Error fetching heatmap data:\", error);\n      res.status(500).json({ message: \"Failed to get heatmap data\" });\n    }\n  });\n\n  // Customers endpoints\n  app.get(\"/api/companies/:companyId/customers\", async (req, res) => {\n    try {\n      const customers = await storage.getCustomersByCompany(req.params.companyId);\n      res.json(customers);\n    } catch (error) {\n      console.error(\"Error fetching customers:\", error);\n      res.status(500).json({ message: \"Failed to get customers\" });\n    }\n  });\n\n  app.get(\"/api/customers/:id\", async (req, res) => {\n    try {\n      const customer = await storage.getCustomer(req.params.id);\n      if (!customer) {\n        return res.status(404).json({ message: \"Customer not found\" });\n      }\n      res.json(customer);\n    } catch (error) {\n      console.error(\"Error fetching customer:\", error);\n      res.status(500).json({ message: \"Failed to get customer\" });\n    }\n  });\n\n  app.post(\"/api/companies/:companyId/customers\", requireManageClients, async (req, res) => {\n    try {\n      const customer = insertCustomerSchema.parse({\n        ...req.body,\n        companyId: req.params.companyId\n      });\n      const newCustomer = await storage.createCustomer(customer);\n      res.status(201).json(newCustomer);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      console.error(\"Error creating customer:\", error);\n      res.status(500).json({ message: \"Failed to create customer\" });\n    }\n  });\n\n  app.put(\"/api/customers/:id\", requireManageClients, async (req, res) => {\n    try {\n      const customer = insertCustomerSchema.partial().parse(req.body);\n      const updatedCustomer = await storage.updateCustomer(req.params.id, customer);\n      res.json(updatedCustomer);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      console.error(\"Error updating customer:\", error);\n      res.status(500).json({ message: \"Failed to update customer\" });\n    }\n  });\n\n  app.delete(\"/api/customers/:id\", requireManageClients, async (req, res) => {\n    try {\n      await storage.deleteCustomer(req.params.id);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting customer:\", error);\n      res.status(500).json({ message: \"Failed to delete customer\" });\n    }\n  });\n\n  // Authentication routes\n  app.post(\"/api/auth/login\", loginLimiter, async (req, res) => {\n    try {\n      const { username, password } = req.body;\n      \n      if (!username || !password) {\n        return res.status(400).json({ message: \"Username and password are required\" });\n      }\n\n      // Find user by username OR email\n      let user = await storage.getUserByUsername(username);\n      if (!user) {\n        user = await storage.getUserByEmail(username);\n      }\n      \n      // Always hash even if user not found (prevent timing attacks)\n      const dummyHash = '$2a$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/LewY5GyYqR.NvJ8Om';\n      const hashToCompare = user?.password || dummyHash;\n      const isValidPassword = await bcrypt.compare(password, hashToCompare);\n      \n      if (!user || !isValidPassword) {\n        return res.status(401).json({ message: \"Invalid credentials\" });\n      }\n\n      // Check if user must use SSO\n      if (user.authProvider !== 'local') {\n        return res.status(400).json({ message: 'User must sign in with SSO' });\n      }\n\n      // Check if user is active\n      if (!user.isActive) {\n        return res.status(403).json({ message: 'Account is disabled' });\n      }\n\n      // Generate secure JWT token\n      const token = jwt.sign(\n        {\n          userId: user.id,\n          username: user.username,\n          role: user.role,\n          companyId: user.companyId,\n          customerId: user.customerId\n        },\n        JWT_SECRET,\n        { expiresIn: '24h' }\n      );\n\n      // Return user data without password\n      res.json({\n        user: sanitizeUser(user),\n        token: token\n      });\n    } catch (error) {\n      console.error(\"Login error:\", error);\n      res.status(500).json({ message: \"Internal server error\" });\n    }\n  });\n\n  // Logout route\n  app.post(\"/api/auth/logout\", async (req, res) => {\n    try {\n      // In a real application, you might want to invalidate the token here\n      // For now, we just return success since logout is handled client-side\n      res.json({ message: \"Logged out successfully\" });\n    } catch (error) {\n      console.error(\"Logout error:\", error);\n      res.status(500).json({ message: \"Internal server error\" });\n    }\n  });\n\n  // Get current authenticated user\n  app.get(\"/api/auth/me\", async (req, res) => {\n    try {\n      const authHeader = req.headers.authorization;\n      if (!authHeader) {\n        return res.status(404).json({ message: \"Not authenticated\" });\n      }\n      \n      const token = authHeader.replace('Bearer ', '');\n      \n      // Try JWT first, fallback to old token format for backwards compatibility\n      try {\n        const decoded = jwt.verify(token, JWT_SECRET) as any;\n        const user = await storage.getUser(decoded.userId);\n        if (!user) {\n          return res.status(404).json({ message: \"User not found\" });\n        }\n        return res.json({ user: sanitizeUser(user) });\n      } catch (jwtError) {\n        // Fallback: Parse old token format for backwards compatibility\n        const parts = token.split('_');\n        if (parts.length >= 2 && parts[0] === 'token') {\n          const userId = parts[1];\n          const user = await storage.getUser(userId);\n          if (!user) {\n            return res.status(404).json({ message: \"User not found\" });\n          }\n          return res.json({ user: sanitizeUser(user) });\n        }\n        return res.status(401).json({ message: \"Invalid token\" });\n      }\n    } catch (error) {\n      console.error(\"Get current user error:\", error);\n      res.status(500).json({ message: \"Internal server error\" });\n    }\n  });\n\n  // Get available modules for the authenticated user\n  app.get(\"/api/auth/available-modules\", async (req, res) => {\n    try {\n      const authHeader = req.headers.authorization;\n      if (!authHeader) {\n        return res.status(401).json({ message: \"Not authenticated\" });\n      }\n      \n      const token = authHeader.replace('Bearer ', '');\n      \n      let user;\n      try {\n        const decoded = jwt.verify(token, JWT_SECRET) as any;\n        user = await storage.getUser(decoded.userId);\n      } catch (jwtError) {\n        // Fallback for old token format\n        const parts = token.split('_');\n        if (parts.length >= 2 && parts[0] === 'token') {\n          const userId = parts[1];\n          user = await storage.getUser(userId);\n        }\n      }\n      \n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n\n      let availableModules: string[] = [];\n\n      // Separate logic for OPUS users and customer users\n      if (user.userType === 'customer_user') {\n        // Customer users: get modules from their associated customer\n        if (user.customerId) {\n          const customer = await storage.getCustomer(user.customerId);\n          if (customer) {\n            availableModules = customer.modules || [];\n          }\n        }\n      } else {\n        // OPUS users: get modules from the user directly\n        availableModules = user.modules || [];\n      }\n      \n      res.json({ modules: availableModules });\n    } catch (error) {\n      console.error(\"Get available modules error:\", error);\n      res.status(500).json({ message: \"Internal server error\" });\n    }\n  });\n\n  // Get user modules with default module (for mobile module restriction)\n  // SECURED: Uses requireAuth middleware to ensure proper authentication\n  app.get(\"/api/auth/user-modules\", requireAuth, async (req, res) => {\n    try {\n      // User is already validated by requireAuth middleware\n      const user = req.user;\n      \n      if (!user) {\n        return res.status(401).json({ message: \"Not authenticated\" });\n      }\n\n      let modules: ('clean' | 'maintenance')[] = [];\n\n      // Separate logic for OPUS users and customer users\n      if (user.userType === 'customer_user') {\n        // Customer users: get modules from their associated customer\n        if (user.customerId) {\n          const customer = await storage.getCustomer(user.customerId);\n          if (customer) {\n            modules = (customer.modules || ['clean']) as ('clean' | 'maintenance')[];\n          }\n        }\n      } else {\n        // OPUS users: get modules from the user directly\n        const fullUser = await storage.getUser(user.id);\n        if (fullUser) {\n          modules = (fullUser.modules || ['clean']) as ('clean' | 'maintenance')[];\n        }\n      }\n      \n      // SEGURANÇA: Garantir que sempre retorne pelo menos 1 módulo\n      // Se modules estiver vazio, forçar 'clean' como fallback seguro\n      if (modules.length === 0) {\n        modules = ['clean'];\n      }\n      \n      // Default to first available module\n      const defaultModule = modules[0];\n      \n      res.json({ \n        modules,\n        defaultModule \n      });\n    } catch (error) {\n      console.error(\"Get user modules error:\", error);\n      res.status(500).json({ message: \"Internal server error\" });\n    }\n  });\n\n  // === ROLES MANAGEMENT ===\n  \n  // Listar todas as funções\n  app.get(\"/api/roles\", async (req, res) => {\n    try {\n      const roles = await storage.getCustomRoles();\n      res.json(roles);\n    } catch (error) {\n      console.error(\"Error fetching roles:\", error);\n      res.status(500).json({ message: \"Failed to fetch roles\" });\n    }\n  });\n\n  // Criar nova função\n  app.post(\"/api/roles\", async (req, res) => {\n    try {\n      const { permissions, ...roleData } = req.body;\n      \n      // Criar a função\n      const role = await storage.createCustomRole(roleData);\n      \n      // Adicionar permissões\n      if (permissions?.length) {\n        await storage.setRolePermissions(role.id, permissions);\n      }\n      \n      // Retornar função completa com permissões\n      const fullRole = await storage.getCustomRoleById(role.id);\n      res.status(201).json(fullRole);\n    } catch (error) {\n      console.error(\"Error creating role:\", error);\n      res.status(500).json({ message: \"Failed to create role\" });\n    }\n  });\n\n  // Atualizar função\n  app.patch(\"/api/roles/:id\", async (req, res) => {\n    try {\n      const { permissions, ...roleData } = req.body;\n      \n      // Atualizar dados da função\n      const role = await storage.updateCustomRole(req.params.id, roleData);\n      \n      // Atualizar permissões se fornecidas\n      if (permissions) {\n        await storage.setRolePermissions(req.params.id, permissions);\n      }\n      \n      // Retornar função completa atualizada\n      const fullRole = await storage.getCustomRoleById(req.params.id);\n      res.json(fullRole);\n    } catch (error) {\n      console.error(\"Error updating role:\", error);\n      res.status(500).json({ message: \"Failed to update role\" });\n    }\n  });\n\n  // Excluir função\n  app.delete(\"/api/roles/:id\", async (req, res) => {\n    try {\n      await storage.deleteCustomRole(req.params.id);\n      res.status(204).end();\n    } catch (error) {\n      console.error(\"Error deleting role:\", error);\n      res.status(500).json({ message: \"Failed to delete role\" });\n    }\n  });\n\n  // Buscar roles de um usuário específico\n  app.get(\"/api/users/:userId/roles\", async (req, res) => {\n    try {\n      const roles = await storage.getUserRoleAssignments(req.params.userId);\n      res.json(roles);\n    } catch (error) {\n      console.error(\"Error fetching user roles:\", error);\n      res.status(500).json({ message: \"Failed to fetch user roles\" });\n    }\n  });\n\n  // Atribuir role a um usuário (novo endpoint mais intuitivo)\n  app.post(\"/api/users/:userId/roles\", async (req, res) => {\n    try {\n      const assignmentData = {\n        id: `ura-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\n        userId: req.params.userId,\n        roleId: req.body.roleId,\n        customerId: req.body.customerId || null,\n      };\n      const assignment = await storage.createUserRoleAssignment(assignmentData);\n      res.status(201).json(assignment);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      console.error(\"Error creating user role assignment:\", error);\n      res.status(500).json({ message: \"Failed to create user role assignment\" });\n    }\n  });\n\n  // Atribuir role a um usuário (endpoint antigo mantido para compatibilidade)\n  app.post(\"/api/user-role-assignments\", async (req, res) => {\n    try {\n      const assignmentData = insertUserRoleAssignmentSchema.parse(req.body);\n      const assignment = await storage.createUserRoleAssignment(assignmentData);\n      res.status(201).json(assignment);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      console.error(\"Error creating user role assignment:\", error);\n      res.status(500).json({ message: \"Failed to create user role assignment\" });\n    }\n  });\n\n  // Remover role de um usuário\n  app.delete(\"/api/users/:userId/roles/:roleId\", async (req, res) => {\n    try {\n      await storage.deleteUserRoleAssignment(req.params.userId, req.params.roleId);\n      res.status(204).end();\n    } catch (error) {\n      console.error(\"Error deleting user role assignment:\", error);\n      res.status(500).json({ message: \"Failed to delete user role assignment\" });\n    }\n  });\n\n  // === CLEANING ACTIVITIES MANAGEMENT ===\n  \n  // Get cleaning activities by company\n  app.get(\"/api/companies/:companyId/cleaning-activities\", async (req, res) => {\n    try {\n      const module = req.query.module as 'clean' | 'maintenance' | undefined;\n      const activities = await storage.getCleaningActivitiesByCompany(req.params.companyId, module);\n      res.json(activities);\n    } catch (error) {\n      console.error(\"Error fetching cleaning activities:\", error);\n      res.status(500).json({ message: \"Failed to get cleaning activities\" });\n    }\n  });\n\n  // Get single cleaning activity\n  app.get(\"/api/cleaning-activities/:id\", async (req, res) => {\n    try {\n      const activity = await storage.getCleaningActivity(req.params.id);\n      if (!activity) {\n        return res.status(404).json({ message: \"Cleaning activity not found\" });\n      }\n      res.json(activity);\n    } catch (error) {\n      console.error(\"Error fetching cleaning activity:\", error);\n      res.status(500).json({ message: \"Failed to get cleaning activity\" });\n    }\n  });\n\n  // Create cleaning activity\n  app.post(\"/api/cleaning-activities\", async (req, res) => {\n    try {\n      // Limpar campos que podem ter valores inválidos\n      const cleanedData = { \n        ...req.body,\n        module: req.body.module || 'clean'\n      };\n      \n      if (cleanedData.checklistTemplateId === \"none\" || cleanedData.checklistTemplateId === \"\") {\n        cleanedData.checklistTemplateId = null;\n      }\n      \n      // Converter strings vazias em null para campos de hora\n      if (cleanedData.startTime === \"\") {\n        cleanedData.startTime = null;\n      }\n      if (cleanedData.endTime === \"\") {\n        cleanedData.endTime = null;\n      }\n      \n      // Validar dados (schema omite o ID)\n      const activityData = insertCleaningActivitySchema.parse(cleanedData);\n      \n      // Gerar ID único após validação\n      const activityWithId = {\n        ...activityData,\n        id: `ca-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`\n      };\n      \n      const activity = await storage.createCleaningActivity(activityWithId as any);\n      res.status(201).json(activity);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      console.error(\"Error creating cleaning activity:\", error);\n      res.status(500).json({ message: \"Failed to create cleaning activity\" });\n    }\n  });\n\n  // Update cleaning activity\n  app.put(\"/api/cleaning-activities/:id\", async (req, res) => {\n    try {\n      const activityData = insertCleaningActivitySchema.partial().parse(req.body);\n      const activity = await storage.updateCleaningActivity(req.params.id, activityData);\n      res.json(activity);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      console.error(\"Error updating cleaning activity:\", error);\n      res.status(500).json({ message: \"Failed to update cleaning activity\" });\n    }\n  });\n\n  // Delete cleaning activity\n  app.delete(\"/api/cleaning-activities/:id\", async (req, res) => {\n    try {\n      await storage.deleteCleaningActivity(req.params.id);\n      res.json({ message: \"Cleaning activity deleted successfully\" });\n    } catch (error) {\n      console.error(\"Error deleting cleaning activity:\", error);\n      res.status(500).json({ message: \"Failed to delete cleaning activity\" });\n    }\n  });\n\n  // === MAINTENANCE ACTIVITIES MANAGEMENT ===\n  \n  // Get maintenance activities by customer\n  app.get(\"/api/customers/:customerId/maintenance-activities\", async (req, res) => {\n    try {\n      const activities = await storage.getMaintenanceActivitiesByCustomer(req.params.customerId);\n      res.json(activities);\n    } catch (error) {\n      console.error(\"Error fetching maintenance activities:\", error);\n      res.status(500).json({ message: \"Failed to get maintenance activities\" });\n    }\n  });\n\n  // Get maintenance activities by company\n  app.get(\"/api/companies/:companyId/maintenance-activities\", async (req, res) => {\n    try {\n      const activities = await storage.getMaintenanceActivitiesByCompany(req.params.companyId);\n      res.json(activities);\n    } catch (error) {\n      console.error(\"Error fetching maintenance activities:\", error);\n      res.status(500).json({ message: \"Failed to get maintenance activities\" });\n    }\n  });\n\n  // Get single maintenance activity\n  app.get(\"/api/maintenance-activities/:id\", async (req, res) => {\n    try {\n      const activity = await storage.getMaintenanceActivity(req.params.id);\n      if (!activity) {\n        return res.status(404).json({ message: \"Maintenance activity not found\" });\n      }\n      res.json(activity);\n    } catch (error) {\n      console.error(\"Error fetching maintenance activity:\", error);\n      res.status(500).json({ message: \"Failed to get maintenance activity\" });\n    }\n  });\n\n  // Create maintenance activity\n  app.post(\"/api/maintenance-activities\", async (req, res) => {\n    try {\n      console.log(\"[DEBUG] Request body:\", JSON.stringify(req.body, null, 2));\n      \n      const cleanedData = { \n        ...req.body,\n        module: 'maintenance',\n        customerId: req.body.activeClientId || req.body.customerId // Map activeClientId to customerId\n      };\n      \n      // Remove activeClientId if present (not part of schema)\n      delete cleanedData.activeClientId;\n      \n      if (cleanedData.checklistTemplateId === \"none\" || cleanedData.checklistTemplateId === \"\") {\n        cleanedData.checklistTemplateId = null;\n      }\n      \n      if (cleanedData.assignedUserId === \"none\" || cleanedData.assignedUserId === \"\") {\n        cleanedData.assignedUserId = null;\n      }\n      \n      if (cleanedData.slaConfigId === \"none\" || cleanedData.slaConfigId === \"\") {\n        cleanedData.slaConfigId = null;\n      }\n      \n      if (cleanedData.startTime === \"\") {\n        cleanedData.startTime = null;\n      }\n      if (cleanedData.endTime === \"\") {\n        cleanedData.endTime = null;\n      }\n      \n      console.log(\"[DEBUG] Cleaned data:\", JSON.stringify(cleanedData, null, 2));\n      \n      const activityData = insertMaintenanceActivitySchema.parse(cleanedData);\n      \n      const activityWithId = {\n        ...activityData,\n        id: `ma-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`\n      };\n      \n      const activity = await storage.createMaintenanceActivity(activityWithId as any);\n      \n      // Generate work orders for current month immediately\n      if (activity.isActive && activity.equipmentIds && activity.equipmentIds.length > 0) {\n        const now = new Date();\n        const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);\n        const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);\n        \n        try {\n          await storage.generateMaintenanceWorkOrders(\n            activity.companyId,\n            startOfMonth,\n            endOfMonth\n          );\n          console.log(`[PLAN CREATED] Generated work orders for current month for activity ${activity.id}`);\n        } catch (error) {\n          console.error(`[PLAN CREATED] Failed to generate work orders:`, error);\n          // Don't fail the request if work order generation fails\n        }\n      }\n      \n      res.status(201).json(activity);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        console.error(\"[DEBUG] Zod validation errors:\", JSON.stringify(error.errors, null, 2));\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      console.error(\"Error creating maintenance activity:\", error);\n      res.status(500).json({ message: \"Failed to create maintenance activity\" });\n    }\n  });\n\n  // Update maintenance activity\n  app.put(\"/api/maintenance-activities/:id\", async (req, res) => {\n    try {\n      const activityData = insertMaintenanceActivitySchema.partial().parse(req.body);\n      const activity = await storage.updateMaintenanceActivity(req.params.id, activityData);\n      res.json(activity);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      console.error(\"Error updating maintenance activity:\", error);\n      res.status(500).json({ message: \"Failed to update maintenance activity\" });\n    }\n  });\n\n  // Delete maintenance activity\n  app.delete(\"/api/maintenance-activities/:id\", async (req, res) => {\n    try {\n      await storage.deleteMaintenanceActivity(req.params.id);\n      res.json({ message: \"Maintenance activity deleted successfully\" });\n    } catch (error) {\n      console.error(\"Error deleting maintenance activity:\", error);\n      res.status(500).json({ message: \"Failed to delete maintenance activity\" });\n    }\n  });\n\n  // === SCHEDULER MANAGEMENT ===\n  \n  // Generate scheduled work orders from cleaning activities\n  app.post(\"/api/scheduler/generate-work-orders\", async (req, res) => {\n    try {\n      const { companyId, windowStart, windowEnd } = req.body;\n      \n      if (!companyId) {\n        return res.status(400).json({ message: \"Company ID is required\" });\n      }\n      \n      // Default window: APENAS MÊS CORRENTE (1 mês)\n      // Isso evita criar milhões de OS, gerando apenas o necessário\n      const now = new Date();\n      const startDate = windowStart ? new Date(windowStart) : new Date(now.getFullYear(), now.getMonth(), 1);\n      // Fim = último dia do mês corrente\n      const endDate = windowEnd ? new Date(windowEnd) : new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);\n      \n      console.log(`[SCHEDULER] Gerando OS para período: ${startDate.toISOString()} até ${endDate.toISOString()}`);\n      \n      const generatedOrders = await storage.generateScheduledWorkOrders(companyId, startDate, endDate);\n      \n      console.log(`[SCHEDULER] ✅ ${generatedOrders.length} OS geradas com sucesso`);\n      \n      res.json({\n        message: `Generated ${generatedOrders.length} scheduled work orders`,\n        generatedOrders: generatedOrders.length,\n        workOrders: generatedOrders,\n        period: {\n          start: startDate,\n          end: endDate\n        }\n      });\n    } catch (error) {\n      console.error(\"Error generating scheduled work orders:\", error);\n      res.status(500).json({ message: \"Failed to generate scheduled work orders\" });\n    }\n  });\n\n  // Generate scheduled work orders from maintenance activities\n  app.post(\"/api/scheduler/generate-maintenance-work-orders\", async (req, res) => {\n    try {\n      const { companyId, windowStart, windowEnd } = req.body;\n      \n      if (!companyId) {\n        return res.status(400).json({ message: \"Company ID is required\" });\n      }\n      \n      // Default window: MÊS ATUAL (sistema regenera automaticamente no final de cada mês)\n      const now = new Date();\n      const startDate = windowStart ? new Date(windowStart) : new Date(now.getFullYear(), now.getMonth(), 1);\n      // Gerar OSs apenas até o final do mês atual\n      const endDate = windowEnd ? new Date(windowEnd) : new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);\n      \n      console.log(`[SCHEDULER MAINTENANCE] Gerando OSs de manutenção para período: ${startDate.toISOString()} até ${endDate.toISOString()}`);\n      \n      const generatedOrders = await storage.generateMaintenanceWorkOrders(companyId, startDate, endDate);\n      \n      console.log(`[SCHEDULER MAINTENANCE] ✅ ${generatedOrders.length} OSs de manutenção geradas com sucesso`);\n      \n      res.json({\n        message: `Generated ${generatedOrders.length} maintenance work orders`,\n        generatedOrders: generatedOrders.length,\n        workOrders: generatedOrders,\n        period: {\n          start: startDate,\n          end: endDate\n        }\n      });\n    } catch (error) {\n      console.error(\"Error generating maintenance work orders:\", error);\n      res.status(500).json({ message: \"Failed to generate maintenance work orders\" });\n    }\n  });\n\n  // Monthly regeneration of maintenance work orders (called automatically)\n  app.post(\"/api/scheduler/regenerate-monthly-maintenance\", async (req, res) => {\n    try {\n      console.log(`[MONTHLY SCHEDULER] Iniciando regeneração mensal automática de OSs de manutenção`);\n      \n      // Get all companies\n      const allCompanies = await storage.getCompanies();\n      \n      let totalGenerated = 0;\n      \n      for (const company of allCompanies) {\n        try {\n          // Calculate next month window\n          const now = new Date();\n          const nextMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);\n          const startDate = new Date(nextMonth.getFullYear(), nextMonth.getMonth(), 1);\n          const endDate = new Date(nextMonth.getFullYear(), nextMonth.getMonth() + 1, 0, 23, 59, 59);\n          \n          console.log(`[MONTHLY SCHEDULER] Gerando OSs para ${company.name} - período: ${startDate.toISOString()} até ${endDate.toISOString()}`);\n          \n          const generatedOrders = await storage.generateMaintenanceWorkOrders(company.id, startDate, endDate);\n          totalGenerated += generatedOrders.length;\n          \n          console.log(`[MONTHLY SCHEDULER] ✅ ${generatedOrders.length} OSs geradas para ${company.name}`);\n        } catch (companyError) {\n          console.error(`[MONTHLY SCHEDULER] Erro ao gerar OSs para ${company.name}:`, companyError);\n        }\n      }\n      \n      console.log(`[MONTHLY SCHEDULER] ✅ Total: ${totalGenerated} OSs de manutenção geradas para próximo mês`);\n      \n      res.json({\n        message: `Monthly regeneration completed`,\n        totalGenerated,\n        companiesProcessed: allCompanies.length\n      });\n    } catch (error) {\n      console.error(\"Error in monthly regeneration:\", error);\n      res.status(500).json({ message: \"Failed to regenerate monthly work orders\" });\n    }\n  });\n\n  // === SYSTEM USERS MANAGEMENT ===\n  \n  // Listar usuários do sistema OPUS (type: opus_user)\n  app.get(\"/api/system-users\", async (req, res) => {\n    try {\n      const users = await storage.getOpusUsers();\n      \n      // Para cada usuário, buscar seus roles customizados e remover senha\n      const usersWithRoles = await Promise.all(\n        users.map(async (user) => {\n          const roleAssignments = await storage.getUserRoleAssignments(user.id);\n          const sanitized = sanitizeUser(user);\n          return {\n            ...sanitized,\n            customRoles: roleAssignments\n          };\n        })\n      );\n      \n      res.json(usersWithRoles);\n    } catch (error) {\n      console.error(\"Error fetching system users:\", error);\n      res.status(500).json({ message: \"Failed to fetch system users\" });\n    }\n  });\n\n  // Criar novo usuário do sistema OPUS\n  app.post(\"/api/system-users\", async (req, res) => {\n    try {\n      const userData = insertUserSchema.parse(req.body);\n      \n      // Hash password if provided\n      let hashedPassword = userData.password;\n      if (userData.password && (!userData.authProvider || userData.authProvider === 'local')) {\n        hashedPassword = await bcrypt.hash(userData.password, 12);\n      }\n      \n      // NÃO enviar o campo ID - deixar o DEFAULT do banco gerar\n      const userDataToInsert: any = {\n        username: userData.username,\n        email: userData.email,\n        password: hashedPassword || '',\n        name: userData.name,\n        role: userData.role,\n        userType: 'opus_user',\n        companyId: 'company-opus-default',\n        customerId: null,\n        authProvider: userData.authProvider || 'local',\n        msTenantId: userData.msTenantId || null,\n        isActive: userData.isActive ?? true,\n      };\n      \n      const user = await storage.createUser(userDataToInsert);\n      res.status(201).json(user);\n    } catch (error: any) {\n      console.error(\"Error creating system user:\", error);\n      \n      // Check for duplicate username\n      if (error?.code === '23505' && error?.constraint === 'users_username_unique') {\n        return res.status(400).json({ \n          message: `Username já está em uso. Por favor, escolha outro username.` \n        });\n      }\n      \n      res.status(500).json({ message: \"Failed to create system user\" });\n    }\n  });\n\n  // Atualizar usuário do sistema\n  app.patch(\"/api/system-users/:id\", async (req, res) => {\n    try {\n      const userData = insertUserSchema.partial().parse(req.body);\n      const user = await storage.updateUser(req.params.id, userData);\n      res.json(sanitizeUser(user));\n    } catch (error) {\n      console.error(\"Error updating system user:\", error);\n      res.status(500).json({ message: \"Failed to update system user\" });\n    }\n  });\n\n  // Alterar status (ativo/inativo) de usuário do sistema\n  app.patch(\"/api/system-users/:id/status\", async (req, res) => {\n    try {\n      const { isActive } = req.body;\n      const user = await storage.updateUser(req.params.id, { isActive });\n      res.json(user);\n    } catch (error) {\n      console.error(\"Error updating system user status:\", error);\n      res.status(500).json({ message: \"Failed to update system user status\" });\n    }\n  });\n\n  // === USER SITE ASSIGNMENTS ===\n  \n  // Get sites assigned to a user\n  app.get(\"/api/users/:userId/site-assignments\", async (req, res) => {\n    try {\n      const assignments = await storage.getUserSiteAssignments(req.params.userId);\n      res.json(assignments);\n    } catch (error) {\n      console.error(\"Error fetching user site assignments:\", error);\n      res.status(500).json({ message: \"Failed to fetch user site assignments\" });\n    }\n  });\n\n  // Get users assigned to a site\n  app.get(\"/api/sites/:siteId/users\", async (req, res) => {\n    try {\n      const users = await storage.getUsersBySite(req.params.siteId);\n      res.json(sanitizeUsers(users));\n    } catch (error) {\n      console.error(\"Error fetching site users:\", error);\n      res.status(500).json({ message: \"Failed to fetch site users\" });\n    }\n  });\n\n  // Assign user to site\n  app.post(\"/api/user-site-assignments\", async (req, res) => {\n    try {\n      const assignment = insertUserSiteAssignmentSchema.parse(req.body);\n      const newAssignment = await storage.createUserSiteAssignment(assignment);\n      res.status(201).json(newAssignment);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      console.error(\"Error creating user site assignment:\", error);\n      res.status(500).json({ message: \"Failed to create user site assignment\" });\n    }\n  });\n\n  // Remove user from site\n  app.delete(\"/api/users/:userId/sites/:siteId\", async (req, res) => {\n    try {\n      await storage.deleteUserSiteAssignment(req.params.userId, req.params.siteId);\n      res.json({ message: \"User site assignment removed successfully\" });\n    } catch (error) {\n      console.error(\"Error removing user site assignment:\", error);\n      res.status(500).json({ message: \"Failed to remove user site assignment\" });\n    }\n  });\n\n  // === PUBLIC REQUEST LOGS (Spam Control) ===\n  \n  // Check recent public requests for spam control\n  app.get(\"/api/public-requests/check/:ipHash/:qrCodePointId\", async (req, res) => {\n    try {\n      const { ipHash, qrCodePointId } = req.params;\n      const hoursWindow = parseInt(req.query.hours as string) || 24;\n      const count = await storage.checkRecentPublicRequests(ipHash, qrCodePointId, hoursWindow);\n      res.json({ count, allowed: count < 5 }); // Max 5 requests per 24h\n    } catch (error) {\n      console.error(\"Error checking public requests:\", error);\n      res.status(500).json({ message: \"Failed to check public requests\" });\n    }\n  });\n\n  // === SITE SHIFTS ===\n  \n  // Get shifts for a site\n  app.get(\"/api/sites/:siteId/shifts\", async (req, res) => {\n    try {\n      const shifts = await storage.getSiteShifts(req.params.siteId);\n      res.json(shifts);\n    } catch (error) {\n      console.error(\"Error fetching site shifts:\", error);\n      res.status(500).json({ message: \"Failed to fetch site shifts\" });\n    }\n  });\n\n  // Create new shift\n  app.post(\"/api/site-shifts\", async (req, res) => {\n    try {\n      const shift = insertSiteShiftSchema.parse(req.body);\n      const newShift = await storage.createSiteShift(shift);\n      res.status(201).json(newShift);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      console.error(\"Error creating site shift:\", error);\n      res.status(500).json({ message: \"Failed to create site shift\" });\n    }\n  });\n\n  // Update shift\n  app.put(\"/api/site-shifts/:id\", async (req, res) => {\n    try {\n      const shift = insertSiteShiftSchema.parse(req.body);\n      const updatedShift = await storage.updateSiteShift(req.params.id, shift);\n      res.json(updatedShift);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      console.error(\"Error updating site shift:\", error);\n      res.status(500).json({ message: \"Failed to update site shift\" });\n    }\n  });\n\n  // Delete shift\n  app.delete(\"/api/site-shifts/:id\", async (req, res) => {\n    try {\n      await storage.deleteSiteShift(req.params.id);\n      res.json({ message: \"Site shift deleted successfully\" });\n    } catch (error) {\n      console.error(\"Error deleting site shift:\", error);\n      res.status(500).json({ message: \"Failed to delete site shift\" });\n    }\n  });\n\n  // === BATHROOM COUNTER LOGS ===\n  \n  // Get bathroom counter audit logs for a zone\n  app.get(\"/api/zones/:zoneId/bathroom-counter-logs\", async (req, res) => {\n    try {\n      const limit = parseInt(req.query.limit as string) || 50;\n      const logs = await storage.getBathroomCounterLogs(req.params.zoneId, limit);\n      res.json(logs);\n    } catch (error) {\n      console.error(\"Error fetching bathroom counter logs:\", error);\n      res.status(500).json({ message: \"Failed to fetch bathroom counter logs\" });\n    }\n  });\n\n  // === COMPANY COUNTERS ===\n  \n  // Get counter for a company and key\n  app.get(\"/api/companies/:companyId/counters/:key\", async (req, res) => {\n    try {\n      const counter = await storage.getCompanyCounter(req.params.companyId, req.params.key);\n      if (!counter) {\n        return res.status(404).json({ message: \"Counter not found\" });\n      }\n      res.json(counter);\n    } catch (error) {\n      console.error(\"Error fetching company counter:\", error);\n      res.status(500).json({ message: \"Failed to fetch company counter\" });\n    }\n  });\n\n  // Create counter\n  app.post(\"/api/company-counters\", async (req, res) => {\n    try {\n      const counter = insertCompanyCounterSchema.parse(req.body);\n      const newCounter = await storage.createCompanyCounter(counter);\n      res.status(201).json(newCounter);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      console.error(\"Error creating company counter:\", error);\n      res.status(500).json({ message: \"Failed to create company counter\" });\n    }\n  });\n\n  // ============================================================================\n  // MAINTENANCE MODULE - Equipment Routes\n  // ============================================================================\n\n  // Get equipment by customer\n  app.get(\"/api/customers/:customerId/equipment\", async (req, res) => {\n    try {\n      const module = req.query.module as 'clean' | 'maintenance' | undefined;\n      const equipment = await storage.getEquipmentByCustomer(req.params.customerId, module);\n      res.json(equipment);\n    } catch (error) {\n      console.error(\"Error fetching equipment:\", error);\n      res.status(500).json({ message: \"Failed to fetch equipment\" });\n    }\n  });\n\n  // Get equipment by site\n  app.get(\"/api/sites/:siteId/equipment\", async (req, res) => {\n    try {\n      const module = req.query.module as 'clean' | 'maintenance' | undefined;\n      const equipment = await storage.getEquipmentBySite(req.params.siteId, module);\n      res.json(equipment);\n    } catch (error) {\n      console.error(\"Error fetching equipment:\", error);\n      res.status(500).json({ message: \"Failed to fetch equipment\" });\n    }\n  });\n\n  // Get equipment by zone\n  app.get(\"/api/zones/:zoneId/equipment\", async (req, res) => {\n    try {\n      const module = req.query.module as 'clean' | 'maintenance' | undefined;\n      const equipment = await storage.getEquipmentByZone(req.params.zoneId, module);\n      res.json(equipment);\n    } catch (error) {\n      console.error(\"Error fetching equipment:\", error);\n      res.status(500).json({ message: \"Failed to fetch equipment\" });\n    }\n  });\n\n  // Get equipment by multiple zones (query parameter)\n  app.get(\"/api/equipment\", async (req, res) => {\n    try {\n      const zoneIdsParam = req.query.zoneIds as string;\n      const module = req.query.module as 'clean' | 'maintenance' | undefined;\n      \n      if (!zoneIdsParam) {\n        return res.status(400).json({ message: \"zoneIds query parameter is required\" });\n      }\n      \n      const zoneIds = zoneIdsParam.split(',').filter(id => id.trim());\n      \n      if (zoneIds.length === 0) {\n        return res.json([]);\n      }\n      \n      // Fetch equipment for all zones and merge\n      const equipmentPromises = zoneIds.map(zoneId => \n        storage.getEquipmentByZone(zoneId.trim(), module)\n      );\n      \n      const equipmentArrays = await Promise.all(equipmentPromises);\n      const allEquipment = equipmentArrays.flat();\n      \n      // Remove duplicates by ID\n      const uniqueEquipment = Array.from(\n        new Map(allEquipment.map(eq => [eq.id, eq])).values()\n      );\n      \n      res.json(uniqueEquipment);\n    } catch (error) {\n      console.error(\"Error fetching equipment by zones:\", error);\n      res.status(500).json({ message: \"Failed to fetch equipment\" });\n    }\n  });\n\n  // Get single equipment\n  app.get(\"/api/equipment/:id\", async (req, res) => {\n    try {\n      const equipment = await storage.getEquipment(req.params.id);\n      if (!equipment) {\n        return res.status(404).json({ message: \"Equipment not found\" });\n      }\n      res.json(equipment);\n    } catch (error) {\n      console.error(\"Error fetching equipment:\", error);\n      res.status(500).json({ message: \"Failed to fetch equipment\" });\n    }\n  });\n\n  // Create equipment\n  app.post(\"/api/equipment\", async (req, res) => {\n    try {\n      const equipment = insertEquipmentSchema.parse(req.body);\n      const newEquipment = await storage.createEquipment(equipment);\n      res.status(201).json(newEquipment);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      console.error(\"Error creating equipment:\", error);\n      res.status(500).json({ message: \"Failed to create equipment\" });\n    }\n  });\n\n  // Update equipment\n  app.put(\"/api/equipment/:id\", async (req, res) => {\n    try {\n      const equipment = insertEquipmentSchema.partial().parse(req.body);\n      const updatedEquipment = await storage.updateEquipment(req.params.id, equipment);\n      res.json(updatedEquipment);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      console.error(\"Error updating equipment:\", error);\n      res.status(500).json({ message: \"Failed to update equipment\" });\n    }\n  });\n\n  // Delete equipment\n  app.delete(\"/api/equipment/:id\", async (req, res) => {\n    try {\n      await storage.deleteEquipment(req.params.id);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting equipment:\", error);\n      res.status(500).json({ message: \"Failed to delete equipment\" });\n    }\n  });\n\n  // ============================================================================\n  // MAINTENANCE MODULE - Maintenance Checklist Templates Routes\n  // ============================================================================\n\n  // Get checklist templates by customer\n  app.get(\"/api/customers/:customerId/maintenance-checklist-templates\", async (req, res) => {\n    try {\n      const module = req.query.module as 'clean' | 'maintenance' | undefined;\n      const templates = await storage.getMaintenanceChecklistTemplatesByCustomer(req.params.customerId, module);\n      res.json(templates);\n    } catch (error) {\n      console.error(\"Error fetching maintenance checklist templates:\", error);\n      res.status(500).json({ message: \"Failed to fetch maintenance checklist templates\" });\n    }\n  });\n\n  // Get checklist templates by equipment type\n  app.get(\"/api/customers/:customerId/maintenance-checklist-templates/equipment-type/:equipmentType\", async (req, res) => {\n    try {\n      const module = req.query.module as 'clean' | 'maintenance' | undefined;\n      const templates = await storage.getMaintenanceChecklistTemplatesByEquipmentType(\n        req.params.customerId, \n        req.params.equipmentType,\n        module\n      );\n      res.json(templates);\n    } catch (error) {\n      console.error(\"Error fetching maintenance checklist templates:\", error);\n      res.status(500).json({ message: \"Failed to fetch maintenance checklist templates\" });\n    }\n  });\n\n  // Get checklist templates by equipment\n  app.get(\"/api/equipment/:equipmentId/maintenance-checklist-templates\", async (req, res) => {\n    try {\n      const templates = await storage.getMaintenanceChecklistTemplatesByEquipment(req.params.equipmentId);\n      res.json(templates);\n    } catch (error) {\n      console.error(\"Error fetching maintenance checklist templates:\", error);\n      res.status(500).json({ message: \"Failed to fetch maintenance checklist templates\" });\n    }\n  });\n\n  // Get single checklist template\n  app.get(\"/api/maintenance-checklist-templates/:id\", async (req, res) => {\n    try {\n      const template = await storage.getMaintenanceChecklistTemplate(req.params.id);\n      if (!template) {\n        return res.status(404).json({ message: \"Maintenance checklist template not found\" });\n      }\n      res.json(template);\n    } catch (error) {\n      console.error(\"Error fetching maintenance checklist template:\", error);\n      res.status(500).json({ message: \"Failed to fetch maintenance checklist template\" });\n    }\n  });\n\n  // Create checklist template\n  app.post(\"/api/maintenance-checklist-templates\", async (req, res) => {\n    try {\n      const template = insertMaintenanceChecklistTemplateSchema.parse(req.body);\n      const newTemplate = await storage.createMaintenanceChecklistTemplate(template);\n      res.status(201).json(newTemplate);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      console.error(\"Error creating maintenance checklist template:\", error);\n      res.status(500).json({ message: \"Failed to create maintenance checklist template\" });\n    }\n  });\n\n  // Update checklist template\n  app.put(\"/api/maintenance-checklist-templates/:id\", async (req, res) => {\n    try {\n      const template = insertMaintenanceChecklistTemplateSchema.partial().parse(req.body);\n      const updatedTemplate = await storage.updateMaintenanceChecklistTemplate(req.params.id, template);\n      res.json(updatedTemplate);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      console.error(\"Error updating maintenance checklist template:\", error);\n      res.status(500).json({ message: \"Failed to update maintenance checklist template\" });\n    }\n  });\n\n  // Delete checklist template\n  app.delete(\"/api/maintenance-checklist-templates/:id\", async (req, res) => {\n    try {\n      await storage.deleteMaintenanceChecklistTemplate(req.params.id);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting maintenance checklist template:\", error);\n      res.status(500).json({ message: \"Failed to delete maintenance checklist template\" });\n    }\n  });\n\n  // ============================================================================\n  // MAINTENANCE MODULE - Maintenance Checklist Executions Routes\n  // ============================================================================\n\n  // Get executions by equipment\n  app.get(\"/api/equipment/:equipmentId/maintenance-checklist-executions\", async (req, res) => {\n    try {\n      const executions = await storage.getMaintenanceChecklistExecutionsByEquipment(req.params.equipmentId);\n      res.json(executions);\n    } catch (error) {\n      console.error(\"Error fetching maintenance checklist executions:\", error);\n      res.status(500).json({ message: \"Failed to fetch maintenance checklist executions\" });\n    }\n  });\n\n  // Get executions by work order\n  app.get(\"/api/work-orders/:workOrderId/maintenance-checklist-executions\", async (req, res) => {\n    try {\n      const executions = await storage.getMaintenanceChecklistExecutionsByWorkOrder(req.params.workOrderId);\n      res.json(executions);\n    } catch (error) {\n      console.error(\"Error fetching maintenance checklist executions:\", error);\n      res.status(500).json({ message: \"Failed to fetch maintenance checklist executions\" });\n    }\n  });\n\n  // Get single execution\n  app.get(\"/api/maintenance-checklist-executions/:id\", async (req, res) => {\n    try {\n      const execution = await storage.getMaintenanceChecklistExecution(req.params.id);\n      if (!execution) {\n        return res.status(404).json({ message: \"Maintenance checklist execution not found\" });\n      }\n      res.json(execution);\n    } catch (error) {\n      console.error(\"Error fetching maintenance checklist execution:\", error);\n      res.status(500).json({ message: \"Failed to fetch maintenance checklist execution\" });\n    }\n  });\n\n  // Create execution\n  app.post(\"/api/maintenance-checklist-executions\", async (req, res) => {\n    try {\n      const execution = insertMaintenanceChecklistExecutionSchema.parse(req.body);\n      const newExecution = await storage.createMaintenanceChecklistExecution(execution);\n      res.status(201).json(newExecution);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      console.error(\"Error creating maintenance checklist execution:\", error);\n      res.status(500).json({ message: \"Failed to create maintenance checklist execution\" });\n    }\n  });\n\n  // Update execution\n  app.put(\"/api/maintenance-checklist-executions/:id\", async (req, res) => {\n    try {\n      const execution = insertMaintenanceChecklistExecutionSchema.partial().parse(req.body);\n      const updatedExecution = await storage.updateMaintenanceChecklistExecution(req.params.id, execution);\n      res.json(updatedExecution);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      console.error(\"Error updating maintenance checklist execution:\", error);\n      res.status(500).json({ message: \"Failed to update maintenance checklist execution\" });\n    }\n  });\n\n  // Delete execution\n  app.delete(\"/api/maintenance-checklist-executions/:id\", async (req, res) => {\n    try {\n      await storage.deleteMaintenanceChecklistExecution(req.params.id);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting maintenance checklist execution:\", error);\n      res.status(500).json({ message: \"Failed to delete maintenance checklist execution\" });\n    }\n  });\n\n  // ============================================================================\n  // MAINTENANCE MODULE - Maintenance Plans Routes\n  // ============================================================================\n\n  // Get plans by customer\n  app.get(\"/api/customers/:customerId/maintenance-plans\", async (req, res) => {\n    try {\n      const module = req.query.module as 'clean' | 'maintenance' | undefined;\n      const plans = await storage.getMaintenancePlansByCustomer(req.params.customerId, module);\n      res.json(plans);\n    } catch (error) {\n      console.error(\"Error fetching maintenance plans:\", error);\n      res.status(500).json({ message: \"Failed to fetch maintenance plans\" });\n    }\n  });\n\n  // Get single plan\n  app.get(\"/api/maintenance-plans/:id\", async (req, res) => {\n    try {\n      const plan = await storage.getMaintenancePlan(req.params.id);\n      if (!plan) {\n        return res.status(404).json({ message: \"Maintenance plan not found\" });\n      }\n      res.json(plan);\n    } catch (error) {\n      console.error(\"Error fetching maintenance plan:\", error);\n      res.status(500).json({ message: \"Failed to fetch maintenance plan\" });\n    }\n  });\n\n  // Create plan\n  app.post(\"/api/maintenance-plans\", async (req, res) => {\n    try {\n      const plan = insertMaintenancePlanSchema.parse(req.body);\n      const newPlan = await storage.createMaintenancePlan(plan);\n      res.status(201).json(newPlan);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      console.error(\"Error creating maintenance plan:\", error);\n      res.status(500).json({ message: \"Failed to create maintenance plan\" });\n    }\n  });\n\n  // Update plan\n  app.put(\"/api/maintenance-plans/:id\", async (req, res) => {\n    try {\n      const plan = insertMaintenancePlanSchema.partial().parse(req.body);\n      const updatedPlan = await storage.updateMaintenancePlan(req.params.id, plan);\n      res.json(updatedPlan);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      console.error(\"Error updating maintenance plan:\", error);\n      res.status(500).json({ message: \"Failed to update maintenance plan\" });\n    }\n  });\n\n  // Delete plan\n  app.delete(\"/api/maintenance-plans/:id\", async (req, res) => {\n    try {\n      await storage.deleteMaintenancePlan(req.params.id);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting maintenance plan:\", error);\n      res.status(500).json({ message: \"Failed to delete maintenance plan\" });\n    }\n  });\n\n  // ============================================================================\n  // MAINTENANCE MODULE - Maintenance Plan Equipment Routes\n  // ============================================================================\n\n  // Get plan equipments by plan\n  app.get(\"/api/maintenance-plans/:planId/equipments\", async (req, res) => {\n    try {\n      const planEquipments = await storage.getMaintenancePlanEquipmentsByPlan(req.params.planId);\n      res.json(planEquipments);\n    } catch (error) {\n      console.error(\"Error fetching maintenance plan equipments:\", error);\n      res.status(500).json({ message: \"Failed to fetch maintenance plan equipments\" });\n    }\n  });\n\n  // Get plan equipments by equipment\n  app.get(\"/api/equipment/:equipmentId/maintenance-plans\", async (req, res) => {\n    try {\n      const planEquipments = await storage.getMaintenancePlanEquipmentsByEquipment(req.params.equipmentId);\n      res.json(planEquipments);\n    } catch (error) {\n      console.error(\"Error fetching maintenance plan equipments:\", error);\n      res.status(500).json({ message: \"Failed to fetch maintenance plan equipments\" });\n    }\n  });\n\n  // Get single plan equipment\n  app.get(\"/api/maintenance-plan-equipments/:id\", async (req, res) => {\n    try {\n      const planEquipment = await storage.getMaintenancePlanEquipment(req.params.id);\n      if (!planEquipment) {\n        return res.status(404).json({ message: \"Maintenance plan equipment not found\" });\n      }\n      res.json(planEquipment);\n    } catch (error) {\n      console.error(\"Error fetching maintenance plan equipment:\", error);\n      res.status(500).json({ message: \"Failed to fetch maintenance plan equipment\" });\n    }\n  });\n\n  // Create plan equipment\n  app.post(\"/api/maintenance-plan-equipments\", async (req, res) => {\n    try {\n      const planEquipment = insertMaintenancePlanEquipmentSchema.parse(req.body);\n      const newPlanEquipment = await storage.createMaintenancePlanEquipment(planEquipment);\n      res.status(201).json(newPlanEquipment);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      console.error(\"Error creating maintenance plan equipment:\", error);\n      res.status(500).json({ message: \"Failed to create maintenance plan equipment\" });\n    }\n  });\n\n  // Update plan equipment\n  app.put(\"/api/maintenance-plan-equipments/:id\", async (req, res) => {\n    try {\n      const planEquipment = insertMaintenancePlanEquipmentSchema.partial().parse(req.body);\n      const updatedPlanEquipment = await storage.updateMaintenancePlanEquipment(req.params.id, planEquipment);\n      res.json(updatedPlanEquipment);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      console.error(\"Error updating maintenance plan equipment:\", error);\n      res.status(500).json({ message: \"Failed to update maintenance plan equipment\" });\n    }\n  });\n\n  // Delete plan equipment\n  app.delete(\"/api/maintenance-plan-equipments/:id\", async (req, res) => {\n    try {\n      await storage.deleteMaintenancePlanEquipment(req.params.id);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting maintenance plan equipment:\", error);\n      res.status(500).json({ message: \"Failed to delete maintenance plan equipment\" });\n    }\n  });\n\n  const httpServer = createServer(app);\n  return httpServer;\n}\n","size_bytes":134971},"server/utils/security.ts":{"content":"import { type User } from \"@shared/schema\";\n\n/**\n * Remove sensitive fields from user object\n */\nexport function sanitizeUser<T extends Partial<User>>(user: T): Omit<T, 'password'> {\n  const { password, ...sanitized } = user;\n  return sanitized;\n}\n\n/**\n * Remove sensitive fields from array of users\n */\nexport function sanitizeUsers<T extends Partial<User>>(users: T[]): Omit<T, 'password'>[] {\n  return users.map(user => sanitizeUser(user));\n}\n\n/**\n * Generate secure random string for tokens/secrets\n */\nexport function generateSecureToken(length: number = 32): string {\n  const crypto = require('crypto');\n  return crypto.randomBytes(length).toString('hex');\n}\n\n/**\n * Constant-time string comparison to prevent timing attacks\n */\nexport function secureCompare(a: string, b: string): boolean {\n  if (a.length !== b.length) {\n    return false;\n  }\n  \n  const crypto = require('crypto');\n  const bufferA = Buffer.from(a);\n  const bufferB = Buffer.from(b);\n  \n  return crypto.timingSafeEqual(bufferA, bufferB);\n}\n","size_bytes":1014},"server/storage.ts":{"content":"import { \n  companies, sites, zones, qrCodePoints, users, checklistTemplates, \n  slaConfigs, cleaningActivities, workOrders, bathroomCounters, webhookConfigs, services,\n  serviceTypes, serviceCategories, serviceZones, dashboardGoals, auditLogs, customers,\n  userSiteAssignments, publicRequestLogs, siteShifts, bathroomCounterLogs, companyCounters,\n  workOrderComments,\n  equipment, equipmentTypes, maintenanceChecklistTemplates,\n  maintenanceChecklistExecutions, maintenancePlans, maintenancePlanEquipments, maintenanceActivities,\n  type Company, type InsertCompany, type Site, type InsertSite, \n  type Zone, type InsertZone, type QrCodePoint, type InsertQrCodePoint,\n  type User, type InsertUser, type ChecklistTemplate, type InsertChecklistTemplate,\n  type SlaConfig, type InsertSlaConfig, type CleaningActivity, type InsertCleaningActivity,\n  type WorkOrder, type InsertWorkOrder, type BathroomCounter, type InsertBathroomCounter,\n  type WebhookConfig, type InsertWebhookConfig, type Service, type InsertService,\n  type ServiceType, type InsertServiceType, type ServiceCategory, type InsertServiceCategory,\n  type ServiceZone, type InsertServiceZone, type DashboardGoal, type InsertDashboardGoal, \n  type AuditLog, type InsertAuditLog, type Customer, type InsertCustomer,\n  type UserSiteAssignment, type InsertUserSiteAssignment,\n  type PublicRequestLog, type InsertPublicRequestLog, \n  type SiteShift, type InsertSiteShift,\n  type BathroomCounterLog, type InsertBathroomCounterLog,\n  type CompanyCounter, type InsertCompanyCounter,\n  type WorkOrderComment, type InsertWorkOrderComment,\n  customRoles, rolePermissions, userRoleAssignments,\n  type CustomRole, type CustomRoleWithPermissions, type InsertCustomRole, type RolePermission, type InsertRolePermission,\n  type UserRoleAssignment, type InsertUserRoleAssignment,\n  type Equipment, type InsertEquipment,\n  type MaintenanceChecklistTemplate, type InsertMaintenanceChecklistTemplate,\n  type MaintenanceChecklistExecution, type InsertMaintenanceChecklistExecution,\n  type MaintenancePlan, type InsertMaintenancePlan,\n  type MaintenancePlanEquipment, type InsertMaintenancePlanEquipment,\n  type MaintenanceActivity, type InsertMaintenanceActivity\n} from \"@shared/schema\";\nimport { db } from \"./db\";\nimport { eq, and, or, desc, sql, count, inArray, isNull, isNotNull, ne } from \"drizzle-orm\";\nimport bcrypt from \"bcryptjs\";\nimport { nanoid } from \"nanoid\";\nimport crypto from \"crypto\";\n\nexport interface IStorage {\n  // Companies\n  getCompanies(): Promise<Company[]>;\n  getCompany(id: string): Promise<Company | undefined>;\n  createCompany(company: InsertCompany): Promise<Company>;\n  updateCompany(id: string, company: Partial<InsertCompany>): Promise<Company>;\n\n  // Sites\n  getSitesByCompany(companyId: string, module?: 'clean' | 'maintenance'): Promise<Site[]>;\n  getSitesByCustomer(customerId: string, module?: 'clean' | 'maintenance'): Promise<Site[]>;\n  getSite(id: string): Promise<Site | undefined>;\n  createSite(site: InsertSite): Promise<Site>;\n  updateSite(id: string, site: Partial<InsertSite>): Promise<Site>;\n  deleteSite(id: string): Promise<void>;\n\n  // Customer-filtered data methods\n  getZonesByCustomer(customerId: string, module?: 'clean' | 'maintenance'): Promise<Zone[]>;\n  getWorkOrdersByCustomer(customerId: string, module?: 'clean' | 'maintenance'): Promise<WorkOrder[]>;\n  getDashboardStatsByCustomer(customerId: string, period: string, site: string, module?: 'clean' | 'maintenance'): Promise<any>;\n  getAnalyticsByCustomer(customerId: string, period: string, site: string, module?: 'clean' | 'maintenance'): Promise<any>;\n  \n  // Customer Report Methods\n  getGeneralReport(customerId: string, period: string, module?: 'clean' | 'maintenance'): Promise<any>;\n  getSLAAnalysis(customerId: string, period: string, module?: 'clean' | 'maintenance'): Promise<any>;\n  getProductivityReport(customerId: string, period: string, module?: 'clean' | 'maintenance'): Promise<any>;\n  getOperatorPerformance(customerId: string, period: string, module?: 'clean' | 'maintenance'): Promise<any>;\n  getLocationAnalysis(customerId: string, period: string, module?: 'clean' | 'maintenance'): Promise<any>;\n  getTemporalAnalysis(customerId: string, period: string, module?: 'clean' | 'maintenance'): Promise<any>;\n\n  // Zones\n  getZonesByCompany(companyId: string, module?: 'clean' | 'maintenance'): Promise<Zone[]>;\n  getZonesBySite(siteId: string, module?: 'clean' | 'maintenance'): Promise<Zone[]>;\n  getZone(id: string): Promise<Zone | undefined>;\n  createZone(zone: InsertZone): Promise<Zone>;\n  updateZone(id: string, zone: Partial<InsertZone>): Promise<Zone>;\n  deleteZone(id: string): Promise<void>;\n\n  // QR Code Points\n  getQrCodePointsByCompany(companyId: string, module?: 'clean' | 'maintenance'): Promise<QrCodePoint[]>;\n  getQrCodePointsByCustomer(customerId: string, module?: 'clean' | 'maintenance'): Promise<any[]>;\n  \n  // Customer-specific resources\n  getCleaningActivitiesByCustomer(customerId: string, module?: 'clean' | 'maintenance'): Promise<CleaningActivity[]>;\n  getServicesByCustomer(customerId: string, module?: 'clean' | 'maintenance'): Promise<Service[]>;\n  getUsersByCustomer(customerId: string): Promise<User[]>;\n  getChecklistTemplatesByCustomer(customerId: string, module?: 'clean' | 'maintenance'): Promise<ChecklistTemplate[]>;\n  getQrCodePointsByZone(zoneId: string): Promise<QrCodePoint[]>;\n  getQrCodePoint(id: string): Promise<QrCodePoint | undefined>;\n  getQrCodePointByCode(code: string): Promise<QrCodePoint | undefined>;\n  createQrCodePoint(qrCodePoint: InsertQrCodePoint): Promise<QrCodePoint>;\n  updateQrCodePoint(id: string, qrCodePoint: Partial<InsertQrCodePoint>): Promise<QrCodePoint>;\n  deleteQrCodePoint(id: string): Promise<void>;\n  \n  // QR Code Resolution\n  resolveQrCode(code: string): Promise<{\n    qrPoint: QrCodePoint;\n    zone: Zone;\n    site: Site;\n    company: Company;\n    customer: Customer;\n    services: Service[];\n    defaultService?: Service;\n    checklist?: ChecklistTemplate;\n  } | null>;\n\n  // Users\n  getUsers(): Promise<User[]>;\n  getUsersByCompany(companyId: string): Promise<User[]>;\n  getUser(id: string): Promise<User | undefined>;\n  getUserByUsername(username: string): Promise<User | undefined>;\n  getUserByEmail(email: string): Promise<User | undefined>;\n  createUser(user: InsertUser): Promise<User>;\n  updateUser(id: string, user: Partial<InsertUser>): Promise<User>;\n  deleteUser(id: string): Promise<void>;\n\n  // Services\n  getServicesByZone(customerId: string, zoneId: string, module?: 'clean' | 'maintenance'): Promise<Service[]>;\n  getService(id: string): Promise<Service | undefined>;\n  createService(service: InsertService): Promise<Service>;\n  updateService(id: string, service: Partial<InsertService>): Promise<Service>;\n  deleteService(id: string): Promise<void>;\n\n  // Service Zones\n  getServiceZonesByZone(zoneId: string): Promise<ServiceZone[]>;\n  getServiceZonesByService(serviceId: string): Promise<ServiceZone[]>;\n  createServiceZone(serviceZone: InsertServiceZone): Promise<ServiceZone>;\n  deleteServiceZone(serviceId: string, zoneId: string): Promise<void>;\n\n  // Service Types\n  getServiceTypesByCustomer(customerId: string, module?: 'clean' | 'maintenance'): Promise<ServiceType[]>;\n  getServiceType(id: string): Promise<ServiceType | undefined>;\n  createServiceType(serviceType: InsertServiceType): Promise<ServiceType>;\n  updateServiceType(id: string, serviceType: Partial<InsertServiceType>): Promise<ServiceType>;\n  deleteServiceType(id: string): Promise<void>;\n\n  // Service Categories\n  // CATEGORIAS - INTERFACE COMENTADA\n  /* getServiceCategoriesByCustomer(customerId: string, module?: 'clean' | 'maintenance'): Promise<ServiceCategory[]>;\n  getServiceCategoriesByType(typeId: string): Promise<ServiceCategory[]>;\n  getServiceCategory(id: string): Promise<ServiceCategory | undefined>;\n  createServiceCategory(serviceCategory: InsertServiceCategory): Promise<ServiceCategory>;\n  updateServiceCategory(id: string, serviceCategory: Partial<InsertServiceCategory>): Promise<ServiceCategory>;\n  deleteServiceCategory(id: string): Promise<void>; */\n\n  // Checklist Templates\n  getChecklistTemplatesByCompany(companyId: string, module?: 'clean' | 'maintenance'): Promise<ChecklistTemplate[]>;\n  getChecklistTemplate(id: string): Promise<ChecklistTemplate | undefined>;\n  getChecklistTemplateByServiceId(serviceId: string): Promise<ChecklistTemplate | undefined>;\n  createChecklistTemplate(template: InsertChecklistTemplate): Promise<ChecklistTemplate>;\n  updateChecklistTemplate(id: string, template: Partial<InsertChecklistTemplate>): Promise<ChecklistTemplate>;\n  deleteChecklistTemplate(id: string): Promise<void>;\n  getWorkOrdersByChecklistTemplate(checklistTemplateId: string): Promise<WorkOrder[]>;\n\n  // SLA Configs\n  getSlaConfigsByCompany(companyId: string, module?: 'clean' | 'maintenance'): Promise<SlaConfig[]>;\n  getSlaConfig(id: string): Promise<SlaConfig | undefined>;\n  createSlaConfig(slaConfig: InsertSlaConfig): Promise<SlaConfig>;\n  updateSlaConfig(id: string, slaConfig: Partial<InsertSlaConfig>): Promise<SlaConfig>;\n\n  // Cleaning Activities\n  getCleaningActivitiesByCompany(companyId: string, module?: 'clean' | 'maintenance'): Promise<CleaningActivity[]>;\n  getCleaningActivity(id: string): Promise<CleaningActivity | undefined>;\n  createCleaningActivity(activity: InsertCleaningActivity): Promise<CleaningActivity>;\n  updateCleaningActivity(id: string, activity: Partial<InsertCleaningActivity>): Promise<CleaningActivity>;\n  deleteCleaningActivity(id: string): Promise<void>;\n\n  // Maintenance Activities\n  getMaintenanceActivitiesByCustomer(customerId: string): Promise<MaintenanceActivity[]>;\n  getMaintenanceActivitiesByCompany(companyId: string): Promise<MaintenanceActivity[]>;\n  getMaintenanceActivity(id: string): Promise<MaintenanceActivity | undefined>;\n  createMaintenanceActivity(activity: InsertMaintenanceActivity): Promise<MaintenanceActivity>;\n  updateMaintenanceActivity(id: string, activity: Partial<InsertMaintenanceActivity>): Promise<MaintenanceActivity>;\n  deleteMaintenanceActivity(id: string): Promise<void>;\n  \n  // Scheduler functions\n  expandOccurrences(activity: CleaningActivity, windowStart: Date, windowEnd: Date): Date[];\n  generateScheduledWorkOrders(companyId: string, windowStart: Date, windowEnd: Date): Promise<WorkOrder[]>;\n  generateMaintenanceWorkOrders(companyId: string, windowStart: Date, windowEnd: Date): Promise<WorkOrder[]>;\n\n  // Work Orders\n  getWorkOrdersByCompany(companyId: string, module?: 'clean' | 'maintenance'): Promise<WorkOrder[]>;\n  getWorkOrdersByUser(userId: string): Promise<WorkOrder[]>;\n  getWorkOrder(id: string): Promise<WorkOrder | undefined>;\n  createWorkOrder(workOrder: InsertWorkOrder): Promise<WorkOrder>;\n  updateWorkOrder(id: string, workOrder: Partial<InsertWorkOrder>): Promise<WorkOrder>;\n  getNextWorkOrderNumber(companyId: string): Promise<number>;\n  reopenWorkOrder(workOrderId: string, userId: string, reason: string, attachments?: any): Promise<WorkOrder>;\n\n  // Work Order Comments\n  getWorkOrderComments(workOrderId: string): Promise<WorkOrderComment[]>;\n  createWorkOrderComment(comment: InsertWorkOrderComment): Promise<WorkOrderComment>;\n  deleteWorkOrderComment(id: string): Promise<void>;\n\n  // Bathroom Counters\n  getBathroomCounterByZone(zoneId: string): Promise<BathroomCounter | undefined>;\n  createBathroomCounter(counter: InsertBathroomCounter): Promise<BathroomCounter>;\n  updateBathroomCounter(id: string, counter: Partial<InsertBathroomCounter>): Promise<BathroomCounter>;\n  incrementBathroomCounter(zoneId: string): Promise<BathroomCounter>;\n\n  // Webhook Configs\n  getWebhookConfigsByCompany(companyId: string): Promise<WebhookConfig[]>;\n  getWebhookConfig(id: string): Promise<WebhookConfig | undefined>;\n  createWebhookConfig(config: InsertWebhookConfig): Promise<WebhookConfig>;\n  updateWebhookConfig(id: string, config: Partial<InsertWebhookConfig>): Promise<WebhookConfig>;\n\n  // Dashboard stats\n  getDashboardStats(companyId: string, period?: string, siteId?: string): Promise<{\n    openWorkOrders: number;\n    overdueWorkOrders: number;\n    completedWorkOrders: number;\n    slaCompliance: number;\n    areaCleanedToday: number;\n    activeOperators: number;\n    totalSites: number;\n    totalZones: number;\n    efficiency: number;\n    qualityIndex: number | null;\n    ratedCount: number;\n  }>;\n\n  // Performance analytics\n  getPerformanceAnalytics(companyId: string, period?: string, siteId?: string): Promise<{\n    daily: Array<{\n      date: string;\n      efficiency: number;\n      completed: number;\n      total: number;\n    }>;\n    statusBreakdown: Array<{\n      status: string;\n      count: number;\n      percentage: number;\n    }>;\n    weeklyActivity: Array<{\n      day: string;\n      count: number;\n    }>;\n    priorityBreakdown: Array<{\n      priority: string;\n      count: number;\n    }>;\n    locationBreakdown: Array<{\n      zone: string;\n      count: number;\n    }>;\n    averageCompletionTime: number;\n    completedIn24h: number;\n    completedIn4h: number;\n  }>;\n\n  // Dashboard Goals\n  getDashboardGoals(companyId: string, module?: 'clean' | 'maintenance'): Promise<DashboardGoal[]>;\n  createDashboardGoal(goal: InsertDashboardGoal): Promise<DashboardGoal>;\n  updateDashboardGoal(id: string, goal: Partial<InsertDashboardGoal>): Promise<DashboardGoal>;\n  deleteDashboardGoal(id: string): Promise<void>;\n\n  // Customers\n  getCustomersByCompany(companyId: string): Promise<Customer[]>;\n  getCustomer(id: string): Promise<Customer | undefined>;\n  createCustomer(customer: InsertCustomer): Promise<Customer>;\n  updateCustomer(id: string, customer: Partial<InsertCustomer>): Promise<Customer>;\n  deleteCustomer(id: string): Promise<void>;\n\n  // Custom Roles\n  getCustomRoles(): Promise<CustomRoleWithPermissions[]>;\n  getCustomRoleById(id: string): Promise<CustomRoleWithPermissions | undefined>;\n  createCustomRole(role: InsertCustomRole): Promise<CustomRoleWithPermissions>;\n  updateCustomRole(id: string, role: Partial<InsertCustomRole>): Promise<CustomRoleWithPermissions>;\n  deleteCustomRole(id: string): Promise<void>;\n  setRolePermissions(roleId: string, permissions: string[]): Promise<void>;\n  getUserRoles(userId: string): Promise<UserRoleAssignment[]>;\n  getUserRoleAssignments(userId: string): Promise<UserRoleAssignment[]>;\n  getRolePermissions(roleId: string): Promise<RolePermission[]>;\n  createUserRoleAssignment(assignment: InsertUserRoleAssignment): Promise<UserRoleAssignment>;\n\n  // System Users (OPUS employees)\n  getOpusUsers(): Promise<User[]>;\n\n  // User Site Assignments\n  getUserSiteAssignments(userId: string): Promise<UserSiteAssignment[]>;\n  getUsersBySite(siteId: string): Promise<User[]>;\n  createUserSiteAssignment(assignment: InsertUserSiteAssignment): Promise<UserSiteAssignment>;\n  deleteUserSiteAssignment(userId: string, siteId: string): Promise<void>;\n\n  // Public Request Logs (spam control)\n  createPublicRequestLog(log: InsertPublicRequestLog): Promise<PublicRequestLog>;\n  checkRecentPublicRequests(ipHash: string, qrCodePointId: string, hoursWindow: number): Promise<number>;\n\n  // Site Shifts\n  getSiteShifts(siteId: string): Promise<SiteShift[]>;\n  createSiteShift(shift: InsertSiteShift): Promise<SiteShift>;\n  updateSiteShift(id: string, shift: Partial<InsertSiteShift>): Promise<SiteShift>;\n  deleteSiteShift(id: string): Promise<void>;\n\n  // Bathroom Counter Logs (auditing)\n  createBathroomCounterLog(log: InsertBathroomCounterLog): Promise<BathroomCounterLog>;\n  getBathroomCounterLogs(zoneId: string, limit?: number): Promise<BathroomCounterLog[]>;\n\n  // Company Counters (sequential numbering)\n  getCompanyCounter(companyId: string, key: string): Promise<CompanyCounter | undefined>;\n  createCompanyCounter(counter: InsertCompanyCounter): Promise<CompanyCounter>;\n  incrementCompanyCounter(companyId: string, key: string): Promise<number>;\n\n  // Reports Metrics\n  getReportsMetrics(companyId: string, period: string): Promise<{\n    completedWorkOrders: number;\n    completedWorkOrdersChange: string;\n    averageSLA: number;\n    averageSLAChange: string;\n    totalAreaCleaned: number;\n    totalAreaCleanedChange: string;\n    averageExecutionTime: number;\n    averageExecutionTimeChange: string;\n  }>;\n  getWorkOrdersStatusDistribution(companyId: string, period: string): Promise<{\n    status: string;\n    count: number;\n    label: string;\n    color: string;\n  }[]>;\n  getSLAPerformanceBreakdown(companyId: string, period: string): Promise<{\n    totalSLA: number;\n    categories: {\n      category: string;\n      percentage: number;\n      color: string;\n      label: string;\n    }[];\n  }>;\n\n  // ============================================================================\n  // MAINTENANCE MODULE - Equipment\n  // ============================================================================\n  getEquipmentByCustomer(customerId: string, module?: 'clean' | 'maintenance'): Promise<Equipment[]>;\n  getEquipmentBySite(siteId: string, module?: 'clean' | 'maintenance'): Promise<Equipment[]>;\n  getEquipmentByZone(zoneId: string, module?: 'clean' | 'maintenance'): Promise<Equipment[]>;\n  getEquipment(id: string): Promise<Equipment | undefined>;\n  createEquipment(equipment: InsertEquipment): Promise<Equipment>;\n  updateEquipment(id: string, equipment: Partial<InsertEquipment>): Promise<Equipment>;\n  deleteEquipment(id: string): Promise<void>;\n\n  // Maintenance Checklist Templates\n  getMaintenanceChecklistTemplatesByCustomer(customerId: string, module?: 'clean' | 'maintenance'): Promise<MaintenanceChecklistTemplate[]>;\n  getMaintenanceChecklistTemplatesByEquipmentType(customerId: string, equipmentType: string, module?: 'clean' | 'maintenance'): Promise<MaintenanceChecklistTemplate[]>;\n  getMaintenanceChecklistTemplatesByEquipment(equipmentId: string): Promise<MaintenanceChecklistTemplate[]>;\n  getMaintenanceChecklistTemplate(id: string): Promise<MaintenanceChecklistTemplate | undefined>;\n  createMaintenanceChecklistTemplate(template: InsertMaintenanceChecklistTemplate): Promise<MaintenanceChecklistTemplate>;\n  updateMaintenanceChecklistTemplate(id: string, template: Partial<InsertMaintenanceChecklistTemplate>): Promise<MaintenanceChecklistTemplate>;\n  deleteMaintenanceChecklistTemplate(id: string): Promise<void>;\n\n  // Maintenance Checklist Executions\n  getMaintenanceChecklistExecutionsByEquipment(equipmentId: string): Promise<MaintenanceChecklistExecution[]>;\n  getMaintenanceChecklistExecutionsByWorkOrder(workOrderId: string): Promise<MaintenanceChecklistExecution[]>;\n  getMaintenanceChecklistExecution(id: string): Promise<MaintenanceChecklistExecution | undefined>;\n  createMaintenanceChecklistExecution(execution: InsertMaintenanceChecklistExecution): Promise<MaintenanceChecklistExecution>;\n  updateMaintenanceChecklistExecution(id: string, execution: Partial<InsertMaintenanceChecklistExecution>): Promise<MaintenanceChecklistExecution>;\n  deleteMaintenanceChecklistExecution(id: string): Promise<void>;\n\n  // Maintenance Plans\n  getMaintenancePlansByCustomer(customerId: string, module?: 'clean' | 'maintenance'): Promise<MaintenancePlan[]>;\n  getMaintenancePlan(id: string): Promise<MaintenancePlan | undefined>;\n  createMaintenancePlan(plan: InsertMaintenancePlan): Promise<MaintenancePlan>;\n  updateMaintenancePlan(id: string, plan: Partial<InsertMaintenancePlan>): Promise<MaintenancePlan>;\n  deleteMaintenancePlan(id: string): Promise<void>;\n\n  // Maintenance Plan Equipments\n  getMaintenancePlanEquipmentsByPlan(planId: string): Promise<MaintenancePlanEquipment[]>;\n  getMaintenancePlanEquipmentsByEquipment(equipmentId: string): Promise<MaintenancePlanEquipment[]>;\n  getMaintenancePlanEquipment(id: string): Promise<MaintenancePlanEquipment | undefined>;\n  createMaintenancePlanEquipment(planEquipment: InsertMaintenancePlanEquipment): Promise<MaintenancePlanEquipment>;\n  updateMaintenancePlanEquipment(id: string, planEquipment: Partial<InsertMaintenancePlanEquipment>): Promise<MaintenancePlanEquipment>;\n  deleteMaintenancePlanEquipment(id: string): Promise<void>;\n}\n\nexport class DatabaseStorage implements IStorage {\n  // Companies\n  async getCompanies(): Promise<Company[]> {\n    return await db.select().from(companies).orderBy(companies.name);\n  }\n\n  async getCompany(id: string): Promise<Company | undefined> {\n    const [company] = await db.select().from(companies).where(eq(companies.id, id));\n    return company;\n  }\n\n  async createCompany(company: InsertCompany): Promise<Company> {\n    const [newCompany] = await db.insert(companies).values(company).returning();\n    return newCompany;\n  }\n\n  async updateCompany(id: string, company: Partial<InsertCompany>): Promise<Company> {\n    const [updatedCompany] = await db.update(companies)\n      .set({ ...company, updatedAt: sql`now()` })\n      .where(eq(companies.id, id))\n      .returning();\n    return updatedCompany;\n  }\n\n  // Sites\n  async getSitesByCompany(companyId: string, module?: 'clean' | 'maintenance'): Promise<Site[]> {\n    const whereCondition = module\n      ? and(eq(sites.companyId, companyId), eq(sites.module, module))\n      : eq(sites.companyId, companyId);\n    \n    return await db.select().from(sites)\n      .where(whereCondition)\n      .orderBy(sites.name);\n  }\n\n  async getSitesByCustomer(customerId: string, module?: 'clean' | 'maintenance'): Promise<Site[]> {\n    const whereCondition = module\n      ? and(eq(sites.customerId, customerId), eq(sites.module, module))\n      : eq(sites.customerId, customerId);\n    \n    return await db.select().from(sites)\n      .where(whereCondition)\n      .orderBy(sites.name);\n  }\n\n  // Customer-filtered methods\n\n  async getWorkOrdersByCustomer(customerId: string, module?: 'clean' | 'maintenance'): Promise<WorkOrder[]> {\n    // Get sites for this customer (filter by module if provided)\n    const sitesWhereCondition = module\n      ? and(eq(sites.customerId, customerId), eq(sites.module, module))\n      : eq(sites.customerId, customerId);\n    \n    const customerSites = await db.select().from(sites).where(sitesWhereCondition);\n    const siteIds = customerSites.map(site => site.id);\n    \n    if (siteIds.length === 0) {\n      return [];\n    }\n    \n    // Get zones for these sites (filter by module if provided)\n    let siteWhereCondition = eq(zones.siteId, siteIds[0]);\n    for (let i = 1; i < siteIds.length; i++) {\n      siteWhereCondition = sql`${siteWhereCondition} OR ${zones.siteId} = ${siteIds[i]}`;\n    }\n    \n    const zonesWhereCondition = module\n      ? and(siteWhereCondition, eq(zones.module, module))\n      : siteWhereCondition;\n    \n    const customerZones = await db.select().from(zones).where(zonesWhereCondition);\n    const zoneIds = customerZones.map(zone => zone.id);\n    \n    if (zoneIds.length === 0) {\n      return [];\n    }\n    \n    // Get work orders for these zones (filter by module if provided)\n    let zoneWhereCondition = eq(workOrders.zoneId, zoneIds[0]);\n    for (let i = 1; i < zoneIds.length; i++) {\n      zoneWhereCondition = sql`${zoneWhereCondition} OR ${workOrders.zoneId} = ${zoneIds[i]}`;\n    }\n    \n    const whereConditions = module \n      ? and(zoneWhereCondition, eq(workOrders.module, module))\n      : zoneWhereCondition;\n    \n    return await db.select()\n      .from(workOrders)\n      .where(whereConditions)\n      .orderBy(desc(workOrders.createdAt));\n  }\n\n  async getDashboardStatsByCustomer(customerId: string, period: string, site: string, module?: 'clean' | 'maintenance'): Promise<any> {\n    // Get customer sites for filtering (filter by module if provided)\n    const sitesWhereCondition = module\n      ? and(eq(sites.customerId, customerId), eq(sites.module, module))\n      : eq(sites.customerId, customerId);\n    \n    const customerSites = await db.select().from(sites).where(sitesWhereCondition);\n    if (customerSites.length === 0) {\n      return {\n        openWorkOrders: 0,\n        completedWorkOrders: 0,\n        overdueWorkOrders: 0,\n        totalSites: 0,\n        totalZones: 0,\n        slaCompliance: 0,\n        areaCleanedToday: 0,\n        activeOperators: 0,\n        efficiency: 0,\n        qualityIndex: 0\n      };\n    }\n\n    const siteIds = customerSites.map(site => site.id);\n    \n    // Get zones for customer sites only (filter by module if provided)\n    const zonesWhereCondition = module\n      ? and(inArray(zones.siteId, siteIds), eq(zones.module, module))\n      : inArray(zones.siteId, siteIds);\n    \n    const customerZones = await db.select().from(zones)\n      .where(zonesWhereCondition);\n    const zoneIds = customerZones.map(zone => zone.id);\n\n    if (zoneIds.length === 0) {\n      return {\n        openWorkOrders: 0,\n        completedWorkOrders: 0,\n        overdueWorkOrders: 0,\n        totalSites: customerSites.length,\n        totalZones: 0,\n        slaCompliance: 0,\n        areaCleanedToday: 0,\n        activeOperators: 0,\n        efficiency: 0,\n        qualityIndex: 0\n      };\n    }\n\n    // Calculate date range based on period\n    let dateFilter = sql`true`; // Default: no date filter\n    if (period === 'hoje') {\n      dateFilter = sql`DATE(${workOrders.createdAt}) = CURRENT_DATE`;\n    } else if (period === 'ontem') {\n      dateFilter = sql`DATE(${workOrders.createdAt}) = CURRENT_DATE - INTERVAL '1 day'`;\n    } else if (period === 'semana') {\n      dateFilter = sql`${workOrders.createdAt} >= CURRENT_DATE - INTERVAL '7 days'`;\n    } else if (period === 'mes') {\n      dateFilter = sql`${workOrders.createdAt} >= CURRENT_DATE - INTERVAL '30 days'`;\n    }\n    // If period is 'total' or 'todos', no date filter\n\n    // Module filter - apply to all queries\n    const moduleFilter = module ? eq(workOrders.module, module) : sql`true`;\n\n    // Get work orders only for customer zones with period filter and module filter\n    const [openWO] = await db.select({ count: count() })\n      .from(workOrders)\n      .where(and(\n        inArray(workOrders.zoneId, zoneIds),\n        moduleFilter,\n        eq(workOrders.status, 'aberta'),\n        dateFilter\n      ));\n\n    const [completedWO] = await db.select({ count: count() })\n      .from(workOrders)\n      .where(and(\n        inArray(workOrders.zoneId, zoneIds),\n        moduleFilter,\n        eq(workOrders.status, 'concluida'),\n        dateFilter\n      ));\n\n    // Calculate overdue work orders: open work orders with dueDate < NOW()\n    const [overdueWO] = await db.select({ count: count() })\n      .from(workOrders)\n      .where(and(\n        inArray(workOrders.zoneId, zoneIds),\n        moduleFilter,\n        eq(workOrders.status, 'aberta'),\n        sql`${workOrders.dueDate} < NOW()`,\n        dateFilter\n      ));\n\n    // Get users for customer sites\n    const companyId = customerSites[0].companyId;\n    const users = await this.getUsersByCompany(companyId);\n\n    // Calculate quality index from customer ratings\n    const ratedWorkOrders = await db.select({ customerRating: workOrders.customerRating })\n      .from(workOrders)\n      .where(and(\n        inArray(workOrders.zoneId, zoneIds),\n        moduleFilter,\n        isNotNull(workOrders.customerRating)\n      ));\n    \n    let qualityIndex = null;\n    let ratedCount = 0;\n    if (ratedWorkOrders.length > 0) {\n      const totalRating = ratedWorkOrders.reduce((sum, wo) => sum + (wo.customerRating || 0), 0);\n      qualityIndex = parseFloat((totalRating / ratedWorkOrders.length).toFixed(1));\n      ratedCount = ratedWorkOrders.length;\n    }\n\n    // Calculate SLA Compliance\n    const completedOnTime = await db\n      .select({ count: count() })\n      .from(workOrders)\n      .where(and(\n        inArray(workOrders.zoneId, zoneIds),\n        moduleFilter,\n        eq(workOrders.status, 'concluida'),\n        sql`${workOrders.completedAt} <= ${workOrders.dueDate}`,\n        dateFilter\n      ));\n    \n    const slaCompliance = completedWO.count > 0 \n      ? Math.round((completedOnTime[0].count / completedWO.count) * 100) \n      : 0;\n\n    return {\n      openWorkOrders: openWO.count,\n      completedWorkOrders: completedWO.count,\n      overdueWorkOrders: overdueWO.count,\n      totalSites: customerSites.length,\n      totalZones: customerZones.length,\n      slaCompliance,\n      areaCleanedToday: 0,\n      activeOperators: users.length,\n      efficiency: completedWO.count > 0 ? Math.round((completedWO.count / (completedWO.count + openWO.count + overdueWO.count)) * 100) : 0,\n      qualityIndex,\n      ratedCount\n    };\n  }\n\n  // 1. RELATÓRIO GERAL - Visão completa das operações com todos os KPIs principais\n  async getGeneralReport(customerId: string, period: string, module?: 'clean' | 'maintenance'): Promise<any> {\n    const sitesWhereCondition = module\n      ? and(eq(sites.customerId, customerId), eq(sites.module, module))\n      : eq(sites.customerId, customerId);\n\n    const customerSites = await db.select().from(sites).where(sitesWhereCondition);\n    if (customerSites.length === 0) {\n      return {\n        overview: { totalWorkOrders: 0, completedWorkOrders: 0, pendingWorkOrders: 0, overdueWorkOrders: 0 },\n        efficiency: { overallEfficiency: 0, qualityIndex: 0, resourceUtilization: 0 },\n        financial: { totalCost: 0, costPerWorkOrder: 0, budgetUtilization: 0 },\n        compliance: { slaCompliance: 0, safetyIncidents: 0, qualityScore: 0 }\n      };\n    }\n\n    const siteIds = customerSites.map(site => site.id);\n\n    const zonesWhereCondition = module\n      ? and(inArray(zones.siteId, siteIds), eq(zones.module, module))\n      : inArray(zones.siteId, siteIds);\n\n    const customerZones = await db.select().from(zones).where(zonesWhereCondition);\n    const zoneIds = customerZones.map(zone => zone.id);\n    \n    if (zoneIds.length === 0) {\n      return { overview: {}, efficiency: {}, financial: {}, compliance: {} };\n    }\n\n    // Filter by module if provided\n    const whereConditions = module \n      ? and(inArray(workOrders.zoneId, zoneIds), eq(workOrders.module, module))\n      : inArray(workOrders.zoneId, zoneIds);\n      \n    const customerWorkOrders = await db.select().from(workOrders).where(whereConditions);\n    const total = customerWorkOrders.length;\n    const completed = customerWorkOrders.filter(wo => wo.status === 'concluida').length;\n    const pending = customerWorkOrders.filter(wo => wo.status === 'aberta').length;\n    // Note: 'vencida' status doesn't exist in schema\n    const overdue = 0;\n\n    return {\n      overview: {\n        totalWorkOrders: total,\n        completedWorkOrders: completed,\n        pendingWorkOrders: pending,\n        overdueWorkOrders: overdue,\n        completionRate: total > 0 ? Math.round((completed / total) * 100) : 0\n      },\n      efficiency: {\n        overallEfficiency: total > 0 ? Math.round((completed / total) * 100) : 0,\n        qualityIndex: Math.round(Math.random() * 30 + 70), // Simulated: 70-100\n        resourceUtilization: Math.round(Math.random() * 20 + 75), // Simulated: 75-95\n        averageCompletionTime: Math.round(Math.random() * 60 + 120) // Simulated: 120-180 min\n      },\n      financial: {\n        totalCost: completed * 85.50, // R$ 85.50 por OS\n        costPerWorkOrder: 85.50,\n        budgetUtilization: Math.round(Math.random() * 15 + 80), // 80-95%\n        savings: completed * 12.30 // Economia de R$ 12.30 por OS\n      },\n      compliance: {\n        slaCompliance: total > 0 ? Math.round((completed / total) * 100) : 0,\n        safetyIncidents: Math.floor(Math.random() * 3), // 0-2 incidentes\n        qualityScore: Math.round(Math.random() * 15 + 85), // 85-100\n        auditScore: Math.round(Math.random() * 10 + 90) // 90-100\n      }\n    };\n  }\n\n  // 2. ANÁLISE DE SLA - Performance detalhada de cumprimento de prazos\n  async getSLAAnalysis(customerId: string, period: string, module?: 'clean' | 'maintenance'): Promise<any> {\n    const sitesWhereCondition = module\n      ? and(eq(sites.customerId, customerId), eq(sites.module, module))\n      : eq(sites.customerId, customerId);\n\n    const customerSites = await db.select().from(sites).where(sitesWhereCondition);\n    if (customerSites.length === 0) {\n      return { slaBreakdown: [], timeDistribution: [], criticalAlerts: [] };\n    }\n\n    const siteIds = customerSites.map(site => site.id);\n\n    const zonesWhereCondition = module\n      ? and(inArray(zones.siteId, siteIds), eq(zones.module, module))\n      : inArray(zones.siteId, siteIds);\n\n    const customerZones = await db.select().from(zones).where(zonesWhereCondition);\n    const zoneIds = customerZones.map(zone => zone.id);\n    \n    if (zoneIds.length === 0) {\n      return { slaBreakdown: [], timeDistribution: [], criticalAlerts: [] };\n    }\n\n    // Filter by module if provided\n    const whereConditions = module \n      ? and(inArray(workOrders.zoneId, zoneIds), eq(workOrders.module, module))\n      : inArray(workOrders.zoneId, zoneIds);\n      \n    const customerWorkOrders = await db.select().from(workOrders).where(whereConditions);\n    const total = customerWorkOrders.length;\n\n    const slaBreakdown = [\n      { category: \"Limpeza Geral\", met: Math.floor(total * 0.85), total: Math.floor(total * 0.4), percentage: 85 },\n      { category: \"Manutenção Preventiva\", met: Math.floor(total * 0.92), total: Math.floor(total * 0.3), percentage: 92 },\n      { category: \"Serviços Especiais\", met: Math.floor(total * 0.78), total: Math.floor(total * 0.2), percentage: 78 },\n      { category: \"Emergências\", met: Math.floor(total * 0.95), total: Math.floor(total * 0.1), percentage: 95 }\n    ];\n\n    const timeDistribution = [\n      { range: \"0-2h\", count: Math.floor(total * 0.45), percentage: 45 },\n      { range: \"2-4h\", count: Math.floor(total * 0.30), percentage: 30 },\n      { range: \"4-8h\", count: Math.floor(total * 0.15), percentage: 15 },\n      { range: \"+8h\", count: Math.floor(total * 0.10), percentage: 10 }\n    ];\n\n    return {\n      slaBreakdown,\n      timeDistribution,\n      averageResponseTime: \"2h 15min\",\n      criticalAlerts: total > 0 ? Math.floor(total * 0.05) : 0,\n      onTimeCompletion: total > 0 ? Math.round((customerWorkOrders.filter(wo => wo.status === 'concluida').length / total) * 100) : 0\n    };\n  }\n\n  // 3. PRODUTIVIDADE - Métricas de eficiência e produtividade operacional\n  async getProductivityReport(customerId: string, period: string, module?: 'clean' | 'maintenance'): Promise<any> {\n    const sitesWhereCondition = module\n      ? and(eq(sites.customerId, customerId), eq(sites.module, module))\n      : eq(sites.customerId, customerId);\n\n    const customerSites = await db.select().from(sites).where(sitesWhereCondition);\n    if (customerSites.length === 0) {\n      return { productivity: {}, efficiency: {}, trends: [] };\n    }\n\n    const siteIds = customerSites.map(site => site.id);\n\n    const zonesWhereCondition = module\n      ? and(inArray(zones.siteId, siteIds), eq(zones.module, module))\n      : inArray(zones.siteId, siteIds);\n\n    const customerZones = await db.select().from(zones).where(zonesWhereCondition);\n    const zoneIds = customerZones.map(zone => zone.id);\n    \n    if (zoneIds.length === 0) {\n      return { productivity: {}, efficiency: {}, trends: [] };\n    }\n\n    // Calcular data limite baseado no período\n    const periodDays = parseInt(period) || 30;\n    const startDate = new Date();\n    startDate.setDate(startDate.getDate() - periodDays);\n\n    // Filter by module if provided\n    const whereConditions = module \n      ? and(inArray(workOrders.zoneId, zoneIds), eq(workOrders.module, module))\n      : inArray(workOrders.zoneId, zoneIds);\n\n    // Buscar WOs no período\n    const customerWorkOrders = await db.select().from(workOrders).where(whereConditions);\n    const periodWorkOrders = customerWorkOrders.filter(wo => {\n      const woDate = wo.createdAt ? new Date(wo.createdAt) : new Date();\n      return woDate >= startDate;\n    });\n\n    const completed = periodWorkOrders.filter(wo => wo.status === 'concluida');\n    const completedCount = completed.length;\n    const total = periodWorkOrders.length;\n\n    // Buscar operadores ativos\n    const companyId = customerSites[0].companyId;\n    const allUsers = await db.select().from(users).where(eq(users.companyId, companyId));\n    const operators = allUsers.filter(u => u.role === 'operador' || u.role === 'supervisor_site');\n    const operatorCount = operators.length || 1;\n\n    // MÉTRICAS DE PRODUTIVIDADE REAIS\n    \n    // 1. OS por Dia (REAL)\n    const workOrdersPerDay = periodDays > 0 ? Math.round(completedCount / periodDays) : 0;\n\n    // 2. Tempo Médio de Conclusão (REAL - calculado de startedAt até completedAt)\n    let averageCompletionTime = 0;\n    const completedWithTimes = completed.filter(wo => wo.startedAt && wo.completedAt);\n    if (completedWithTimes.length > 0) {\n      const totalMinutes = completedWithTimes.reduce((sum, wo) => {\n        const start = new Date(wo.startedAt!).getTime();\n        const end = new Date(wo.completedAt!).getTime();\n        const minutes = (end - start) / (1000 * 60);\n        return sum + (minutes > 0 ? minutes : 0);\n      }, 0);\n      averageCompletionTime = Math.round(totalMinutes / completedWithTimes.length);\n    }\n\n    // 3. Área Limpa por Hora (REAL - baseado em áreas das zonas)\n    const totalArea = customerZones.reduce((sum, zone) => {\n      const area = zone.areaM2 ? parseFloat(zone.areaM2) : 0;\n      return sum + area;\n    }, 0);\n    const totalHours = completedWithTimes.length > 0 ? completedWithTimes.reduce((sum, wo) => {\n      const start = new Date(wo.startedAt!).getTime();\n      const end = new Date(wo.completedAt!).getTime();\n      return sum + ((end - start) / (1000 * 60 * 60));\n    }, 0) : 1;\n    const areaCleanedPerHour = totalHours > 0 ? Math.round(totalArea / totalHours) : 0;\n\n    // 4. Tarefas por Operador (REAL)\n    const tasksPerOperator = Math.round(completedCount / operatorCount);\n\n    // 5. Score de Qualidade (REAL - baseado em SLA compliance e ratings)\n    const onTimeWork = periodWorkOrders.filter(wo => {\n      if (!wo.dueDate || !wo.completedAt) return false;\n      return new Date(wo.completedAt) <= new Date(wo.dueDate);\n    }).length;\n    const qualityScore = total > 0 ? Math.round((onTimeWork / total) * 100) : 0;\n\n    const productivity = {\n      workOrdersPerDay,\n      averageCompletionTime,\n      areaCleanedPerHour,\n      tasksPerOperator,\n      qualityScore\n    };\n\n    // MÉTRICAS DE EFICIÊNCIA (baseadas em dados reais)\n    \n    // 1. Utilização de Recursos (% de operadores com WOs ativas)\n    const activeOperators = new Set(periodWorkOrders.filter(wo => wo.assignedUserId).map(wo => wo.assignedUserId)).size;\n    const resourceUtilization = operatorCount > 0 ? Math.round((activeOperators / operatorCount) * 100) : 0;\n\n    // 2. Uptime de Equipamentos (% de WOs completadas no prazo)\n    const equipmentUptime = total > 0 ? Math.round((onTimeWork / total) * 100) : 0;\n\n    // 3. Desperdício de Material (% de WOs atrasadas)\n    const lateWork = total - onTimeWork;\n    const materialWaste = total > 0 ? Math.round((lateWork / total) * 100) : 0;\n\n    // 4. Consumo de Energia (estimativa baseada em horas trabalhadas * consumo médio)\n    const energyConsumption = Math.round(totalHours * 15); // 15 kWh por hora de trabalho\n\n    // 5. Eficiência de Custo (baseado em SLA compliance)\n    const onTime = periodWorkOrders.filter(wo => {\n      if (!wo.dueDate || !wo.completedAt) return false;\n      return new Date(wo.completedAt) <= new Date(wo.dueDate);\n    }).length;\n    const costEfficiency = total > 0 ? Math.round((onTime / total) * 100) : 0;\n\n    const efficiency = {\n      resourceUtilization,\n      equipmentUptime,\n      materialWaste,\n      energyConsumption,\n      costEfficiency\n    };\n\n    // TENDÊNCIAS MENSAIS (REAIS - últimos 6 meses)\n    const trends = [];\n    const monthNames = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];\n    \n    for (let i = 5; i >= 0; i--) {\n      const monthDate = new Date();\n      monthDate.setMonth(monthDate.getMonth() - i);\n      const month = monthDate.getMonth();\n      const year = monthDate.getFullYear();\n      \n      const monthWorkOrders = customerWorkOrders.filter(wo => {\n        const woDate = wo.createdAt ? new Date(wo.createdAt) : new Date();\n        return woDate.getMonth() === month && woDate.getFullYear() === year;\n      });\n      \n      const monthCompleted = monthWorkOrders.filter(wo => wo.status === 'concluida').length;\n      const monthTotal = monthWorkOrders.length;\n      const monthOnTime = monthWorkOrders.filter(wo => {\n        if (!wo.dueDate || !wo.completedAt) return false;\n        return new Date(wo.completedAt) <= new Date(wo.dueDate);\n      }).length;\n      \n      // Produtividade do mês (% de conclusão)\n      const monthProductivity = monthTotal > 0 ? Math.round((monthCompleted / monthTotal) * 100) : 0;\n      \n      // Eficiência do mês (% completadas no prazo)\n      const monthEfficiency = monthTotal > 0 ? Math.round((monthOnTime / monthTotal) * 100) : 0;\n      \n      trends.push({\n        month: monthNames[month],\n        productivity: monthProductivity,\n        efficiency: monthEfficiency\n      });\n    }\n\n    return { productivity, efficiency, trends };\n  }\n\n  // 4. PERFORMANCE DE OPERADORES - Análise individual e comparativa\n  async getOperatorPerformance(customerId: string, period: string, module?: 'clean' | 'maintenance'): Promise<any> {\n    const sitesWhereCondition = module\n      ? and(eq(sites.customerId, customerId), eq(sites.module, module))\n      : eq(sites.customerId, customerId);\n\n    const customerSites = await db.select().from(sites).where(sitesWhereCondition);\n    if (customerSites.length === 0) {\n      return { operators: [], rankings: [], teamStats: {} };\n    }\n\n    const customerUsers = await db.select().from(users).where(eq(users.companyId, customerSites[0].companyId));\n    const operators = customerUsers.filter(user => user.role === 'operador' || user.role === 'supervisor_site');\n\n    const operatorsData = operators.map((op, index) => ({\n      id: op.id,\n      name: op.name,\n      tasksCompleted: Math.floor(Math.random() * 50 + 20), // 20-70 tarefas\n      efficiency: Math.round(Math.random() * 20 + 75), // 75-95%\n      qualityScore: Math.round(Math.random() * 15 + 80), // 80-95\n      punctuality: Math.round(Math.random() * 10 + 88), // 88-98%\n      experienceLevel: index < 2 ? \"Senior\" : index < 4 ? \"Pleno\" : \"Junior\",\n      certification: Math.random() > 0.3 ? \"Ativo\" : \"Pendente\"\n    }));\n\n    const rankings = [\n      { position: 1, operator: \"Maria Silva\", score: 94.5, improvement: \"+2.1%\" },\n      { position: 2, operator: \"João Santos\", score: 91.2, improvement: \"+1.8%\" },\n      { position: 3, operator: \"Ana Costa\", score: 89.7, improvement: \"-0.5%\" }\n    ];\n\n    const teamStats = {\n      totalOperators: operators.length,\n      averageEfficiency: Math.round(Math.random() * 10 + 85), // 85-95%\n      topPerformer: operatorsData[0]?.name || \"N/A\",\n      improvementNeeded: Math.floor(operators.length * 0.2), // 20% precisam melhoria\n      trainingCompleted: Math.floor(operators.length * 0.8) // 80% completaram treinamento\n    };\n\n    return { operators: operatorsData, rankings, teamStats };\n  }\n\n  // 5. ANÁLISE POR LOCAIS - Distribuição e performance por zona e site\n  async getLocationAnalysis(customerId: string, period: string, module?: 'clean' | 'maintenance'): Promise<any> {\n    const sitesWhereCondition = module\n      ? and(eq(sites.customerId, customerId), eq(sites.module, module))\n      : eq(sites.customerId, customerId);\n\n    const customerSites = await db.select().from(sites).where(sitesWhereCondition);\n    if (customerSites.length === 0) {\n      return { sites: [], zones: [], heatmap: [] };\n    }\n\n    const siteIds = customerSites.map(site => site.id);\n\n    const zonesWhereCondition = module\n      ? and(inArray(zones.siteId, siteIds), eq(zones.module, module))\n      : inArray(zones.siteId, siteIds);\n\n    const customerZones = await db.select().from(zones).where(zonesWhereCondition);\n    \n    const sitesData = await Promise.all(customerSites.map(async (site) => {\n      const siteZones = customerZones.filter(zone => zone.siteId === site.id);\n      const zoneIds = siteZones.map(zone => zone.id);\n      const siteWorkOrders = zoneIds.length > 0 ? \n        await db.select().from(workOrders).where(inArray(workOrders.zoneId, zoneIds)) : [];\n      \n      return {\n        id: site.id,\n        name: site.name,\n        totalZones: siteZones.length,\n        totalWorkOrders: siteWorkOrders.length,\n        completedWorkOrders: siteWorkOrders.filter(wo => wo.status === 'concluida').length,\n        efficiency: siteWorkOrders.length > 0 ? \n          Math.round((siteWorkOrders.filter(wo => wo.status === 'concluida').length / siteWorkOrders.length) * 100) : 0,\n        area: Math.round(Math.random() * 2000 + 1000), // 1000-3000 m²\n        utilizationRate: Math.round(Math.random() * 30 + 65) // 65-95%\n      };\n    }));\n\n    const zonesData = await Promise.all(customerZones.map(async (zone) => {\n      const zoneWorkOrders = await db.select().from(workOrders).where(eq(workOrders.zoneId, zone.id));\n      \n      return {\n        id: zone.id,\n        name: zone.name,\n        siteId: zone.siteId,\n        siteName: customerSites.find(s => s.id === zone.siteId)?.name || \"N/A\",\n        totalWorkOrders: zoneWorkOrders.length,\n        completedWorkOrders: zoneWorkOrders.filter(wo => wo.status === 'concluida').length,\n        averageTime: Math.round(Math.random() * 60 + 60), // 60-120 min\n        priority: zone.category ? (zone.category === 'critica' ? 'Alta' : zone.category === 'comum' ? 'Média' : 'Baixa') : 'Média',\n        lastCleaning: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]\n      };\n    }));\n\n    return { sites: sitesData, zones: zonesData, heatmap: [] };\n  }\n\n  // 6. ANÁLISE TEMPORAL - Tendências e padrões ao longo do tempo  \n  async getTemporalAnalysis(customerId: string, period: string, module?: 'clean' | 'maintenance'): Promise<any> {\n    const sitesWhereCondition = module\n      ? and(eq(sites.customerId, customerId), eq(sites.module, module))\n      : eq(sites.customerId, customerId);\n\n    const customerSites = await db.select().from(sites).where(sitesWhereCondition);\n    if (customerSites.length === 0) {\n      return { trends: [], patterns: [], forecasts: [] };\n    }\n\n    const siteIds = customerSites.map(site => site.id);\n\n    const zonesWhereCondition = module\n      ? and(inArray(zones.siteId, siteIds), eq(zones.module, module))\n      : inArray(zones.siteId, siteIds);\n\n    const customerZones = await db.select().from(zones).where(zonesWhereCondition);\n    const zoneIds = customerZones.map(zone => zone.id);\n    \n    if (zoneIds.length === 0) {\n      return { trends: [], patterns: [], forecasts: [] };\n    }\n\n    const customerWorkOrders = await db.select().from(workOrders).where(inArray(workOrders.zoneId, zoneIds));\n    const completed = customerWorkOrders.filter(wo => wo.status === 'concluida').length;\n\n    // Tendências mensais dos últimos 6 meses\n    const trends = [\n      { period: \"Jan 2025\", workOrders: Math.floor(completed * 0.8), efficiency: 82, cost: 15420 },\n      { period: \"Fev 2025\", workOrders: Math.floor(completed * 0.9), efficiency: 85, cost: 16890 },\n      { period: \"Mar 2025\", workOrders: Math.floor(completed * 1.1), efficiency: 88, cost: 18350 },\n      { period: \"Abr 2025\", workOrders: Math.floor(completed * 1.0), efficiency: 87, cost: 17680 },\n      { period: \"Mai 2025\", workOrders: Math.floor(completed * 1.2), efficiency: 91, cost: 19240 },\n      { period: \"Jun 2025\", workOrders: completed, efficiency: 94, cost: 20150 }\n    ];\n\n    // Padrões por dia da semana\n    const patterns = [\n      { day: \"Segunda\", avgWorkOrders: Math.floor(completed / 4), peak: \"08:00-10:00\" },\n      { day: \"Terça\", avgWorkOrders: Math.floor(completed / 3.5), peak: \"09:00-11:00\" },\n      { day: \"Quarta\", avgWorkOrders: Math.floor(completed / 3.8), peak: \"08:30-10:30\" },\n      { day: \"Quinta\", avgWorkOrders: Math.floor(completed / 4.2), peak: \"09:00-11:00\" },\n      { day: \"Sexta\", avgWorkOrders: Math.floor(completed / 5), peak: \"07:30-09:30\" }\n    ];\n\n    // Previsões para próximos meses\n    const forecasts = [\n      { period: \"Jul 2025\", predicted: Math.floor(completed * 1.1), confidence: 87 },\n      { period: \"Ago 2025\", predicted: Math.floor(completed * 1.15), confidence: 82 },\n      { period: \"Set 2025\", predicted: Math.floor(completed * 1.08), confidence: 79 }\n    ];\n\n    return { trends, patterns, forecasts };\n  }\n\n  async getAnalyticsByCustomer(customerId: string, period: string, site: string, module?: 'clean' | 'maintenance'): Promise<any> {\n    // Get customer-specific analytics\n    const sitesWhereCondition = module\n      ? and(eq(sites.customerId, customerId), eq(sites.module, module))\n      : eq(sites.customerId, customerId);\n\n    const customerSites = await db.select().from(sites).where(sitesWhereCondition);\n    if (customerSites.length === 0) {\n      return {\n        workOrdersData: [],\n        statusBreakdown: [],\n        daily: [],\n        slaPerformance: {}\n      };\n    }\n\n    const siteIds = customerSites.map(site => site.id);\n\n    const zonesWhereCondition = module\n      ? and(inArray(zones.siteId, siteIds), eq(zones.module, module))\n      : inArray(zones.siteId, siteIds);\n\n    const customerZones = await db.select().from(zones)\n      .where(zonesWhereCondition);\n    const zoneIds = customerZones.map(zone => zone.id);\n\n    if (zoneIds.length === 0) {\n      return {\n        workOrdersData: [],\n        statusBreakdown: [],\n        daily: [],\n        slaPerformance: {}\n      };\n    }\n\n    // Calculate date range based on period\n    let dateFilter = sql`true`; // Default: no date filter\n    let previousDateFilter = sql`false`; // Previous period for comparison\n    \n    if (period === 'hoje') {\n      dateFilter = sql`DATE(${workOrders.createdAt}) = CURRENT_DATE`;\n      previousDateFilter = sql`DATE(${workOrders.createdAt}) = CURRENT_DATE - INTERVAL '1 day'`;\n    } else if (period === 'ontem') {\n      dateFilter = sql`DATE(${workOrders.createdAt}) = CURRENT_DATE - INTERVAL '1 day'`;\n      previousDateFilter = sql`DATE(${workOrders.createdAt}) = CURRENT_DATE - INTERVAL '2 days'`;\n    } else if (period === 'semana') {\n      dateFilter = sql`${workOrders.createdAt} >= CURRENT_DATE - INTERVAL '7 days'`;\n      previousDateFilter = sql`${workOrders.createdAt} >= CURRENT_DATE - INTERVAL '14 days' AND ${workOrders.createdAt} < CURRENT_DATE - INTERVAL '7 days'`;\n    } else if (period === 'mes') {\n      dateFilter = sql`${workOrders.createdAt} >= CURRENT_DATE - INTERVAL '30 days'`;\n      previousDateFilter = sql`${workOrders.createdAt} >= CURRENT_DATE - INTERVAL '60 days' AND ${workOrders.createdAt} < CURRENT_DATE - INTERVAL '30 days'`;\n    }\n\n    // Module filter - apply to all queries\n    const moduleFilter = module ? eq(workOrders.module, module) : sql`true`;\n\n    // Get work orders for customer zones only with period filter and module filter\n    const customerWorkOrders = await db.select()\n      .from(workOrders)\n      .where(and(\n        inArray(workOrders.zoneId, zoneIds),\n        moduleFilter,\n        dateFilter\n      ))\n      .orderBy(desc(workOrders.createdAt));\n\n    // Get previous period work orders for comparison\n    const previousWorkOrders = await db.select()\n      .from(workOrders)\n      .where(and(\n        inArray(workOrders.zoneId, zoneIds),\n        moduleFilter,\n        previousDateFilter\n      ));\n\n    // Generate status breakdown\n    const statusCounts = {\n      aberta: 0,\n      concluida: 0,\n      vencida: 0\n    };\n\n    const previousStatusCounts = {\n      aberta: 0,\n      concluida: 0,\n      vencida: 0\n    };\n\n    customerWorkOrders.forEach(wo => {\n      statusCounts[wo.status as keyof typeof statusCounts]++;\n    });\n\n    previousWorkOrders.forEach(wo => {\n      previousStatusCounts[wo.status as keyof typeof statusCounts]++;\n    });\n\n    const total = customerWorkOrders.length;\n    const statusBreakdown = Object.entries(statusCounts).map(([status, count]) => ({\n      status,\n      count,\n      percentage: total > 0 ? Math.round((count / total) * 100) : 0\n    }));\n\n    // Calculate real daily data from database (last 30 days)\n    const dailyDataRaw = await db\n      .select({\n        date: sql<string>`TO_CHAR(DATE(${workOrders.createdAt}), 'YYYY-MM-DD')`.as('date'),\n        completed: sql<number>`COUNT(CASE WHEN ${workOrders.status} = 'concluida' THEN 1 END)`.as('completed'),\n        total: sql<number>`COUNT(*)`.as('total'),\n      })\n      .from(workOrders)\n      .where(and(\n        inArray(workOrders.zoneId, zoneIds),\n        moduleFilter,\n        sql`${workOrders.createdAt} >= CURRENT_DATE - INTERVAL '30 days'`\n      ))\n      .groupBy(sql`DATE(${workOrders.createdAt})`)\n      .orderBy(sql`DATE(${workOrders.createdAt})`);\n\n    const daily = dailyDataRaw.map(d => ({\n      date: d.date,\n      efficiency: d.total > 0 ? Math.round((d.completed / d.total) * 100) : 0,\n      completed: d.completed,\n      total: d.total\n    }));\n\n    // Priority breakdown - agregação por prioridade (APENAS ABERTAS E VENCIDAS)\n    const priorityDataRaw = await db\n      .select({\n        priority: workOrders.priority,\n        count: sql<number>`COUNT(*)`.as('count')\n      })\n      .from(workOrders)\n      .where(and(\n        inArray(workOrders.zoneId, zoneIds),\n        moduleFilter,\n        ne(workOrders.status, 'concluida'), // Excluir concluídas\n        dateFilter\n      ))\n      .groupBy(workOrders.priority);\n\n    const activeTotal = priorityDataRaw.reduce((sum, p) => sum + Number(p.count), 0);\n    const priorityBreakdown = priorityDataRaw.map(p => ({\n      priority: p.priority || 'baixa',\n      count: Number(p.count),\n      percentage: activeTotal > 0 ? Math.round((Number(p.count) / activeTotal) * 100) : 0\n    }));\n\n    // Location breakdown - agregação por zona (APENAS ABERTAS E VENCIDAS)\n    const locationDataRaw = await db\n      .select({\n        zoneId: workOrders.zoneId,\n        zoneName: zones.name,\n        count: sql<number>`COUNT(*)`.as('count')\n      })\n      .from(workOrders)\n      .innerJoin(zones, eq(workOrders.zoneId, zones.id))\n      .where(and(\n        inArray(workOrders.zoneId, zoneIds),\n        moduleFilter,\n        ne(workOrders.status, 'concluida'), // Excluir concluídas\n        dateFilter\n      ))\n      .groupBy(workOrders.zoneId, zones.name);\n\n    const locationTotal = locationDataRaw.reduce((sum, l) => sum + Number(l.count), 0);\n    const locationBreakdown = locationDataRaw.map(l => ({\n      location: l.zoneName || 'Sem zona',\n      count: Number(l.count),\n      percentage: locationTotal > 0 ? Math.round((Number(l.count) / locationTotal) * 100) : 0\n    }));\n\n    // Weekday breakdown - agregação por dia da semana (em português)\n    const weekdayDataRaw = await db\n      .select({\n        weekday: sql<number>`EXTRACT(DOW FROM ${workOrders.scheduledDate})`.as('weekday'),\n        count: sql<number>`COUNT(*)`.as('count')\n      })\n      .from(workOrders)\n      .where(and(\n        inArray(workOrders.zoneId, zoneIds),\n        moduleFilter,\n        dateFilter\n      ))\n      .groupBy(sql`EXTRACT(DOW FROM ${workOrders.scheduledDate})`);\n\n    // Map days to Portuguese\n    const dayMap: Record<number, string> = {\n      0: 'Domingo',\n      1: 'Segunda',\n      2: 'Terça',\n      3: 'Quarta',\n      4: 'Quinta',\n      5: 'Sexta',\n      6: 'Sábado'\n    };\n\n    const weekdayBreakdown = weekdayDataRaw.map(w => ({\n      day: dayMap[w.weekday] || 'Desconhecido',\n      count: Number(w.count)\n    }));\n\n    // Calculate real area cleaned from zones\n    const areaData = await db\n      .select({\n        totalArea: sql<number>`COALESCE(SUM(${zones.areaM2}), 0)`.as('totalArea')\n      })\n      .from(workOrders)\n      .innerJoin(zones, eq(workOrders.zoneId, zones.id))\n      .where(and(\n        inArray(workOrders.zoneId, zoneIds),\n        moduleFilter,\n        eq(workOrders.status, 'concluida'),\n        dateFilter\n      ));\n\n    const previousAreaData = await db\n      .select({\n        totalArea: sql<number>`COALESCE(SUM(${zones.areaM2}), 0)`.as('totalArea')\n      })\n      .from(workOrders)\n      .innerJoin(zones, eq(workOrders.zoneId, zones.id))\n      .where(and(\n        inArray(workOrders.zoneId, zoneIds),\n        moduleFilter,\n        eq(workOrders.status, 'concluida'),\n        previousDateFilter\n      ));\n\n    const totalAreaCleaned = Math.round(areaData[0]?.totalArea || 0);\n    const previousAreaCleaned = Math.round(previousAreaData[0]?.totalArea || 0);\n\n    // Calculate real average execution time (in minutes)\n    const avgTimeData = await db\n      .select({\n        avgMinutes: sql<number>`COALESCE(AVG(EXTRACT(EPOCH FROM (${workOrders.completedAt} - ${workOrders.createdAt})) / 60), 0)`.as('avgMinutes')\n      })\n      .from(workOrders)\n      .where(and(\n        inArray(workOrders.zoneId, zoneIds),\n        moduleFilter,\n        eq(workOrders.status, 'concluida'),\n        sql`${workOrders.completedAt} IS NOT NULL`,\n        dateFilter\n      ));\n\n    const previousAvgTimeData = await db\n      .select({\n        avgMinutes: sql<number>`COALESCE(AVG(EXTRACT(EPOCH FROM (${workOrders.completedAt} - ${workOrders.createdAt})) / 60), 0)`.as('avgMinutes')\n      })\n      .from(workOrders)\n      .where(and(\n        inArray(workOrders.zoneId, zoneIds),\n        moduleFilter,\n        eq(workOrders.status, 'concluida'),\n        sql`${workOrders.completedAt} IS NOT NULL`,\n        previousDateFilter\n      ));\n\n    const averageExecutionTime = Math.round(avgTimeData[0]?.avgMinutes || 0);\n    const previousAvgTime = Math.round(previousAvgTimeData[0]?.avgMinutes || 0);\n\n    // Calculate percentage changes\n    const calculateChange = (current: number, previous: number): string => {\n      if (previous === 0) return current > 0 ? \"+100%\" : \"0%\";\n      const change = Math.round(((current - previous) / previous) * 100);\n      return change >= 0 ? `+${change}%` : `${change}%`;\n    };\n\n    const completedWorkOrdersChange = calculateChange(statusCounts.concluida, previousStatusCounts.concluida);\n    const averageSLAChange = calculateChange(\n      total > 0 ? Math.round((statusCounts.concluida / total) * 100) : 0,\n      previousWorkOrders.length > 0 ? Math.round((previousStatusCounts.concluida / previousWorkOrders.length) * 100) : 0\n    );\n    const totalAreaCleanedChange = calculateChange(totalAreaCleaned, previousAreaCleaned);\n    const averageExecutionTimeChange = calculateChange(averageExecutionTime, previousAvgTime);\n\n    return {\n      // Dados compatíveis com o frontend - TODOS REAIS DO BANCO\n      completedWorkOrders: statusCounts.concluida,\n      completedWorkOrdersChange,\n      averageSLA: total > 0 ? Math.round((statusCounts.concluida / total) * 100) : 0,\n      averageSLAChange,\n      totalAreaCleaned,\n      totalAreaCleanedChange,\n      averageExecutionTime,\n      averageExecutionTimeChange,\n      \n      // Dados adicionais para outros usos\n      statusBreakdown,\n      daily,\n      priorityBreakdown,\n      locationBreakdown,\n      weekdayBreakdown,\n      slaPerformance: {\n        totalSLA: total,\n        categories: []\n      }\n    };\n  }\n\n  async getSite(id: string): Promise<Site | undefined> {\n    const [site] = await db.select().from(sites).where(eq(sites.id, id));\n    return site;\n  }\n\n  async createSite(site: InsertSite): Promise<Site> {\n    const [newSite] = await db.insert(sites).values({\n      ...site,\n      id: crypto.randomUUID(),\n    }).returning();\n    return newSite;\n  }\n\n  async updateSite(id: string, site: Partial<InsertSite>): Promise<Site> {\n    const [updatedSite] = await db.update(sites)\n      .set({ ...site, updatedAt: sql`now()` })\n      .where(eq(sites.id, id))\n      .returning();\n    return updatedSite;\n  }\n\n  async deleteSite(id: string): Promise<void> {\n    // Exclusão em cascata com estratégia mais agressiva\n    \n    // 1. Primeiro, obter todas as zonas do site\n    const siteZones = await db.select({ id: zones.id }).from(zones).where(eq(zones.siteId, id));\n    const zoneIds = siteZones.map(z => z.id);\n    \n    if (zoneIds.length === 0) {\n      // Se não há zonas, apenas deletar o site\n      await db.delete(sites).where(eq(sites.id, id));\n      return;\n    }\n\n    // 2. Obter todas as cleaning_activities das zonas do site\n    const siteCleaningActivities = await db.select({ id: cleaningActivities.id })\n      .from(cleaningActivities)\n      .where(inArray(cleaningActivities.zoneId, zoneIds));\n    const cleaningActivityIds = siteCleaningActivities.map(ca => ca.id);\n\n    // 3. ABORDAGEM AGRESSIVA: Deletar TODOS os work_orders que fazem referência a essas cleaning_activities\n    if (cleaningActivityIds.length > 0) {\n      // Deletar por cleaning_activity_id\n      await db.delete(workOrders).where(inArray(workOrders.cleaningActivityId, cleaningActivityIds));\n    }\n    \n    // 4. Deletar work_orders que fazem referência direta às zonas\n    await db.delete(workOrders).where(inArray(workOrders.zoneId, zoneIds));\n    \n    // 5. Agora deletar todas as dependências das zonas\n    await db.delete(cleaningActivities).where(inArray(cleaningActivities.zoneId, zoneIds));\n    await db.delete(qrCodePoints).where(inArray(qrCodePoints.zoneId, zoneIds));\n    await db.delete(serviceZones).where(inArray(serviceZones.zoneId, zoneIds));\n    \n    // 6. Deletar dependências do site\n    await db.delete(userSiteAssignments).where(eq(userSiteAssignments.siteId, id));\n    await db.delete(siteShifts).where(eq(siteShifts.siteId, id));\n    \n    // 7. Deletar zonas e site\n    await db.delete(zones).where(eq(zones.siteId, id));\n    await db.delete(sites).where(eq(sites.id, id));\n  }\n\n  // Zones\n  async getZonesByCompany(companyId: string, module?: 'clean' | 'maintenance'): Promise<Zone[]> {\n    // Get sites for this company, filtering by module if provided\n    const siteWhereCondition = module\n      ? and(eq(sites.companyId, companyId), eq(sites.module, module))\n      : eq(sites.companyId, companyId);\n    \n    const companySites = await db.select().from(sites).where(siteWhereCondition);\n    \n    // Filter zones by company sites\n    const siteIds = companySites.map(site => site.id);\n    \n    if (siteIds.length === 0) {\n      return [];\n    }\n    \n    // Use OR conditions for each siteId\n    let whereCondition = eq(zones.siteId, siteIds[0]);\n    for (let i = 1; i < siteIds.length; i++) {\n      whereCondition = sql`${whereCondition} OR ${zones.siteId} = ${siteIds[i]}`;\n    }\n    \n    return await db.select()\n      .from(zones)\n      .where(whereCondition)\n      .orderBy(zones.name);\n  }\n\n  async getZonesByCustomer(customerId: string, module?: 'clean' | 'maintenance'): Promise<Zone[]> {\n    // Get sites for this customer, filtering by module if provided\n    const siteWhereCondition = module\n      ? and(eq(sites.customerId, customerId), eq(sites.module, module))\n      : eq(sites.customerId, customerId);\n    \n    const customerSites = await db.select().from(sites).where(siteWhereCondition);\n    \n    // Filter zones by customer sites\n    const siteIds = customerSites.map(site => site.id);\n    \n    if (siteIds.length === 0) {\n      return [];\n    }\n    \n    // Use OR conditions for each siteId\n    let whereCondition = eq(zones.siteId, siteIds[0]);\n    for (let i = 1; i < siteIds.length; i++) {\n      whereCondition = sql`${whereCondition} OR ${zones.siteId} = ${siteIds[i]}`;\n    }\n    \n    return await db.select()\n      .from(zones)\n      .where(whereCondition)\n      .orderBy(zones.name);\n  }\n\n  async getCleaningActivitiesByCustomer(customerId: string, module?: 'clean' | 'maintenance'): Promise<CleaningActivity[]> {\n    // Get sites for this customer\n    const customerSites = await db.select().from(sites).where(eq(sites.customerId, customerId));\n    const siteIds = customerSites.map(site => site.id);\n    \n    if (siteIds.length === 0) {\n      return [];\n    }\n    \n    // Get zones for these sites\n    let zonesWhereCondition = eq(zones.siteId, siteIds[0]);\n    for (let i = 1; i < siteIds.length; i++) {\n      zonesWhereCondition = sql`${zonesWhereCondition} OR ${zones.siteId} = ${siteIds[i]}`;\n    }\n    \n    const customerZones = await db.select().from(zones).where(zonesWhereCondition);\n    const zoneIds = customerZones.map(zone => zone.id);\n    \n    if (zoneIds.length === 0) {\n      return [];\n    }\n    \n    // Get cleaning activities for these zones\n    let activitiesWhereCondition = eq(cleaningActivities.zoneId, zoneIds[0]);\n    for (let i = 1; i < zoneIds.length; i++) {\n      activitiesWhereCondition = sql`${activitiesWhereCondition} OR ${cleaningActivities.zoneId} = ${zoneIds[i]}`;\n    }\n    \n    // Apply module filter if provided\n    const whereConditions = module\n      ? and(activitiesWhereCondition, eq(cleaningActivities.module, module))\n      : activitiesWhereCondition;\n    \n    return await db.select()\n      .from(cleaningActivities)\n      .where(whereConditions)\n      .orderBy(cleaningActivities.name);\n  }\n\n\n  async getUsersByCustomer(customerId: string): Promise<User[]> {\n    // Get users that belong to this specific customer:\n    // 1. Users directly associated with this customer (customer_user with customerId)\n    // 2. Opus users assigned to this customer (opus_user with assignedClientId)\n    return await db.select().from(users)\n      .where(\n        or(\n          eq(users.customerId, customerId),\n          eq(users.assignedClientId, customerId)\n        )\n      )\n      .orderBy(users.name);\n  }\n\n  async getChecklistTemplatesByCustomer(customerId: string, module?: 'clean' | 'maintenance'): Promise<ChecklistTemplate[]> {\n    // Get customer sites to determine their company\n    const customerSites = await db.select().from(sites).where(eq(sites.customerId, customerId));\n    \n    if (customerSites.length === 0) {\n      return [];\n    }\n\n    const companyId = customerSites[0].companyId;\n    const siteIds = customerSites.map(site => site.id);\n    \n    // Return checklist templates that are either:\n    // 1. Global to the company (siteId is null) \n    // 2. Specific to this customer's sites\n    const conditions = [\n      eq(checklistTemplates.companyId, companyId),\n      or(\n        isNull(checklistTemplates.siteId),\n        inArray(checklistTemplates.siteId, siteIds)\n      )\n    ];\n    \n    if (module) {\n      conditions.push(eq(checklistTemplates.module, module));\n    }\n    \n    const results = await db.select().from(checklistTemplates)\n      .where(and(...conditions))\n      .orderBy(checklistTemplates.createdAt);\n      \n    return results;\n  }\n\n  async getZonesBySite(siteId: string, module?: 'clean' | 'maintenance'): Promise<Zone[]> {\n    const whereCondition = module\n      ? and(eq(zones.siteId, siteId), eq(zones.module, module))\n      : eq(zones.siteId, siteId);\n    \n    return await db.select().from(zones)\n      .where(whereCondition)\n      .orderBy(zones.name);\n  }\n\n  async getZone(id: string): Promise<Zone | undefined> {\n    const [zone] = await db.select().from(zones).where(eq(zones.id, id));\n    return zone;\n  }\n\n  async createZone(zone: InsertZone): Promise<Zone> {\n    const [newZone] = await db.insert(zones).values({\n      ...zone,\n      id: crypto.randomUUID(),\n    }).returning();\n    return newZone;\n  }\n\n  async updateZone(id: string, zone: Partial<InsertZone>): Promise<Zone> {\n    const [updatedZone] = await db.update(zones)\n      .set({ ...zone, updatedAt: sql`now()` })\n      .where(eq(zones.id, id))\n      .returning();\n    return updatedZone;\n  }\n\n  async deleteZone(id: string): Promise<void> {\n    // Delete all related QR code points first\n    await db.delete(qrCodePoints).where(eq(qrCodePoints.zoneId, id));\n    \n    // Delete the zone\n    await db.delete(zones).where(eq(zones.id, id));\n  }\n\n  // QR Code Points\n  async getQrCodePointsByCompany(companyId: string, module?: 'clean' | 'maintenance'): Promise<QrCodePoint[]> {\n    // Get all sites for this company, filtered by module if provided\n    const sitesFilter = module \n      ? and(eq(sites.companyId, companyId), eq(sites.module, module))\n      : eq(sites.companyId, companyId);\n    const companySites = await db.select().from(sites).where(sitesFilter);\n    const siteIds = companySites.map(site => site.id);\n    \n    if (siteIds.length === 0) {\n      return [];\n    }\n    \n    // Get all zones for these sites, filtered by module if provided\n    let whereCondition = eq(zones.siteId, siteIds[0]);\n    for (let i = 1; i < siteIds.length; i++) {\n      whereCondition = sql`${whereCondition} OR ${zones.siteId} = ${siteIds[i]}`;\n    }\n    if (module) {\n      whereCondition = and(whereCondition, eq(zones.module, module));\n    }\n    \n    const companyZones = await db.select().from(zones).where(whereCondition);\n    const zoneIds = companyZones.map(zone => zone.id);\n    \n    if (zoneIds.length === 0) {\n      return [];\n    }\n    \n    // Get all QR code points for these zones with zone info, filtered by module if provided\n    let qrWhereCondition = eq(qrCodePoints.zoneId, zoneIds[0]);\n    for (let i = 1; i < zoneIds.length; i++) {\n      qrWhereCondition = sql`${qrWhereCondition} OR ${qrCodePoints.zoneId} = ${zoneIds[i]}`;\n    }\n    if (module) {\n      qrWhereCondition = and(qrWhereCondition, eq(qrCodePoints.module, module));\n    }\n    \n    const qrPoints = await db.select({\n      id: qrCodePoints.id,\n      zoneId: qrCodePoints.zoneId,\n      serviceId: qrCodePoints.serviceId,\n      code: qrCodePoints.code,\n      type: qrCodePoints.type,\n      name: qrCodePoints.name,\n      description: qrCodePoints.description,\n      isActive: qrCodePoints.isActive,\n      createdAt: qrCodePoints.createdAt,\n      updatedAt: qrCodePoints.updatedAt,\n      zoneName: zones.name,\n      siteAddress: sites.address,\n    })\n    .from(qrCodePoints)\n    .leftJoin(zones, eq(qrCodePoints.zoneId, zones.id))\n    .leftJoin(sites, eq(zones.siteId, sites.id))\n    .where(qrWhereCondition)\n    .orderBy(qrCodePoints.name);\n    \n    return qrPoints as any[];\n  }\n\n  async getQrCodePointsByCustomer(customerId: string, module?: 'clean' | 'maintenance'): Promise<any[]> {\n    // Get all sites for this customer, filtered by module if provided\n    const sitesFilter = module \n      ? and(eq(sites.customerId, customerId), eq(sites.module, module))\n      : eq(sites.customerId, customerId);\n    const customerSites = await db.select().from(sites).where(sitesFilter);\n    const siteIds = customerSites.map(site => site.id);\n    \n    if (siteIds.length === 0) {\n      return [];\n    }\n    \n    // Get all zones for these sites, filtered by module if provided\n    let whereCondition = eq(zones.siteId, siteIds[0]);\n    for (let i = 1; i < siteIds.length; i++) {\n      whereCondition = sql`${whereCondition} OR ${zones.siteId} = ${siteIds[i]}`;\n    }\n    if (module) {\n      whereCondition = and(whereCondition, eq(zones.module, module));\n    }\n    \n    const customerZones = await db.select().from(zones).where(whereCondition);\n    const zoneIds = customerZones.map(zone => zone.id);\n    \n    if (zoneIds.length === 0) {\n      return [];\n    }\n    \n    // Get all QR code points for these zones with zone info, filtered by module if provided\n    let qrWhereCondition = eq(qrCodePoints.zoneId, zoneIds[0]);\n    for (let i = 1; i < zoneIds.length; i++) {\n      qrWhereCondition = sql`${qrWhereCondition} OR ${qrCodePoints.zoneId} = ${zoneIds[i]}`;\n    }\n    if (module) {\n      qrWhereCondition = and(qrWhereCondition, eq(qrCodePoints.module, module));\n    }\n    \n    const qrPoints = await db.select({\n      id: qrCodePoints.id,\n      zoneId: qrCodePoints.zoneId,\n      serviceId: qrCodePoints.serviceId,\n      code: qrCodePoints.code,\n      type: qrCodePoints.type,\n      name: qrCodePoints.name,\n      description: qrCodePoints.description,\n      isActive: qrCodePoints.isActive,\n      createdAt: qrCodePoints.createdAt,\n      updatedAt: qrCodePoints.updatedAt,\n      zoneName: zones.name,\n      siteAddress: sites.address,\n    })\n    .from(qrCodePoints)\n    .leftJoin(zones, eq(qrCodePoints.zoneId, zones.id))\n    .leftJoin(sites, eq(zones.siteId, sites.id))\n    .where(qrWhereCondition)\n    .orderBy(qrCodePoints.name);\n    \n    return qrPoints as any[];\n  }\n\n  async getQrCodePointsByZone(zoneId: string): Promise<QrCodePoint[]> {\n    return await db.select().from(qrCodePoints)\n      .where(eq(qrCodePoints.zoneId, zoneId))\n      .orderBy(qrCodePoints.name);\n  }\n\n  async getQrCodePoint(id: string): Promise<QrCodePoint | undefined> {\n    const [point] = await db.select().from(qrCodePoints).where(eq(qrCodePoints.id, id));\n    return point;\n  }\n\n  async getQrCodePointByCode(code: string): Promise<QrCodePoint | undefined> {\n    const [point] = await db.select().from(qrCodePoints).where(eq(qrCodePoints.code, code));\n    return point;\n  }\n\n  async createQrCodePoint(qrCodePoint: InsertQrCodePoint): Promise<QrCodePoint> {\n    // Garantir que id e code sempre têm valores\n    const qrPointWithDefaults = {\n      id: crypto.randomUUID(),\n      ...qrCodePoint,\n      code: qrCodePoint.code || crypto.randomUUID()\n    };\n    const [newPoint] = await db.insert(qrCodePoints).values([qrPointWithDefaults]).returning();\n    return newPoint;\n  }\n\n  async updateQrCodePoint(id: string, qrCodePoint: Partial<InsertQrCodePoint>): Promise<QrCodePoint> {\n    const [updatedPoint] = await db.update(qrCodePoints)\n      .set({ ...qrCodePoint, updatedAt: sql`now()` })\n      .where(eq(qrCodePoints.id, id))\n      .returning();\n    return updatedPoint;\n  }\n\n  async deleteQrCodePoint(id: string): Promise<void> {\n    await db.delete(qrCodePoints).where(eq(qrCodePoints.id, id));\n  }\n\n  // QR Code Resolution - Get all necessary data for QR code execution\n  async resolveQrCode(code: string): Promise<{\n    qrPoint: QrCodePoint;\n    zone: Zone;\n    site: Site;\n    company: Company;\n    services: Service[];\n    defaultService?: Service;\n    checklist?: ChecklistTemplate;\n  } | null> {\n    try {\n      // Find the QR code point\n      const qrPoint = await this.getQrCodePointByCode(code);\n      if (!qrPoint || !qrPoint.isActive) {\n        return null;\n      }\n\n      // Get zone information\n      const zone = await this.getZone(qrPoint.zoneId);\n      if (!zone || !zone.isActive) {\n        return null;\n      }\n\n      // Get site information\n      const site = await this.getSite(zone.siteId);\n      if (!site || !site.isActive) {\n        return null;\n      }\n\n      // Get company information\n      const company = await this.getCompany(site.companyId);\n      if (!company || !company.isActive) {\n        return null;\n      }\n\n      // Get customer information\n      if (!site.customerId) {\n        console.error(\"Site has no customer assigned\");\n        return null;\n      }\n      \n      const customer = await this.getCustomer(site.customerId);\n      if (!customer || !customer.isActive) {\n        return null;\n      }\n\n      // Get available services for this zone filtered by QR code module\n      const services = await this.getServicesByZone(site.customerId, zone.id, qrPoint.module);\n\n      // Get default service and checklist if specified  \n      let defaultService: Service | undefined;\n      let checklist: ChecklistTemplate | undefined;\n\n      if (qrPoint.serviceId) {\n        try {\n          defaultService = await this.getService(qrPoint.serviceId);\n          if (defaultService && defaultService.isActive) {\n            checklist = await this.getChecklistTemplateByServiceId(defaultService.id);\n          }\n        } catch (error) {\n          console.error(\"Error getting default service/checklist:\", error);\n          // Continue without default service\n        }\n      }\n\n      return {\n        qrPoint,\n        zone,\n        site,\n        company,\n        customer,\n        services: services.filter(s => s.isActive),\n        defaultService,\n        checklist\n      };\n\n    } catch (error) {\n      console.error(\"Error resolving QR code:\", error);\n      return null;\n    }\n  }\n\n  // Users\n  async getUsers(): Promise<User[]> {\n    return await db.select().from(users).orderBy(users.name);\n  }\n\n  async getUsersByCompany(companyId: string): Promise<User[]> {\n    return await db.select().from(users)\n      .where(eq(users.companyId, companyId))\n      .orderBy(users.name);\n  }\n\n  async getUser(id: string): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.id, id));\n    return user;\n  }\n\n  async getUserByUsername(username: string): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.username, username));\n    return user;\n  }\n\n  async getUserByEmail(email: string): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.email, email));\n    return user;\n  }\n\n  async createUser(user: InsertUser): Promise<User> {\n    const [newUser] = await db.insert(users).values(user).returning();\n    return newUser;\n  }\n\n  async updateUser(id: string, user: Partial<InsertUser>): Promise<User> {\n    const updateData = { ...user };\n    \n    // Hash password if it's being updated\n    if (updateData.password) {\n      updateData.password = await bcrypt.hash(updateData.password, 10);\n    }\n    \n    const [updatedUser] = await db.update(users)\n      .set({ ...updateData, updatedAt: sql`now()` })\n      .where(eq(users.id, id))\n      .returning();\n    return updatedUser;\n  }\n\n  async deleteUser(id: string): Promise<void> {\n    // Deletar registros relacionados primeiro para evitar violação de chave estrangeira\n    \n    // 1. Deletar atribuições de funções (roles)\n    await db.delete(userRoleAssignments).where(eq(userRoleAssignments.userId, id));\n    \n    // 2. Deletar atribuições de sites\n    await db.delete(userSiteAssignments).where(eq(userSiteAssignments.userId, id));\n    \n    // 3. Deletar o usuário\n    await db.delete(users).where(eq(users.id, id));\n  }\n\n  // Services\n  async getServicesByCustomer(customerId: string, module?: 'clean' | 'maintenance'): Promise<Service[]> {\n    const whereConditions = module\n      ? and(eq(services.customerId, customerId), eq(services.module, module))\n      : eq(services.customerId, customerId);\n    \n    return await db.select().from(services)\n      .where(whereConditions)\n      .orderBy(services.name);\n  }\n\n  async getServicesByZone(customerId: string, zoneId: string, module?: 'clean' | 'maintenance'): Promise<Service[]> {\n    try {\n      // Return all active services for this customer filtered by module if provided\n      const whereCondition = module\n        ? and(\n            eq(services.customerId, customerId),\n            eq(services.isActive, true),\n            eq(services.module, module)\n          )\n        : and(\n            eq(services.customerId, customerId),\n            eq(services.isActive, true)\n          );\n      \n      const servicesList = await db.select().from(services)\n        .where(whereCondition)\n        .orderBy(services.name);\n        \n      return servicesList;\n        \n    } catch (error) {\n      console.error(\"Error getting services by zone:\", error);\n      return [];\n    }\n  }\n\n  async getService(id: string): Promise<Service | undefined> {\n    const [service] = await db.select().from(services).where(eq(services.id, id));\n    return service;\n  }\n\n  async createService(service: InsertService): Promise<Service> {\n    const [newService] = await db.insert(services).values({\n      ...service,\n      id: crypto.randomUUID(),\n      module: service.module || 'clean', // Default to 'clean' if not specified\n    }).returning();\n    return newService;\n  }\n\n  async updateService(id: string, service: Partial<InsertService>): Promise<Service> {\n    const [updatedService] = await db.update(services)\n      .set({ ...service, updatedAt: sql`now()` })\n      .where(eq(services.id, id))\n      .returning();\n    return updatedService;\n  }\n\n  async deleteService(id: string): Promise<void> {\n    await db.delete(services).where(eq(services.id, id));\n  }\n\n  // Service Zones\n  async getServiceZonesByZone(zoneId: string): Promise<ServiceZone[]> {\n    return await db.select().from(serviceZones)\n      .where(and(\n        eq(serviceZones.zoneId, zoneId),\n        eq(serviceZones.isActive, true)\n      ));\n  }\n\n  async getServiceZonesByService(serviceId: string): Promise<ServiceZone[]> {\n    return await db.select().from(serviceZones)\n      .where(and(\n        eq(serviceZones.serviceId, serviceId),\n        eq(serviceZones.isActive, true)\n      ));\n  }\n\n  async createServiceZone(serviceZone: InsertServiceZone): Promise<ServiceZone> {\n    const [newServiceZone] = await db.insert(serviceZones).values(serviceZone).returning();\n    return newServiceZone;\n  }\n\n  async deleteServiceZone(serviceId: string, zoneId: string): Promise<void> {\n    await db.delete(serviceZones).where(\n      and(\n        eq(serviceZones.serviceId, serviceId),\n        eq(serviceZones.zoneId, zoneId)\n      )\n    );\n  }\n\n  // Service Types\n  async getServiceTypesByCustomer(customerId: string, module?: 'clean' | 'maintenance'): Promise<ServiceType[]> {\n    const whereConditions = module\n      ? and(eq(serviceTypes.customerId, customerId), eq(serviceTypes.module, module))\n      : eq(serviceTypes.customerId, customerId);\n    \n    return await db.select().from(serviceTypes)\n      .where(whereConditions)\n      .orderBy(serviceTypes.name);\n  }\n\n  async getServiceType(id: string): Promise<ServiceType | undefined> {\n    const [serviceType] = await db.select().from(serviceTypes).where(eq(serviceTypes.id, id));\n    return serviceType;\n  }\n\n  async createServiceType(serviceType: InsertServiceType): Promise<ServiceType> {\n    const [newServiceType] = await db.insert(serviceTypes).values({\n      ...serviceType,\n      id: crypto.randomUUID(),\n      module: serviceType.module || 'clean', // Default to 'clean' if not specified\n    }).returning();\n    return newServiceType;\n  }\n\n  async updateServiceType(id: string, serviceType: Partial<InsertServiceType>): Promise<ServiceType> {\n    const [updatedServiceType] = await db.update(serviceTypes)\n      .set({ ...serviceType, updatedAt: sql`now()` })\n      .where(eq(serviceTypes.id, id))\n      .returning();\n    return updatedServiceType;\n  }\n\n  async deleteServiceType(id: string): Promise<void> {\n    // CATEGORIAS - COMENTADO (categorias foram removidas do sistema)\n    // await db.delete(serviceCategories).where(eq(serviceCategories.typeId, id));\n    await db.delete(serviceTypes).where(eq(serviceTypes.id, id));\n  }\n\n  // CATEGORIAS - TODAS AS FUNÇÕES COMENTADAS (MANTER PARA REFERÊNCIA FUTURA)\n  /* async getServiceCategoriesByCustomer(customerId: string, module?: 'clean' | 'maintenance'): Promise<ServiceCategory[]> {\n    const conditions = [eq(serviceCategories.customerId, customerId)];\n    if (module) {\n      conditions.push(eq(serviceCategories.module, module));\n    }\n    return await db.select().from(serviceCategories)\n      .where(and(...conditions))\n      .orderBy(serviceCategories.name);\n  }\n\n  async getServiceCategoriesByType(typeId: string): Promise<ServiceCategory[]> {\n    return await db.select().from(serviceCategories)\n      .where(eq(serviceCategories.typeId, typeId))\n      .orderBy(serviceCategories.name);\n  }\n\n  async getServiceCategory(id: string): Promise<ServiceCategory | undefined> {\n    const [serviceCategory] = await db.select().from(serviceCategories).where(eq(serviceCategories.id, id));\n    return serviceCategory;\n  }\n\n  async createServiceCategory(serviceCategory: InsertServiceCategory): Promise<ServiceCategory> {\n    const [newServiceCategory] = await db.insert(serviceCategories).values({\n      ...serviceCategory,\n      id: crypto.randomUUID(),\n    }).returning();\n    return newServiceCategory;\n  }\n\n  async updateServiceCategory(id: string, serviceCategory: Partial<InsertServiceCategory>): Promise<ServiceCategory> {\n    const [updatedServiceCategory] = await db.update(serviceCategories)\n      .set({ ...serviceCategory, updatedAt: sql`now()` })\n      .where(eq(serviceCategories.id, id))\n      .returning();\n    return updatedServiceCategory;\n  }\n\n  async deleteServiceCategory(id: string): Promise<void> {\n    await db.delete(serviceCategories).where(eq(serviceCategories.id, id));\n  } */\n\n  // Checklist Templates\n  async getChecklistTemplatesByCompany(companyId: string, module?: 'clean' | 'maintenance'): Promise<ChecklistTemplate[]> {\n    const conditions = [eq(checklistTemplates.companyId, companyId)];\n    if (module) {\n      conditions.push(eq(checklistTemplates.module, module));\n    }\n    return await db.select().from(checklistTemplates)\n      .where(and(...conditions))\n      .orderBy(checklistTemplates.name);\n  }\n\n  async getChecklistTemplate(id: string): Promise<ChecklistTemplate | undefined> {\n    const [template] = await db.select().from(checklistTemplates).where(eq(checklistTemplates.id, id));\n    return template;\n  }\n\n  async createChecklistTemplate(template: InsertChecklistTemplate): Promise<ChecklistTemplate> {\n    const id = `checklist-${Date.now()}-${nanoid(10)}`;\n    const [newTemplate] = await db.insert(checklistTemplates).values({\n      ...template,\n      id\n    }).returning();\n    return newTemplate;\n  }\n\n  async updateChecklistTemplate(id: string, template: Partial<InsertChecklistTemplate>): Promise<ChecklistTemplate> {\n    const [updatedTemplate] = await db.update(checklistTemplates)\n      .set({ ...template, updatedAt: sql`now()` })\n      .where(eq(checklistTemplates.id, id))\n      .returning();\n    return updatedTemplate;\n  }\n\n  async deleteChecklistTemplate(id: string): Promise<void> {\n    await db.delete(checklistTemplates).where(eq(checklistTemplates.id, id));\n  }\n\n  async getWorkOrdersByChecklistTemplate(checklistTemplateId: string): Promise<WorkOrder[]> {\n    return await db.select().from(workOrders)\n      .where(eq(workOrders.checklistTemplateId, checklistTemplateId));\n  }\n\n  async getChecklistTemplateByServiceId(serviceId: string): Promise<ChecklistTemplate | undefined> {\n    try {\n      // First try to find a checklist specifically for this service\n      const [serviceSpecificTemplate] = await db.select().from(checklistTemplates)\n        .where(eq(checklistTemplates.serviceId, serviceId))\n        .limit(1);\n\n      if (serviceSpecificTemplate) {\n        return serviceSpecificTemplate;\n      }\n\n      // If no service-specific checklist, return the general one\n      const [generalTemplate] = await db.select().from(checklistTemplates)\n        .where(and(\n          eq(checklistTemplates.companyId, \"company-opus-default\"),\n          isNull(checklistTemplates.serviceId)\n        ))\n        .limit(1);\n\n      return generalTemplate;\n    } catch (error) {\n      console.error('Error getting checklist for service:', error);\n      throw error;\n    }\n  }\n\n  // SLA Configs\n  async getSlaConfigsByCompany(companyId: string, module?: 'clean' | 'maintenance'): Promise<SlaConfig[]> {\n    const conditions = [eq(slaConfigs.companyId, companyId)];\n    if (module) {\n      conditions.push(eq(slaConfigs.module, module));\n    }\n    return await db.select().from(slaConfigs)\n      .where(and(...conditions))\n      .orderBy(slaConfigs.name);\n  }\n\n  async getSlaConfig(id: string): Promise<SlaConfig | undefined> {\n    const [config] = await db.select().from(slaConfigs).where(eq(slaConfigs.id, id));\n    return config;\n  }\n\n  async createSlaConfig(slaConfig: InsertSlaConfig): Promise<SlaConfig> {\n    const [newConfig] = await db.insert(slaConfigs).values(slaConfig).returning();\n    return newConfig;\n  }\n\n  async updateSlaConfig(id: string, slaConfig: Partial<InsertSlaConfig>): Promise<SlaConfig> {\n    const [updatedConfig] = await db.update(slaConfigs)\n      .set({ ...slaConfig, updatedAt: sql`now()` })\n      .where(eq(slaConfigs.id, id))\n      .returning();\n    return updatedConfig;\n  }\n\n  // Cleaning Activities\n  async getCleaningActivitiesByCompany(companyId: string, module?: 'clean' | 'maintenance'): Promise<CleaningActivity[]> {\n    const whereConditions = module\n      ? and(eq(cleaningActivities.companyId, companyId), eq(cleaningActivities.module, module))\n      : eq(cleaningActivities.companyId, companyId);\n    \n    return await db.select().from(cleaningActivities)\n      .where(whereConditions)\n      .orderBy(cleaningActivities.name);\n  }\n\n  async getCleaningActivity(id: string): Promise<CleaningActivity | undefined> {\n    const [activity] = await db.select().from(cleaningActivities).where(eq(cleaningActivities.id, id));\n    return activity;\n  }\n\n  async createCleaningActivity(activity: InsertCleaningActivity): Promise<CleaningActivity> {\n    const [newActivity] = await db.insert(cleaningActivities).values({\n      ...activity,\n      module: activity.module || 'clean', // Default to 'clean' if not specified\n    }).returning();\n    return newActivity;\n  }\n\n  async updateCleaningActivity(id: string, activity: Partial<InsertCleaningActivity>): Promise<CleaningActivity> {\n    const [updatedActivity] = await db.update(cleaningActivities)\n      .set({ ...activity, updatedAt: sql`now()` })\n      .where(eq(cleaningActivities.id, id))\n      .returning();\n    return updatedActivity;\n  }\n\n  async deleteCleaningActivity(id: string): Promise<void> {\n    // Primeiro, deletar as work orders relacionadas\n    await db.delete(workOrders).where(eq(workOrders.cleaningActivityId, id));\n    \n    // Depois deletar a cleaning activity\n    await db.delete(cleaningActivities).where(eq(cleaningActivities.id, id));\n  }\n\n  // Maintenance Activities\n  async getMaintenanceActivitiesByCustomer(customerId: string): Promise<MaintenanceActivity[]> {\n    return await db.select().from(maintenanceActivities)\n      .where(eq(maintenanceActivities.customerId, customerId))\n      .orderBy(maintenanceActivities.name);\n  }\n\n  async getMaintenanceActivitiesByCompany(companyId: string): Promise<MaintenanceActivity[]> {\n    return await db.select().from(maintenanceActivities)\n      .where(eq(maintenanceActivities.companyId, companyId))\n      .orderBy(maintenanceActivities.name);\n  }\n\n  async getMaintenanceActivity(id: string): Promise<MaintenanceActivity | undefined> {\n    const [activity] = await db.select().from(maintenanceActivities)\n      .where(eq(maintenanceActivities.id, id));\n    return activity;\n  }\n\n  async createMaintenanceActivity(activity: InsertMaintenanceActivity): Promise<MaintenanceActivity> {\n    const [newActivity] = await db.insert(maintenanceActivities).values({\n      ...activity,\n      module: 'maintenance',\n    }).returning();\n    return newActivity;\n  }\n\n  async updateMaintenanceActivity(id: string, activity: Partial<InsertMaintenanceActivity>): Promise<MaintenanceActivity> {\n    const [updatedActivity] = await db.update(maintenanceActivities)\n      .set({ ...activity, updatedAt: sql`now()` })\n      .where(eq(maintenanceActivities.id, id))\n      .returning();\n    return updatedActivity;\n  }\n\n  async deleteMaintenanceActivity(id: string): Promise<void> {\n    await db.delete(maintenanceActivities).where(eq(maintenanceActivities.id, id));\n  }\n\n  // Helper function to expand occurrences based on activity frequency\n  // Retorna 1 OS para CADA execução individual\n  expandOccurrences(activity: CleaningActivity, windowStart: Date, windowEnd: Date): Array<{date: Date, occurrence: number, total: number}> {\n    const occurrences: Array<{date: Date, occurrence: number, total: number}> = [];\n    const { frequency, frequencyConfig, startDate, endDate } = activity;\n    \n    if (!activity.isActive) return occurrences;\n\n    // Respeitar a data de início da atividade - não gerar ordens retroativas\n    const effectiveStart = startDate ? new Date(Math.max(windowStart.getTime(), new Date(startDate).getTime())) : windowStart;\n    \n    // Respeitar a data de fim da atividade se existir\n    const effectiveEnd = endDate ? new Date(Math.min(windowEnd.getTime(), new Date(endDate).getTime())) : windowEnd;\n    \n    // Se a atividade ainda não começou ou já terminou, não gerar nada\n    if (effectiveStart > effectiveEnd) return occurrences;\n\n    const current = new Date(effectiveStart);\n    \n    while (current <= effectiveEnd) {\n      switch (frequency) {\n        case 'diaria':\n          // Daily: Gera 1 OS para CADA vez (se 3x/dia = 3 OS por dia)\n          const timesPerDay = (frequencyConfig as any)?.timesPerDay || 1;\n          for (let i = 0; i < timesPerDay; i++) {\n            const occurrence = new Date(current);\n            // Distribute times evenly throughout the day\n            const hourOffset = Math.floor((24 / timesPerDay) * i);\n            occurrence.setHours(8 + hourOffset, 0, 0, 0); // Start at 8 AM\n            if (occurrence >= effectiveStart && occurrence <= effectiveEnd) {\n              occurrences.push({\n                date: new Date(occurrence),\n                occurrence: i + 1,\n                total: timesPerDay\n              });\n            }\n          }\n          break;\n          \n        case 'semanal':\n          // Weekly: 1 OS para CADA dia da semana (3x/semana = 3 OS por semana)\n          const dayOfWeek = current.getDay(); // 0 = Sunday\n          const weekDays = (frequencyConfig as any)?.weekDays || ['segunda'];\n          const dayMap = {\n            'domingo': 0, 'segunda': 1, 'terca': 2, 'quarta': 3,\n            'quinta': 4, 'sexta': 5, 'sabado': 6\n          };\n          \n          weekDays.forEach((day: string, index: number) => {\n            const targetDay = dayMap[day as keyof typeof dayMap];\n            if (dayOfWeek === targetDay) {\n              const occurrence = new Date(current);\n              occurrence.setHours(9, 0, 0, 0); // Fixed time for weekly tasks\n              if (occurrence >= effectiveStart && occurrence <= effectiveEnd) {\n                occurrences.push({\n                  date: new Date(occurrence),\n                  occurrence: index + 1,\n                  total: weekDays.length\n                });\n              }\n            }\n          });\n          break;\n          \n        case 'mensal':\n          // Monthly: Process once per month on the first day or effective start\n          const monthDay = (frequencyConfig as any)?.monthDay || 1;\n          \n          if (current.getDate() === 1 || current.getTime() === effectiveStart.getTime()) {\n            const occurrenceDate = new Date(current.getFullYear(), current.getMonth(), monthDay, 10, 0, 0, 0);\n            \n            if (occurrenceDate >= effectiveStart && occurrenceDate <= effectiveEnd) {\n              occurrences.push({\n                date: new Date(occurrenceDate),\n                occurrence: 1,\n                total: 1\n              });\n            }\n          }\n          break;\n          \n        case 'trimestral':\n          // Quarterly: 1 OS a cada 3 meses\n          const quarterMonthDay = (frequencyConfig as any)?.monthDay || 1;\n          \n          if (current.getDate() === 1 || current.getTime() === effectiveStart.getTime()) {\n            const currentMonth = current.getMonth();\n            const currentYear = current.getFullYear();\n            \n            // Verificar se este é um mês de execução trimestral (0, 3, 6, 9)\n            if (currentMonth % 3 === 0) {\n              const occurrenceDate = new Date(currentYear, currentMonth, quarterMonthDay, 10, 0, 0, 0);\n              \n              if (occurrenceDate >= effectiveStart && occurrenceDate <= effectiveEnd) {\n                occurrences.push({\n                  date: new Date(occurrenceDate),\n                  occurrence: 1,\n                  total: 1\n                });\n              }\n            }\n          }\n          break;\n          \n        case 'semestral':\n          // Semi-annual: 1 OS a cada 6 meses\n          const semiAnnualMonthDay = (frequencyConfig as any)?.monthDay || 1;\n          \n          if (current.getDate() === 1 || current.getTime() === effectiveStart.getTime()) {\n            const currentMonth = current.getMonth();\n            const currentYear = current.getFullYear();\n            \n            // Verificar se este é um mês de execução semestral (0, 6)\n            if (currentMonth === 0 || currentMonth === 6) {\n              const occurrenceDate = new Date(currentYear, currentMonth, semiAnnualMonthDay, 10, 0, 0, 0);\n              \n              if (occurrenceDate >= effectiveStart && occurrenceDate <= effectiveEnd) {\n                occurrences.push({\n                  date: new Date(occurrenceDate),\n                  occurrence: 1,\n                  total: 1\n                });\n              }\n            }\n          }\n          break;\n          \n        case 'anual':\n          // Annual: 1 OS por ano\n          const annualMonthDay = (frequencyConfig as any)?.monthDay || 1;\n          const annualMonth = ((frequencyConfig as any)?.month || 1) - 1; // 0-indexed\n          \n          if (current.getDate() === 1 || current.getTime() === effectiveStart.getTime()) {\n            const currentMonth = current.getMonth();\n            const currentYear = current.getFullYear();\n            \n            // Verificar se este é o mês de execução anual\n            if (currentMonth === annualMonth) {\n              const occurrenceDate = new Date(currentYear, annualMonth, annualMonthDay, 10, 0, 0, 0);\n              \n              if (occurrenceDate >= effectiveStart && occurrenceDate <= effectiveEnd) {\n                occurrences.push({\n                  date: new Date(occurrenceDate),\n                  occurrence: 1,\n                  total: 1\n                });\n              }\n            }\n          }\n          break;\n          \n        case 'turno':\n          // Shift-based: 1 OS para CADA turno (3 turnos = 3 OS por dia)\n          const shifts = (frequencyConfig as any)?.turnShifts || ['manha'];\n          const shiftTimes = {\n            'manha': { hour: 8, minute: 0 },\n            'tarde': { hour: 14, minute: 0 },\n            'noite': { hour: 20, minute: 0 }\n          };\n          \n          shifts.forEach((shift: string, index: number) => {\n            const time = shiftTimes[shift as keyof typeof shiftTimes];\n            if (time) {\n              const occurrence = new Date(current);\n              occurrence.setHours(time.hour, time.minute, 0, 0);\n              if (occurrence >= effectiveStart && occurrence <= effectiveEnd) {\n                occurrences.push({\n                  date: new Date(occurrence),\n                  occurrence: index + 1,\n                  total: shifts.length\n                });\n              }\n            }\n          });\n          break;\n      }\n      \n      // Move to next day\n      current.setDate(current.getDate() + 1);\n    }\n    \n    return occurrences;\n  }\n\n  // Generate scheduled work orders from cleaning activities\n  async generateScheduledWorkOrders(companyId: string, windowStart: Date, windowEnd: Date): Promise<WorkOrder[]> {\n    // Get active cleaning activities\n    const activities = await this.getCleaningActivitiesByCompany(companyId);\n    const activeActivities = activities.filter(a => a.isActive);\n    \n    const generatedOrders: WorkOrder[] = [];\n    \n    for (const activity of activeActivities) {\n      const occurrences = this.expandOccurrences(activity, windowStart, windowEnd);\n      \n      for (const occ of occurrences) {\n        // Check if work order already exists for this activity and exact datetime (idempotency)\n        const existing = await db.select().from(workOrders)\n          .where(and(\n            eq(workOrders.companyId, companyId),\n            eq(workOrders.cleaningActivityId, activity.id),\n            eq(workOrders.scheduledDate, occ.date)\n          ))\n          .limit(1);\n          \n        if (existing.length > 0) {\n          continue; // Skip if already exists\n        }\n        \n        // Generate work order number\n        const workOrderNumber = await this.getNextWorkOrderNumber(companyId);\n        \n        // Build title with occurrence label if multiple times\n        let title = `${activity.name}`;\n        if (occ.total > 1) {\n          // Determinar o período baseado na frequência\n          let periodo = 'ao dia';\n          if (activity.frequency === 'semanal') {\n            periodo = 'na semana';\n          } else if (activity.frequency === 'turno') {\n            periodo = 'turnos';\n          }\n          title = `${activity.name} - ${occ.occurrence}ª/${occ.total} (${occ.total}x ${periodo})`;\n        }\n        \n        // Create work order\n        const workOrderData = {\n          id: crypto.randomUUID(),\n          number: workOrderNumber,\n          companyId: companyId,\n          zoneId: activity.zoneId,\n          serviceId: activity.serviceId,\n          cleaningActivityId: activity.id,\n          checklistTemplateId: activity.checklistTemplateId,\n          type: 'programada' as const,\n          status: 'aberta' as const,\n          priority: 'media' as const,\n          title: title,\n          description: activity.description,\n          scheduledDate: occ.date,\n          dueDate: new Date(occ.date.getTime() + (2 * 60 * 60 * 1000)), // 2 hours after scheduled\n          origin: 'Sistema - Cronograma'\n        };\n        \n        const [createdOrder] = await db.insert(workOrders).values(workOrderData).returning();\n        generatedOrders.push(createdOrder);\n      }\n    }\n    \n    return generatedOrders;\n  }\n\n  // Generate scheduled work orders from maintenance activities\n  async generateMaintenanceWorkOrders(companyId: string, windowStart: Date, windowEnd: Date): Promise<WorkOrder[]> {\n    // Get active maintenance activities\n    const activities = await this.getMaintenanceActivitiesByCompany(companyId);\n    const activeActivities = activities.filter((a: any) => a.isActive);\n    \n    const generatedOrders: WorkOrder[] = [];\n    \n    for (const activity of activeActivities) {\n      // Convert maintenance activity to format compatible with expandOccurrences\n      const activityForExpansion: any = {\n        ...activity,\n        module: 'maintenance'\n      };\n      \n      const occurrences = this.expandOccurrences(activityForExpansion, windowStart, windowEnd);\n      \n      console.log(`[SCHEDULER DEBUG] Activity: \"${activity.name}\" (${activity.id})`);\n      console.log(`[SCHEDULER DEBUG] Occurrences generated: ${occurrences.length}`);\n      occurrences.forEach((occ, idx) => {\n        console.log(`  ${idx + 1}. ${occ.date.toISOString().split('T')[0]} (${occ.occurrence}/${occ.total})`);\n      });\n      \n      // Get equipment based on equipmentIds array\n      let equipmentList: any[] = [];\n      console.log(`[SCHEDULER DEBUG] activity.equipmentIds:`, activity.equipmentIds);\n      console.log(`[SCHEDULER DEBUG] equipmentIds type:`, typeof activity.equipmentIds);\n      console.log(`[SCHEDULER DEBUG] equipmentIds isArray:`, Array.isArray(activity.equipmentIds));\n      \n      if (activity.equipmentIds && activity.equipmentIds.length > 0) {\n        // Get all specified equipment\n        equipmentList = await db.select().from(equipment)\n          .where(inArray(equipment.id, activity.equipmentIds));\n        \n        console.log(`[SCHEDULER DEBUG] Equipment IDs in activity: ${activity.equipmentIds.length}`);\n        console.log(`[SCHEDULER DEBUG] Equipment found: ${equipmentList.length}`);\n        equipmentList.forEach(eq => {\n          console.log(`  - ${eq.name} (ID: ${eq.id})`);\n        });\n      } else {\n        console.log(`[SCHEDULER DEBUG] ❌ No equipment IDs found in activity - skipping OS generation`);\n      }\n      \n      // Generate work orders for each equipment and occurrence combination\n      for (const equipItem of equipmentList) {\n        for (const occ of occurrences) {\n          // Check if work order already exists (idempotency)\n          const existing = await db.select().from(workOrders)\n            .where(and(\n              eq(workOrders.companyId, companyId),\n              eq(workOrders.maintenanceActivityId, activity.id),\n              eq(workOrders.equipmentId, equipItem.id),\n              eq(workOrders.scheduledDate, occ.date)\n            ))\n            .limit(1);\n            \n          if (existing.length > 0) {\n            console.log(`[SCHEDULER DEBUG] ⏭️  Skipping - OS already exists for ${occ.date.toISOString().split('T')[0]}`);\n            continue; // Skip if already exists\n          }\n          \n          console.log(`[SCHEDULER DEBUG] ✅ Creating OS for ${occ.date.toISOString().split('T')[0]}`);\n          \n          // Generate work order number\n          const workOrderNumber = await this.getNextWorkOrderNumber(companyId);\n          \n          // Build title\n          let title = `${activity.name} - ${equipItem.name}`;\n          if (occ.total > 1) {\n            let periodo = 'ao dia';\n            if (activity.frequency === 'semanal') {\n              periodo = 'na semana';\n            } else if (activity.frequency === 'turno') {\n              periodo = 'turnos';\n            }\n            title = `${activity.name} - ${equipItem.name} - ${occ.occurrence}ª/${occ.total}`;\n          }\n          \n          // Verify if checklist template exists and get serviceId from it\n          let validChecklistTemplateId = null;\n          let serviceId = null;\n          if (activity.checklistTemplateId) {\n            const [template] = await db.select().from(maintenanceChecklistTemplates)\n              .where(eq(maintenanceChecklistTemplates.id, activity.checklistTemplateId))\n              .limit(1);\n            if (template) {\n              validChecklistTemplateId = activity.checklistTemplateId;\n              serviceId = template.serviceId; // Get serviceId from checklist template\n            }\n          }\n          \n          // Create work order with site and zone from equipment\n          const workOrderData = {\n            id: crypto.randomUUID(),\n            number: workOrderNumber,\n            companyId: companyId,\n            equipmentId: equipItem.id,\n            maintenanceActivityId: activity.id,\n            maintenanceChecklistTemplateId: validChecklistTemplateId,\n            serviceId: serviceId, // Add serviceId from checklist template\n            type: 'programada' as const,\n            status: 'aberta' as const,\n            priority: 'media' as const,\n            title: title,\n            description: activity.description || `Manutenção ${activity.type} para ${equipItem.name}`,\n            scheduledDate: occ.date,\n            dueDate: new Date(occ.date.getTime() + (4 * 60 * 60 * 1000)), // 4 hours after scheduled\n            origin: 'Sistema - Plano de Manutenção',\n            module: 'maintenance' as const,\n            zoneId: equipItem.zoneId  // Add zone from equipment\n          };\n          \n          const [createdOrder] = await db.insert(workOrders).values(workOrderData).returning();\n          generatedOrders.push(createdOrder);\n        }\n      }\n    }\n    \n    return generatedOrders;\n  }\n\n  // Work Orders\n  async getWorkOrdersByCompany(companyId: string, module?: 'clean' | 'maintenance'): Promise<WorkOrder[]> {\n    const whereConditions = module\n      ? and(eq(workOrders.companyId, companyId), eq(workOrders.module, module))\n      : eq(workOrders.companyId, companyId);\n    \n    return await db.select().from(workOrders)\n      .where(whereConditions)\n      .orderBy(desc(workOrders.createdAt));\n  }\n\n  async getWorkOrdersByUser(userId: string): Promise<WorkOrder[]> {\n    return await db.select().from(workOrders)\n      .where(eq(workOrders.assignedUserId, userId))\n      .orderBy(desc(workOrders.createdAt));\n  }\n\n  async getWorkOrder(id: string): Promise<WorkOrder | undefined> {\n    const [workOrder] = await db.select()\n      .from(workOrders)\n      .where(eq(workOrders.id, id));\n    \n    if (!workOrder) return undefined;\n    \n    // Buscar relacionamentos manualmente\n    let site = null;\n    let zone = null;\n    let service = null;\n    let assignedOperator = null;\n    \n    if (workOrder.siteId) {\n      [site] = await db.select().from(sites).where(eq(sites.id, workOrder.siteId));\n    }\n    \n    if (workOrder.zoneId) {\n      [zone] = await db.select().from(zones).where(eq(zones.id, workOrder.zoneId));\n    }\n    \n    if (workOrder.serviceId) {\n      [service] = await db.select().from(services).where(eq(services.id, workOrder.serviceId));\n    }\n    \n    if (workOrder.assignedUserId) {\n      [assignedOperator] = await db.select().from(users).where(eq(users.id, workOrder.assignedUserId));\n    }\n    \n    return {\n      ...workOrder,\n      site,\n      zone,\n      service,\n      assignedOperator,\n    } as any;\n  }\n\n  async createWorkOrder(workOrder: InsertWorkOrder): Promise<WorkOrder> {\n    const number = await this.getNextWorkOrderNumber(workOrder.companyId);\n    const id = crypto.randomUUID();\n    \n    // Auto-assign checklist template and estimated hours based on service\n    let checklistTemplateId = workOrder.checklistTemplateId;\n    let estimatedHours = workOrder.estimatedHours;\n    \n    if (workOrder.serviceId) {\n      // Get service details\n      const [service] = await db.select()\n        .from(services)\n        .where(eq(services.id, workOrder.serviceId))\n        .limit(1);\n      \n      if (service) {\n        // Auto-assign estimated hours from service duration\n        if (!estimatedHours && service.estimatedDurationMinutes) {\n          estimatedHours = Math.max(1, Math.round(service.estimatedDurationMinutes / 60)); // Convert minutes to hours (minimum 1 hour)\n        }\n        \n        // Auto-assign checklist template if not specified\n        if (!checklistTemplateId) {\n          const [checklistTemplate] = await db.select()\n            .from(checklistTemplates)\n            .where(eq(checklistTemplates.serviceId, workOrder.serviceId))\n            .limit(1);\n          \n          if (checklistTemplate) {\n            checklistTemplateId = checklistTemplate.id;\n          }\n        }\n      }\n    }\n    \n    const [newWorkOrder] = await db.insert(workOrders)\n      .values({ \n        ...workOrder,\n        id,\n        number,\n        checklistTemplateId,\n        estimatedHours,\n        module: workOrder.module || 'clean' // Default to 'clean' if not specified\n      })\n      .returning();\n      \n    // Create audit log for work order creation\n    if (newWorkOrder) {\n      try {\n        await this.createAuditLog({\n          companyId: newWorkOrder.companyId,\n          userId: null, // System operation - in real app, get from session\n          action: \"create\",\n          entityType: \"work_order\",\n          entityId: newWorkOrder.id,\n          metadata: { details: `Work order #${newWorkOrder.number} created - Type: ${workOrder.type}, Priority: ${workOrder.priority}, Service: ${workOrder.serviceId || 'none'}, Auto-assigned: ${checklistTemplateId ? 'Checklist' : ''} ${estimatedHours ? 'Hours' : ''}` },\n          timestamp: new Date(),\n        });\n      } catch (logError) {\n        console.error(\"Failed to create audit log:\", logError);\n      }\n    }\n    \n    return newWorkOrder;\n  }\n\n  async updateWorkOrder(id: string, workOrder: Partial<InsertWorkOrder>): Promise<WorkOrder> {\n    // Remove undefined values to prevent overwriting existing data with NULL\n    // Convert ISO strings to Date objects for timestamp fields\n    const cleanedData = Object.entries(workOrder).reduce((acc, [key, value]) => {\n      if (value !== undefined) {\n        // Convert ISO date strings to Date objects\n        if (['completedAt', 'startedAt', 'scheduledStartAt', 'scheduledEndAt'].includes(key) && typeof value === 'string') {\n          acc[key] = new Date(value);\n        } else {\n          acc[key] = value;\n        }\n      }\n      return acc;\n    }, {} as any);\n    \n    // Auto-set completedAt when status changes to concluida\n    if (cleanedData.status === 'concluida' && !cleanedData.completedAt) {\n      cleanedData.completedAt = new Date();\n    }\n    \n    // Auto-set startedAt if not set when completing\n    if (cleanedData.status === 'concluida' && !cleanedData.startedAt) {\n      const [existing] = await db.select().from(workOrders).where(eq(workOrders.id, id));\n      if (existing && !existing.startedAt) {\n        cleanedData.startedAt = existing.createdAt;\n      }\n    }\n    \n    const [updatedWorkOrder] = await db.update(workOrders)\n      .set({ ...cleanedData, updatedAt: sql`now()` })\n      .where(eq(workOrders.id, id))\n      .returning();\n    \n    // Create audit log for work order update\n    if (updatedWorkOrder) {\n      try {\n        await this.createAuditLog({\n          companyId: updatedWorkOrder.companyId,\n          userId: null, // System operation - in real app, get from session\n          action: \"update\",\n          entityType: \"work_order\",\n          entityId: updatedWorkOrder.id,\n          metadata: { details: `Work order #${updatedWorkOrder.number} updated - Status: ${workOrder.status || updatedWorkOrder.status}` },\n          timestamp: new Date(),\n        });\n      } catch (logError) {\n        console.error(\"Failed to create audit log:\", logError);\n      }\n    }\n    \n    return updatedWorkOrder;\n  }\n\n  async deleteWorkOrder(id: string): Promise<void> {\n    // Get work order info before deletion for audit log\n    const workOrder = await this.getWorkOrder(id);\n    \n    await db.delete(workOrders).where(eq(workOrders.id, id));\n    \n    // Create audit log for work order deletion\n    if (workOrder) {\n      try {\n        await this.createAuditLog({\n          companyId: workOrder.companyId,\n          userId: null, // System operation\n          action: \"delete\",\n          entityType: \"work_order\",\n          entityId: workOrder.id,\n          metadata: { details: `Work order #${workOrder.number} deleted - Type: ${workOrder.type}` },\n          timestamp: new Date(),\n        });\n      } catch (logError) {\n        console.error(\"Failed to create audit log:\", logError);\n      }\n    }\n  }\n\n  // Audit Logs\n  async createAuditLog(log: InsertAuditLog): Promise<AuditLog> {\n    const logWithId = {\n      ...log,\n      id: log.id || crypto.randomUUID(),\n    };\n    const [newLog] = await db.insert(auditLogs).values(logWithId).returning();\n    return newLog;\n  }\n\n  async getAuditLogsByCompany(companyId: string, limit: number = 100): Promise<AuditLog[]> {\n    return await db.select().from(auditLogs)\n      .where(eq(auditLogs.companyId, companyId))\n      .orderBy(desc(auditLogs.timestamp))\n      .limit(limit);\n  }\n\n  async getAuditLogsByEntity(entityType: string, entityId: string): Promise<AuditLog[]> {\n    return await db.select().from(auditLogs)\n      .where(and(\n        eq(auditLogs.entityType, entityType),\n        eq(auditLogs.entityId, entityId)\n      ))\n      .orderBy(desc(auditLogs.timestamp));\n  }\n\n  async getNextWorkOrderNumber(companyId: string): Promise<number> {\n    return await this.incrementCompanyCounter(companyId, 'work_order');\n  }\n\n  async reopenWorkOrder(workOrderId: string, userId: string, reason: string, attachments?: any): Promise<WorkOrder> {\n    // Create comment with reopen request flag\n    await this.createWorkOrderComment({\n      id: crypto.randomUUID(),\n      workOrderId,\n      userId,\n      comment: reason,\n      attachments,\n      isReopenRequest: true,\n    });\n\n    // Update work order status to aberta (open)\n    const [reopenedWorkOrder] = await db.update(workOrders)\n      .set({ \n        status: 'aberta',\n        updatedAt: sql`now()` \n      })\n      .where(eq(workOrders.id, workOrderId))\n      .returning();\n\n    // Create audit log\n    try {\n      await this.createAuditLog({\n        companyId: reopenedWorkOrder.companyId,\n        userId,\n        action: \"reopen\",\n        entityType: \"work_order\",\n        entityId: workOrderId,\n        metadata: { details: `Work order #${reopenedWorkOrder.number} reopened - Reason: ${reason}` },\n        timestamp: new Date(),\n      });\n    } catch (logError) {\n      console.error(\"Failed to create audit log:\", logError);\n    }\n\n    return reopenedWorkOrder;\n  }\n\n  // Work Order Comments\n  async getWorkOrderComments(workOrderId: string): Promise<WorkOrderComment[]> {\n    return await db.select()\n      .from(workOrderComments)\n      .where(eq(workOrderComments.workOrderId, workOrderId))\n      .orderBy(workOrderComments.createdAt);\n  }\n\n  async createWorkOrderComment(comment: InsertWorkOrderComment): Promise<WorkOrderComment> {\n    const [newComment] = await db.insert(workOrderComments)\n      .values(comment)\n      .returning();\n    return newComment;\n  }\n\n  async deleteWorkOrderComment(id: string): Promise<void> {\n    await db.delete(workOrderComments).where(eq(workOrderComments.id, id));\n  }\n\n  // Bathroom Counters\n  async getBathroomCounterByZone(zoneId: string): Promise<BathroomCounter | undefined> {\n    const [counter] = await db.select().from(bathroomCounters).where(eq(bathroomCounters.zoneId, zoneId));\n    return counter;\n  }\n\n  async createBathroomCounter(counter: InsertBathroomCounter): Promise<BathroomCounter> {\n    const [newCounter] = await db.insert(bathroomCounters).values(counter).returning();\n    return newCounter;\n  }\n\n  async updateBathroomCounter(id: string, counter: Partial<InsertBathroomCounter>): Promise<BathroomCounter> {\n    const [updatedCounter] = await db.update(bathroomCounters)\n      .set({ ...counter, updatedAt: sql`now()` })\n      .where(eq(bathroomCounters.id, id))\n      .returning();\n    return updatedCounter;\n  }\n\n  async incrementBathroomCounter(zoneId: string): Promise<BathroomCounter> {\n    const counter = await this.getBathroomCounterByZone(zoneId);\n    if (!counter) {\n      throw new Error('Bathroom counter not found for zone');\n    }\n\n    const previousCount = counter.currentCount || 0;\n    const newCount = previousCount + 1;\n    const [updatedCounter] = await db.update(bathroomCounters)\n      .set({ \n        currentCount: newCount,\n        updatedAt: sql`now()` \n      })\n      .where(eq(bathroomCounters.id, counter.id))\n      .returning();\n\n    // Create audit log\n    await this.createBathroomCounterLog({\n      id: crypto.randomUUID(),\n      counterId: counter.id,\n      delta: 1,\n      action: 'increment',\n      previousValue: previousCount,\n      newValue: newCount\n    });\n\n    // Check if limit reached and create work order if needed\n    if (newCount >= counter.limitCount) {\n      // Create automatic cleaning work order\n      const zone = await this.getZone(zoneId);\n      if (zone) {\n        const site = await this.getSite(zone.siteId);\n        if (site) {\n          await this.createWorkOrder({\n            companyId: site.companyId,\n            zoneId: zoneId,\n            type: 'corretiva_interna',\n            priority: 'alta',\n            title: 'Limpeza Automática - Limite de Uso Atingido',\n            description: `Contador de uso atingiu o limite de ${counter.limitCount}. Limpeza necessária.`,\n            origin: 'Contador Automático',\n            scheduledDate: null,\n            dueDate: null\n          });\n        }\n      }\n    }\n\n    return updatedCounter;\n  }\n\n  // Webhook Configs\n  async getWebhookConfigsByCompany(companyId: string): Promise<WebhookConfig[]> {\n    return await db.select().from(webhookConfigs)\n      .where(eq(webhookConfigs.companyId, companyId))\n      .orderBy(webhookConfigs.name);\n  }\n\n  async getWebhookConfig(id: string): Promise<WebhookConfig | undefined> {\n    const [config] = await db.select().from(webhookConfigs).where(eq(webhookConfigs.id, id));\n    return config;\n  }\n\n  async createWebhookConfig(config: InsertWebhookConfig): Promise<WebhookConfig> {\n    const [newConfig] = await db.insert(webhookConfigs).values(config).returning();\n    return newConfig;\n  }\n\n  async updateWebhookConfig(id: string, config: Partial<InsertWebhookConfig>): Promise<WebhookConfig> {\n    const [updatedConfig] = await db.update(webhookConfigs)\n      .set({ ...config, updatedAt: sql`now()` })\n      .where(eq(webhookConfigs.id, id))\n      .returning();\n    return updatedConfig;\n  }\n\n  // Dashboard stats\n  async getDashboardStats(companyId: string, period?: string, siteId?: string): Promise<{\n    openWorkOrders: number;\n    overdueWorkOrders: number;\n    completedWorkOrders: number;\n    slaCompliance: number;\n    areaCleanedToday: number;\n    activeOperators: number;\n    totalSites: number;\n    totalZones: number;\n    efficiency: number;\n    qualityIndex: number | null;\n    ratedCount: number;\n  }> {\n    // Build date filter based on period\n    let dateFilter = null;\n    const now = new Date();\n    \n    switch (period) {\n      case 'hoje':\n        dateFilter = sql`DATE(${workOrders.createdAt}) = CURRENT_DATE`;\n        break;\n      case 'ontem':\n        dateFilter = sql`DATE(${workOrders.createdAt}) = CURRENT_DATE - INTERVAL '1 day'`;\n        break;\n      case 'semana':\n        dateFilter = sql`${workOrders.createdAt} >= CURRENT_DATE - INTERVAL '7 days'`;\n        break;\n      case 'mes':\n        dateFilter = sql`${workOrders.createdAt} >= CURRENT_DATE - INTERVAL '30 days'`;\n        break;\n      case 'total':\n        // No date filter for all data\n        break;\n      default:\n        // No date filter for all data\n        break;\n    }\n\n    // Build site filter conditions\n    let siteFilter = [eq(workOrders.companyId, companyId)];\n    \n    if (siteId && siteId !== 'todos') {\n      siteFilter.push(sql`${workOrders.zoneId} IN (\n        SELECT id FROM ${zones} WHERE ${zones.siteId} = ${siteId}\n      )`);\n    }\n    \n    if (dateFilter) {\n      siteFilter.push(dateFilter);\n    }\n\n    // Get work orders counts by status with filters\n    const workOrderStats = await db.select({\n      status: workOrders.status,\n      count: count()\n    })\n      .from(workOrders)\n      .where(and(...siteFilter))\n      .groupBy(workOrders.status);\n\n    const statusCounts = workOrderStats.reduce((acc, stat) => {\n      acc[stat.status] = stat.count;\n      return acc;\n    }, {} as Record<string, number>);\n\n    // Get active operators count\n    const [operatorCount] = await db.select({ count: count() })\n      .from(users)\n      .where(and(\n        eq(users.companyId, companyId),\n        eq(users.role, 'operador'),\n        eq(users.isActive, true)\n      ));\n\n    // Get sites count (filtered by site if specified)\n    let sitesCountWhere = [eq(sites.companyId, companyId)];\n    if (siteId && siteId !== 'todos') {\n      sitesCountWhere.push(eq(sites.id, siteId));\n    }\n    const [sitesCount] = await db.select({ count: count() })\n      .from(sites)\n      .where(and(...sitesCountWhere));\n\n    // Get zones count (filtered by site if specified)\n    let zonesCountWhere = [eq(sites.companyId, companyId)];\n    if (siteId && siteId !== 'todos') {\n      zonesCountWhere.push(eq(sites.id, siteId));\n    }\n    const [zonesCount] = await db.select({ count: count() })\n      .from(zones)\n      .innerJoin(sites, eq(zones.siteId, sites.id))\n      .where(and(...zonesCountWhere));\n\n    // Calculate area cleaned with period and site filters\n    let areaCleanedWhere = [\n      eq(workOrders.companyId, companyId),\n      eq(workOrders.status, 'concluida')\n    ];\n    \n    if (siteId && siteId !== 'todos') {\n      areaCleanedWhere.push(sql`${workOrders.zoneId} IN (\n        SELECT id FROM ${zones} WHERE ${zones.siteId} = ${siteId}\n      )`);\n    }\n    \n    // Apply period filter for area calculation\n    if (period === 'hoje') {\n      areaCleanedWhere.push(sql`DATE(${workOrders.completedAt}) = CURRENT_DATE`);\n    } else if (period === 'ontem') {\n      areaCleanedWhere.push(sql`DATE(${workOrders.completedAt}) = CURRENT_DATE - INTERVAL '1 day'`);\n    } else if (period === 'semana') {\n      areaCleanedWhere.push(sql`${workOrders.completedAt} >= CURRENT_DATE - INTERVAL '7 days'`);\n    } else if (period === 'mes') {\n      areaCleanedWhere.push(sql`${workOrders.completedAt} >= CURRENT_DATE - INTERVAL '30 days'`);\n    } else if (period === 'total') {\n      // No date filter for total - include all completed work orders\n    }\n    \n    const completedAreas = await db.select({ \n      areaM2: zones.areaM2 \n    })\n      .from(workOrders)\n      .innerJoin(zones, eq(workOrders.zoneId, zones.id))\n      .where(and(...areaCleanedWhere));\n\n    const totalAreaCleaned = completedAreas.reduce((total, area) => {\n      return total + (parseFloat(area.areaM2 || '0'));\n    }, 0);\n\n    // Calculate overdue work orders: open work orders with dueDate < NOW()\n    let overdueWhere = [\n      eq(workOrders.companyId, companyId),\n      eq(workOrders.status, 'aberta'),\n      sql`${workOrders.dueDate} < NOW()`\n    ];\n    \n    if (siteId && siteId !== 'todos') {\n      overdueWhere.push(sql`${workOrders.zoneId} IN (\n        SELECT id FROM ${zones} WHERE ${zones.siteId} = ${siteId}\n      )`);\n    }\n    \n    if (dateFilter) {\n      overdueWhere.push(dateFilter);\n    }\n    \n    const [overdueCount] = await db.select({ count: count() })\n      .from(workOrders)\n      .where(and(...overdueWhere));\n\n    // Calculate efficiency (completed vs total)\n    const totalToday = (statusCounts.concluida || 0) + (statusCounts.aberta || 0);\n    const efficiency = totalToday > 0 ? Math.round(((statusCounts.concluida || 0) / totalToday) * 100) : 0;\n\n    // Calculate SLA compliance (completed on time vs total completed) with filters\n    let slaComplianceWhere = [\n      eq(workOrders.companyId, companyId),\n      eq(workOrders.status, 'concluida'),\n      sql`${workOrders.completedAt} <= ${workOrders.scheduledEndAt}`\n    ];\n    \n    if (siteId && siteId !== 'todos') {\n      slaComplianceWhere.push(sql`${workOrders.zoneId} IN (\n        SELECT id FROM ${zones} WHERE ${zones.siteId} = ${siteId}\n      )`);\n    }\n    \n    if (dateFilter) {\n      slaComplianceWhere.push(dateFilter);\n    }\n    \n    const completedOnTime = await db.select({ count: count() })\n      .from(workOrders)\n      .where(and(...slaComplianceWhere));\n\n    const totalCompleted = statusCounts.concluida || 0;\n    const slaCompliance = totalCompleted > 0 ? Math.round((completedOnTime[0].count / totalCompleted) * 100) : 100;\n\n    // Quality index - Calculate from customer ratings if available\n    let qualityIndex = 0;\n    let ratedCount = 0;\n    \n    // Query for rated work orders\n    const ratedWhere = [\n      eq(workOrders.companyId, companyId),\n      isNotNull(workOrders.customerRating)\n    ];\n    \n    if (siteId) {\n      const siteZones = await db.select({ id: zones.id })\n        .from(zones)\n        .where(eq(zones.siteId, siteId));\n      const siteZoneIds = siteZones.map(z => z.id);\n      if (siteZoneIds.length > 0) {\n        ratedWhere.push(inArray(workOrders.zoneId, siteZoneIds));\n      }\n    }\n    \n    if (dateFilter) {\n      ratedWhere.push(dateFilter);\n    }\n    \n    const ratedWorkOrders = await db.select({ \n      customerRating: workOrders.customerRating \n    })\n      .from(workOrders)\n      .where(and(...ratedWhere));\n    \n    if (ratedWorkOrders.length > 0) {\n      const totalRating = ratedWorkOrders.reduce((sum, wo) => sum + (wo.customerRating || 0), 0);\n      qualityIndex = totalRating / ratedWorkOrders.length;\n      ratedCount = ratedWorkOrders.length;\n    }\n\n    return {\n      openWorkOrders: statusCounts.aberta || 0,\n      overdueWorkOrders: overdueCount.count,\n      completedWorkOrders: statusCounts.concluida || 0,\n      slaCompliance,\n      areaCleanedToday: Math.round(totalAreaCleaned),\n      activeOperators: operatorCount.count,\n      totalSites: sitesCount.count,\n      totalZones: zonesCount.count,\n      efficiency,\n      qualityIndex: ratedCount > 0 ? parseFloat(qualityIndex.toFixed(1)) : null,\n      ratedCount\n    };\n  }\n\n  // Performance analytics for charts\n  async getPerformanceAnalytics(companyId: string, period: string = '7d', siteId?: string): Promise<{\n    daily: Array<{\n      date: string;\n      efficiency: number;\n      completed: number;\n      total: number;\n    }>;\n    statusBreakdown: Array<{\n      status: string;\n      count: number;\n      percentage: number;\n    }>;\n    weeklyActivity: Array<{\n      day: string;\n      count: number;\n    }>;\n    priorityBreakdown: Array<{\n      priority: string;\n      count: number;\n    }>;\n    locationBreakdown: Array<{\n      zone: string;\n      count: number;\n    }>;\n    averageCompletionTime: number;\n    completedIn24h: number;\n    completedIn4h: number;\n  }> {\n    try {\n      // Build filters based on period and site\n      let dateFilter = null;\n      switch (period) {\n        case 'hoje':\n          dateFilter = sql`DATE(${workOrders.scheduledDate}) = CURRENT_DATE`;\n          break;\n        case 'ontem':\n          dateFilter = sql`DATE(${workOrders.scheduledDate}) = CURRENT_DATE - INTERVAL '1 day'`;\n          break;\n        case 'semana':\n          dateFilter = sql`${workOrders.scheduledDate} >= CURRENT_DATE - INTERVAL '7 days'`;\n          break;\n        case 'mes':\n          dateFilter = sql`${workOrders.scheduledDate} >= CURRENT_DATE - INTERVAL '30 days'`;\n          break;\n        case 'total':\n          // No date filter for all data\n          break;\n        default:\n          // No date filter for all data\n          break;\n      }\n\n      let analyticsFilter = [eq(workOrders.companyId, companyId)];\n      \n      if (siteId && siteId !== 'todos') {\n        analyticsFilter.push(sql`${workOrders.zoneId} IN (\n          SELECT id FROM ${zones} WHERE ${zones.siteId} = ${siteId}\n        )`);\n      }\n      \n      if (dateFilter) {\n        analyticsFilter.push(dateFilter);\n      }\n\n      // Get daily data - include both past AND future dates to ensure chart shows data\n      const dailyStats = await db.select({\n        date: sql`DATE(${workOrders.scheduledDate})`.as('date'),\n        completed: sql`COUNT(CASE WHEN ${workOrders.status} = 'concluida' THEN 1 END)`.as('completed'),\n        total: count()\n      })\n        .from(workOrders)\n        .where(and(...analyticsFilter, sql`${workOrders.scheduledDate} IS NOT NULL`))\n        .groupBy(sql`DATE(${workOrders.scheduledDate})`)\n        .orderBy(sql`DATE(${workOrders.scheduledDate}) ASC`)\n        .limit(14); // Get more data to ensure we have something to show\n\n      // Create dataset using actual dates with data (past or future)\n      // If no historical data exists, use future scheduled dates\n      let daily = [];\n      \n      if (dailyStats.length > 0) {\n        // Use real data from database, regardless of being past or future\n        daily = dailyStats.slice(0, 7).map(stat => ({\n          date: new Date(stat.date as string).toISOString().split('T')[0],\n          efficiency: stat.total > 0 ? Math.round((Number(stat.completed) / stat.total) * 100) : 0,\n          completed: Number(stat.completed),\n          total: stat.total\n        }));\n      } else {\n        // If no data found with filters, show at least one data point to prevent empty chart\n        daily = [{\n          date: new Date().toISOString().split('T')[0],\n          efficiency: 0,\n          completed: 0,\n          total: 0\n        }];\n      }\n\n      // Get actual status breakdown from database with filters\n      const statusStats = await db.select({\n        status: workOrders.status,\n        count: count()\n      })\n        .from(workOrders)\n        .where(and(...analyticsFilter))\n        .groupBy(workOrders.status);\n\n      const totalOrders = statusStats.reduce((sum, stat) => sum + stat.count, 0);\n      const statusBreakdown = statusStats.length > 0 ? statusStats.map(stat => ({\n        status: stat.status,\n        count: stat.count,\n        percentage: totalOrders > 0 ? Math.round((stat.count / totalOrders) * 100) : 0\n      })) : [\n        // Return empty array if no data exists, don't show fake data\n        { status: 'concluida', count: 0, percentage: 0 },\n        { status: 'aberta', count: 0, percentage: 0 },\n        { status: 'vencida', count: 0, percentage: 0 }\n      ];\n\n      // Get weekly activity data (OS by day of week)\n      const weekDayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];\n      const weeklyStats = await db.select({\n        dayOfWeek: sql`EXTRACT(DOW FROM ${workOrders.createdAt})`.as('day_of_week'),\n        count: count()\n      })\n        .from(workOrders)\n        .where(and(...analyticsFilter))\n        .groupBy(sql`EXTRACT(DOW FROM ${workOrders.createdAt})`);\n\n      // Initialize all days with 0 count\n      const weeklyActivity = weekDayNames.map((day, index) => {\n        const dayStat = weeklyStats.find(s => Number(s.dayOfWeek) === index);\n        return {\n          day,\n          count: dayStat ? dayStat.count : 0\n        };\n      });\n\n      // Get priority breakdown\n      const priorityOrder = ['urgente', 'alta', 'media', 'baixa'];\n      const priorityLabels: { [key: string]: string } = {\n        'urgente': 'Urgente',\n        'alta': 'Alta',\n        'media': 'Média',\n        'baixa': 'Baixa'\n      };\n\n      const priorityStats = await db.select({\n        priority: workOrders.priority,\n        count: count()\n      })\n        .from(workOrders)\n        .where(and(...analyticsFilter))\n        .groupBy(workOrders.priority);\n\n      const priorityBreakdown = priorityOrder.map(priority => {\n        const stat = priorityStats.find(s => s.priority === priority);\n        return {\n          priority: priorityLabels[priority] || priority,\n          count: stat ? stat.count : 0\n        };\n      });\n\n      // Get location breakdown (top 5 zones)\n      const locationStats = await db.select({\n        zoneId: workOrders.zoneId,\n        count: count()\n      })\n        .from(workOrders)\n        .where(and(...analyticsFilter, isNotNull(workOrders.zoneId)))\n        .groupBy(workOrders.zoneId)\n        .orderBy(sql`count(*) DESC`)\n        .limit(5);\n\n      // Get zone names\n      const locationBreakdown = await Promise.all(\n        locationStats.map(async (stat) => {\n          const zone = await db.select({ name: zones.name })\n            .from(zones)\n            .where(eq(zones.id, stat.zoneId!))\n            .limit(1);\n          return {\n            zone: zone[0]?.name || 'Desconhecido',\n            count: stat.count\n          };\n        })\n      );\n\n      // Calculate average completion time and percentages\n      const completedOrders = await db.select({\n        createdAt: workOrders.createdAt,\n        completedAt: workOrders.completedAt\n      })\n        .from(workOrders)\n        .where(and(...analyticsFilter, eq(workOrders.status, 'concluida'), isNotNull(workOrders.completedAt)));\n\n      let averageCompletionTime = 0;\n      let completedIn24h = 0;\n      let completedIn4h = 0;\n\n      if (completedOrders.length > 0) {\n        let totalTime = 0;\n        let count24h = 0;\n        let count4h = 0;\n\n        completedOrders.forEach(order => {\n          if (order.createdAt && order.completedAt) {\n            const diff = new Date(order.completedAt).getTime() - new Date(order.createdAt).getTime();\n            const hours = diff / (1000 * 60 * 60);\n            totalTime += hours;\n            \n            if (hours <= 24) count24h++;\n            if (hours <= 4) count4h++;\n          }\n        });\n\n        averageCompletionTime = Math.round((totalTime / completedOrders.length) * 10) / 10;\n        completedIn24h = Math.round((count24h / completedOrders.length) * 100);\n        completedIn4h = Math.round((count4h / completedOrders.length) * 100);\n      }\n\n      return { \n        daily, \n        statusBreakdown, \n        weeklyActivity,\n        priorityBreakdown,\n        locationBreakdown,\n        averageCompletionTime,\n        completedIn24h,\n        completedIn4h\n      };\n    } catch (error) {\n      console.error('Error in getPerformanceAnalytics:', error);\n      throw error;\n    }\n  }\n\n  // Dashboard Goals\n  async getDashboardGoals(companyId: string, module?: 'clean' | 'maintenance'): Promise<DashboardGoal[]> {\n    const whereConditions = module\n      ? and(\n          eq(dashboardGoals.companyId, companyId),\n          eq(dashboardGoals.isActive, true),\n          eq(dashboardGoals.module, module)\n        )\n      : and(eq(dashboardGoals.companyId, companyId), eq(dashboardGoals.isActive, true));\n    \n    return await db.select()\n      .from(dashboardGoals)\n      .where(whereConditions)\n      .orderBy(dashboardGoals.goalType, dashboardGoals.createdAt);\n  }\n\n  async createDashboardGoal(goal: InsertDashboardGoal): Promise<DashboardGoal> {\n    const [newGoal] = await db.insert(dashboardGoals).values({\n      ...goal,\n      id: crypto.randomUUID(),\n      module: goal.module || 'clean', // Default to 'clean' if not specified\n    }).returning();\n    return newGoal;\n  }\n\n  async updateDashboardGoal(id: string, goal: Partial<InsertDashboardGoal>): Promise<DashboardGoal> {\n    const [updatedGoal] = await db.update(dashboardGoals)\n      .set({ ...goal, updatedAt: sql`now()` })\n      .where(eq(dashboardGoals.id, id))\n      .returning();\n    return updatedGoal;\n  }\n\n  async deleteDashboardGoal(id: string): Promise<void> {\n    await db.update(dashboardGoals)\n      .set({ isActive: false, updatedAt: sql`now()` })\n      .where(eq(dashboardGoals.id, id));\n  }\n\n  // Cleaning Heatmap Data with SLA - Shows ALL zones\n  async getCleaningHeatmapData(companyId: string, siteId: string): Promise<any[]> {\n    try {\n      // Get ALL zones for the site (regardless of whether they have data)\n      const allZones = await db.select({\n        zoneId: zones.id,\n        zoneName: zones.name,\n        zoneCategory: zones.category,\n        positionX: zones.positionX,\n        positionY: zones.positionY,\n        areaM2: zones.areaM2,\n        sizeScale: zones.sizeScale\n      })\n      .from(zones)\n      .where(and(eq(zones.siteId, siteId), eq(zones.isActive, true)));\n\n      const heatmapData = await Promise.all(\n        allZones.map(async (zone) => {\n          // Calculate SLA de Limpeza baseado em atividades programadas vs execuções\n          const totalScheduled = await db.select({\n            count: sql<number>`count(*)::int`\n          })\n          .from(cleaningActivities)\n          .where(\n            and(\n              eq(cleaningActivities.companyId, companyId),\n              eq(cleaningActivities.zoneId, zone.zoneId),\n              eq(cleaningActivities.isActive, true)\n            )\n          );\n\n          const completedOnTime = await db.select({\n            count: sql<number>`count(*)::int`\n          })\n          .from(workOrders)\n          .where(\n            and(\n              eq(workOrders.companyId, companyId),\n              eq(workOrders.zoneId, zone.zoneId),\n              eq(workOrders.status, 'concluida'),\n              sql`${workOrders.completedAt} <= ${workOrders.dueDate}`\n            )\n          );\n\n          // Count overdue/open orders (SLA breaking)\n          const overdueOrders = await db.select({\n            count: sql<number>`count(*)::int`\n          })\n          .from(workOrders)\n          .where(\n            and(\n              eq(workOrders.companyId, companyId),\n              eq(workOrders.zoneId, zone.zoneId),\n              or(\n                and(eq(workOrders.status, 'concluida'), sql`${workOrders.completedAt} > ${workOrders.dueDate}`),\n                and(eq(workOrders.status, 'aberta'), sql`${workOrders.dueDate} < NOW()`)\n              )\n            )\n          );\n\n          // Calculate SLA percentage\n          const scheduledCount = totalScheduled[0]?.count || 0;\n          const completedOnTimeCount = completedOnTime[0]?.count || 0;\n          const overdueCount = overdueOrders[0]?.count || 0;\n          const totalOrders = completedOnTimeCount + overdueCount;\n          \n          // Default SLA logic:\n          // - Se tem OS: calcula SLA real\n          // - Se não tem OS mas tem atividades programadas: 100% (está cumprindo)\n          // - Se não tem nada: 100% (considerado cumprindo por falta de demanda)\n          let slaPercentage = 100; // Default para zonas sem dados\n          \n          if (totalOrders > 0) {\n            // Tem ordens de serviço - calcula SLA real\n            slaPercentage = Math.round((completedOnTimeCount / totalOrders) * 100);\n          } else if (scheduledCount > 0) {\n            // Tem atividades programadas mas sem OS - assumir 100% (cumprindo)\n            slaPercentage = 100;\n          }\n          // Caso contrário mantém 100% (zona sem dados = assumir cumprindo)\n          \n          // Determine heat level and color based on SLA\n          let heatLevel: 'excellent' | 'good' | 'warning' | 'critical';\n          let color: string;\n          \n          if (slaPercentage >= 95) {\n            heatLevel = 'excellent';\n            color = '#10B981'; // green-500\n          } else if (slaPercentage >= 85) {\n            heatLevel = 'good';\n            color = '#84CC16'; // lime-500\n          } else if (slaPercentage >= 70) {\n            heatLevel = 'warning';\n            color = '#F59E0B'; // amber-500\n          } else {\n            heatLevel = 'critical';\n            color = '#EF4444'; // red-500\n          }\n\n          return {\n            zoneId: zone.zoneId,\n            zoneName: zone.zoneName,\n            category: zone.zoneCategory,\n            positionX: zone.positionX ? Number(zone.positionX) : null,\n            positionY: zone.positionY ? Number(zone.positionY) : null,\n            areaM2: zone.areaM2 ? Number(zone.areaM2) : 0,\n            sizeScale: zone.sizeScale ? Number(zone.sizeScale) : 1,\n            slaPercentage,\n            heatLevel,\n            color,\n            metrics: {\n              scheduledActivities: scheduledCount,\n              completedOnTime: completedOnTimeCount,\n              overdueOrders: overdueCount,\n              totalOrders\n            }\n          };\n        })\n      );\n\n      return heatmapData;\n    } catch (error) {\n      console.error('Error in getCleaningHeatmapData:', error);\n      throw error;\n    }\n  }\n\n  // Customers\n  async getCustomersByCompany(companyId: string): Promise<Customer[]> {\n    return await db.select()\n      .from(customers)\n      .where(and(eq(customers.companyId, companyId), eq(customers.isActive, true)))\n      .orderBy(customers.name);\n  }\n\n  async getCustomer(id: string): Promise<Customer | undefined> {\n    const [customer] = await db.select()\n      .from(customers)\n      .where(eq(customers.id, id));\n    return customer || undefined;\n  }\n\n  async createCustomer(customer: InsertCustomer): Promise<Customer> {\n    const [newCustomer] = await db.insert(customers).values({\n      ...customer,\n      id: crypto.randomUUID(),\n    }).returning();\n    return newCustomer;\n  }\n\n  async updateCustomer(id: string, customer: Partial<InsertCustomer>): Promise<Customer> {\n    const [updatedCustomer] = await db.update(customers)\n      .set({...customer, updatedAt: sql`now()`})\n      .where(eq(customers.id, id))\n      .returning();\n    return updatedCustomer;\n  }\n\n  async deleteCustomer(id: string): Promise<void> {\n    await db.update(customers)\n      .set({ isActive: false, updatedAt: sql`now()` })\n      .where(eq(customers.id, id));\n  }\n\n  // Custom Roles\n  async getCustomRoles(): Promise<CustomRoleWithPermissions[]> {\n    const roles = await db.select().from(customRoles).where(eq(customRoles.isActive, true));\n    \n    // Para cada role, buscar suas permissões\n    const rolesWithPermissions = await Promise.all(\n      roles.map(async (role) => {\n        const permissions = await db.select()\n          .from(rolePermissions)\n          .where(eq(rolePermissions.roleId, role.id));\n        \n        return {\n          ...role,\n          permissions: permissions.map(p => p.permission)\n        };\n      })\n    );\n    \n    return rolesWithPermissions;\n  }\n\n  async getCustomRoleById(id: string): Promise<CustomRoleWithPermissions | undefined> {\n    const [role] = await db.select().from(customRoles).where(eq(customRoles.id, id));\n    \n    if (!role) return undefined;\n    \n    const permissions = await db.select()\n      .from(rolePermissions)\n      .where(eq(rolePermissions.roleId, id));\n    \n    return {\n      ...role,\n      permissions: permissions.map(p => p.permission)\n    };\n  }\n\n  async createCustomRole(roleData: InsertCustomRole): Promise<CustomRoleWithPermissions> {\n    const [role] = await db.insert(customRoles)\n      .values({\n        ...roleData,\n        id: roleData.id || `role-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\n        companyId: roleData.companyId || 'company-opus-default'\n      })\n      .returning();\n    \n    return {\n      ...role,\n      permissions: []\n    };\n  }\n\n  async updateCustomRole(id: string, roleData: Partial<InsertCustomRole>): Promise<CustomRoleWithPermissions> {\n    const [role] = await db.update(customRoles)\n      .set(roleData)\n      .where(eq(customRoles.id, id))\n      .returning();\n    \n    const permissions = await db.select()\n      .from(rolePermissions)\n      .where(eq(rolePermissions.roleId, id));\n    \n    return {\n      ...role,\n      permissions: permissions.map(p => p.permission)\n    };\n  }\n\n  async deleteCustomRole(id: string): Promise<void> {\n    // Primeiro remover todas as permissões associadas\n    await db.delete(rolePermissions).where(eq(rolePermissions.roleId, id));\n    \n    // Remover todas as atribuições de usuários\n    await db.delete(userRoleAssignments).where(eq(userRoleAssignments.roleId, id));\n    \n    // Por fim, remover a role\n    await db.delete(customRoles).where(eq(customRoles.id, id));\n  }\n\n  async setRolePermissions(roleId: string, permissions: string[]): Promise<void> {\n    // Primeiro remover todas as permissões existentes\n    await db.delete(rolePermissions).where(eq(rolePermissions.roleId, roleId));\n    \n    // Adicionar as novas permissões\n    if (permissions.length > 0) {\n      const permissionEntries = permissions.map((permission, index) => ({\n        id: `rp-${Date.now()}-${index}-${Math.random().toString(36).substr(2, 9)}`,\n        roleId,\n        permission\n      }));\n      \n      await db.insert(rolePermissions).values(permissionEntries as any);\n    }\n  }\n\n  async getUserRoles(userId: string): Promise<UserRoleAssignment[]> {\n    return this.getUserRoleAssignments(userId);\n  }\n\n  async getUserRoleAssignments(userId: string): Promise<UserRoleAssignment[]> {\n    const assignments = await db.select({\n      id: userRoleAssignments.id,\n      userId: userRoleAssignments.userId,\n      roleId: userRoleAssignments.roleId,\n      customerId: userRoleAssignments.customerId,\n      roleName: customRoles.name,\n      roleDescription: customRoles.description,\n      roleIsSystemRole: customRoles.isSystemRole,\n      roleIsActive: customRoles.isActive,\n    })\n    .from(userRoleAssignments)\n    .innerJoin(customRoles, eq(userRoleAssignments.roleId, customRoles.id))\n    .where(eq(userRoleAssignments.userId, userId));\n\n    // Para cada assignment, buscar as permissões da role\n    const assignmentsWithPermissions = await Promise.all(\n      assignments.map(async (assignment) => {\n        const permissions = await db.select()\n          .from(rolePermissions)\n          .where(eq(rolePermissions.roleId, assignment.roleId));\n        \n        return {\n          id: assignment.id,\n          userId: assignment.userId,\n          roleId: assignment.roleId,\n          customerId: assignment.customerId,\n          createdAt: new Date(),\n          role: {\n            id: assignment.roleId,\n            companyId: assignment.userId, // This should be retrieved from user or role context\n            name: assignment.roleName,\n            description: assignment.roleDescription,\n            isSystemRole: assignment.roleIsSystemRole,\n            isActive: assignment.roleIsActive,\n            permissions: permissions.map(p => p.permission)\n          }\n        };\n      })\n    );\n\n    return assignmentsWithPermissions as UserRoleAssignment[];\n  }\n\n  async getRolePermissions(roleId: string): Promise<RolePermission[]> {\n    return await db.select()\n      .from(rolePermissions)\n      .where(eq(rolePermissions.roleId, roleId));\n  }\n\n  async createUserRoleAssignment(assignment: InsertUserRoleAssignment): Promise<UserRoleAssignment> {\n    const [newAssignment] = await db.insert(userRoleAssignments)\n      .values(assignment)\n      .returning();\n    \n    // Buscar o role completo com permissões\n    const role = await this.getCustomRoleById(newAssignment.roleId);\n    \n    return {\n      id: newAssignment.id,\n      userId: newAssignment.userId,\n      roleId: newAssignment.roleId,\n      customerId: newAssignment.customerId,\n      createdAt: newAssignment.createdAt,\n      role: role!\n    } as UserRoleAssignment;\n  }\n\n  async deleteUserRoleAssignment(userId: string, roleId: string): Promise<void> {\n    await db.delete(userRoleAssignments)\n      .where(and(\n        eq(userRoleAssignments.userId, userId),\n        eq(userRoleAssignments.roleId, roleId)\n      ));\n  }\n\n  // System Users (OPUS employees)\n  async getOpusUsers(): Promise<User[]> {\n    // OPUS users are those with userType = 'opus_user' and NO customerId\n    // These are OPUS CLEAN employees who have access to all clients with filters\n    return await db.select()\n      .from(users)\n      .where(and(\n        eq(users.userType, 'opus_user'),\n        isNull(users.customerId),\n        eq(users.isActive, true)\n      ))\n      .orderBy(users.name);\n  }\n\n  // User Site Assignments\n  async getUserSiteAssignments(userId: string): Promise<UserSiteAssignment[]> {\n    return await db.select()\n      .from(userSiteAssignments)\n      .where(eq(userSiteAssignments.userId, userId));\n  }\n\n  async getUsersBySite(siteId: string): Promise<User[]> {\n    const assignments = await db.select({\n      userId: userSiteAssignments.userId\n    })\n      .from(userSiteAssignments)\n      .where(eq(userSiteAssignments.siteId, siteId));\n\n    if (assignments.length === 0) {\n      return [];\n    }\n\n    const userIds = assignments.map(a => a.userId);\n    return await db.select()\n      .from(users)\n      .where(inArray(users.id, userIds))\n      .orderBy(users.name);\n  }\n\n  async createUserSiteAssignment(assignment: InsertUserSiteAssignment): Promise<UserSiteAssignment> {\n    const [newAssignment] = await db.insert(userSiteAssignments)\n      .values(assignment)\n      .returning();\n    return newAssignment;\n  }\n\n  async deleteUserSiteAssignment(userId: string, siteId: string): Promise<void> {\n    await db.delete(userSiteAssignments)\n      .where(and(\n        eq(userSiteAssignments.userId, userId),\n        eq(userSiteAssignments.siteId, siteId)\n      ));\n  }\n\n  // Public Request Logs (spam control)\n  async createPublicRequestLog(log: InsertPublicRequestLog): Promise<PublicRequestLog> {\n    const [newLog] = await db.insert(publicRequestLogs)\n      .values(log)\n      .returning();\n    return newLog;\n  }\n\n  async checkRecentPublicRequests(ipHash: string, qrCodePointId: string, hoursWindow: number): Promise<number> {\n    const [result] = await db.select({ count: count() })\n      .from(publicRequestLogs)\n      .where(and(\n        eq(publicRequestLogs.ipHash, ipHash),\n        eq(publicRequestLogs.qrCodePointId, qrCodePointId),\n        sql`${publicRequestLogs.createdAt} > NOW() - INTERVAL '${hoursWindow} hours'`\n      ));\n    return result.count;\n  }\n\n  // Site Shifts\n  async getSiteShifts(siteId: string): Promise<SiteShift[]> {\n    return await db.select()\n      .from(siteShifts)\n      .where(eq(siteShifts.siteId, siteId))\n      .orderBy(siteShifts.name);\n  }\n\n  async createSiteShift(shift: InsertSiteShift): Promise<SiteShift> {\n    const [newShift] = await db.insert(siteShifts)\n      .values(shift)\n      .returning();\n    return newShift;\n  }\n\n  async updateSiteShift(id: string, shift: Partial<InsertSiteShift>): Promise<SiteShift> {\n    const [updatedShift] = await db.update(siteShifts)\n      .set({ ...shift, updatedAt: sql`now()` })\n      .where(eq(siteShifts.id, id))\n      .returning();\n    return updatedShift;\n  }\n\n  async deleteSiteShift(id: string): Promise<void> {\n    await db.delete(siteShifts)\n      .where(eq(siteShifts.id, id));\n  }\n\n  // Bathroom Counter Logs (auditing)\n  async createBathroomCounterLog(log: InsertBathroomCounterLog): Promise<BathroomCounterLog> {\n    const [newLog] = await db.insert(bathroomCounterLogs)\n      .values(log)\n      .returning();\n    return newLog;\n  }\n\n  async getBathroomCounterLogs(zoneId: string, limit: number = 50): Promise<BathroomCounterLog[]> {\n    // Get bathroom counter for this zone first\n    const counter = await this.getBathroomCounterByZone(zoneId);\n    if (!counter) {\n      return [];\n    }\n\n    return await db.select()\n      .from(bathroomCounterLogs)\n      .where(eq(bathroomCounterLogs.counterId, counter.id))\n      .orderBy(desc(bathroomCounterLogs.createdAt))\n      .limit(limit);\n  }\n\n  // Company Counters (sequential numbering)\n  async getCompanyCounter(companyId: string, key: string): Promise<CompanyCounter | undefined> {\n    const [counter] = await db.select()\n      .from(companyCounters)\n      .where(and(\n        eq(companyCounters.companyId, companyId),\n        eq(companyCounters.key, key)\n      ));\n    return counter;\n  }\n\n  async createCompanyCounter(counter: InsertCompanyCounter): Promise<CompanyCounter> {\n    const [newCounter] = await db.insert(companyCounters)\n      .values({\n        ...counter,\n        id: counter.id || `cc-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`\n      })\n      .returning();\n    return newCounter;\n  }\n\n  async incrementCompanyCounter(companyId: string, key: string): Promise<number> {\n    // Try to increment existing counter\n    const [result] = await db.update(companyCounters)\n      .set({\n        nextNumber: sql`${companyCounters.nextNumber} + 1`,\n        updatedAt: sql`now()`\n      })\n      .where(and(\n        eq(companyCounters.companyId, companyId),\n        eq(companyCounters.key, key)\n      ))\n      .returning({ nextNumber: companyCounters.nextNumber });\n\n    if (result && result.nextNumber !== null) {\n      return result.nextNumber;\n    }\n\n    // If no existing counter, create one\n    const newCounter = await this.createCompanyCounter({\n      id: `cc-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\n      companyId,\n      key,\n      nextNumber: 2 // Since we're returning 1 for the first use\n    });\n    \n    return 1; // First number\n  }\n\n  // Reports Metrics - KPI cards for reports page\n  async getReportsMetrics(companyId: string, period: string): Promise<{\n    completedWorkOrders: number;\n    completedWorkOrdersChange: string;\n    averageSLA: number;\n    averageSLAChange: string;\n    totalAreaCleaned: number;\n    totalAreaCleanedChange: string;\n    averageExecutionTime: number;\n    averageExecutionTimeChange: string;\n  }> {\n    try {\n      // Build date filter based on period (in days)\n      const periodDays = parseInt(period) || 30;\n      const previousPeriodDays = periodDays * 2; // For comparison\n      \n      // Current period filter\n      const currentPeriodFilter = sql`${workOrders.createdAt} >= CURRENT_DATE - INTERVAL '${sql.raw(periodDays.toString())} days'`;\n      const previousPeriodFilter = sql`${workOrders.createdAt} >= CURRENT_DATE - INTERVAL '${sql.raw(previousPeriodDays.toString())} days' AND ${workOrders.createdAt} < CURRENT_DATE - INTERVAL '${sql.raw(periodDays.toString())} days'`;\n      \n      // 1. Completed Work Orders\n      const [currentCompleted] = await db.select({ count: count() })\n        .from(workOrders)\n        .where(and(\n          eq(workOrders.companyId, companyId),\n          eq(workOrders.status, 'concluida'),\n          currentPeriodFilter\n        ));\n      \n      const [previousCompleted] = await db.select({ count: count() })\n        .from(workOrders)\n        .where(and(\n          eq(workOrders.companyId, companyId),\n          eq(workOrders.status, 'concluida'),\n          previousPeriodFilter\n        ));\n      \n      const completedChange = previousCompleted.count > 0 \n        ? Math.round(((currentCompleted.count - previousCompleted.count) / previousCompleted.count) * 100)\n        : currentCompleted.count > 0 ? 100 : 0;\n      \n      // 2. Average SLA (percentage of tasks completed on time)\n      const [currentSLAStats] = await db.select({\n        total: count(),\n        onTime: sql<number>`COUNT(CASE WHEN ${workOrders.completedAt} <= ${workOrders.dueDate} THEN 1 END)::int`\n      })\n        .from(workOrders)\n        .where(and(\n          eq(workOrders.companyId, companyId),\n          eq(workOrders.status, 'concluida'),\n          currentPeriodFilter,\n          isNotNull(workOrders.dueDate),\n          isNotNull(workOrders.completedAt)\n        ));\n      \n      const [previousSLAStats] = await db.select({\n        total: count(),\n        onTime: sql<number>`COUNT(CASE WHEN ${workOrders.completedAt} <= ${workOrders.dueDate} THEN 1 END)::int`\n      })\n        .from(workOrders)\n        .where(and(\n          eq(workOrders.companyId, companyId),\n          eq(workOrders.status, 'concluida'),\n          previousPeriodFilter,\n          isNotNull(workOrders.dueDate),\n          isNotNull(workOrders.completedAt)\n        ));\n      \n      const currentSLA = currentSLAStats.total > 0 ? Math.round((currentSLAStats.onTime / currentSLAStats.total) * 100) : 0;\n      const previousSLA = previousSLAStats.total > 0 ? Math.round((previousSLAStats.onTime / previousSLAStats.total) * 100) : 0;\n      const slaChange = previousSLA > 0 ? currentSLA - previousSLA : currentSLA > 0 ? 100 : 0;\n      \n      // 3. Total Area Cleaned (sum of zones from completed work orders)\n      const [currentAreaResult] = await db.select({\n        totalArea: sql<number>`COALESCE(SUM(CAST(${zones.areaM2} AS NUMERIC)), 0)::int`\n      })\n        .from(workOrders)\n        .innerJoin(zones, eq(workOrders.zoneId, zones.id))\n        .where(and(\n          eq(workOrders.companyId, companyId),\n          eq(workOrders.status, 'concluida'),\n          currentPeriodFilter\n        ));\n      \n      const [previousAreaResult] = await db.select({\n        totalArea: sql<number>`COALESCE(SUM(CAST(${zones.areaM2} AS NUMERIC)), 0)::int`\n      })\n        .from(workOrders)\n        .innerJoin(zones, eq(workOrders.zoneId, zones.id))\n        .where(and(\n          eq(workOrders.companyId, companyId),\n          eq(workOrders.status, 'concluida'),\n          previousPeriodFilter\n        ));\n      \n      const areaChange = previousAreaResult.totalArea > 0 \n        ? Math.round(((currentAreaResult.totalArea - previousAreaResult.totalArea) / previousAreaResult.totalArea) * 100)\n        : currentAreaResult.totalArea > 0 ? 100 : 0;\n      \n      // 4. Average Execution Time (in minutes)\n      const [currentTimeResult] = await db.select({\n        avgTime: sql<number>`COALESCE(AVG(EXTRACT(EPOCH FROM (${workOrders.completedAt} - ${workOrders.startedAt}))/60), 0)::int`\n      })\n        .from(workOrders)\n        .where(and(\n          eq(workOrders.companyId, companyId),\n          eq(workOrders.status, 'concluida'),\n          currentPeriodFilter,\n          isNotNull(workOrders.startedAt),\n          isNotNull(workOrders.completedAt)\n        ));\n      \n      const [previousTimeResult] = await db.select({\n        avgTime: sql<number>`COALESCE(AVG(EXTRACT(EPOCH FROM (${workOrders.completedAt} - ${workOrders.startedAt}))/60), 0)::int`\n      })\n        .from(workOrders)\n        .where(and(\n          eq(workOrders.companyId, companyId),\n          eq(workOrders.status, 'concluida'),\n          previousPeriodFilter,\n          isNotNull(workOrders.startedAt),\n          isNotNull(workOrders.completedAt)\n        ));\n      \n      const timeChange = previousTimeResult.avgTime > 0 \n        ? Math.round(((currentTimeResult.avgTime - previousTimeResult.avgTime) / previousTimeResult.avgTime) * 100)\n        : currentTimeResult.avgTime > 0 ? 100 : 0;\n      \n      return {\n        completedWorkOrders: currentCompleted.count,\n        completedWorkOrdersChange: `${completedChange >= 0 ? '+' : ''}${completedChange}%`,\n        averageSLA: currentSLA,\n        averageSLAChange: `${slaChange >= 0 ? '+' : ''}${slaChange}%`,\n        totalAreaCleaned: currentAreaResult.totalArea,\n        totalAreaCleanedChange: `${areaChange >= 0 ? '+' : ''}${areaChange}%`,\n        averageExecutionTime: currentTimeResult.avgTime,\n        averageExecutionTimeChange: `${timeChange >= 0 ? '+' : ''}${timeChange}%`\n      };\n    } catch (error) {\n      console.error('Error in getReportsMetrics:', error);\n      throw error;\n    }\n  }\n\n  // Work Orders Status Distribution for charts\n  async getWorkOrdersStatusDistribution(companyId: string, period: string): Promise<{\n    status: string;\n    count: number;\n    label: string;\n    color: string;\n  }[]> {\n    try {\n      const periodDays = parseInt(period) || 30;\n      const dateFilter = sql`${workOrders.createdAt} >= CURRENT_DATE - INTERVAL '${sql.raw(periodDays.toString())} days'`;\n      \n      const statusStats = await db.select({\n        status: workOrders.status,\n        count: count()\n      })\n        .from(workOrders)\n        .where(and(\n          eq(workOrders.companyId, companyId),\n          dateFilter\n        ))\n        .groupBy(workOrders.status);\n      \n      const statusMap = {\n        'concluida': { label: 'Concluídas', color: 'bg-green-500' },\n        'vencida': { label: 'Vencidas', color: 'bg-red-500' },\n        'aberta': { label: 'Abertas', color: 'bg-yellow-500' }\n      };\n      \n      return statusStats.map(stat => ({\n        status: stat.status,\n        count: stat.count,\n        label: statusMap[stat.status as keyof typeof statusMap]?.label || stat.status,\n        color: statusMap[stat.status as keyof typeof statusMap]?.color || 'bg-gray-500'\n      }));\n    } catch (error) {\n      console.error('Error in getWorkOrdersStatusDistribution:', error);\n      throw error;\n    }\n  }\n\n  // SLA Performance Breakdown for charts\n  async getSLAPerformanceBreakdown(companyId: string, period: string): Promise<{\n    totalSLA: number;\n    categories: {\n      category: string;\n      percentage: number;\n      color: string;\n      label: string;\n    }[];\n  }> {\n    try {\n      const periodDays = parseInt(period) || 30;\n      const dateFilter = sql`${workOrders.createdAt} >= CURRENT_DATE - INTERVAL '${sql.raw(periodDays.toString())} days'`;\n      \n      // Get overall SLA performance\n      const [slaStats] = await db.select({\n        total: count(),\n        onTime: sql<number>`COUNT(CASE WHEN ${workOrders.completedAt} <= ${workOrders.dueDate} THEN 1 END)::int`,\n        late: sql<number>`COUNT(CASE WHEN ${workOrders.completedAt} > ${workOrders.dueDate} THEN 1 END)::int`,\n        pending: sql<number>`COUNT(CASE WHEN ${workOrders.status} != 'concluida' AND ${workOrders.dueDate} > NOW() THEN 1 END)::int`,\n        overdue: sql<number>`COUNT(CASE WHEN ${workOrders.status} != 'concluida' AND ${workOrders.dueDate} <= NOW() THEN 1 END)::int`\n      })\n        .from(workOrders)\n        .where(and(\n          eq(workOrders.companyId, companyId),\n          dateFilter,\n          isNotNull(workOrders.dueDate)\n        ));\n      \n      const total = slaStats.total;\n      const totalSLA = total > 0 ? Math.round((slaStats.onTime / total) * 100) : 87; // Default to 87% if no data\n      \n      if (total === 0) {\n        // Return default data if no work orders found\n        return {\n          totalSLA: 87,\n          categories: [\n            { category: 'onTime', percentage: 87, color: 'bg-green-500', label: 'No Prazo' },\n            { category: 'atRisk', percentage: 8, color: 'bg-yellow-500', label: 'Em Risco' },\n            { category: 'overdue', percentage: 5, color: 'bg-red-500', label: 'Vencidos' }\n          ]\n        };\n      }\n      \n      const categories = [\n        {\n          category: 'onTime',\n          percentage: Math.round((slaStats.onTime / total) * 100),\n          color: 'bg-green-500',\n          label: 'No Prazo'\n        },\n        {\n          category: 'atRisk',\n          percentage: Math.round((slaStats.pending / total) * 100),\n          color: 'bg-yellow-500',\n          label: 'Em Risco'\n        },\n        {\n          category: 'overdue',\n          percentage: Math.round(((slaStats.late + slaStats.overdue) / total) * 100),\n          color: 'bg-red-500',\n          label: 'Vencidos'\n        }\n      ];\n      \n      return {\n        totalSLA,\n        categories\n      };\n    } catch (error) {\n      console.error('Error in getSLAPerformanceBreakdown:', error);\n      // Return default data on error\n      return {\n        totalSLA: 87,\n        categories: [\n          { category: 'onTime', percentage: 87, color: 'bg-green-500', label: 'No Prazo' },\n          { category: 'atRisk', percentage: 8, color: 'bg-yellow-500', label: 'Em Risco' },\n          { category: 'overdue', percentage: 5, color: 'bg-red-500', label: 'Vencidos' }\n        ]\n      };\n    }\n  }\n\n  // ============================================================================\n  // MAINTENANCE MODULE - Equipment Implementation\n  // ============================================================================\n  \n  async getEquipmentByCustomer(customerId: string, module?: 'clean' | 'maintenance'): Promise<Equipment[]> {\n    const conditions = [eq(equipment.customerId, customerId)];\n    if (module) {\n      conditions.push(eq(equipment.module, module));\n    }\n    return await db.select()\n      .from(equipment)\n      .where(and(...conditions))\n      .orderBy(desc(equipment.createdAt));\n  }\n\n  async getEquipmentBySite(siteId: string, module?: 'clean' | 'maintenance'): Promise<Equipment[]> {\n    const conditions = [eq(equipment.siteId, siteId)];\n    if (module) {\n      conditions.push(eq(equipment.module, module));\n    }\n    return await db.select()\n      .from(equipment)\n      .where(and(...conditions))\n      .orderBy(desc(equipment.createdAt));\n  }\n\n  async getEquipmentByZone(zoneId: string, module?: 'clean' | 'maintenance'): Promise<Equipment[]> {\n    const conditions = [eq(equipment.zoneId, zoneId)];\n    if (module) {\n      conditions.push(eq(equipment.module, module));\n    }\n    return await db.select()\n      .from(equipment)\n      .where(and(...conditions))\n      .orderBy(desc(equipment.createdAt));\n  }\n\n  async getEquipment(id: string): Promise<Equipment | undefined> {\n    const [result] = await db.select().from(equipment).where(eq(equipment.id, id));\n    return result;\n  }\n\n  async createEquipment(equipmentData: InsertEquipment): Promise<Equipment> {\n    const id = nanoid();\n    const [newEquipment] = await db.insert(equipment).values({ \n      ...equipmentData, \n      id \n    }).returning();\n    return newEquipment;\n  }\n\n  async updateEquipment(id: string, equipmentData: Partial<InsertEquipment>): Promise<Equipment> {\n    const [updatedEquipment] = await db.update(equipment)\n      .set({ ...equipmentData, updatedAt: sql`now()` })\n      .where(eq(equipment.id, id))\n      .returning();\n    return updatedEquipment;\n  }\n\n  async deleteEquipment(id: string): Promise<void> {\n    await db.delete(equipment).where(eq(equipment.id, id));\n  }\n\n  // Maintenance Checklist Templates Implementation\n  \n  async getMaintenanceChecklistTemplatesByCustomer(customerId: string, module?: 'clean' | 'maintenance'): Promise<MaintenanceChecklistTemplate[]> {\n    const conditions = [eq(maintenanceChecklistTemplates.customerId, customerId)];\n    if (module) {\n      conditions.push(eq(maintenanceChecklistTemplates.module, module));\n    }\n    return await db.select()\n      .from(maintenanceChecklistTemplates)\n      .where(and(...conditions))\n      .orderBy(desc(maintenanceChecklistTemplates.createdAt));\n  }\n\n  async getMaintenanceChecklistTemplatesByEquipmentType(customerId: string, equipmentType: string, module?: 'clean' | 'maintenance'): Promise<MaintenanceChecklistTemplate[]> {\n    const conditions = [\n      eq(maintenanceChecklistTemplates.customerId, customerId),\n      eq(maintenanceChecklistTemplates.equipmentType, equipmentType)\n    ];\n    if (module) {\n      conditions.push(eq(maintenanceChecklistTemplates.module, module));\n    }\n    return await db.select()\n      .from(maintenanceChecklistTemplates)\n      .where(and(...conditions))\n      .orderBy(desc(maintenanceChecklistTemplates.createdAt));\n  }\n\n  async getMaintenanceChecklistTemplatesByEquipment(equipmentId: string): Promise<MaintenanceChecklistTemplate[]> {\n    return await db.select()\n      .from(maintenanceChecklistTemplates)\n      .where(eq(maintenanceChecklistTemplates.equipmentId, equipmentId))\n      .orderBy(desc(maintenanceChecklistTemplates.createdAt));\n  }\n\n  async getMaintenanceChecklistTemplate(id: string): Promise<MaintenanceChecklistTemplate | undefined> {\n    const [result] = await db.select().from(maintenanceChecklistTemplates).where(eq(maintenanceChecklistTemplates.id, id));\n    return result;\n  }\n\n  async createMaintenanceChecklistTemplate(template: InsertMaintenanceChecklistTemplate): Promise<MaintenanceChecklistTemplate> {\n    const id = nanoid();\n    const [newTemplate] = await db.insert(maintenanceChecklistTemplates).values({ \n      ...template, \n      id \n    }).returning();\n    return newTemplate;\n  }\n\n  async updateMaintenanceChecklistTemplate(id: string, template: Partial<InsertMaintenanceChecklistTemplate>): Promise<MaintenanceChecklistTemplate> {\n    const [updatedTemplate] = await db.update(maintenanceChecklistTemplates)\n      .set({ ...template, updatedAt: sql`now()` })\n      .where(eq(maintenanceChecklistTemplates.id, id))\n      .returning();\n    return updatedTemplate;\n  }\n\n  async deleteMaintenanceChecklistTemplate(id: string): Promise<void> {\n    await db.delete(maintenanceChecklistTemplates).where(eq(maintenanceChecklistTemplates.id, id));\n  }\n\n  // Maintenance Checklist Executions Implementation\n  \n  async getMaintenanceChecklistExecutionsByEquipment(equipmentId: string): Promise<MaintenanceChecklistExecution[]> {\n    return await db.select()\n      .from(maintenanceChecklistExecutions)\n      .where(eq(maintenanceChecklistExecutions.equipmentId, equipmentId))\n      .orderBy(desc(maintenanceChecklistExecutions.createdAt));\n  }\n\n  async getMaintenanceChecklistExecutionsByWorkOrder(workOrderId: string): Promise<MaintenanceChecklistExecution[]> {\n    return await db.select()\n      .from(maintenanceChecklistExecutions)\n      .where(eq(maintenanceChecklistExecutions.workOrderId, workOrderId))\n      .orderBy(desc(maintenanceChecklistExecutions.createdAt));\n  }\n\n  async getMaintenanceChecklistExecution(id: string): Promise<MaintenanceChecklistExecution | undefined> {\n    const [result] = await db.select().from(maintenanceChecklistExecutions).where(eq(maintenanceChecklistExecutions.id, id));\n    return result;\n  }\n\n  async createMaintenanceChecklistExecution(execution: InsertMaintenanceChecklistExecution): Promise<MaintenanceChecklistExecution> {\n    const id = nanoid();\n    const [newExecution] = await db.insert(maintenanceChecklistExecutions).values({ \n      ...execution, \n      id \n    }).returning();\n    return newExecution;\n  }\n\n  async updateMaintenanceChecklistExecution(id: string, execution: Partial<InsertMaintenanceChecklistExecution>): Promise<MaintenanceChecklistExecution> {\n    const [updatedExecution] = await db.update(maintenanceChecklistExecutions)\n      .set({ ...execution, updatedAt: sql`now()` })\n      .where(eq(maintenanceChecklistExecutions.id, id))\n      .returning();\n    return updatedExecution;\n  }\n\n  async deleteMaintenanceChecklistExecution(id: string): Promise<void> {\n    await db.delete(maintenanceChecklistExecutions).where(eq(maintenanceChecklistExecutions.id, id));\n  }\n\n  // Maintenance Plans Implementation\n  \n  async getMaintenancePlansByCustomer(customerId: string, module?: 'clean' | 'maintenance'): Promise<MaintenancePlan[]> {\n    const conditions = [eq(maintenancePlans.customerId, customerId)];\n    if (module) {\n      conditions.push(eq(maintenancePlans.module, module));\n    }\n    return await db.select()\n      .from(maintenancePlans)\n      .where(and(...conditions))\n      .orderBy(desc(maintenancePlans.createdAt));\n  }\n\n  async getMaintenancePlan(id: string): Promise<MaintenancePlan | undefined> {\n    const [result] = await db.select().from(maintenancePlans).where(eq(maintenancePlans.id, id));\n    return result;\n  }\n\n  async createMaintenancePlan(plan: InsertMaintenancePlan): Promise<MaintenancePlan> {\n    const id = nanoid();\n    const [newPlan] = await db.insert(maintenancePlans).values({ \n      ...plan, \n      id \n    }).returning();\n    return newPlan;\n  }\n\n  async updateMaintenancePlan(id: string, plan: Partial<InsertMaintenancePlan>): Promise<MaintenancePlan> {\n    const [updatedPlan] = await db.update(maintenancePlans)\n      .set({ ...plan, updatedAt: sql`now()` })\n      .where(eq(maintenancePlans.id, id))\n      .returning();\n    return updatedPlan;\n  }\n\n  async deleteMaintenancePlan(id: string): Promise<void> {\n    await db.delete(maintenancePlans).where(eq(maintenancePlans.id, id));\n  }\n\n  // Maintenance Plan Equipments Implementation\n  \n  async getMaintenancePlanEquipmentsByPlan(planId: string): Promise<MaintenancePlanEquipment[]> {\n    return await db.select()\n      .from(maintenancePlanEquipments)\n      .where(eq(maintenancePlanEquipments.planId, planId))\n      .orderBy(desc(maintenancePlanEquipments.createdAt));\n  }\n\n  async getMaintenancePlanEquipmentsByEquipment(equipmentId: string): Promise<MaintenancePlanEquipment[]> {\n    return await db.select()\n      .from(maintenancePlanEquipments)\n      .where(eq(maintenancePlanEquipments.equipmentId, equipmentId))\n      .orderBy(desc(maintenancePlanEquipments.createdAt));\n  }\n\n  async getMaintenancePlanEquipment(id: string): Promise<MaintenancePlanEquipment | undefined> {\n    const [result] = await db.select().from(maintenancePlanEquipments).where(eq(maintenancePlanEquipments.id, id));\n    return result;\n  }\n\n  async createMaintenancePlanEquipment(planEquipment: InsertMaintenancePlanEquipment): Promise<MaintenancePlanEquipment> {\n    const id = nanoid();\n    const [newPlanEquipment] = await db.insert(maintenancePlanEquipments).values({ \n      ...planEquipment, \n      id \n    }).returning();\n    return newPlanEquipment;\n  }\n\n  async updateMaintenancePlanEquipment(id: string, planEquipment: Partial<InsertMaintenancePlanEquipment>): Promise<MaintenancePlanEquipment> {\n    const [updatedPlanEquipment] = await db.update(maintenancePlanEquipments)\n      .set({ ...planEquipment, updatedAt: sql`now()` })\n      .where(eq(maintenancePlanEquipments.id, id))\n      .returning();\n    return updatedPlanEquipment;\n  }\n\n  async deleteMaintenancePlanEquipment(id: string): Promise<void> {\n    await db.delete(maintenancePlanEquipments).where(eq(maintenancePlanEquipments.id, id));\n  }\n\n  // Equipment Types Implementation\n  \n  async getEquipmentTypesByCompany(companyId: string, module?: 'clean' | 'maintenance'): Promise<EquipmentType[]> {\n    const conditions = [eq(equipmentTypes.companyId, companyId)];\n    if (module) {\n      conditions.push(eq(equipmentTypes.module, module));\n    }\n    return await db.select()\n      .from(equipmentTypes)\n      .where(and(...conditions))\n      .orderBy(desc(equipmentTypes.createdAt));\n  }\n\n  async getEquipmentType(id: string): Promise<EquipmentType | undefined> {\n    const [result] = await db.select().from(equipmentTypes).where(eq(equipmentTypes.id, id));\n    return result;\n  }\n\n  async createEquipmentType(equipmentType: InsertEquipmentType): Promise<EquipmentType> {\n    const id = nanoid();\n    const [newEquipmentType] = await db.insert(equipmentTypes).values({ \n      ...equipmentType, \n      id \n    }).returning();\n    return newEquipmentType;\n  }\n\n  async updateEquipmentType(id: string, equipmentType: Partial<InsertEquipmentType>): Promise<EquipmentType> {\n    const [updatedEquipmentType] = await db.update(equipmentTypes)\n      .set({ ...equipmentType, updatedAt: sql`now()` })\n      .where(eq(equipmentTypes.id, id))\n      .returning();\n    return updatedEquipmentType;\n  }\n\n  async deleteEquipmentType(id: string): Promise<void> {\n    await db.delete(equipmentTypes).where(eq(equipmentTypes.id, id));\n  }\n}\n\nexport const storage = new DatabaseStorage();\n","size_bytes":174866},"client/src/hooks/use-toast.ts":{"content":"import * as React from \"react\"\n\nimport type {\n  ToastActionElement,\n  ToastProps,\n} from \"@/components/ui/toast\"\n\nconst TOAST_LIMIT = 1\nconst TOAST_REMOVE_DELAY = 1000000\n\ntype ToasterToast = ToastProps & {\n  id: string\n  title?: React.ReactNode\n  description?: React.ReactNode\n  action?: ToastActionElement\n}\n\nconst actionTypes = {\n  ADD_TOAST: \"ADD_TOAST\",\n  UPDATE_TOAST: \"UPDATE_TOAST\",\n  DISMISS_TOAST: \"DISMISS_TOAST\",\n  REMOVE_TOAST: \"REMOVE_TOAST\",\n} as const\n\nlet count = 0\n\nfunction genId() {\n  count = (count + 1) % Number.MAX_SAFE_INTEGER\n  return count.toString()\n}\n\ntype ActionType = typeof actionTypes\n\ntype Action =\n  | {\n      type: ActionType[\"ADD_TOAST\"]\n      toast: ToasterToast\n    }\n  | {\n      type: ActionType[\"UPDATE_TOAST\"]\n      toast: Partial<ToasterToast>\n    }\n  | {\n      type: ActionType[\"DISMISS_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n  | {\n      type: ActionType[\"REMOVE_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n\ninterface State {\n  toasts: ToasterToast[]\n}\n\nconst toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\n\nconst addToRemoveQueue = (toastId: string) => {\n  if (toastTimeouts.has(toastId)) {\n    return\n  }\n\n  const timeout = setTimeout(() => {\n    toastTimeouts.delete(toastId)\n    dispatch({\n      type: \"REMOVE_TOAST\",\n      toastId: toastId,\n    })\n  }, TOAST_REMOVE_DELAY)\n\n  toastTimeouts.set(toastId, timeout)\n}\n\nexport const reducer = (state: State, action: Action): State => {\n  switch (action.type) {\n    case \"ADD_TOAST\":\n      return {\n        ...state,\n        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\n      }\n\n    case \"UPDATE_TOAST\":\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === action.toast.id ? { ...t, ...action.toast } : t\n        ),\n      }\n\n    case \"DISMISS_TOAST\": {\n      const { toastId } = action\n\n      // ! Side effects ! - This could be extracted into a dismissToast() action,\n      // but I'll keep it here for simplicity\n      if (toastId) {\n        addToRemoveQueue(toastId)\n      } else {\n        state.toasts.forEach((toast) => {\n          addToRemoveQueue(toast.id)\n        })\n      }\n\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === toastId || toastId === undefined\n            ? {\n                ...t,\n                open: false,\n              }\n            : t\n        ),\n      }\n    }\n    case \"REMOVE_TOAST\":\n      if (action.toastId === undefined) {\n        return {\n          ...state,\n          toasts: [],\n        }\n      }\n      return {\n        ...state,\n        toasts: state.toasts.filter((t) => t.id !== action.toastId),\n      }\n  }\n}\n\nconst listeners: Array<(state: State) => void> = []\n\nlet memoryState: State = { toasts: [] }\n\nfunction dispatch(action: Action) {\n  memoryState = reducer(memoryState, action)\n  listeners.forEach((listener) => {\n    listener(memoryState)\n  })\n}\n\ntype Toast = Omit<ToasterToast, \"id\">\n\nfunction toast({ ...props }: Toast) {\n  const id = genId()\n\n  const update = (props: ToasterToast) =>\n    dispatch({\n      type: \"UPDATE_TOAST\",\n      toast: { ...props, id },\n    })\n  const dismiss = () => dispatch({ type: \"DISMISS_TOAST\", toastId: id })\n\n  dispatch({\n    type: \"ADD_TOAST\",\n    toast: {\n      ...props,\n      id,\n      open: true,\n      onOpenChange: (open) => {\n        if (!open) dismiss()\n      },\n    },\n  })\n\n  return {\n    id: id,\n    dismiss,\n    update,\n  }\n}\n\nfunction useToast() {\n  const [state, setState] = React.useState<State>(memoryState)\n\n  React.useEffect(() => {\n    listeners.push(setState)\n    return () => {\n      const index = listeners.indexOf(setState)\n      if (index > -1) {\n        listeners.splice(index, 1)\n      }\n    }\n  }, [state])\n\n  return {\n    ...state,\n    toast,\n    dismiss: (toastId?: string) => dispatch({ type: \"DISMISS_TOAST\", toastId }),\n  }\n}\n\nexport { useToast, toast }\n","size_bytes":3895},"client/src/components/ui/drawer.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Drawer as DrawerPrimitive } from \"vaul\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Drawer = ({\n  shouldScaleBackground = true,\n  ...props\n}: React.ComponentProps<typeof DrawerPrimitive.Root>) => (\n  <DrawerPrimitive.Root\n    shouldScaleBackground={shouldScaleBackground}\n    {...props}\n  />\n)\nDrawer.displayName = \"Drawer\"\n\nconst DrawerTrigger = DrawerPrimitive.Trigger\n\nconst DrawerPortal = DrawerPrimitive.Portal\n\nconst DrawerClose = DrawerPrimitive.Close\n\nconst DrawerOverlay = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Overlay\n    ref={ref}\n    className={cn(\"fixed inset-0 z-50 bg-black/80\", className)}\n    {...props}\n  />\n))\nDrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName\n\nconst DrawerContent = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DrawerPortal>\n    <DrawerOverlay />\n    <DrawerPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background\",\n        className\n      )}\n      {...props}\n    >\n      <div className=\"mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted\" />\n      {children}\n    </DrawerPrimitive.Content>\n  </DrawerPortal>\n))\nDrawerContent.displayName = \"DrawerContent\"\n\nconst DrawerHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"grid gap-1.5 p-4 text-center sm:text-left\", className)}\n    {...props}\n  />\n)\nDrawerHeader.displayName = \"DrawerHeader\"\n\nconst DrawerFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"mt-auto flex flex-col gap-2 p-4\", className)}\n    {...props}\n  />\n)\nDrawerFooter.displayName = \"DrawerFooter\"\n\nconst DrawerTitle = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDrawerTitle.displayName = DrawerPrimitive.Title.displayName\n\nconst DrawerDescription = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDrawerDescription.displayName = DrawerPrimitive.Description.displayName\n\nexport {\n  Drawer,\n  DrawerPortal,\n  DrawerOverlay,\n  DrawerTrigger,\n  DrawerClose,\n  DrawerContent,\n  DrawerHeader,\n  DrawerFooter,\n  DrawerTitle,\n  DrawerDescription,\n}\n","size_bytes":3021},"client/src/lib/utils.ts":{"content":"import { clsx, type ClassValue } from \"clsx\"\nimport { twMerge } from \"tailwind-merge\"\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs))\n}\n","size_bytes":166},"client/src/index.css":{"content":"@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');\n\n@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\n:root {\n  --radius: 0.5rem;\n  --background: hsl(0 0% 100%);\n  --foreground: hsl(215 25% 15%);\n  --card: hsl(0 0% 100%);\n  --card-foreground: hsl(215 25% 15%);\n  --popover: hsl(0 0% 100%);\n  --popover-foreground: hsl(215 25% 15%);\n  --primary: hsl(215 84% 27%);\n  --primary-foreground: hsl(0 0% 100%);\n  --secondary: hsl(215 14% 34%);\n  --secondary-foreground: hsl(0 0% 100%);\n  --muted: hsl(215 20% 92%);\n  --muted-foreground: hsl(215 14% 45%);\n  --accent: hsl(215 20% 92%);\n  --accent-foreground: hsl(215 25% 15%);\n  --destructive: hsl(0 84% 60%);\n  --destructive-foreground: hsl(210 40% 98%);\n  --border: hsl(215 20% 88%);\n  --input: hsl(215 20% 88%);\n  --ring: hsl(215 84% 27%);\n  --chart-1: hsl(215 84% 27%);\n  --chart-2: hsl(215 14% 34%);\n  --chart-3: hsl(215 20% 50%);\n  --chart-4: hsl(43 74% 66%);\n  --chart-5: hsl(215 30% 65%);\n  --sidebar: hsl(215 25% 98%);\n  --sidebar-foreground: hsl(215 25% 15%);\n  --sidebar-primary: hsl(215 84% 27%);\n  --sidebar-primary-foreground: hsl(0 0% 100%);\n  --sidebar-accent: hsl(215 20% 92%);\n  --sidebar-accent-foreground: hsl(215 84% 27%);\n  --sidebar-border: hsl(215 20% 88%);\n  --sidebar-ring: hsl(215 84% 27%);\n  --module-primary: #1e3a8a;\n  --module-secondary: #3b82f6;\n  --module-accent: #60a5fa;\n  --font-sans: 'Inter', system-ui, -apple-system, sans-serif;\n  --font-serif: Georgia, serif;\n  --font-mono: Menlo, monospace;\n}\n\n[data-module=\"clean\"] {\n  --primary: hsl(215 84% 27%);\n  --ring: hsl(215 84% 27%);\n  --chart-1: hsl(215 84% 27%);\n  --sidebar-primary: hsl(215 84% 27%);\n  --sidebar-ring: hsl(215 84% 27%);\n  --module-primary: #1e3a8a;\n  --module-secondary: #3b82f6;\n  --module-accent: #60a5fa;\n}\n\n[data-module=\"maintenance\"] {\n  --primary: hsl(26 100% 50%);\n  --ring: hsl(26 100% 50%);\n  --chart-1: hsl(26 98% 50%);\n  --sidebar-primary: hsl(26 100% 50%);\n  --sidebar-ring: hsl(26 100% 50%);\n  --module-primary: #FF9800;\n  --module-secondary: #FB8C00;\n  --module-accent: #FFB74D;\n}\n\n.dark {\n  --background: hsl(215 28% 8%);\n  --foreground: hsl(215 20% 95%);\n  --card: hsl(215 28% 8%);\n  --card-foreground: hsl(215 20% 95%);\n  --popover: hsl(215 28% 8%);\n  --popover-foreground: hsl(215 20% 95%);\n  --primary: hsl(215 35% 55%); /* Lighter OPUS Navy for dark mode */\n  --primary-foreground: hsl(215 28% 8%);\n  --secondary: hsl(215 20% 20%);\n  --secondary-foreground: hsl(215 20% 95%);\n  --muted: hsl(215 20% 20%);\n  --muted-foreground: hsl(215 14% 65%);\n  --accent: hsl(215 20% 20%);\n  --accent-foreground: hsl(215 20% 95%);\n  --destructive: hsl(0 62% 30%);\n  --destructive-foreground: hsl(210 40% 98%);\n  --border: hsl(215 20% 20%);\n  --input: hsl(215 20% 20%);\n  --ring: hsl(215 35% 55%);\n  --sidebar: hsl(215 28% 10%);\n  --sidebar-foreground: hsl(215 20% 90%);\n  --sidebar-primary: hsl(215 35% 55%); /* OPUS Navy adapted for dark */\n  --sidebar-primary-foreground: hsl(0 0% 100%);\n  --sidebar-accent: hsl(215 20% 18%);\n  --sidebar-accent-foreground: hsl(215 35% 65%);\n  --sidebar-border: hsl(215 20% 25%);\n  --sidebar-ring: hsl(215 35% 55%);\n  --opus-navy: hsl(215 35% 55%); /* Adapted for dark mode */\n  --opus-slate: hsl(215 14% 65%); /* Adapted for dark mode */\n  --opus-light: hsl(215 20% 20%); /* Dark accent */\n}\n\n@layer base {\n  * {\n    @apply border-border;\n  }\n  \n  html {\n    height: 100%;\n  }\n\n  body {\n    @apply font-sans antialiased bg-background text-foreground;\n    height: 100%;\n    overflow-x: hidden;\n    overflow-y: auto;\n  }\n  \n  #root {\n    min-height: 100vh;\n    width: 100vw;\n    overflow-x: hidden;\n    overflow-y: auto;\n  }\n}\n\n@layer components {\n  /* Force select dropdown arrow to be visible */\n  [data-radix-select-trigger] svg,\n  .select-trigger svg {\n    display: block !important;\n    opacity: 0.5 !important;\n    pointer-events: none;\n  }\n}\n\n/* Custom animations for interactive charts */\n@keyframes fade-in {\n  from {\n    opacity: 0;\n    transform: translateY(10px);\n  }\n  to {\n    opacity: 1;\n    transform: translateY(0);\n  }\n}\n\n@keyframes pulse-slow {\n  0%, 100% {\n    opacity: 1;\n  }\n  50% {\n    opacity: 0.8;\n  }\n}\n\n.animate-fade-in {\n  animation: fade-in 0.8s ease-out;\n}\n\n.animate-pulse-slow {\n  animation: pulse-slow 3s infinite;\n}\n","size_bytes":4294},"client/src/components/work-order-modal.tsx":{"content":"import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useState, useEffect } from \"react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { X, Check, TriangleAlert, Clock, Camera, MapPin, User, AlertCircle, Calendar, Timer, Eye, Star, Flag, PlayCircle, PauseCircle } from \"lucide-react\";\nimport { Input } from \"@/components/ui/input\";\nimport { format } from \"date-fns\";\nimport { ptBR } from \"date-fns/locale\";\n\ninterface WorkOrderModalProps {\n  workOrderId: string;\n  onClose: () => void;\n}\n\nexport default function WorkOrderModal({ workOrderId, onClose }: WorkOrderModalProps) {\n  const [formData, setFormData] = useState({\n    status: \"\",\n    assignedUserId: \"\",\n    priority: \"\",\n    observations: \"\",\n    scheduledDate: \"\",\n    dueDate: \"\"\n  });\n  const [checklistItems, setChecklistItems] = useState<any[]>([]);\n  const [photos, setPhotos] = useState<File[]>([]);\n  const [photoPreviewUrls, setPhotoPreviewUrls] = useState<string[]>([]);\n  const [newComment, setNewComment] = useState(\"\");\n  const [commentPhotos, setCommentPhotos] = useState<File[]>([]);\n  const [commentPhotoPreviewUrls, setCommentPhotoPreviewUrls] = useState<string[]>([]);\n  const [selectedRating, setSelectedRating] = useState<number | null>(null);\n  const [ratingComment, setRatingComment] = useState(\"\");\n  \n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  \n  // Get current user\n  const authStr = localStorage.getItem('opus_clean_auth');\n  const currentUser = authStr ? JSON.parse(authStr).user : null;\n\n  // Get work order details\n  const { data: workOrder, isLoading } = useQuery({\n    queryKey: [\"/api/work-orders\", workOrderId],\n    enabled: !!workOrderId,\n  });\n\n  // Get execution time from backend (calcula baseado nos registros de status)\n  const { data: executionTime } = useQuery({\n    queryKey: [\"/api/work-orders\", workOrderId, \"execution-time\"],\n    enabled: !!workOrderId,\n    refetchInterval: (workOrder as any)?.status === 'em_execucao' ? 1000 : false, // Atualiza a cada 1s se estiver em execução\n  });\n\n  // Get company users for assignment\n  const { data: users } = useQuery({\n    queryKey: [\"/api/companies\", (workOrder as any)?.companyId, \"users\"],\n    enabled: !!(workOrder as any)?.companyId,\n  });\n\n  // Get zones to find zone name\n  const { data: zones } = useQuery({\n    queryKey: [\"/api/companies\", (workOrder as any)?.companyId, \"zones\"],\n    enabled: !!(workOrder as any)?.companyId,\n  });\n\n  // Get customer ID from work order\n  const customerId = (workOrder as any)?.companyId;\n  const workOrderModule = (workOrder as any)?.module;\n  const maintenanceTemplateId = (workOrder as any)?.maintenanceChecklistTemplateId;\n  const cleanTemplateId = (workOrder as any)?.checklistTemplateId;\n\n  // Get checklist template for this work order (cleaning module)\n  const { data: checklistTemplate } = useQuery({\n    queryKey: [\"/api/companies\", customerId, \"checklist-templates\"],\n    enabled: !!customerId && workOrderModule === 'clean',\n  });\n\n  // Get maintenance checklist template for this work order (maintenance module) - Busca direta por ID\n  const { data: maintenanceChecklistTemplate } = useQuery({\n    queryKey: [\"/api/maintenance-checklist-templates\", maintenanceTemplateId],\n    enabled: !!maintenanceTemplateId && workOrderModule === 'maintenance',\n  });\n\n  // Get SLA config for work order type\n  const { data: slaConfigs } = useQuery({\n    queryKey: [\"/api/companies\", (workOrder as any)?.companyId, \"sla-configs\"],\n    enabled: !!(workOrder as any)?.companyId,\n  });\n\n  // Get services and service categories\n  const { data: services } = useQuery({\n    queryKey: [\"/api/companies\", (workOrder as any)?.companyId, \"services\"],\n    enabled: !!(workOrder as any)?.companyId,\n  });\n\n  // Get work order comments\n  const { data: comments } = useQuery({\n    queryKey: [\"/api/work-orders\", workOrderId, \"comments\"],\n    enabled: !!workOrderId,\n  });\n\n  // Initialize form data when workOrder loads\n  useEffect(() => {\n    if (workOrder) {\n      setFormData({\n        status: (workOrder as any).status || \"aberta\",\n        assignedUserId: (workOrder as any).assignedUserId || \"unassigned\",\n        priority: (workOrder as any).priority || \"media\",\n        observations: (workOrder as any).observations || \"\",\n        scheduledDate: (workOrder as any).scheduledDate ? new Date((workOrder as any).scheduledDate).toISOString().split('T')[0] : \"\",\n        dueDate: (workOrder as any).dueDate ? new Date((workOrder as any).dueDate).toISOString().split('T')[0] : \"\"\n      });\n\n      // Initialize checklist items from the work order or template\n      const items = (workOrder as any).checklistData || \n                   (checklistTemplate as any[])?.[0]?.items || \n                   [];\n      \n      // Ensure items is always an array\n      const itemsArray = Array.isArray(items) ? items : [];\n      \n      setChecklistItems(itemsArray.map((item: any, index: number) => ({\n        ...item,\n        id: item.id || `item-${index}`,\n        completed: (workOrder as any).checklistProgress?.[item.id] || false\n      })));\n    }\n  }, [workOrder, checklistTemplate]);\n\n  const updateWorkOrderMutation = useMutation({\n    mutationFn: async (data: any) => {\n      const updateData = {\n        ...data,\n        assignedUserId: data.assignedUserId === \"unassigned\" ? null : data.assignedUserId,\n        checklistProgress: checklistItems.reduce((acc, item) => {\n          acc[item.id] = item.completed;\n          return acc;\n        }, {} as Record<string, boolean>),\n        scheduledDate: data.scheduledDate ? new Date(data.scheduledDate).toISOString() : null,\n        dueDate: data.dueDate ? new Date(data.dueDate).toISOString() : null,\n        estimatedHours: data.estimatedHours ? parseFloat(data.estimatedHours) : null\n      };\n      \n      // Remove empty strings to avoid database constraints\n      Object.keys(updateData).forEach(key => {\n        if (updateData[key] === \"\") {\n          updateData[key] = null;\n        }\n      });\n      \n      return await apiRequest(\"PUT\", `/api/work-orders/${workOrderId}`, updateData);\n    },\n    onSuccess: () => {\n      toast({ title: \"Ordem de serviço atualizada com sucesso!\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/work-orders\"] });\n      onClose();\n    },\n    onError: () => {\n      toast({ \n        title: \"Erro ao atualizar ordem de serviço\", \n        variant: \"destructive\" \n      });\n    },\n  });\n\n  const addCommentMutation = useMutation({\n    mutationFn: async (commentData: any) => {\n      return await apiRequest(\"POST\", `/api/work-orders/${workOrderId}/comments`, commentData);\n    },\n    onSuccess: () => {\n      toast({ title: \"Comentário adicionado!\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/work-orders\", workOrderId, \"comments\"] });\n      setNewComment(\"\");\n      setCommentPhotos([]);\n      setCommentPhotoPreviewUrls([]);\n    },\n    onError: () => {\n      toast({ \n        title: \"Erro ao adicionar comentário\", \n        variant: \"destructive\" \n      });\n    },\n  });\n\n  const submitRatingMutation = useMutation({\n    mutationFn: async (ratingData: { rating: number; comment: string; userId: string }) => {\n      return await apiRequest(\"POST\", `/api/work-orders/${workOrderId}/rating`, ratingData);\n    },\n    onSuccess: () => {\n      toast({ \n        title: \"Avaliação enviada com sucesso!\",\n        description: \"Obrigado pelo seu feedback.\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/work-orders\", workOrderId] });\n      setSelectedRating(null);\n      setRatingComment(\"\");\n    },\n    onError: () => {\n      toast({ \n        title: \"Erro ao enviar avaliação\", \n        variant: \"destructive\" \n      });\n    },\n  });\n\n  const handleSave = () => {\n    updateWorkOrderMutation.mutate(formData);\n  };\n\n  const handleSubmitRating = () => {\n    if (!selectedRating || !currentUser) return;\n    \n    submitRatingMutation.mutate({\n      rating: selectedRating,\n      comment: ratingComment,\n      userId: currentUser.id,\n    });\n  };\n\n  const handleAddComment = async () => {\n    if (!newComment.trim() && commentPhotos.length === 0) return;\n    \n    // Convert photos to base64 for storage\n    const attachments = await Promise.all(\n      commentPhotos.map(file => {\n        return new Promise((resolve) => {\n          const reader = new FileReader();\n          reader.onloadend = () => resolve({ url: reader.result, type: file.type, name: file.name });\n          reader.readAsDataURL(file);\n        });\n      })\n    );\n\n    addCommentMutation.mutate({\n      userId: \"admin-user-default\", // TODO: Get from session\n      comment: newComment || \"Anexo(s) adicionado(s)\",\n      attachments: attachments.length > 0 ? attachments : undefined,\n    });\n  };\n\n  const handleCommentPhotoSelect = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const files = Array.from(e.target.files || []);\n    \n    const validFiles = files.filter(file => {\n      if (file.size > 5 * 1024 * 1024) {\n        toast({\n          title: `Arquivo ${file.name} é muito grande`,\n          description: \"O tamanho máximo é 5MB\",\n          variant: \"destructive\"\n        });\n        return false;\n      }\n      return true;\n    });\n\n    setCommentPhotos(prev => [...prev, ...validFiles]);\n\n    validFiles.forEach(file => {\n      const reader = new FileReader();\n      reader.onloadend = () => {\n        setCommentPhotoPreviewUrls(prev => [...prev, reader.result as string]);\n      };\n      reader.readAsDataURL(file);\n    });\n\n    e.target.value = '';\n  };\n\n  const handleRemoveCommentPhoto = (index: number) => {\n    setCommentPhotos(prev => prev.filter((_, i) => i !== index));\n    setCommentPhotoPreviewUrls(prev => prev.filter((_, i) => i !== index));\n  };\n\n  const handleChecklistChange = (itemId: string, completed: boolean) => {\n    setChecklistItems(prev => \n      prev.map(item => \n        item.id === itemId ? { ...item, completed } : item\n      )\n    );\n  };\n\n  const handlePhotoSelect = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const files = Array.from(e.target.files || []);\n    \n    // Validate file size (max 5MB per file)\n    const validFiles = files.filter(file => {\n      if (file.size > 5 * 1024 * 1024) {\n        toast({\n          title: `Arquivo ${file.name} é muito grande`,\n          description: \"O tamanho máximo é 5MB\",\n          variant: \"destructive\"\n        });\n        return false;\n      }\n      return true;\n    });\n\n    // Add to photos array\n    setPhotos(prev => [...prev, ...validFiles]);\n\n    // Create preview URLs\n    validFiles.forEach(file => {\n      const reader = new FileReader();\n      reader.onloadend = () => {\n        setPhotoPreviewUrls(prev => [...prev, reader.result as string]);\n      };\n      reader.readAsDataURL(file);\n    });\n\n    // Reset input\n    e.target.value = '';\n  };\n\n  const handleRemovePhoto = (index: number) => {\n    setPhotos(prev => prev.filter((_, i) => i !== index));\n    setPhotoPreviewUrls(prev => prev.filter((_, i) => i !== index));\n  };\n\n  const getStatusBadge = (status: string) => {\n    switch (status) {\n      case \"vencida\":\n        return <Badge variant=\"destructive\">Vencida</Badge>;\n      case \"concluida\":\n        return <Badge className=\"bg-green-100 text-green-800\">Concluída</Badge>;\n      default:\n        return <Badge variant=\"outline\">Aberta</Badge>;\n    }\n  };\n\n  const getPriorityBadge = (priority: string) => {\n    switch (priority) {\n      case \"critica\":\n        return <Badge variant=\"destructive\">Crítica</Badge>;\n      case \"alta\":\n        return <Badge className=\"bg-orange-100 text-orange-800\">Alta</Badge>;\n      case \"media\":\n        return <Badge className=\"bg-yellow-100 text-yellow-800\">Média</Badge>;\n      default:\n        return <Badge variant=\"outline\">Baixa</Badge>;\n    }\n  };\n\n  const getZoneName = () => {\n    const zone = (zones as any[] || []).find((z: any) => z.id === (workOrder as any)?.zoneId);\n    return zone?.name || 'Local não encontrado';\n  };\n\n  if (isLoading) {\n    return (\n      <Dialog open={true} onOpenChange={onClose}>\n        <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\">\n          <div className=\"flex items-center justify-center p-8\">\n            <div className=\"text-center space-y-2\">\n              <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto\"></div>\n              <p className=\"text-sm text-muted-foreground\">Carregando ordem de serviço...</p>\n            </div>\n          </div>\n        </DialogContent>\n      </Dialog>\n    );\n  }\n\n  return (\n    <Dialog open={true} onOpenChange={onClose}>\n      <DialogContent className=\"max-w-5xl max-h-[90vh] overflow-y-auto\" data-testid=\"work-order-modal\">\n        <DialogHeader>\n          <div>\n            <DialogTitle className=\"text-2xl font-bold text-foreground\">\n              OS #{(workOrder as any)?.number || workOrderId.slice(0, 8)}\n            </DialogTitle>\n            <DialogDescription className=\"text-base\">\n              {(workOrder as any)?.title || \"Ordem de Serviço\"}\n            </DialogDescription>\n            <div className=\"flex items-center gap-4 mt-2\">\n              <div className=\"flex items-center gap-1 text-sm text-muted-foreground\">\n                <MapPin className=\"w-4 h-4\" />\n                {getZoneName()}\n              </div>\n              <div className=\"flex items-center gap-1 text-sm text-muted-foreground\">\n                <Clock className=\"w-4 h-4\" />\n                Criada em {(workOrder as any)?.createdAt ? new Date((workOrder as any).createdAt).toLocaleDateString('pt-BR') : \"--\"}\n              </div>\n            </div>\n          </div>\n        </DialogHeader>\n        \n        <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-8\">\n          {/* Work Order Details */}\n          <div className=\"space-y-6\">\n            <div className=\"flex items-center gap-4\">\n              <div className=\"space-y-1\">\n                <span className=\"text-sm font-medium\">Status</span>\n                <div>{getStatusBadge((workOrder as any)?.status)}</div>\n              </div>\n              <div className=\"space-y-1\">\n                <span className=\"text-sm font-medium\">Prioridade</span>\n                <div>{getPriorityBadge((workOrder as any)?.priority)}</div>\n              </div>\n            </div>\n\n            <div className=\"space-y-4\">\n              <div>\n                <label className=\"block text-sm font-medium text-foreground mb-2\">Alterar Status</label>\n                <Select value={formData.status} onValueChange={(value) => setFormData(prev => ({...prev, status: value}))}>\n                  <SelectTrigger data-testid=\"select-status\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"aberta\">Aberta</SelectItem>\n                    <SelectItem value=\"concluida\">Concluída</SelectItem>\n                    <SelectItem value=\"vencida\">Vencida</SelectItem>\n                    <SelectItem value=\"cancelada\">Cancelada</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n              \n              <div>\n                <label className=\"block text-sm font-medium text-foreground mb-2\">Responsável</label>\n                <Select value={formData.assignedUserId} onValueChange={(value) => setFormData(prev => ({...prev, assignedUserId: value}))}>\n                  <SelectTrigger data-testid=\"select-assigned-user\">\n                    <SelectValue placeholder=\"Selecione um responsável\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"unassigned\">Não atribuído</SelectItem>\n                    {(users as any[] || [])\n                      .filter((user: any) => user.role === \"operador\" || user.role === \"supervisor_site\")\n                      .map((user: any) => (\n                        <SelectItem key={user.id} value={user.id}>\n                          <div className=\"flex items-center gap-2\">\n                            <User className=\"w-4 h-4\" />\n                            {user.name}\n                          </div>\n                        </SelectItem>\n                      ))}\n                  </SelectContent>\n                </Select>\n              </div>\n              \n              <div>\n                <label className=\"block text-sm font-medium text-foreground mb-2\">Prioridade</label>\n                <Select value={formData.priority} onValueChange={(value) => setFormData(prev => ({...prev, priority: value}))}>\n                  <SelectTrigger data-testid=\"select-priority\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"baixa\">Baixa</SelectItem>\n                    <SelectItem value=\"media\">Média</SelectItem>\n                    <SelectItem value=\"alta\">Alta</SelectItem>\n                    <SelectItem value=\"critica\">Crítica</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n              \n              {/* Date Configuration Section */}\n              <div className=\"space-y-4 p-4 bg-blue-50 rounded-lg border border-blue-200\">\n                <h4 className=\"font-semibold text-blue-900 flex items-center gap-2\">\n                  <Calendar className=\"w-4 h-4\" />\n                  Configurações de Data\n                </h4>\n                \n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                  <div>\n                    <label className=\"block text-sm font-medium mb-2\">Data Agendada</label>\n                    <Input \n                      type=\"date\"\n                      value={formData.scheduledDate}\n                      onChange={(e) => setFormData(prev => ({...prev, scheduledDate: e.target.value}))}\n                      data-testid=\"input-scheduled-date\"\n                    />\n                  </div>\n                  \n                  <div>\n                    <label className=\"block text-sm font-medium mb-2\">Data Limite</label>\n                    <Input \n                      type=\"date\"\n                      value={formData.dueDate}\n                      onChange={(e) => setFormData(prev => ({...prev, dueDate: e.target.value}))}\n                      data-testid=\"input-due-date\"\n                    />\n                  </div>\n                  \n                  {/* Datas de Execução - Apenas visualização */}\n                  {((workOrder as any)?.startedAt || (workOrder as any)?.completedAt) && (\n                    <div className=\"col-span-2 p-3 bg-gray-50 rounded-lg border\">\n                      <h5 className=\"font-medium text-gray-700 flex items-center gap-2 mb-3\">\n                        <Eye className=\"w-4 h-4\" />\n                        Status de Execução (Operador App)\n                      </h5>\n                      <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                        <div>\n                          <span className=\"text-gray-600\">Iniciado em:</span>\n                          <p className=\"font-medium\">\n                            {(workOrder as any)?.startedAt \n                              ? format(new Date((workOrder as any).startedAt), \"dd/MM/yyyy HH:mm\", { locale: ptBR })\n                              : \"Não iniciado\"\n                            }\n                          </p>\n                        </div>\n                        <div>\n                          <span className=\"text-gray-600\">Concluído em:</span>\n                          <p className=\"font-medium\">\n                            {(workOrder as any)?.completedAt \n                              ? format(new Date((workOrder as any).completedAt), \"dd/MM/yyyy HH:mm\", { locale: ptBR })\n                              : \"Não concluído\"\n                            }\n                          </p>\n                        </div>\n                      </div>\n                    </div>\n                  )}\n                </div>\n                \n                <div>\n                  <label className=\"block text-sm font-medium mb-2 flex items-center gap-2\">\n                    <Timer className=\"w-4 h-4\" />\n                    Tempo Real de Execução\n                  </label>\n                  <div className=\"px-3 py-2 bg-slate-50 border border-slate-200 rounded-md text-sm font-medium text-slate-900\">\n                    {(executionTime as any)?.formatted || \"Carregando...\"}\n                  </div>\n                  <p className=\"text-xs text-slate-500 mt-1\">\n                    Tempo que a OS ficou em execução (pausas descontadas)\n                  </p>\n                </div>\n              </div>\n\n              {/* SLA and Service Information */}\n              <div className=\"space-y-4 p-4 bg-green-50 rounded-lg border border-green-200\">\n                <h4 className=\"font-semibold text-green-900 flex items-center gap-2\">\n                  <AlertCircle className=\"w-4 h-4\" />\n                  Informações de SLA e Serviços\n                </h4>\n                \n                {Array.isArray(slaConfigs) && slaConfigs.length > 0 && (\n                  <div>\n                    <span className=\"text-sm font-medium\">SLA Configurado:</span>\n                    <div className=\"mt-1 text-sm text-green-800\">\n                      {slaConfigs.map((sla: any) => (\n                        <div key={sla.id} className=\"bg-white p-2 rounded border\">\n                          <div>{sla.serviceType} - {sla.priority}</div>\n                          <div className=\"text-xs\">Tempo limite: {sla.responseTimeHours}h</div>\n                        </div>\n                      ))}\n                    </div>\n                  </div>\n                )}\n                \n                {Array.isArray(services) && services.length > 0 && (\n                  <div>\n                    <span className=\"text-sm font-medium\">Serviços Relacionados:</span>\n                    <div className=\"mt-1 text-sm\">\n                      {services.filter((service: any) => \n                        service.zoneId === (workOrder as any)?.zoneId\n                      ).map((service: any) => (\n                        <div key={service.id} className=\"bg-white p-2 rounded border mb-1\">\n                          <div className=\"font-medium\">{service.name}</div>\n                          <div className=\"text-xs text-gray-600\">{service.description}</div>\n                        </div>\n                      ))}\n                    </div>\n                  </div>\n                )}\n              </div>\n              \n              <div>\n                <label className=\"block text-sm font-medium text-foreground mb-2\">Observações</label>\n                <Textarea \n                  className=\"h-32\" \n                  placeholder=\"Adicione observações sobre esta OS...\"\n                  value={formData.observations}\n                  onChange={(e) => setFormData(prev => ({...prev, observations: e.target.value}))}\n                  data-testid=\"textarea-observations\"\n                />\n              </div>\n            </div>\n          </div>\n          \n          {/* Dynamic Checklist */}\n          <div className=\"space-y-6\">\n            <div className=\"flex items-center justify-between\">\n              <h3 className=\"text-lg font-semibold text-foreground\">Checklist</h3>\n              <span className=\"text-sm text-muted-foreground\">\n                {checklistItems.filter(item => item.completed).length} de {checklistItems.length} completos\n              </span>\n            </div>\n            \n            {checklistItems.length > 0 ? (\n              <div className=\"space-y-3\">\n                {checklistItems.map((item, index) => (\n                  <div key={item.id} className={`flex items-center space-x-3 p-4 border rounded-lg transition-colors ${\n                    item.completed ? 'bg-green-50 border-green-200' : 'border-gray-200 hover:border-gray-300'\n                  }`}>\n                    <Checkbox \n                      checked={item.completed}\n                      onCheckedChange={(checked) => handleChecklistChange(item.id, !!checked)}\n                      data-testid={`checkbox-${index}`}\n                    />\n                    <div className=\"flex-1\">\n                      <span className={`text-sm ${item.completed ? 'line-through text-muted-foreground' : 'text-foreground'}`}>\n                        {item.label || item.name}\n                      </span>\n                      {item.description && (\n                        <p className=\"text-xs text-muted-foreground mt-1\">{item.description}</p>\n                      )}\n                    </div>\n                    {item.completed ? (\n                      <Check className=\"w-5 h-5 text-green-600\" />\n                    ) : item.required ? (\n                      <AlertCircle className=\"w-5 h-5 text-orange-500\" />\n                    ) : (\n                      <Clock className=\"w-5 h-5 text-muted-foreground\" />\n                    )}\n                  </div>\n                ))}\n              </div>\n            ) : (\n              <div className=\"text-center py-8 text-muted-foreground\">\n                <AlertCircle className=\"w-8 h-8 mx-auto mb-2\" />\n                <p>Nenhum checklist disponível para esta OS</p>\n                <p className=\"text-sm\">Configure um template de checklist no sistema</p>\n              </div>\n            )}\n            \n            {/* Dados da Finalização (se OS está concluída e tem checklistData) */}\n            {(workOrder as any)?.status === 'concluida' && (workOrder as any)?.checklistData && (\n              <div className=\"mt-6 space-y-4 border-t pt-4\">\n                <h3 className=\"text-lg font-semibold text-green-700 flex items-center gap-2\">\n                  <Check className=\"w-5 h-5\" />\n                  Dados da Finalização\n                </h3>\n                \n                <div className=\"bg-green-50 border border-green-200 rounded-lg p-4 space-y-3\">\n                  {Object.entries((workOrder as any).checklistData).map(([itemId, answer]: [string, any]) => {\n                    // Buscar o template correto baseado no módulo\n                    const currentTemplate = (workOrder as any).module === 'maintenance' \n                      ? maintenanceChecklistTemplate  // Agora é um objeto único, não array\n                      : (checklistTemplate as any[])?.[0]; // Cleaning ainda retorna array\n                    \n                    // Encontrar o item do template para pegar o rótulo\n                    const templateItem = currentTemplate?.items?.find((item: any) => item.id === itemId);\n                    \n                    // Tentar diferentes campos para o rótulo\n                    const itemTitle = templateItem?.label || templateItem?.title || templateItem?.name || templateItem?.text || itemId;\n                    \n                    return (\n                      <div key={itemId} className=\"space-y-2\">\n                        <p className=\"font-medium text-sm text-gray-700\">{itemTitle}</p>\n                        \n                        {/* Se for array (múltiplas respostas de texto) */}\n                        {Array.isArray(answer) && (\n                          <div className=\"space-y-1\">\n                            {answer.map((item: string, idx: number) => (\n                              <p key={idx} className=\"text-sm text-gray-600 bg-white p-2 rounded border border-green-200\">\n                                {item}\n                              </p>\n                            ))}\n                          </div>\n                        )}\n                        \n                        {/* Se for foto */}\n                        {answer?.type === 'photo' && answer?.photos && (\n                          <div className=\"flex gap-2 flex-wrap\">\n                            {answer.photos.map((photo: string, idx: number) => (\n                              <img \n                                key={idx}\n                                src={photo} \n                                alt={`${itemTitle} - Foto ${idx + 1}`}\n                                className=\"w-24 h-24 object-cover rounded border border-green-300\"\n                              />\n                            ))}\n                            <span className=\"text-xs text-green-700 self-center\">\n                              {answer.count} foto(s)\n                            </span>\n                          </div>\n                        )}\n                        \n                        {/* Se for checkbox */}\n                        {typeof answer === 'boolean' && (\n                          <span className={`text-sm ${answer ? 'text-green-700' : 'text-gray-500'}`}>\n                            {answer ? '✓ Sim' : '✗ Não'}\n                          </span>\n                        )}\n                        \n                        {/* Se for texto simples */}\n                        {typeof answer === 'string' && (\n                          <p className=\"text-sm text-gray-600 bg-white p-2 rounded border border-green-200\">\n                            {answer}\n                          </p>\n                        )}\n                      </div>\n                    );\n                  })}\n                </div>\n              </div>\n            )}\n\n            {/* Histórico da Ordem */}\n            <div className=\"mt-6 space-y-4 border-t pt-4\">\n              <h3 className=\"text-lg font-semibold text-blue-900 flex items-center gap-2\">\n                <Clock className=\"w-5 h-5\" />\n                Histórico da Ordem\n              </h3>\n              \n              <div className=\"bg-gradient-to-br from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-4\">\n                <div className=\"space-y-3\">\n                  {/* Abertura da OS */}\n                  <div className=\"flex gap-3\">\n                    <div className=\"flex flex-col items-center\">\n                      <div className=\"w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center\">\n                        <Flag className=\"w-4 h-4 text-white\" />\n                      </div>\n                      {(comments as any[])?.length > 0 && <div className=\"w-0.5 h-full bg-blue-300 mt-1\"></div>}\n                    </div>\n                    <div className={`flex-1 ${(comments as any[])?.length > 0 ? 'pb-4' : ''}`}>\n                      <p className=\"font-semibold text-slate-900\">OS Criada</p>\n                      <p className=\"text-sm text-slate-600\">\n                        {(workOrder as any)?.createdAt \n                          ? format(new Date((workOrder as any).createdAt), \"dd/MM/yyyy HH:mm\", { locale: ptBR })\n                          : \"--\"\n                        }\n                      </p>\n                    </div>\n                  </div>\n\n                  {/* Histórico de comentários (mudanças de status) */}\n                  {(comments as any[])?.map((comment: any, index: number) => {\n                    const isLastItem = index === (comments as any[]).length - 1;\n                    let icon = <PlayCircle className=\"w-4 h-4 text-white\" />;\n                    let bgColor = \"bg-green-500\";\n                    \n                    if (comment.comment.includes('pausou')) {\n                      icon = <PauseCircle className=\"w-4 h-4 text-white\" />;\n                      bgColor = \"bg-orange-500\";\n                    } else if (comment.comment.includes('retomou') || comment.comment.includes('iniciou')) {\n                      icon = <PlayCircle className=\"w-4 h-4 text-white\" />;\n                      bgColor = \"bg-blue-500\";\n                    } else if (comment.comment.includes('finalizou') || comment.comment.includes('concluiu')) {\n                      icon = <Check className=\"w-4 h-4 text-white\" />;\n                      bgColor = \"bg-green-600\";\n                    }\n\n                    return (\n                      <div key={comment.id} className=\"flex gap-3\">\n                        <div className=\"flex flex-col items-center\">\n                          <div className={`w-8 h-8 rounded-full ${bgColor} flex items-center justify-center`}>\n                            {icon}\n                          </div>\n                          {!isLastItem && <div className=\"w-0.5 h-full bg-blue-300 mt-1\"></div>}\n                        </div>\n                        <div className={`flex-1 ${!isLastItem ? 'pb-4' : ''}`}>\n                          <p className=\"font-semibold text-slate-900\">{comment.comment.split('\\n')[0]}</p>\n                          <p className=\"text-sm text-slate-600\">\n                            {format(new Date(comment.createdAt), \"dd/MM/yyyy HH:mm\", { locale: ptBR })}\n                          </p>\n                          {comment.user?.name && (\n                            <p className=\"text-xs text-slate-500 mt-1\">Por: {comment.user.name}</p>\n                          )}\n                        </div>\n                      </div>\n                    );\n                  })}\n                </div>\n              </div>\n            </div>\n\n            {/* Comments Section */}\n            <div className=\"mt-6 space-y-4\">\n              <div className=\"flex items-center justify-between\">\n                <h3 className=\"text-lg font-semibold\">Comentários</h3>\n                <Badge variant=\"outline\">\n                  {(comments as any[])?.filter((c: any) => {\n                    // Filtrar apenas comentários de usuários (não de sistema)\n                    const text = c.comment || '';\n                    const isSystemComment = text.includes('⏯️') || text.includes('⏸️') || text.includes('▶️') || \n                                          text.includes('iniciou a execução') || text.includes('pausou a OS') || \n                                          text.includes('retomou a execução') || text.includes('finalizou') ||\n                                          text.includes('OS Finalizada!') || text.includes('✅ Checklist');\n                    return !isSystemComment;\n                  }).length || 0}\n                </Badge>\n              </div>\n              \n              {/* Comments List */}\n              <div className=\"space-y-3 max-h-64 overflow-y-auto\">\n                {(comments as any[])  && (comments as any[]).length > 0 ? (\n                  (comments as any[])\n                    .filter((comment: any) => {\n                      // Filtrar comentários de sistema\n                      const text = comment.comment || '';\n                      const isSystemComment = text.includes('⏯️') || text.includes('⏸️') || text.includes('▶️') || \n                                            text.includes('iniciou a execução') || text.includes('pausou a OS') || \n                                            text.includes('retomou a execução') || text.includes('finalizou') ||\n                                            text.includes('OS Finalizada!') || text.includes('✅ Checklist');\n                      return !isSystemComment;\n                    })\n                    .map((comment: any) => (\n                    <div key={comment.id} className=\"border rounded-lg p-4 space-y-2\">\n                      <div className=\"flex items-start justify-between\">\n                        <div className=\"flex items-center space-x-2\">\n                          <User className=\"w-4 h-4 text-muted-foreground\" />\n                          <span className=\"text-sm font-medium\">\n                            {(users as any[] || []).find((u: any) => u.id === comment.userId)?.name || 'Usuário'}\n                          </span>\n                          {comment.isReopenRequest && (\n                            <Badge variant=\"destructive\" className=\"text-xs\">Reabertura</Badge>\n                          )}\n                        </div>\n                        <span className=\"text-xs text-muted-foreground\">\n                          {format(new Date(comment.createdAt), \"dd/MM/yyyy HH:mm\", { locale: ptBR })}\n                        </span>\n                      </div>\n                      <p className=\"text-sm text-gray-700\">{comment.comment}</p>\n                      {comment.attachments && comment.attachments.length > 0 && (\n                        <div className=\"flex gap-2 mt-2\">\n                          {comment.attachments.map((att: any, idx: number) => (\n                            <img \n                              key={idx}\n                              src={att.url || att} \n                              alt={`Anexo ${idx + 1}`}\n                              className=\"w-20 h-20 object-cover rounded border\"\n                            />\n                          ))}\n                        </div>\n                      )}\n                    </div>\n                  ))\n                ) : (\n                  <p className=\"text-sm text-muted-foreground text-center py-4\">\n                    Nenhum comentário ainda\n                  </p>\n                )}\n              </div>\n\n              {/* Add Comment */}\n              <div className=\"border-t pt-4 space-y-3\">\n                <Textarea\n                  placeholder=\"Adicionar comentário...\"\n                  value={newComment}\n                  onChange={(e) => setNewComment(e.target.value)}\n                  className=\"min-h-[80px]\"\n                  data-testid=\"textarea-new-comment\"\n                />\n                \n                <div className=\"flex items-center justify-between\">\n                  <div className=\"flex items-center gap-2\">\n                    <input\n                      type=\"file\"\n                      id=\"comment-photo-upload\"\n                      accept=\"image/jpeg,image/png,image/jpg\"\n                      multiple\n                      className=\"hidden\"\n                      onChange={handleCommentPhotoSelect}\n                    />\n                    <label \n                      htmlFor=\"comment-photo-upload\"\n                      className=\"cursor-pointer\"\n                    >\n                      <Button variant=\"outline\" size=\"sm\" type=\"button\" asChild>\n                        <span>\n                          <Camera className=\"w-4 h-4 mr-2\" />\n                          Anexar Fotos\n                        </span>\n                      </Button>\n                    </label>\n                    {commentPhotos.length > 0 && (\n                      <span className=\"text-sm text-muted-foreground\">\n                        {commentPhotos.length} foto(s) selecionada(s)\n                      </span>\n                    )}\n                  </div>\n                  <Button \n                    onClick={handleAddComment}\n                    disabled={!newComment.trim() && commentPhotos.length === 0}\n                    size=\"sm\"\n                    data-testid=\"button-add-comment\"\n                  >\n                    Enviar Comentário\n                  </Button>\n                </div>\n\n                {/* Comment Photo Previews */}\n                {commentPhotoPreviewUrls.length > 0 && (\n                  <div className=\"flex gap-2 flex-wrap\">\n                    {commentPhotoPreviewUrls.map((url, index) => (\n                      <div key={index} className=\"relative group\">\n                        <img \n                          src={url} \n                          alt={`Preview ${index + 1}`}\n                          className=\"w-16 h-16 object-cover rounded border\"\n                        />\n                        <Button\n                          type=\"button\"\n                          variant=\"destructive\"\n                          size=\"sm\"\n                          className=\"absolute -top-2 -right-2 opacity-0 group-hover:opacity-100 transition-opacity h-6 w-6 p-0\"\n                          onClick={() => handleRemoveCommentPhoto(index)}\n                        >\n                          <X className=\"w-3 h-3\" />\n                        </Button>\n                      </div>\n                    ))}\n                  </div>\n                )}\n              </div>\n            </div>\n\n            {/* Rating Section - Only for completed work orders and customer users */}\n            {(workOrder as any)?.status === 'concluida' && \n             currentUser?.userType === 'customer_user' && \n             !(workOrder as any)?.customerRating && (\n              <div className=\"mt-6 p-6 border-2 border-orange-300 rounded-lg bg-gradient-to-r from-orange-50 to-amber-50\">\n                <div className=\"flex items-center gap-2 mb-4\">\n                  <Star className=\"w-5 h-5 text-orange-600\" />\n                  <h3 className=\"text-lg font-semibold text-orange-900\">Avalie este Serviço</h3>\n                </div>\n                <p className=\"text-sm text-gray-600 mb-4\">\n                  Como você avalia a qualidade do serviço realizado? (1 = Péssimo, 10 = Excelente)\n                </p>\n                \n                {/* Rating Buttons */}\n                <div className=\"grid grid-cols-5 sm:grid-cols-10 gap-2 mb-4\">\n                  {[1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map((rating) => (\n                    <Button\n                      key={rating}\n                      type=\"button\"\n                      variant={selectedRating === rating ? \"default\" : \"outline\"}\n                      className={`h-12 font-bold text-lg ${\n                        selectedRating === rating \n                          ? rating <= 4 \n                            ? 'bg-red-600 hover:bg-red-700' \n                            : rating <= 7 \n                            ? 'bg-yellow-600 hover:bg-yellow-700' \n                            : 'bg-green-600 hover:bg-green-700'\n                          : 'hover:bg-gray-100'\n                      }`}\n                      onClick={() => setSelectedRating(rating)}\n                      data-testid={`button-rating-${rating}`}\n                    >\n                      {rating}\n                    </Button>\n                  ))}\n                </div>\n\n                {/* Optional Comment */}\n                <Textarea\n                  placeholder=\"Comentário (opcional)\"\n                  value={ratingComment}\n                  onChange={(e) => setRatingComment(e.target.value)}\n                  className=\"mb-4\"\n                  rows={3}\n                  data-testid=\"textarea-rating-comment\"\n                />\n\n                <Button\n                  onClick={handleSubmitRating}\n                  disabled={!selectedRating || submitRatingMutation.isPending}\n                  className=\"w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3\"\n                  data-testid=\"button-submit-rating\"\n                >\n                  {submitRatingMutation.isPending ? \"Enviando...\" : \"Enviar Avaliação\"}\n                </Button>\n              </div>\n            )}\n\n            {/* Show existing rating if already rated */}\n            {(workOrder as any)?.status === 'concluida' && \n             (workOrder as any)?.customerRating && (\n              <div className=\"mt-6 p-6 border-2 border-green-300 rounded-lg bg-gradient-to-r from-green-50 to-emerald-50\">\n                <div className=\"flex items-center gap-2 mb-2\">\n                  <Star className=\"w-5 h-5 text-green-600 fill-green-600\" />\n                  <h3 className=\"text-lg font-semibold text-green-900\">Avaliação Registrada</h3>\n                </div>\n                <div className=\"flex items-center gap-2 mb-2\">\n                  <span className=\"text-3xl font-bold text-green-700\">\n                    {(workOrder as any).customerRating}/10\n                  </span>\n                  <span className=\"text-sm text-gray-600\">\n                    em {format(new Date((workOrder as any).ratedAt), \"dd/MM/yyyy HH:mm\", { locale: ptBR })}\n                  </span>\n                </div>\n                {(workOrder as any).customerRatingComment && (\n                  <p className=\"text-sm text-gray-700 mt-2 p-3 bg-white rounded border border-green-200\">\n                    \"{(workOrder as any).customerRatingComment}\"\n                  </p>\n                )}\n              </div>\n            )}\n          </div>\n          </div>\n        \n        <div className=\"flex items-center justify-end space-x-4 mt-8 pt-6 border-t\">\n          <Button variant=\"outline\" onClick={onClose} data-testid=\"button-cancel\">\n            Cancelar\n          </Button>\n          <Button \n            onClick={handleSave}\n            disabled={updateWorkOrderMutation.isPending}\n            data-testid=\"button-save\"\n            className=\"bg-blue-600 hover:bg-blue-700\"\n          >\n            {updateWorkOrderMutation.isPending ? \"Salvando...\" : \"Salvar Alterações\"}\n          </Button>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}","size_bytes":45287},"client/src/components/ui/input-otp.tsx":{"content":"import * as React from \"react\"\nimport { OTPInput, OTPInputContext } from \"input-otp\"\nimport { Dot } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst InputOTP = React.forwardRef<\n  React.ElementRef<typeof OTPInput>,\n  React.ComponentPropsWithoutRef<typeof OTPInput>\n>(({ className, containerClassName, ...props }, ref) => (\n  <OTPInput\n    ref={ref}\n    containerClassName={cn(\n      \"flex items-center gap-2 has-[:disabled]:opacity-50\",\n      containerClassName\n    )}\n    className={cn(\"disabled:cursor-not-allowed\", className)}\n    {...props}\n  />\n))\nInputOTP.displayName = \"InputOTP\"\n\nconst InputOTPGroup = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"flex items-center\", className)} {...props} />\n))\nInputOTPGroup.displayName = \"InputOTPGroup\"\n\nconst InputOTPSlot = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\"> & { index: number }\n>(({ index, className, ...props }, ref) => {\n  const inputOTPContext = React.useContext(OTPInputContext)\n  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]\n\n  return (\n    <div\n      ref={ref}\n      className={cn(\n        \"relative flex h-10 w-10 items-center justify-center border-y border-r border-input text-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md\",\n        isActive && \"z-10 ring-2 ring-ring ring-offset-background\",\n        className\n      )}\n      {...props}\n    >\n      {char}\n      {hasFakeCaret && (\n        <div className=\"pointer-events-none absolute inset-0 flex items-center justify-center\">\n          <div className=\"h-4 w-px animate-caret-blink bg-foreground duration-1000\" />\n        </div>\n      )}\n    </div>\n  )\n})\nInputOTPSlot.displayName = \"InputOTPSlot\"\n\nconst InputOTPSeparator = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ ...props }, ref) => (\n  <div ref={ref} role=\"separator\" {...props}>\n    <Dot />\n  </div>\n))\nInputOTPSeparator.displayName = \"InputOTPSeparator\"\n\nexport { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }\n","size_bytes":2154},"client/src/components/ui/avatar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as AvatarPrimitive from \"@radix-ui/react-avatar\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Avatar = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatar.displayName = AvatarPrimitive.Root.displayName\n\nconst AvatarImage = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Image>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Image\n    ref={ref}\n    className={cn(\"aspect-square h-full w-full\", className)}\n    {...props}\n  />\n))\nAvatarImage.displayName = AvatarPrimitive.Image.displayName\n\nconst AvatarFallback = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Fallback>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Fallback\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full items-center justify-center rounded-full bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatarFallback.displayName = AvatarPrimitive.Fallback.displayName\n\nexport { Avatar, AvatarImage, AvatarFallback }\n","size_bytes":1419},"client/src/components/ui/command.tsx":{"content":"import * as React from \"react\"\nimport { type DialogProps } from \"@radix-ui/react-dialog\"\nimport { Command as CommandPrimitive } from \"cmdk\"\nimport { Search } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Dialog, DialogContent } from \"@/components/ui/dialog\"\n\nconst Command = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nCommand.displayName = CommandPrimitive.displayName\n\nconst CommandDialog = ({ children, ...props }: DialogProps) => {\n  return (\n    <Dialog {...props}>\n      <DialogContent className=\"overflow-hidden p-0 shadow-lg\">\n        <Command className=\"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5\">\n          {children}\n        </Command>\n      </DialogContent>\n    </Dialog>\n  )\n}\n\nconst CommandInput = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Input>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>\n>(({ className, ...props }, ref) => (\n  <div className=\"flex items-center border-b px-3\" cmdk-input-wrapper=\"\">\n    <Search className=\"mr-2 h-4 w-4 shrink-0 opacity-50\" />\n    <CommandPrimitive.Input\n      ref={ref}\n      className={cn(\n        \"flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    />\n  </div>\n))\n\nCommandInput.displayName = CommandPrimitive.Input.displayName\n\nconst CommandList = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.List\n    ref={ref}\n    className={cn(\"max-h-[300px] overflow-y-auto overflow-x-hidden\", className)}\n    {...props}\n  />\n))\n\nCommandList.displayName = CommandPrimitive.List.displayName\n\nconst CommandEmpty = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Empty>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>\n>((props, ref) => (\n  <CommandPrimitive.Empty\n    ref={ref}\n    className=\"py-6 text-center text-sm\"\n    {...props}\n  />\n))\n\nCommandEmpty.displayName = CommandPrimitive.Empty.displayName\n\nconst CommandGroup = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Group>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Group\n    ref={ref}\n    className={cn(\n      \"overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandGroup.displayName = CommandPrimitive.Group.displayName\n\nconst CommandSeparator = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nCommandSeparator.displayName = CommandPrimitive.Separator.displayName\n\nconst CommandItem = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandItem.displayName = CommandPrimitive.Item.displayName\n\nconst CommandShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nCommandShortcut.displayName = \"CommandShortcut\"\n\nexport {\n  Command,\n  CommandDialog,\n  CommandInput,\n  CommandList,\n  CommandEmpty,\n  CommandGroup,\n  CommandItem,\n  CommandShortcut,\n  CommandSeparator,\n}\n","size_bytes":4885},"client/src/pages/users.tsx":{"content":"import Header from \"@/components/layout/header\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useState, useEffect } from \"react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { \n  Plus, \n  Users as UsersIcon, \n  Eye, \n  Edit, \n  Trash2,\n  UserCheck,\n  UserX,\n  Search,\n  Filter,\n  KeyRound\n} from \"lucide-react\";\n\ninterface UsersProps {\n  customerId: string;\n}\n\nexport default function Users({ customerId }: UsersProps) {\n  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);\n  const [isViewDialogOpen, setIsViewDialogOpen] = useState(false);\n  const [isEditDialogOpen, setIsEditDialogOpen] = useState(false);\n  const [isPasswordDialogOpen, setIsPasswordDialogOpen] = useState(false);\n  const [selectedUser, setSelectedUser] = useState<any>(null);\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const [roleFilter, setRoleFilter] = useState(\"todos\");\n  const [statusFilter, setStatusFilter] = useState(\"todos\");\n  const [userName, setUserName] = useState(\"\");\n  const [userEmail, setUserEmail] = useState(\"\");\n  const [userUsername, setUserUsername] = useState(\"\");\n  const [userRole, setUserRole] = useState<string>(\"\");\n  const [userPassword, setUserPassword] = useState(\"\");\n  const [userModules, setUserModules] = useState<string[]>([]);\n  \n  // Edit user states\n  const [editName, setEditName] = useState(\"\");\n  const [editEmail, setEditEmail] = useState(\"\");\n  const [editRole, setEditRole] = useState<string>(\"\");\n  const [editIsActive, setEditIsActive] = useState(true);\n  \n  // Password change states\n  const [newPassword, setNewPassword] = useState(\"\");\n  const [confirmPassword, setConfirmPassword] = useState(\"\");\n\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  // Resetar campos do formulário quando o diálogo fechar\n  useEffect(() => {\n    if (!isCreateDialogOpen) {\n      setUserName(\"\");\n      setUserEmail(\"\");\n      setUserUsername(\"\");\n      setUserPassword(\"\");\n      setUserRole(\"\");\n      setUserModules([]);\n    }\n  }, [isCreateDialogOpen]);\n\n  const { data: users, isLoading } = useQuery({\n    queryKey: [\"/api/customers\", customerId, \"users\"],\n    enabled: !!customerId,\n  });\n\n  const { data: customer } = useQuery<{ modules?: string[] }>({\n    queryKey: [\"/api/customers\", customerId],\n    enabled: !!customerId,\n  });\n\n  // Buscar custom roles criados em \"Funções\"\n  const { data: customRoles = [], isLoading: isLoadingRoles } = useQuery<any[]>({\n    queryKey: [\"/api/roles\"],\n  });\n\n  const createUserMutation = useMutation({\n    mutationFn: async (data: any) => {\n      return await apiRequest(\"POST\", \"/api/users\", data);\n    },\n    onSuccess: () => {\n      toast({ title: \"Usuário criado com sucesso\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/customers\", customerId, \"users\"] });\n      setIsCreateDialogOpen(false);\n      setUserName(\"\");\n      setUserEmail(\"\");\n      setUserUsername(\"\");\n      setUserPassword(\"\");\n      setUserRole(\"\");\n      setUserModules([]);\n    },\n    onError: (error: any) => {\n      const errorMessage = error?.message || \"Erro ao criar usuário\";\n      const errorDetails = error?.details || \"Verifique se todos os campos estão preenchidos corretamente\";\n      \n      toast({ \n        title: errorMessage,\n        description: errorDetails,\n        variant: \"destructive\" \n      });\n    },\n  });\n\n  const deleteUserMutation = useMutation({\n    mutationFn: async (userId: string) => {\n      return await apiRequest(\"DELETE\", `/api/users/${userId}`);\n    },\n    onSuccess: () => {\n      toast({ title: \"Usuário excluído com sucesso\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/customers\", customerId, \"users\"] });\n    },\n    onError: () => {\n      toast({ \n        title: \"Erro ao excluir usuário\", \n        variant: \"destructive\" \n      });\n    },\n  });\n\n  const resetPasswordMutation = useMutation({\n    mutationFn: async (data: { userId: string; password: string }) => {\n      await apiRequest('PATCH', `/api/users/${data.userId}`, { password: data.password });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/customers\", customerId, \"users\"] });\n      toast({\n        title: 'Senha alterada com sucesso!',\n        description: 'A nova senha foi definida para o usuário.',\n      });\n      setIsPasswordDialogOpen(false);\n      setNewPassword(\"\");\n      setConfirmPassword(\"\");\n    },\n    onError: (error: any) => {\n      toast({\n        title: 'Erro ao alterar senha',\n        description: error.message,\n        variant: 'destructive',\n      });\n    },\n  });\n\n  const handleOpenPasswordDialog = (user: any) => {\n    setSelectedUser(user);\n    setNewPassword(\"\");\n    setConfirmPassword(\"\");\n    setIsPasswordDialogOpen(true);\n  };\n\n  const handleChangePassword = () => {\n    if (!newPassword.trim()) {\n      toast({\n        title: \"Senha obrigatória\",\n        description: \"Digite uma nova senha.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (newPassword !== confirmPassword) {\n      toast({\n        title: \"Senhas não coincidem\",\n        description: \"A senha e a confirmação devem ser iguais.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (newPassword.length < 4) {\n      toast({\n        title: \"Senha muito curta\",\n        description: \"A senha deve ter pelo menos 4 caracteres.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    resetPasswordMutation.mutate({\n      userId: selectedUser.id,\n      password: newPassword,\n    });\n  };\n\n  const handleCreateUser = () => {\n    if (!userName.trim() || !userEmail.trim() || !userUsername.trim() || !userPassword.trim()) {\n      toast({ \n        title: \"Todos os campos são obrigatórios\", \n        variant: \"destructive\" \n      });\n      return;\n    }\n\n    if (!userRole || !userRole.trim()) {\n      toast({ \n        title: \"Selecione um perfil\", \n        description: \"O perfil do usuário é obrigatório\",\n        variant: \"destructive\" \n      });\n      return;\n    }\n\n    if (!customer) {\n      toast({ \n        title: \"Erro ao obter dados do cliente\", \n        variant: \"destructive\" \n      });\n      return;\n    }\n\n    if (userModules.length === 0) {\n      toast({ \n        title: \"Selecione pelo menos um módulo\", \n        description: \"O usuário precisa ter acesso a pelo menos um módulo\",\n        variant: \"destructive\" \n      });\n      return;\n    }\n\n    createUserMutation.mutate({\n      companyId: (customer as any).companyId,\n      customerId,\n      name: userName,\n      email: userEmail,\n      username: userUsername,\n      password: userPassword,\n      role: userRole,\n      authProvider: 'local',\n      userType: 'customer_user',\n      modules: userModules,\n    });\n  };\n\n  const updateUserMutation = useMutation({\n    mutationFn: async (data: any) => {\n      // Atualizar dados básicos\n      await apiRequest(\"PUT\", `/api/users/${data.userId}`, data.updates);\n      \n      // Se mudou o perfil, atualizar o userRoleAssignment\n      if (data.newRoleId && selectedUser.customRoles?.[0]?.roleId !== data.newRoleId) {\n        // Remover role assignment antigo se existir\n        if (selectedUser.customRoles && selectedUser.customRoles.length > 0) {\n          await apiRequest(\"DELETE\", `/api/users/${data.userId}/roles/${selectedUser.customRoles[0].roleId}`, {});\n        }\n        \n        // Criar novo role assignment\n        await apiRequest(\"POST\", `/api/users/${data.userId}/roles`, {\n          roleId: data.newRoleId,\n          customerId: customerId\n        });\n      }\n      \n      return true;\n    },\n    onSuccess: () => {\n      toast({ title: \"Usuário atualizado com sucesso\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/customers\", customerId, \"users\"] });\n      setIsEditDialogOpen(false);\n    },\n    onError: (error: any) => {\n      toast({ \n        title: \"Erro ao atualizar usuário\", \n        description: error.message || \"Tente novamente\",\n        variant: \"destructive\" \n      });\n    },\n  });\n\n  const handleViewUser = (user: any) => {\n    setSelectedUser(user);\n    setIsViewDialogOpen(true);\n  };\n\n  const handleEditUser = (user: any) => {\n    setSelectedUser(user);\n    setEditName(user.name);\n    setEditEmail(user.email);\n    // Pegar o roleId do customRole se existir\n    setEditRole(user.customRoles?.[0]?.roleId || '');\n    setEditIsActive(user.isActive);\n    setIsEditDialogOpen(true);\n  };\n\n  const handleUpdateUser = async () => {\n    if (!editName.trim() || !editEmail.trim()) {\n      toast({ \n        title: \"Nome e email são obrigatórios\", \n        variant: \"destructive\" \n      });\n      return;\n    }\n\n    // Primeiro atualiza os dados básicos do usuário\n    updateUserMutation.mutate({\n      userId: selectedUser.id,\n      updates: {\n        name: editName,\n        email: editEmail,\n        isActive: editIsActive,\n      },\n      // Passar o novo roleId para atualizar depois\n      newRoleId: editRole\n    });\n  };\n\n  const handleDeleteUser = (user: any) => {\n    if (window.confirm(`Tem certeza que deseja excluir o usuário \"${user.name}\"?`)) {\n      deleteUserMutation.mutate(user.id);\n    }\n  };\n\n  const getRoleBadge = (user: any) => {\n    // Verificar se o usuário tem customRoles\n    if (user.customRoles && user.customRoles.length > 0) {\n      const role = user.customRoles[0].role;\n      \n      // Cores baseadas no nome do role\n      if (role.name.toLowerCase().includes('admin')) {\n        return <Badge variant=\"destructive\">{role.name}</Badge>;\n      } else if (role.name.toLowerCase().includes('cliente') || role.name.toLowerCase().includes('gestor')) {\n        return <Badge className=\"bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200\">{role.name}</Badge>;\n      } else if (role.name.toLowerCase().includes('supervisor')) {\n        return <Badge className=\"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200\">{role.name}</Badge>;\n      } else if (role.name.toLowerCase().includes('operador')) {\n        return <Badge className=\"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200\">{role.name}</Badge>;\n      } else if (role.name.toLowerCase().includes('auditor')) {\n        return <Badge className=\"bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200\">{role.name}</Badge>;\n      }\n      return <Badge variant=\"outline\">{role.name}</Badge>;\n    }\n    \n    // Fallback para o role padrão do sistema\n    if (user.role) {\n      const roleLabels: any = {\n        'admin': 'Administrador',\n        'gestor_cliente': 'Gestor de Cliente',\n        'supervisor_site': 'Supervisor de Local',\n        'operador': 'Operador',\n        'auditor': 'Auditor'\n      };\n      \n      const label = roleLabels[user.role] || user.role;\n      \n      if (user.role === 'admin') {\n        return <Badge variant=\"destructive\">{label}</Badge>;\n      } else if (user.role === 'gestor_cliente') {\n        return <Badge className=\"bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200\">{label}</Badge>;\n      } else if (user.role === 'supervisor_site') {\n        return <Badge className=\"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200\">{label}</Badge>;\n      } else if (user.role === 'operador') {\n        return <Badge className=\"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200\">{label}</Badge>;\n      } else if (user.role === 'auditor') {\n        return <Badge className=\"bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200\">{label}</Badge>;\n      }\n      return <Badge variant=\"outline\">{label}</Badge>;\n    }\n    \n    // Se não tem customRoles nem role padrão, mostrar \"SEM PERFIL\"\n    return <Badge variant=\"destructive\" className=\"animate-pulse\">⚠️ SEM PERFIL</Badge>;\n  };\n\n  const getModulesBadges = (user: any) => {\n    const modules = user.modules || [];\n    \n    return (\n      <div className=\"flex flex-wrap gap-1\">\n        {modules.includes('clean') && (\n          <Badge className=\"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200\" data-testid={`badge-module-clean-${user.id}`}>\n            Clean\n          </Badge>\n        )}\n        {modules.includes('maintenance') && (\n          <Badge className=\"bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200\" data-testid={`badge-module-maintenance-${user.id}`}>\n            Manutenção\n          </Badge>\n        )}\n      </div>\n    );\n  };\n\n  const filteredUsers = (users as any[])?.filter((user: any) => {\n    const matchesSearch = user.name?.toLowerCase().includes(searchTerm.toLowerCase()) ||\n                         user.email?.toLowerCase().includes(searchTerm.toLowerCase()) ||\n                         user.username?.toLowerCase().includes(searchTerm.toLowerCase());\n    const matchesRole = roleFilter === \"todos\" || user.role === roleFilter;\n    const matchesStatus = statusFilter === \"todos\" || \n                         (statusFilter === \"ativo\" && user.isActive) ||\n                         (statusFilter === \"inativo\" && !user.isActive);\n    return matchesSearch && matchesRole && matchesStatus;\n  }) || [];\n\n  if (isLoading) {\n    return (\n      <div className=\"flex-1 flex items-center justify-center\">\n        <div>Carregando usuários...</div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h2 className=\"text-2xl font-bold text-foreground\">Usuários</h2>\n          <p className=\"text-muted-foreground\">Gerenciamento de usuários e permissões do sistema</p>\n        </div>\n        <Dialog open={isCreateDialogOpen} onOpenChange={setIsCreateDialogOpen}>\n          <DialogTrigger asChild>\n            <Button data-testid=\"button-create-user\">\n              <Plus className=\"w-4 h-4 mr-2\" />\n              Novo Usuário\n            </Button>\n          </DialogTrigger>\n          <DialogContent className=\"max-h-[90vh] overflow-y-auto\">\n            <DialogHeader>\n              <DialogTitle>Criar Novo Usuário</DialogTitle>\n            </DialogHeader>\n            <div className=\"space-y-4\">\n              <div>\n                <label className=\"block text-sm font-medium text-foreground mb-2\">\n                  Nome Completo *\n                </label>\n                <Input\n                  placeholder=\"Ex: João da Silva\"\n                  value={userName}\n                  onChange={(e) => setUserName(e.target.value)}\n                  data-testid=\"input-user-name\"\n                />\n              </div>\n              <div>\n                <label className=\"block text-sm font-medium text-foreground mb-2\">\n                  Email *\n                </label>\n                <Input\n                  type=\"email\"\n                  placeholder=\"joao@empresa.com\"\n                  value={userEmail}\n                  onChange={(e) => setUserEmail(e.target.value)}\n                  data-testid=\"input-user-email\"\n                />\n              </div>\n              <div>\n                <label className=\"block text-sm font-medium text-foreground mb-2\">\n                  Nome de Usuário *\n                </label>\n                <Input\n                  placeholder=\"joao.silva\"\n                  value={userUsername}\n                  onChange={(e) => setUserUsername(e.target.value)}\n                  data-testid=\"input-user-username\"\n                />\n              </div>\n              <div>\n                <label className=\"block text-sm font-medium text-foreground mb-2\">\n                  Senha *\n                </label>\n                <Input\n                  type=\"password\"\n                  placeholder=\"••••••••\"\n                  value={userPassword}\n                  onChange={(e) => setUserPassword(e.target.value)}\n                  data-testid=\"input-user-password\"\n                />\n              </div>\n              <div>\n                <label className=\"block text-sm font-medium text-foreground mb-2\">\n                  Perfil *\n                </label>\n                {isLoadingRoles ? (\n                  <div className=\"text-sm text-muted-foreground\">Carregando perfis...</div>\n                ) : Array.isArray(customRoles) && customRoles.length > 0 ? (\n                  <Select value={userRole} onValueChange={(value: any) => setUserRole(value)}>\n                    <SelectTrigger data-testid=\"select-user-role\">\n                      <SelectValue placeholder=\"Selecione o perfil do usuário\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {customRoles.map((role: any) => (\n                        <SelectItem key={role.id} value={role.id}>\n                          {role.name}\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                ) : (\n                  <div className=\"text-sm text-destructive\">\n                    Nenhum perfil disponível. Crie perfis em \"Funções\" primeiro.\n                  </div>\n                )}\n              </div>\n              <div>\n                <label className=\"block text-sm font-medium text-foreground mb-3\">\n                  Módulos de Acesso * \n                </label>\n                <div className=\"space-y-3 border rounded-lg p-4 bg-slate-50 dark:bg-slate-900\">\n                  <div className=\"flex items-start space-x-3\">\n                    <input\n                      type=\"checkbox\"\n                      id=\"module-clean\"\n                      checked={userModules.includes('clean')}\n                      onChange={(e) => {\n                        if (e.target.checked) {\n                          setUserModules([...userModules, 'clean']);\n                        } else {\n                          setUserModules(userModules.filter(m => m !== 'clean'));\n                        }\n                      }}\n                      disabled={!customer?.modules?.includes('clean')}\n                      className=\"mt-1 h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed\"\n                      data-testid=\"checkbox-module-clean\"\n                    />\n                    <div className=\"flex-1\">\n                      <label htmlFor=\"module-clean\" className={customer?.modules?.includes('clean') ? \"cursor-pointer\" : \"cursor-not-allowed opacity-50\"}>\n                        <div className=\"font-medium text-blue-900 dark:text-blue-300\">OPUS Clean</div>\n                        <div className=\"text-sm text-muted-foreground\">Gestão de Limpeza e Facilities</div>\n                        {!customer?.modules?.includes('clean') && (\n                          <div className=\"text-xs text-red-600 dark:text-red-400 mt-1\">Módulo não disponível para este cliente</div>\n                        )}\n                      </label>\n                    </div>\n                  </div>\n                  <div className=\"flex items-start space-x-3\">\n                    <input\n                      type=\"checkbox\"\n                      id=\"module-maintenance\"\n                      checked={userModules.includes('maintenance')}\n                      onChange={(e) => {\n                        if (e.target.checked) {\n                          setUserModules([...userModules, 'maintenance']);\n                        } else {\n                          setUserModules(userModules.filter(m => m !== 'maintenance'));\n                        }\n                      }}\n                      disabled={!customer?.modules?.includes('maintenance')}\n                      className=\"mt-1 h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500 disabled:opacity-50 disabled:cursor-not-allowed\"\n                      data-testid=\"checkbox-module-maintenance\"\n                    />\n                    <div className=\"flex-1\">\n                      <label htmlFor=\"module-maintenance\" className={customer?.modules?.includes('maintenance') ? \"cursor-pointer\" : \"cursor-not-allowed opacity-50\"}>\n                        <div className=\"font-medium text-orange-900 dark:text-orange-300\">OPUS Manutenção</div>\n                        <div className=\"text-sm text-muted-foreground\">Gestão de Manutenção</div>\n                        {!customer?.modules?.includes('maintenance') && (\n                          <div className=\"text-xs text-red-600 dark:text-red-400 mt-1\">Módulo não disponível para este cliente</div>\n                        )}\n                      </label>\n                    </div>\n                  </div>\n                </div>\n                <p className=\"text-xs text-muted-foreground mt-2\">\n                  Selecione um ou mais módulos que o usuário poderá acessar (apenas módulos disponíveis para o cliente)\n                </p>\n              </div>\n              <div className=\"flex justify-end space-x-2\">\n                <Button \n                  variant=\"outline\" \n                  onClick={() => setIsCreateDialogOpen(false)}\n                  data-testid=\"button-cancel-user\"\n                >\n                  Cancelar\n                </Button>\n                <Button \n                  onClick={handleCreateUser}\n                  disabled={createUserMutation.isPending}\n                  data-testid=\"button-save-user\"\n                >\n                  {createUserMutation.isPending ? \"Criando...\" : \"Criar Usuário\"}\n                </Button>\n              </div>\n            </div>\n          </DialogContent>\n        </Dialog>\n      </div>\n      \n      <div className=\"space-y-6\">\n        {/* Filters */}\n        <Card className=\"mb-6\">\n          <CardContent className=\"p-4\">\n            <div className=\"flex flex-col sm:flex-row gap-4 items-center\">\n              <div className=\"relative flex-1\">\n                <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground w-4 h-4\" />\n                <Input\n                  placeholder=\"Buscar por nome, email ou usuário...\"\n                  value={searchTerm}\n                  onChange={(e) => setSearchTerm(e.target.value)}\n                  className=\"pl-10\"\n                  data-testid=\"input-search-users\"\n                />\n              </div>\n              <Select value={roleFilter} onValueChange={setRoleFilter}>\n                <SelectTrigger className=\"w-48\" data-testid=\"select-role-filter\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"todos\">Todos os Perfis</SelectItem>\n                  {(customRoles as any[])?.map((role: any) => (\n                    <SelectItem key={role.id} value={role.id}>\n                      {role.name}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n              <Select value={statusFilter} onValueChange={setStatusFilter}>\n                <SelectTrigger className=\"w-32\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"todos\">Todos</SelectItem>\n                  <SelectItem value=\"ativo\">Ativos</SelectItem>\n                  <SelectItem value=\"inativo\">Inativos</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Summary Cards */}\n        <div className=\"grid grid-cols-1 md:grid-cols-4 gap-6 mb-6\">\n          <Card>\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Total Usuários</p>\n                  <p className=\"text-2xl font-bold text-foreground\">\n                    {filteredUsers.length}\n                  </p>\n                </div>\n                <UsersIcon className=\"w-8 h-8 text-primary\" />\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Ativos</p>\n                  <p className=\"text-2xl font-bold text-chart-2\">\n                    {filteredUsers.filter((u: any) => u.isActive).length}\n                  </p>\n                </div>\n                <div className=\"w-8 h-8 bg-chart-2/10 rounded-full flex items-center justify-center\">\n                  <UserCheck className=\"w-4 h-4 text-chart-2\" />\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Com Perfis</p>\n                  <p className=\"text-2xl font-bold text-chart-4\">\n                    {filteredUsers.filter((u: any) => u.role).length}\n                  </p>\n                </div>\n                <div className=\"w-8 h-8 bg-chart-4/10 rounded-full flex items-center justify-center\">\n                  <UserCheck className=\"w-4 h-4 text-chart-4\" />\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Inativos</p>\n                  <p className=\"text-2xl font-bold text-muted-foreground\">\n                    {filteredUsers.filter((u: any) => !u.isActive).length}\n                  </p>\n                </div>\n                <UserX className=\"w-8 h-8 text-muted-foreground\" />\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* Users Table */}\n        <Card>\n          <CardHeader>\n            <CardTitle>Lista de Usuários</CardTitle>\n          </CardHeader>\n          <CardContent>\n            {filteredUsers.length === 0 ? (\n              <div className=\"text-center py-8\">\n                <UsersIcon className=\"w-12 h-12 text-muted-foreground mx-auto mb-4\" />\n                <p className=\"text-muted-foreground\">Nenhum usuário encontrado</p>\n                <p className=\"text-sm text-muted-foreground mt-2\">\n                  {(users as any[])?.length === 0 \n                    ? \"Crie o primeiro usuário para começar\"\n                    : \"Ajuste os filtros para encontrar usuários\"\n                  }\n                </p>\n              </div>\n            ) : (\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>Nome</TableHead>\n                    <TableHead>Email</TableHead>\n                    <TableHead>Usuário</TableHead>\n                    <TableHead>Perfil</TableHead>\n                    <TableHead>Módulos</TableHead>\n                    <TableHead>Status</TableHead>\n                    <TableHead>Último Acesso</TableHead>\n                    <TableHead>Ações</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {filteredUsers.map((user: any) => (\n                    <TableRow key={user.id} className=\"hover:bg-muted/50\">\n                      <TableCell className=\"font-medium\">{user.name}</TableCell>\n                      <TableCell>{user.email}</TableCell>\n                      <TableCell className=\"font-mono\">{user.username}</TableCell>\n                      <TableCell>{getRoleBadge(user)}</TableCell>\n                      <TableCell>{getModulesBadges(user)}</TableCell>\n                      <TableCell>\n                        {user.isActive ? (\n                          <Badge className=\"bg-chart-2/10 text-chart-2\">Ativo</Badge>\n                        ) : (\n                          <Badge variant=\"outline\">Inativo</Badge>\n                        )}\n                      </TableCell>\n                      <TableCell className=\"text-muted-foreground\">\n                        {user.lastLogin \n                          ? new Date(user.lastLogin).toLocaleDateString('pt-BR')\n                          : \"Nunca\"\n                        }\n                      </TableCell>\n                      <TableCell>\n                        <div className=\"flex items-center gap-1\">\n                          <Button \n                            variant=\"outline\" \n                            size=\"icon\"\n                            className=\"h-8 w-8\"\n                            onClick={() => handleViewUser(user)}\n                            data-testid={`button-view-user-${user.id}`}\n                            title=\"Visualizar\"\n                          >\n                            <Eye className=\"h-4 w-4\" />\n                          </Button>\n                          <Button \n                            variant=\"outline\" \n                            size=\"icon\"\n                            className=\"h-8 w-8\"\n                            onClick={() => handleEditUser(user)}\n                            data-testid={`button-edit-user-${user.id}`}\n                            title=\"Editar\"\n                          >\n                            <Edit className=\"h-4 w-4\" />\n                          </Button>\n                          <Button \n                            variant=\"outline\" \n                            size=\"icon\"\n                            className=\"h-8 w-8\"\n                            onClick={() => handleOpenPasswordDialog(user)}\n                            disabled={resetPasswordMutation.isPending}\n                            data-testid={`button-reset-password-${user.id}`}\n                            title=\"Trocar Senha\"\n                          >\n                            <KeyRound className=\"h-4 w-4\" />\n                          </Button>\n                          <Button \n                            variant=\"outline\" \n                            size=\"icon\"\n                            className=\"h-8 w-8 text-destructive hover:bg-destructive hover:text-destructive-foreground\"\n                            onClick={() => handleDeleteUser(user)}\n                            disabled={deleteUserMutation.isPending}\n                            data-testid={`button-delete-user-${user.id}`}\n                            title=\"Excluir\"\n                          >\n                            <Trash2 className=\"h-4 w-4\" />\n                          </Button>\n                        </div>\n                      </TableCell>\n                    </TableRow>\n                  ))}\n                </TableBody>\n              </Table>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* View User Dialog */}\n      <Dialog open={isViewDialogOpen} onOpenChange={setIsViewDialogOpen}>\n        <DialogContent className=\"max-w-md max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>Detalhes do Usuário</DialogTitle>\n          </DialogHeader>\n          {selectedUser && (\n            <div className=\"space-y-4\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <label className=\"text-xs text-muted-foreground\">Nome Completo</label>\n                  <p className=\"font-medium\">{selectedUser.name}</p>\n                </div>\n                <div>\n                  <label className=\"text-xs text-muted-foreground\">Nome de Usuário</label>\n                  <p className=\"font-mono text-sm\">{selectedUser.username}</p>\n                </div>\n              </div>\n              <div>\n                <label className=\"text-xs text-muted-foreground\">Email</label>\n                <p className=\"font-medium\">{selectedUser.email}</p>\n              </div>\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <label className=\"text-xs text-muted-foreground\">Perfil</label>\n                  <div className=\"mt-1\">{getRoleBadge(selectedUser)}</div>\n                </div>\n                <div>\n                  <label className=\"text-xs text-muted-foreground\">Status</label>\n                  <div className=\"mt-1\">\n                    {selectedUser.isActive ? (\n                      <Badge className=\"bg-chart-2/10 text-chart-2\">Ativo</Badge>\n                    ) : (\n                      <Badge variant=\"outline\">Inativo</Badge>\n                    )}\n                  </div>\n                </div>\n              </div>\n              <div>\n                <label className=\"text-xs text-muted-foreground\">Último Acesso</label>\n                <p className=\"text-sm\">\n                  {selectedUser.lastLogin \n                    ? new Date(selectedUser.lastLogin).toLocaleString('pt-BR')\n                    : \"Nunca acessou\"\n                  }\n                </p>\n              </div>\n              <div className=\"flex justify-end pt-4\">\n                <Button onClick={() => setIsViewDialogOpen(false)}>\n                  Fechar\n                </Button>\n              </div>\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n\n      {/* Edit User Dialog */}\n      <Dialog open={isEditDialogOpen} onOpenChange={setIsEditDialogOpen}>\n        <DialogContent className=\"max-w-md max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>Editar Usuário</DialogTitle>\n          </DialogHeader>\n          {selectedUser && (\n            <div className=\"space-y-4\">\n              <div>\n                <label className=\"block text-sm font-medium text-foreground mb-2\">\n                  Nome Completo *\n                </label>\n                <Input\n                  placeholder=\"Nome completo\"\n                  value={editName}\n                  onChange={(e) => setEditName(e.target.value)}\n                  data-testid=\"input-edit-name\"\n                />\n              </div>\n              <div>\n                <label className=\"block text-sm font-medium text-foreground mb-2\">\n                  Email *\n                </label>\n                <Input\n                  type=\"email\"\n                  placeholder=\"email@empresa.com\"\n                  value={editEmail}\n                  onChange={(e) => setEditEmail(e.target.value)}\n                  data-testid=\"input-edit-email\"\n                />\n              </div>\n              <div>\n                <label className=\"block text-sm font-medium text-foreground mb-2\">\n                  Nome de Usuário\n                </label>\n                <Input\n                  disabled\n                  value={selectedUser.username}\n                  className=\"bg-muted\"\n                  title=\"Nome de usuário não pode ser alterado\"\n                />\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  Nome de usuário não pode ser alterado\n                </p>\n              </div>\n              <div>\n                <label className=\"block text-sm font-medium text-foreground mb-2\">\n                  Perfil *\n                </label>\n                <Select value={editRole} onValueChange={(value: any) => setEditRole(value)}>\n                  <SelectTrigger data-testid=\"select-edit-role\">\n                    <SelectValue placeholder=\"Selecione um perfil\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {(customRoles as any[])?.map((role: any) => (\n                      <SelectItem key={role.id} value={role.id}>\n                        {role.name}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n              <div className=\"flex items-center space-x-2\">\n                <input\n                  type=\"checkbox\"\n                  id=\"edit-is-active\"\n                  checked={editIsActive}\n                  onChange={(e) => setEditIsActive(e.target.checked)}\n                  className=\"h-4 w-4\"\n                  data-testid=\"checkbox-edit-active\"\n                />\n                <label htmlFor=\"edit-is-active\" className=\"text-sm font-medium\">\n                  Usuário ativo\n                </label>\n              </div>\n              <div className=\"flex justify-end space-x-2 pt-4\">\n                <Button \n                  variant=\"outline\" \n                  onClick={() => setIsEditDialogOpen(false)}\n                  data-testid=\"button-cancel-edit\"\n                >\n                  Cancelar\n                </Button>\n                <Button \n                  onClick={handleUpdateUser}\n                  disabled={updateUserMutation.isPending}\n                  data-testid=\"button-save-edit\"\n                >\n                  {updateUserMutation.isPending ? \"Salvando...\" : \"Salvar Alterações\"}\n                </Button>\n              </div>\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n\n      {/* Change Password Dialog */}\n      <Dialog open={isPasswordDialogOpen} onOpenChange={setIsPasswordDialogOpen}>\n        <DialogContent className=\"max-w-md max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>Trocar Senha do Usuário</DialogTitle>\n          </DialogHeader>\n          {selectedUser && (\n            <div className=\"space-y-4\">\n              <div className=\"bg-muted p-3 rounded-lg\">\n                <p className=\"text-sm text-muted-foreground\">Alterando senha para:</p>\n                <p className=\"font-medium\">{selectedUser.name}</p>\n                <p className=\"text-sm font-mono text-muted-foreground\">@{selectedUser.username}</p>\n              </div>\n              \n              <div>\n                <label className=\"block text-sm font-medium text-foreground mb-2\">\n                  Nova Senha *\n                </label>\n                <Input\n                  type=\"password\"\n                  placeholder=\"Digite a nova senha\"\n                  value={newPassword}\n                  onChange={(e) => setNewPassword(e.target.value)}\n                  data-testid=\"input-new-password\"\n                  autoFocus\n                />\n              </div>\n              \n              <div>\n                <label className=\"block text-sm font-medium text-foreground mb-2\">\n                  Confirmar Senha *\n                </label>\n                <Input\n                  type=\"password\"\n                  placeholder=\"Digite a senha novamente\"\n                  value={confirmPassword}\n                  onChange={(e) => setConfirmPassword(e.target.value)}\n                  data-testid=\"input-confirm-password\"\n                />\n              </div>\n\n              <div className=\"bg-yellow-50 border border-yellow-200 rounded-lg p-3\">\n                <p className=\"text-xs text-yellow-800\">\n                  ⚠️ A senha será alterada imediatamente. Certifique-se de informar o usuário sobre a nova senha.\n                </p>\n              </div>\n\n              <div className=\"flex justify-end space-x-2 pt-4\">\n                <Button \n                  variant=\"outline\" \n                  onClick={() => setIsPasswordDialogOpen(false)}\n                  data-testid=\"button-cancel-password\"\n                >\n                  Cancelar\n                </Button>\n                <Button \n                  onClick={handleChangePassword}\n                  disabled={resetPasswordMutation.isPending}\n                  data-testid=\"button-save-password\"\n                >\n                  {resetPasswordMutation.isPending ? \"Alterando...\" : \"Alterar Senha\"}\n                </Button>\n              </div>\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","size_bytes":40290},"client/src/components/ui/breadcrumb.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Breadcrumb = React.forwardRef<\n  HTMLElement,\n  React.ComponentPropsWithoutRef<\"nav\"> & {\n    separator?: React.ReactNode\n  }\n>(({ ...props }, ref) => <nav ref={ref} aria-label=\"breadcrumb\" {...props} />)\nBreadcrumb.displayName = \"Breadcrumb\"\n\nconst BreadcrumbList = React.forwardRef<\n  HTMLOListElement,\n  React.ComponentPropsWithoutRef<\"ol\">\n>(({ className, ...props }, ref) => (\n  <ol\n    ref={ref}\n    className={cn(\n      \"flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5\",\n      className\n    )}\n    {...props}\n  />\n))\nBreadcrumbList.displayName = \"BreadcrumbList\"\n\nconst BreadcrumbItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentPropsWithoutRef<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    className={cn(\"inline-flex items-center gap-1.5\", className)}\n    {...props}\n  />\n))\nBreadcrumbItem.displayName = \"BreadcrumbItem\"\n\nconst BreadcrumbLink = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentPropsWithoutRef<\"a\"> & {\n    asChild?: boolean\n  }\n>(({ asChild, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      className={cn(\"transition-colors hover:text-foreground\", className)}\n      {...props}\n    />\n  )\n})\nBreadcrumbLink.displayName = \"BreadcrumbLink\"\n\nconst BreadcrumbPage = React.forwardRef<\n  HTMLSpanElement,\n  React.ComponentPropsWithoutRef<\"span\">\n>(({ className, ...props }, ref) => (\n  <span\n    ref={ref}\n    role=\"link\"\n    aria-disabled=\"true\"\n    aria-current=\"page\"\n    className={cn(\"font-normal text-foreground\", className)}\n    {...props}\n  />\n))\nBreadcrumbPage.displayName = \"BreadcrumbPage\"\n\nconst BreadcrumbSeparator = ({\n  children,\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) => (\n  <li\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"[&>svg]:w-3.5 [&>svg]:h-3.5\", className)}\n    {...props}\n  >\n    {children ?? <ChevronRight />}\n  </li>\n)\nBreadcrumbSeparator.displayName = \"BreadcrumbSeparator\"\n\nconst BreadcrumbEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More</span>\n  </span>\n)\nBreadcrumbEllipsis.displayName = \"BreadcrumbElipssis\"\n\nexport {\n  Breadcrumb,\n  BreadcrumbList,\n  BreadcrumbItem,\n  BreadcrumbLink,\n  BreadcrumbPage,\n  BreadcrumbSeparator,\n  BreadcrumbEllipsis,\n}\n","size_bytes":2712},"client/src/components/ui/tabs.tsx":{"content":"import * as React from \"react\"\nimport * as TabsPrimitive from \"@radix-ui/react-tabs\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Tabs = TabsPrimitive.Root\n\nconst TabsList = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.List\n    ref={ref}\n    className={cn(\n      \"inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsList.displayName = TabsPrimitive.List.displayName\n\nconst TabsTrigger = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsTrigger.displayName = TabsPrimitive.Trigger.displayName\n\nconst TabsContent = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsContent.displayName = TabsPrimitive.Content.displayName\n\nexport { Tabs, TabsList, TabsTrigger, TabsContent }\n","size_bytes":1883},"client/src/pages/admin-dashboards.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useModule } from \"@/contexts/ModuleContext\";\nimport { \n  BarChart, \n  Bar, \n  XAxis, \n  YAxis, \n  CartesianGrid, \n  Tooltip, \n  ResponsiveContainer,\n  PieChart,\n  Pie,\n  Cell,\n  LineChart,\n  Line,\n  Area,\n  AreaChart\n} from \"recharts\";\nimport { \n  TrendingUp, \n  TrendingDown, \n  Activity, \n  Clock, \n  CheckCircle, \n  AlertTriangle,\n  Users,\n  Building,\n  Calendar,\n  BarChart3,\n  PieChart as PieChartIcon,\n  Download,\n  Filter,\n  RefreshCw\n} from \"lucide-react\";\n\ninterface AdminDashboardsProps {\n  companyId: string;\n}\n\nexport default function AdminDashboards({ companyId }: AdminDashboardsProps) {\n  const { currentModule } = useModule();\n  const [timeFilter, setTimeFilter] = useState(\"7d\");\n  const [refreshing, setRefreshing] = useState(false);\n  const queryClient = useQueryClient();\n\n  const { data: analytics = {}, isLoading } = useQuery({\n    queryKey: [\"/api/companies\", companyId, \"analytics\", timeFilter, \"todos\"],\n    enabled: !!companyId,\n  });\n\n  const { data: workOrders = [] } = useQuery({\n    queryKey: [\"/api/companies\", companyId, \"work-orders\", { module: currentModule }],\n    enabled: !!companyId,\n  });\n\n  const { data: sites = [] } = useQuery({\n    queryKey: [\"/api/companies\", companyId, \"sites\", { module: currentModule }],\n    enabled: !!companyId,\n  });\n\n  const handleRefresh = async () => {\n    setRefreshing(true);\n    \n    // Invalidar todas as queries do dashboard para forçar atualização\n    await Promise.all([\n      queryClient.invalidateQueries({ queryKey: [\"/api/companies\", companyId, \"analytics\"] }),\n      queryClient.invalidateQueries({ queryKey: [\"/api/companies\", companyId, \"work-orders\"] }),\n      queryClient.invalidateQueries({ queryKey: [\"/api/companies\", companyId, \"sites\"] })\n    ]);\n    \n    setRefreshing(false);\n  };\n\n  // Dados mockados para demonstração estilo Power BI\n  const statusData = [\n    { name: \"Concluídas\", value: 45, color: \"#10b981\" },\n    { name: \"Em Andamento\", value: 23, color: \"#f59e0b\" },\n    { name: \"Abertas\", value: 32, color: \"#3b82f6\" },\n    { name: \"Vencidas\", value: 12, color: \"#ef4444\" }\n  ];\n\n  const monthlyData = [\n    { month: \"Jan\", completed: 120, pending: 45, overdue: 8 },\n    { month: \"Fev\", completed: 135, pending: 38, overdue: 12 },\n    { month: \"Mar\", completed: 148, pending: 52, overdue: 6 },\n    { month: \"Abr\", completed: 162, pending: 41, overdue: 9 },\n    { month: \"Mai\", completed: 158, pending: 47, overdue: 15 },\n    { month: \"Jun\", completed: 175, pending: 39, overdue: 7 }\n  ];\n\n  const performanceData = [\n    { day: \"Seg\", efficiency: 85, target: 90 },\n    { day: \"Ter\", efficiency: 92, target: 90 },\n    { day: \"Qua\", efficiency: 88, target: 90 },\n    { day: \"Qui\", efficiency: 94, target: 90 },\n    { day: \"Sex\", efficiency: 87, target: 90 },\n    { day: \"Sáb\", efficiency: 82, target: 90 },\n    { day: \"Dom\", efficiency: 79, target: 90 }\n  ];\n\n  const siteData = (sites as any[]).map((site: any, index: number) => ({\n    name: site.name,\n    orders: Math.floor(Math.random() * 50) + 10,\n    efficiency: Math.floor(Math.random() * 30) + 70,\n    alerts: Math.floor(Math.random() * 5)\n  }));\n\n  if (isLoading) {\n    return (\n      <div className=\"p-4 space-y-4\">\n        <div className=\"animate-pulse space-y-4\">\n          <div className=\"h-20 bg-slate-200 rounded-lg\"></div>\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div className=\"h-32 bg-slate-200 rounded-lg\"></div>\n            <div className=\"h-32 bg-slate-200 rounded-lg\"></div>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"flex-1 p-4 space-y-4 bg-background overflow-auto\">\n      {/* Header com Filtros */}\n      <div className=\"space-y-4 mb-6\">\n        <div>\n          <h1 className=\"text-2xl font-bold text-foreground\">Dashboards BI</h1>\n          <p className=\"text-sm text-muted-foreground\">Analytics avançado e monitoramento em tempo real</p>\n        </div>\n        <div className=\"flex flex-col sm:flex-row items-center gap-3 justify-center sm:justify-start\">\n          <Select value={timeFilter} onValueChange={setTimeFilter}>\n            <SelectTrigger className=\"w-full sm:w-32\">\n              <SelectValue />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"24h\">24 horas</SelectItem>\n              <SelectItem value=\"7d\">7 dias</SelectItem>\n              <SelectItem value=\"30d\">30 dias</SelectItem>\n              <SelectItem value=\"90d\">3 meses</SelectItem>\n            </SelectContent>\n          </Select>\n          <div className=\"flex gap-2 w-full sm:w-auto\">\n            <Button \n              size=\"sm\" \n              variant=\"outline\" \n              onClick={handleRefresh}\n              disabled={refreshing}\n              className={`flex-1 sm:flex-none transition-all duration-300 ${refreshing ? 'scale-95 bg-primary/5' : 'hover:scale-105'}`}\n              data-testid=\"button-refresh-dashboard\"\n            >\n              <RefreshCw className={`w-4 h-4 mr-2 transition-transform duration-500 ${refreshing ? 'animate-spin' : ''}`} />\n              {refreshing ? 'Atualizando...' : 'Atualizar'}\n            </Button>\n            <Button size=\"sm\" variant=\"outline\" className=\"flex-1 sm:flex-none\">\n              <Download className=\"w-4 h-4 mr-2\" />\n              Exportar\n            </Button>\n          </div>\n        </div>\n      </div>\n\n      {/* KPIs principais */}\n      <div className=\"grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6\">\n        <Card className=\"bg-gradient-to-r from-blue-500 to-blue-600 text-white\">\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-blue-100 text-sm font-medium\">Total OS</p>\n                <p className=\"text-2xl font-bold mt-1\">112</p>\n                <div className=\"flex items-center mt-2\">\n                  <TrendingUp className=\"w-4 h-4 mr-1\" />\n                  <span className=\"text-sm\">+12% este mês</span>\n                </div>\n              </div>\n              <Activity className=\"w-8 h-8 text-blue-200\" />\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card className=\"bg-gradient-to-r from-green-500 to-green-600 text-white\">\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-green-100 text-sm font-medium\">Concluídas</p>\n                <p className=\"text-2xl font-bold mt-1\">89</p>\n                <div className=\"flex items-center mt-2\">\n                  <TrendingUp className=\"w-4 h-4 mr-1\" />\n                  <span className=\"text-sm\">79.5% taxa</span>\n                </div>\n              </div>\n              <CheckCircle className=\"w-8 h-8 text-green-200\" />\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card className=\"bg-gradient-to-r from-yellow-500 to-yellow-600 text-white\">\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-yellow-100 text-sm font-medium\">Pendentes</p>\n                <p className=\"text-2xl font-bold mt-1\">23</p>\n                <div className=\"flex items-center mt-2\">\n                  <Clock className=\"w-4 h-4 mr-1\" />\n                  <span className=\"text-sm\">20.5% total</span>\n                </div>\n              </div>\n              <Clock className=\"w-8 h-8 text-yellow-200\" />\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card className=\"bg-gradient-to-r from-red-500 to-red-600 text-white\">\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-red-100 text-sm font-medium\">Vencidas</p>\n                <p className=\"text-2xl font-bold mt-1\">7</p>\n                <div className=\"flex items-center mt-2\">\n                  <TrendingDown className=\"w-4 h-4 mr-1\" />\n                  <span className=\"text-sm\">-3 vs ontem</span>\n                </div>\n              </div>\n              <AlertTriangle className=\"w-8 h-8 text-red-200\" />\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Gráficos principais */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6 mb-6\">\n        {/* Status Distribution */}\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-sm flex items-center gap-1\">\n              <PieChartIcon className=\"w-3 h-3\" />\n              Status das OS\n            </CardTitle>\n          </CardHeader>\n          <CardContent className=\"p-4\">\n            <div className=\"flex justify-center relative\">\n              <ResponsiveContainer width={140} height={140}>\n                <PieChart>\n                  <Pie\n                    data={statusData}\n                    cx={70}\n                    cy={70}\n                    innerRadius={35}\n                    outerRadius={55}\n                    paddingAngle={2}\n                    dataKey=\"value\"\n                  >\n                    {statusData.map((entry, index) => (\n                      <Cell key={`cell-${index}`} fill={entry.color} />\n                    ))}\n                  </Pie>\n                  <Tooltip />\n                </PieChart>\n              </ResponsiveContainer>\n              {/* Centro do gráfico com valor total */}\n              <div className=\"absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2\">\n                <div className=\"text-center\">\n                  <div className=\"text-2xl font-bold text-foreground\">\n                    {statusData.reduce((acc, curr) => acc + curr.value, 0)}\n                  </div>\n                  <div className=\"text-xs text-muted-foreground\">Total OS</div>\n                </div>\n              </div>\n            </div>\n            <div className=\"mt-3 space-y-1\">\n              {statusData.map((item, index) => (\n                <div key={index} className=\"flex items-center justify-between text-xs\">\n                  <div className=\"flex items-center gap-1\">\n                    <div \n                      className=\"w-2 h-2 rounded-full\" \n                      style={{ backgroundColor: item.color }}\n                    ></div>\n                    <span>{item.name}</span>\n                  </div>\n                  <div className=\"text-right\">\n                    <span className=\"font-semibold\">{item.value}</span>\n                    <span className=\"text-gray-500 ml-1\">\n                      {Math.round((item.value / statusData.reduce((acc, curr) => acc + curr.value, 0)) * 100)}%\n                    </span>\n                  </div>\n                </div>\n              ))}\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Monthly Trend */}\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-sm flex items-center gap-1\">\n              <BarChart3 className=\"w-3 h-3\" />\n              Tendência Mensal\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <ResponsiveContainer width=\"100%\" height={150}>\n              <BarChart data={monthlyData}>\n                <CartesianGrid strokeDasharray=\"3 3\" />\n                <XAxis \n                  dataKey=\"month\" \n                  fontSize={12}\n                  tickLine={false}\n                  axisLine={false}\n                />\n                <YAxis \n                  fontSize={12}\n                  tickLine={false}\n                  axisLine={false}\n                />\n                <Tooltip />\n                <Bar dataKey=\"completed\" fill=\"#10b981\" radius={4} />\n                <Bar dataKey=\"pending\" fill=\"#f59e0b\" radius={4} />\n                <Bar dataKey=\"overdue\" fill=\"#ef4444\" radius={4} />\n              </BarChart>\n            </ResponsiveContainer>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Performance e Sites */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6 mb-6\">\n        {/* Performance Semanal */}\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-sm flex items-center gap-1\">\n              <TrendingUp className=\"w-3 h-3\" />\n              Performance Semanal\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <ResponsiveContainer width=\"100%\" height={120}>\n              <AreaChart data={performanceData}>\n                <CartesianGrid strokeDasharray=\"3 3\" />\n                <XAxis \n                  dataKey=\"day\" \n                  fontSize={12}\n                  tickLine={false}\n                  axisLine={false}\n                />\n                <YAxis \n                  fontSize={12}\n                  tickLine={false}\n                  axisLine={false}\n                  domain={[70, 100]}\n                />\n                <Tooltip />\n                <Area\n                  type=\"monotone\"\n                  dataKey=\"efficiency\"\n                  stroke=\"#3b82f6\"\n                  fill=\"#3b82f6\"\n                  fillOpacity={0.3}\n                  radius={4}\n                />\n                <Line\n                  type=\"monotone\"\n                  dataKey=\"target\"\n                  stroke=\"#ef4444\"\n                  strokeDasharray=\"5 5\"\n                />\n              </AreaChart>\n            </ResponsiveContainer>\n          </CardContent>\n        </Card>\n\n        {/* Performance por Local */}\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-sm flex items-center gap-1\">\n              <Building className=\"w-3 h-3\" />\n              Performance por Local\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-2 max-h-32 overflow-y-auto\">\n              {siteData.slice(0, 4).map((site, index) => (\n                <div key={index} className=\"flex items-center justify-between p-1.5 bg-slate-50 rounded\">\n                  <div className=\"flex-1 min-w-0\">\n                    <p className=\"font-medium text-xs text-slate-900 truncate\">{site.name}</p>\n                    <p className=\"text-xs text-slate-600\">{site.orders} OS</p>\n                  </div>\n                  <div className=\"flex items-center gap-1\">\n                    <p className=\"text-xs font-semibold text-slate-900\">{site.efficiency}%</p>\n                    <div \n                      className={`w-1.5 h-6 rounded-full ${\n                        site.efficiency >= 90 ? 'bg-green-500' :\n                        site.efficiency >= 80 ? 'bg-yellow-500' :\n                        'bg-red-500'\n                      }`}\n                    ></div>\n                  </div>\n                </div>\n              ))}\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Alertas e Insights */}\n      <Card>\n        <CardHeader className=\"pb-2\">\n          <CardTitle className=\"text-sm flex items-center gap-1\">\n            <AlertTriangle className=\"w-3 h-3\" />\n            Alertas\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-1 gap-2\">\n            <div className=\"p-2 bg-yellow-50 border-l-2 border-yellow-400 rounded-r\">\n              <div className=\"flex items-center gap-1\">\n                <AlertTriangle className=\"w-3 h-3 text-yellow-600\" />\n                <div>\n                  <p className=\"text-xs font-semibold text-yellow-800\">SLA em Risco</p>\n                  <p className=\"text-xs text-yellow-700\">3 OS podem vencer hoje</p>\n                </div>\n              </div>\n            </div>\n            \n            <div className=\"p-2 bg-green-50 border-l-2 border-green-400 rounded-r\">\n              <div className=\"flex items-center gap-1\">\n                <TrendingUp className=\"w-3 h-3 text-green-600\" />\n                <div>\n                  <p className=\"text-xs font-semibold text-green-800\">Performance Alta</p>\n                  <p className=\"text-xs text-green-700\">12% acima da meta</p>\n                </div>\n              </div>\n            </div>\n            \n            <div className=\"p-2 bg-blue-50 border-l-2 border-blue-400 rounded-r\">\n              <div className=\"flex items-center gap-1\">\n                <Users className=\"w-3 h-3 text-blue-600\" />\n                <div>\n                  <p className=\"text-xs font-semibold text-blue-800\">Equipe Ativa</p>\n                  <p className=\"text-xs text-blue-700\">8 operadores em campo</p>\n                </div>\n              </div>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}","size_bytes":17058},"client/src/components/ui/label.tsx":{"content":"import * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst labelVariants = cva(\n  \"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\"\n)\n\nconst Label = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &\n    VariantProps<typeof labelVariants>\n>(({ className, ...props }, ref) => (\n  <LabelPrimitive.Root\n    ref={ref}\n    className={cn(labelVariants(), className)}\n    {...props}\n  />\n))\nLabel.displayName = LabelPrimitive.Root.displayName\n\nexport { Label }\n","size_bytes":710},"client/src/components/ui/select.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SelectPrimitive from \"@radix-ui/react-select\"\nimport { Check, ChevronDown, ChevronUp } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Select = SelectPrimitive.Root\n\nconst SelectGroup = SelectPrimitive.Group\n\nconst SelectValue = SelectPrimitive.Value\n\nconst SelectTrigger = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <SelectPrimitive.Icon asChild>\n      <ChevronDown className=\"h-4 w-4 opacity-50\" />\n    </SelectPrimitive.Icon>\n  </SelectPrimitive.Trigger>\n))\nSelectTrigger.displayName = SelectPrimitive.Trigger.displayName\n\nconst SelectScrollUpButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollUpButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronUp className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollUpButton>\n))\nSelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName\n\nconst SelectScrollDownButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollDownButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronDown className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollDownButton>\n))\nSelectScrollDownButton.displayName =\n  SelectPrimitive.ScrollDownButton.displayName\n\nconst SelectContent = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>\n>(({ className, children, position = \"popper\", ...props }, ref) => (\n  <SelectPrimitive.Portal>\n    <SelectPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"relative z-50 max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]\",\n        position === \"popper\" &&\n          \"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1\",\n        className\n      )}\n      position={position}\n      {...props}\n    >\n      <SelectScrollUpButton />\n      <SelectPrimitive.Viewport\n        className={cn(\n          \"p-1\",\n          position === \"popper\" &&\n            \"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]\"\n        )}\n      >\n        {children}\n      </SelectPrimitive.Viewport>\n      <SelectScrollDownButton />\n    </SelectPrimitive.Content>\n  </SelectPrimitive.Portal>\n))\nSelectContent.displayName = SelectPrimitive.Content.displayName\n\nconst SelectLabel = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Label\n    ref={ref}\n    className={cn(\"py-1.5 pl-8 pr-2 text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nSelectLabel.displayName = SelectPrimitive.Label.displayName\n\nconst SelectItem = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <SelectPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </SelectPrimitive.ItemIndicator>\n    </span>\n\n    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>\n  </SelectPrimitive.Item>\n))\nSelectItem.displayName = SelectPrimitive.Item.displayName\n\nconst SelectSeparator = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nSelectSeparator.displayName = SelectPrimitive.Separator.displayName\n\nexport {\n  Select,\n  SelectGroup,\n  SelectValue,\n  SelectTrigger,\n  SelectContent,\n  SelectLabel,\n  SelectItem,\n  SelectSeparator,\n  SelectScrollUpButton,\n  SelectScrollDownButton,\n}\n","size_bytes":5742},"client/src/pages/cleaning-schedule.tsx":{"content":"import Header from \"@/components/layout/header\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { useState, useMemo, useEffect } from \"react\";\nimport { useClient } from \"@/contexts/ClientContext\";\nimport { useModule } from \"@/contexts/ModuleContext\";\nimport { useLocation } from \"wouter\";\nimport { \n  Plus, \n  Calendar, \n  Clock, \n  MapPin,\n  Eye,\n  Edit,\n  Copy,\n  Trash2,\n  ChevronLeft,\n  ChevronRight,\n  User,\n  Timer,\n  Save,\n  Settings\n} from \"lucide-react\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from \"@/components/ui/dialog\";\nimport { Label } from \"@/components/ui/label\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\n\nexport default function CleaningSchedule() {\n  const { activeClientId } = useClient();\n  const { currentModule } = useModule();\n  const queryClient = useQueryClient();\n  const { toast } = useToast();\n  const [, setLocation] = useLocation();\n\n  const [viewMode, setViewMode] = useState<\"monthly\" | \"list\">(\"monthly\");\n  const [siteFilter, setSiteFilter] = useState(\"todos\");\n  const [currentDate, setCurrentDate] = useState(new Date());\n  const [showCreateModal, setShowCreateModal] = useState(false);\n  const [showDayDetailsModal, setShowDayDetailsModal] = useState(false);\n  const [selectedDay, setSelectedDay] = useState<number | null>(null);\n  const [selectedActivities, setSelectedActivities] = useState<any[]>([]);\n  const [showActivityDetailsModal, setShowActivityDetailsModal] = useState(false);\n  const [showEditActivityModal, setShowEditActivityModal] = useState(false);\n  const [selectedActivity, setSelectedActivity] = useState<any>(null);\n  const [selectedForDeletion, setSelectedForDeletion] = useState<string[]>([]);\n\n  // Removido: geração automática que estava criando OSs excessivamente\n\n  const { data: activities, isLoading } = useQuery({\n    queryKey: [\"/api/customers\", activeClientId, \"cleaning-activities\"],\n    enabled: !!activeClientId,\n  });\n\n  // Removido: useEffect que estava gerando OSs automaticamente a cada carregamento\n\n  const { data: sites } = useQuery({\n    queryKey: [\"/api/customers\", activeClientId, \"sites\", { module: currentModule }],\n    enabled: !!activeClientId,\n  });\n\n  const { data: zones } = useQuery({\n    queryKey: [\"/api/customers\", activeClientId, \"zones\", { module: currentModule }],\n    enabled: !!activeClientId,\n  });\n\n  const { data: users } = useQuery({\n    queryKey: [\"/api/customers\", activeClientId, \"users\"],\n    enabled: !!activeClientId,\n  });\n\n  const { data: services } = useQuery({\n    queryKey: [\"/api/customers\", activeClientId, \"services\"],\n    enabled: !!activeClientId,\n  });\n\n  // Redirect if not in clean module\n  useEffect(() => {\n    if (currentModule !== 'clean') {\n      setLocation('/');\n    }\n  }, [currentModule, setLocation]);\n\n  // Mutation to delete cleaning activity\n  const deleteCleaningActivityMutation = useMutation({\n    mutationFn: async (activityId: string) => {\n      await apiRequest('DELETE', `/api/cleaning-activities/${activityId}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/customers\", activeClientId, \"cleaning-activities\"] });\n      toast({\n        title: \"Atividade excluída\",\n        description: \"A atividade de limpeza foi removida com sucesso.\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Não foi possível excluir a atividade.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleDeleteActivity = async (activity: any) => {\n    if (confirm(`Deseja realmente excluir a atividade \"${activity.name}\"? Esta ação não pode ser desfeita.`)) {\n      await deleteCleaningActivityMutation.mutateAsync(activity.id);\n    }\n  };\n\n  const getFrequencyBadge = (frequency: string) => {\n    switch (frequency) {\n      case \"diaria\":\n        return <Badge className=\"bg-chart-2/10 text-chart-2\">Diária</Badge>;\n      case \"semanal\":\n        return <Badge className=\"bg-chart-4/10 text-chart-4\">Semanal</Badge>;\n      case \"mensal\":\n        return <Badge className=\"bg-primary/10 text-primary\">Mensal</Badge>;\n      case \"trimestral\":\n        return <Badge className=\"bg-indigo-100/80 text-indigo-700\">Trimestral</Badge>;\n      case \"semestral\":\n        return <Badge className=\"bg-violet-100/80 text-violet-700\">Semestral</Badge>;\n      case \"anual\":\n        return <Badge className=\"bg-rose-100/80 text-rose-700\">Anual</Badge>;\n      case \"turno\":\n        return <Badge className=\"bg-chart-1/10 text-chart-1\">Por Turno</Badge>;\n      default:\n        return <Badge variant=\"outline\">Personalizada</Badge>;\n    }\n  };\n\n  // Função para gerar o calendário mensal\n  const generateMonthCalendar = () => {\n    const year = currentDate.getFullYear();\n    const month = currentDate.getMonth();\n    const firstDay = new Date(year, month, 1);\n    const lastDay = new Date(year, month + 1, 0);\n    const firstDayOfWeek = firstDay.getDay(); // 0 = domingo\n    const daysInMonth = lastDay.getDate();\n    \n    const calendar = [];\n    let day = 1;\n    \n    // Criar as semanas do mês\n    for (let week = 0; week < 6; week++) {\n      const weekDays = [];\n      \n      for (let dayOfWeek = 0; dayOfWeek < 7; dayOfWeek++) {\n        if (week === 0 && dayOfWeek < firstDayOfWeek) {\n          // Dias vazios antes do primeiro dia do mês\n          weekDays.push(null);\n        } else if (day > daysInMonth) {\n          // Dias vazios depois do último dia do mês\n          weekDays.push(null);\n        } else {\n          // Dias válidos do mês\n          weekDays.push(day);\n          day++;\n        }\n      }\n      \n      calendar.push(weekDays);\n      \n      // Se todos os dias do mês já foram adicionados, parar\n      if (day > daysInMonth) break;\n    }\n    \n    return calendar;\n  };\n\n  // Função para obter zona por ID\n  const getZoneName = (zoneId: string) => {\n    const zone = (zones as any[] || []).find((z: any) => z.id === zoneId);\n    return zone?.name || 'Local não encontrado';\n  };\n\n  // Função para obter responsável por ID\n  const getAssignedUserName = (userId: string) => {\n    const user = (users as any[] || []).find((u: any) => u.id === userId);\n    return user?.name || 'Não atribuído';\n  };\n\n  // Função para obter SLA baseado no tipo de atividade\n  const getSLAForActivity = (activity: any) => {\n    return `${activity.slaMinutes || 60}min`;\n  };\n\n  // Função para obter serviços relacionados a uma zona\n  const getServicesForZone = (zoneId: string) => {\n    return (services as any[] || []).filter((s: any) => s.zoneId === zoneId);\n  };\n\n  // Função para calcular próxima data de execução\n  const getNextExecutionDate = (activity: any) => {\n    const now = new Date();\n    const lastExecution = activity.lastExecutedAt ? new Date(activity.lastExecutedAt) : null;\n    \n    if (!lastExecution) return 'Nunca executado';\n    \n    let nextDate = new Date(lastExecution);\n    \n    switch (activity.frequency) {\n      case 'diaria':\n        nextDate.setDate(nextDate.getDate() + 1);\n        break;\n      case 'semanal':\n        nextDate.setDate(nextDate.getDate() + 7);\n        break;\n      case 'mensal':\n        nextDate.setMonth(nextDate.getMonth() + 1);\n        break;\n      case 'trimestral':\n        nextDate.setMonth(nextDate.getMonth() + 3);\n        break;\n      case 'semestral':\n        nextDate.setMonth(nextDate.getMonth() + 6);\n        break;\n      case 'anual':\n        nextDate.setFullYear(nextDate.getFullYear() + 1);\n        break;\n      default:\n        return 'Frequência personalizada';\n    }\n    \n    return nextDate.toLocaleDateString('pt-BR');\n  };\n\n  // Função para obter atividades de um dia específico\n  const getActivitiesForDay = (day: number) => {\n    if (!activities) return [];\n    \n    return (activities as any[]).filter((activity: any) => {\n      if (activity.frequency === 'diaria') return true;\n      if (activity.frequency === 'semanal') {\n        const dayOfWeek = new Date(currentDate.getFullYear(), currentDate.getMonth(), day).getDay();\n        const weekDays = activity.frequencyConfig?.weekDays || [];\n        const dayMap: Record<string, number> = {\n          'domingo': 0, 'segunda': 1, 'terca': 2, 'quarta': 3,\n          'quinta': 4, 'sexta': 5, 'sabado': 6\n        };\n        return weekDays.some((d: string) => dayMap[d] === dayOfWeek);\n      }\n      if (activity.frequency === 'mensal') {\n        // Atividades mensais aparecem apenas no dia configurado\n        return day === (activity.frequencyConfig?.monthDay || 1);\n      }\n      if (activity.frequency === 'trimestral') {\n        // Atividades trimestrais aparecem no dia configurado, a cada 3 meses\n        const startDate = new Date(activity.startDate);\n        const currentMonth = currentDate.getMonth();\n        const startMonth = startDate.getMonth();\n        const monthDiff = (currentMonth - startMonth + 12) % 12;\n        return monthDiff % 3 === 0 && day === (activity.frequencyConfig?.monthDay || 1);\n      }\n      if (activity.frequency === 'semestral') {\n        // Atividades semestrais aparecem no dia configurado, a cada 6 meses\n        const startDate = new Date(activity.startDate);\n        const currentMonth = currentDate.getMonth();\n        const startMonth = startDate.getMonth();\n        const monthDiff = (currentMonth - startMonth + 12) % 12;\n        return monthDiff % 6 === 0 && day === (activity.frequencyConfig?.monthDay || 1);\n      }\n      if (activity.frequency === 'anual') {\n        // Atividades anuais aparecem no dia/mês configurado\n        const startDate = new Date(activity.startDate);\n        const currentMonth = currentDate.getMonth();\n        const startMonth = startDate.getMonth();\n        return currentMonth === startMonth && day === (activity.frequencyConfig?.monthDay || 1);\n      }\n      return false;\n    });\n  };\n\n  // Função para navegar pelos meses\n  const navigateMonth = (direction: 'prev' | 'next') => {\n    setCurrentDate(prev => {\n      const newDate = new Date(prev);\n      if (direction === 'prev') {\n        newDate.setMonth(prev.getMonth() - 1);\n      } else {\n        newDate.setMonth(prev.getMonth() + 1);\n      }\n      return newDate;\n    });\n  };\n\n  // Função para abrir detalhes do dia\n  const openDayDetails = (day: number) => {\n    const dayActivities = getActivitiesForDay(day);\n    setSelectedDay(day);\n    setSelectedActivities(dayActivities);\n    setShowDayDetailsModal(true);\n  };\n\n  // Função para formatar data selecionada\n  const getSelectedDateFormatted = () => {\n    if (!selectedDay) return '';\n    const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), selectedDay);\n    return date.toLocaleDateString('pt-BR', { \n      weekday: 'long', \n      year: 'numeric', \n      month: 'long', \n      day: 'numeric' \n    });\n  };\n\n  if (isLoading) {\n    return (\n      <>\n        <Header title=\"Plano de Limpeza\" description=\"Gerenciamento de atividades programadas\" />\n        <div className=\"flex-1 flex items-center justify-center\">\n          <div>Carregando plano de limpeza...</div>\n        </div>\n      </>\n    );\n  }\n\n  return (\n    <>\n      <Header \n        title=\"Plano de Limpeza\" \n        description=\"Gerenciamento de atividades de limpeza programadas\"\n      >\n        <div className=\"flex items-center space-x-2\">\n          <Select value={viewMode} onValueChange={(value: \"monthly\" | \"list\") => setViewMode(value)}>\n            <SelectTrigger className=\"w-32\" data-testid=\"select-view-mode\">\n              <SelectValue />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"monthly\">📆 Mensal</SelectItem>\n              <SelectItem value=\"list\">📋 Lista</SelectItem>\n            </SelectContent>\n          </Select>\n          <Button \n            onClick={() => setShowCreateModal(true)}\n            data-testid=\"button-create-activity\"\n          >\n            <Plus className=\"w-4 h-4 mr-2\" />\n            Nova Atividade\n          </Button>\n        </div>\n      </Header>\n      \n      <main className=\"flex-1 overflow-auto p-3 md:p-6 bg-muted/30\">\n        {/* Filters */}\n        <Card className=\"mb-6\">\n          <CardContent className=\"p-4\">\n            <div className=\"flex flex-col sm:flex-row gap-4 items-center\">\n              <Select value={siteFilter} onValueChange={setSiteFilter}>\n                <SelectTrigger className=\"w-48\" data-testid=\"select-site-filter\">\n                  <SelectValue placeholder=\"Filtrar por local\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"todos\">Todos os Locais</SelectItem>\n                  {(sites as any[])?.map((site: any) => (\n                    <SelectItem key={site.id} value={site.id}>\n                      {site.name}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n              \n              <Select defaultValue=\"todas\">\n                <SelectTrigger className=\"w-48\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"todas\">Todas Frequências</SelectItem>\n                  <SelectItem value=\"diaria\">Diária</SelectItem>\n                  <SelectItem value=\"semanal\">Semanal</SelectItem>\n                  <SelectItem value=\"mensal\">Mensal</SelectItem>\n                  <SelectItem value=\"trimestral\">Trimestral</SelectItem>\n                  <SelectItem value=\"semestral\">Semestral</SelectItem>\n                  <SelectItem value=\"anual\">Anual</SelectItem>\n                  <SelectItem value=\"turno\">Por Turno</SelectItem>\n                </SelectContent>\n              </Select>\n\n              <Select defaultValue=\"ativas\">\n                <SelectTrigger className=\"w-48\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"ativas\">Ativas</SelectItem>\n                  <SelectItem value=\"inativas\">Inativas</SelectItem>\n                  <SelectItem value=\"todas\">Todas</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Summary Cards - Modernizado */}\n        <div className=\"grid grid-cols-1 md:grid-cols-4 gap-6 mb-6\">\n          <Card className=\"bg-gradient-to-br from-blue-50 via-blue-100/50 to-white border-blue-200/50 shadow-lg hover:shadow-xl transition-all duration-300\">\n            <CardContent className=\"p-6\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm font-semibold text-blue-600 mb-1\">Atividades Ativas</p>\n                  <p className=\"text-3xl font-bold text-blue-900\">\n                    {(activities as any[])?.filter((a: any) => a.isActive).length || 0}\n                  </p>\n                </div>\n                <div className=\"w-14 h-14 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center shadow-lg transform hover:scale-110 transition-transform\">\n                  <Calendar className=\"w-7 h-7 text-white\" />\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card className=\"bg-gradient-to-br from-emerald-50 via-emerald-100/50 to-white border-emerald-200/50 shadow-lg hover:shadow-xl transition-all duration-300\">\n            <CardContent className=\"p-6\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm font-semibold text-emerald-600 mb-1\">Diárias</p>\n                  <p className=\"text-3xl font-bold text-emerald-900\">\n                    {(activities as any[])?.filter((a: any) => a.frequency === 'diaria').length || 0}\n                  </p>\n                </div>\n                <div className=\"w-14 h-14 bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-2xl flex items-center justify-center shadow-lg transform hover:scale-110 transition-transform\">\n                  <Clock className=\"w-7 h-7 text-white\" />\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card className=\"bg-gradient-to-br from-violet-50 via-violet-100/50 to-white border-violet-200/50 shadow-lg hover:shadow-xl transition-all duration-300\">\n            <CardContent className=\"p-6\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm font-semibold text-violet-600 mb-1\">Semanais</p>\n                  <p className=\"text-3xl font-bold text-violet-900\">\n                    {(activities as any[])?.filter((a: any) => a.frequency === 'semanal').length || 0}\n                  </p>\n                </div>\n                <div className=\"w-14 h-14 bg-gradient-to-br from-violet-500 to-violet-600 rounded-2xl flex items-center justify-center shadow-lg transform hover:scale-110 transition-transform\">\n                  <Clock className=\"w-7 h-7 text-white\" />\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card className=\"bg-gradient-to-br from-amber-50 via-amber-100/50 to-white border-amber-200/50 shadow-lg hover:shadow-xl transition-all duration-300\">\n            <CardContent className=\"p-6\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm font-semibold text-amber-600 mb-1\">Locais Cobertos</p>\n                  <p className=\"text-3xl font-bold text-amber-900\">\n                    {new Set((activities as any[])?.map((a: any) => a.zoneId)).size || 0}\n                  </p>\n                </div>\n                <div className=\"w-14 h-14 bg-gradient-to-br from-amber-500 to-amber-600 rounded-2xl flex items-center justify-center shadow-lg transform hover:scale-110 transition-transform\">\n                  <MapPin className=\"w-7 h-7 text-white\" />\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* Calendar Views or Activities List */}\n        {viewMode === \"monthly\" ? (\n          <Card className=\"bg-white border-0 shadow-2xl overflow-hidden\">\n            <CardHeader className=\"bg-gradient-to-r from-blue-600 via-blue-700 to-indigo-700 text-white p-8 shadow-inner\">\n              <CardTitle className=\"flex items-center justify-between\">\n                <div className=\"flex items-center gap-4\">\n                  <div className=\"w-16 h-16 bg-white/20 backdrop-blur-sm rounded-2xl flex items-center justify-center shadow-lg border border-white/30\">\n                    <Calendar className=\"w-8 h-8 text-white\" />\n                  </div>\n                  <div>\n                    <h2 className=\"text-2xl font-bold mb-1\">Calendário de Limpeza</h2>\n                    <p className=\"text-blue-100 text-sm font-medium\">Atividades programadas por data</p>\n                  </div>\n                </div>\n                <div className=\"flex items-center gap-3\">\n                  <Button \n                    variant=\"outline\" \n                    size=\"sm\"\n                    onClick={() => navigateMonth('prev')}\n                    className=\"bg-white/10 border-white/30 text-white hover:bg-white/20 hover:border-white/40 h-10 w-10 p-0 rounded-xl transition-all shadow-md\"\n                    data-testid=\"button-prev-month\"\n                  >\n                    <ChevronLeft className=\"w-5 h-5\" />\n                  </Button>\n                  <span className=\"font-bold text-xl min-w-52 text-center px-4 py-2 bg-white/10 backdrop-blur-sm rounded-xl border border-white/20\">\n                    {currentDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' }).replace(/^\\w/, c => c.toUpperCase())}\n                  </span>\n                  <Button \n                    variant=\"outline\" \n                    size=\"sm\"\n                    onClick={() => navigateMonth('next')}\n                    className=\"bg-white/10 border-white/30 text-white hover:bg-white/20 hover:border-white/40 h-10 w-10 p-0 rounded-xl transition-all shadow-md\"\n                    data-testid=\"button-next-month\"\n                  >\n                    <ChevronRight className=\"w-5 h-5\" />\n                  </Button>\n                </div>\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"p-8\">\n              {/* Legenda - Modernizada */}\n              <div className=\"flex flex-wrap gap-4 mb-8 p-6 bg-gradient-to-r from-slate-50 to-blue-50/30 rounded-2xl border border-slate-200/50 shadow-sm\">\n                <div className=\"flex items-center gap-2 px-3 py-2 bg-white rounded-lg shadow-sm border border-blue-100\">\n                  <div className=\"w-3 h-3 bg-gradient-to-br from-blue-400 to-blue-600 rounded-full shadow-sm\"></div>\n                  <span className=\"text-sm font-semibold text-slate-700\">Diárias</span>\n                </div>\n                <div className=\"flex items-center gap-2 px-3 py-2 bg-white rounded-lg shadow-sm border border-emerald-100\">\n                  <div className=\"w-3 h-3 bg-gradient-to-br from-emerald-400 to-emerald-600 rounded-full shadow-sm\"></div>\n                  <span className=\"text-sm font-semibold text-slate-700\">Semanais</span>\n                </div>\n                <div className=\"flex items-center gap-2 px-3 py-2 bg-white rounded-lg shadow-sm border border-purple-100\">\n                  <div className=\"w-3 h-3 bg-gradient-to-br from-purple-400 to-purple-600 rounded-full shadow-sm\"></div>\n                  <span className=\"text-sm font-semibold text-slate-700\">Mensais</span>\n                </div>\n                <div className=\"flex items-center gap-2 px-3 py-2 bg-white rounded-lg shadow-sm border border-indigo-100\">\n                  <div className=\"w-3 h-3 bg-gradient-to-br from-indigo-400 to-indigo-600 rounded-full shadow-sm\"></div>\n                  <span className=\"text-sm font-semibold text-slate-700\">Trimestrais</span>\n                </div>\n                <div className=\"flex items-center gap-2 px-3 py-2 bg-white rounded-lg shadow-sm border border-violet-100\">\n                  <div className=\"w-3 h-3 bg-gradient-to-br from-violet-400 to-violet-600 rounded-full shadow-sm\"></div>\n                  <span className=\"text-sm font-semibold text-slate-700\">Semestrais</span>\n                </div>\n                <div className=\"flex items-center gap-2 px-3 py-2 bg-white rounded-lg shadow-sm border border-rose-100\">\n                  <div className=\"w-3 h-3 bg-gradient-to-br from-rose-400 to-rose-600 rounded-full shadow-sm\"></div>\n                  <span className=\"text-sm font-semibold text-slate-700\">Anuais</span>\n                </div>\n                <div className=\"flex items-center gap-2 px-3 py-2 bg-white rounded-lg shadow-sm border border-orange-100\">\n                  <div className=\"w-3 h-3 bg-gradient-to-br from-orange-400 to-orange-600 rounded-full shadow-sm\"></div>\n                  <span className=\"text-sm font-semibold text-slate-700\">Por Turno</span>\n                </div>\n              </div>\n\n              {/* Cabeçalho da semana - Modernizado */}\n              <div className=\"grid grid-cols-7 gap-3 mb-4\">\n                {['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'].map(day => (\n                  <div key={day} className=\"p-4 text-center font-bold text-sm text-slate-800 bg-gradient-to-br from-slate-100 to-slate-50 rounded-xl border border-slate-200 shadow-sm\">\n                    {day}\n                  </div>\n                ))}\n              </div>\n\n              {/* Calendário - Modernizado */}\n              <div className=\"grid grid-cols-7 gap-3\">\n                {generateMonthCalendar().map((week, weekIndex) => \n                  week.map((day, dayIndex) => {\n                    const dayActivities = day ? getActivitiesForDay(day) : [];\n                    const isToday = day && \n                      day === new Date().getDate() && \n                      currentDate.getMonth() === new Date().getMonth() && \n                      currentDate.getFullYear() === new Date().getFullYear();\n                    \n                    return (\n                      <div \n                        key={`${weekIndex}-${dayIndex}`} \n                        className={`rounded-2xl p-4 min-h-36 transition-all duration-300 ${\n                          day \n                            ? `bg-gradient-to-br from-white to-slate-50/50 hover:from-blue-50/30 hover:to-slate-50 hover:shadow-xl cursor-pointer border-2 ${\n                                isToday \n                                  ? 'shadow-lg ring-4 ring-blue-400 ring-opacity-30 border-blue-500 bg-gradient-to-br from-blue-50 to-white' \n                                  : 'border-slate-200/60 shadow-sm hover:border-blue-300'\n                              }` \n                            : 'bg-gradient-to-br from-slate-100/50 to-slate-50 border border-slate-100'\n                        }`}\n                        onClick={() => day && openDayDetails(day)}\n                        data-testid={`calendar-day-${day}`}\n                      >\n                        {day && (\n                          <>\n                            <div className={`text-xl font-bold mb-3 flex items-center justify-between ${\n                              isToday ? 'text-blue-600' : 'text-slate-800'\n                            }`}>\n                              <span>{day}</span>\n                              {isToday && (\n                                <span className=\"text-xs text-white bg-blue-500 px-2 py-1 rounded-full font-semibold shadow-sm\">Hoje</span>\n                              )}\n                            </div>\n                            <div className=\"space-y-2\">\n                              {dayActivities.slice(0, 3).map((activity: any, index: number) => {\n                                const getActivityColor = (freq: string) => {\n                                  switch (freq) {\n                                    case 'diaria': return 'bg-gradient-to-r from-blue-50 to-blue-100 border-l-blue-500 text-blue-800 hover:from-blue-100 hover:to-blue-150';\n                                    case 'semanal': return 'bg-gradient-to-r from-emerald-50 to-emerald-100 border-l-emerald-500 text-emerald-800 hover:from-emerald-100 hover:to-emerald-150';\n                                    case 'mensal': return 'bg-gradient-to-r from-purple-50 to-purple-100 border-l-purple-500 text-purple-800 hover:from-purple-100 hover:to-purple-150';\n                                    case 'trimestral': return 'bg-gradient-to-r from-indigo-50 to-indigo-100 border-l-indigo-500 text-indigo-800 hover:from-indigo-100 hover:to-indigo-150';\n                                    case 'semestral': return 'bg-gradient-to-r from-violet-50 to-violet-100 border-l-violet-500 text-violet-800 hover:from-violet-100 hover:to-violet-150';\n                                    case 'anual': return 'bg-gradient-to-r from-rose-50 to-rose-100 border-l-rose-500 text-rose-800 hover:from-rose-100 hover:to-rose-150';\n                                    case 'turno': return 'bg-gradient-to-r from-orange-50 to-orange-100 border-l-orange-500 text-orange-800 hover:from-orange-100 hover:to-orange-150';\n                                    default: return 'bg-gradient-to-r from-gray-50 to-gray-100 border-l-gray-500 text-gray-800 hover:from-gray-100 hover:to-gray-150';\n                                  }\n                                };\n\n                                return (\n                                  <div \n                                    key={activity.id + index} \n                                    className={`text-xs p-3 rounded-xl border-l-4 ${getActivityColor(activity.frequency)} shadow-sm hover:shadow-md transition-all duration-200 cursor-pointer transform hover:scale-105`}\n                                    onClick={(e) => {\n                                      e.stopPropagation();\n                                      openDayDetails(day);\n                                    }}\n                                    data-testid={`activity-card-${activity.id}`}\n                                  >\n                                    <div className=\"font-bold mb-1.5 leading-tight\">\n                                      {activity.name}\n                                    </div>\n                                    <div className=\"flex items-center gap-1.5 text-xs opacity-80\">\n                                      <MapPin className=\"w-3 h-3\" />\n                                      <span className=\"truncate\">{getZoneName(activity.zoneId)}</span>\n                                    </div>\n                                    <div className=\"flex items-center gap-1.5 text-xs opacity-80 mt-1\">\n                                      <Clock className=\"w-3 h-3\" />\n                                      {getSLAForActivity(activity)}\n                                    </div>\n                                  </div>\n                                );\n                              })}\n                              {dayActivities.length > 3 && (\n                                <div \n                                  className=\"text-xs text-slate-700 text-center py-2.5 bg-gradient-to-r from-slate-100 to-slate-50 rounded-xl font-semibold border-2 border-dashed border-slate-300 cursor-pointer hover:from-slate-200 hover:to-slate-100 hover:border-slate-400 transition-all shadow-sm hover:shadow-md\"\n                                  onClick={(e) => {\n                                    e.stopPropagation();\n                                    openDayDetails(day);\n                                  }}\n                                  data-testid={`more-activities-${day}`}\n                                >\n                                  +{dayActivities.length - 3} mais atividades\n                                </div>\n                              )}\n                            </div>\n                          </>\n                        )}\n                      </div>\n                    );\n                  })\n                )}\n              </div>\n            </CardContent>\n          </Card>\n        ) : (\n          <Card>\n            <CardHeader>\n              <CardTitle>Lista de Atividades de Limpeza</CardTitle>\n            </CardHeader>\n            <CardContent>\n            {!activities || (activities as any[]).length === 0 ? (\n              <div className=\"text-center py-8\">\n                <Calendar className=\"w-12 h-12 text-muted-foreground mx-auto mb-4\" />\n                <p className=\"text-muted-foreground\">Nenhuma atividade cadastrada</p>\n                <p className=\"text-sm text-muted-foreground mt-2\">\n                  Crie sua primeira atividade de limpeza para começar\n                </p>\n                <Button className=\"mt-4\" data-testid=\"button-create-first-activity\">\n                  <Plus className=\"w-4 h-4 mr-2\" />\n                  Criar Primeira Atividade\n                </Button>\n              </div>\n            ) : (\n              <div className=\"space-y-4\">\n                {(activities as any[]).map((activity: any) => (\n                  <div \n                    key={activity.id} \n                    className=\"border border-border rounded-lg p-4 hover:bg-muted/30 transition-colors\"\n                  >\n                    <div className=\"flex items-start justify-between\">\n                      <div className=\"flex-1\">\n                        <div className=\"flex items-center space-x-3 mb-2\">\n                          <h3 className=\"text-lg font-semibold text-foreground\">\n                            {activity.name}\n                          </h3>\n                          {getFrequencyBadge(activity.frequency)}\n                          {activity.isActive ? (\n                            <Badge className=\"bg-chart-2/10 text-chart-2\">Ativa</Badge>\n                          ) : (\n                            <Badge variant=\"outline\">Inativa</Badge>\n                          )}\n                        </div>\n                        \n                        <p className=\"text-sm text-muted-foreground mb-3\">\n                          {activity.description || \"Sem descrição\"}\n                        </p>\n                        \n                        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm text-muted-foreground\">\n                          <div className=\"flex items-center space-x-1\">\n                            <MapPin className=\"w-4 h-4\" />\n                            <span>Local: {getZoneName(activity.zoneId)}</span>\n                          </div>\n                          <div className=\"flex items-center space-x-1\">\n                            <Clock className=\"w-4 h-4\" />\n                            <span>SLA: {getSLAForActivity(activity)}</span>\n                          </div>\n                          <div className=\"flex items-center space-x-1\">\n                            <User className=\"w-4 h-4\" />\n                            <span>Responsável: {getAssignedUserName(activity.assignedUserId)}</span>\n                          </div>\n                          <div className=\"flex items-center space-x-1\">\n                            <Calendar className=\"w-4 h-4\" />\n                            <span>Próxima: {getNextExecutionDate(activity)}</span>\n                          </div>\n                          {activity.estimatedHours && (\n                            <div className=\"flex items-center space-x-1\">\n                              <Timer className=\"w-4 h-4\" />\n                              <span>Estimativa: {activity.estimatedHours}h</span>\n                            </div>\n                          )}\n                          {getServicesForZone(activity.zoneId).length > 0 && (\n                            <div className=\"flex items-center space-x-1\">\n                              <span>🔧</span>\n                              <span>{getServicesForZone(activity.zoneId).length} serviços vinculados</span>\n                            </div>\n                          )}\n                        </div>\n                        \n                        {/* Show linked services */}\n                        {getServicesForZone(activity.zoneId).length > 0 && (\n                          <div className=\"mt-3 p-3 bg-gray-50 rounded-lg\">\n                            <h5 className=\"text-sm font-medium text-gray-900 mb-2\">Serviços Vinculados:</h5>\n                            <div className=\"flex flex-wrap gap-2\">\n                              {getServicesForZone(activity.zoneId).map((service: any) => (\n                                <Badge key={service.id} variant=\"outline\" className=\"text-xs\">\n                                  {service.name}\n                                </Badge>\n                              ))}\n                            </div>\n                          </div>\n                        )}\n                      </div>\n                      \n                      <div className=\"flex items-center space-x-2\">\n                        <Button \n                          variant=\"ghost\" \n                          size=\"sm\"\n                          data-testid={`button-view-activity-${activity.id}`}\n                        >\n                          <Eye className=\"w-4 h-4\" />\n                        </Button>\n                        <Button \n                          variant=\"ghost\" \n                          size=\"sm\"\n                          data-testid={`button-edit-activity-${activity.id}`}\n                        >\n                          <Edit className=\"w-4 h-4\" />\n                        </Button>\n                        <Button \n                          variant=\"ghost\" \n                          size=\"sm\"\n                          data-testid={`button-copy-activity-${activity.id}`}\n                        >\n                          <Copy className=\"w-4 h-4\" />\n                        </Button>\n                        <Button \n                          variant=\"ghost\" \n                          size=\"sm\"\n                          onClick={() => handleDeleteActivity(activity)}\n                          disabled={deleteCleaningActivityMutation.isPending}\n                          data-testid={`button-delete-activity-${activity.id}`}\n                        >\n                          <Trash2 className=\"w-4 h-4\" />\n                        </Button>\n                      </div>\n                    </div>\n                  </div>\n                ))}\n              </div>\n            )}\n          </CardContent>\n        </Card>\n        )}\n\n        {/* Modal de Detalhes do Dia - Design Compacto */}\n        <Dialog open={showDayDetailsModal} onOpenChange={setShowDayDetailsModal}>\n          <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-auto\">\n            <DialogHeader className=\"pb-4\">\n              <DialogTitle className=\"text-xl font-bold text-blue-800 flex items-center gap-2\">\n                <Calendar className=\"w-5 h-5\" />\n                {getSelectedDateFormatted()}\n              </DialogTitle>\n              <DialogDescription>\n                {selectedActivities.length > 0 \n                  ? `${selectedActivities.length} atividade(s) programada(s) para este dia`\n                  : \"Nenhuma atividade programada para este dia\"\n                }\n              </DialogDescription>\n            </DialogHeader>\n            \n            <div className=\"space-y-3\">\n              {selectedActivities.length > 0 ? (\n                selectedActivities.map((activity: any, index: number) => {\n                  const getActivityColorClass = (freq: string) => {\n                    switch (freq) {\n                      case 'diaria': return 'border-l-blue-500 bg-blue-50/30';\n                      case 'semanal': return 'border-l-green-500 bg-green-50/30';\n                      case 'mensal': return 'border-l-purple-500 bg-purple-50/30';\n                      case 'trimestral': return 'border-l-indigo-500 bg-indigo-50/30';\n                      case 'semestral': return 'border-l-violet-500 bg-violet-50/30';\n                      case 'anual': return 'border-l-rose-500 bg-rose-50/30';\n                      case 'turno': return 'border-l-orange-500 bg-orange-50/30';\n                      default: return 'border-l-gray-500 bg-gray-50/30';\n                    }\n                  };\n\n                  return (\n                    <div key={activity.id + index} className={`border-l-4 ${getActivityColorClass(activity.frequency)} p-3 rounded-lg bg-white/50`}>\n                      <div className=\"flex items-center justify-between\">\n                        <div className=\"flex items-center gap-3\">\n                          <input\n                            type=\"checkbox\"\n                            checked={selectedForDeletion.includes(activity.id)}\n                            onChange={(e) => {\n                              if (e.target.checked) {\n                                setSelectedForDeletion([...selectedForDeletion, activity.id]);\n                              } else {\n                                setSelectedForDeletion(selectedForDeletion.filter(id => id !== activity.id));\n                              }\n                            }}\n                            className=\"w-4 h-4 text-red-600 bg-gray-100 border-gray-300 rounded focus:ring-red-500 focus:ring-2\"\n                          />\n                          <div className=\"flex-1 min-w-0\">\n                            <div className=\"flex items-center gap-2 mb-1\">\n                              <h3 className=\"text-sm font-semibold text-gray-900 truncate\">\n                                {activity.name}\n                              </h3>\n                              {getFrequencyBadge(activity.frequency)}\n                            </div>\n                            \n                            <div className=\"flex items-center gap-4 text-xs text-gray-600\">\n                              <span className=\"flex items-center gap-1\">\n                                <MapPin className=\"w-3 h-3\" />\n                                {getZoneName(activity.zoneId)}\n                              </span>\n                              <span className=\"flex items-center gap-1\">\n                                <Clock className=\"w-3 h-3\" />\n                                {getSLAForActivity(activity)}\n                              </span>\n                              <span className=\"flex items-center gap-1\">\n                                <User className=\"w-3 h-3\" />\n                                {getAssignedUserName(activity.assignedUserId || '')}\n                              </span>\n                            </div>\n                          </div>\n                        </div>\n                        \n                        <div className=\"flex items-center gap-1 ml-2\">\n                          <Button \n                            variant=\"ghost\" \n                            size=\"sm\"\n                            onClick={(e) => {\n                              e.preventDefault();\n                              e.stopPropagation();\n                              // Abrir modal de detalhes da atividade\n                              setSelectedActivity(activity);\n                              setShowActivityDetailsModal(true);\n                            }}\n                            data-testid={`button-view-activity-${activity.id}`}\n                            className=\"h-7 w-7 p-0\"\n                            title=\"Ver Detalhes\"\n                          >\n                            <Eye className=\"w-3 h-3\" />\n                          </Button>\n                          <Button \n                            variant=\"ghost\" \n                            size=\"sm\"\n                            onClick={(e) => {\n                              e.preventDefault();\n                              e.stopPropagation();\n                              // Abrir modal de edição da atividade\n                              setSelectedActivity(activity);\n                              setShowEditActivityModal(true);\n                            }}\n                            data-testid={`button-edit-activity-${activity.id}`}\n                            className=\"h-7 w-7 p-0\"\n                            title=\"Editar\"\n                          >\n                            <Edit className=\"w-3 h-3\" />\n                          </Button>\n                          <Button \n                            variant=\"ghost\" \n                            size=\"sm\"\n                            onClick={async (e) => {\n                              e.preventDefault();\n                              e.stopPropagation();\n                              try {\n                                // Duplicar atividade via API\n                                const response = await apiRequest('POST', `/api/companies/${activeClientId}/cleaning-activities`, {\n                                  name: `${activity.name} (Cópia)`,\n                                  description: activity.description,\n                                  frequency: activity.frequency,\n                                  zoneId: activity.zoneId,\n                                  serviceId: activity.serviceId,\n                                  isActive: activity.isActive\n                                });\n                                \n                                if (response.ok) {\n                                  toast({\n                                    title: \"Atividade Duplicada\",\n                                    description: `\"${activity.name}\" foi duplicada com sucesso!`,\n                                  });\n                                  // Recarregar dados\n                                  queryClient.invalidateQueries({ queryKey: [\"/api/companies\", activeClientId, \"cleaning-activities\"] });\n                                } else {\n                                  throw new Error('Erro ao duplicar');\n                                }\n                              } catch (error) {\n                                toast({\n                                  title: \"Erro ao Duplicar\",\n                                  description: \"Não foi possível duplicar a atividade\",\n                                  variant: \"destructive\"\n                                });\n                              }\n                            }}\n                            data-testid={`button-copy-activity-${activity.id}`}\n                            className=\"h-7 w-7 p-0\"\n                            title=\"Duplicar\"\n                          >\n                            <Copy className=\"w-3 h-3\" />\n                          </Button>\n                          <Button \n                            variant=\"ghost\" \n                            size=\"sm\"\n                            onClick={async (e) => {\n                              e.preventDefault();\n                              e.stopPropagation();\n                              if (window.confirm(`Tem certeza que deseja deletar \"${activity.name}\"?`)) {\n                                try {\n                                  const response = await apiRequest('DELETE', `/api/cleaning-activities/${activity.id}`);\n                                  if (response.ok) {\n                                    toast({\n                                      title: \"Atividade Deletada\",\n                                      description: `\"${activity.name}\" foi removida com sucesso!`,\n                                    });\n                                    // Recarregar dados\n                                    queryClient.invalidateQueries({ queryKey: [\"/api/customers\", activeClientId, \"cleaning-activities\"] });\n                                  } else {\n                                    throw new Error('Erro ao deletar');\n                                  }\n                                } catch (error) {\n                                  toast({\n                                    title: \"Erro ao Deletar\",\n                                    description: \"Não foi possível deletar a atividade\",\n                                    variant: \"destructive\"\n                                  });\n                                }\n                              }\n                            }}\n                            data-testid={`button-delete-activity-${activity.id}`}\n                            className=\"h-7 w-7 p-0 text-red-600 hover:text-red-700\"\n                            title=\"Deletar\"\n                          >\n                            <Trash2 className=\"w-3 h-3\" />\n                          </Button>\n                        </div>\n                      </div>\n                    </div>\n                  );\n                })\n              ) : (\n                <div className=\"text-center py-8\">\n                  <Calendar className=\"w-12 h-12 text-gray-300 mx-auto mb-3\" />\n                  <h3 className=\"text-lg font-semibold text-gray-900 mb-2\">\n                    Nenhuma atividade programada\n                  </h3>\n                  <p className=\"text-gray-500 mb-4\">\n                    Este dia não possui atividades de limpeza agendadas.\n                  </p>\n                  <Button \n                    onClick={() => {\n                      setShowDayDetailsModal(false);\n                      setShowCreateModal(true);\n                    }}\n                    data-testid=\"button-create-activity-for-day\"\n                    size=\"sm\"\n                  >\n                    <Plus className=\"w-4 h-4 mr-2\" />\n                    Criar Atividade\n                  </Button>\n                </div>\n              )}\n            </div>\n\n            <div className=\"flex items-center justify-between mt-4 pt-3 border-t text-sm\">\n              <div className=\"text-gray-500\">\n                {selectedActivities.length > 0 && (\n                  `Total: ${selectedActivities.reduce((acc, activity) => acc + (activity.estimatedDuration || 30), 0)}min`\n                )}\n              </div>\n              <div className=\"flex gap-2 flex-wrap\">\n                {selectedActivities.length > 0 && (\n                  <>\n                    <Button \n                      variant=\"destructive\" \n                      size=\"sm\"\n                      onClick={async () => {\n                        if (window.confirm(`Tem certeza que deseja deletar TODAS as ${selectedActivities.length} atividade(s) deste dia?`)) {\n                          try {\n                            const allIds = selectedActivities.map(a => a.id);\n                            await Promise.all(\n                              allIds.map(id => apiRequest('DELETE', `/api/cleaning-activities/${id}`))\n                            );\n                            toast({\n                              title: \"Atividades Deletadas\",\n                              description: `${selectedActivities.length} atividade(s) foram removidas com sucesso!`,\n                            });\n                            queryClient.invalidateQueries({ queryKey: [\"/api/customers\", activeClientId, \"cleaning-activities\"] });\n                            setSelectedForDeletion([]);\n                            setShowDayDetailsModal(false);\n                          } catch (error) {\n                            toast({\n                              title: \"Erro ao Deletar\",\n                              description: \"Não foi possível deletar as atividades\",\n                              variant: \"destructive\"\n                            });\n                          }\n                        }\n                      }}\n                      data-testid=\"button-delete-all-day\"\n                    >\n                      <Trash2 className=\"w-4 h-4 mr-1\" />\n                      Deletar Todas ({selectedActivities.length})\n                    </Button>\n                    \n                    {selectedForDeletion.length > 0 && (\n                      <Button \n                        variant=\"destructive\" \n                        size=\"sm\"\n                        onClick={async () => {\n                          if (window.confirm(`Tem certeza que deseja deletar ${selectedForDeletion.length} atividade(s) selecionada(s)?`)) {\n                            try {\n                              await Promise.all(\n                                selectedForDeletion.map(id => apiRequest('DELETE', `/api/cleaning-activities/${id}`))\n                              );\n                              toast({\n                                title: \"Atividades Deletadas\",\n                                description: `${selectedForDeletion.length} atividade(s) selecionada(s) foram removidas com sucesso!`,\n                              });\n                              queryClient.invalidateQueries({ queryKey: [\"/api/customers\", activeClientId, \"cleaning-activities\"] });\n                              setSelectedForDeletion([]);\n                            } catch (error) {\n                              toast({\n                                title: \"Erro ao Deletar\",\n                                description: \"Não foi possível deletar as atividades selecionadas\",\n                                variant: \"destructive\"\n                              });\n                            }\n                          }\n                        }}\n                        data-testid=\"button-delete-selected\"\n                      >\n                        <Trash2 className=\"w-4 h-4 mr-1\" />\n                        Deletar Selecionadas ({selectedForDeletion.length})\n                      </Button>\n                    )}\n                  </>\n                )}\n                \n                <Button variant=\"outline\" size=\"sm\" onClick={() => setShowDayDetailsModal(false)}>\n                  Fechar\n                </Button>\n                \n                {selectedActivities.length > 0 && (\n                  <Button \n                    size=\"sm\"\n                    onClick={() => {\n                      setShowDayDetailsModal(false);\n                      setShowCreateModal(true);\n                    }}\n                    data-testid=\"button-add-more-activities\"\n                  >\n                    <Plus className=\"w-4 h-4 mr-1\" />\n                    Nova Atividade\n                  </Button>\n                )}\n              </div>\n            </div>\n          </DialogContent>\n        </Dialog>\n\n        {/* Modal de Criação de Atividade */}\n        {showCreateModal && (\n          <CreateCleaningActivityModal\n            activeClientId={activeClientId}\n            onClose={() => setShowCreateModal(false)}\n            onSuccess={() => {\n              setShowCreateModal(false);\n              queryClient.invalidateQueries({ queryKey: [\"/api/companies\", activeClientId, \"cleaning-activities\"] });\n            }}\n          />\n        )}\n\n        {/* Modal de Detalhes da Atividade */}\n        <Dialog open={showActivityDetailsModal} onOpenChange={setShowActivityDetailsModal}>\n          <DialogContent className=\"max-w-md\">\n            <DialogHeader>\n              <DialogTitle className=\"text-lg font-semibold\">Detalhes da Atividade</DialogTitle>\n              <DialogDescription>\n                Informações completas sobre a atividade selecionada.\n              </DialogDescription>\n            </DialogHeader>\n            {selectedActivity && (\n              <div className=\"space-y-4\">\n                <div>\n                  <h3 className=\"font-semibold text-gray-900\">{selectedActivity.name}</h3>\n                  {selectedActivity.description && (\n                    <p className=\"text-sm text-gray-600 mt-1\">{selectedActivity.description}</p>\n                  )}\n                </div>\n                \n                <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                  <div>\n                    <span className=\"font-medium text-gray-700\">Frequência:</span>\n                    <p className=\"text-gray-600\">{selectedActivity.frequency === 'diaria' ? 'Diária' : \n                                                  selectedActivity.frequency === 'semanal' ? 'Semanal' : \n                                                  selectedActivity.frequency === 'mensal' ? 'Mensal' :\n                                                  selectedActivity.frequency === 'turno' ? 'Por Turno' : 'Personalizada'}</p>\n                  </div>\n                  <div>\n                    <span className=\"font-medium text-gray-700\">Status:</span>\n                    <p className=\"text-gray-600\">{selectedActivity.isActive ? 'Ativa' : 'Inativa'}</p>\n                  </div>\n                  <div>\n                    <span className=\"font-medium text-gray-700\">Local:</span>\n                    <p className=\"text-gray-600\">{getZoneName(selectedActivity.zoneId)}</p>\n                  </div>\n                  <div>\n                    <span className=\"font-medium text-gray-700\">SLA:</span>\n                    <p className=\"text-gray-600\">{getSLAForActivity(selectedActivity)}</p>\n                  </div>\n                  <div className=\"col-span-2\">\n                    <span className=\"font-medium text-gray-700\">Responsável:</span>\n                    <p className=\"text-gray-600\">{getAssignedUserName(selectedActivity.assignedUserId || '')}</p>\n                  </div>\n                </div>\n              </div>\n            )}\n          </DialogContent>\n        </Dialog>\n\n        {/* Modal de Edição da Atividade */}\n        <Dialog open={showEditActivityModal} onOpenChange={setShowEditActivityModal}>\n          <DialogContent className=\"max-w-md\">\n            <DialogHeader>\n              <DialogTitle className=\"text-lg font-semibold\">Editar Atividade</DialogTitle>\n              <DialogDescription>\n                Modifique as informações da atividade abaixo.\n              </DialogDescription>\n            </DialogHeader>\n            {selectedActivity && (\n              <div className=\"space-y-4\">\n                <div>\n                  <Label htmlFor=\"edit-name\">Nome da Atividade</Label>\n                  <Input \n                    id=\"edit-name\"\n                    defaultValue={selectedActivity.name}\n                    className=\"mt-1\"\n                  />\n                </div>\n                \n                <div>\n                  <Label htmlFor=\"edit-description\">Descrição</Label>\n                  <Textarea \n                    id=\"edit-description\"\n                    defaultValue={selectedActivity.description || ''}\n                    className=\"mt-1\"\n                  />\n                </div>\n                \n                <div>\n                  <Label htmlFor=\"edit-frequency\">Frequência</Label>\n                  <Select defaultValue={selectedActivity.frequency}>\n                    <SelectTrigger className=\"mt-1\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"diaria\">Diária</SelectItem>\n                      <SelectItem value=\"semanal\">Semanal</SelectItem>\n                      <SelectItem value=\"mensal\">Mensal</SelectItem>\n                      <SelectItem value=\"trimestral\">Trimestral</SelectItem>\n                      <SelectItem value=\"semestral\">Semestral</SelectItem>\n                      <SelectItem value=\"anual\">Anual</SelectItem>\n                      <SelectItem value=\"turno\">Por Turno</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n                \n                <div className=\"flex justify-end gap-2 pt-4\">\n                  <Button \n                    type=\"button\" \n                    variant=\"outline\" \n                    onClick={() => setShowEditActivityModal(false)}\n                  >\n                    Cancelar\n                  </Button>\n                  <Button \n                    type=\"button\"\n                    onClick={() => {\n                      toast({\n                        title: \"Em Desenvolvimento\",\n                        description: \"Funcionalidade de edição será implementada em breve\",\n                      });\n                      setShowEditActivityModal(false);\n                    }}\n                  >\n                    Salvar Alterações\n                  </Button>\n                </div>\n              </div>\n            )}\n          </DialogContent>\n        </Dialog>\n      </main>\n    </>\n  );\n}\n\n// Componente de Modal para Criação de Atividade de Limpeza\ninterface CreateCleaningActivityModalProps {\n  activeClientId: string;\n  onClose: () => void;\n  onSuccess: () => void;\n}\n\nfunction CreateCleaningActivityModal({ activeClientId, onClose, onSuccess }: CreateCleaningActivityModalProps) {\n  const { currentModule } = useModule();\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  \n  const [formData, setFormData] = useState({\n    name: \"\",\n    description: \"\",\n    frequency: \"diaria\",\n    startDate: \"\",\n    frequencyConfig: {\n      weekDays: [] as string[], // para semanal: [\"domingo\", \"segunda\", ...]\n      monthDay: 1, // para mensal: dia do mês (1-31)\n      turnShifts: [] as string[], // para turno: [\"manha\", \"tarde\", \"noite\"]\n      timesPerDay: 1 // para diaria: quantas vezes por dia\n    },\n    serviceId: \"\",\n    siteId: \"\",\n    zoneId: \"\",\n    checklistTemplateId: \"none\",\n    // Campos opcionais de horário\n    startTime: \"\",\n    endTime: \"\",\n    isActive: true\n  });\n\n  const { data: services } = useQuery({\n    queryKey: [\"/api/customers\", activeClientId, \"services\"],\n    enabled: !!activeClientId,\n  });\n\n  const { data: sites } = useQuery({\n    queryKey: [\"/api/customers\", activeClientId, \"sites\", { module: currentModule }],\n    enabled: !!activeClientId,\n  });\n\n  const { data: zones } = useQuery({\n    queryKey: [\"/api/customers\", activeClientId, \"zones\", { module: currentModule }],\n    enabled: !!activeClientId,\n  });\n\n  const { data: checklistTemplates } = useQuery({\n    queryKey: [\"/api/companies\", activeClientId, \"checklist-templates\"],\n    enabled: !!activeClientId,\n  });\n\n\n\n  // Filtrar zonas baseado no site selecionado\n  const filteredZones = useMemo(() => {\n    if (!formData.siteId || !zones) return [];\n    return (zones as any[]).filter((zone: any) => zone.siteId === formData.siteId);\n  }, [zones, formData.siteId]);\n\n  const handleChange = (field: string, value: any) => {\n    setFormData(prev => {\n      const newData = { ...prev, [field]: value };\n      \n      // Auto-preenchimento de checklist baseado no serviço selecionado\n      if (field === 'serviceId' && value && services) {\n        const selectedService = (services as any[]).find(s => s.id === value);\n        if (selectedService?.checklistTemplateId) {\n          newData.checklistTemplateId = selectedService.checklistTemplateId;\n        }\n      }\n      \n      // Limpar zona quando site muda\n      if (field === 'siteId') {\n        newData.zoneId = \"\";\n      }\n      \n      // Reset frequency config quando muda frequência\n      if (field === 'frequency') {\n        newData.frequencyConfig = {\n          weekDays: [],\n          monthDay: 1,\n          turnShifts: [],\n          timesPerDay: 1\n        };\n      }\n      \n      return newData;\n    });\n  };\n\n  const handleFrequencyConfigChange = (configField: string, value: any) => {\n    setFormData(prev => ({\n      ...prev,\n      frequencyConfig: {\n        ...prev.frequencyConfig,\n        [configField]: value\n      }\n    }));\n  };\n\n  const createActivityMutation = useMutation({\n    mutationFn: async (data: any) => {\n      // Get the site to obtain companyId\n      const site = (sites as any[])?.find(s => s.id === data.siteId);\n      const companyId = site?.companyId || \"company-opus-default\";\n      const submitData = {\n        ...data,\n        companyId,\n        activeClientId,\n        checklistTemplateId: data.checklistTemplateId === \"none\" ? null : data.checklistTemplateId,\n      };\n      // Retornar companyId também para usar no onSuccess\n      return { activity: await apiRequest(\"POST\", \"/api/cleaning-activities\", submitData), companyId };\n    },\n    onSuccess: async (result: any) => {\n      toast({ title: \"Atividade de limpeza criada com sucesso!\" });\n      \n      // Invalidar cache para mostrar a nova atividade na lista\n      queryClient.invalidateQueries({ \n        queryKey: [\"/api/customers\", activeClientId, \"cleaning-activities\"] \n      });\n      \n      // Gerar ordens de trabalho automaticamente\n      const companyId = result.companyId || \"company-opus-default\";\n      console.log(\"Gerando OSs para companyId:\", companyId);\n      \n      try {\n        const response = await apiRequest(\"POST\", \"/api/scheduler/generate-work-orders\", {\n          companyId\n        });\n        \n        const data = await response.json();\n        console.log(\"Resposta da geração de OSs:\", data);\n        \n        // Invalidar cache das ordens de trabalho também\n        queryClient.invalidateQueries({ \n          queryKey: [\"/api/customers\", activeClientId, \"work-orders\"] \n        });\n        \n        toast({ \n          title: \"Ordens de trabalho geradas!\", \n          description: `${data.generatedOrders || 0} OSs criadas automaticamente`\n        });\n      } catch (error) {\n        console.error(\"Erro ao gerar ordens:\", error);\n        toast({\n          title: \"Erro ao gerar OSs automáticas\",\n          description: \"As OSs precisarão ser geradas manualmente\",\n          variant: \"destructive\"\n        });\n      }\n      \n      onSuccess();\n    },\n    onError: () => {\n      toast({ \n        title: \"Erro ao criar atividade de limpeza\", \n        variant: \"destructive\" \n      });\n    },\n  });\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (!formData.name || !formData.serviceId || !formData.siteId || !formData.zoneId || !formData.startDate) {\n      toast({\n        title: \"Campos obrigatórios\",\n        description: \"Preencha todos os campos obrigatórios\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    // Validar configuração de frequência\n    if (formData.frequency === \"diaria\" && formData.frequencyConfig.timesPerDay < 1) {\n      toast({\n        title: \"Frequência diária inválida\",\n        description: \"Informe quantas vezes por dia a atividade deve ser realizada\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    if (formData.frequency === \"semanal\" && formData.frequencyConfig.weekDays.length === 0) {\n      toast({\n        title: \"Dias da semana obrigatórios\",\n        description: \"Selecione pelo menos um dia da semana\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    if (formData.frequency === \"turno\" && formData.frequencyConfig.turnShifts.length === 0) {\n      toast({\n        title: \"Turnos obrigatórios\", \n        description: \"Selecione pelo menos um turno\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    createActivityMutation.mutate(formData);\n  };\n\n  return (\n    <Dialog open={true} onOpenChange={onClose}>\n      <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\" data-testid=\"create-activity-modal\">\n        <DialogHeader>\n          <DialogTitle className=\"text-xl font-bold\">Nova Atividade de Limpeza</DialogTitle>\n          <DialogDescription>\n            Preencha as informações para criar uma nova atividade de limpeza programada\n          </DialogDescription>\n        </DialogHeader>\n        \n        <form onSubmit={handleSubmit} className=\"space-y-6\">\n          {/* Informações Básicas */}\n          <div className=\"space-y-4 p-4 bg-blue-50 rounded-lg border border-blue-200\">\n            <h4 className=\"font-semibold text-blue-900 flex items-center gap-2\">\n              <Settings className=\"w-4 h-4\" />\n              Informações Básicas\n            </h4>\n            \n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"name\">Nome da Atividade *</Label>\n                <Input\n                  id=\"name\"\n                  placeholder=\"Ex: Limpeza dos banheiros\"\n                  value={formData.name}\n                  onChange={(e) => handleChange(\"name\", e.target.value)}\n                  data-testid=\"input-name\"\n                  required\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"frequency\">Frequência</Label>\n                <Select value={formData.frequency} onValueChange={(value) => handleChange(\"frequency\", value)}>\n                  <SelectTrigger data-testid=\"select-frequency\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"diaria\">Diária</SelectItem>\n                    <SelectItem value=\"semanal\">Semanal</SelectItem>\n                    <SelectItem value=\"mensal\">Mensal</SelectItem>\n                    <SelectItem value=\"trimestral\">Trimestral</SelectItem>\n                    <SelectItem value=\"semestral\">Semestral</SelectItem>\n                    <SelectItem value=\"anual\">Anual</SelectItem>\n                    <SelectItem value=\"turno\">Por Turno</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"startDate\">Data de Início *</Label>\n                <Input\n                  id=\"startDate\"\n                  type=\"date\"\n                  value={formData.startDate}\n                  onChange={(e) => handleChange(\"startDate\", e.target.value)}\n                  data-testid=\"input-start-date\"\n                  required\n                />\n              </div>\n\n              {/* Campos opcionais de horário */}\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"startTime\">Horário de Início (opcional)</Label>\n                <Input\n                  id=\"startTime\"\n                  type=\"time\"\n                  placeholder=\"Ex: 08:00\"\n                  value={formData.startTime}\n                  onChange={(e) => handleChange(\"startTime\", e.target.value)}\n                  data-testid=\"input-start-time\"\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"endTime\">Horário de Fim (opcional)</Label>\n                <Input\n                  id=\"endTime\"\n                  type=\"time\"\n                  placeholder=\"Ex: 18:00\"\n                  value={formData.endTime}\n                  onChange={(e) => handleChange(\"endTime\", e.target.value)}\n                  data-testid=\"input-end-time\"\n                />\n              </div>\n\n              <div className=\"md:col-span-2 space-y-2\">\n                <Label htmlFor=\"description\">Descrição</Label>\n                <Textarea\n                  id=\"description\"\n                  placeholder=\"Descreva detalhes da atividade de limpeza...\"\n                  value={formData.description}\n                  onChange={(e) => handleChange(\"description\", e.target.value)}\n                  data-testid=\"textarea-description\"\n                  rows={3}\n                />\n              </div>\n\n              {/* Configuração de Frequência */}\n              {formData.frequency === \"diaria\" && (\n                <div key=\"daily-config\" className=\"space-y-2\">\n                  <Label htmlFor=\"timesPerDay\">Quantas vezes por dia? *</Label>\n                  <Select \n                    key=\"times-per-day-select\"\n                    value={formData.frequencyConfig.timesPerDay.toString()} \n                    onValueChange={(value) => handleFrequencyConfigChange(\"timesPerDay\", parseInt(value))}\n                  >\n                    <SelectTrigger data-testid=\"select-times-per-day\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"1\">1 vez por dia</SelectItem>\n                      <SelectItem value=\"2\">2 vezes por dia</SelectItem>\n                      <SelectItem value=\"3\">3 vezes por dia</SelectItem>\n                      <SelectItem value=\"4\">4 vezes por dia</SelectItem>\n                      <SelectItem value=\"5\">5 vezes por dia</SelectItem>\n                      <SelectItem value=\"6\">6 vezes por dia</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n              )}\n\n              {formData.frequency === \"semanal\" && (\n                <div key=\"weekly-config\" className=\"md:col-span-2 space-y-3\">\n                  <Label>Dias da Semana *</Label>\n                  <div className=\"grid grid-cols-7 gap-2\">\n                    {[\n                      { key: \"domingo\", label: \"Dom\" },\n                      { key: \"segunda\", label: \"Seg\" },\n                      { key: \"terca\", label: \"Ter\" },\n                      { key: \"quarta\", label: \"Qua\" },\n                      { key: \"quinta\", label: \"Qui\" },\n                      { key: \"sexta\", label: \"Sex\" },\n                      { key: \"sabado\", label: \"Sáb\" }\n                    ].map(day => (\n                      <label key={day.key} className=\"flex flex-col items-center space-y-1 cursor-pointer\">\n                        <input\n                          type=\"checkbox\"\n                          checked={formData.frequencyConfig.weekDays.includes(day.key)}\n                          onChange={(e) => {\n                            const newWeekDays = e.target.checked\n                              ? [...formData.frequencyConfig.weekDays, day.key]\n                              : formData.frequencyConfig.weekDays.filter(d => d !== day.key);\n                            handleFrequencyConfigChange(\"weekDays\", newWeekDays);\n                          }}\n                          className=\"rounded\"\n                        />\n                        <span className=\"text-xs\">{day.label}</span>\n                      </label>\n                    ))}\n                  </div>\n                </div>\n              )}\n\n              {formData.frequency === \"mensal\" && (\n                <div key=\"monthly-config\" className=\"space-y-2\">\n                  <Label htmlFor=\"monthDay\">Dia do Mês *</Label>\n                  <Select \n                    value={formData.frequencyConfig.monthDay.toString()} \n                    onValueChange={(value) => handleFrequencyConfigChange(\"monthDay\", parseInt(value))}\n                  >\n                    <SelectTrigger data-testid=\"select-month-day\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {Array.from({ length: 31 }, (_, i) => i + 1).map(day => (\n                        <SelectItem key={day} value={day.toString()}>\n                          Dia {day}\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n              )}\n\n              {(formData.frequency === \"trimestral\" || formData.frequency === \"semestral\" || formData.frequency === \"anual\") && (\n                <div key=\"periodic-config\" className=\"space-y-2\">\n                  <Label htmlFor=\"executionDate\">\n                    {formData.frequency === \"trimestral\" && \"Data Inicial de Execução (repete a cada 3 meses) *\"}\n                    {formData.frequency === \"semestral\" && \"Data Inicial de Execução (repete a cada 6 meses) *\"}\n                    {formData.frequency === \"anual\" && \"Data de Execução Anual *\"}\n                  </Label>\n                  <Input\n                    id=\"executionDate\"\n                    type=\"date\"\n                    value={formData.startDate || \"\"}\n                    onChange={(e) => {\n                      const date = new Date(e.target.value);\n                      handleChange(\"startDate\", e.target.value);\n                      handleFrequencyConfigChange(\"monthDay\", date.getDate());\n                    }}\n                    className=\"w-full\"\n                    data-testid=\"input-execution-date\"\n                  />\n                  <p className=\"text-xs text-muted-foreground\">\n                    {formData.frequency === \"trimestral\" && \"A atividade será executada nesta data e se repetirá a cada 3 meses\"}\n                    {formData.frequency === \"semestral\" && \"A atividade será executada nesta data e se repetirá a cada 6 meses\"}\n                    {formData.frequency === \"anual\" && \"A atividade será executada anualmente nesta data\"}\n                  </p>\n                </div>\n              )}\n\n              {formData.frequency === \"turno\" && (\n                <div key=\"shift-config\" className=\"md:col-span-2 space-y-3\">\n                  <Label>Turnos *</Label>\n                  <div className=\"flex gap-4\">\n                    {[\n                      { key: \"manha\", label: \"Manhã\" },\n                      { key: \"tarde\", label: \"Tarde\" },\n                      { key: \"noite\", label: \"Noite\" }\n                    ].map(shift => (\n                      <label key={shift.key} className=\"flex items-center space-x-2 cursor-pointer\">\n                        <input\n                          type=\"checkbox\"\n                          checked={formData.frequencyConfig.turnShifts.includes(shift.key)}\n                          onChange={(e) => {\n                            const newTurnShifts = e.target.checked\n                              ? [...formData.frequencyConfig.turnShifts, shift.key]\n                              : formData.frequencyConfig.turnShifts.filter(s => s !== shift.key);\n                            handleFrequencyConfigChange(\"turnShifts\", newTurnShifts);\n                          }}\n                          className=\"rounded\"\n                        />\n                        <span>{shift.label}</span>\n                      </label>\n                    ))}\n                  </div>\n                </div>\n              )}\n            </div>\n          </div>\n\n          {/* Local e Configurações */}\n          <div className=\"space-y-4 p-4 bg-green-50 rounded-lg border border-green-200\">\n            <h4 className=\"font-semibold text-green-900 flex items-center gap-2\">\n              <MapPin className=\"w-4 h-4\" />\n              Local e Configurações\n            </h4>\n\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"serviceId\">Serviço *</Label>\n                <Select value={formData.serviceId} onValueChange={(value) => handleChange(\"serviceId\", value)}>\n                  <SelectTrigger data-testid=\"select-service\">\n                    <SelectValue placeholder=\"Selecione o serviço\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {(services as any[])?.map((service: any) => (\n                      <SelectItem key={service.id} value={service.id}>\n                        {service.name}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n                {formData.serviceId && (services as any[])?.find(s => s.id === formData.serviceId)?.checklistTemplateId && (\n                  <p className=\"text-xs text-blue-600 mt-1\">\n                    ✨ Checklist será vinculado automaticamente\n                  </p>\n                )}\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"siteId\">Local *</Label>\n                <Select value={formData.siteId} onValueChange={(value) => handleChange(\"siteId\", value)}>\n                  <SelectTrigger data-testid=\"select-site\">\n                    <SelectValue placeholder=\"Selecione o local\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {(sites as any[])?.map((site: any) => (\n                      <SelectItem key={site.id} value={site.id}>\n                        {site.name}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"zoneId\">Zona *</Label>\n                <Select \n                  value={formData.zoneId} \n                  onValueChange={(value) => handleChange(\"zoneId\", value)}\n                  disabled={!formData.siteId}\n                >\n                  <SelectTrigger data-testid=\"select-zone\">\n                    <SelectValue placeholder={!formData.siteId ? \"Selecione um local primeiro\" : \"Selecione a zona\"} />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {filteredZones?.map((zone: any) => (\n                      <SelectItem key={zone.id} value={zone.id}>\n                        {zone.name}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"isActive\">Status</Label>\n                <Select \n                  value={formData.isActive ? \"true\" : \"false\"} \n                  onValueChange={(value) => handleChange(\"isActive\", value === \"true\")}\n                >\n                  <SelectTrigger data-testid=\"select-status\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"true\">Ativa</SelectItem>\n                    <SelectItem value=\"false\">Inativa</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n          </div>\n\n          {/* Botões de Ação */}\n          <div className=\"flex justify-end space-x-3 pt-4 border-t\">\n            <Button \n              type=\"button\" \n              variant=\"outline\" \n              onClick={onClose}\n              data-testid=\"button-cancel\"\n            >\n              Cancelar\n            </Button>\n            <Button \n              type=\"submit\" \n              disabled={createActivityMutation.isPending}\n              data-testid=\"button-create\"\n            >\n              <Save className=\"w-4 h-4 mr-2\" />\n              {createActivityMutation.isPending ? \"Criando...\" : \"Criar Atividade\"}\n            </Button>\n          </div>\n        </form>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","size_bytes":81060},"client/src/components/heatmap/CleaningHeatmap.tsx":{"content":"import React from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { AlertTriangle, CheckCircle, Clock, XCircle } from \"lucide-react\";\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from \"@/components/ui/tooltip\";\n\ninterface CleaningHeatmapProps {\n  companyId: string;\n  siteId: string;\n  onZoneClick?: (zoneId: string) => void;\n  selectedSite?: any;\n}\n\ninterface HeatmapZone {\n  zoneId: string;\n  zoneName: string;\n  category: string;\n  positionX: number;\n  positionY: number;\n  areaM2: number;\n  sizeScale: number;\n  slaPercentage: number;\n  heatLevel: 'excellent' | 'good' | 'warning' | 'critical';\n  color: string;\n  metrics: {\n    scheduledActivities: number;\n    completedOnTime: number;\n    overdueOrders: number;\n    totalOrders: number;\n  };\n}\n\nconst HeatLevelIcon = ({ level }: { level: string }) => {\n  switch (level) {\n    case 'excellent':\n      return <CheckCircle className=\"w-4 h-4 text-green-500\" />;\n    case 'good':\n      return <CheckCircle className=\"w-4 h-4 text-lime-500\" />;\n    case 'warning':\n      return <Clock className=\"w-4 h-4 text-amber-500\" />;\n    case 'critical':\n      return <AlertTriangle className=\"w-4 h-4 text-red-500\" />;\n    default:\n      return <XCircle className=\"w-4 h-4 text-gray-500\" />;\n  }\n};\n\nconst getLevelLabel = (level: string): string => {\n  switch (level) {\n    case 'excellent':\n      return 'Excelente';\n    case 'good':\n      return 'Bom';\n    case 'warning':\n      return 'Atenção';\n    case 'critical':\n      return 'Crítico';\n    default:\n      return 'N/A';\n  }\n};\n\nexport default function CleaningHeatmap({ companyId, siteId, onZoneClick, selectedSite }: CleaningHeatmapProps) {\n  // Use the same zones query as SiteMap to get identical position data\n  const { data: zones, isLoading: zonesLoading, error: zonesError } = useQuery({\n    queryKey: [\"/api/sites\", siteId, \"zones\"],\n    enabled: !!siteId,\n  });\n\n  // Get SLA data for each zone\n  const { data: heatmapData, isLoading: heatmapLoading, error: heatmapError } = useQuery({\n    queryKey: ['/api/companies', companyId, 'heatmap', siteId],\n    enabled: !!(companyId && siteId),\n  });\n\n  // Merge zone position data from SiteMap with SLA data from heatmap - MOVED TO TOP\n  const zonesWithSLA = React.useMemo(() => {\n    if (!zones || !heatmapData) return [];\n    \n    return (zones as any[]).map((zone: any) => {\n      const slaData = Array.isArray(heatmapData) ? heatmapData.find((hm: any) => hm.zoneId === zone.id) : null;\n      return {\n        zoneId: zone.id,\n        zoneName: zone.name,\n        category: zone.category,\n        positionX: zone.positionX,\n        positionY: zone.positionY,\n        areaM2: zone.areaM2 ? Number(zone.areaM2) : 0,\n        sizeScale: zone.sizeScale ? Number(zone.sizeScale) : 1,\n        slaPercentage: slaData?.slaPercentage || 100,\n        heatLevel: slaData?.heatLevel || 'excellent',\n        color: slaData?.color || '#10B981',\n        metrics: slaData?.metrics || {\n          scheduledActivities: 0,\n          completedOnTime: 0,\n          overdueOrders: 0,\n          totalOrders: 0\n        }\n      };\n    });\n  }, [zones, heatmapData]);\n\n  const isLoading = zonesLoading || heatmapLoading;\n  const error = zonesError || heatmapError;\n\n  if (isLoading) {\n    return (\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <div className=\"w-5 h-5 bg-gradient-to-r from-green-400 via-yellow-400 to-red-400 rounded\"></div>\n            Mapa de Calor - SLA de Limpeza\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"flex items-center justify-center h-64\">\n            <div className=\"animate-pulse space-y-2 w-full\">\n              <div className=\"h-4 bg-gray-200 rounded w-3/4\"></div>\n              <div className=\"h-4 bg-gray-200 rounded w-1/2\"></div>\n              <div className=\"h-32 bg-gray-200 rounded\"></div>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  if (error) {\n    return (\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2 text-red-500\">\n            <div className=\"w-5 h-5 bg-gradient-to-r from-green-400 via-yellow-400 to-red-400 rounded\"></div>\n            Erro - Mapa de Calor\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"text-center py-8\">\n            <p className=\"text-red-500\">Erro ao carregar dados do mapa de calor</p>\n            <p className=\"text-sm text-muted-foreground mt-2\">\n              Verifique a conexão e tente novamente\n            </p>\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  if (zonesWithSLA.length === 0) {\n    return (\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <div className=\"w-5 h-5 bg-gradient-to-r from-green-400 via-yellow-400 to-red-400 rounded\"></div>\n            Mapa de Calor - SLA de Limpeza\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"text-center py-8\">\n            <div className=\"w-16 h-16 bg-gradient-to-r from-green-400 via-yellow-400 to-red-400 rounded-full mx-auto mb-4 opacity-20\"></div>\n            <p className=\"text-muted-foreground\">Nenhuma zona encontrada para análise</p>\n            <p className=\"text-sm text-muted-foreground mt-2\">\n              Adicione locais ao site para visualizar o mapa de calor\n            </p>\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  return (\n    <Card>\n      <CardHeader>\n        <CardTitle className=\"flex items-center gap-2\">\n          <div className=\"w-5 h-5 bg-gradient-to-r from-green-400 via-yellow-400 to-red-400 rounded\"></div>\n          Mapa de Calor - SLA de Limpeza\n        </CardTitle>\n        <p className=\"text-sm text-muted-foreground\">\n          Mostra o cumprimento do SLA de limpeza por zona (atividades executadas no prazo)\n        </p>\n      </CardHeader>\n      <CardContent>\n        {/* Heat Map Visualization - Same layout as SiteMap */}\n        <div className=\"bg-muted/50 rounded-lg p-4 relative min-h-96 overflow-hidden\">\n          <div className=\"absolute inset-4 bg-background border-2 border-border rounded select-none\">\n            {/* Site title */}\n            <div className=\"absolute top-2 left-4 text-sm font-medium text-foreground z-50\">\n              {selectedSite?.name} - Mapa de SLA de Limpeza\n            </div>\n            \n            <TooltipProvider>\n              {zonesWithSLA.map((zone, index) => {\n                const area = parseFloat(zone.areaM2?.toString() || '0');\n                const allAreas = zonesWithSLA.map((z: any) => parseFloat(z.areaM2?.toString() || '0'));\n                const maxArea = Math.max(...allAreas);\n                const minArea = Math.min(...allAreas.filter(a => a > 0));\n                \n                // Calculate proportional size exactly like SiteMap\n                const minSize = 80;\n                const maxSize = 180;\n                const sizeRatio = maxArea > minArea && area > 0 ? (area - minArea) / (maxArea - minArea) : 0;\n                const calculatedSize = minSize + (sizeRatio * (maxSize - minSize));\n                const size = Math.max(minSize, Math.min(maxSize, calculatedSize));\n                \n                // Use EXACT same positioning logic as SiteMap component  \n                // Use direct index (NOT sorted by area) to match SiteMap exactly\n                const directIndex = index;\n                \n                // Default positions matching SiteMap exactly\n                const defaultPositions = [\n                  { left: 20, top: 30 },\n                  { left: 70, top: 20 },\n                  { left: 50, top: 70 },\n                  { left: 15, top: 75 },\n                  { left: 80, top: 75 }\n                ];\n                \n                // Use saved positions from \"Planta dos Locais\" if available, otherwise use defaults\n                // This ensures EXACT layout replication from the site map editor\n                const position = zone.positionX && zone.positionY\n                  ? { left: parseFloat(zone.positionX.toString()), top: parseFloat(zone.positionY.toString()) }\n                  : defaultPositions[directIndex] || defaultPositions[0];\n\n                return (\n                  <Tooltip key={zone.zoneId}>\n                    <TooltipTrigger asChild>\n                      <div\n                        className=\"absolute cursor-pointer border-2 border-white shadow-lg hover:scale-105 transition-all duration-200 z-10 rounded-lg flex flex-col items-center justify-center text-white text-xs font-semibold p-2\"\n                        style={{\n                          backgroundColor: zone.color,\n                          left: `${position.left}%`,\n                          top: `${position.top}%`,\n                          width: `${size}px`,\n                          height: `${size * 0.75}px`, // Rectangle aspect ratio\n                          transform: 'translate(-50%, -50%)',\n                          opacity: 0.9,\n                          borderWidth: '2px'\n                        }}\n                        onClick={() => onZoneClick?.(zone.zoneId)}\n                        data-testid={`heatmap-zone-${zone.zoneId}`}\n                      >\n                        <div className=\"text-center\">\n                          <div className=\"font-bold text-white truncate max-w-full text-xs\">\n                            {zone.zoneName}\n                          </div>\n                          <div className=\"text-xs opacity-90 font-bold\">\n                            {zone.slaPercentage}% SLA\n                          </div>\n                          {zone.areaM2 > 0 && (\n                            <div className=\"text-xs opacity-75\">\n                              {zone.areaM2}m²\n                            </div>\n                          )}\n                        </div>\n                      </div>\n                    </TooltipTrigger>\n                    <TooltipContent side=\"top\" className=\"max-w-xs\">\n                      <div className=\"space-y-2\">\n                        <div className=\"font-semibold flex items-center gap-2\">\n                          <HeatLevelIcon level={zone.heatLevel} />\n                          {zone.zoneName}\n                        </div>\n                        <div className=\"text-sm space-y-1\">\n                          <p><strong>SLA:</strong> {zone.slaPercentage}%</p>\n                          <p><strong>Nível:</strong> {getLevelLabel(zone.heatLevel)}</p>\n                          <p><strong>Atividades Programadas:</strong> {zone.metrics.scheduledActivities}</p>\n                          <p><strong>Concluídas no Prazo:</strong> {zone.metrics.completedOnTime}</p>\n                          <p><strong>Em Atraso:</strong> {zone.metrics.overdueOrders}</p>\n                          {zone.areaM2 > 0 && <p><strong>Área:</strong> {zone.areaM2}m²</p>}\n                          {zone.category && <p><strong>Categoria:</strong> {zone.category}</p>}\n                        </div>\n                      </div>\n                    </TooltipContent>\n                  </Tooltip>\n                );\n              })}\n            </TooltipProvider>\n          </div>\n        </div>\n        \n        {/* Legend */}\n        <div className=\"mt-4 flex items-center justify-between text-sm\">\n          <span className=\"text-muted-foreground\">Legenda:</span>\n          <div className=\"flex items-center gap-4\">\n            <div className=\"flex items-center gap-2\">\n              <div className=\"w-4 h-4 bg-green-500 rounded\"></div>\n              <span>Excelente (≥95%)</span>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <div className=\"w-4 h-4 bg-lime-500 rounded\"></div>\n              <span>Bom (85-94%)</span>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <div className=\"w-4 h-4 bg-amber-500 rounded\"></div>\n              <span>Atenção (70-84%)</span>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <div className=\"w-4 h-4 bg-red-500 rounded\"></div>\n              <span>Crítico (&lt;70%)</span>\n            </div>\n          </div>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}","size_bytes":12415},"client/src/pages/qr-test.tsx":{"content":"import { useState } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { ArrowLeft, Search, CheckCircle, XCircle } from \"lucide-react\";\nimport { useLocation } from \"wouter\";\n\nconst COMPANY_ID = \"company-opus-default\";\n\nexport default function QrTest() {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const [qrCode, setQrCode] = useState(\"\");\n  const [result, setResult] = useState<any>(null);\n  const [loading, setLoading] = useState(false);\n  const [error, setError] = useState(\"\");\n\n  const testQrCode = async () => {\n    if (!qrCode.trim()) {\n      toast({\n        title: \"Erro\",\n        description: \"Digite um código QR para testar\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setLoading(true);\n    setError(\"\");\n    setResult(null);\n\n    try {\n      const response = await fetch(`/api/qr-scan/resolve?code=${encodeURIComponent(qrCode.trim())}&companyId=${COMPANY_ID}`);\n      \n      if (response.ok) {\n        const data = await response.json();\n        setResult(data);\n        toast({\n          title: \"✅ QR Code encontrado!\",\n          description: `${data.zone.name} - ${data.site.name}`,\n        });\n      } else {\n        const errorData = await response.text();\n        setError(`${response.status}: ${errorData}`);\n        toast({\n          title: \"❌ QR Code não encontrado\",\n          description: `Status: ${response.status}`,\n          variant: \"destructive\",\n        });\n      }\n    } catch (err) {\n      setError(`Erro de rede: ${err}`);\n      toast({\n        title: \"❌ Erro de conexão\",\n        description: \"Não foi possível conectar ao servidor\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const addPhysicalCodes = async () => {\n    setIsAddingCodes(true);\n    let successCount = 0;\n    let errorCount = 0;\n\n    for (const codeData of physicalCodesToAdd) {\n      try {\n        const response = await fetch('/api/qr-points', {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({\n            ...codeData,\n            companyId: COMPANY_ID,\n            type: 'execution',\n            isActive: true\n          }),\n        });\n\n        if (response.ok) {\n          successCount++;\n        } else {\n          errorCount++;\n          console.log(`Erro ao adicionar ${codeData.code}:`, await response.text());\n        }\n      } catch (error) {\n        errorCount++;\n        console.log(`Erro de rede ao adicionar ${codeData.code}:`, error);\n      }\n    }\n\n    setIsAddingCodes(false);\n    toast({\n      title: successCount > 0 ? \"✅ QR Codes adicionados!\" : \"❌ Erro ao adicionar códigos\",\n      description: `${successCount} códigos adicionados, ${errorCount} erros`,\n      variant: errorCount > successCount ? \"destructive\" : \"default\",\n    });\n  };\n\n  const [isAddingCodes, setIsAddingCodes] = useState(false);\n\n  const predefinedCodes = [\n    { name: \"QR Teste Simples\", code: \"TESTE123\" },\n    { name: \"QR ABC\", code: \"ABC\" },\n    { name: \"QR Numérico\", code: \"12345\" },\n    { name: \"QR Execução\", code: \"95724a42-d74e-4c8e-ad3e-ba2cf4c8c2c9\" },\n    { name: \"QR Atendimento\", code: \"qqq\" },\n    // Códigos físicos comuns\n    { name: \"QR Físico Principal\", code: \"PHYSICAL001\" },\n    { name: \"Banheiro 001\", code: \"BATH001\" },\n    { name: \"Banheiro 002\", code: \"BATH002\" },\n    { name: \"Escritório 001\", code: \"OFFICE001\" },\n    { name: \"Limpeza 001\", code: \"CLEAN001\" },\n    { name: \"Código 00001\", code: \"00001\" },\n    { name: \"Código 00002\", code: \"00002\" },\n    { name: \"Área A001\", code: \"A001\" },\n    { name: \"Área B001\", code: \"B001\" },\n    { name: \"Sala 001\", code: \"SALA001\" },\n    { name: \"QR Point 001\", code: \"QR001\" },\n    { name: \"QR Point 002\", code: \"QR002\" },\n    { name: \"Local 001\", code: \"LOC001\" },\n    { name: \"Zona 001\", code: \"ZONE001\" },\n  ];\n\n  const physicalCodesToAdd = [\n    { code: \"PHYSICAL001\", name: \"QR Físico - Banheiro Principal\", zoneId: \"zone-3\" },\n    { code: \"BATH001\", name: \"Banheiro 001\", zoneId: \"zone-3\" },\n    { code: \"BATH002\", name: \"Banheiro 002\", zoneId: \"zone-3\" },\n    { code: \"OFFICE001\", name: \"Escritório 001\", zoneId: \"zone-3\" },\n    { code: \"CLEAN001\", name: \"Limpeza 001\", zoneId: \"zone-3\" },\n    { code: \"00001\", name: \"Código Numérico 00001\", zoneId: \"zone-3\" },\n    { code: \"00002\", name: \"Código Numérico 00002\", zoneId: \"zone-3\" },\n    { code: \"A001\", name: \"Área A001\", zoneId: \"zone-3\" },\n    { code: \"B001\", name: \"Área B001\", zoneId: \"zone-3\" },\n    { code: \"SALA001\", name: \"Sala 001\", zoneId: \"zone-3\" },\n    { code: \"QR001\", name: \"QR Point 001\", zoneId: \"zone-3\" },\n    { code: \"QR002\", name: \"QR Point 002\", zoneId: \"zone-3\" },\n    { code: \"LOC001\", name: \"Local 001\", zoneId: \"zone-3\" },\n    { code: \"ZONE001\", name: \"Zona 001\", zoneId: \"zone-3\" },\n  ];\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4\">\n      <div className=\"max-w-2xl mx-auto\">\n        {/* Header */}\n        <div className=\"flex items-center justify-between mb-6\">\n          <Button \n            variant=\"ghost\" \n            onClick={() => setLocation(\"/mobile\")}\n            className=\"p-2\"\n          >\n            <ArrowLeft className=\"w-6 h-6\" />\n          </Button>\n          <h1 className=\"text-xl font-bold\">Teste QR Code</h1>\n          <div></div>\n        </div>\n\n        {/* Manual Test */}\n        <Card className=\"mb-6\">\n          <CardHeader>\n            <CardTitle>Teste Manual de QR Code</CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"flex space-x-2\">\n              <Input\n                placeholder=\"Digite o código QR aqui\"\n                value={qrCode}\n                onChange={(e) => setQrCode(e.target.value)}\n                onKeyPress={(e) => e.key === \"Enter\" && testQrCode()}\n              />\n              <Button onClick={testQrCode} disabled={loading}>\n                <Search className=\"w-4 h-4 mr-2\" />\n                {loading ? \"Testando...\" : \"Testar\"}\n              </Button>\n            </div>\n\n            {/* Add Physical Codes Button */}\n            <div className=\"flex justify-center py-4\">\n              <Button \n                onClick={addPhysicalCodes} \n                disabled={isAddingCodes}\n                variant=\"outline\"\n                className=\"w-full\"\n              >\n                {isAddingCodes ? \"Adicionando códigos...\" : \"📱 Adicionar QR Codes Físicos Comuns\"}\n              </Button>\n            </div>\n\n            {/* Predefined QR Codes */}\n            <div className=\"space-y-2\">\n              <p className=\"text-sm text-muted-foreground\">QR Codes no sistema ({predefinedCodes.length} códigos):</p>\n              {predefinedCodes.map((item) => (\n                <div key={item.code} className=\"flex items-center justify-between p-2 bg-muted rounded\">\n                  <div>\n                    <p className=\"font-medium\">{item.name}</p>\n                    <p className=\"text-xs text-muted-foreground font-mono\">{item.code}</p>\n                  </div>\n                  <Button \n                    size=\"sm\" \n                    variant=\"outline\"\n                    onClick={() => setQrCode(item.code)}\n                  >\n                    Usar\n                  </Button>\n                </div>\n              ))}\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Results */}\n        {error && (\n          <Card className=\"mb-6 border-red-200\">\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center space-x-2 text-red-600\">\n                <XCircle className=\"w-5 h-5\" />\n                <p className=\"font-medium\">Erro:</p>\n              </div>\n              <p className=\"text-sm text-red-600 mt-1 font-mono\">{error}</p>\n            </CardContent>\n          </Card>\n        )}\n\n        {result && (\n          <Card className=\"border-green-200\">\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center space-x-2 text-green-600 mb-4\">\n                <CheckCircle className=\"w-5 h-5\" />\n                <p className=\"font-medium\">QR Code encontrado com sucesso!</p>\n              </div>\n              \n              <div className=\"space-y-3\">\n                <div>\n                  <p className=\"font-medium\">QR Point:</p>\n                  <p className=\"text-sm\">Nome: {result.qrPoint.name}</p>\n                  <p className=\"text-sm\">Tipo: {result.qrPoint.type}</p>\n                  <p className=\"text-sm\">Código: {result.qrPoint.code}</p>\n                </div>\n                \n                <div>\n                  <p className=\"font-medium\">Localização:</p>\n                  <p className=\"text-sm\">Zona: {result.zone.name}</p>\n                  <p className=\"text-sm\">Local: {result.site.name}</p>\n                  <p className=\"text-sm\">Empresa: {result.company.name}</p>\n                </div>\n                \n                <div>\n                  <p className=\"font-medium\">Serviços disponíveis: {result.services.length}</p>\n                  <div className=\"max-h-32 overflow-y-auto\">\n                    {result.services.slice(0, 3).map((service: any) => (\n                      <p key={service.id} className=\"text-xs text-muted-foreground\">\n                        • {service.name}\n                      </p>\n                    ))}\n                    {result.services.length > 3 && (\n                      <p className=\"text-xs text-muted-foreground\">\n                        ... e mais {result.services.length - 3} serviços\n                      </p>\n                    )}\n                  </div>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        )}\n\n        {/* Instructions */}\n        <Card className=\"mt-6\">\n          <CardHeader>\n            <CardTitle>Instruções para Teste</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-2 text-sm\">\n              <p>1. <strong>📱 Primeiro:</strong> Clique em \"Adicionar QR Codes Físicos Comuns\" para registrar códigos típicos</p>\n              <p>2. <strong>🔍 Teste Manual:</strong> Digite o código do seu QR físico na caixa de texto acima</p>\n              <p>3. <strong>📱 Scanner:</strong> Se funcionar aqui, funcionará no scanner mobile</p>\n              <p>4. <strong>✅ Códigos Disponíveis:</strong> Temos {predefinedCodes.length} códigos cadastrados (veja a lista acima)</p>\n              <p>5. <strong>🎯 Dica:</strong> Se seu QR físico não funcionar, ele precisa conter exatamente um dos códigos cadastrados</p>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}","size_bytes":10950},"client/src/components/ui/toast.tsx":{"content":"import * as React from \"react\"\nimport * as ToastPrimitives from \"@radix-ui/react-toast\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ToastProvider = ToastPrimitives.Provider\n\nconst ToastViewport = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Viewport>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Viewport\n    ref={ref}\n    className={cn(\n      \"fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]\",\n      className\n    )}\n    {...props}\n  />\n))\nToastViewport.displayName = ToastPrimitives.Viewport.displayName\n\nconst toastVariants = cva(\n  \"group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full\",\n  {\n    variants: {\n      variant: {\n        default: \"border bg-background text-foreground\",\n        destructive:\n          \"destructive group border-destructive bg-destructive text-destructive-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Toast = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &\n    VariantProps<typeof toastVariants>\n>(({ className, variant, ...props }, ref) => {\n  return (\n    <ToastPrimitives.Root\n      ref={ref}\n      className={cn(toastVariants({ variant }), className)}\n      {...props}\n    />\n  )\n})\nToast.displayName = ToastPrimitives.Root.displayName\n\nconst ToastAction = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Action>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Action\n    ref={ref}\n    className={cn(\n      \"inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive\",\n      className\n    )}\n    {...props}\n  />\n))\nToastAction.displayName = ToastPrimitives.Action.displayName\n\nconst ToastClose = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Close>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Close\n    ref={ref}\n    className={cn(\n      \"absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600\",\n      className\n    )}\n    toast-close=\"\"\n    {...props}\n  >\n    <X className=\"h-4 w-4\" />\n  </ToastPrimitives.Close>\n))\nToastClose.displayName = ToastPrimitives.Close.displayName\n\nconst ToastTitle = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Title>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Title\n    ref={ref}\n    className={cn(\"text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nToastTitle.displayName = ToastPrimitives.Title.displayName\n\nconst ToastDescription = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Description>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Description\n    ref={ref}\n    className={cn(\"text-sm opacity-90\", className)}\n    {...props}\n  />\n))\nToastDescription.displayName = ToastPrimitives.Description.displayName\n\ntype ToastProps = React.ComponentPropsWithoutRef<typeof Toast>\n\ntype ToastActionElement = React.ReactElement<typeof ToastAction>\n\nexport {\n  type ToastProps,\n  type ToastActionElement,\n  ToastProvider,\n  ToastViewport,\n  Toast,\n  ToastTitle,\n  ToastDescription,\n  ToastClose,\n  ToastAction,\n}\n","size_bytes":4845},"client/src/main.tsx":{"content":"import { createRoot } from \"react-dom/client\";\nimport App from \"./App\";\nimport \"./index.css\";\n\ncreateRoot(document.getElementById(\"root\")!).render(<App />);\n","size_bytes":157},"drizzle.config.ts":{"content":"import { defineConfig } from \"drizzle-kit\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\"DATABASE_URL, ensure the database is provisioned\");\n}\n\nexport default defineConfig({\n  out: \"./migrations\",\n  schema: \"./shared/schema.ts\",\n  dialect: \"postgresql\",\n  dbCredentials: {\n    url: process.env.DATABASE_URL,\n  },\n});\n","size_bytes":325},"client/src/pages/checklists.backup.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Select as CustomSelect, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport Select from \"react-select\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useClient } from \"@/contexts/ClientContext\";\nimport { Plus, Edit3, Trash2, FileText, List, Eye } from \"lucide-react\";\nimport type { ChecklistTemplate } from \"@shared/schema\";\n\ninterface ChecklistItem {\n  id: string;\n  type: 'text' | 'number' | 'photo';\n  label: string;\n  required: boolean;\n  description?: string;\n  validation?: {\n    minLength?: number;\n    maxLength?: number;\n    minValue?: number;\n    maxValue?: number;\n    photoRequired?: boolean;\n    photoMinCount?: number;\n    photoMaxCount?: number;\n  };\n}\n\ninterface SelectOption {\n  value: string;\n  label: string;\n}\ninterface Checklist {\n  id: string;\n  name: string;\n  description: string;\n  items: ChecklistItem[];\n  companyId: string;\n  createdAt: string;\n  updatedAt: string;\n}\n\nexport default function Checklists() {\n  const { activeClientId } = useClient();\n  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);\n  const [editingChecklist, setEditingChecklist] = useState<Checklist | null>(null);\n  const [checklistForm, setChecklistForm] = useState({\n    name: \"\",\n    description: \"\",\n    siteIds: [] as string[],\n    zoneIds: [] as string[],\n    serviceId: \"\",\n    items: [] as ChecklistItem[]\n  });\n  const [newItem, setNewItem] = useState<Partial<ChecklistItem>>({\n    type: 'text',\n    label: \"\",\n    required: false,\n    description: \"\",\n    validation: {}\n  });\n\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n// Função para lidar com a mudança de valor no Multiselect\nconst handleMultiSelectChange = (\n  selectedOptions: SelectOption[] | null, \n  field: \"siteIds\" | \"zoneIds\"\n) => {\n  const ids = selectedOptions ? selectedOptions.map((option: SelectOption) => option.value) : [];\n  setChecklistForm(prev => ({ ...prev, [field]: ids }));\n};\n\n\n  const { data: checklists = [], isLoading } = useQuery<ChecklistTemplate[]>({\n    queryKey: [\"/api/customers\", activeClientId, \"checklist-templates\"],\n    enabled: !!activeClientId,\n  });\n\n  const { data: sites = [] } = useQuery({\n    queryKey: [\"/api/customers\", activeClientId, \"sites\"],\n    enabled: !!activeClientId,\n  });\n\n  const { data: services = [] } = useQuery({\n    queryKey: [\"/api/customers\", activeClientId, \"services\"],\n    enabled: !!activeClientId,\n  });\n\n  // Buscar zonas quando um site é selecionado\n  const { data: zones = [] } = useQuery({\n    queryKey: [\"/api/sites\", checklistForm.siteId, \"zones\"],\n    enabled: !!checklistForm.siteId,\n  });\n\n  const createChecklistMutation = useMutation({\n    mutationFn: async (data: typeof checklistForm) => {\n      const response = await apiRequest(\"POST\", `/api/customers/${activeClientId}/checklist-templates`, data);\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/customers\", activeClientId, \"checklist-templates\"] });\n      setIsCreateDialogOpen(false);\n      resetForm();\n      toast({\n        title: \"Checklist criado\",\n        description: \"O checklist foi criado com sucesso.\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Erro ao criar checklist\",\n        description: \"Houve um problema ao criar o checklist.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateChecklistMutation = useMutation({\n    mutationFn: async (data: typeof checklistForm & { id: string }) => {\n      const response = await apiRequest(\"PUT\", `/api/customers/${activeClientId}/checklist-templates/${data.id}`, data);\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/customers\", activeClientId, \"checklist-templates\"] });\n      setIsCreateDialogOpen(false);\n      setEditingChecklist(null);\n      resetForm();\n      toast({\n        title: \"Checklist atualizado\",\n        description: \"O checklist foi atualizado com sucesso.\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Erro ao atualizar checklist\",\n        description: \"Houve um problema ao atualizar o checklist.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteChecklistMutation = useMutation({\n    mutationFn: async (checklistId: string) => {\n      await apiRequest(\"DELETE\", `/api/customers/${activeClientId}/checklist-templates/${checklistId}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/customers\", activeClientId, \"checklist-templates\"] });\n      toast({\n        title: \"Checklist excluído\",\n        description: \"O checklist foi excluído com sucesso.\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Erro ao excluir checklist\",\n        description: \"Houve um problema ao excluir o checklist.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const resetForm = () => {\n    setChecklistForm({\n      name: \"\",\n      description: \"\",\n      siteIds: [] as string[],\n      zoneIds: [] as string[],\n      serviceId: \"\",\n      items: []\n    });\n    setNewItem({\n      type: 'text',\n      label: \"\",\n      required: false,\n      description: \"\",\n      validation: {}\n    });\n  };\n\n  const addItem = () => {\n    if (!newItem.label?.trim()) {\n      toast({\n        title: \"Campo obrigatório\",\n        description: \"O rótulo do item é obrigatório.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    const item: ChecklistItem = {\n      id: Date.now().toString(),\n      type: newItem.type as ChecklistItem['type'],\n      label: newItem.label,\n      required: newItem.required || false,\n      description: newItem.description || \"\",\n      validation: newItem.validation || {}\n    };\n\n    setChecklistForm(prev => ({\n      ...prev,\n      items: [...prev.items, item]\n    }));\n\n    setNewItem({\n      type: 'text',\n      label: \"\",\n      required: false,\n      description: \"\",\n      validation: {}\n    });\n  };\n\n  const removeItem = (itemId: string) => {\n    setChecklistForm(prev => ({\n      ...prev,\n      items: prev.items.filter(item => item.id !== itemId)\n    }));\n  };\n\n  const handleEdit = (checklist: any) => {\n    setEditingChecklist(checklist);\n    setChecklistForm({\n      name: checklist.name,\n      description: checklist.description,\n      siteIds: checklist.siteIds || [],\n      zoneIds: checklist.zoneIds || [],\n      serviceId: checklist.serviceId || \"\",\n      items: checklist.items\n    });\n    setIsCreateDialogOpen(true);\n  };\n\n  const handleSubmit = () => {\n    if (!checklistForm.name.trim()) {\n      toast({\n        title: \"Campo obrigatório\",\n        description: \"O nome do checklist é obrigatório.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (checklistForm.siteIds.length === 0) {\n      toast({\n        title: \"Campo obrigatório\",\n        description: \"Selecione pelo menos um local para o checklist.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (checklistForm.zoneIds.length === 0) {\n      toast({\n        title: \"Campo obrigatório\",\n        description: \"Selecione pelo menos uma zona para o checklist.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (!checklistForm.serviceId) {\n      toast({\n        title: \"Campo obrigatório\",\n        description: \"Selecione um serviço para o checklist.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (checklistForm.items.length === 0) {\n      toast({\n        title: \"Itens obrigatórios\",\n        description: \"Adicione pelo menos um item ao checklist.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (editingChecklist) {\n      updateChecklistMutation.mutate({\n        ...checklistForm,\n        id: editingChecklist.id\n      });\n    } else {\n      createChecklistMutation.mutate(checklistForm);\n    }\n  };\n\n  const getTypeIcon = (type: string) => {\n    switch (type) {\n      case 'photo': return <Eye className=\"w-4 h-4\" />;\n      case 'number': return <span className=\"w-4 h-4 text-center text-xs font-bold\">#</span>;\n      default: return <FileText className=\"w-4 h-4\" />;\n    }\n  };\n\n  const getTypeLabel = (type: string) => {\n    switch (type) {\n      case 'photo': return 'Foto';\n      case 'number': return 'Número';\n      default: return 'Texto';\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"h-full bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 p-6\">\n        <div className=\"text-center space-y-4\">\n          <div className=\"w-16 h-16 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mx-auto\"></div>\n          <p className=\"text-slate-600\">Carregando checklists...</p>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"h-full overflow-auto bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50\">\n      {/* Header */}\n      <div className=\"bg-white/80 backdrop-blur-xl border-b border-white/20 shadow-lg shadow-blue-500/5 sticky top-0 z-50\">\n        <div className=\"px-8 py-6\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center space-x-4\">\n              <div className=\"w-12 h-12 bg-gradient-to-br from-green-600 via-green-700 to-emerald-800 rounded-2xl flex items-center justify-center shadow-lg\">\n                <List className=\"w-7 h-7 text-white\" />\n              </div>\n              <div>\n                <h1 className=\"text-3xl font-bold bg-gradient-to-r from-slate-900 via-green-900 to-emerald-900 bg-clip-text text-transparent\">\n                  Checklists\n                </h1>\n                <p className=\"text-sm text-slate-600\">\n                  Gerencie os checklists para ordens de serviço\n                </p>\n              </div>\n            </div>\n            <Dialog open={isCreateDialogOpen} onOpenChange={(open) => {\n              setIsCreateDialogOpen(open);\n              if (!open) {\n                setEditingChecklist(null);\n                resetForm();\n              }\n            }}>\n              <DialogTrigger asChild>\n                <Button \n                  className=\"bg-gradient-to-r from-green-600 to-emerald-700 hover:from-green-700 hover:to-emerald-800\"\n                  data-testid=\"button-create-checklist\"\n                >\n                  <Plus className=\"w-4 h-4 mr-2\" />\n                  Novo Checklist\n                </Button>\n              </DialogTrigger>\n              <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\">\n                <DialogHeader>\n                  <DialogTitle>\n                    {editingChecklist ? \"Editar Checklist\" : \"Criar Novo Checklist\"}\n                  </DialogTitle>\n                </DialogHeader>\n                \n                <div className=\"space-y-6\">\n                  {/* Form básico */}\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"name\">Nome do Checklist</Label>\n                      <Input\n                        id=\"name\"\n                        data-testid=\"input-checklist-name\"\n                        value={checklistForm.name}\n                        onChange={(e) => setChecklistForm(prev => ({ ...prev, name: e.target.value }))}\n                        placeholder=\"Ex: Limpeza de Banheiros\"\n                      />\n                    </div>\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"description\">Descrição</Label>\n                      <Textarea\n                        id=\"description\"\n                        data-testid=\"input-checklist-description\"\n                        value={checklistForm.description}\n                        onChange={(e) => setChecklistForm(prev => ({ ...prev, description: e.target.value }))}\n                        placeholder=\"Descrição do checklist...\"\n                        rows={2}\n                      />\n                    </div>\n                  </div>\n\n                  {/* Vinculação obrigatória */}\n                  <div className=\"grid grid-cols-3 gap-4\">\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"siteId\">Local <span className=\"text-red-500\">*</span></Label>\n                      <Select \n                        value={checklistForm.siteId} \n                        onValueChange={(value) => setChecklistForm(prev => ({ \n                          ...prev, \n                          siteId: value,\n                          zoneId: \"\" // Reset zona quando mudar o local\n                        }))}\n                      >\n                        <SelectTrigger data-testid=\"select-checklist-site\">\n                          <SelectValue placeholder=\"Selecione o local\" />\n                        </SelectTrigger>\n                        <SelectContent>\n                          {(sites as any[]).map((site) => (\n                            <SelectItem key={site.id} value={site.id}>\n                              {site.name}\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                    </div>\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"zoneId\">Zona <span className=\"text-red-500\">*</span></Label>\n                      <Select \n                        value={checklistForm.zoneId} \n                        onValueChange={(value) => setChecklistForm(prev => ({ ...prev, zoneId: value }))}\n                        disabled={!checklistForm.siteId}\n                      >\n                        <SelectTrigger data-testid=\"select-checklist-zone\">\n                          <SelectValue placeholder={checklistForm.siteId ? \"Selecione a zona\" : \"Selecione um local primeiro\"} />\n                        </SelectTrigger>\n                        <SelectContent>\n                          {(zones as any[]).map((zone) => (\n                            <SelectItem key={zone.id} value={zone.id}>\n                              {zone.name}\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                    </div>\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"serviceId\">Serviço <span className=\"text-red-500\">*</span></Label>\n                      <Select \n                        value={checklistForm.serviceId} \n                        onValueChange={(value) => setChecklistForm(prev => ({ ...prev, serviceId: value }))}\n                      >\n                        <SelectTrigger data-testid=\"select-checklist-service\">\n                          <SelectValue placeholder=\"Selecione o serviço\" />\n                        </SelectTrigger>\n                        <SelectContent>\n                          {(services as any[]).map((service) => (\n                            <SelectItem key={service.id} value={service.id}>\n                              {service.name}\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                    </div>\n                  </div>\n\n                  {/* Adicionar item */}\n                  <Card>\n                    <CardHeader>\n                      <CardTitle className=\"text-lg\">Adicionar Item</CardTitle>\n                    </CardHeader>\n                    <CardContent className=\"space-y-4\">\n                      <div className=\"grid grid-cols-3 gap-4\">\n                        <div className=\"space-y-2\">\n                          <Label>Tipo</Label>\n                          <Select \n                            value={newItem.type} \n                            onValueChange={(value) => setNewItem(prev => ({ ...prev, type: value as ChecklistItem['type'] }))}\n                          >\n                            <SelectTrigger data-testid=\"select-item-type\">\n                              <SelectValue />\n                            </SelectTrigger>\n                            <SelectContent>\n                              <SelectItem value=\"text\">Texto</SelectItem>\n                              <SelectItem value=\"number\">Número</SelectItem>\n                              <SelectItem value=\"photo\">Foto</SelectItem>\n                            </SelectContent>\n                          </Select>\n                        </div>\n                        <div className=\"space-y-2\">\n                          <Label>Rótulo</Label>\n                          <Input\n                            data-testid=\"input-item-label\"\n                            value={newItem.label}\n                            onChange={(e) => setNewItem(prev => ({ ...prev, label: e.target.value }))}\n                            placeholder=\"Ex: Limpeza concluída?\"\n                          />\n                        </div>\n                        <div className=\"space-y-2\">\n                          <Label>Observações</Label>\n                          <Input\n                            data-testid=\"input-item-description\"\n                            value={newItem.description}\n                            onChange={(e) => setNewItem(prev => ({ ...prev, description: e.target.value }))}\n                            placeholder=\"Instruções opcionais...\"\n                          />\n                        </div>\n                      </div>\n\n                      {/* Configurações avançadas baseadas no tipo */}\n                      {newItem.type && (\n                        <Card className=\"bg-slate-50\">\n                          <CardHeader className=\"pb-3\">\n                            <CardTitle className=\"text-sm\">Configurações Avançadas - {getTypeLabel(newItem.type || 'text')}</CardTitle>\n                          </CardHeader>\n                          <CardContent className=\"space-y-3\">\n                            {/* Configurações para Texto */}\n                            {newItem.type === 'text' && (\n                              <div className=\"grid grid-cols-2 gap-4\">\n                                <div className=\"space-y-1\">\n                                  <Label className=\"text-xs\">Mínimo de caracteres</Label>\n                                  <Input\n                                    type=\"number\"\n                                    placeholder=\"Ex: 10\"\n                                    value={newItem.validation?.minLength || \"\"}\n                                    onChange={(e) => setNewItem(prev => ({\n                                      ...prev,\n                                      validation: {\n                                        ...prev.validation,\n                                        minLength: e.target.value ? parseInt(e.target.value) : undefined\n                                      }\n                                    }))}\n                                    className=\"h-8 text-xs\"\n                                  />\n                                </div>\n                                <div className=\"space-y-1\">\n                                  <Label className=\"text-xs\">Máximo de caracteres</Label>\n                                  <Input\n                                    type=\"number\"\n                                    placeholder=\"Ex: 500\"\n                                    value={newItem.validation?.maxLength || \"\"}\n                                    onChange={(e) => setNewItem(prev => ({\n                                      ...prev,\n                                      validation: {\n                                        ...prev.validation,\n                                        maxLength: e.target.value ? parseInt(e.target.value) : undefined\n                                      }\n                                    }))}\n                                    className=\"h-8 text-xs\"\n                                  />\n                                </div>\n                              </div>\n                            )}\n\n                            {/* Configurações para Número */}\n                            {newItem.type === 'number' && (\n                              <div className=\"grid grid-cols-2 gap-4\">\n                                <div className=\"space-y-1\">\n                                  <Label className=\"text-xs\">Valor mínimo</Label>\n                                  <Input\n                                    type=\"number\"\n                                    placeholder=\"Ex: 0\"\n                                    value={newItem.validation?.minValue || \"\"}\n                                    onChange={(e) => setNewItem(prev => ({\n                                      ...prev,\n                                      validation: {\n                                        ...prev.validation,\n                                        minValue: e.target.value ? parseInt(e.target.value) : undefined\n                                      }\n                                    }))}\n                                    className=\"h-8 text-xs\"\n                                  />\n                                </div>\n                                <div className=\"space-y-1\">\n                                  <Label className=\"text-xs\">Valor máximo</Label>\n                                  <Input\n                                    type=\"number\"\n                                    placeholder=\"Ex: 100\"\n                                    value={newItem.validation?.maxValue || \"\"}\n                                    onChange={(e) => setNewItem(prev => ({\n                                      ...prev,\n                                      validation: {\n                                        ...prev.validation,\n                                        maxValue: e.target.value ? parseInt(e.target.value) : undefined\n                                      }\n                                    }))}\n                                    className=\"h-8 text-xs\"\n                                  />\n                                </div>\n                              </div>\n                            )}\n\n                            {/* Configurações para Foto */}\n                            {newItem.type === 'photo' && (\n                              <div className=\"space-y-3\">\n                                <div className=\"grid grid-cols-2 gap-4\">\n                                  <div className=\"space-y-1\">\n                                    <Label className=\"text-xs\">Mínimo de fotos</Label>\n                                    <Input\n                                      type=\"number\"\n                                      placeholder=\"Ex: 1\"\n                                      value={newItem.validation?.photoMinCount || \"\"}\n                                      onChange={(e) => setNewItem(prev => ({\n                                        ...prev,\n                                        validation: {\n                                          ...prev.validation,\n                                          photoMinCount: e.target.value ? parseInt(e.target.value) : undefined\n                                        }\n                                      }))}\n                                      className=\"h-8 text-xs\"\n                                    />\n                                  </div>\n                                  <div className=\"space-y-1\">\n                                    <Label className=\"text-xs\">Máximo de fotos</Label>\n                                    <Input\n                                      type=\"number\"\n                                      placeholder=\"Ex: 5\"\n                                      value={newItem.validation?.photoMaxCount || \"\"}\n                                      onChange={(e) => setNewItem(prev => ({\n                                        ...prev,\n                                        validation: {\n                                          ...prev.validation,\n                                          photoMaxCount: e.target.value ? parseInt(e.target.value) : undefined\n                                        }\n                                      }))}\n                                      className=\"h-8 text-xs\"\n                                    />\n                                  </div>\n                                </div>\n                                <div className=\"flex items-center space-x-2\">\n                                  <Switch\n                                    checked={newItem.validation?.photoRequired || false}\n                                    onCheckedChange={(checked) => setNewItem(prev => ({\n                                      ...prev,\n                                      validation: {\n                                        ...prev.validation,\n                                      photoRequired: checked\n                                      }\n                                    }))}\n                                  />\n                                  <Label className=\"text-xs\">Foto obrigatória (independente do campo obrigatório)</Label>\n                                </div>\n                              </div>\n                            )}\n                          </CardContent>\n                        </Card>\n                      )}\n\n                      <div className=\"flex items-center justify-between\">\n                        <div className=\"flex items-center space-x-2\">\n                          <Switch\n                            data-testid=\"switch-item-required\"\n                            checked={newItem.required}\n                            onCheckedChange={(checked) => setNewItem(prev => ({ ...prev, required: checked }))}\n                          />\n                          <Label>Campo obrigatório</Label>\n                        </div>\n                        <Button \n                          onClick={addItem} \n                          variant=\"outline\"\n                          data-testid=\"button-add-item\"\n                        >\n                          <Plus className=\"w-4 h-4 mr-2\" />\n                          Adicionar Item\n                        </Button>\n                      </div>\n                    </CardContent>\n                  </Card>\n\n                  {/* Lista de itens */}\n                  {checklistForm.items.length > 0 && (\n                    <Card>\n                      <CardHeader>\n                        <CardTitle className=\"text-lg\">Itens do Checklist ({checklistForm.items.length})</CardTitle>\n                      </CardHeader>\n                      <CardContent>\n                        <div className=\"space-y-3\">\n                          {checklistForm.items.map((item, index) => (\n                            <div key={item.id} className=\"flex items-center justify-between p-3 border rounded-lg bg-slate-50\">\n                              <div className=\"flex items-center space-x-3 flex-1\">\n                                <span className=\"text-sm font-medium text-slate-500\">#{index + 1}</span>\n                                <div className=\"flex items-center space-x-2\">\n                                  {getTypeIcon(item.type)}\n                                  <Badge variant=\"outline\">{getTypeLabel(item.type)}</Badge>\n                                </div>\n                                <div className=\"flex-1\">\n                                  <p className=\"font-medium\">{item.label}</p>\n                                  {item.description && (\n                                    <p className=\"text-sm text-slate-600\">{item.description}</p>\n                                  )}\n                                  {/* Mostrar configurações de validação aplicadas */}\n                                  {item.validation && Object.keys(item.validation).length > 0 && (\n                                    <div className=\"flex flex-wrap gap-1 mt-1\">\n                                      {item.validation.minLength && (\n                                        <Badge variant=\"outline\" className=\"text-xs bg-blue-50\">\n                                          Mín: {item.validation.minLength} chars\n                                        </Badge>\n                                      )}\n                                      {item.validation.maxLength && (\n                                        <Badge variant=\"outline\" className=\"text-xs bg-blue-50\">\n                                          Máx: {item.validation.maxLength} chars\n                                        </Badge>\n                                      )}\n                                      {item.validation.minValue !== undefined && (\n                                        <Badge variant=\"outline\" className=\"text-xs bg-green-50\">\n                                          Mín: {item.validation.minValue}\n                                        </Badge>\n                                      )}\n                                      {item.validation.maxValue !== undefined && (\n                                        <Badge variant=\"outline\" className=\"text-xs bg-green-50\">\n                                          Máx: {item.validation.maxValue}\n                                        </Badge>\n                                      )}\n                                      {item.validation.photoMinCount && (\n                                        <Badge variant=\"outline\" className=\"text-xs bg-purple-50\">\n                                          Mín: {item.validation.photoMinCount} fotos\n                                        </Badge>\n                                      )}\n                                      {item.validation.photoMaxCount && (\n                                        <Badge variant=\"outline\" className=\"text-xs bg-purple-50\">\n                                          Máx: {item.validation.photoMaxCount} fotos\n                                        </Badge>\n                                      )}\n                                      {item.validation.photoRequired && (\n                                        <Badge variant=\"outline\" className=\"text-xs bg-orange-50\">\n                                          Foto obrigatória\n                                        </Badge>\n                                      )}\n                                    </div>\n                                  )}\n                                </div>\n                                <div className=\"flex flex-col space-y-1\">\n                                  {item.required && (\n                                    <Badge className=\"bg-red-100 text-red-800 text-xs\">Obrigatório</Badge>\n                                  )}\n                                </div>\n                              </div>\n                              <Button\n                                variant=\"ghost\"\n                                size=\"sm\"\n                                onClick={() => removeItem(item.id)}\n                                data-testid={`button-remove-item-${index}`}\n                              >\n                                <Trash2 className=\"w-4 h-4 text-red-500\" />\n                              </Button>\n                            </div>\n                          ))}\n                        </div>\n                      </CardContent>\n                    </Card>\n                  )}\n\n                  {/* Botões de ação */}\n                  <div className=\"flex justify-end space-x-3\">\n                    <Button \n                      variant=\"outline\" \n                      onClick={() => {\n                        setIsCreateDialogOpen(false);\n                        setEditingChecklist(null);\n                        resetForm();\n                      }}\n                    >\n                      Cancelar\n                    </Button>\n                    <Button \n                      onClick={handleSubmit}\n                      disabled={createChecklistMutation.isPending || updateChecklistMutation.isPending}\n                      data-testid=\"button-save-checklist\"\n                    >\n                      {createChecklistMutation.isPending || updateChecklistMutation.isPending \n                        ? \"Salvando...\" \n                        : editingChecklist ? \"Atualizar\" : \"Criar\"\n                      }\n                    </Button>\n                  </div>\n                </div>\n              </DialogContent>\n            </Dialog>\n          </div>\n        </div>\n      </div>\n\n      {/* Content */}\n      <div className=\"p-8\">\n        {!Array.isArray(checklists) || checklists.length === 0 ? (\n          <Card className=\"bg-white/80 backdrop-blur-sm border-white/20\">\n            <CardContent className=\"p-12 text-center\">\n              <List className=\"w-16 h-16 text-slate-400 mx-auto mb-4\" />\n              <h3 className=\"text-xl font-semibold text-slate-900 mb-2\">\n                Nenhum checklist criado\n              </h3>\n              <p className=\"text-slate-600 mb-6\">\n                Crie seu primeiro checklist para começar a padronizar as ordens de serviço.\n              </p>\n              <Button \n                onClick={() => setIsCreateDialogOpen(true)}\n                className=\"bg-gradient-to-r from-green-600 to-emerald-700\"\n              >\n                <Plus className=\"w-4 h-4 mr-2\" />\n                Criar Primeiro Checklist\n              </Button>\n            </CardContent>\n          </Card>\n        ) : (\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n            {Array.isArray(checklists) && checklists.map((checklist: any) => (\n              <Card key={checklist.id} className=\"bg-white/80 backdrop-blur-sm border-white/20 shadow-lg hover:shadow-xl transition-shadow\">\n                <CardHeader>\n                  <div className=\"flex items-start justify-between\">\n                    <div className=\"flex-1\">\n                      <CardTitle className=\"text-lg\">{checklist.name}</CardTitle>\n                      <p className=\"text-sm text-slate-600 mt-1\">{checklist.description}</p>\n                    </div>\n                    <div className=\"flex space-x-1\">\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={() => handleEdit(checklist)}\n                        data-testid={`button-edit-checklist-${checklist.id}`}\n                      >\n                        <Edit3 className=\"w-4 h-4\" />\n                      </Button>\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={() => deleteChecklistMutation.mutate(checklist.id)}\n                        data-testid={`button-delete-checklist-${checklist.id}`}\n                      >\n                        <Trash2 className=\"w-4 h-4 text-red-500\" />\n                      </Button>\n                    </div>\n                  </div>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"space-y-2\">\n                    <div className=\"flex items-center justify-between text-sm\">\n                      <span className=\"text-slate-600\">Total de itens:</span>\n                      <Badge variant=\"outline\">{Array.isArray(checklist.items) ? checklist.items.length : 0}</Badge>\n                    </div>\n                    <div className=\"flex items-center justify-between text-sm\">\n                      <span className=\"text-slate-600\">Obrigatórios:</span>\n                      <Badge variant=\"outline\" className=\"bg-red-50 text-red-700\">\n                        {Array.isArray(checklist.items) ? checklist.items.filter((item: any) => item.required).length : 0}\n                      </Badge>\n                    </div>\n                    <div className=\"text-xs text-slate-500\">\n                      Criado em: {checklist.createdAt ? new Date(checklist.createdAt).toLocaleDateString('pt-BR') : 'N/A'}\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}","size_bytes":36891},"client/src/components/heatmap/TraditionalHeatmap.tsx":{"content":"import React, { useState, useMemo } from 'react';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Badge } from '@/components/ui/badge';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog';\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip';\nimport { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';\nimport { apiRequest } from '@/lib/queryClient';\nimport { useToast } from '@/hooks/use-toast';\nimport { \n  Activity, \n  MapPin, \n  TrendingUp, \n  AlertTriangle, \n  CheckCircle, \n  XCircle,\n  Eye,\n  Edit3,\n  Save,\n  X,\n  Palette,\n  Move,\n  RotateCcw,\n  ZoomIn,\n  ZoomOut,\n  Maximize,\n  Grid3x3,\n  Thermometer\n} from 'lucide-react';\n\ninterface Zone {\n  zoneId: string;\n  zoneName: string;\n  areaM2: number;\n  slaPercentage: number;\n  totalTasks: number;\n  completedTasks: number;\n  category: string;\n  positionX?: number;\n  positionY?: number;\n  sizeScale?: number;\n  id?: string;\n  name?: string;\n  description?: string;\n  siteId?: string;\n  isActive?: boolean;\n}\n\ninterface TraditionalHeatmapProps {\n  data: Zone[];\n  selectedSite?: any;\n  onZoneClick?: (zoneId: string) => void;\n}\n\nexport default function TraditionalHeatmap({ data, selectedSite, onZoneClick }: TraditionalHeatmapProps) {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  \n  // SUPER DEBUG - Verificar se componente executa\n  console.log('🔥🔥🔥 HEATMAP EXECUTANDO - Data length:', data?.length, 'Site:', selectedSite?.name);\n  \n  \n  const [hoveredZone, setHoveredZone] = useState<string | null>(null);\n  const [isEditMode, setIsEditMode] = useState<boolean>(true); // Modo de edição ativo por padrão\n  const [editingZone, setEditingZone] = useState<any>(null);\n  const [zonePositions, setZonePositions] = useState<{[key: string]: {left: number, top: number}}>({});\n  const [zoneSizes, setZoneSizes] = useState<{[key: string]: number}>({});\n  const [draggingZone, setDraggingZone] = useState<string | null>(null);\n  const [dragOffset, setDragOffset] = useState<{x: number, y: number}>({x: 0, y: 0});\n  const [isDragging, setIsDragging] = useState<boolean>(false);\n  const [dragStartTime, setDragStartTime] = useState<number>(0);\n  const [dragStartPos, setDragStartPos] = useState<{x: number, y: number}>({x: 0, y: 0});\n  const [mapScale, setMapScale] = useState<number>(1);\n  const [mapOffset, setMapOffset] = useState<{x: number, y: number}>({x: 0, y: 0});\n  const [isPanning, setIsPanning] = useState<boolean>(false);\n  const [panStartPos, setPanStartPos] = useState<{x: number, y: number}>({x: 0, y: 0});\n  const [showGrid, setShowGrid] = useState<boolean>(true);\n  const [snapToGrid, setSnapToGrid] = useState<boolean>(true);\n\n  // Mutation to update zone\n  const updateZoneMutation = useMutation({\n    mutationFn: async (zoneData: any) => {\n      const { id, ...updateData } = zoneData;\n      const response = await apiRequest('PATCH', `/api/zones/${id}`, updateData);\n      return response.json();\n    },\n    onSuccess: () => {\n      if (selectedSite?.id) {\n        queryClient.invalidateQueries({ queryKey: [\"/api/sites\", selectedSite.id, \"zones\"] });\n      }\n      toast({\n        title: \"Zona atualizada\",\n        description: \"As alterações foram salvas com sucesso.\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Não foi possível salvar as alterações.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Initialize positions and sizes when zones change\n  React.useEffect(() => {\n    if (data) {\n      // Load positions from database or set defaults\n      const loadedPositions: {[key: string]: {left: number, top: number}} = {};\n      const loadedSizes: {[key: string]: number} = {};\n      \n      data.forEach((zone, index) => {\n        const zoneId = zone.zoneId || zone.id || `zone-${index}`;\n        \n        // Use database positions if available, otherwise use defaults\n        if (zone.positionX != null && zone.positionY != null) {\n          loadedPositions[zoneId] = {\n            left: parseFloat(zone.positionX.toString()),\n            top: parseFloat(zone.positionY.toString())\n          };\n        } else {\n          // Default positions for zones without saved positions\n          const defaultPositions = [\n            { left: 20, top: 30 },\n            { left: 70, top: 20 },\n            { left: 50, top: 70 },\n            { left: 15, top: 75 },\n            { left: 80, top: 75 }\n          ];\n          const position = defaultPositions[index] || defaultPositions[0];\n          loadedPositions[zoneId] = position;\n        }\n        \n        // Load size scale from database or use default\n        if (zone.sizeScale) {\n          loadedSizes[zoneId] = parseFloat(zone.sizeScale.toString());\n        }\n      });\n      \n      setZonePositions(loadedPositions);\n      setZoneSizes(loadedSizes);\n    }\n  }, [data]);\n\n  // Função para obter cor gradiente baseada no SLA (mapa de calor real)\n  const getSLAColor = (sla: number) => {\n    if (sla >= 95) return {\n      bg: 'from-blue-400 to-blue-600',\n      shadow: 'shadow-blue-500/30',\n      glow: 'shadow-blue-400/60'\n    };\n    if (sla >= 85) return {\n      bg: 'from-green-400 to-green-600',\n      shadow: 'shadow-green-500/30', \n      glow: 'shadow-green-400/60'\n    };\n    if (sla >= 70) return {\n      bg: 'from-yellow-400 to-orange-500',\n      shadow: 'shadow-yellow-500/30',\n      glow: 'shadow-yellow-400/60'\n    };\n    if (sla >= 50) return {\n      bg: 'from-orange-500 to-red-600',\n      shadow: 'shadow-orange-500/30',\n      glow: 'shadow-orange-400/60'\n    };\n    return {\n      bg: 'from-red-600 to-red-800',\n      shadow: 'shadow-red-500/30',\n      glow: 'shadow-red-400/60'\n    };\n  };\n\n  // Função para obter ícone baseado no SLA\n  const getSLAIcon = (sla: number) => {\n    if (sla >= 95) return CheckCircle;\n    if (sla >= 85) return TrendingUp;\n    if (sla >= 70) return Activity;\n    if (sla >= 50) return AlertTriangle;\n    return XCircle;\n  };\n\n  // Função para obter label do SLA\n  const getSLALabel = (sla: number) => {\n    if (sla >= 95) return 'Excelente';\n    if (sla >= 85) return 'Bom';\n    if (sla >= 70) return 'Atenção';\n    if (sla >= 50) return 'Ruim';\n    return 'Crítico';\n  };\n\n  // Calcular estatísticas\n  const stats = useMemo(() => {\n    const totalZones = data.length;\n    const excellentZones = data.filter(z => (z.slaPercentage || 0) >= 95).length;\n    const goodZones = data.filter(z => (z.slaPercentage || 0) >= 85 && (z.slaPercentage || 0) < 95).length;\n    const warningZones = data.filter(z => (z.slaPercentage || 0) >= 70 && (z.slaPercentage || 0) < 85).length;\n    const criticalZones = data.filter(z => (z.slaPercentage || 0) < 50).length;\n    const avgSLA = totalZones > 0 ? Math.round(data.reduce((sum, z) => sum + (z.slaPercentage || 0), 0) / totalZones) : 0;\n\n    return {\n      totalZones,\n      excellentZones,\n      goodZones,\n      warningZones,\n      criticalZones,\n      avgSLA\n    };\n  }, [data]);\n\n  // Helper functions\n  const snapPosition = (pos: {left: number, top: number}) => {\n    if (!snapToGrid) return pos;\n    const gridSize = 5; // 5% grid\n    return {\n      left: Math.round(pos.left / gridSize) * gridSize,\n      top: Math.round(pos.top / gridSize) * gridSize\n    };\n  };\n\n  const handleZoomIn = () => {\n    setMapScale(prev => Math.min(prev * 1.25, 3));\n  };\n\n  const handleZoomOut = () => {\n    setMapScale(prev => Math.max(prev / 1.25, 0.3));\n  };\n\n  const resetView = () => {\n    setMapScale(1);\n    setMapOffset({x: 0, y: 0});\n  };\n\n  // Functions for edit mode\n  const handleZoneClick = (zone: any, e: React.MouseEvent) => {\n    if (isEditMode && !isDragging) {\n      e.stopPropagation();\n      const timeSinceStart = Date.now() - dragStartTime;\n      const moveDistance = Math.sqrt(\n        Math.pow(e.clientX - dragStartPos.x, 2) + Math.pow(e.clientY - dragStartPos.y, 2)\n      );\n      // Só abre o modal se foi um clique real (pouco movimento e tempo)\n      if (timeSinceStart < 300 && moveDistance < 10) {\n        setEditingZone(zone);\n      }\n    } else {\n      // Modo visualização - chama callback original\n      onZoneClick?.(zone.zoneId || zone.id);\n    }\n  };\n\n  const handleSaveZone = async () => {\n    if (!editingZone) return;\n    \n    try {\n      const updatedZone = {\n        id: editingZone.zoneId || editingZone.id,\n        name: editingZone.zoneName || editingZone.name,\n        description: editingZone.description,\n        areaM2: editingZone.areaM2?.toString(),\n        category: editingZone.category,\n        siteId: editingZone.siteId || selectedSite?.id,\n        isActive: editingZone.isActive !== false\n      };\n      \n      await updateZoneMutation.mutateAsync(updatedZone);\n      setEditingZone(null);\n    } catch (error) {\n      console.error('Erro ao salvar zona:', error);\n      toast({\n        title: \"Erro\",\n        description: \"Não foi possível salvar as alterações. Tente novamente.\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const handleMouseDown = (e: React.MouseEvent, zoneId: string) => {\n    if (!isEditMode) return;\n    e.preventDefault();\n    e.stopPropagation();\n    \n    setDragStartTime(Date.now());\n    setDragStartPos({ x: e.clientX, y: e.clientY });\n    setIsDragging(false);\n    setDraggingZone(zoneId);\n    \n    // Feedback visual correto usando currentTarget\n    const zoneElement = e.currentTarget as HTMLElement;\n    zoneElement.style.zIndex = '1000';\n    zoneElement.style.transform = 'scale(1.02)';\n    zoneElement.style.transition = 'none';\n    zoneElement.style.cursor = 'grabbing';\n  };\n\n  const handleMouseMove = (e: React.MouseEvent) => {\n    if (isPanning) {\n      const deltaX = e.clientX - panStartPos.x;\n      const deltaY = e.clientY - panStartPos.y;\n      setMapOffset(prev => ({\n        x: prev.x + deltaX,\n        y: prev.y + deltaY\n      }));\n      setPanStartPos({ x: e.clientX, y: e.clientY });\n      return;\n    }\n    \n    if (!draggingZone || !isEditMode) return;\n    \n    // Ultra-responsive drag detection\n    setIsDragging(true);\n    e.preventDefault();\n    \n    // Sistema de coordenadas correto: pixels -> transform -> percentual\n    const innerContainer = document.querySelector('.zone-map-container .absolute.inset-4');\n    if (!innerContainer) return;\n    \n    const rect = innerContainer.getBoundingClientRect();\n    // Calcular em pixels primeiro\n    const localX = e.clientX - rect.left;\n    const localY = e.clientY - rect.top;\n    \n    // Aplicar apenas escala (offset já considerado pelo getBoundingClientRect)\n    const logicalX = localX / mapScale;\n    const logicalY = localY / mapScale;\n    \n    // Usar dimensões base (não transformadas) para percentual\n    const baseWidth = rect.width / mapScale;\n    const baseHeight = rect.height / mapScale;\n    const left = (logicalX / baseWidth) * 100;\n    const top = (logicalY / baseHeight) * 100;\n    \n    let newPosition = { \n      left: Math.max(5, Math.min(95, left)), \n      top: Math.max(5, Math.min(95, top)) \n    };\n    \n    // Apply snap to grid\n    if (snapToGrid) {\n      newPosition = snapPosition(newPosition);\n    }\n    \n    setZonePositions(prev => ({\n      ...prev,\n      [draggingZone]: newPosition\n    }));\n  };\n\n  // Função centralizada para finalizar drag e salvar\n  const finalizeDrag = () => {\n    if (draggingZone && isDragging) {\n      const zone = data.find(z => (z.zoneId || z.id) === draggingZone);\n      const position = zonePositions[draggingZone];\n      const currentSize = zoneSizes[draggingZone];\n      \n      if (zone && position) {\n        updateZoneMutation.mutate({\n          id: zone.zoneId || zone.id,\n          name: zone.zoneName || zone.name,\n          description: zone.description,\n          areaM2: zone.areaM2?.toString(),\n          category: zone.category,\n          siteId: zone.siteId || selectedSite?.id,\n          isActive: zone.isActive !== false,\n          positionX: position.left.toFixed(2),\n          positionY: position.top.toFixed(2),\n          sizeScale: currentSize ? (currentSize / 100).toFixed(2) : \"1.00\",\n        });\n      }\n    }\n  };\n  \n  const handleMouseUp = () => {\n    if (isPanning) {\n      setIsPanning(false);\n      return;\n    }\n    \n    // Não salvar aqui - deixar para o global handler para evitar duplicação\n    // finalizeDrag(); // Removido para evitar dupla gravação\n    \n    // Remove visual feedback immediately\n    if (draggingZone) {\n      const zoneElement = document.querySelector(`[data-zone-id=\"${draggingZone}\"]`) as HTMLElement;\n      if (zoneElement) {\n        zoneElement.style.zIndex = '';\n        zoneElement.style.transform = '';\n        zoneElement.style.cursor = '';\n        zoneElement.style.transition = 'all 0.15s ease';\n      }\n    }\n    \n    // Reset immediately for better responsiveness\n    setDraggingZone(null);\n    setDragOffset({ x: 0, y: 0 });\n    setIsDragging(false);\n  };\n\n  // Pan functionality\n  const handleMapMouseDown = (e: React.MouseEvent) => {\n    if (e.button === 1 || (e.button === 0 && e.ctrlKey)) { // Middle click or Ctrl+click\n      e.preventDefault();\n      setIsPanning(true);\n      setPanStartPos({ x: e.clientX, y: e.clientY });\n    }\n  };\n\n  // Add global mouse and wheel events\n  React.useEffect(() => {\n    const handleGlobalMouseUp = () => {\n      if (draggingZone) {\n        // Salvar antes de limpar estado\n        finalizeDrag();\n        \n        const zoneElement = document.querySelector(`[data-zone-id=\"${draggingZone}\"]`) as HTMLElement;\n        if (zoneElement) {\n          zoneElement.style.zIndex = '';\n          zoneElement.style.transform = '';\n          zoneElement.style.cursor = '';\n          zoneElement.style.transition = 'all 0.15s ease';\n        }\n      }\n      \n      setDraggingZone(null);\n      setDragOffset({ x: 0, y: 0 });\n      setIsDragging(false);\n      setIsPanning(false);\n    };\n    \n    const handleGlobalMouseMove = (e: MouseEvent) => {\n      if (isPanning) {\n        const deltaX = e.clientX - panStartPos.x;\n        const deltaY = e.clientY - panStartPos.y;\n        setMapOffset(prev => ({\n          x: prev.x + deltaX,\n          y: prev.y + deltaY\n        }));\n        setPanStartPos({ x: e.clientX, y: e.clientY });\n        return;\n      }\n      \n      // Handle zone dragging globally\n      if (!draggingZone || !isEditMode) return;\n      \n      setIsDragging(true);\n      e.preventDefault();\n      \n      // Sistema de coordenadas correto: pixels -> transform -> percentual\n      const innerContainer = document.querySelector('.zone-map-container .absolute.inset-4');\n      if (!innerContainer) return;\n      \n      const rect = innerContainer.getBoundingClientRect();\n      // Calcular em pixels primeiro\n      const localX = e.clientX - rect.left;\n      const localY = e.clientY - rect.top;\n      \n      // Aplicar apenas escala (offset já considerado pelo getBoundingClientRect)\n      const logicalX = localX / mapScale;\n      const logicalY = localY / mapScale;\n      \n      // Usar dimensões base (não transformadas) para percentual\n      const baseWidth = rect.width / mapScale;\n      const baseHeight = rect.height / mapScale;\n      const left = (logicalX / baseWidth) * 100;\n      const top = (logicalY / baseHeight) * 100;\n      \n      let newPosition = { \n        left: Math.max(5, Math.min(95, left)), \n        top: Math.max(5, Math.min(95, top)) \n      };\n      \n      // Apply snap to grid\n      if (snapToGrid) {\n        newPosition = snapPosition(newPosition);\n      }\n      \n      setZonePositions(prev => ({\n        ...prev,\n        [draggingZone]: newPosition\n      }));\n    };\n\n    const handleWheel = (e: WheelEvent) => {\n      if (isEditMode && e.ctrlKey) {\n        e.preventDefault();\n        const delta = e.deltaY > 0 ? -1 : 1;\n        if (delta > 0) {\n          handleZoomIn();\n        } else {\n          handleZoomOut();\n        }\n      }\n    };\n    \n    if (draggingZone || isPanning) {\n      document.addEventListener('mouseup', handleGlobalMouseUp);\n      document.addEventListener('mousemove', handleGlobalMouseMove);\n    }\n\n    if (isEditMode) {\n      document.addEventListener('wheel', handleWheel, { passive: false });\n    }\n    \n    return () => {\n      document.removeEventListener('mouseup', handleGlobalMouseUp);\n      document.removeEventListener('mousemove', handleGlobalMouseMove);\n      document.removeEventListener('wheel', handleWheel);\n    };\n  }, [draggingZone, isPanning, panStartPos, isEditMode, mapScale, mapOffset]);\n\n  const resetPositions = () => {\n    const positions = [\n      { left: 20, top: 30 },\n      { left: 70, top: 20 },\n      { left: 50, top: 70 },\n      { left: 15, top: 75 },\n      { left: 80, top: 75 }\n    ];\n    \n    const resetPositions: {[key: string]: {left: number, top: number}} = {};\n    data.forEach((zone, index) => {\n      const zoneId = zone.zoneId || zone.id || `zone-${index}`;\n      const position = positions[index] || positions[0];\n      resetPositions[zoneId] = snapToGrid ? snapPosition(position) : position;\n    });\n    setZonePositions(resetPositions);\n  };\n\n  // Keyboard shortcuts\n  React.useEffect(() => {\n    const handleKeyDown = (e: KeyboardEvent) => {\n      if (e.key === 'Escape') {\n        setEditingZone(null);\n        setDraggingZone(null);\n        setIsDragging(false);\n      } else if (e.key === 'g' && e.ctrlKey) {\n        e.preventDefault();\n        setShowGrid(!showGrid);\n      } else if (e.key === 's' && e.ctrlKey) {\n        e.preventDefault();\n        setSnapToGrid(!snapToGrid);\n      } else if (e.key === '=' && e.ctrlKey) {\n        e.preventDefault();\n        handleZoomIn();\n      } else if (e.key === '-' && e.ctrlKey) {\n        e.preventDefault();\n        handleZoomOut();\n      } else if (e.key === '0' && e.ctrlKey) {\n        e.preventDefault();\n        resetView();\n      }\n    };\n    \n    if (isEditMode) {\n      document.addEventListener('keydown', handleKeyDown);\n      return () => document.removeEventListener('keydown', handleKeyDown);\n    }\n  }, [isEditMode, showGrid, snapToGrid]);\n\n  return (\n    <TooltipProvider>\n      <Card className=\"w-full\">\n        <CardHeader>\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"p-2 bg-gradient-to-r from-red-500 to-blue-500 rounded-lg\">\n                <Thermometer className=\"w-5 h-5 text-white\" />\n              </div>\n              <div>\n                <CardTitle className=\"text-lg font-semibold text-foreground\">\n                  Mapa de Calor - {selectedSite?.name || 'Visualização SLA'}\n                </CardTitle>\n                <p className=\"text-sm text-muted-foreground mt-1\">\n                  SLA médio: {stats.avgSLA}% • {stats.totalZones} zonas monitoradas\n                </p>\n              </div>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <Button \n                variant={isEditMode ? \"destructive\" : \"outline\"} \n                size=\"sm\" \n                onClick={() => setIsEditMode(!isEditMode)}\n                data-testid=\"button-edit-mode\"\n              >\n                {isEditMode ? (\n                  <>\n                    <X className=\"w-4 h-4 mr-1\" />\n                    Sair da Edição\n                  </>\n                ) : (\n                  <>\n                    <Edit3 className=\"w-4 h-4 mr-1\" />\n                    Editar Mapa\n                  </>\n                )}\n              </Button>\n              {isEditMode && (\n                <Button \n                  variant=\"outline\" \n                  size=\"sm\" \n                  onClick={resetPositions}\n                  data-testid=\"button-reset-positions\"\n                >\n                  <RotateCcw className=\"w-4 h-4 mr-1\" />\n                  Resetar\n                </Button>\n              )}\n            </div>\n          </div>\n\n          {/* Estatísticas rápidas */}\n          <div className=\"grid grid-cols-2 md:grid-cols-5 gap-3 mt-4\">\n            <div className=\"bg-gradient-to-r from-blue-50 to-blue-100 p-3 rounded-lg\">\n              <div className=\"flex items-center gap-2\">\n                <CheckCircle className=\"w-4 h-4 text-blue-600\" />\n                <span className=\"text-sm font-medium text-blue-900\">Excelentes</span>\n              </div>\n              <div className=\"text-2xl font-bold text-blue-600 mt-1\">{stats.excellentZones}</div>\n            </div>\n\n            <div className=\"bg-gradient-to-r from-green-50 to-green-100 p-3 rounded-lg\">\n              <div className=\"flex items-center gap-2\">\n                <TrendingUp className=\"w-4 h-4 text-green-600\" />\n                <span className=\"text-sm font-medium text-green-900\">Boas</span>\n              </div>\n              <div className=\"text-2xl font-bold text-green-600 mt-1\">{stats.goodZones}</div>\n            </div>\n\n            <div className=\"bg-gradient-to-r from-amber-50 to-amber-100 p-3 rounded-lg\">\n              <div className=\"flex items-center gap-2\">\n                <AlertTriangle className=\"w-4 h-4 text-amber-600\" />\n                <span className=\"text-sm font-medium text-amber-900\">Atenção</span>\n              </div>\n              <div className=\"text-2xl font-bold text-amber-600 mt-1\">{stats.warningZones}</div>\n            </div>\n\n            <div className=\"bg-gradient-to-r from-red-50 to-red-100 p-3 rounded-lg\">\n              <div className=\"flex items-center gap-2\">\n                <XCircle className=\"w-4 h-4 text-red-600\" />\n                <span className=\"text-sm font-medium text-red-900\">Críticas</span>\n              </div>\n              <div className=\"text-2xl font-bold text-red-600 mt-1\">{stats.criticalZones}</div>\n            </div>\n\n            <div className=\"bg-gradient-to-r from-slate-50 to-slate-100 p-3 rounded-lg\">\n              <div className=\"flex items-center gap-2\">\n                <MapPin className=\"w-4 h-4 text-slate-600\" />\n                <span className=\"text-sm font-medium text-slate-900\">Total</span>\n              </div>\n              <div className=\"text-2xl font-bold text-slate-600 mt-1\">{stats.totalZones}</div>\n            </div>\n          </div>\n        </CardHeader>\n\n        <CardContent>\n          {/* Legenda Mapa de Calor Moderno */}\n          <div className=\"flex flex-wrap gap-3 mb-6\">\n            <Badge variant=\"secondary\" className=\"bg-red-100 text-red-800 border-red-200\">\n              <div className=\"w-4 h-4 bg-gradient-to-r from-red-600 to-red-800 rounded-sm mr-2 shadow-sm\"></div>\n              Crítico (&lt; 50%)\n            </Badge>\n            <Badge variant=\"secondary\" className=\"bg-orange-100 text-orange-800 border-orange-200\">\n              <div className=\"w-4 h-4 bg-gradient-to-r from-orange-500 to-red-600 rounded-sm mr-2 shadow-sm\"></div>\n              Ruim (50-69%)\n            </Badge>\n            <Badge variant=\"secondary\" className=\"bg-amber-100 text-amber-800 border-amber-200\">\n              <div className=\"w-4 h-4 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-sm mr-2 shadow-sm\"></div>\n              Atenção (70-84%)\n            </Badge>\n            <Badge variant=\"secondary\" className=\"bg-green-100 text-green-800 border-green-200\">\n              <div className=\"w-4 h-4 bg-gradient-to-r from-green-400 to-green-600 rounded-sm mr-2 shadow-sm\"></div>\n              Bom (85-94%)\n            </Badge>\n            <Badge variant=\"secondary\" className=\"bg-blue-100 text-blue-800 border-blue-200\">\n              <div className=\"w-4 h-4 bg-gradient-to-r from-blue-400 to-blue-600 rounded-sm mr-2 shadow-sm\"></div>\n              Excelente (≥95%)\n            </Badge>\n          </div>\n\n          {!data || data.length === 0 ? (\n            <div className=\"text-center py-8\">\n              <Thermometer className=\"w-12 h-12 text-muted-foreground mx-auto mb-4\" />\n              <p className=\"text-muted-foreground\">Nenhuma zona disponível</p>\n              <p className=\"text-sm text-muted-foreground mt-2\">\n                Selecione um local para visualizar o mapa de calor\n              </p>\n            </div>\n          ) : (\n            <div>\n              {/* Edit mode controls */}\n              {isEditMode && (\n                <div className=\"mb-4 space-y-4\">\n                  <div className=\"p-4 bg-amber-50 border border-amber-200 rounded-lg\">\n                    <div className=\"flex items-center gap-2 mb-2\">\n                      <Palette className=\"w-4 h-4 text-amber-600\" />\n                      <span className=\"text-sm font-medium text-amber-800\">\n                        Modo de Edição Ativo {isDragging && \"- Arrastando...\"} {isPanning && \"- Movendo Visualização...\"}\n                      </span>\n                    </div>\n                    <p className=\"text-xs text-amber-700\">\n                      • <strong>Clique rápido</strong> na zona para editar<br/>\n                      • <strong>Arraste</strong> para reposicionar<br/>\n                      • <strong>Ctrl+Clique</strong> para mover visualização<br/>\n                      • <strong>Atalhos:</strong> Ctrl+G (grade), Ctrl+S (ajustar), Ctrl +/- (zoom), ESC (cancelar)\n                    </p>\n                  </div>\n                  \n                  {/* Advanced Controls */}\n                  <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                    {/* Zoom Controls */}\n                    <div className=\"flex items-center justify-between p-3 bg-background border rounded-lg\">\n                      <div className=\"flex items-center gap-2\">\n                        <ZoomIn className=\"w-4 h-4 text-muted-foreground\" />\n                        <span className=\"text-sm font-medium\">Zoom</span>\n                      </div>\n                      <div className=\"flex items-center gap-1\">\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={handleZoomOut}\n                          className=\"h-8 w-8 p-0\"\n                        >\n                          <ZoomOut className=\"w-3 h-3\" />\n                        </Button>\n                        <span className=\"text-sm text-muted-foreground min-w-[3rem] text-center\">\n                          {Math.round(mapScale * 100)}%\n                        </span>\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={handleZoomIn}\n                          className=\"h-8 w-8 p-0\"\n                        >\n                          <ZoomIn className=\"w-3 h-3\" />\n                        </Button>\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={resetView}\n                          className=\"h-8 w-8 p-0\"\n                        >\n                          <Maximize className=\"w-3 h-3\" />\n                        </Button>\n                      </div>\n                    </div>\n\n                    {/* Grid Controls */}\n                    <div className=\"flex items-center justify-between p-3 bg-background border rounded-lg\">\n                      <div className=\"flex items-center gap-2\">\n                        <Grid3x3 className=\"w-4 h-4 text-muted-foreground\" />\n                        <span className=\"text-sm font-medium\">Grade</span>\n                      </div>\n                      <div className=\"flex items-center gap-2\">\n                        <Button\n                          variant={showGrid ? \"default\" : \"outline\"}\n                          size=\"sm\"\n                          onClick={() => setShowGrid(!showGrid)}\n                          className=\"h-8 text-xs\"\n                        >\n                          {showGrid ? \"Ocultar\" : \"Mostrar\"}\n                        </Button>\n                        <Button\n                          variant={snapToGrid ? \"default\" : \"outline\"}\n                          size=\"sm\"\n                          onClick={() => setSnapToGrid(!snapToGrid)}\n                          className=\"h-8 text-xs\"\n                        >\n                          Ajustar\n                        </Button>\n                      </div>\n                    </div>\n\n                    {/* Reset Controls */}\n                    <div className=\"flex items-center justify-between p-3 bg-background border rounded-lg\">\n                      <div className=\"flex items-center gap-2\">\n                        <RotateCcw className=\"w-4 h-4 text-muted-foreground\" />\n                        <span className=\"text-sm font-medium\">Resetar</span>\n                      </div>\n                      <div className=\"flex items-center gap-2\">\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={resetPositions}\n                          className=\"h-8 text-xs\"\n                        >\n                          Posições\n                        </Button>\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={resetView}\n                          className=\"h-8 text-xs\"\n                        >\n                          Visualização\n                        </Button>\n                      </div>\n                    </div>\n                  </div>\n                </div>\n              )}\n\n              {/* Mapa de Calor Editável */}\n              <div \n                className={`bg-muted/50 rounded-lg p-4 relative min-h-96 mb-6 zone-map-container overflow-hidden ${isEditMode ? 'border-2 border-dashed border-amber-300' : ''}`} \n                data-testid=\"zone-map\"\n                onMouseMove={handleMouseMove}\n                onMouseUp={handleMouseUp}\n                onMouseDown={handleMapMouseDown}\n                onContextMenu={(e) => e.preventDefault()}\n                style={{\n                  cursor: isPanning ? 'grabbing' : isEditMode ? 'grab' : 'default',\n                  userSelect: 'none',\n                  height: '500px' // Forçar altura mínima para debug\n                }}\n              >\n                <div \n                  className=\"absolute inset-4 bg-background border-2 border-border rounded select-none\"\n                  style={{\n                    transform: `scale(${mapScale}) translate(${mapOffset.x}px, ${mapOffset.y}px)`,\n                    transformOrigin: 'center center',\n                    transition: isDragging || isPanning ? 'none' : 'transform 0.2s ease-out',\n                    minHeight: '400px', // Altura mínima para o container das zonas\n                    position: 'relative' // CRITICAL: Container deve ser relative para absolute children\n                  }}\n                >\n                  {/* Grid overlay - deve ficar atrás das zonas */}\n                  {showGrid && isEditMode && (\n                    <div className=\"absolute inset-0 pointer-events-none\" style={{\n                      backgroundImage: 'linear-gradient(rgba(0,0,0,0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(0,0,0,0.1) 1px, transparent 1px)',\n                      backgroundSize: '5% 5%',\n                      zIndex: 1 // Grid atrás das zonas\n                    }} />\n                  )}\n\n                  \n                  {/* ZONA FIXA PARA TESTE */}\n                  <div\n                    className=\"absolute bg-red-500 border-4 border-yellow-400 rounded-lg flex items-center justify-center text-white font-bold text-xl\"\n                    style={{\n                      left: '30%',\n                      top: '30%',\n                      width: '150px',\n                      height: '150px',\n                      zIndex: 9999\n                    }}\n                  >\n                    ZONA TESTE\n                  </div>\n                  \n                  {/* Zonas dos dados reais - SIMPLIFICADO */}\n                  {data && data.length > 0 && data.slice(0, 3).map((zone: any, index: number) => (\n                    <div\n                      key={zone.zoneId || `zone-${index}`}\n                      className=\"absolute bg-blue-500 border-2 border-white rounded-lg flex items-center justify-center text-white font-bold\"\n                      style={{\n                        left: `${20 + (index * 25)}%`,\n                        top: `${50}%`,\n                        width: '120px',\n                        height: '80px',\n                        zIndex: 100\n                      }}\n                      onClick={() => console.log('Zona clicada:', zone.zoneId)}\n                    >\n                      <div className=\"text-center\">\n                        <div className=\"text-xs\">{zone.zoneName}</div>\n                        <div className=\"text-lg\">{zone.slaPercentage}%</div>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              </div>\n            </div>\n          )}\n\n          {/* Instruções */}\n          <div className=\"mt-4 p-3 bg-blue-50 rounded-lg\">\n            <p className=\"text-sm text-blue-800\">\n              <strong>💡 Dica:</strong> {isEditMode ? \n                'Use os controles de edição para personalizar o layout. Arraste as zonas para reposicionar!' :\n                'Ative o modo de edição para personalizar posições e tamanhos das zonas no mapa.'\n              }\n            </p>\n          </div>\n        </CardContent>\n\n        {/* Edit Zone Modal */}\n        {editingZone && (\n          <Dialog open={!!editingZone} onOpenChange={() => setEditingZone(null)}>\n            <DialogContent className=\"sm:max-w-md\">\n              <DialogHeader>\n                <DialogTitle>Editar Zona</DialogTitle>\n              </DialogHeader>\n              <div className=\"space-y-4\">\n                <div>\n                  <Label htmlFor=\"name\">Nome</Label>\n                  <Input\n                    id=\"name\"\n                    value={editingZone.zoneName || editingZone.name || ''}\n                    onChange={(e) => setEditingZone((prev: any) => ({ ...prev, zoneName: e.target.value, name: e.target.value }))}\n                  />\n                </div>\n                <div>\n                  <Label htmlFor=\"description\">Descrição</Label>\n                  <Input\n                    id=\"description\"\n                    value={editingZone.description || ''}\n                    onChange={(e) => setEditingZone((prev: any) => ({ ...prev, description: e.target.value }))}\n                  />\n                </div>\n                <div>\n                  <Label htmlFor=\"area\">Área (m²)</Label>\n                  <Input\n                    id=\"area\"\n                    type=\"number\"\n                    value={editingZone.areaM2 || ''}\n                    onChange={(e) => setEditingZone((prev: any) => ({ ...prev, areaM2: parseFloat(e.target.value) || 0 }))}\n                  />\n                </div>\n                <div>\n                  <Label htmlFor=\"category\">Categoria</Label>\n                  <Input\n                    id=\"category\"\n                    value={editingZone.category || ''}\n                    onChange={(e) => setEditingZone((prev: any) => ({ ...prev, category: e.target.value }))}\n                  />\n                </div>\n                <div className=\"flex justify-end gap-2\">\n                  <Button variant=\"outline\" onClick={() => setEditingZone(null)}>\n                    Cancelar\n                  </Button>\n                  <Button onClick={handleSaveZone} disabled={updateZoneMutation.isPending}>\n                    {updateZoneMutation.isPending ? \"Salvando...\" : \"Salvar\"}\n                  </Button>\n                </div>\n              </div>\n            </DialogContent>\n          </Dialog>\n        )}\n      </Card>\n    </TooltipProvider>\n  );\n}","size_bytes":36008},"launcher.js":{"content":"import 'dotenv/config'\nconst { default: app } = await import('./dist/index.js')  // importa a app\nconst PORT = process.env.PORT || 3007\napp.listen(PORT, () => console.log('API up on :' + PORT))\n","size_bytes":194},"client/src/pages/qr-public.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useState } from \"react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useParams } from \"wouter\";\nimport { \n  MessageCircle, \n  Camera, \n  CheckCircle, \n  AlertTriangle, \n  MapPin,\n  Send,\n  Shield,\n  Clock\n} from \"lucide-react\";\n\nexport default function QrPublic() {\n  const { code } = useParams<{ code: string }>();\n  const [description, setDescription] = useState(\"\");\n  const [photo, setPhoto] = useState<File | null>(null);\n  const [isSubmitting, setIsSubmitting] = useState(false);\n  const [isSubmitted, setIsSubmitted] = useState(false);\n  const [workOrderNumber, setWorkOrderNumber] = useState<number | null>(null);\n  const { toast } = useToast();\n\n  const createServiceRequestMutation = useMutation({\n    mutationFn: async (data: any) => {\n      return await apiRequest(\"POST\", `/api/qr-public/${code}/service-request`, data);\n    },\n    onSuccess: (response) => {\n      setIsSubmitted(true);\n      setWorkOrderNumber(response.workOrderNumber);\n      toast({ title: \"Solicitação enviada com sucesso!\" });\n    },\n    onError: (error: any) => {\n      toast({ \n        title: \"Erro ao enviar solicitação\", \n        description: error.message || \"Tente novamente em alguns instantes\",\n        variant: \"destructive\" \n      });\n    },\n  });\n\n  const handlePhotoUpload = (event: React.ChangeEvent<HTMLInputElement>) => {\n    const file = event.target.files?.[0];\n    if (file) {\n      setPhoto(file);\n    }\n  };\n\n  const handleSubmit = () => {\n    if (!description.trim()) {\n      toast({ \n        title: \"Descrição obrigatória\", \n        description: \"Por favor, descreva o problema ou necessidade\",\n        variant: \"destructive\" \n      });\n      return;\n    }\n\n    setIsSubmitting(true);\n    \n    // In a real implementation, you would upload the photo first\n    const photoUrl = photo ? URL.createObjectURL(photo) : undefined;\n    \n    createServiceRequestMutation.mutate({\n      description: description.trim(),\n      photo: photoUrl\n    });\n  };\n\n  if (isSubmitted) {\n    return (\n      <div className=\"min-h-screen bg-background p-4\">\n        <div className=\"max-w-md mx-auto pt-16\">\n          <Card className=\"border-chart-2/20 bg-chart-2/5\">\n            <CardContent className=\"pt-6 text-center\">\n              <CheckCircle className=\"w-16 h-16 text-chart-2 mx-auto mb-4\" />\n              <h1 className=\"text-2xl font-bold text-foreground mb-2\">\n                Solicitação Enviada!\n              </h1>\n              <p className=\"text-muted-foreground mb-4\">\n                Sua solicitação foi recebida e será atendida em breve.\n              </p>\n              \n              {workOrderNumber && (\n                <div className=\"bg-background rounded-lg p-4 mb-4\">\n                  <p className=\"text-sm text-muted-foreground\">Número do protocolo:</p>\n                  <p className=\"text-xl font-bold text-foreground\">#{workOrderNumber}</p>\n                </div>\n              )}\n              \n              <div className=\"text-xs text-muted-foreground space-y-1\">\n                <p>✓ Equipe será notificada automaticamente</p>\n                <p>✓ Atendimento em até 2 horas</p>\n                <p>✓ Acompanhe pelo WhatsApp se disponível</p>\n              </div>\n            </CardContent>\n          </Card>\n          \n          <div className=\"mt-6 text-center\">\n            <p className=\"text-xs text-muted-foreground\">\n              Powered by <span className=\"font-semibold\">OPUS CLEAN</span>\n            </p>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      {/* Header */}\n      <div className=\"bg-primary text-primary-foreground p-6\">\n        <div className=\"max-w-md mx-auto text-center\">\n          <div className=\"w-12 h-12 bg-primary-foreground/20 rounded-full flex items-center justify-center mx-auto mb-3\">\n            <MessageCircle className=\"w-6 h-6\" />\n          </div>\n          <h1 className=\"text-xl font-bold mb-1\">Solicitar Atendimento</h1>\n          <p className=\"text-sm opacity-90\">\n            Reporte problemas ou solicite limpeza\n          </p>\n        </div>\n      </div>\n\n      <div className=\"max-w-md mx-auto p-4 -mt-4\">\n        {/* Location Card */}\n        <Card className=\"mb-6 border-primary/20\">\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-start space-x-3\">\n              <MapPin className=\"w-5 h-5 text-primary mt-1\" />\n              <div className=\"flex-1\">\n                <h2 className=\"font-semibold text-foreground\">Local Identificado</h2>\n                <p className=\"text-sm text-muted-foreground\">\n                  {/* This would be populated from the QR code data */}\n                  Código: {code}\n                </p>\n                <Badge variant=\"outline\" className=\"mt-2\">\n                  QR Atendimento Público\n                </Badge>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Service Request Form */}\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"text-lg\">Descreva sua Solicitação</CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            {/* Description */}\n            <div>\n              <label className=\"block text-sm font-medium text-foreground mb-2\">\n                O que você observou? *\n              </label>\n              <Textarea\n                placeholder=\"Ex: Banheiro sem papel higiênico, lixeira cheia, piso molhado...\"\n                value={description}\n                onChange={(e) => setDescription(e.target.value)}\n                className=\"min-h-[100px] resize-none\"\n                maxLength={500}\n                data-testid=\"textarea-description\"\n              />\n              <p className=\"text-xs text-muted-foreground mt-1\">\n                {description.length}/500 caracteres\n              </p>\n            </div>\n\n            {/* Photo Upload */}\n            <div>\n              <label className=\"block text-sm font-medium text-foreground mb-2\">\n                Foto (opcional)\n              </label>\n              <div className=\"border-2 border-dashed border-border rounded-lg p-4\">\n                <input\n                  type=\"file\"\n                  accept=\"image/*\"\n                  onChange={handlePhotoUpload}\n                  className=\"hidden\"\n                  id=\"photo-upload\"\n                />\n                <label htmlFor=\"photo-upload\" className=\"cursor-pointer\">\n                  <div className=\"text-center\">\n                    <Camera className=\"w-8 h-8 text-muted-foreground mx-auto mb-2\" />\n                    <p className=\"text-sm text-muted-foreground\">\n                      {photo ? photo.name : \"Toque para adicionar uma foto\"}\n                    </p>\n                    <p className=\"text-xs text-muted-foreground mt-1\">\n                      Máximo 5MB\n                    </p>\n                  </div>\n                </label>\n              </div>\n            </div>\n\n            {/* Priority Info */}\n            <div className=\"bg-muted/30 rounded-lg p-3\">\n              <div className=\"flex items-start space-x-2\">\n                <Clock className=\"w-4 h-4 text-chart-4 mt-0.5\" />\n                <div className=\"text-sm\">\n                  <p className=\"font-medium text-foreground\">Tempo de Atendimento</p>\n                  <p className=\"text-muted-foreground\">\n                    Solicitações são atendidas em até 2 horas durante o horário comercial.\n                  </p>\n                </div>\n              </div>\n            </div>\n\n            {/* Submit Button */}\n            <Button \n              onClick={handleSubmit}\n              disabled={!description.trim() || isSubmitting || createServiceRequestMutation.isPending}\n              className=\"w-full h-12\"\n              data-testid=\"button-submit-request\"\n            >\n              {isSubmitting || createServiceRequestMutation.isPending ? (\n                \"Enviando...\"\n              ) : (\n                <>\n                  <Send className=\"w-4 h-4 mr-2\" />\n                  Enviar Solicitação\n                </>\n              )}\n            </Button>\n\n            {/* Security Notice */}\n            <div className=\"flex items-start space-x-2 p-3 bg-muted/20 rounded-lg\">\n              <Shield className=\"w-4 h-4 text-muted-foreground mt-0.5\" />\n              <div className=\"text-xs text-muted-foreground\">\n                <p className=\"font-medium\">Privacidade e Segurança</p>\n                <p>\n                  Suas informações são tratadas com confidencialidade e utilizadas \n                  apenas para o atendimento da solicitação.\n                </p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Footer */}\n        <div className=\"mt-6 text-center\">\n          <p className=\"text-xs text-muted-foreground\">\n            Powered by <span className=\"font-semibold\">OPUS CLEAN</span>\n          </p>\n          <p className=\"text-xs text-muted-foreground mt-1\">\n            Sistema de Gestão de Facilities\n          </p>\n        </div>\n      </div>\n    </div>\n  );\n}\n","size_bytes":9479},"vite.config.ts":{"content":"import { defineConfig } from \"vite\";\nimport react from \"@vitejs/plugin-react\";\nimport path from \"path\";\n// import runtimeErrorOverlay from \"@replit/vite-plugin-runtime-error-modal\";\n\nexport default defineConfig({\n  plugins: [\n    react(),\n    // runtimeErrorOverlay(), // Temporariamente desabilitado\n    ...(process.env.NODE_ENV !== \"production\" &&\n    process.env.REPL_ID !== undefined\n      ? [\n          await import(\"@replit/vite-plugin-cartographer\").then((m) =>\n            m.cartographer(),\n          ),\n        ]\n      : []),\n  ],\n  resolve: {\n    alias: {\n      \"@\": path.resolve(import.meta.dirname, \"client\", \"src\"),\n      \"@shared\": path.resolve(import.meta.dirname, \"shared\"),\n      \"@assets\": path.resolve(import.meta.dirname, \"attached_assets\"),\n    },\n  },\n  root: path.resolve(import.meta.dirname, \"client\"),\n  build: {\n    outDir: path.resolve(import.meta.dirname, \"dist/public\"),\n    emptyOutDir: true,\n  },\n  server: {\n    host: \"0.0.0.0\",\n    port: 5173,\n    strictPort: false,\n    hmr: {\n      clientPort: 443,\n      protocol: 'wss',\n    },\n    fs: {\n      strict: true,\n      deny: [\"**/.*\"],\n    },\n  },\n});\n","size_bytes":1133},"server/middleware/auth.ts":{"content":"import { Request, Response, NextFunction } from 'express';\nimport { storage } from '../storage';\nimport jwt from 'jsonwebtoken';\n\nconst JWT_SECRET = process.env.JWT_SECRET || 'kJsXXrXanldoNcZJG/iHeTEI8WdMch4PFWNIao1llTU=';\n\nexport type UserRole = 'admin' | 'gestor_cliente' | 'supervisor_site' | 'operador' | 'auditor';\n\nexport interface SessionUser {\n  id: string;\n  companyId: string;\n  customerId?: string;\n  username: string;\n  email: string;\n  name: string;\n  role: UserRole;\n  userType?: string;\n  isActive: boolean;\n}\n\ndeclare global {\n  namespace Express {\n    interface Request {\n      user?: SessionUser;\n    }\n  }\n}\n\n/**\n * Determina o role efetivo baseado nas permissões dos custom roles\n */\nfunction getEffectiveRole(baseRole: UserRole, permissions: string[]): UserRole {\n  // Se já tem role de admin na tabela users, manter\n  if (baseRole === 'admin') {\n    return 'admin';\n  }\n  \n  // Mapear permissões para roles\n  if (permissions.includes('customers_create') || permissions.includes('customers_edit') || permissions.includes('customers_delete')) {\n    return 'admin';\n  }\n  \n  if (permissions.includes('users_create') || permissions.includes('users_edit') || permissions.includes('users_delete')) {\n    return 'gestor_cliente';\n  }\n  \n  if (permissions.includes('workorders_create') || permissions.includes('workorders_edit') || permissions.includes('sites_create')) {\n    return 'supervisor_site';\n  }\n  \n  if (permissions.includes('audit_logs_view') || permissions.includes('reports_view')) {\n    return 'auditor';\n  }\n  \n  // Default: operador\n  return baseRole;\n}\n\n/**\n * Helper function to extract user from Authorization header\n */\nasync function getUserFromToken(req: Request): Promise<SessionUser | null> {\n  try {\n    const authHeader = req.headers.authorization;\n    if (!authHeader) {\n      return null;\n    }\n    \n    const token = authHeader.replace('Bearer ', '');\n    \n    // Try JWT first\n    try {\n      const decoded = jwt.verify(token, JWT_SECRET) as any;\n      const user = await storage.getUser(decoded.userId);\n      if (!user || !user.isActive) {\n        return null;\n      }\n      \n      // Buscar custom roles e suas permissões do usuário\n      const userRoles = await storage.getUserRoles(user.id);\n      const permissions: string[] = [];\n      \n      for (const roleAssignment of userRoles) {\n        const rolePerms = await storage.getRolePermissions(roleAssignment.roleId);\n        permissions.push(...rolePerms.map((p: any) => p.permission).filter((p: string | null) => p !== null));\n      }\n      \n      // Determinar role efetivo baseado nas permissões\n      const effectiveRole = getEffectiveRole(user.role as UserRole, permissions);\n      \n      return {\n        id: user.id,\n        companyId: user.companyId || '',\n        customerId: user.customerId || undefined,\n        username: user.username,\n        email: user.email,\n        name: user.name,\n        role: effectiveRole,\n        userType: user.userType || 'opus_user',\n        isActive: user.isActive\n      };\n    } catch (jwtError) {\n      // Fallback to old token format for backwards compatibility\n      const parts = token.split('_');\n      if (parts.length >= 2 && parts[0] === 'token') {\n        const userId = parts[1];\n        const user = await storage.getUser(userId);\n        if (!user || !user.isActive) {\n          return null;\n        }\n        \n        // Buscar custom roles e suas permissões do usuário\n        const userRoles = await storage.getUserRoles(user.id);\n        const permissions: string[] = [];\n        \n        for (const roleAssignment of userRoles) {\n          const rolePerms = await storage.getRolePermissions(roleAssignment.roleId);\n          permissions.push(...rolePerms.map((p: any) => p.permission).filter((p: string | null) => p !== null));\n        }\n        \n        // Determinar role efetivo baseado nas permissões\n        const effectiveRole = getEffectiveRole(user.role as UserRole, permissions);\n        \n        return {\n          id: user.id,\n          companyId: user.companyId || '',\n          customerId: user.customerId || undefined,\n          username: user.username,\n          email: user.email,\n          name: user.name,\n          role: effectiveRole,\n          userType: user.userType || 'opus_user',\n          isActive: user.isActive\n        };\n      }\n      return null;\n    }\n  } catch (error) {\n    console.error('Error extracting user from token:', error);\n    return null;\n  }\n}\n\n/**\n * Middleware para verificar se o usuário está autenticado\n */\nexport async function requireAuth(req: Request, res: Response, next: NextFunction) {\n  const user = await getUserFromToken(req);\n  \n  if (!user) {\n    return res.status(401).json({ \n      error: 'Não autenticado',\n      message: 'Você precisa estar logado para acessar este recurso.' \n    });\n  }\n  \n  if (!user.isActive) {\n    return res.status(403).json({ \n      error: 'Conta desativada',\n      message: 'Sua conta está desativada. Entre em contato com o administrador.' \n    });\n  }\n  \n  // Attach user to request\n  req.user = user;\n  next();\n}\n\n/**\n * Middleware para verificar se o usuário tem um dos roles permitidos\n */\nexport function requireRole(allowedRoles: UserRole[]) {\n  return async (req: Request, res: Response, next: NextFunction) => {\n    const user = await getUserFromToken(req);\n    \n    if (!user) {\n      return res.status(401).json({ \n        error: 'Não autenticado',\n        message: 'Você precisa estar logado para acessar este recurso.' \n      });\n    }\n    \n    if (!allowedRoles.includes(user.role)) {\n      console.warn(`[ACCESS DENIED] User ${user.id} (${user.role}) tentou acessar recurso que requer: ${allowedRoles.join(', ')}`);\n      return res.status(403).json({ \n        error: 'Acesso negado',\n        message: `Apenas usuários com as seguintes funções podem acessar: ${allowedRoles.join(', ')}.`,\n        requiredRoles: allowedRoles,\n        userRole: user.role\n      });\n    }\n    \n    // Attach user to request\n    req.user = user;\n    next();\n  };\n}\n\n/**\n * Middleware para verificar se o usuário é admin\n */\nexport function requireAdmin(req: Request, res: Response, next: NextFunction) {\n  return requireRole(['admin'])(req, res, next);\n}\n\n/**\n * Middleware para verificar se o usuário pode gerenciar clientes (apenas admin)\n */\nexport function requireManageClients(req: Request, res: Response, next: NextFunction) {\n  return requireRole(['admin'])(req, res, next);\n}\n\n/**\n * Middleware para verificar se o usuário pode gerenciar usuários (admin ou gestor_cliente)\n */\nexport function requireManageUsers(req: Request, res: Response, next: NextFunction) {\n  return requireRole(['admin', 'gestor_cliente'])(req, res, next);\n}\n\n/**\n * Middleware para verificar se o usuário pode gerenciar work orders\n * (admin, gestor_cliente ou supervisor_site)\n */\nexport function requireManageWorkOrders(req: Request, res: Response, next: NextFunction) {\n  return requireRole(['admin', 'gestor_cliente', 'supervisor_site'])(req, res, next);\n}\n\n/**\n * Middleware para verificar se o usuário pode visualizar relatórios\n * (admin, gestor_cliente ou auditor)\n */\nexport function requireViewReports(req: Request, res: Response, next: NextFunction) {\n  return requireRole(['admin', 'gestor_cliente', 'auditor'])(req, res, next);\n}\n\n/**\n * Middleware para validar que o usuário só acessa dados do seu próprio cliente\n * (exceto admin que pode acessar tudo)\n */\nexport async function requireOwnCustomer(req: Request, res: Response, next: NextFunction) {\n  const user = await getUserFromToken(req);\n  \n  if (!user) {\n    return res.status(401).json({ \n      error: 'Não autenticado' \n    });\n  }\n  \n  // Admin pode acessar qualquer cliente\n  if (user.role === 'admin') {\n    req.user = user;\n    return next();\n  }\n  \n  // Pegar customerId do parâmetro da rota ou do body\n  const requestedCustomerId = req.params.customerId || req.body.customerId;\n  \n  if (!requestedCustomerId) {\n    return res.status(400).json({ \n      error: 'Cliente não especificado',\n      message: 'É necessário especificar o ID do cliente.' \n    });\n  }\n  \n  // Verificar se o usuário pertence ao cliente solicitado\n  if (user.customerId !== requestedCustomerId) {\n    console.warn(`[ACCESS DENIED] User ${user.id} tentou acessar dados do cliente ${requestedCustomerId} mas pertence a ${user.customerId}`);\n    return res.status(403).json({ \n      error: 'Acesso negado',\n      message: 'Você não tem permissão para acessar dados deste cliente.',\n      userCustomerId: user.customerId,\n      requestedCustomerId\n    });\n  }\n  \n  req.user = user;\n  next();\n}\n\n/**\n * Middleware para validar que o usuário só acessa suas próprias work orders\n * (usado para operadores que só podem ver suas próprias OSs)\n */\nexport async function requireOwnWorkOrders(req: Request, res: Response, next: NextFunction) {\n  const user = await getUserFromToken(req);\n  \n  if (!user) {\n    return res.status(401).json({ \n      error: 'Não autenticado' \n    });\n  }\n  \n  // Admin, gestor e supervisor podem ver todas as OSs\n  if (['admin', 'gestor_cliente', 'supervisor_site'].includes(user.role)) {\n    req.user = user;\n    return next();\n  }\n  \n  // Operadores só podem ver suas próprias OSs\n  // Isso será validado na query do banco de dados\n  req.user = user;\n  next();\n}\n\n/**\n * Função helper para logar tentativas de acesso negado\n * (pode ser expandida para salvar em audit_logs)\n */\nexport function logAccessDenied(\n  userId: string, \n  resource: string, \n  action: string, \n  reason: string\n) {\n  console.warn(`[ACCESS DENIED] User ${userId} tentou ${action} em ${resource}. Motivo: ${reason}`);\n  // TODO: Salvar em audit_logs no banco de dados\n}\n","size_bytes":9699},"client/src/components/ui/switch.tsx":{"content":"import * as React from \"react\"\nimport * as SwitchPrimitives from \"@radix-ui/react-switch\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Switch = React.forwardRef<\n  React.ElementRef<typeof SwitchPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>\n>(({ className, ...props }, ref) => (\n  <SwitchPrimitives.Root\n    className={cn(\n      \"peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  >\n    <SwitchPrimitives.Thumb\n      className={cn(\n        \"pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0\"\n      )}\n    />\n  </SwitchPrimitives.Root>\n))\nSwitch.displayName = SwitchPrimitives.Root.displayName\n\nexport { Switch }\n","size_bytes":1139},"server/index.ts":{"content":"import express, { type Request, Response, NextFunction } from \"express\";\nimport { registerRoutes } from \"./routes\";\nimport { setupVite, serveStatic, log } from \"./vite\";\nimport helmet from \"helmet\";\nimport cors from \"cors\";\n\nconst app = express();\n\n// Trust proxy for rate limiting and IP detection (required for Replit/VM deployment)\napp.set('trust proxy', 1);\n\napp.use(helmet({\n  contentSecurityPolicy: false,\n  crossOriginEmbedderPolicy: false,\n}));\n\napp.use(cors({\n  origin: process.env.NODE_ENV === 'production' \n    ? [process.env.REPLIT_DOMAIN || 'https://*.replit.dev'] \n    : true,\n  credentials: true,\n  methods: ['GET', 'POST', 'PUT', 'PATCH', 'DELETE', 'OPTIONS'],\n  allowedHeaders: ['Content-Type', 'Authorization'],\n}));\n\napp.use(express.json({ limit: '50mb' }));\napp.use(express.urlencoded({ extended: false, limit: '50mb' }));\n\napp.use((req, res, next) => {\n  const start = Date.now();\n  const path = req.path;\n  let capturedJsonResponse: Record<string, any> | undefined = undefined;\n\n  const originalResJson = res.json;\n  res.json = function (bodyJson, ...args) {\n    capturedJsonResponse = bodyJson;\n    return originalResJson.apply(res, [bodyJson, ...args]);\n  };\n\n  res.on(\"finish\", () => {\n    const duration = Date.now() - start;\n    if (path.startsWith(\"/api\")) {\n      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;\n      if (capturedJsonResponse) {\n        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;\n      }\n\n      if (logLine.length > 80) {\n        logLine = logLine.slice(0, 79) + \"…\";\n      }\n\n      log(logLine);\n    }\n  });\n\n  next();\n});\n\n(async () => {\n  const server = await registerRoutes(app);\n\n  app.use((err: any, _req: Request, res: Response, _next: NextFunction) => {\n    const status = err.status || err.statusCode || 500;\n    const message = err.message || \"Internal Server Error\";\n\n    res.status(status).json({ message });\n    throw err;\n  });\n\n  // importantly only setup vite in development and after\n  // setting up all the other routes so the catch-all route\n  // doesn't interfere with the other routes\n  if (app.get(\"env\") === \"development\") {\n    await setupVite(app, server);\n  } else {\n    serveStatic(app);\n  }\n\n  // ALWAYS serve the app on the port specified in the environment variable PORT\n  // Other ports are firewalled. Default to 5000 if not specified.\n  // this serves both the API and the client.\n  // It is the only port that is not firewalled.\n  const port = parseInt(process.env.PORT || '5000', 10);\n  server.listen({\n    port,\n    host: \"0.0.0.0\",\n    reusePort: true,\n  }, () => {\n    log(`serving on port ${port}`);\n    \n    // Schedule monthly maintenance work order generation\n    scheduleMonthlyMaintenance();\n  });\n})();\n\n// Monthly maintenance scheduler - runs on the last day of each month at 23:00\nfunction scheduleMonthlyMaintenance() {\n  function checkAndRun() {\n    const now = new Date();\n    const tomorrow = new Date(now);\n    tomorrow.setDate(tomorrow.getDate() + 1);\n    \n    // Check if tomorrow is a new month (meaning today is last day of month)\n    const isLastDayOfMonth = tomorrow.getMonth() !== now.getMonth();\n    \n    // Run at 23:00 on the last day of month\n    if (isLastDayOfMonth && now.getHours() === 23 && now.getMinutes() === 0) {\n      log('[MONTHLY SCHEDULER] Executando geração automática de OSs para próximo mês');\n      \n      fetch(`http://localhost:${parseInt(process.env.PORT || '5000', 10)}/api/scheduler/regenerate-monthly-maintenance`, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n      })\n        .then(res => res.json())\n        .then(data => {\n          log(`[MONTHLY SCHEDULER] ✅ Geração concluída: ${data.totalGenerated} OSs criadas`);\n        })\n        .catch(error => {\n          console.error('[MONTHLY SCHEDULER] ❌ Erro na geração automática:', error);\n        });\n    }\n  }\n  \n  // Check every hour\n  setInterval(checkAndRun, 60 * 60 * 1000);\n  log('[MONTHLY SCHEDULER] Agendamento mensal ativado - roda todo último dia do mês às 23:00');\n}\n","size_bytes":4062},"client/src/components/heatmap/ModernHeatmap.tsx":{"content":"import React, { useMemo } from 'react';\nimport Chart from 'react-apexcharts';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Badge } from '@/components/ui/badge';\nimport { Activity, TrendingUp, TrendingDown, Minus } from 'lucide-react';\n\ninterface Zone {\n  zoneId: string;\n  zoneName: string;\n  areaM2: number;\n  slaPercentage: number;\n  totalTasks: number;\n  completedTasks: number;\n  category: string;\n}\n\ninterface ModernHeatmapProps {\n  data: Zone[];\n  selectedSite?: any;\n  onZoneClick?: (zoneId: string) => void;\n}\n\nexport default function ModernHeatmap({ data, selectedSite, onZoneClick }: ModernHeatmapProps) {\n  // Transform data for ApexCharts heatmap\n  const chartData = useMemo(() => {\n    if (!data || data.length === 0) return [];\n\n    // Group zones by category for better visualization\n    const categories = [...new Set(data.map(zone => zone.category))];\n    \n    return categories.map((category, categoryIndex) => {\n      const categoryZones = data.filter(zone => zone.category === category);\n      \n      return {\n        name: category.charAt(0).toUpperCase() + category.slice(1),\n        data: categoryZones.map((zone, zoneIndex) => ({\n          x: zone.zoneName,\n          y: zone.slaPercentage,\n          zone: zone, // Keep zone data for tooltips\n          color: getSLAColor(zone.slaPercentage)\n        }))\n      };\n    });\n  }, [data]);\n\n  // Chart configuration\n  const chartOptions = useMemo(() => ({\n    chart: {\n      type: 'heatmap' as const,\n      height: 400,\n      animations: {\n        enabled: true,\n        easing: 'easeinout',\n        speed: 800\n      },\n      toolbar: {\n        show: true,\n        tools: {\n          download: true,\n          selection: false,\n          zoom: false,\n          zoomin: false,\n          zoomout: false,\n          pan: false,\n          reset: true\n        }\n      },\n      events: {\n        dataPointSelection: (event: any, chartContext: any, config: any) => {\n          const zone = chartData[config.seriesIndex]?.data[config.dataPointIndex]?.zone;\n          if (zone && onZoneClick) {\n            onZoneClick(zone.zoneId);\n          }\n        }\n      }\n    },\n    dataLabels: {\n      enabled: true,\n      style: {\n        colors: ['#fff'],\n        fontSize: '12px',\n        fontWeight: 'bold'\n      },\n      formatter: (value: number) => `${value}%`\n    },\n    colors: ['#008FFB'],\n    plotOptions: {\n      heatmap: {\n        radius: 8,\n        enableShades: false,\n        colorScale: {\n          ranges: [\n            { from: 0, to: 70, color: '#FF4560', name: 'Crítico' },\n            { from: 71, to: 84, color: '#FEB019', name: 'Atenção' },\n            { from: 85, to: 94, color: '#00D9FF', name: 'Bom' },\n            { from: 95, to: 100, color: '#00E396', name: 'Excelente' }\n          ]\n        },\n        distributed: false\n      }\n    },\n    xaxis: {\n      type: 'category',\n      labels: {\n        style: {\n          fontSize: '11px',\n          colors: '#64748b'\n        },\n        rotate: -45,\n        trim: true,\n        maxHeight: 80\n      }\n    },\n    yaxis: {\n      labels: {\n        style: {\n          fontSize: '12px',\n          colors: '#64748b'\n        }\n      }\n    },\n    tooltip: {\n      custom: ({ seriesIndex, dataPointIndex, w }: any) => {\n        const zone = chartData[seriesIndex]?.data[dataPointIndex]?.zone;\n        if (!zone) return '';\n        \n        return `\n          <div class=\"bg-white p-4 rounded-lg shadow-lg border min-w-64\">\n            <div class=\"font-semibold text-slate-900 mb-2\">${zone.zoneName}</div>\n            <div class=\"space-y-2 text-sm\">\n              <div class=\"flex justify-between\">\n                <span class=\"text-slate-600\">SLA:</span>\n                <span class=\"font-medium ${getSLATextColor(zone.slaPercentage)}\">${zone.slaPercentage}%</span>\n              </div>\n              <div class=\"flex justify-between\">\n                <span class=\"text-slate-600\">Área:</span>\n                <span class=\"font-medium\">${zone.areaM2}m²</span>\n              </div>\n              <div class=\"flex justify-between\">\n                <span class=\"text-slate-600\">Tarefas:</span>\n                <span class=\"font-medium\">${zone.completedTasks}/${zone.totalTasks}</span>\n              </div>\n              <div class=\"flex justify-between\">\n                <span class=\"text-slate-600\">Categoria:</span>\n                <span class=\"font-medium capitalize\">${zone.category}</span>\n              </div>\n            </div>\n          </div>\n        `;\n      }\n    },\n    grid: {\n      padding: {\n        top: 0,\n        right: 30,\n        bottom: 0,\n        left: 20\n      }\n    },\n    legend: {\n      show: false\n    }\n  }), [chartData, onZoneClick]);\n\n  // Statistics for the header\n  const stats = useMemo(() => {\n    if (!data || data.length === 0) return { avgSLA: 0, totalZones: 0, criticalZones: 0, excellentZones: 0 };\n\n    const avgSLA = Math.round(data.reduce((sum, zone) => sum + zone.slaPercentage, 0) / data.length);\n    const criticalZones = data.filter(zone => zone.slaPercentage < 70).length;\n    const excellentZones = data.filter(zone => zone.slaPercentage >= 95).length;\n\n    return {\n      avgSLA,\n      totalZones: data.length,\n      criticalZones,\n      excellentZones\n    };\n  }, [data]);\n\n  if (!data || data.length === 0) {\n    return (\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Activity className=\"w-5 h-5 text-blue-600\" />\n            Mapa de Calor Interativo - SLA\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"flex items-center justify-center h-64 text-muted-foreground\">\n            <div className=\"text-center\">\n              <Activity className=\"w-12 h-12 mx-auto mb-4 opacity-50\" />\n              <p>Carregando dados do mapa de calor...</p>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  return (\n    <Card className=\"w-full\">\n      <CardHeader className=\"pb-4\">\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <CardTitle className=\"flex items-center gap-2\">\n              <div className=\"w-6 h-6 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg flex items-center justify-center\">\n                <Activity className=\"w-4 h-4 text-white\" />\n              </div>\n              Mapa de Calor Interativo - SLA de Limpeza\n            </CardTitle>\n            <p className=\"text-sm text-muted-foreground mt-1\">\n              {selectedSite?.name} - Visualização em tempo real do cumprimento de SLA por zona\n            </p>\n          </div>\n        </div>\n\n        {/* Statistics Cards */}\n        <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 mt-4\">\n          <div className=\"bg-gradient-to-r from-blue-50 to-blue-100 p-3 rounded-lg\">\n            <div className=\"flex items-center gap-2\">\n              <Activity className=\"w-4 h-4 text-blue-600\" />\n              <span className=\"text-sm font-medium text-blue-900\">SLA Médio</span>\n            </div>\n            <div className=\"text-2xl font-bold text-blue-600 mt-1\">{stats.avgSLA}%</div>\n          </div>\n\n          <div className=\"bg-gradient-to-r from-green-50 to-green-100 p-3 rounded-lg\">\n            <div className=\"flex items-center gap-2\">\n              <TrendingUp className=\"w-4 h-4 text-green-600\" />\n              <span className=\"text-sm font-medium text-green-900\">Excelentes</span>\n            </div>\n            <div className=\"text-2xl font-bold text-green-600 mt-1\">{stats.excellentZones}</div>\n          </div>\n\n          <div className=\"bg-gradient-to-r from-red-50 to-red-100 p-3 rounded-lg\">\n            <div className=\"flex items-center gap-2\">\n              <TrendingDown className=\"w-4 h-4 text-red-600\" />\n              <span className=\"text-sm font-medium text-red-900\">Críticas</span>\n            </div>\n            <div className=\"text-2xl font-bold text-red-600 mt-1\">{stats.criticalZones}</div>\n          </div>\n\n          <div className=\"bg-gradient-to-r from-slate-50 to-slate-100 p-3 rounded-lg\">\n            <div className=\"flex items-center gap-2\">\n              <Minus className=\"w-4 h-4 text-slate-600\" />\n              <span className=\"text-sm font-medium text-slate-900\">Total</span>\n            </div>\n            <div className=\"text-2xl font-bold text-slate-600 mt-1\">{stats.totalZones}</div>\n          </div>\n        </div>\n      </CardHeader>\n\n      <CardContent>\n        {/* Legend */}\n        <div className=\"flex flex-wrap gap-3 mb-6\">\n          <Badge variant=\"secondary\" className=\"bg-red-100 text-red-800 border-red-200\">\n            <div className=\"w-3 h-3 bg-red-500 rounded-full mr-2\"></div>\n            Crítico (&lt;70%)\n          </Badge>\n          <Badge variant=\"secondary\" className=\"bg-orange-100 text-orange-800 border-orange-200\">\n            <div className=\"w-3 h-3 bg-orange-500 rounded-full mr-2\"></div>\n            Atenção (70-84%)\n          </Badge>\n          <Badge variant=\"secondary\" className=\"bg-cyan-100 text-cyan-800 border-cyan-200\">\n            <div className=\"w-3 h-3 bg-cyan-500 rounded-full mr-2\"></div>\n            Bom (85-94%)\n          </Badge>\n          <Badge variant=\"secondary\" className=\"bg-green-100 text-green-800 border-green-200\">\n            <div className=\"w-3 h-3 bg-green-500 rounded-full mr-2\"></div>\n            Excelente (≥95%)\n          </Badge>\n        </div>\n\n        {/* Interactive Heatmap */}\n        <div className=\"w-full\">\n          <Chart\n            options={chartOptions}\n            series={chartData}\n            type=\"heatmap\"\n            height={400}\n          />\n        </div>\n\n        {/* Instructions */}\n        <div className=\"mt-4 p-3 bg-blue-50 rounded-lg\">\n          <p className=\"text-sm text-blue-800\">\n            <span className=\"font-medium\">💡 Dica:</span> Clique nas células do mapa para ver detalhes das zonas. Use a barra de ferramentas para exportar ou resetar a visualização.\n          </p>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n\n// Helper functions\nfunction getSLAColor(sla: number): string {\n  if (sla >= 95) return '#00E396'; // Green - Excellent\n  if (sla >= 85) return '#00D9FF'; // Cyan - Good  \n  if (sla >= 70) return '#FEB019'; // Orange - Attention\n  return '#FF4560'; // Red - Critical\n}\n\nfunction getSLATextColor(sla: number): string {\n  if (sla >= 95) return 'text-green-600';\n  if (sla >= 85) return 'text-cyan-600';\n  if (sla >= 70) return 'text-orange-600';\n  return 'text-red-600';\n}","size_bytes":10522},"client/src/components/mobile/QRCodesMobile.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Search, QrCode, MapPin, Plus, Eye, Download } from \"lucide-react\";\n\ninterface QRCodesMobileProps {\n  customerId: string;\n}\n\nexport default function QRCodesMobile({ customerId }: QRCodesMobileProps) {\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const [typeFilter, setTypeFilter] = useState(\"todos\");\n\n  const { data: qrCodes, isLoading } = useQuery({\n    queryKey: [\"/api/customers\", customerId, \"qr-points\"],\n    enabled: !!customerId,\n  });\n\n  const filteredQRCodes = (qrCodes as any[])?.filter((qr: any) => {\n    const matchesType = typeFilter === \"todos\" || qr.type === typeFilter;\n    const matchesSearch = qr.name?.toLowerCase().includes(searchTerm.toLowerCase()) ||\n                         qr.description?.toLowerCase().includes(searchTerm.toLowerCase());\n    return matchesType && matchesSearch;\n  }) || [];\n\n  const totalExecucao = (qrCodes as any[])?.filter((qr: any) => qr.type === 'execucao').length || 0;\n  const totalAtendimento = (qrCodes as any[])?.filter((qr: any) => qr.type === 'atendimento').length || 0;\n\n  const getTypeBadge = (type: string, id?: string) => {\n    const testId = id ? `badge-type-${type}-${id}` : `badge-type-${type}`;\n    switch (type) {\n      case \"execucao\":\n        return <Badge className=\"bg-blue-500 text-white text-xs\" data-testid={testId}>Execução</Badge>;\n      case \"atendimento\":\n        return <Badge className=\"bg-green-500 text-white text-xs\" data-testid={testId}>Atendimento</Badge>;\n      default:\n        return <Badge className=\"bg-gray-500 text-white text-xs\" data-testid={testId}>{type}</Badge>;\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"p-4 space-y-4\">\n        <div className=\"animate-pulse space-y-3\">\n          {[1,2,3].map(i => (\n            <div key={i} className=\"h-24 bg-gray-200 rounded-lg\"></div>\n          ))}\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gray-50 pb-20\">\n      {/* Header */}\n      <div className=\"bg-white border-b p-4 space-y-3 sticky top-0 z-10\">\n        <div className=\"flex items-center justify-between\">\n          <h2 className=\"text-lg font-semibold\">QR Codes</h2>\n          <Button size=\"sm\" className=\"bg-blue-600\" data-testid=\"button-new-qrcode\" disabled>\n            <Plus className=\"w-4 h-4 mr-2\" />\n            Novo\n          </Button>\n        </div>\n\n        {/* Busca */}\n        <div className=\"relative\">\n          <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4\" />\n          <Input\n            placeholder=\"Buscar QR Code...\"\n            value={searchTerm}\n            onChange={(e) => setSearchTerm(e.target.value)}\n            className=\"pl-10\"\n            data-testid=\"input-search-qrcodes\"\n          />\n        </div>\n\n        {/* Filtro */}\n        <Select value={typeFilter} onValueChange={setTypeFilter}>\n          <SelectTrigger className=\"w-full\" data-testid=\"select-type-filter\">\n            <SelectValue placeholder=\"Tipo\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"todos\" data-testid=\"select-item-type-todos\">Todos</SelectItem>\n            <SelectItem value=\"execucao\" data-testid=\"select-item-type-execucao\">Execução</SelectItem>\n            <SelectItem value=\"atendimento\" data-testid=\"select-item-type-atendimento\">Atendimento</SelectItem>\n          </SelectContent>\n        </Select>\n      </div>\n\n      {/* Stats */}\n      <div className=\"p-4 grid grid-cols-2 gap-3\">\n        <Card className=\"bg-gradient-to-br from-blue-500 to-blue-600 border-0 shadow-lg\" data-testid=\"card-stats-execucao\">\n          <CardContent className=\"p-4 text-center\">\n            <QrCode className=\"w-6 h-6 text-white mx-auto mb-2\" />\n            <p className=\"text-2xl font-bold text-white\" data-testid=\"text-count-execucao\">{totalExecucao}</p>\n            <p className=\"text-xs text-white/80\">Execução</p>\n          </CardContent>\n        </Card>\n\n        <Card className=\"bg-gradient-to-br from-green-500 to-green-600 border-0 shadow-lg\" data-testid=\"card-stats-atendimento\">\n          <CardContent className=\"p-4 text-center\">\n            <QrCode className=\"w-6 h-6 text-white mx-auto mb-2\" />\n            <p className=\"text-2xl font-bold text-white\" data-testid=\"text-count-atendimento\">{totalAtendimento}</p>\n            <p className=\"text-xs text-white/80\">Atendimento</p>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Lista */}\n      <div className=\"p-4 space-y-3\">\n        <p className=\"text-sm text-gray-600 mb-3\">{filteredQRCodes.length} QR Codes</p>\n        \n        {filteredQRCodes.length === 0 ? (\n          <Card>\n            <CardContent className=\"p-8 text-center text-gray-500\">\n              Nenhum QR Code encontrado\n            </CardContent>\n          </Card>\n        ) : (\n          filteredQRCodes.map((qr: any) => (\n            <Card key={qr.id} className=\"hover:shadow-md transition-shadow\" data-testid={`card-qrcode-${qr.id}`}>\n              <CardContent className=\"p-4\">\n                <div className=\"space-y-3\">\n                  {/* Header */}\n                  <div className=\"flex items-start justify-between\">\n                    <div className=\"flex-1\">\n                      <div className=\"flex items-center gap-2 mb-1\">\n                        <QrCode className=\"w-5 h-5 text-blue-600\" />\n                        <p className=\"font-semibold text-gray-900\" data-testid={`text-qrcode-name-${qr.id}`}>\n                          {qr.name || 'Sem nome'}\n                        </p>\n                      </div>\n                      {getTypeBadge(qr.type, qr.id)}\n                    </div>\n                    <div className=\"flex gap-1\">\n                      <Button variant=\"ghost\" size=\"sm\" className=\"h-8 w-8 p-0\" data-testid={`button-view-qrcode-${qr.id}`} disabled>\n                        <Eye className=\"w-4 h-4\" />\n                      </Button>\n                      <Button variant=\"ghost\" size=\"sm\" className=\"h-8 w-8 p-0\" data-testid={`button-download-qrcode-${qr.id}`} disabled>\n                        <Download className=\"w-4 h-4\" />\n                      </Button>\n                    </div>\n                  </div>\n\n                  {/* Detalhes */}\n                  {qr.description && (\n                    <p className=\"text-sm text-gray-600\" data-testid={`text-qrcode-description-${qr.id}`}>\n                      {qr.description}\n                    </p>\n                  )}\n\n                  <div className=\"flex items-center gap-2 text-sm text-gray-600\">\n                    <MapPin className=\"w-4 h-4\" />\n                    <span data-testid={`text-qrcode-zone-${qr.id}`}>{qr.zoneName || 'Local não especificado'}</span>\n                  </div>\n\n                  {qr.isActive ? (\n                    <Badge variant=\"outline\" className=\"bg-green-50 text-green-700 border-green-200\" data-testid={`badge-status-active-${qr.id}`}>Ativo</Badge>\n                  ) : (\n                    <Badge variant=\"outline\" className=\"bg-gray-50 text-gray-700 border-gray-200\" data-testid={`badge-status-inactive-${qr.id}`}>Inativo</Badge>\n                  )}\n                </div>\n              </CardContent>\n            </Card>\n          ))\n        )}\n      </div>\n    </div>\n  );\n}\n","size_bytes":7630},"client/src/pages/roles.tsx":{"content":"import { useState } from 'react';\nimport { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Badge } from '@/components/ui/badge';\nimport { Checkbox } from '@/components/ui/checkbox';\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog';\nimport { Form, FormControl, FormField, FormItem, FormLabel } from '@/components/ui/form';\nimport { Textarea } from '@/components/ui/textarea';\nimport { useForm } from 'react-hook-form';\nimport { zodResolver } from '@hookform/resolvers/zod';\nimport { z } from 'zod';\nimport { useToast } from '@/hooks/use-toast';\nimport { apiRequest } from '@/lib/queryClient';\nimport { Users, Shield, Plus, Edit, Trash2, Settings, LayoutDashboard, FileText, MapPin, BarChart3, ClipboardCheck, QrCode, Map, Thermometer, Building2, UserCog, Settings2, Eye, CheckCircle2, XCircle } from 'lucide-react';\nimport usePermissions, { PermissionKey } from '@/hooks/usePermissions';\nimport type { CustomRole } from '@/hooks/usePermissions';\n\nconst createRoleSchema = z.object({\n  name: z.string().min(1, 'Nome é obrigatório'),\n  description: z.string().optional(),\n  permissions: z.array(z.string()).min(1, 'Selecione pelo menos uma permissão'),\n});\n\ntype CreateRoleForm = z.infer<typeof createRoleSchema>;\n\nexport default function Roles() {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const { availablePermissions, can } = usePermissions();\n  const [searchTerm, setSearchTerm] = useState('');\n  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);\n  const [editingRole, setEditingRole] = useState<CustomRole | null>(null);\n\n  const form = useForm<CreateRoleForm>({\n    resolver: zodResolver(createRoleSchema),\n    defaultValues: {\n      name: '',\n      description: '',\n      permissions: [],\n    },\n  });\n\n  // Verificar se o usuário pode gerenciar roles\n  if (!can.manageRoles()) {\n    return (\n      <div className=\"flex-1 flex items-center justify-center\">\n        <Card className=\"w-96\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Shield className=\"h-5 w-5\" />\n              Acesso Negado\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <p className=\"text-muted-foreground\">\n              Você não tem permissão para acessar o gerenciamento de funções.\n            </p>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  const { data: roles = [], isLoading } = useQuery<CustomRole[]>({\n    queryKey: ['/api/roles'],\n  });\n\n  const createRoleMutation = useMutation({\n    mutationFn: async (data: CreateRoleForm) => {\n      await apiRequest('POST', '/api/roles', data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/roles'] });\n      setIsCreateDialogOpen(false);\n      setEditingRole(null);\n      form.reset();\n      toast({\n        title: 'Sucesso',\n        description: 'Função criada com sucesso!',\n      });\n    },\n    onError: (error) => {\n      toast({\n        title: 'Erro',\n        description: error.message,\n        variant: 'destructive',\n      });\n    },\n  });\n\n  const updateRoleMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: CreateRoleForm }) => {\n      await apiRequest('PATCH', `/api/roles/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/roles'] });\n      setIsCreateDialogOpen(false);\n      setEditingRole(null);\n      form.reset();\n      toast({\n        title: 'Sucesso',\n        description: 'Função atualizada com sucesso!',\n      });\n    },\n    onError: (error) => {\n      toast({\n        title: 'Erro',\n        description: error.message,\n        variant: 'destructive',\n      });\n    },\n  });\n\n  const deleteRoleMutation = useMutation({\n    mutationFn: async (roleId: string) => {\n      await apiRequest('DELETE', `/api/roles/${roleId}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/roles'] });\n      toast({\n        title: 'Sucesso',\n        description: 'Função excluída com sucesso!',\n      });\n    },\n    onError: (error) => {\n      toast({\n        title: 'Erro',\n        description: error.message,\n        variant: 'destructive',\n      });\n    },\n  });\n\n  const filteredRoles = roles.filter((role: CustomRole) =>\n    role.name.toLowerCase().includes(searchTerm.toLowerCase()) ||\n    role.description?.toLowerCase().includes(searchTerm.toLowerCase())\n  );\n\n  const handleEdit = (role: CustomRole) => {\n    setEditingRole(role);\n    form.reset({\n      name: role.name,\n      description: role.description || '',\n      permissions: role.permissions,\n    });\n    setIsCreateDialogOpen(true);\n  };\n\n  const handleSubmit = (data: CreateRoleForm) => {\n    if (editingRole) {\n      updateRoleMutation.mutate({ id: editingRole.id, data });\n    } else {\n      createRoleMutation.mutate(data);\n    }\n  };\n\n  // Agrupar permissões por categoria\n  const groupedPermissions = availablePermissions.reduce((acc, permission) => {\n    if (!acc[permission.category]) {\n      acc[permission.category] = [];\n    }\n    acc[permission.category].push(permission);\n    return acc;\n  }, {} as Record<string, typeof availablePermissions>);\n\n  // Mapear áreas acessíveis com ícones\n  const areaAccessMap: Record<string, { label: string; icon: any; viewPerm: string }> = {\n    dashboard: { label: 'Dashboard', icon: LayoutDashboard, viewPerm: 'dashboard_view' },\n    workorders: { label: 'Ordens de Serviço', icon: FileText, viewPerm: 'workorders_view' },\n    schedule: { label: 'Plano de Limpeza', icon: ClipboardCheck, viewPerm: 'schedule_view' },\n    checklists: { label: 'Checklists', icon: ClipboardCheck, viewPerm: 'checklists_view' },\n    qrcodes: { label: 'QR Codes', icon: QrCode, viewPerm: 'qrcodes_view' },\n    floorplan: { label: 'Planta dos Locais', icon: Map, viewPerm: 'floor_plan_view' },\n    heatmap: { label: 'Mapa de Calor', icon: Thermometer, viewPerm: 'heatmap_view' },\n    sites: { label: 'Locais', icon: Building2, viewPerm: 'sites_view' },\n    reports: { label: 'Relatórios', icon: BarChart3, viewPerm: 'reports_view' },\n    settings: { label: 'Configurações', icon: Settings2, viewPerm: 'service_settings_view' },\n    users: { label: 'Usuários', icon: UserCog, viewPerm: 'users_view' },\n  };\n\n  const getAccessibleAreas = (permissions: string[]) => {\n    return Object.entries(areaAccessMap)\n      .filter(([_, area]) => permissions.includes(area.viewPerm))\n      .map(([key, area]) => ({ key, ...area }));\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"flex-1 flex items-center justify-center\">\n        <div className=\"text-muted-foreground\">Carregando...</div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"flex-1 p-6 space-y-6 overflow-auto\">\n      <div className=\"flex justify-between items-start shrink-0\">\n          <div>\n            <h1 className=\"text-3xl font-bold text-foreground flex items-center gap-3\">\n              <Settings className=\"h-8 w-8\" />\n              Gerenciamento de Funções\n            </h1>\n            <p className=\"text-muted-foreground mt-2\">\n              Configure funções personalizadas e suas permissões no sistema\n            </p>\n          </div>\n\n          <Dialog open={isCreateDialogOpen} onOpenChange={setIsCreateDialogOpen}>\n            <DialogTrigger asChild>\n              <Button \n                onClick={() => {\n                  setEditingRole(null);\n                  form.reset();\n                }}\n                data-testid=\"button-create-role\"\n              >\n                <Plus className=\"h-4 w-4 mr-2\" />\n                Nova Função\n              </Button>\n            </DialogTrigger>\n            <DialogContent className=\"max-w-4xl max-h-[80vh] overflow-y-auto\">\n              <DialogHeader>\n                <DialogTitle>\n                  {editingRole ? 'Editar Função' : 'Nova Função'}\n                </DialogTitle>\n                <DialogDescription>\n                  {editingRole ? 'Edite os dados da função' : 'Crie uma nova função com permissões específicas'}\n                </DialogDescription>\n              </DialogHeader>\n\n              <Form {...form}>\n                <form onSubmit={form.handleSubmit(handleSubmit)} className=\"space-y-6\">\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <FormField\n                      control={form.control}\n                      name=\"name\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Nome da Função</FormLabel>\n                          <FormControl>\n                            <Input \n                              placeholder=\"Ex: Supervisor, Operador Avançado\"\n                              data-testid=\"input-role-name\"\n                              {...field} \n                            />\n                          </FormControl>\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={form.control}\n                      name=\"description\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Descrição</FormLabel>\n                          <FormControl>\n                            <Textarea \n                              placeholder=\"Descreva as responsabilidades desta função\"\n                              className=\"resize-none\"\n                              data-testid=\"input-role-description\"\n                              {...field}\n                            />\n                          </FormControl>\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n\n                  <div>\n                    <FormLabel className=\"text-base font-medium mb-4 block\">\n                      Permissões\n                    </FormLabel>\n                    <div className=\"space-y-6\">\n                      {Object.entries(groupedPermissions).map(([category, permissions]) => (\n                        <Card key={category}>\n                          <CardHeader className=\"pb-3\">\n                            <CardTitle className=\"text-sm font-medium\">{category}</CardTitle>\n                          </CardHeader>\n                          <CardContent className=\"space-y-3\">\n                            {permissions.map((permission) => (\n                              <FormField\n                                key={permission.key}\n                                control={form.control}\n                                name=\"permissions\"\n                                render={({ field }) => (\n                                  <FormItem className=\"flex items-center space-x-3 space-y-0\">\n                                    <FormControl>\n                                      <Checkbox\n                                        checked={field.value.includes(permission.key)}\n                                        onCheckedChange={(checked) => {\n                                          if (checked) {\n                                            field.onChange([...field.value, permission.key]);\n                                          } else {\n                                            field.onChange(\n                                              field.value.filter((value) => value !== permission.key)\n                                            );\n                                          }\n                                        }}\n                                        data-testid={`checkbox-permission-${permission.key}`}\n                                      />\n                                    </FormControl>\n                                    <FormLabel className=\"text-sm font-normal\">\n                                      {permission.label}\n                                    </FormLabel>\n                                  </FormItem>\n                                )}\n                              />\n                            ))}\n                          </CardContent>\n                        </Card>\n                      ))}\n                    </div>\n                  </div>\n\n                  <div className=\"flex justify-end space-x-2\">\n                    <Button \n                      type=\"button\" \n                      variant=\"outline\" \n                      onClick={() => setIsCreateDialogOpen(false)}\n                      data-testid=\"button-cancel-role\"\n                    >\n                      Cancelar\n                    </Button>\n                    <Button \n                      type=\"submit\" \n                      disabled={createRoleMutation.isPending || updateRoleMutation.isPending}\n                      data-testid=\"button-save-role\"\n                    >\n                      {(createRoleMutation.isPending || updateRoleMutation.isPending) ? 'Salvando...' : 'Salvar'}\n                    </Button>\n                  </div>\n                </form>\n              </Form>\n            </DialogContent>\n          </Dialog>\n      </div>\n\n      <Card>\n          <CardHeader>\n            <div className=\"flex justify-between items-center\">\n              <div>\n                <CardTitle>Funções Cadastradas</CardTitle>\n                <CardDescription>\n                  Total de {filteredRoles.length} função(ões)\n                </CardDescription>\n              </div>\n              <Input\n                placeholder=\"Buscar por nome ou descrição...\"\n                value={searchTerm}\n                onChange={(e) => setSearchTerm(e.target.value)}\n                className=\"max-w-sm\"\n                data-testid=\"input-search-roles\"\n              />\n            </div>\n          </CardHeader>\n          <CardContent>\n            {filteredRoles.length === 0 ? (\n              <div className=\"text-center py-12\">\n                <Users className=\"h-12 w-12 text-muted-foreground mx-auto mb-4\" />\n                <h3 className=\"text-lg font-semibold mb-2\">Nenhuma função encontrada</h3>\n                <p className=\"text-muted-foreground\">\n                  {searchTerm ? 'Tente ajustar sua busca' : 'Crie a primeira função personalizada'}\n                </p>\n              </div>\n            ) : (\n              <div className=\"grid gap-4\">\n                {filteredRoles.map((role: CustomRole) => (\n                  <Card key={role.id} className=\"border-l-4 border-l-primary\">\n                    <CardHeader>\n                      <div className=\"flex justify-between items-start\">\n                        <div className=\"flex-1\">\n                          <div className=\"flex items-center gap-3 mb-2\">\n                            <CardTitle className=\"text-lg\">{role.name}</CardTitle>\n                            {role.isSystemRole && (\n                              <Badge variant=\"secondary\">Sistema</Badge>\n                            )}\n                            {!role.isActive && (\n                              <Badge variant=\"destructive\">Inativo</Badge>\n                            )}\n                            {role.name === 'Operador' && (\n                              <Badge variant=\"outline\" className=\"bg-blue-50 dark:bg-blue-950 text-blue-700 dark:text-blue-300 border-blue-200 dark:border-blue-800\">\n                                📱 Acesso Mobile\n                              </Badge>\n                            )}\n                          </div>\n                          {role.description && (\n                            <CardDescription className=\"mt-2\">\n                              {role.description}\n                            </CardDescription>\n                          )}\n                          {role.name === 'Operador' && (\n                            <div className=\"mt-2 p-2 bg-blue-50 dark:bg-blue-950/30 border border-blue-200 dark:border-blue-800 rounded-md\">\n                              <p className=\"text-xs text-blue-700 dark:text-blue-300\">\n                                ℹ️ Este perfil é exclusivo para <strong>aplicativo mobile</strong>. Operadores não acessam o sistema web administrativo, apenas o app mobile para executar tarefas.\n                              </p>\n                            </div>\n                          )}\n                          \n                          {/* Áreas Acessíveis */}\n                          <div className=\"mt-4 space-y-2\">\n                            <span className=\"text-sm font-medium text-foreground\">\n                              Áreas Acessíveis ({getAccessibleAreas(role.permissions).length}):\n                            </span>\n                            <div className=\"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2\">\n                              {getAccessibleAreas(role.permissions).map((area) => {\n                                const Icon = area.icon;\n                                return (\n                                  <div \n                                    key={area.key}\n                                    className=\"flex items-center gap-2 px-3 py-2 rounded-md bg-primary/5 border border-primary/20 text-sm\"\n                                  >\n                                    <Icon className=\"h-4 w-4 text-primary flex-shrink-0\" />\n                                    <span className=\"text-foreground text-xs\">{area.label}</span>\n                                  </div>\n                                );\n                              })}\n                            </div>\n                          </div>\n\n                          {/* Total de Permissões */}\n                          <div className=\"mt-4 pt-3 border-t\">\n                            <div className=\"flex items-center justify-between text-sm\">\n                              <span className=\"text-muted-foreground\">\n                                Total de permissões:\n                              </span>\n                              <Badge variant=\"secondary\">\n                                {role.permissions.length}\n                              </Badge>\n                            </div>\n                          </div>\n                        </div>\n                        <div className=\"flex space-x-2\">\n                          <Button\n                            variant=\"outline\"\n                            size=\"sm\"\n                            onClick={() => handleEdit(role)}\n                            data-testid={`button-edit-role-${role.id}`}\n                          >\n                            <Edit className=\"h-4 w-4\" />\n                          </Button>\n                          {!role.isSystemRole && (\n                            <Button\n                              variant=\"outline\"\n                              size=\"sm\"\n                              onClick={() => deleteRoleMutation.mutate(role.id)}\n                              disabled={deleteRoleMutation.isPending}\n                              data-testid={`button-delete-role-${role.id}`}\n                            >\n                              <Trash2 className=\"h-4 w-4\" />\n                            </Button>\n                          )}\n                        </div>\n                      </div>\n                    </CardHeader>\n                  </Card>\n                ))}\n              </div>\n            )}\n          </CardContent>\n        </Card>\n    </div>\n  );\n}","size_bytes":19673},"client/src/components/ServiceSelectionModal.tsx":{"content":"import { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Tabs, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { MapPin, Building2, X, Wrench, AlertCircle } from \"lucide-react\";\nimport { useState, useEffect } from \"react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { format, parseISO } from \"date-fns\";\n\ninterface ServiceSelectionModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  resolvedContext: any;\n  scannedQrCode: string;\n  onServiceSelect: (serviceId: string, checklistAnswers?: any, workOrderId?: string) => void;\n}\n\n// Helper para parsear data local sem conversão de timezone\nconst parseLocalDate = (dateString: string | null): Date | null => {\n  if (!dateString) return null;\n  \n  // Se a data já tem horário, use parseISO normal\n  if (dateString.includes('T') || dateString.includes(' ')) {\n    return parseISO(dateString);\n  }\n  \n  // Para datas sem horário (YYYY-MM-DD), criar data local\n  const [year, month, day] = dateString.split('-').map(Number);\n  return new Date(year, month - 1, day);\n};\n\nexport default function ServiceSelectionModal({\n  isOpen,\n  onClose,\n  resolvedContext,\n  scannedQrCode,\n  onServiceSelect,\n}: ServiceSelectionModalProps) {\n  const { toast } = useToast();\n  const [services, setServices] = useState<any[]>([]);\n  const [selectedService, setSelectedService] = useState<string>(\"\");\n  const [isLoadingServices, setIsLoadingServices] = useState(true);\n  const [availableWorkOrders, setAvailableWorkOrders] = useState<any[]>([]);\n  const [isLoadingWorkOrders, setIsLoadingWorkOrders] = useState(false);\n  const [dateFilter, setDateFilter] = useState<'today' | 'upcoming' | 'all' | 'paused'>('all');\n  const [selectedWorkOrder, setSelectedWorkOrder] = useState<string | null>(null);\n\n  useEffect(() => {\n    if (isOpen && resolvedContext?.customer?.id) {\n      loadServices();\n    }\n  }, [isOpen, resolvedContext]);\n\n  useEffect(() => {\n    if (selectedService && resolvedContext?.zone?.id) {\n      loadWorkOrdersForService(selectedService);\n    } else {\n      setAvailableWorkOrders([]);\n      setSelectedWorkOrder(null);\n    }\n  }, [selectedService, resolvedContext]);\n\n  const loadServices = async () => {\n    setIsLoadingServices(true);\n    try {\n      const module = resolvedContext?.qrPoint?.module || 'clean';\n      const response = await fetch(`/api/customers/${resolvedContext.customer.id}/services?module=${module}`);\n      if (response.ok) {\n        const data = await response.json();\n        // Additional filter by module on client side to ensure consistency\n        const filteredData = data.filter((s: any) => s.module === module);\n        setServices(filteredData || []);\n      }\n    } catch (error) {\n      console.error('Erro ao carregar serviços:', error);\n    } finally {\n      setIsLoadingServices(false);\n    }\n  };\n\n  const loadWorkOrdersForService = async (serviceId: string) => {\n    setIsLoadingWorkOrders(true);\n    setSelectedWorkOrder(null);\n    try {\n      const module = resolvedContext?.qrPoint?.module || 'clean';\n      const response = await fetch(`/api/customers/${resolvedContext.customer.id}/work-orders?module=${module}`);\n      if (response.ok) {\n        const allWorkOrders = await response.json();\n        \n        // Filtrar work orders do serviço selecionado, zona atual e módulo correto que estão pendentes ou pausadas\n        const filtered = allWorkOrders.filter((wo: any) => \n          wo.serviceId === serviceId && \n          wo.zoneId === resolvedContext.zone.id &&\n          wo.module === module &&\n          (wo.status === 'aberta' || wo.status === 'em_execucao' || wo.status === 'pausada')\n        );\n        \n        console.log('[SERVICE MODAL] Work orders filtradas por módulo:', module, filtered);\n        setAvailableWorkOrders(filtered);\n      }\n    } catch (error) {\n      console.error('Erro ao carregar work orders:', error);\n    } finally {\n      setIsLoadingWorkOrders(false);\n    }\n  };\n\n  const filteredWorkOrders = availableWorkOrders.filter((wo) => {\n    if (dateFilter === 'paused') {\n      return wo.status === 'pausada';\n    } else if (dateFilter === 'today') {\n      const today = new Date();\n      today.setHours(0, 0, 0, 0);\n      const scheduledDate = parseLocalDate(wo.scheduledDate);\n      return scheduledDate && scheduledDate.toDateString() === today.toDateString();\n    } else if (dateFilter === 'upcoming') {\n      const scheduledDate = parseLocalDate(wo.scheduledDate);\n      return scheduledDate && scheduledDate >= new Date();\n    }\n    return true;\n  });\n\n  const selectedServiceData = services.find(s => s.id === selectedService);\n\n  const handleExecuteExisting = () => {\n    if (!selectedWorkOrder) {\n      toast({\n        title: \"Selecione uma OS\",\n        description: \"Escolha uma ordem de serviço para executar\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    console.log(\"✅ Executando OS existente:\", selectedWorkOrder);\n    onServiceSelect(selectedService, undefined, selectedWorkOrder);\n  };\n\n  if (!isOpen) return null;\n\n  return (\n    <div \n      className=\"fixed inset-0 z-[9999] flex items-center justify-center p-4\"\n      style={{ \n        backgroundColor: 'rgba(0, 0, 0, 0.8)',\n        backdropFilter: 'blur(8px)'\n      }}\n    >\n      <Card className=\"w-full max-w-lg max-h-[90vh] bg-white shadow-2xl flex flex-col\">\n        <CardHeader className=\"relative pb-4 flex-shrink-0\">\n          <Button\n            variant=\"ghost\"\n            size=\"icon\"\n            className=\"absolute right-4 top-4\"\n            onClick={onClose}\n            data-testid=\"button-close-modal\"\n          >\n            <X className=\"w-5 h-5\" />\n          </Button>\n          \n          <CardTitle className=\"text-2xl font-bold text-slate-900\">\n            Executar Serviço\n          </CardTitle>\n          \n          <div className=\"mt-4 space-y-2\">\n            <div className=\"flex items-center gap-2 text-sm text-slate-600\">\n              <Building2 className=\"w-4 h-4\" />\n              <span className=\"font-medium\">{resolvedContext?.site?.name}</span>\n            </div>\n            <div className=\"flex items-center gap-2 text-sm text-slate-600\">\n              <MapPin className=\"w-4 h-4\" />\n              <span className=\"font-medium\">{resolvedContext?.zone?.name}</span>\n            </div>\n            {resolvedContext?.qrPoint && (\n              <Badge variant=\"outline\" className=\"text-xs\">\n                Ponto: {resolvedContext.qrPoint.name || resolvedContext.qrPoint.code}\n              </Badge>\n            )}\n          </div>\n        </CardHeader>\n\n        <CardContent className=\"space-y-6 overflow-y-auto flex-1\">\n          {/* Selecionar Serviço */}\n          <div className=\"space-y-3\">\n            <h3 className=\"font-semibold text-slate-900\">\n              Selecione o Serviço\n            </h3>\n            \n            {isLoadingServices ? (\n              <div className=\"text-center py-4 text-slate-500\">\n                Carregando serviços...\n              </div>\n            ) : services.length === 0 ? (\n              <div className=\"text-center py-4 text-slate-500\">\n                Nenhum serviço disponível\n              </div>\n            ) : (\n              <Select value={selectedService} onValueChange={setSelectedService}>\n                <SelectTrigger data-testid=\"select-service\" className=\"w-full\">\n                  <SelectValue placeholder=\"Escolha o tipo de serviço\" />\n                </SelectTrigger>\n                <SelectContent className=\"z-[99999]\">\n                  {services.map((service) => (\n                    <SelectItem key={service.id} value={service.id}>\n                      {service.name}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            )}\n          </div>\n\n          {/* Mostrar lista de work orders após selecionar serviço */}\n          {selectedService && (\n            <div className=\"space-y-4 border-t pt-4\">\n              {isLoadingWorkOrders ? (\n                <div className=\"text-center py-4 text-slate-500\">\n                  Buscando ordens de serviço...\n                </div>\n              ) : availableWorkOrders.length === 0 ? (\n                <div className=\"border rounded-lg p-6 bg-blue-50 border-blue-200 text-center space-y-4\">\n                  <AlertCircle className=\"w-12 h-12 text-blue-500 mx-auto\" />\n                  <div>\n                    <h4 className=\"font-semibold text-slate-900 mb-1\">\n                      Nenhuma OS Disponível\n                    </h4>\n                    <p className=\"text-sm text-slate-600\">\n                      Não há ordens de serviço pendentes de <strong>{selectedServiceData?.name}</strong> neste local.\n                    </p>\n                    <p className=\"text-sm text-slate-600 mt-2\">\n                      Você pode criar uma nova ordem de serviço corretiva agora.\n                    </p>\n                  </div>\n                  <Button\n                    onClick={() => onServiceSelect(selectedService)}\n                    className=\"w-full bg-blue-600 hover:bg-blue-700\"\n                    data-testid=\"button-create-corrective-os\"\n                  >\n                    <Wrench className=\"w-4 h-4 mr-2\" />\n                    Criar Nova OS Corretiva\n                  </Button>\n                </div>\n              ) : (\n                <div className=\"border rounded-lg p-4 space-y-3 bg-amber-50 border-amber-200\">\n                  <div className=\"flex items-center gap-2\">\n                    <Wrench className=\"w-5 h-5 text-amber-600\" />\n                    <h4 className=\"font-semibold text-slate-900\">\n                      Selecione a Ordem de Serviço\n                    </h4>\n                  </div>\n                  \n                  <p className=\"text-sm text-slate-600\">\n                    Encontramos {availableWorkOrders.length} ordem(ns) pendente(s) de <strong>{selectedServiceData?.name}</strong> neste local\n                  </p>\n                  \n                  {/* Filtros por data */}\n                  <Tabs value={dateFilter} onValueChange={(v) => setDateFilter(v as any)} className=\"w-full\">\n                    <TabsList className=\"grid w-full grid-cols-4\">\n                      <TabsTrigger value=\"today\" className=\"text-xs\">\n                        Hoje\n                      </TabsTrigger>\n                      <TabsTrigger value=\"upcoming\" className=\"text-xs\">\n                        Próximos\n                      </TabsTrigger>\n                      <TabsTrigger value=\"paused\" className=\"text-xs\">\n                        Pausadas\n                      </TabsTrigger>\n                      <TabsTrigger value=\"all\" className=\"text-xs\">\n                        Todos\n                      </TabsTrigger>\n                    </TabsList>\n                  </Tabs>\n                  \n                  {/* Lista de OS */}\n                  {filteredWorkOrders.length === 0 ? (\n                    <div className=\"text-center py-6 text-slate-500 text-sm\">\n                      {dateFilter === 'today' && 'Nenhuma ordem agendada para hoje'}\n                      {dateFilter === 'upcoming' && 'Nenhuma ordem agendada'}\n                      {dateFilter === 'paused' && 'Nenhuma ordem pausada'}\n                      {dateFilter === 'all' && 'Nenhuma ordem pendente'}\n                    </div>\n                  ) : (\n                    <div className=\"space-y-2 max-h-64 overflow-y-auto\">\n                      {filteredWorkOrders.map((wo) => {\n                        const isSelected = selectedWorkOrder === wo.id;\n                        const scheduledDate = parseLocalDate(wo.scheduledDate);\n                        const isToday = scheduledDate && \n                          scheduledDate.toDateString() === new Date().toDateString();\n                        \n                        return (\n                          <button\n                            key={wo.id}\n                            onClick={() => setSelectedWorkOrder(wo.id)}\n                            className={`w-full text-left p-3 rounded-lg border-2 transition-all ${\n                              isSelected \n                                ? 'border-amber-600 bg-white shadow-md' \n                                : 'border-slate-200 bg-white hover:border-amber-300'\n                            }`}\n                            data-testid={`wo-card-${wo.id}`}\n                          >\n                            <div className=\"flex items-start justify-between gap-2\">\n                              <div className=\"flex-1 min-w-0\">\n                                <div className=\"flex items-center gap-2 mb-1 flex-wrap\">\n                                  <span className=\"font-semibold text-slate-900\">\n                                    OS #{wo.number}\n                                  </span>\n                                  {wo.status === 'pausada' && (\n                                    <Badge className=\"bg-orange-600 text-white text-xs\">\n                                      ⏸ PAUSADA\n                                    </Badge>\n                                  )}\n                                  {isToday && (\n                                    <Badge className=\"bg-green-600 text-white text-xs\">\n                                      HOJE\n                                    </Badge>\n                                  )}\n                                  {wo.priority === 'alta' && (\n                                    <Badge variant=\"destructive\" className=\"text-xs\">\n                                      Urgente\n                                    </Badge>\n                                  )}\n                                </div>\n                                <p className=\"text-sm text-slate-600 truncate\">\n                                  {wo.title}\n                                </p>\n                                {scheduledDate && (\n                                  <p className=\"text-xs text-slate-500 mt-1\">\n                                    Agendada: {format(scheduledDate, 'dd/MM/yyyy HH:mm')}\n                                  </p>\n                                )}\n                              </div>\n                              {isSelected && (\n                                <div className=\"flex-shrink-0\">\n                                  <div className=\"w-6 h-6 rounded-full bg-amber-600 flex items-center justify-center\">\n                                    <svg className=\"w-4 h-4 text-white\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\n                                    </svg>\n                                  </div>\n                                </div>\n                              )}\n                            </div>\n                          </button>\n                        );\n                      })}\n                    </div>\n                  )}\n                  \n                  <div className=\"grid grid-cols-2 gap-3\">\n                    <Button\n                      onClick={handleExecuteExisting}\n                      disabled={!selectedWorkOrder}\n                      className=\"bg-amber-600 hover:bg-amber-700 disabled:opacity-50\"\n                      data-testid=\"button-execute-existing\"\n                    >\n                      <Wrench className=\"w-4 h-4 mr-2\" />\n                      Executar OS\n                    </Button>\n                    <Button\n                      onClick={() => onServiceSelect(selectedService)}\n                      variant=\"outline\"\n                      className=\"border-blue-600 text-blue-600 hover:bg-blue-50\"\n                      data-testid=\"button-create-new-os\"\n                    >\n                      Criar Nova OS\n                    </Button>\n                  </div>\n                </div>\n              )}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":16254},"diagnostico-vm.sh":{"content":"#!/bin/bash\necho \"🔍 DIAGNÓSTICO VM\"\necho \"================\"\n\necho \"\"\necho \"1️⃣ Servidor:\"\ncurl -s -o /dev/null -w \"HTTP %{http_code}\\n\" http://localhost:3007/\n\necho \"\"\necho \"2️⃣ HTML:\"\ncurl -s http://localhost:3007/ | grep -o '<html' && echo \"✅ OK\" || echo \"❌ ERRO\"\n\necho \"\"\necho \"3️⃣ Assets JS:\"\nJS=$(curl -s http://localhost:3007/ | grep -o '/assets/index-[^\"]*\\.js' | head -1)\necho \"Arquivo: $JS\"\ncurl -s -o /dev/null -w \"HTTP %{http_code}\\n\" \"http://localhost:3007$JS\"\n\necho \"\"\necho \"4️⃣ Arquivos compilados:\"\nls -lh dist/public/index.html 2>/dev/null && echo \"✅ index.html OK\" || echo \"❌ Falta index.html\"\nls -lh dist/index.js 2>/dev/null && echo \"✅ backend OK\" || echo \"❌ Falta backend\"\necho \"Assets: $(ls dist/public/assets/*.js 2>/dev/null | wc -l) arquivos JS\"\n\necho \"\"\necho \"5️⃣ PM2:\"\npm2 list | grep newfacilities\n","size_bytes":861},"client/src/components/ui/card.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Card = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"rounded-lg border bg-card text-card-foreground shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nCard.displayName = \"Card\"\n\nconst CardHeader = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex flex-col space-y-1.5 p-6\", className)}\n    {...props}\n  />\n))\nCardHeader.displayName = \"CardHeader\"\n\nconst CardTitle = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"text-2xl font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nCardTitle.displayName = \"CardTitle\"\n\nconst CardDescription = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nCardDescription.displayName = \"CardDescription\"\n\nconst CardContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\n))\nCardContent.displayName = \"CardContent\"\n\nconst CardFooter = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex items-center p-6 pt-0\", className)}\n    {...props}\n  />\n))\nCardFooter.displayName = \"CardFooter\"\n\nexport { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }\n","size_bytes":1858},"client/src/pages/work-orders.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Popover, PopoverContent, PopoverTrigger } from \"@/components/ui/popover\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useState } from \"react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useClient } from \"@/contexts/ClientContext\";\nimport { useModule } from \"@/contexts/ModuleContext\";\nimport { useModuleTheme } from \"@/hooks/use-module-theme\";\nimport { ModernCard, ModernCardHeader, ModernCardContent } from \"@/components/ui/modern-card\";\nimport { ModernPageHeader } from \"@/components/ui/modern-page-header\";\nimport { \n  Plus, \n  Eye, \n  Search, \n  Trash2, \n  Clock, \n  AlertTriangle, \n  CheckCircle2, \n  RefreshCw,\n  Calendar,\n  Filter,\n  Edit,\n  ChevronDown,\n  X,\n  MapPin,\n  PauseCircle,\n  ClipboardList\n} from \"lucide-react\";\nimport WorkOrderModal from \"@/components/work-order-modal\";\nimport CreateWorkOrderModal from \"@/components/create-work-order-modal\";\nimport { cn } from \"@/lib/utils\";\n\ninterface MultiSelectOption {\n  value: string;\n  label: string;\n}\n\ninterface MultiSelectProps {\n  options: MultiSelectOption[];\n  selected: string[];\n  onChange: (selected: string[]) => void;\n  placeholder: string;\n  testId?: string;\n}\n\nfunction MultiSelect({ options, selected, onChange, placeholder, testId }: MultiSelectProps) {\n  const [open, setOpen] = useState(false);\n  \n  const toggleOption = (value: string) => {\n    if (selected.includes(value)) {\n      onChange(selected.filter(v => v !== value));\n    } else {\n      onChange([...selected, value]);\n    }\n  };\n\n  const clearAll = () => {\n    onChange([]);\n  };\n\n  const getDisplayText = () => {\n    if (selected.length === 0) return placeholder;\n    if (selected.length === 1) {\n      const option = options.find(o => o.value === selected[0]);\n      return option?.label || placeholder;\n    }\n    return `${selected.length} selecionados`;\n  };\n\n  return (\n    <Popover open={open} onOpenChange={setOpen}>\n      <PopoverTrigger asChild>\n        <Button\n          variant=\"outline\"\n          role=\"combobox\"\n          aria-expanded={open}\n          className=\"w-[200px] justify-between font-normal\"\n          data-testid={testId}\n        >\n          <span className=\"truncate\">{getDisplayText()}</span>\n          <div className=\"flex items-center gap-1\">\n            {selected.length > 0 && (\n              <X \n                className=\"h-4 w-4 opacity-50 hover:opacity-100\" \n                onClick={(e) => {\n                  e.stopPropagation();\n                  clearAll();\n                }}\n              />\n            )}\n            <ChevronDown className=\"h-4 w-4 opacity-50\" />\n          </div>\n        </Button>\n      </PopoverTrigger>\n      <PopoverContent className=\"w-[200px] p-2\" align=\"start\">\n        <div className=\"space-y-2\">\n          {options.map((option) => (\n            <div\n              key={option.value}\n              className=\"flex items-center space-x-2 hover:bg-gray-100 p-2 rounded cursor-pointer\"\n              onClick={() => toggleOption(option.value)}\n              data-testid={`${testId}-option-${option.value}`}\n            >\n              <Checkbox\n                checked={selected.includes(option.value)}\n                onCheckedChange={() => toggleOption(option.value)}\n              />\n              <label className=\"text-sm cursor-pointer flex-1\">\n                {option.label}\n              </label>\n            </div>\n          ))}\n        </div>\n      </PopoverContent>\n    </Popover>\n  );\n}\n\nexport default function WorkOrders() {\n  const { activeClientId } = useClient();\n  const { currentModule } = useModule();\n  const theme = useModuleTheme();\n  const [selectedWorkOrder, setSelectedWorkOrder] = useState<string | null>(null);\n  const [showCreateModal, setShowCreateModal] = useState(false);\n  const [statusFilter, setStatusFilter] = useState<string[]>([]);\n  const [zoneFilter, setZoneFilter] = useState<string[]>([]);\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const [startDate, setStartDate] = useState(\"\");\n  const [endDate, setEndDate] = useState(\"\");\n  const [lastUpdate, setLastUpdate] = useState(new Date());\n  const [isRefreshing, setIsRefreshing] = useState(false);\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  const { data: workOrders, isLoading, refetch } = useQuery({\n    queryKey: [\"/api/customers\", activeClientId, \"work-orders\", { module: currentModule }],\n    enabled: !!activeClientId,\n  });\n\n  const { data: zones } = useQuery({\n    queryKey: [\"/api/customers\", activeClientId, \"zones\", { module: currentModule }],\n    enabled: !!activeClientId,\n  });\n\n  const { data: users } = useQuery({\n    queryKey: [\"/api/customers\", activeClientId, \"users\"],\n    enabled: !!activeClientId,\n  });\n\n  const deleteWorkOrderMutation = useMutation({\n    mutationFn: async (workOrderId: string) => {\n      return await apiRequest(\"DELETE\", `/api/customers/${activeClientId}/work-orders/${workOrderId}`);\n    },\n    onSuccess: () => {\n      toast({ title: \"Ordem de serviço deletada com sucesso\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/customers\", activeClientId, \"work-orders\"] });\n    },\n    onError: () => {\n      toast({ \n        title: \"Erro ao deletar ordem de serviço\", \n        variant: \"destructive\" \n      });\n    },\n  });\n\n  const handleDeleteWorkOrder = (workOrderId: string, workOrderTitle: string) => {\n    if (window.confirm(`Tem certeza que deseja deletar a OS \"${workOrderTitle}\"? Esta ação não pode ser desfeita.`)) {\n      deleteWorkOrderMutation.mutate(workOrderId);\n    }\n  };\n\n  const handleRefresh = () => {\n    setIsRefreshing(true);\n    refetch();\n    setLastUpdate(new Date());\n    setTimeout(() => setIsRefreshing(false), 1000);\n  };\n\n  const getStatusBadge = (status: string) => {\n    switch (status) {\n      case \"aberta\":\n        return <Badge className=\"bg-blue-600 text-white border-0\">Aberta</Badge>;\n      case \"em_execucao\":\n        return <Badge className=\"bg-yellow-600 text-white border-0\">Em Execução</Badge>;\n      case \"pausada\":\n        return <Badge className=\"bg-orange-600 text-white border-0\">Pausada</Badge>;\n      case \"vencida\":\n        return <Badge className=\"bg-red-600 text-white border-0\">Vencida</Badge>;\n      case \"concluida\":\n        return <Badge className=\"bg-green-600 text-white border-0\">Concluída</Badge>;\n      case \"cancelada\":\n        return <Badge className=\"bg-gray-500 text-white border-0\">Cancelada</Badge>;\n      default:\n        return <Badge className=\"bg-blue-600 text-white border-0\">Aberta</Badge>;\n    }\n  };\n\n  const getPriorityBadge = (priority: string) => {\n    switch (priority) {\n      case \"critica\":\n        return <Badge className=\"bg-red-500 text-white border-0\">Crítica</Badge>;\n      case \"alta\":\n        return <Badge className=\"bg-orange-500 text-white border-0\">Alta</Badge>;\n      case \"media\":\n        return <Badge className=\"bg-yellow-500 text-white border-0\">Média</Badge>;\n      default:\n        return <Badge className=\"bg-blue-500 text-white border-0\">Baixa</Badge>;\n    }\n  };\n\n  const getTypeLabel = (orderType: string) => {\n    switch (orderType) {\n      case \"programada\":\n        return \"Programada\";\n      case \"corretiva_interna\":\n        return \"Corretiva Interna\";\n      case \"corretiva_publica\":\n        return \"Corretiva Pública\";\n      default:\n        return \"N/A\";\n    }\n  };\n\n  const filteredWorkOrders = (workOrders as any[])?.filter((wo: any) => {\n    const matchesStatus = statusFilter.length === 0 || statusFilter.includes(wo.status);\n    const matchesZone = zoneFilter.length === 0 || zoneFilter.includes(wo.zoneId);\n    const matchesSearch = wo.title?.toLowerCase().includes(searchTerm.toLowerCase()) ||\n                         wo.number?.toString().includes(searchTerm) ||\n                         wo.id?.toString().includes(searchTerm);\n    \n    let matchesDateRange = true;\n    if (startDate || endDate) {\n      const scheduledDate = wo.scheduledDate ? new Date(wo.scheduledDate) : null;\n      if (scheduledDate) {\n        if (startDate) {\n          const start = new Date(startDate);\n          start.setHours(0, 0, 0, 0);\n          if (scheduledDate < start) matchesDateRange = false;\n        }\n        if (endDate) {\n          const end = new Date(endDate);\n          end.setHours(23, 59, 59, 999);\n          if (scheduledDate > end) matchesDateRange = false;\n        }\n      } else {\n        matchesDateRange = false;\n      }\n    }\n    \n    return matchesStatus && matchesZone && matchesSearch && matchesDateRange;\n  }).sort((a: any, b: any) => {\n    if (a.scheduledDate && b.scheduledDate) {\n      return new Date(a.scheduledDate).getTime() - new Date(b.scheduledDate).getTime();\n    }\n    if (a.scheduledDate) return -1;\n    if (b.scheduledDate) return 1;\n    return 0;\n  }) || [];\n\n  const totalAbertas = (workOrders as any[])?.filter((wo: any) => \n    wo.status === 'aberta' || wo.status === 'atrasada'\n  ).length || 0;\n  \n  const totalVencidas = (workOrders as any[])?.filter((wo: any) => \n    wo.status === 'vencida'\n  ).length || 0;\n  \n  const totalPausadas = (workOrders as any[])?.filter((wo: any) => \n    wo.status === 'pausada'\n  ).length || 0;\n  \n  const totalConcluidas = (workOrders as any[])?.filter((wo: any) => \n    wo.status === 'concluida'\n  ).length || 0;\n\n  // Descrição dinâmica baseada no módulo\n  const headerDescription = currentModule === 'maintenance' \n    ? \"Gerenciamento de ordens de serviço de manutenção\" \n    : \"Gerenciamento de ordens de serviço de limpeza\";\n\n  if (isLoading) {\n    return (\n      <div className={cn(\"flex-1 flex items-center justify-center\", theme.gradients.subtle)}>\n        <div className=\"text-center\">\n          <div className={cn(\n            \"w-16 h-16 border-4 border-t-transparent rounded-full animate-spin mx-auto mb-4\",\n            theme.borders.primary\n          )}></div>\n          <p className=\"text-slate-600 font-medium\">Carregando ordens de serviço...</p>\n        </div>\n      </div>\n    );\n  }\n\n  const getZoneName = (zoneId: string) => {\n    const zone = (zones as any[])?.find((z: any) => z.id === zoneId);\n    return zone?.name || \"N/A\";\n  };\n\n  const getUserName = (userId: string) => {\n    const user = (users as any[])?.find((u: any) => u.id === userId);\n    return user?.name || \"Não atribuído\";\n  };\n\n  // Formata data sem problemas de timezone\n  const formatDateOnly = (dateString: string | null | undefined) => {\n    if (!dateString) return '-';\n    // Se já é uma string no formato YYYY-MM-DD, formata diretamente\n    const match = dateString.match(/^(\\d{4})-(\\d{2})-(\\d{2})/);\n    if (match) {\n      const [, year, month, day] = match;\n      return `${day}/${month}/${year}`;\n    }\n    // Fallback para conversão normal\n    return new Date(dateString).toLocaleDateString('pt-BR');\n  };\n\n  return (\n    <>\n      <ModernPageHeader \n        title=\"Ordens de Serviço\"\n        description={headerDescription}\n        icon={ClipboardList}\n        stats={[\n          { label: \"Abertas\", value: totalAbertas, icon: Clock },\n          { label: \"Vencidas\", value: totalVencidas, icon: AlertTriangle },\n          { label: \"Pausadas\", value: totalPausadas, icon: PauseCircle },\n          { label: \"Concluídas\", value: totalConcluidas, icon: CheckCircle2 }\n        ]}\n        actions={\n          <>\n            <Button \n              variant=\"outline\" \n              size=\"sm\" \n              onClick={handleRefresh}\n              className={cn(\"flex items-center gap-2\", theme.buttons.outline)}\n              data-testid=\"button-refresh\"\n            >\n              <RefreshCw className={`w-4 h-4 transition-transform duration-1000 ${isRefreshing ? 'rotate-360' : ''}`} />\n              Atualizar\n            </Button>\n            <Button \n              onClick={() => setShowCreateModal(true)} \n              className={theme.buttons.primary}\n              data-testid=\"button-create-work-order\"\n            >\n              <Plus className=\"w-4 h-4 mr-2\" />\n              Nova OS\n            </Button>\n          </>\n        }\n      />\n      \n      <main className={cn(\"flex-1 overflow-auto p-6\", theme.gradients.subtle)}>\n        <div className=\"max-w-7xl mx-auto space-y-6\">\n          {/* Info de última atualização */}\n          <div className={cn(\n            \"backdrop-blur-xl bg-white/60 rounded-lg px-4 py-2 w-fit border\",\n            theme.borders.light\n          )}>\n            <span className=\"text-sm text-slate-600 flex items-center gap-2\">\n              <Clock className=\"w-3.5 h-3.5\" />\n              Última atualização: {lastUpdate.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}\n            </span>\n          </div>\n\n          {/* Busca e Filtros */}\n          <ModernCard variant=\"gradient\">\n            <ModernCardHeader icon={<Search className={cn(\"w-5 h-5\", theme.text.primary)} />}>\n              Buscar e Filtrar\n            </ModernCardHeader>\n            <ModernCardContent>\n              {/* Busca */}\n              <div className=\"mb-6\">\n                <div className=\"relative\">\n                  <Search className={cn(\"absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5\", theme.text.light)} />\n                  <Input\n                    placeholder=\"Digite o número da OS, título ou descrição...\"\n                    value={searchTerm}\n                    onChange={(e) => setSearchTerm(e.target.value)}\n                    className={cn(\n                      \"pl-12 h-12 bg-white/80 backdrop-blur-sm border-2 text-base shadow-sm transition-all duration-200\",\n                      theme.borders.light,\n                      \"focus:border-current focus:ring-2 focus:ring-opacity-20\"\n                    )}\n                    style={{\n                      borderColor: searchTerm ? theme.primaryHex : undefined,\n                      outlineColor: theme.primaryHex + '33'\n                    }}\n                    data-testid=\"input-search-work-orders\"\n                  />\n                </div>\n              </div>\n\n              {/* Filtros Rápidos */}\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 mb-6\">\n                <div>\n                  <label className={cn(\"text-xs font-semibold uppercase tracking-wide mb-2 block flex items-center gap-2\", theme.text.dark)}>\n                    <Filter className={cn(\"w-3.5 h-3.5\", theme.text.primary)} />\n                    Status\n                  </label>\n                  <MultiSelect\n                    options={[\n                      { value: \"aberta\", label: \"Abertas\" },\n                      { value: \"em_execucao\", label: \"Em Execução\" },\n                      { value: \"pausada\", label: \"Pausadas\" },\n                      { value: \"vencida\", label: \"Vencidas\" },\n                      { value: \"concluida\", label: \"Concluídas\" },\n                      { value: \"cancelada\", label: \"Canceladas\" }\n                    ]}\n                    selected={statusFilter}\n                    onChange={setStatusFilter}\n                    placeholder=\"Todos os Status\"\n                    testId=\"select-status-filter\"\n                  />\n                </div>\n                \n                <div>\n                  <label className={cn(\"text-xs font-semibold uppercase tracking-wide mb-2 block flex items-center gap-2\", theme.text.dark)}>\n                    <MapPin className={cn(\"w-3.5 h-3.5\", theme.text.primary)} />\n                    Zonas\n                  </label>\n                  <MultiSelect\n                    options={(zones as any[] || []).map((zone: any) => ({\n                      value: zone.id,\n                      label: zone.name\n                    }))}\n                    selected={zoneFilter}\n                    onChange={setZoneFilter}\n                    placeholder=\"Todas as Zonas\"\n                    testId=\"select-zone-filter\"\n                  />\n                </div>\n              </div>\n\n              {/* Filtro de Período */}\n              <div className={cn(\n                \"backdrop-blur-sm bg-white/60 border rounded-lg p-4\",\n                theme.borders.light\n              )}>\n                <label className={cn(\"text-xs font-semibold uppercase tracking-wide mb-3 block flex items-center gap-2\", theme.text.dark)}>\n                  <Calendar className={cn(\"w-3.5 h-3.5\", theme.text.primary)} />\n                  Filtrar por Período de Agendamento\n                </label>\n                <div className=\"flex flex-wrap items-center gap-4\">\n                  <div className=\"flex items-center gap-3 flex-1 min-w-[200px]\">\n                    <span className=\"text-sm font-medium text-slate-600 whitespace-nowrap\">De:</span>\n                    <Input\n                      type=\"date\"\n                      value={startDate}\n                      onChange={(e) => setStartDate(e.target.value)}\n                      className=\"flex-1 border-slate-300 focus:ring-2 focus:ring-opacity-20 shadow-sm\"\n                      data-testid=\"input-start-date\"\n                    />\n                  </div>\n                  <div className=\"flex items-center gap-3 flex-1 min-w-[200px]\">\n                    <span className=\"text-sm font-medium text-slate-600 whitespace-nowrap\">Até:</span>\n                    <Input\n                      type=\"date\"\n                      value={endDate}\n                      onChange={(e) => setEndDate(e.target.value)}\n                      className=\"flex-1 border-slate-300 focus:ring-2 focus:ring-opacity-20 shadow-sm\"\n                      data-testid=\"input-end-date\"\n                    />\n                  </div>\n                </div>\n              </div>\n            </ModernCardContent>\n          </ModernCard>\n\n          {/* Tabela de Ordens de Serviço */}\n          <ModernCard>\n            <ModernCardHeader icon={<ClipboardList className={cn(\"w-5 h-5\", theme.text.primary)} />}>\n              Lista de Ordens de Serviço\n            </ModernCardHeader>\n            <ModernCardContent>\n              \n              {filteredWorkOrders.length === 0 ? (\n                <div className=\"text-center py-12\">\n                  <p className=\"text-gray-500\">Nenhuma ordem de serviço encontrada</p>\n                </div>\n              ) : (\n                <div className=\"overflow-x-auto\">\n                  <table className=\"w-full\">\n                    <thead>\n                      <tr className=\"border-b border-gray-200\">\n                        <th className=\"text-left py-3 px-4 text-sm font-semibold text-gray-600\">ID</th>\n                        <th className=\"text-left py-3 px-4 text-sm font-semibold text-gray-600\">Tipo</th>\n                        <th className=\"text-left py-3 px-4 text-sm font-semibold text-gray-600\">Local</th>\n                        <th className=\"text-left py-3 px-4 text-sm font-semibold text-gray-600\">Título</th>\n                        <th className=\"text-left py-3 px-4 text-sm font-semibold text-gray-600\">Responsável</th>\n                        <th className=\"text-left py-3 px-4 text-sm font-semibold text-gray-600\">Prioridade</th>\n                        <th className=\"text-left py-3 px-4 text-sm font-semibold text-gray-600\">Status</th>\n                        <th className=\"text-left py-3 px-4 text-sm font-semibold text-gray-600\">Data Agendada</th>\n                        <th className=\"text-left py-3 px-4 text-sm font-semibold text-gray-600\">Criada em</th>\n                        <th className=\"text-left py-3 px-4 text-sm font-semibold text-gray-600\">Ações</th>\n                      </tr>\n                    </thead>\n                    <tbody>\n                      {filteredWorkOrders.map((wo: any) => (\n                        <tr \n                          key={wo.id} \n                          className=\"border-b border-gray-100 hover:bg-gray-50 transition-colors\"\n                          data-testid={`row-work-order-${wo.id}`}\n                        >\n                          <td className=\"py-3 px-4 text-sm font-medium text-gray-900\" data-testid={`text-id-${wo.id}`}>\n                            #{wo.number || wo.id?.slice(0, 3)}\n                          </td>\n                          <td className=\"py-3 px-4 text-sm text-gray-600\" data-testid={`text-type-${wo.id}`}>\n                            {getTypeLabel(wo.type)}\n                          </td>\n                          <td className=\"py-3 px-4 text-sm text-gray-600\" data-testid={`text-zone-${wo.id}`}>\n                            {getZoneName(wo.zoneId)}\n                          </td>\n                          <td className=\"py-3 px-4 text-sm text-gray-900\" data-testid={`text-title-${wo.id}`}>\n                            {wo.title || 'Sem título'}\n                          </td>\n                          <td className=\"py-3 px-4 text-sm text-gray-600\" data-testid={`text-operator-${wo.id}`}>\n                            {getUserName(wo.assignedUserId)}\n                          </td>\n                          <td className=\"py-3 px-4\" data-testid={`badge-priority-${wo.id}`}>\n                            {getPriorityBadge(wo.priority)}\n                          </td>\n                          <td className=\"py-3 px-4\" data-testid={`badge-status-${wo.id}`}>\n                            {getStatusBadge(wo.status)}\n                          </td>\n                          <td className=\"py-3 px-4 text-sm text-gray-600\" data-testid={`text-date-${wo.id}`}>\n                            {formatDateOnly(wo.scheduledDate)}\n                          </td>\n                          <td className=\"py-3 px-4 text-sm text-gray-600\" data-testid={`text-created-${wo.id}`}>\n                            {wo.createdAt ? new Date(wo.createdAt).toLocaleDateString('pt-BR') : '-'}\n                          </td>\n                          <td className=\"py-3 px-4\">\n                            <div className=\"flex items-center gap-2\">\n                              <Button\n                                variant=\"ghost\"\n                                size=\"sm\"\n                                onClick={() => setSelectedWorkOrder(wo.id)}\n                                className={cn(\n                                  \"hover:scale-110 transition-transform\",\n                                  theme.text.primary,\n                                  `hover:${theme.backgrounds.light}`\n                                )}\n                                data-testid={`button-view-${wo.id}`}\n                              >\n                                <Eye className=\"w-4 h-4\" />\n                              </Button>\n                              <Button\n                                variant=\"ghost\"\n                                size=\"sm\"\n                                onClick={() => handleDeleteWorkOrder(wo.id, wo.title)}\n                                className=\"text-red-600 hover:text-red-700 hover:bg-red-50 hover:scale-110 transition-transform\"\n                                data-testid={`button-delete-${wo.id}`}\n                              >\n                                <Trash2 className=\"w-4 h-4\" />\n                              </Button>\n                            </div>\n                          </td>\n                        </tr>\n                      ))}\n                    </tbody>\n                  </table>\n                </div>\n              )}\n            </ModernCardContent>\n          </ModernCard>\n        </div>\n      </main>\n\n      {selectedWorkOrder && (\n        <WorkOrderModal\n          workOrderId={selectedWorkOrder}\n          onClose={() => setSelectedWorkOrder(null)}\n        />\n      )}\n      {showCreateModal && activeClientId && (\n        <CreateWorkOrderModal\n          customerId={activeClientId}\n          onClose={() => setShowCreateModal(false)}\n          onSuccess={() => {\n            setShowCreateModal(false);\n            queryClient.invalidateQueries({ queryKey: [\"/api/customers\", activeClientId, \"work-orders\"] });\n          }}\n        />\n      )}\n    </>\n  );\n}\n","size_bytes":24200},"client/src/pages/audit-logs.tsx":{"content":"import Header from \"@/components/layout/header\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { useState } from \"react\";\nimport { \n  Search, \n  Calendar, \n  Clock, \n  User,\n  Activity,\n  Filter,\n  Download,\n  Eye,\n  AlertCircle,\n  CheckCircle,\n  XCircle,\n  Info\n} from \"lucide-react\";\n\ninterface AuditLogsProps {\n  companyId: string;\n}\n\nexport default function AuditLogs({ companyId }: AuditLogsProps) {\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const [actionFilter, setActionFilter] = useState(\"todas\");\n  const [userFilter, setUserFilter] = useState(\"todos\");\n  const [dateFilter, setDateFilter] = useState(\"todos\");\n  \n  const { data: auditLogs, isLoading } = useQuery({\n    queryKey: [\"/api/companies\", companyId, \"audit-logs\"],\n    enabled: !!companyId,\n  });\n\n  const { data: users } = useQuery({\n    queryKey: [\"/api/companies\", companyId, \"users\"],\n    enabled: !!companyId,\n  });\n\n  const getActionBadge = (action: string) => {\n    switch (action.toLowerCase()) {\n      case \"create\":\n        return <Badge className=\"bg-green-100 text-green-800\"><CheckCircle className=\"w-3 h-3 mr-1\" />Criação</Badge>;\n      case \"update\":\n        return <Badge className=\"bg-blue-100 text-blue-800\"><Info className=\"w-3 h-3 mr-1\" />Atualização</Badge>;\n      case \"delete\":\n        return <Badge className=\"bg-red-100 text-red-800\"><XCircle className=\"w-3 h-3 mr-1\" />Exclusão</Badge>;\n      case \"login\":\n        return <Badge className=\"bg-purple-100 text-purple-800\"><User className=\"w-3 h-3 mr-1\" />Login</Badge>;\n      case \"logout\":\n        return <Badge className=\"bg-gray-100 text-gray-800\"><User className=\"w-3 h-3 mr-1\" />Logout</Badge>;\n      default:\n        return <Badge variant=\"outline\"><Activity className=\"w-3 h-3 mr-1\" />{action}</Badge>;\n    }\n  };\n\n  const getEntityName = (entityType: string, entityId: string) => {\n    // Simplified entity name resolution - in real implementation would lookup actual entities\n    return `${entityType}#${entityId.slice(0, 8)}`;\n  };\n\n  const getUserName = (userId: string) => {\n    const user = (users as any[] || []).find((u: any) => u.id === userId);\n    return user?.name || 'Usuário não encontrado';\n  };\n\n  const formatTimestamp = (timestamp: string) => {\n    const date = new Date(timestamp);\n    return {\n      date: date.toLocaleDateString('pt-BR'),\n      time: date.toLocaleTimeString('pt-BR', { \n        hour: '2-digit', \n        minute: '2-digit' \n      })\n    };\n  };\n\n  const filteredLogs = (auditLogs as any[] || []).filter((log: any) => {\n    const matchesSearch = searchTerm === \"\" || \n      log.action.toLowerCase().includes(searchTerm.toLowerCase()) ||\n      log.entityType.toLowerCase().includes(searchTerm.toLowerCase()) ||\n      getUserName(log.userId).toLowerCase().includes(searchTerm.toLowerCase());\n    \n    const matchesAction = actionFilter === \"todas\" || log.action.toLowerCase() === actionFilter;\n    const matchesUser = userFilter === \"todos\" || log.userId === userFilter;\n    \n    return matchesSearch && matchesAction && matchesUser;\n  });\n\n  return (\n    <>\n      <Header />\n      <main className=\"container mx-auto py-8 px-4\">\n        <div className=\"flex items-center justify-between mb-6\">\n          <div>\n            <h1 className=\"text-3xl font-bold text-foreground\">Logs de Auditoria</h1>\n            <p className=\"text-muted-foreground mt-2\">\n              Histórico completo de todas as ações realizadas no sistema\n            </p>\n          </div>\n          <Button variant=\"outline\" data-testid=\"button-export-logs\">\n            <Download className=\"w-4 h-4 mr-2\" />\n            Exportar Logs\n          </Button>\n        </div>\n\n        {/* Filters */}\n        <Card className=\"mb-6\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Filter className=\"w-5 h-5\" />\n              Filtros\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n              <div>\n                <label className=\"block text-sm font-medium mb-2\">Pesquisar</label>\n                <div className=\"relative\">\n                  <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground w-4 h-4\" />\n                  <Input\n                    placeholder=\"Buscar por ação, entidade ou usuário...\"\n                    value={searchTerm}\n                    onChange={(e) => setSearchTerm(e.target.value)}\n                    className=\"pl-10\"\n                    data-testid=\"input-search-logs\"\n                  />\n                </div>\n              </div>\n              \n              <div>\n                <label className=\"block text-sm font-medium mb-2\">Tipo de Ação</label>\n                <Select value={actionFilter} onValueChange={setActionFilter}>\n                  <SelectTrigger data-testid=\"select-action-filter\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"todas\">Todas as Ações</SelectItem>\n                    <SelectItem value=\"create\">Criação</SelectItem>\n                    <SelectItem value=\"update\">Atualização</SelectItem>\n                    <SelectItem value=\"delete\">Exclusão</SelectItem>\n                    <SelectItem value=\"login\">Login</SelectItem>\n                    <SelectItem value=\"logout\">Logout</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n              \n              <div>\n                <label className=\"block text-sm font-medium mb-2\">Usuário</label>\n                <Select value={userFilter} onValueChange={setUserFilter}>\n                  <SelectTrigger data-testid=\"select-user-filter\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"todos\">Todos os Usuários</SelectItem>\n                    {(users as any[] || []).map((user: any) => (\n                      <SelectItem key={user.id} value={user.id}>\n                        {user.name}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n              \n              <div>\n                <label className=\"block text-sm font-medium mb-2\">Período</label>\n                <Select value={dateFilter} onValueChange={setDateFilter}>\n                  <SelectTrigger data-testid=\"select-date-filter\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"todos\">Todos os Períodos</SelectItem>\n                    <SelectItem value=\"hoje\">Hoje</SelectItem>\n                    <SelectItem value=\"semana\">Última Semana</SelectItem>\n                    <SelectItem value=\"mes\">Último Mês</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Summary Stats */}\n        <div className=\"grid grid-cols-1 md:grid-cols-4 gap-6 mb-6\">\n          <Card>\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Total de Logs</p>\n                  <p className=\"text-2xl font-bold text-foreground\">\n                    {filteredLogs.length}\n                  </p>\n                </div>\n                <Activity className=\"w-8 h-8 text-primary\" />\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Criações</p>\n                  <p className=\"text-2xl font-bold text-green-600\">\n                    {filteredLogs.filter((log: any) => log.action === 'create').length}\n                  </p>\n                </div>\n                <CheckCircle className=\"w-8 h-8 text-green-600\" />\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Atualizações</p>\n                  <p className=\"text-2xl font-bold text-blue-600\">\n                    {filteredLogs.filter((log: any) => log.action === 'update').length}\n                  </p>\n                </div>\n                <Info className=\"w-8 h-8 text-blue-600\" />\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Exclusões</p>\n                  <p className=\"text-2xl font-bold text-red-600\">\n                    {filteredLogs.filter((log: any) => log.action === 'delete').length}\n                  </p>\n                </div>\n                <XCircle className=\"w-8 h-8 text-red-600\" />\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* Logs List */}\n        <Card>\n          <CardHeader>\n            <CardTitle>Registro de Atividades</CardTitle>\n          </CardHeader>\n          <CardContent>\n            {isLoading ? (\n              <div className=\"text-center py-8\">\n                <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto\"></div>\n                <p className=\"text-sm text-muted-foreground mt-2\">Carregando logs...</p>\n              </div>\n            ) : filteredLogs.length === 0 ? (\n              <div className=\"text-center py-8\">\n                <AlertCircle className=\"w-12 h-12 text-muted-foreground mx-auto mb-4\" />\n                <p className=\"text-muted-foreground\">Nenhum log encontrado</p>\n                <p className=\"text-sm text-muted-foreground mt-2\">\n                  {searchTerm || actionFilter !== \"todas\" || userFilter !== \"todos\" \n                    ? \"Tente ajustar os filtros de pesquisa\"\n                    : \"Ações do sistema aparecerão aqui\"}\n                </p>\n              </div>\n            ) : (\n              <div className=\"space-y-3\">\n                {filteredLogs.map((log: any) => {\n                  const { date, time } = formatTimestamp(log.timestamp);\n                  \n                  return (\n                    <div \n                      key={log.id} \n                      className=\"border border-border rounded-lg p-4 hover:bg-muted/30 transition-colors\"\n                    >\n                      <div className=\"flex items-start justify-between\">\n                        <div className=\"flex-1\">\n                          <div className=\"flex items-center gap-3 mb-2\">\n                            {getActionBadge(log.action)}\n                            <span className=\"text-sm font-medium text-foreground\">\n                              {log.entityType} • {getEntityName(log.entityType, log.entityId)}\n                            </span>\n                          </div>\n                          \n                          {log.details && (\n                            <p className=\"text-sm text-muted-foreground mb-2\">\n                              {log.details}\n                            </p>\n                          )}\n                          \n                          <div className=\"flex items-center gap-6 text-xs text-muted-foreground\">\n                            <div className=\"flex items-center gap-1\">\n                              <User className=\"w-3 h-3\" />\n                              <span>{getUserName(log.userId)}</span>\n                            </div>\n                            <div className=\"flex items-center gap-1\">\n                              <Calendar className=\"w-3 h-3\" />\n                              <span>{date}</span>\n                            </div>\n                            <div className=\"flex items-center gap-1\">\n                              <Clock className=\"w-3 h-3\" />\n                              <span>{time}</span>\n                            </div>\n                          </div>\n                        </div>\n                        \n                        <Button \n                          variant=\"ghost\" \n                          size=\"sm\"\n                          data-testid={`button-view-log-${log.id}`}\n                        >\n                          <Eye className=\"w-4 h-4\" />\n                        </Button>\n                      </div>\n                    </div>\n                  );\n                })}\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </main>\n    </>\n  );\n}","size_bytes":13298},"client/src/hooks/use-mobile.tsx":{"content":"import * as React from \"react\"\n\nconst MOBILE_BREAKPOINT = 768\n\nexport function useIsMobile() {\n  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)\n\n  React.useEffect(() => {\n    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)\n    const onChange = () => {\n      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    }\n    mql.addEventListener(\"change\", onChange)\n    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    return () => mql.removeEventListener(\"change\", onChange)\n  }, [])\n\n  return !!isMobile\n}\n","size_bytes":565},"client/src/lib/queryClient.ts":{"content":"import { QueryClient, QueryFunction } from \"@tanstack/react-query\";\n\nasync function throwIfResNotOk(res: Response) {\n  if (!res.ok) {\n    const text = (await res.text()) || res.statusText;\n    \n    // Tentar fazer parse do JSON para extrair message e details\n    try {\n      const errorData = JSON.parse(text);\n      const error: any = new Error(errorData.message || text);\n      error.message = errorData.message || text;\n      error.details = errorData.details || null;\n      error.errors = errorData.errors || null;\n      throw error;\n    } catch (parseError) {\n      // Se não for JSON válido, jogar o texto direto\n      throw new Error(text);\n    }\n  }\n}\n\nexport async function apiRequest(\n  method: string,\n  url: string,\n  data?: unknown | undefined,\n): Promise<Response> {\n  // Get token from localStorage\n  const token = localStorage.getItem(\"opus_clean_token\");\n  \n  const headers: Record<string, string> = data ? { \"Content-Type\": \"application/json\" } : {};\n  if (token) {\n    headers[\"Authorization\"] = `Bearer ${token}`;\n  }\n  \n  const res = await fetch(url, {\n    method,\n    headers,\n    body: data ? JSON.stringify(data) : undefined,\n    credentials: \"include\",\n  });\n\n  await throwIfResNotOk(res);\n  return res;\n}\n\ntype UnauthorizedBehavior = \"returnNull\" | \"throw\";\nexport const getQueryFn: <T>(options: {\n  on401: UnauthorizedBehavior;\n}) => QueryFunction<T> =\n  ({ on401: unauthorizedBehavior }) =>\n  async ({ queryKey }) => {\n    // Get token from localStorage\n    const token = localStorage.getItem(\"opus_clean_token\");\n    \n    const headers: Record<string, string> = {};\n    if (token) {\n      headers[\"Authorization\"] = `Bearer ${token}`;\n    }\n    \n    // Process queryKey to handle objects as query parameters\n    let url = \"\";\n    const queryParams: Record<string, string> = {};\n    \n    for (const part of queryKey) {\n      if (typeof part === \"object\" && part !== null) {\n        // Extract query parameters from object\n        Object.assign(queryParams, part);\n      } else {\n        // Build URL path\n        url += (url ? \"/\" : \"\") + part;\n      }\n    }\n    \n    // Append query parameters if any\n    if (Object.keys(queryParams).length > 0) {\n      const params = new URLSearchParams(queryParams);\n      url += \"?\" + params.toString();\n    }\n    \n    const res = await fetch(url, {\n      headers,\n      credentials: \"include\",\n    });\n\n    if (unauthorizedBehavior === \"returnNull\" && res.status === 401) {\n      return null;\n    }\n\n    await throwIfResNotOk(res);\n    return await res.json();\n  };\n\nexport const queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      queryFn: getQueryFn({ on401: \"throw\" }),\n      refetchInterval: false,\n      refetchOnWindowFocus: false,\n      refetchOnMount: false,\n      refetchOnReconnect: false,\n      staleTime: 5 * 60 * 1000, // 5 minutos - dados frescos, mas não refetch excessivo\n      retry: false,\n    },\n    mutations: {\n      retry: false,\n    },\n  },\n});\n","size_bytes":2959},"client/src/components/ui/table.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Table = React.forwardRef<\n  HTMLTableElement,\n  React.HTMLAttributes<HTMLTableElement>\n>(({ className, ...props }, ref) => (\n  <div className=\"relative w-full overflow-auto\">\n    <table\n      ref={ref}\n      className={cn(\"w-full caption-bottom text-sm\", className)}\n      {...props}\n    />\n  </div>\n))\nTable.displayName = \"Table\"\n\nconst TableHeader = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <thead ref={ref} className={cn(\"[&_tr]:border-b\", className)} {...props} />\n))\nTableHeader.displayName = \"TableHeader\"\n\nconst TableBody = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tbody\n    ref={ref}\n    className={cn(\"[&_tr:last-child]:border-0\", className)}\n    {...props}\n  />\n))\nTableBody.displayName = \"TableBody\"\n\nconst TableFooter = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tfoot\n    ref={ref}\n    className={cn(\n      \"border-t bg-muted/50 font-medium [&>tr]:last:border-b-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableFooter.displayName = \"TableFooter\"\n\nconst TableRow = React.forwardRef<\n  HTMLTableRowElement,\n  React.HTMLAttributes<HTMLTableRowElement>\n>(({ className, ...props }, ref) => (\n  <tr\n    ref={ref}\n    className={cn(\n      \"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nTableRow.displayName = \"TableRow\"\n\nconst TableHead = React.forwardRef<\n  HTMLTableCellElement,\n  React.ThHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <th\n    ref={ref}\n    className={cn(\n      \"h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableHead.displayName = \"TableHead\"\n\nconst TableCell = React.forwardRef<\n  HTMLTableCellElement,\n  React.TdHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <td\n    ref={ref}\n    className={cn(\"p-4 align-middle [&:has([role=checkbox])]:pr-0\", className)}\n    {...props}\n  />\n))\nTableCell.displayName = \"TableCell\"\n\nconst TableCaption = React.forwardRef<\n  HTMLTableCaptionElement,\n  React.HTMLAttributes<HTMLTableCaptionElement>\n>(({ className, ...props }, ref) => (\n  <caption\n    ref={ref}\n    className={cn(\"mt-4 text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nTableCaption.displayName = \"TableCaption\"\n\nexport {\n  Table,\n  TableHeader,\n  TableBody,\n  TableFooter,\n  TableHead,\n  TableRow,\n  TableCell,\n  TableCaption,\n}\n","size_bytes":2765},"client/src/components/ui/accordion.tsx":{"content":"import * as React from \"react\"\nimport * as AccordionPrimitive from \"@radix-ui/react-accordion\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Accordion = AccordionPrimitive.Root\n\nconst AccordionItem = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <AccordionPrimitive.Item\n    ref={ref}\n    className={cn(\"border-b\", className)}\n    {...props}\n  />\n))\nAccordionItem.displayName = \"AccordionItem\"\n\nconst AccordionTrigger = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Header className=\"flex\">\n    <AccordionPrimitive.Trigger\n      ref={ref}\n      className={cn(\n        \"flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <ChevronDown className=\"h-4 w-4 shrink-0 transition-transform duration-200\" />\n    </AccordionPrimitive.Trigger>\n  </AccordionPrimitive.Header>\n))\nAccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName\n\nconst AccordionContent = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Content\n    ref={ref}\n    className=\"overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down\"\n    {...props}\n  >\n    <div className={cn(\"pb-4 pt-0\", className)}>{children}</div>\n  </AccordionPrimitive.Content>\n))\n\nAccordionContent.displayName = AccordionPrimitive.Content.displayName\n\nexport { Accordion, AccordionItem, AccordionTrigger, AccordionContent }\n","size_bytes":1977},"client/src/components/ui/navigation-menu.tsx":{"content":"import * as React from \"react\"\nimport * as NavigationMenuPrimitive from \"@radix-ui/react-navigation-menu\"\nimport { cva } from \"class-variance-authority\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst NavigationMenu = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative z-10 flex max-w-max flex-1 items-center justify-center\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <NavigationMenuViewport />\n  </NavigationMenuPrimitive.Root>\n))\nNavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName\n\nconst NavigationMenuList = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.List\n    ref={ref}\n    className={cn(\n      \"group flex flex-1 list-none items-center justify-center space-x-1\",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName\n\nconst NavigationMenuItem = NavigationMenuPrimitive.Item\n\nconst navigationMenuTriggerStyle = cva(\n  \"group inline-flex h-10 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[state=open]:text-accent-foreground data-[state=open]:bg-accent/50 data-[state=open]:hover:bg-accent data-[state=open]:focus:bg-accent\"\n)\n\nconst NavigationMenuTrigger = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Trigger\n    ref={ref}\n    className={cn(navigationMenuTriggerStyle(), \"group\", className)}\n    {...props}\n  >\n    {children}{\" \"}\n    <ChevronDown\n      className=\"relative top-[1px] ml-1 h-3 w-3 transition duration-200 group-data-[state=open]:rotate-180\"\n      aria-hidden=\"true\"\n    />\n  </NavigationMenuPrimitive.Trigger>\n))\nNavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName\n\nconst NavigationMenuContent = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto \",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName\n\nconst NavigationMenuLink = NavigationMenuPrimitive.Link\n\nconst NavigationMenuViewport = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>\n>(({ className, ...props }, ref) => (\n  <div className={cn(\"absolute left-0 top-full flex justify-center\")}>\n    <NavigationMenuPrimitive.Viewport\n      className={cn(\n        \"origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  </div>\n))\nNavigationMenuViewport.displayName =\n  NavigationMenuPrimitive.Viewport.displayName\n\nconst NavigationMenuIndicator = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Indicator\n    ref={ref}\n    className={cn(\n      \"top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in\",\n      className\n    )}\n    {...props}\n  >\n    <div className=\"relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md\" />\n  </NavigationMenuPrimitive.Indicator>\n))\nNavigationMenuIndicator.displayName =\n  NavigationMenuPrimitive.Indicator.displayName\n\nexport {\n  navigationMenuTriggerStyle,\n  NavigationMenu,\n  NavigationMenuList,\n  NavigationMenuItem,\n  NavigationMenuContent,\n  NavigationMenuTrigger,\n  NavigationMenuLink,\n  NavigationMenuIndicator,\n  NavigationMenuViewport,\n}\n","size_bytes":5128},"client/src/components/ui/skeleton.tsx":{"content":"import { cn } from \"@/lib/utils\"\n\nfunction Skeleton({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) {\n  return (\n    <div\n      className={cn(\"animate-pulse rounded-md bg-muted\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Skeleton }\n","size_bytes":261},"client/src/lib/auth.ts":{"content":"import { apiRequest } from \"./queryClient\";\n\nexport interface User {\n  id: string;\n  name: string;\n  email: string;\n  username: string;\n  role: \"admin\" | \"gestor_cliente\" | \"supervisor_site\" | \"operador\" | \"auditor\";\n  companyId?: string;\n  isActive: boolean;\n}\n\nexport interface LoginCredentials {\n  username: string;\n  password: string;\n}\n\nexport interface AuthState {\n  user: User | null;\n  isAuthenticated: boolean;\n  isLoading: boolean;\n}\n\n// Auth storage keys\nconst AUTH_STORAGE_KEY = \"opus_clean_auth\";\nconst TOKEN_STORAGE_KEY = \"opus_clean_token\";\n\n/**\n * Get current authentication state from localStorage\n */\nexport function getAuthState(): AuthState {\n  try {\n    const stored = localStorage.getItem(AUTH_STORAGE_KEY);\n    if (stored) {\n      const parsed = JSON.parse(stored);\n      return {\n        user: parsed.user,\n        isAuthenticated: !!parsed.user,\n        isLoading: false,\n      };\n    }\n  } catch (error) {\n    console.error(\"Error parsing auth state:\", error);\n  }\n\n  return {\n    user: null,\n    isAuthenticated: false,\n    isLoading: false,\n  };\n}\n\n/**\n * Save authentication state to localStorage\n */\nexport function setAuthState(user: User | null, token?: string): void {\n  try {\n    if (user && token) {\n      localStorage.setItem(AUTH_STORAGE_KEY, JSON.stringify({ user }));\n      localStorage.setItem(TOKEN_STORAGE_KEY, token);\n    } else {\n      localStorage.removeItem(AUTH_STORAGE_KEY);\n      localStorage.removeItem(TOKEN_STORAGE_KEY);\n    }\n  } catch (error) {\n    console.error(\"Error saving auth state:\", error);\n  }\n}\n\n/**\n * Get stored authentication token\n */\nexport function getAuthToken(): string | null {\n  try {\n    return localStorage.getItem(TOKEN_STORAGE_KEY);\n  } catch (error) {\n    console.error(\"Error getting auth token:\", error);\n    return null;\n  }\n}\n\n/**\n * Login with username and password\n */\nexport async function login(credentials: LoginCredentials): Promise<{ user: User; token: string }> {\n  try {\n    const response = await apiRequest(\"POST\", \"/api/auth/login\", credentials);\n    const data = await response.json();\n    \n    if (data.user && data.token) {\n      setAuthState(data.user, data.token);\n      return data;\n    }\n    \n    throw new Error(\"Invalid response format\");\n  } catch (error) {\n    throw new Error(\"Login failed. Please check your credentials.\");\n  }\n}\n\n/**\n * Login with Microsoft SSO\n */\nexport async function loginWithMicrosoft(): Promise<{ user: User; token: string }> {\n  try {\n    // In a real implementation, this would redirect to Microsoft OAuth\n    // For now, we'll simulate the flow\n    window.location.href = \"/api/auth/microsoft\";\n    \n    // This would be handled by the redirect callback\n    throw new Error(\"Redirecting to Microsoft...\");\n  } catch (error) {\n    throw new Error(\"Microsoft SSO login failed\");\n  }\n}\n\n/**\n * Logout and clear authentication state\n */\nexport async function logout(): Promise<void> {\n  try {\n    // Call logout endpoint to invalidate server session\n    await apiRequest(\"POST\", \"/api/auth/logout\", {});\n  } catch (error) {\n    console.error(\"Error calling logout endpoint:\", error);\n  } finally {\n    // Always clear local state regardless of server response\n    setAuthState(null);\n  }\n}\n\n/**\n * Refresh current user data\n */\nexport async function refreshUser(): Promise<User> {\n  try {\n    const response = await apiRequest(\"GET\", \"/api/auth/me\", {});\n    const user = await response.json();\n    \n    const currentState = getAuthState();\n    if (currentState.user) {\n      setAuthState(user, getAuthToken() || undefined);\n    }\n    \n    return user;\n  } catch (error) {\n    // If refresh fails, user might be logged out\n    setAuthState(null);\n    throw new Error(\"Session expired. Please log in again.\");\n  }\n}\n\n/**\n * Check if user has specific role\n */\nexport function hasRole(user: User | null, roles: string | string[]): boolean {\n  if (!user) return false;\n  \n  const roleArray = Array.isArray(roles) ? roles : [roles];\n  return roleArray.includes(user.role);\n}\n\n/**\n * Check if user is admin\n */\nexport function isAdmin(user: User | null): boolean {\n  return hasRole(user, \"admin\");\n}\n\n/**\n * Check if user can manage company data\n */\nexport function canManageCompany(user: User | null): boolean {\n  return hasRole(user, [\"admin\", \"gestor_cliente\"]);\n}\n\n/**\n * Check if user can manage site data\n */\nexport function canManageSite(user: User | null): boolean {\n  return hasRole(user, [\"admin\", \"gestor_cliente\", \"supervisor_site\"]);\n}\n\n/**\n * Check if user can only view their own work orders\n */\nexport function canOnlyViewOwnWorkOrders(user: User | null): boolean {\n  return hasRole(user, \"operador\");\n}\n\n/**\n * Get user's company ID for API calls\n */\nexport function getUserCompanyId(user: User | null): string | null {\n  return user?.companyId || null;\n}\n\n/**\n * Format user display name\n */\nexport function getUserDisplayName(user: User | null): string {\n  if (!user) return \"Usuário\";\n  return user.name || user.username || user.email;\n}\n\n/**\n * Get user role display name in Portuguese\n */\nexport function getRoleDisplayName(role: string): string {\n  const roleMap: Record<string, string> = {\n    admin: \"Administrador\",\n    gestor_cliente: \"Gestor do Cliente\",\n    supervisor_site: \"Supervisor de Local\",\n    operador: \"Operador\",\n    auditor: \"Auditor\"\n  };\n  \n  return roleMap[role] || role;\n}\n\n/**\n * Initialize auth state on app startup\n */\nexport function initializeAuth(): AuthState {\n  const state = getAuthState();\n  \n  // Check if token exists and is still valid\n  const token = getAuthToken();\n  if (state.user && token) {\n    // In a real app, you might want to validate the token with the server\n    return state;\n  }\n  \n  // Clear invalid state\n  if (state.user && !token) {\n    setAuthState(null);\n    return {\n      user: null,\n      isAuthenticated: false,\n      isLoading: false,\n    };\n  }\n  \n  return state;\n}\n\n/**\n * Create a mock authenticated user for development\n */\nexport function createMockAuthUser(role: \"admin\" | \"operador\" = \"admin\"): User {\n  return {\n    id: `mock-user-${role}`,\n    name: role === \"admin\" ? \"Administrador Sistema\" : \"Carlos Oliveira\",\n    email: role === \"admin\" ? \"admin@opusclean.com\" : \"carlos@opusclean.com\",\n    username: role === \"admin\" ? \"admin\" : \"carlos.oliveira\",\n    role,\n    companyId: \"company-1\",\n    isActive: true,\n  };\n}\n\n/**\n * Login with mock user for development\n */\nexport function loginAsMockUser(role: \"admin\" | \"operador\" = \"admin\"): void {\n  const mockUser = createMockAuthUser(role);\n  const mockToken = `mock-token-${Date.now()}`;\n  setAuthState(mockUser, mockToken);\n}\n","size_bytes":6598},"client/src/contexts/ClientContext.tsx":{"content":"import React, { createContext, useContext, useState, useEffect, ReactNode } from 'react';\nimport { useQuery } from '@tanstack/react-query';\nimport { useAuth } from '@/hooks/useAuth';\n\ninterface Customer {\n  id: string;\n  name: string;\n  isActive: boolean;\n  modules: string[];\n}\n\ninterface ClientContextType {\n  activeClientId: string;\n  setActiveClientId: (clientId: string) => void;\n  activeClient: Customer | null;\n  customers: Customer[];\n  isLoading: boolean;\n}\n\nconst ClientContext = createContext<ClientContextType | undefined>(undefined);\n\ninterface ClientProviderProps {\n  children: ReactNode;\n}\n\nexport function ClientProvider({ children }: ClientProviderProps) {\n  // Inicializar com valor do localStorage se existir\n  const [activeClientId, setActiveClientId] = useState<string>(() => {\n    return localStorage.getItem('opus:activeClientId') || \"\";\n  });\n  const { user } = useAuth();\n  \n  // Usar o companyId do usuário logado ao invés de um valor fixo\n  const companyId = user?.companyId || \"company-opus-default\";\n\n  // Se o usuário é customer_user, ele só vê seu próprio cliente\n  const isCustomerUser = user?.userType === 'customer_user';\n  const userCustomerId = user?.customerId;\n\n  // Buscar todos os clientes da empresa do usuário (apenas para admin/opus users)\n  const { data: allCustomers = [], isLoading: isLoadingCustomers } = useQuery({\n    queryKey: [\"/api/companies\", companyId, \"customers\"],\n    enabled: !isCustomerUser && !!companyId, // Só buscar se não for customer_user e tiver companyId\n  });\n\n  // Filtrar apenas clientes ativos\n  const customers = (allCustomers as Customer[]).filter(customer => customer.isActive);\n\n  // Buscar cliente ativo específico  \n  const { data: activeClient } = useQuery({\n    queryKey: [\"/api/customers\", activeClientId],\n    enabled: !!activeClientId,\n  });\n\n  // Resetar activeClientId quando o companyId mudar (quando user loga)\n  // SOMENTE se não houver um cliente válido salvo no localStorage\n  useEffect(() => {\n    if (companyId && !isCustomerUser) {\n      const savedClientId = localStorage.getItem('opus:activeClientId');\n      // Só resetar se não houver cliente salvo no localStorage\n      if (!savedClientId) {\n        setActiveClientId(\"\");\n      }\n    }\n  }, [companyId, isCustomerUser]);\n\n  // COMBINADO: Definir activeClientId corretamente baseado no tipo de usuário\n  useEffect(() => {\n    // Se é customer_user, SEMPRE usar o customerId dele (PRIORIDADE)\n    if (isCustomerUser && userCustomerId) {\n      if (activeClientId !== userCustomerId) {\n        setActiveClientId(userCustomerId);\n      }\n      return; // Não executar lógica de admin\n    }\n    \n    // Se é admin/opus_user e não tem cliente selecionado\n    if (!isCustomerUser && !activeClientId && customers.length > 0) {\n      // Verificar se o cliente do localStorage é válido antes de sobrescrever\n      const savedClientId = localStorage.getItem('opus:activeClientId');\n      const savedClientExists = savedClientId && customers.some(c => c.id === savedClientId);\n      \n      if (savedClientExists) {\n        // Se existe um cliente válido salvo, usar ele\n        setActiveClientId(savedClientId);\n      } else {\n        // Caso contrário, usar o primeiro da lista\n        setActiveClientId(customers[0].id);\n      }\n    }\n  }, [isCustomerUser, userCustomerId, activeClientId, customers]);\n\n  // Para customer_user, isLoading só é false quando activeClientId está definido\n  const isLoading = isCustomerUser \n    ? !activeClientId \n    : isLoadingCustomers;\n\n  // Sincronizar activeClientId com localStorage\n  useEffect(() => {\n    if (activeClientId) {\n      localStorage.setItem('opus:activeClientId', activeClientId);\n      console.log(`[CLIENT CONTEXT] Cliente ativo atualizado: ${activeClientId}`);\n    }\n  }, [activeClientId]);\n\n  const value: ClientContextType = {\n    activeClientId,\n    setActiveClientId,\n    activeClient: activeClient as Customer | null,\n    customers: customers as Customer[],\n    isLoading,\n  };\n\n  return (\n    <ClientContext.Provider value={value}>\n      {children}\n    </ClientContext.Provider>\n  );\n}\n\nexport function useClient() {\n  const context = useContext(ClientContext);\n  if (context === undefined) {\n    throw new Error('useClient must be used within a ClientProvider');\n  }\n  return context;\n}","size_bytes":4313},"client/src/pages/dashboard.tsx":{"content":"import React from \"react\";\nimport { useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport { useClient } from \"@/contexts/ClientContext\";\nimport { useModule } from \"@/contexts/ModuleContext\";\nimport { useLocation } from \"wouter\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { \n  BarChart,\n  Bar,\n  XAxis,\n  YAxis,\n  CartesianGrid,\n  Tooltip,\n  ResponsiveContainer,\n  PieChart,\n  Pie,\n  Cell,\n  LineChart,\n  Line,\n  AreaChart,\n  Area\n} from 'recharts';\nimport { \n  TrendingUp, \n  TrendingDown, \n  Clock, \n  CheckCircle, \n  AlertTriangle,\n  MapPin,\n  Calendar,\n  RefreshCcw,\n  Download,\n  Building,\n  Target,\n  Award,\n  Activity,\n  Gauge,\n  BarChart3,\n  Zap,\n  Star,\n  ArrowUp,\n  ArrowDown\n} from \"lucide-react\";\n\nexport default function Dashboard() {\n  const [selectedPeriod, setSelectedPeriod] = React.useState<string>(\"total\");\n  const [selectedSite, setSelectedSite] = React.useState<string>(\"todos\");\n  const [isRefreshing, setIsRefreshing] = React.useState(false);\n  const queryClient = useQueryClient();\n  const [, navigate] = useLocation();\n\n  const { activeClientId } = useClient();\n  const { currentModule } = useModule();\n\n  // Queries\n  const { data: stats, isLoading: statsLoading } = useQuery({\n    queryKey: [`/api/customers/${activeClientId}/dashboard-stats/${selectedPeriod}/${selectedSite}?module=${currentModule}`],\n    enabled: !!activeClientId,\n  });\n\n  const { data: analytics, isLoading: analyticsLoading } = useQuery({\n    queryKey: [`/api/customers/${activeClientId}/analytics/${selectedPeriod}/${selectedSite}?module=${currentModule}`],\n    enabled: !!activeClientId,\n  });\n\n  const { data: workOrders } = useQuery({\n    queryKey: [\"/api/customers\", activeClientId, \"work-orders\", { module: currentModule }],\n    enabled: !!activeClientId,\n  });\n\n  const { data: sites } = useQuery({\n    queryKey: [\"/api/customers\", activeClientId, \"sites\", { module: currentModule }],\n    enabled: !!activeClientId,\n  });\n\n  const { data: goals } = useQuery({\n    queryKey: [\"/api/customers\", activeClientId, \"dashboard-goals\"],\n    enabled: !!activeClientId,\n  });\n\n  const { data: zones } = useQuery({\n    queryKey: [\"/api/customers\", activeClientId, \"zones\", { module: currentModule }],\n    enabled: !!activeClientId,\n  });\n\n  // Helper function to get goal value by type\n  const getGoalValue = (goalType: string): number | null => {\n    if (!goals) return null;\n    const goal = (goals as any[]).find((g: any) => g.goalType === goalType);\n    return goal ? parseFloat(goal.goalValue) : null;\n  };\n\n\n  if (statsLoading) {\n    return (\n      <div className=\"min-h-screen bg-gradient-to-br from-white via-slate-50/40 to-slate-100/20 flex items-center justify-center\">\n        <div className=\"text-center space-y-6\">\n          <div className=\"relative\">\n            <div className=\"w-20 h-20 border-4 border-blue-100 border-t-blue-600 rounded-full animate-spin mx-auto\"></div>\n            <div className=\"absolute inset-0 w-20 h-20 border-4 border-transparent border-r-blue-400 rounded-full animate-spin mx-auto\" style={{ animationDirection: 'reverse', animationDuration: '1s' }}></div>\n          </div>\n          <div>\n            <p className=\"text-base font-semibold text-slate-900\">Carregando dados...</p>\n            <p className=\"text-sm text-slate-500 mt-1\">Preparando seu dashboard</p>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-white via-slate-50/40 to-slate-100/20\">\n      {/* Modern Glassmorphic Header */}\n      <div className=\"sticky top-0 z-50 backdrop-blur-xl bg-white/90 border-b border-slate-200/60 shadow-sm\">\n        <div className=\"max-w-7xl mx-auto px-6 py-4\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center gap-4\">\n              <div className=\"w-12 h-12 rounded-2xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center shadow-lg shadow-blue-500/25\">\n                <BarChart3 className=\"w-6 h-6 text-white\" />\n              </div>\n              <div>\n                <h1 className=\"text-2xl font-bold bg-gradient-to-r from-slate-900 to-slate-700 bg-clip-text text-transparent\">\n                  Dashboard\n                </h1>\n                <p className=\"text-sm text-slate-600\">Visão completa do sistema em tempo real</p>\n              </div>\n            </div>\n            \n            <div className=\"flex items-center gap-3\">\n              <Select value={selectedPeriod} onValueChange={setSelectedPeriod}>\n                <SelectTrigger className=\"w-40 h-10 border-slate-200 bg-white/60 backdrop-blur-sm hover:bg-white transition-all\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"hoje\">Hoje</SelectItem>\n                  <SelectItem value=\"ontem\">Ontem</SelectItem>\n                  <SelectItem value=\"semana\">Esta Semana</SelectItem>\n                  <SelectItem value=\"mes\">Este Mês</SelectItem>\n                  <SelectItem value=\"total\">Total</SelectItem>\n                </SelectContent>\n              </Select>\n\n              <Select value={selectedSite} onValueChange={setSelectedSite}>\n                <SelectTrigger className=\"w-48 h-10 border-slate-200 bg-white/60 backdrop-blur-sm hover:bg-white transition-all\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"todos\">Todos os Locais</SelectItem>\n                  {(sites as any[] || []).map((site: any) => (\n                    <SelectItem key={site.id} value={site.id}>\n                      {site.name}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n\n              <Button \n                variant=\"outline\" \n                size=\"sm\"\n                className=\"h-10 border-slate-200 bg-white/60 backdrop-blur-sm hover:bg-white hover:scale-105 transition-all duration-200\"\n                onClick={() => {\n                  setIsRefreshing(true);\n                  if (activeClientId) {\n                    queryClient.invalidateQueries({ queryKey: [\"/api/customers\", activeClientId] });\n                  }\n                  setTimeout(() => setIsRefreshing(false), 1000);\n                }}\n                data-testid=\"button-refresh\"\n              >\n                <RefreshCcw className={`w-4 h-4 mr-2 ${isRefreshing ? 'animate-spin' : ''}`} />\n                Atualizar\n              </Button>\n\n              <Button \n                variant=\"outline\" \n                size=\"sm\"\n                className=\"h-10 border-slate-200 bg-white/60 backdrop-blur-sm hover:bg-white hover:scale-105 transition-all duration-200\"\n                onClick={() => {\n                  const exportData = {\n                    periodo: selectedPeriod,\n                    local: selectedSite === 'todos' ? 'Todos os Locais' : (sites as any[] || []).find((s: any) => s.id === selectedSite)?.name || 'N/A',\n                    data_export: new Date().toLocaleString('pt-BR'),\n                    kpis: {\n                      eficiencia: (stats as any)?.efficiency || 0,\n                      sla_compliance: (stats as any)?.slaCompliance || 0,\n                      os_abertas: (stats as any)?.openWorkOrders || 0,\n                      os_concluidas: (stats as any)?.completedWorkOrders || 0,\n                      os_vencidas: (stats as any)?.overdueWorkOrders || 0,\n                      area_limpa: (stats as any)?.areaCleanedToday || 0,\n                      operadores_ativos: (stats as any)?.activeOperators || 0,\n                      indice_qualidade: (stats as any)?.qualityIndex || 0\n                    }\n                  };\n                  \n                  const csvContent = `data:text/csv;charset=utf-8,` +\n                    `Período,${exportData.periodo}\\n` +\n                    `Local,${exportData.local}\\n` +\n                    `Data de Exportação,${exportData.data_export}\\n` +\n                    `\\n` +\n                    `Métrica,Valor\\n` +\n                    `Eficiência Operacional,${exportData.kpis.eficiencia}%\\n` +\n                    `SLA Compliance,${exportData.kpis.sla_compliance}%\\n` +\n                    `OS Abertas,${exportData.kpis.os_abertas}\\n` +\n                    `OS Concluídas,${exportData.kpis.os_concluidas}\\n` +\n                    `OS Vencidas,${exportData.kpis.os_vencidas}\\n` +\n                    `Área Limpa (m²),${exportData.kpis.area_limpa}\\n` +\n                    `Operadores Ativos,${exportData.kpis.operadores_ativos}\\n` +\n                    `Índice de Qualidade,${exportData.kpis.indice_qualidade}/10`;\n                  \n                  const encodedUri = encodeURI(csvContent);\n                  const link = document.createElement(\"a\");\n                  link.setAttribute(\"href\", encodedUri);\n                  link.setAttribute(\"download\", `dashboard_${selectedPeriod}_${new Date().toISOString().split('T')[0]}.csv`);\n                  document.body.appendChild(link);\n                  link.click();\n                  document.body.removeChild(link);\n                }}\n                data-testid=\"button-exportar\"\n              >\n                <Download className=\"w-4 h-4 mr-2\" />\n                Exportar\n              </Button>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {/* Main Content */}\n      <div className=\"max-w-7xl mx-auto p-6 space-y-6\">\n        {/* Modern KPI Cards with Glassmorphism */}\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5\">\n          {/* Eficiência Operacional */}\n          <div className=\"group relative\">\n            <div className=\"absolute -inset-0.5 bg-gradient-to-r from-emerald-500 to-emerald-600 rounded-2xl opacity-0 group-hover:opacity-100 blur transition duration-300\"></div>\n            <Card className=\"relative border-0 shadow-lg hover:shadow-2xl transition-all duration-300 backdrop-blur-sm bg-white/90 overflow-hidden\">\n              <div className=\"absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-emerald-500/10 to-transparent rounded-bl-full\"></div>\n              <CardContent className=\"p-6 relative\">\n                <div className=\"flex items-start justify-between mb-4\">\n                  <div className=\"w-14 h-14 rounded-2xl bg-gradient-to-br from-emerald-500 to-emerald-600 flex items-center justify-center shadow-lg shadow-emerald-500/30 transform group-hover:scale-110 group-hover:rotate-3 transition-all duration-300\">\n                    <Zap className=\"w-7 h-7 text-white\" />\n                  </div>\n                  {(() => {\n                    const goalValue = getGoalValue('eficiencia_operacional');\n                    if (!goalValue) return null;\n                    const currentValue = (stats as any)?.efficiency || 0;\n                    const diff = currentValue - goalValue;\n                    return diff >= 0 ? (\n                      <Badge className=\"bg-emerald-500/10 text-emerald-700 hover:bg-emerald-500/20 border-0 shadow-sm backdrop-blur-sm\">\n                        <ArrowUp className=\"w-3 h-3 mr-1\" />\n                        +{diff.toFixed(1)}%\n                      </Badge>\n                    ) : (\n                      <Badge className=\"bg-red-500/10 text-red-700 hover:bg-red-500/20 border-0 shadow-sm backdrop-blur-sm\">\n                        <ArrowDown className=\"w-3 h-3 mr-1\" />\n                        {diff.toFixed(1)}%\n                      </Badge>\n                    );\n                  })()}\n                </div>\n                <div>\n                  <p className=\"text-sm font-semibold text-slate-600 mb-2\">Eficiência Operacional</p>\n                  <p className=\"text-4xl font-bold bg-gradient-to-r from-emerald-600 to-emerald-700 bg-clip-text text-transparent mb-4\">\n                    {(stats as any)?.efficiency || 0}%\n                  </p>\n                  <div className=\"relative h-2 bg-slate-100 rounded-full overflow-hidden\">\n                    <div \n                      className=\"absolute h-full bg-gradient-to-r from-emerald-500 to-emerald-600 rounded-full transition-all duration-500 shadow-sm\"\n                      style={{ width: `${(stats as any)?.efficiency || 0}%` }}\n                    ></div>\n                  </div>\n                  {(() => {\n                    const goalValue = getGoalValue('eficiencia_operacional');\n                    if (!goalValue) return null;\n                    return (\n                      <p className=\"text-xs text-slate-500 mt-3 flex items-center gap-1\">\n                        <Target className=\"w-3 h-3\" />\n                        Meta: {goalValue}%\n                      </p>\n                    );\n                  })()}\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          {/* SLA Compliance */}\n          <div className=\"group relative\">\n            <div className=\"absolute -inset-0.5 bg-gradient-to-r from-blue-500 to-blue-600 rounded-2xl opacity-0 group-hover:opacity-100 blur transition duration-300\"></div>\n            <Card className=\"relative border-0 shadow-lg hover:shadow-2xl transition-all duration-300 backdrop-blur-sm bg-white/90 overflow-hidden\">\n              <div className=\"absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-blue-500/10 to-transparent rounded-bl-full\"></div>\n              <CardContent className=\"p-6 relative\">\n                <div className=\"flex items-start justify-between mb-4\">\n                  <div className=\"w-14 h-14 rounded-2xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center shadow-lg shadow-blue-500/30 transform group-hover:scale-110 group-hover:rotate-3 transition-all duration-300\">\n                    <Clock className=\"w-7 h-7 text-white\" />\n                  </div>\n                  {(() => {\n                    const goalValue = getGoalValue('sla_compliance');\n                    if (!goalValue) return null;\n                    const currentValue = (stats as any)?.slaCompliance || 0;\n                    const diff = currentValue - goalValue;\n                    return diff >= 0 ? (\n                      <Badge className=\"bg-blue-500/10 text-blue-700 hover:bg-blue-500/20 border-0 shadow-sm backdrop-blur-sm\">\n                        <ArrowUp className=\"w-3 h-3 mr-1\" />\n                        +{diff.toFixed(1)}%\n                      </Badge>\n                    ) : (\n                      <Badge className=\"bg-red-500/10 text-red-700 hover:bg-red-500/20 border-0 shadow-sm backdrop-blur-sm\">\n                        <ArrowDown className=\"w-3 h-3 mr-1\" />\n                        {diff.toFixed(1)}%\n                      </Badge>\n                    );\n                  })()}\n                </div>\n                <div>\n                  <p className=\"text-sm font-semibold text-slate-600 mb-2\">SLA Compliance</p>\n                  <p className=\"text-4xl font-bold bg-gradient-to-r from-blue-600 to-blue-700 bg-clip-text text-transparent mb-4\">\n                    {(stats as any)?.slaCompliance || 0}%\n                  </p>\n                  <div className=\"relative h-2 bg-slate-100 rounded-full overflow-hidden\">\n                    <div \n                      className=\"absolute h-full bg-gradient-to-r from-blue-500 to-blue-600 rounded-full transition-all duration-500 shadow-sm\"\n                      style={{ width: `${(stats as any)?.slaCompliance || 0}%` }}\n                    ></div>\n                  </div>\n                  {(() => {\n                    const goalValue = getGoalValue('sla_compliance');\n                    if (!goalValue) return null;\n                    return (\n                      <p className=\"text-xs text-slate-500 mt-3 flex items-center gap-1\">\n                        <Target className=\"w-3 h-3\" />\n                        Meta: {goalValue}%\n                      </p>\n                    );\n                  })()}\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          {/* OS Concluídas */}\n          <div className=\"group relative\">\n            <div className=\"absolute -inset-0.5 bg-gradient-to-r from-purple-500 to-purple-600 rounded-2xl opacity-0 group-hover:opacity-100 blur transition duration-300\"></div>\n            <Card className=\"relative border-0 shadow-lg hover:shadow-2xl transition-all duration-300 backdrop-blur-sm bg-white/90 overflow-hidden\">\n              <div className=\"absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-purple-500/10 to-transparent rounded-bl-full\"></div>\n              <CardContent className=\"p-6 relative\">\n                <div className=\"flex items-start justify-between mb-4\">\n                  <div className=\"w-14 h-14 rounded-2xl bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center shadow-lg shadow-purple-500/30 transform group-hover:scale-110 group-hover:rotate-3 transition-all duration-300\">\n                    <CheckCircle className=\"w-7 h-7 text-white\" />\n                  </div>\n                  {(() => {\n                    const goalValue = getGoalValue('os_concluidas_mes');\n                    const currentValue = (stats as any)?.completedWorkOrders || 0;\n                    if (goalValue && goalValue > 0) {\n                      const diff = currentValue - goalValue;\n                      return diff >= 0 ? (\n                        <Badge className=\"bg-purple-500/10 text-purple-700 hover:bg-purple-500/20 border-0 shadow-sm backdrop-blur-sm\">\n                          <ArrowUp className=\"w-3 h-3 mr-1\" />\n                          +{diff}\n                        </Badge>\n                      ) : (\n                        <Badge className=\"bg-red-500/10 text-red-700 hover:bg-red-500/20 border-0 shadow-sm backdrop-blur-sm\">\n                          <ArrowDown className=\"w-3 h-3 mr-1\" />\n                          {diff}\n                        </Badge>\n                      );\n                    }\n                    return null;\n                  })()}\n                </div>\n                <div>\n                  <p className=\"text-sm font-semibold text-slate-600 mb-2\">OS Concluídas</p>\n                  <p className=\"text-4xl font-bold bg-gradient-to-r from-purple-600 to-purple-700 bg-clip-text text-transparent mb-4\">\n                    {(stats as any)?.completedWorkOrders || 0}\n                  </p>\n                  <div className=\"relative h-2 bg-slate-100 rounded-full overflow-hidden\">\n                    <div \n                      className=\"absolute h-full bg-gradient-to-r from-purple-500 to-purple-600 rounded-full transition-all duration-500 shadow-sm\"\n                      style={{ width: `${(stats as any)?.efficiency || 0}%` }}\n                    ></div>\n                  </div>\n                  {(() => {\n                    const goalValue = getGoalValue('os_concluidas_mes');\n                    const totalOrders = ((stats as any)?.completedWorkOrders || 0) + ((stats as any)?.openWorkOrders || 0);\n                    return goalValue ? (\n                      <p className=\"text-xs text-slate-500 mt-3 flex items-center gap-1\">\n                        <Target className=\"w-3 h-3\" />\n                        Meta: {goalValue}\n                      </p>\n                    ) : (\n                      <p className=\"text-xs text-slate-500 mt-3 flex items-center gap-1\">\n                        <Activity className=\"w-3 h-3\" />\n                        Total: {totalOrders}\n                      </p>\n                    );\n                  })()}\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          {/* Índice de Qualidade */}\n          <div className=\"group relative\">\n            <div className=\"absolute -inset-0.5 bg-gradient-to-r from-amber-500 to-amber-600 rounded-2xl opacity-0 group-hover:opacity-100 blur transition duration-300\"></div>\n            <Card className=\"relative border-0 shadow-lg hover:shadow-2xl transition-all duration-300 backdrop-blur-sm bg-white/90 overflow-hidden\">\n              <div className=\"absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-amber-500/10 to-transparent rounded-bl-full\"></div>\n              <CardContent className=\"p-6 relative\">\n                <div className=\"flex items-start justify-between mb-4\">\n                  <div className=\"w-14 h-14 rounded-2xl bg-gradient-to-br from-amber-500 to-amber-600 flex items-center justify-center shadow-lg shadow-amber-500/30 transform group-hover:scale-110 group-hover:rotate-3 transition-all duration-300\">\n                    <Star className=\"w-7 h-7 text-white\" />\n                  </div>\n                  {(() => {\n                    const completedOrders = (stats as any)?.completedWorkOrders || 0;\n                    const qualityIndex = (stats as any)?.qualityIndex;\n                    \n                    if (completedOrders === 0 || qualityIndex === null || qualityIndex === undefined) {\n                      return null;\n                    }\n                    \n                    const goalValue = getGoalValue('indice_qualidade');\n                    const diff = goalValue ? qualityIndex - goalValue : 0;\n                    \n                    return goalValue && diff >= 0 ? (\n                      <Badge className=\"bg-amber-500/10 text-amber-700 hover:bg-amber-500/20 border-0 shadow-sm backdrop-blur-sm\">\n                        <ArrowUp className=\"w-3 h-3 mr-1\" />\n                        +{diff.toFixed(1)}\n                      </Badge>\n                    ) : goalValue && diff < 0 ? (\n                      <Badge className=\"bg-red-500/10 text-red-700 hover:bg-red-500/20 border-0 shadow-sm backdrop-blur-sm\">\n                        <ArrowDown className=\"w-3 h-3 mr-1\" />\n                        {diff.toFixed(1)}\n                      </Badge>\n                    ) : null;\n                  })()}\n                </div>\n                <div>\n                  <p className=\"text-sm font-semibold text-slate-600 mb-2\">Índice de Qualidade</p>\n                  {(() => {\n                    const completedOrders = (stats as any)?.completedWorkOrders || 0;\n                    const qualityIndex = (stats as any)?.qualityIndex;\n                    \n                    if (completedOrders === 0 || qualityIndex === null || qualityIndex === undefined) {\n                      return <p className=\"text-4xl font-bold text-slate-400 mb-4\">N/A</p>;\n                    }\n                    \n                    return (\n                      <p className=\"text-4xl font-bold bg-gradient-to-r from-amber-600 to-amber-700 bg-clip-text text-transparent mb-4\">\n                        {qualityIndex}<span className=\"text-xl text-slate-500\">/10</span>\n                      </p>\n                    );\n                  })()}\n                  <div className=\"relative h-2 bg-slate-100 rounded-full overflow-hidden\">\n                    <div \n                      className=\"absolute h-full bg-gradient-to-r from-amber-500 to-amber-600 rounded-full transition-all duration-500 shadow-sm\"\n                      style={{ width: `${((stats as any)?.completedWorkOrders || 0) > 0 ? ((stats as any)?.qualityIndex || 0) * 10 : 0}%` }}\n                    ></div>\n                  </div>\n                  {(() => {\n                    const goalValue = getGoalValue('indice_qualidade');\n                    const ratedCount = (stats as any)?.ratedCount || 0;\n                    const completedOrders = (stats as any)?.completedWorkOrders || 0;\n                    \n                    if (completedOrders === 0) {\n                      return <p className=\"text-xs text-slate-500 mt-3\">Sem avaliações</p>;\n                    }\n                    \n                    return goalValue ? (\n                      <p className=\"text-xs text-slate-500 mt-3 flex items-center gap-1\">\n                        <Target className=\"w-3 h-3\" />\n                        Meta: {goalValue}/10 • {ratedCount} avaliações\n                      </p>\n                    ) : (\n                      <p className=\"text-xs text-slate-500 mt-3 flex items-center gap-1\">\n                        <Award className=\"w-3 h-3\" />\n                        {ratedCount} avaliações\n                      </p>\n                    );\n                  })()}\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n        </div>\n\n        {/* Modern Charts with Glassmorphism */}\n        <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-5\">\n          {/* Performance Trend */}\n          <Card className=\"border-0 shadow-lg backdrop-blur-sm bg-white/90 overflow-hidden\">\n            <div className=\"absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500\"></div>\n            <CardHeader className=\"border-b border-slate-100 bg-gradient-to-r from-slate-50 to-transparent\">\n              <CardTitle className=\"text-base font-semibold text-slate-900 flex items-center gap-2\">\n                <div className=\"w-8 h-8 rounded-lg bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center shadow-sm\">\n                  <Activity className=\"w-4 h-4 text-white\" />\n                </div>\n                Tendência de Performance\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"p-6\">\n              <ResponsiveContainer width=\"100%\" height={280}>\n                <AreaChart data={(analytics as any)?.daily || []}>\n                  <defs>\n                    <linearGradient id=\"colorGradient\" x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\n                      <stop offset=\"5%\" stopColor=\"#3b82f6\" stopOpacity={0.3}/>\n                      <stop offset=\"95%\" stopColor=\"#3b82f6\" stopOpacity={0}/>\n                    </linearGradient>\n                  </defs>\n                  <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#e2e8f0\" vertical={false} />\n                  <XAxis \n                    dataKey=\"date\" \n                    stroke=\"#94a3b8\"\n                    tick={{ fontSize: 12, fill: '#64748b' }}\n                    axisLine={{ stroke: '#e2e8f0' }}\n                    tickFormatter={(value) => {\n                      if (!value) return '';\n                      const date = new Date(value);\n                      return `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}`;\n                    }}\n                  />\n                  <YAxis \n                    stroke=\"#94a3b8\" \n                    tick={{ fontSize: 12, fill: '#64748b' }}\n                    axisLine={{ stroke: '#e2e8f0' }}\n                  />\n                  <Tooltip \n                    contentStyle={{\n                      backgroundColor: 'rgba(255, 255, 255, 0.95)',\n                      backdropFilter: 'blur(12px)',\n                      border: '1px solid #e2e8f0',\n                      borderRadius: '12px',\n                      boxShadow: '0 8px 16px rgba(0,0,0,0.1)'\n                    }}\n                  />\n                  <Area \n                    type=\"monotone\" \n                    dataKey=\"efficiency\" \n                    stroke=\"#3b82f6\" \n                    strokeWidth={3}\n                    fill=\"url(#colorGradient)\"\n                    name=\"Eficiência %\"\n                  />\n                </AreaChart>\n              </ResponsiveContainer>\n            </CardContent>\n          </Card>\n\n          {/* Status Distribution */}\n          <Card className=\"border-0 shadow-lg backdrop-blur-sm bg-white/90 overflow-hidden\">\n            <div className=\"absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-emerald-500 via-blue-500 to-purple-500\"></div>\n            <CardHeader className=\"border-b border-slate-100 bg-gradient-to-r from-slate-50 to-transparent\">\n              <CardTitle className=\"text-base font-semibold text-slate-900 flex items-center gap-2\">\n                <div className=\"w-8 h-8 rounded-lg bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center shadow-sm\">\n                  <BarChart3 className=\"w-4 h-4 text-white\" />\n                </div>\n                Distribuição de Status\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"p-6\">\n              <ResponsiveContainer width=\"100%\" height={280}>\n                <PieChart>\n                  <Pie\n                    data={(analytics as any)?.statusBreakdown?.map((item: any) => ({\n                      name: item.status === 'concluida' ? 'Concluídas' : \n                            item.status === 'aberta' ? 'Abertas' : \n                            item.status === 'vencida' ? 'Vencidas' : item.status,\n                      value: item.count,\n                      percentage: item.percentage\n                    })) || []}\n                    cx=\"50%\"\n                    cy=\"50%\"\n                    innerRadius={70}\n                    outerRadius={100}\n                    paddingAngle={3}\n                    dataKey=\"value\"\n                  >\n                    {((analytics as any)?.statusBreakdown || []).map((entry: any, index: number) => (\n                      <Cell \n                        key={`cell-${index}`} \n                        fill={\n                          entry.status === 'concluida' ? '#10b981' :\n                          entry.status === 'em_andamento' ? '#3b82f6' :\n                          entry.status === 'aberta' ? '#f59e0b' :\n                          entry.status === 'vencida' ? '#ef4444' : '#6b7280'\n                        }\n                      />\n                    ))}\n                  </Pie>\n                  <Tooltip \n                    contentStyle={{\n                      backgroundColor: 'rgba(255, 255, 255, 0.95)',\n                      backdropFilter: 'blur(12px)',\n                      border: '1px solid #e2e8f0',\n                      borderRadius: '12px',\n                      boxShadow: '0 8px 16px rgba(0,0,0,0.1)'\n                    }}\n                  />\n                </PieChart>\n              </ResponsiveContainer>\n              <div className=\"mt-6 grid grid-cols-2 gap-3\">\n                {((analytics as any)?.statusBreakdown || []).map((item: any, index: number) => (\n                  <div key={index} className=\"flex items-center gap-2 p-2 rounded-lg bg-slate-50/50 backdrop-blur-sm hover:bg-slate-100/80 transition-all\">\n                    <div \n                      className=\"w-3 h-3 rounded-full flex-shrink-0 shadow-sm\" \n                      style={{ \n                        backgroundColor: \n                          item.status === 'concluida' ? '#10b981' :\n                          item.status === 'em_andamento' ? '#3b82f6' :\n                          item.status === 'aberta' ? '#f59e0b' :\n                          item.status === 'vencida' ? '#ef4444' : '#6b7280'\n                      }}\n                    />\n                    <span className=\"text-xs font-medium text-slate-700\">\n                      {item.status === 'concluida' ? 'Concluídas' : \n                       item.status === 'aberta' ? 'Abertas' : \n                       item.status === 'vencida' ? 'Vencidas' : item.status}: {item.count}\n                    </span>\n                  </div>\n                ))}\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* Sites Overview with Modern Design */}\n        <Card className=\"border-0 shadow-lg backdrop-blur-sm bg-white/90 overflow-hidden\">\n          <div className=\"absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-cyan-500 via-blue-500 to-indigo-500\"></div>\n          <CardHeader className=\"border-b border-slate-100 bg-gradient-to-r from-slate-50 to-transparent\">\n            <div className=\"flex items-center justify-between\">\n              <CardTitle className=\"text-base font-semibold text-slate-900 flex items-center gap-2\">\n                <div className=\"w-8 h-8 rounded-lg bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center shadow-sm\">\n                  <Building className=\"w-4 h-4 text-white\" />\n                </div>\n                Performance por Local\n              </CardTitle>\n              <Badge className=\"bg-blue-500/10 text-blue-700 hover:bg-blue-500/20 border-0 shadow-sm backdrop-blur-sm\">\n                {(sites as any[] || []).length} {(sites as any[] || []).length === 1 ? 'Local' : 'Locais'}\n              </Badge>\n            </div>\n          </CardHeader>\n          <CardContent className=\"p-6\">\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n              {(sites as any[] || []).map((site: any) => {\n                const siteWorkOrders = (workOrders as any[] || []).filter((wo: any) => wo.siteId === site.id);\n                const totalOS = siteWorkOrders.length;\n                const concluidas = siteWorkOrders.filter((wo: any) => wo.status === 'concluida').length;\n                const abertas = siteWorkOrders.filter((wo: any) => wo.status === 'aberta').length;\n                const vencidas = siteWorkOrders.filter((wo: any) => wo.status === 'vencida').length;\n                const taxaConclusao = totalOS > 0 ? Math.round((concluidas / totalOS) * 100) : 0;\n                \n                return (\n                  <div \n                    key={site.id}\n                    className=\"group relative p-5 rounded-2xl border border-slate-200 hover:border-blue-300 hover:shadow-xl transition-all duration-300 cursor-pointer bg-white/80 backdrop-blur-sm overflow-hidden\"\n                    onClick={() => {\n                      setSelectedSite(site.id);\n                      queryClient.invalidateQueries({ \n                        queryKey: [`/api/customers/${activeClientId}/dashboard-stats`] \n                      });\n                    }}\n                    data-testid={`site-card-${site.id}`}\n                  >\n                    <div className=\"absolute top-0 right-0 w-24 h-24 bg-gradient-to-br from-blue-500/5 to-transparent rounded-bl-full opacity-0 group-hover:opacity-100 transition-opacity\"></div>\n                    <div className=\"flex items-start justify-between mb-3 relative\">\n                      <div className=\"flex-1\">\n                        <h4 className=\"font-bold text-slate-900 mb-1 group-hover:text-blue-600 transition-colors\">{site.name}</h4>\n                        <p className=\"text-xs text-slate-500 flex items-center gap-1\">\n                          <MapPin className=\"w-3 h-3\" />\n                          {(zones as any[] || []).filter((z: any) => z.siteId === site.id).length} zonas\n                        </p>\n                      </div>\n                      <Badge className={`shadow-sm backdrop-blur-sm ${\n                        taxaConclusao >= 80 ? 'bg-emerald-500/10 text-emerald-700 border-emerald-200/50' :\n                        taxaConclusao >= 60 ? 'bg-blue-500/10 text-blue-700 border-blue-200/50' :\n                        taxaConclusao >= 40 ? 'bg-amber-500/10 text-amber-700 border-amber-200/50' : \n                        'bg-red-500/10 text-red-700 border-red-200/50'\n                      } border`}>\n                        {taxaConclusao}%\n                      </Badge>\n                    </div>\n                    \n                    <div className=\"relative h-2 bg-slate-100 rounded-full overflow-hidden mb-4 shadow-inner\">\n                      <div \n                        className={`absolute h-full rounded-full transition-all duration-500 ${\n                          taxaConclusao >= 80 ? 'bg-gradient-to-r from-emerald-500 to-emerald-600' :\n                          taxaConclusao >= 60 ? 'bg-gradient-to-r from-blue-500 to-blue-600' :\n                          taxaConclusao >= 40 ? 'bg-gradient-to-r from-amber-500 to-amber-600' : \n                          'bg-gradient-to-r from-red-500 to-red-600'\n                        }`}\n                        style={{ width: `${taxaConclusao}%` }}\n                      ></div>\n                    </div>\n                    \n                    <div className=\"grid grid-cols-3 gap-2 relative\">\n                      <div className=\"text-center bg-gradient-to-br from-emerald-50 to-emerald-100/50 rounded-xl p-2.5 border border-emerald-200/50 shadow-sm\">\n                        <div className=\"text-lg font-bold text-emerald-600\">{concluidas}</div>\n                        <div className=\"text-xs text-emerald-700 font-medium\">OK</div>\n                      </div>\n                      <div className=\"text-center bg-gradient-to-br from-amber-50 to-amber-100/50 rounded-xl p-2.5 border border-amber-200/50 shadow-sm\">\n                        <div className=\"text-lg font-bold text-amber-600\">{abertas}</div>\n                        <div className=\"text-xs text-amber-700 font-medium\">Abertas</div>\n                      </div>\n                      <div className=\"text-center bg-gradient-to-br from-red-50 to-red-100/50 rounded-xl p-2.5 border border-red-200/50 shadow-sm\">\n                        <div className=\"text-lg font-bold text-red-600\">{vencidas}</div>\n                        <div className=\"text-xs text-red-700 font-medium\">Venc.</div>\n                      </div>\n                    </div>\n                  </div>\n                );\n              })}\n              \n              {(sites as any[] || []).length === 0 && (\n                <div className=\"col-span-full text-center py-16 bg-slate-50/50 rounded-2xl backdrop-blur-sm\">\n                  <Building className=\"w-16 h-16 text-slate-300 mx-auto mb-4\" />\n                  <p className=\"text-slate-500 text-sm font-medium\">Nenhum local cadastrado</p>\n                  <p className=\"text-slate-400 text-xs mt-1\">Adicione locais para visualizar métricas</p>\n                </div>\n              )}\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Zone Performance with Modern Design */}\n        <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-5\">\n          {/* Top Zones */}\n          <Card className=\"border-0 shadow-lg backdrop-blur-sm bg-white/90 overflow-hidden\">\n            <div className=\"absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-yellow-500 via-orange-500 to-red-500\"></div>\n            <CardHeader className=\"border-b border-slate-100 bg-gradient-to-r from-slate-50 to-transparent\">\n              <CardTitle className=\"text-base font-semibold text-slate-900 flex items-center gap-2\">\n                <div className=\"w-8 h-8 rounded-lg bg-gradient-to-br from-emerald-500 to-emerald-600 flex items-center justify-center shadow-sm\">\n                  <TrendingUp className=\"w-4 h-4 text-white\" />\n                </div>\n                Top Zonas\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"p-6\">\n              <div className=\"space-y-3\">\n                {(() => {\n                  const zonesWithStats = (zones as any[] || []).map((zone: any) => {\n                    const zoneWorkOrders = (workOrders as any[] || []).filter((wo: any) => wo.zoneId === zone.id);\n                    const total = zoneWorkOrders.length;\n                    const concluidas = zoneWorkOrders.filter((wo: any) => wo.status === 'concluida').length;\n                    const taxa = total > 0 ? Math.round((concluidas / total) * 100) : 0;\n                    return { ...zone, totalOS: total, concluidas, taxa };\n                  })\n                  .filter(z => z.totalOS > 0)\n                  .sort((a, b) => b.taxa - a.taxa)\n                  .slice(0, 5);\n\n                  if (zonesWithStats.length === 0) {\n                    return (\n                      <div className=\"text-center py-12 bg-slate-50/50 rounded-2xl backdrop-blur-sm\">\n                        <MapPin className=\"w-12 h-12 text-slate-300 mx-auto mb-3\" />\n                        <p className=\"text-slate-500 text-sm font-medium\">Nenhuma zona com OSs</p>\n                      </div>\n                    );\n                  }\n\n                  return zonesWithStats.map((zone: any, index: number) => (\n                    <div \n                      key={zone.id} \n                      className=\"flex items-center justify-between p-4 rounded-xl bg-gradient-to-r from-slate-50 to-white hover:from-blue-50/50 hover:to-white transition-all duration-200 border border-slate-200/50 hover:border-blue-300/50 shadow-sm hover:shadow-md group\"\n                      data-testid={`top-zone-${zone.id}`}\n                    >\n                      <div className=\"flex items-center gap-3\">\n                        <div className={`w-10 h-10 rounded-xl flex items-center justify-center text-sm font-bold text-white shadow-lg transform group-hover:scale-110 transition-transform ${\n                          index === 0 ? 'bg-gradient-to-br from-yellow-400 to-yellow-500 shadow-yellow-500/30' :\n                          index === 1 ? 'bg-gradient-to-br from-slate-400 to-slate-500 shadow-slate-500/30' :\n                          index === 2 ? 'bg-gradient-to-br from-orange-400 to-orange-500 shadow-orange-500/30' :\n                          'bg-gradient-to-br from-emerald-400 to-emerald-500 shadow-emerald-500/30'\n                        }`}>\n                          #{index + 1}\n                        </div>\n                        <div>\n                          <div className=\"font-semibold text-slate-900 text-sm group-hover:text-blue-600 transition-colors\">{zone.name}</div>\n                          <div className=\"text-xs text-slate-500\">\n                            {zone.concluidas}/{zone.totalOS} OSs concluídas\n                          </div>\n                        </div>\n                      </div>\n                      <div className=\"text-2xl font-bold bg-gradient-to-r from-emerald-600 to-emerald-700 bg-clip-text text-transparent\">\n                        {zone.taxa}%\n                      </div>\n                    </div>\n                  ));\n                })()}\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Attention Zones */}\n          <Card className=\"border-0 shadow-lg backdrop-blur-sm bg-white/90 overflow-hidden\">\n            <div className=\"absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-red-500 via-orange-500 to-amber-500\"></div>\n            <CardHeader className=\"border-b border-slate-100 bg-gradient-to-r from-slate-50 to-transparent\">\n              <CardTitle className=\"text-base font-semibold text-slate-900 flex items-center gap-2\">\n                <div className=\"w-8 h-8 rounded-lg bg-gradient-to-br from-red-500 to-red-600 flex items-center justify-center shadow-sm\">\n                  <AlertTriangle className=\"w-4 h-4 text-white\" />\n                </div>\n                Zonas de Atenção\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"p-6\">\n              <div className=\"space-y-3\">\n                {(() => {\n                  const zonesWithStats = (zones as any[] || []).map((zone: any) => {\n                    const zoneWorkOrders = (workOrders as any[] || []).filter((wo: any) => wo.zoneId === zone.id);\n                    const total = zoneWorkOrders.length;\n                    const vencidas = zoneWorkOrders.filter((wo: any) => wo.status === 'vencida').length;\n                    const abertas = zoneWorkOrders.filter((wo: any) => wo.status === 'aberta').length;\n                    return { ...zone, totalOS: total, vencidas, abertas };\n                  })\n                  .filter(z => z.vencidas > 0)\n                  .sort((a, b) => b.vencidas - a.vencidas)\n                  .slice(0, 5);\n\n                  if (zonesWithStats.length === 0) {\n                    return (\n                      <div className=\"text-center py-12 bg-gradient-to-br from-emerald-50 to-green-50/50 rounded-2xl backdrop-blur-sm border border-emerald-200/50\">\n                        <CheckCircle className=\"w-12 h-12 text-emerald-500 mx-auto mb-3\" />\n                        <p className=\"text-emerald-600 font-semibold text-sm\">Tudo em dia!</p>\n                        <p className=\"text-emerald-600/70 text-xs mt-1\">Nenhuma zona com OSs vencidas</p>\n                      </div>\n                    );\n                  }\n\n                  return zonesWithStats.map((zone: any) => (\n                    <div \n                      key={zone.id} \n                      className=\"flex items-center justify-between p-4 rounded-xl bg-gradient-to-r from-red-50/50 to-white hover:from-red-50 hover:to-white transition-all duration-200 border border-red-200/50 hover:border-red-300 shadow-sm hover:shadow-md group\"\n                      data-testid={`attention-zone-${zone.id}`}\n                    >\n                      <div className=\"flex items-center gap-3\">\n                        <div className=\"w-10 h-10 rounded-xl bg-gradient-to-br from-red-500 to-red-600 flex items-center justify-center shadow-lg shadow-red-500/30 transform group-hover:scale-110 transition-transform\">\n                          <AlertTriangle className=\"w-5 h-5 text-white\" />\n                        </div>\n                        <div>\n                          <div className=\"font-semibold text-slate-900 text-sm group-hover:text-red-600 transition-colors\">{zone.name}</div>\n                          <div className=\"text-xs text-slate-500\">\n                            {zone.vencidas} vencidas • {zone.abertas} abertas\n                          </div>\n                        </div>\n                      </div>\n                      <div className=\"text-2xl font-bold bg-gradient-to-r from-red-600 to-red-700 bg-clip-text text-transparent\">\n                        {zone.vencidas}\n                      </div>\n                    </div>\n                  ));\n                })()}\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n    </div>\n  );\n}\n","size_bytes":46177},"client/src/components/ui/input.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Input = React.forwardRef<HTMLInputElement, React.ComponentProps<\"input\">>(\n  ({ className, type, ...props }, ref) => {\n    return (\n      <input\n        type={type}\n        className={cn(\n          \"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n          className\n        )}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nInput.displayName = \"Input\"\n\nexport { Input }\n","size_bytes":791},"client/src/components/ui/pagination.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { ButtonProps, buttonVariants } from \"@/components/ui/button\"\n\nconst Pagination = ({ className, ...props }: React.ComponentProps<\"nav\">) => (\n  <nav\n    role=\"navigation\"\n    aria-label=\"pagination\"\n    className={cn(\"mx-auto flex w-full justify-center\", className)}\n    {...props}\n  />\n)\nPagination.displayName = \"Pagination\"\n\nconst PaginationContent = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    className={cn(\"flex flex-row items-center gap-1\", className)}\n    {...props}\n  />\n))\nPaginationContent.displayName = \"PaginationContent\"\n\nconst PaginationItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li ref={ref} className={cn(\"\", className)} {...props} />\n))\nPaginationItem.displayName = \"PaginationItem\"\n\ntype PaginationLinkProps = {\n  isActive?: boolean\n} & Pick<ButtonProps, \"size\"> &\n  React.ComponentProps<\"a\">\n\nconst PaginationLink = ({\n  className,\n  isActive,\n  size = \"icon\",\n  ...props\n}: PaginationLinkProps) => (\n  <a\n    aria-current={isActive ? \"page\" : undefined}\n    className={cn(\n      buttonVariants({\n        variant: isActive ? \"outline\" : \"ghost\",\n        size,\n      }),\n      className\n    )}\n    {...props}\n  />\n)\nPaginationLink.displayName = \"PaginationLink\"\n\nconst PaginationPrevious = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to previous page\"\n    size=\"default\"\n    className={cn(\"gap-1 pl-2.5\", className)}\n    {...props}\n  >\n    <ChevronLeft className=\"h-4 w-4\" />\n    <span>Previous</span>\n  </PaginationLink>\n)\nPaginationPrevious.displayName = \"PaginationPrevious\"\n\nconst PaginationNext = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to next page\"\n    size=\"default\"\n    className={cn(\"gap-1 pr-2.5\", className)}\n    {...props}\n  >\n    <span>Next</span>\n    <ChevronRight className=\"h-4 w-4\" />\n  </PaginationLink>\n)\nPaginationNext.displayName = \"PaginationNext\"\n\nconst PaginationEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    aria-hidden\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More pages</span>\n  </span>\n)\nPaginationEllipsis.displayName = \"PaginationEllipsis\"\n\nexport {\n  Pagination,\n  PaginationContent,\n  PaginationEllipsis,\n  PaginationItem,\n  PaginationLink,\n  PaginationNext,\n  PaginationPrevious,\n}\n","size_bytes":2751},"client/src/pages/system-users.tsx":{"content":"import { useState } from 'react';\nimport { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Badge } from '@/components/ui/badge';\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog';\nimport { Form, FormControl, FormField, FormItem, FormLabel } from '@/components/ui/form';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { useForm } from 'react-hook-form';\nimport { zodResolver } from '@hookform/resolvers/zod';\nimport { z } from 'zod';\nimport { useToast } from '@/hooks/use-toast';\nimport { apiRequest } from '@/lib/queryClient';\nimport { Users, Plus, Edit, Trash2, Shield, Building2, KeyRound } from 'lucide-react';\nimport usePermissions from '@/hooks/usePermissions';\n\nconst createUserSchema = z.object({\n  username: z.string().min(1, 'Username é obrigatório'),\n  email: z.string().email('Email inválido'),\n  password: z.string().min(6, 'Senha deve ter no mínimo 6 caracteres'),\n  name: z.string().min(1, 'Nome é obrigatório'),\n  role: z.enum(['admin', 'gestor_cliente', 'supervisor_site', 'operador', 'auditor']),\n});\n\ntype CreateUserForm = z.infer<typeof createUserSchema>;\ntype User = {\n  id: string;\n  username: string;\n  email: string;\n  name: string;\n  role: string;\n  userType: string;\n  assignedClientId?: string;\n  isActive: boolean;\n  createdAt: string;\n  updatedAt: string;\n};\n\nexport default function SystemUsers() {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const { can } = usePermissions();\n  const [searchTerm, setSearchTerm] = useState('');\n  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);\n  const [editingUser, setEditingUser] = useState<User | null>(null);\n\n  const form = useForm<CreateUserForm>({\n    resolver: zodResolver(createUserSchema),\n    defaultValues: {\n      username: '',\n      email: '',\n      password: '',\n      name: '',\n      role: 'operador',\n    },\n  });\n\n  // Verificar se o usuário pode gerenciar usuários OPUS\n  if (!can.viewOpusUsers()) {\n    return (\n      <div className=\"flex-1 flex items-center justify-center\">\n        <Card className=\"w-96\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Shield className=\"h-5 w-5\" />\n              Acesso Negado\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <p className=\"text-muted-foreground\">\n              Você não tem permissão para acessar o gerenciamento de usuários do sistema.\n            </p>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  // Buscar apenas usuários OPUS (tipo opus_user)\n  const OPUS_COMPANY_ID = \"de722500-9ce3-4b13-8a1d-cddcb168551e\";\n  const { data: users = [], isLoading } = useQuery<User[]>({\n    queryKey: ['/api/system-users'],\n  });\n\n  const createUserMutation = useMutation({\n    mutationFn: async (data: CreateUserForm) => {\n      await apiRequest('POST', '/api/system-users', {\n        ...data,\n        userType: 'opus_user',\n        companyId: OPUS_COMPANY_ID,\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/system-users'] });\n      setIsCreateDialogOpen(false);\n      setEditingUser(null);\n      form.reset();\n      toast({\n        title: 'Sucesso',\n        description: 'Usuário do sistema criado com sucesso!',\n      });\n    },\n    onError: (error) => {\n      toast({\n        title: 'Erro',\n        description: error.message,\n        variant: 'destructive',\n      });\n    },\n  });\n\n  const updateUserMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: Partial<CreateUserForm> }) => {\n      await apiRequest('PATCH', `/api/system-users/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/system-users'] });\n      setIsCreateDialogOpen(false);\n      setEditingUser(null);\n      form.reset();\n      toast({\n        title: 'Sucesso',\n        description: 'Usuário atualizado com sucesso!',\n      });\n    },\n    onError: (error) => {\n      toast({\n        title: 'Erro',\n        description: error.message,\n        variant: 'destructive',\n      });\n    },\n  });\n\n  const toggleUserStatusMutation = useMutation({\n    mutationFn: async ({ id, isActive }: { id: string; isActive: boolean }) => {\n      await apiRequest('PATCH', `/api/system-users/${id}/status`, { isActive });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/system-users'] });\n      toast({\n        title: 'Sucesso',\n        description: 'Status do usuário atualizado!',\n      });\n    },\n    onError: (error) => {\n      toast({\n        title: 'Erro',\n        description: error.message,\n        variant: 'destructive',\n      });\n    },\n  });\n\n  const resetPasswordMutation = useMutation({\n    mutationFn: async (userId: string) => {\n      const tempPassword = Math.random().toString(36).slice(-8) + Math.random().toString(36).slice(-4).toUpperCase();\n      await apiRequest('PATCH', `/api/system-users/${userId}`, { password: tempPassword });\n      return tempPassword;\n    },\n    onSuccess: (tempPassword, userId) => {\n      const user = users.find((u: User) => u.id === userId);\n      queryClient.invalidateQueries({ queryKey: ['/api/system-users'] });\n      toast({\n        title: 'Senha Resetada!',\n        description: (\n          <div>\n            <p className=\"font-bold\">Nova senha para {user?.username}:</p>\n            <p className=\"font-mono text-lg mt-2 bg-primary/20 p-2 rounded\">{tempPassword}</p>\n            <p className=\"text-xs mt-2\">Copie esta senha e compartilhe com segurança.</p>\n          </div>\n        ),\n        duration: 30000,\n      });\n    },\n    onError: (error) => {\n      toast({\n        title: 'Erro ao resetar senha',\n        description: error.message,\n        variant: 'destructive',\n      });\n    },\n  });\n\n  const filteredUsers = users.filter((user: User) =>\n    user.name.toLowerCase().includes(searchTerm.toLowerCase()) ||\n    user.email.toLowerCase().includes(searchTerm.toLowerCase()) ||\n    user.username.toLowerCase().includes(searchTerm.toLowerCase())\n  );\n\n  const handleEdit = (user: User) => {\n    setEditingUser(user);\n    form.reset({\n      username: user.username,\n      email: user.email,\n      name: user.name,\n      role: user.role as any,\n      password: '', // Não pré-carregar senha\n    });\n    setIsCreateDialogOpen(true);\n  };\n\n  const handleSubmit = (data: CreateUserForm) => {\n    if (editingUser) {\n      // Remover password se estiver vazia na edição\n      const updateData = data.password ? data : { ...data, password: undefined };\n      updateUserMutation.mutate({ id: editingUser.id, data: updateData });\n    } else {\n      createUserMutation.mutate(data);\n    }\n  };\n\n  const getCustomRoleName = (user: User & { customRoles?: any[] }) => {\n    if (user.customRoles && user.customRoles.length > 0) {\n      return user.customRoles[0].role.name;\n    }\n    // Fallback para usar o role padrão do usuário\n    switch (user.role) {\n      case 'admin':\n        return 'Administrador';\n      case 'gestor_cliente':\n        return 'Gestor de Cliente';\n      case 'supervisor_site':\n        return 'Supervisor de Local';\n      case 'operador':\n        return 'Operador';\n      case 'auditor':\n        return 'Auditor';\n      default:\n        return null;\n    }\n  };\n\n  const getRoleBadgeColor = (user: User & { customRoles?: any[] }) => {\n    const customRole = getCustomRoleName(user);\n    \n    if (customRole) {\n      // Cores para custom roles\n      if (customRole.toLowerCase().includes('admin')) return 'destructive';\n      if (customRole.toLowerCase().includes('cliente')) return 'default';\n      if (customRole.toLowerCase().includes('operador')) return 'outline';\n      return 'secondary';\n    }\n    \n    // Fallback para roles antigos (se não tiver custom role)\n    switch (user.role) {\n      case 'admin':\n        return 'destructive';\n      case 'gestor_cliente':\n        return 'default';\n      case 'supervisor_site':\n        return 'secondary';\n      case 'operador':\n        return 'outline';\n      case 'auditor':\n        return 'secondary';\n      default:\n        return 'outline';\n    }\n  };\n\n  const getRoleLabel = (user: User & { customRoles?: any[] }) => {\n    const customRole = getCustomRoleName(user);\n    if (customRole) {\n      return customRole;\n    }\n    \n    // Fallback para roles antigos\n    switch (user.role) {\n      case 'admin':\n        return 'Administrador';\n      case 'gestor_cliente':\n        return 'Gestor de Cliente';\n      case 'supervisor_site':\n        return 'Supervisor de Local';\n      case 'operador':\n        return 'Operador';\n      case 'auditor':\n        return 'Auditor';\n      default:\n        return user.role;\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"flex-1 flex items-center justify-center\">\n        <div className=\"text-muted-foreground\">Carregando...</div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"flex-1 p-6 space-y-6\">\n      <div className=\"flex justify-between items-start\">\n        <div>\n          <h1 className=\"text-3xl font-bold text-foreground flex items-center gap-3\">\n            <Building2 className=\"h-8 w-8\" />\n            Usuários do Sistema OPUS\n          </h1>\n          <p className=\"text-muted-foreground mt-2\">\n            Gerenciar funcionários da empresa OPUS CLEAN\n          </p>\n        </div>\n\n        <Dialog open={isCreateDialogOpen} onOpenChange={setIsCreateDialogOpen}>\n          <DialogTrigger asChild>\n            <Button \n              onClick={() => {\n                setEditingUser(null);\n                form.reset();\n              }}\n              data-testid=\"button-create-system-user\"\n            >\n              <Plus className=\"h-4 w-4 mr-2\" />\n              Novo Usuário OPUS\n            </Button>\n          </DialogTrigger>\n          <DialogContent className=\"max-h-[90vh] overflow-y-auto\">\n            <DialogHeader>\n              <DialogTitle>\n                {editingUser ? 'Editar Usuário OPUS' : 'Novo Usuário OPUS'}\n              </DialogTitle>\n              <DialogDescription>\n                {editingUser ? 'Edite os dados do usuário' : 'Crie um novo funcionário da OPUS CLEAN'}\n              </DialogDescription>\n            </DialogHeader>\n\n            <Form {...form}>\n              <form onSubmit={form.handleSubmit(handleSubmit)} className=\"space-y-4\">\n                <FormField\n                  control={form.control}\n                  name=\"username\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Username</FormLabel>\n                      <FormControl>\n                        <Input \n                          placeholder=\"usuario123\"\n                          data-testid=\"input-username\"\n                          {...field} \n                        />\n                      </FormControl>\n                    </FormItem>\n                  )}\n                />\n                \n                <FormField\n                  control={form.control}\n                  name=\"email\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Email</FormLabel>\n                      <FormControl>\n                        <Input \n                          type=\"email\"\n                          placeholder=\"usuario@grupoopus.com\"\n                          data-testid=\"input-email\"\n                          {...field} \n                        />\n                      </FormControl>\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"name\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Nome Completo</FormLabel>\n                      <FormControl>\n                        <Input \n                          placeholder=\"João Silva\"\n                          data-testid=\"input-name\"\n                          {...field} \n                        />\n                      </FormControl>\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"password\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>\n                        {editingUser ? 'Nova Senha (deixe vazio para manter)' : 'Senha'}\n                      </FormLabel>\n                      <FormControl>\n                        <Input \n                          type=\"password\"\n                          placeholder={editingUser ? \"Nova senha (opcional)\" : \"Digite uma senha\"}\n                          data-testid=\"input-password\"\n                          {...field} \n                        />\n                      </FormControl>\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"role\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Função</FormLabel>\n                      <Select onValueChange={field.onChange} value={field.value}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-role\">\n                            <SelectValue placeholder=\"Selecione uma função\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          <SelectItem value=\"admin\">Administrador</SelectItem>\n                          <SelectItem value=\"gestor_cliente\">Gestor de Cliente</SelectItem>\n                          <SelectItem value=\"supervisor_site\">Supervisor de Local</SelectItem>\n                          <SelectItem value=\"operador\">Operador</SelectItem>\n                          <SelectItem value=\"auditor\">Auditor</SelectItem>\n                        </SelectContent>\n                      </Select>\n                    </FormItem>\n                  )}\n                />\n\n                <div className=\"flex justify-end space-x-2\">\n                  <Button \n                    type=\"button\" \n                    variant=\"outline\" \n                    onClick={() => setIsCreateDialogOpen(false)}\n                    data-testid=\"button-cancel\"\n                  >\n                    Cancelar\n                  </Button>\n                  <Button \n                    type=\"submit\" \n                    disabled={createUserMutation.isPending || updateUserMutation.isPending}\n                    data-testid=\"button-save\"\n                  >\n                    {(createUserMutation.isPending || updateUserMutation.isPending) ? 'Salvando...' : 'Salvar'}\n                  </Button>\n                </div>\n              </form>\n            </Form>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <div className=\"flex justify-between items-center\">\n            <div>\n              <CardTitle>Usuários OPUS Cadastrados</CardTitle>\n              <CardDescription>\n                Total de {filteredUsers.length} funcionário(s) OPUS\n              </CardDescription>\n            </div>\n            <Input\n              placeholder=\"Buscar por nome, email ou username...\"\n              value={searchTerm}\n              onChange={(e) => setSearchTerm(e.target.value)}\n              className=\"max-w-sm\"\n              data-testid=\"input-search\"\n            />\n          </div>\n        </CardHeader>\n        <CardContent>\n          {filteredUsers.length === 0 ? (\n            <div className=\"text-center py-12\">\n              <Users className=\"h-12 w-12 text-muted-foreground mx-auto mb-4\" />\n              <h3 className=\"text-lg font-semibold mb-2\">Nenhum usuário encontrado</h3>\n              <p className=\"text-muted-foreground\">\n                {searchTerm ? 'Tente ajustar sua busca' : 'Crie o primeiro usuário OPUS'}\n              </p>\n            </div>\n          ) : (\n            <div className=\"grid gap-4\">\n              {filteredUsers.map((user: User) => (\n                <Card key={user.id} className=\"border-l-4 border-l-primary\">\n                  <CardHeader>\n                    <div className=\"flex justify-between items-start\">\n                      <div className=\"flex-1\">\n                        <div className=\"flex items-center gap-3 mb-2\">\n                          <CardTitle className=\"text-lg\">{user.name}</CardTitle>\n                          {getCustomRoleName(user) ? (\n                            <Badge variant={getRoleBadgeColor(user)}>\n                              {getRoleLabel(user)}\n                            </Badge>\n                          ) : (\n                            <Badge variant=\"destructive\" className=\"animate-pulse\">\n                              ⚠️ SEM PERFIL\n                            </Badge>\n                          )}\n                          {!user.isActive && (\n                            <Badge variant=\"destructive\">Inativo</Badge>\n                          )}\n                        </div>\n                        <CardDescription>\n                          <div className=\"space-y-1\">\n                            <div><strong>Username:</strong> {user.username}</div>\n                            <div><strong>Email:</strong> {user.email}</div>\n                          </div>\n                        </CardDescription>\n                      </div>\n                      <div className=\"flex gap-1\">\n                        <Button\n                          variant=\"outline\"\n                          size=\"icon\"\n                          className=\"h-8 w-8\"\n                          onClick={() => handleEdit(user)}\n                          data-testid={`button-edit-${user.id}`}\n                          title=\"Editar\"\n                        >\n                          <Edit className=\"h-4 w-4\" />\n                        </Button>\n                        <Button\n                          variant=\"outline\"\n                          size=\"icon\"\n                          className=\"h-8 w-8\"\n                          onClick={() => {\n                            if (confirm(`Resetar senha de ${user.name}? Uma nova senha será gerada e exibida.`)) {\n                              resetPasswordMutation.mutate(user.id);\n                            }\n                          }}\n                          disabled={resetPasswordMutation.isPending}\n                          data-testid={`button-reset-password-${user.id}`}\n                          title=\"Resetar Senha\"\n                        >\n                          <KeyRound className=\"h-4 w-4\" />\n                        </Button>\n                        <Button\n                          variant=\"outline\"\n                          size=\"icon\"\n                          className={`h-8 w-8 ${user.isActive ? 'text-destructive hover:bg-destructive hover:text-destructive-foreground' : 'text-green-600 hover:bg-green-600 hover:text-white'}`}\n                          onClick={() => toggleUserStatusMutation.mutate({ \n                            id: user.id, \n                            isActive: !user.isActive \n                          })}\n                          data-testid={`button-toggle-${user.id}`}\n                          title={user.isActive ? 'Desativar' : 'Ativar'}\n                        >\n                          {user.isActive ? <Trash2 className=\"h-4 w-4\" /> : <Plus className=\"h-4 w-4\" />}\n                        </Button>\n                      </div>\n                    </div>\n                  </CardHeader>\n                </Card>\n              ))}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}","size_bytes":20109},"client/src/components/ui/carousel.tsx":{"content":"import * as React from \"react\"\nimport useEmblaCarousel, {\n  type UseEmblaCarouselType,\n} from \"embla-carousel-react\"\nimport { ArrowLeft, ArrowRight } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\n\ntype CarouselApi = UseEmblaCarouselType[1]\ntype UseCarouselParameters = Parameters<typeof useEmblaCarousel>\ntype CarouselOptions = UseCarouselParameters[0]\ntype CarouselPlugin = UseCarouselParameters[1]\n\ntype CarouselProps = {\n  opts?: CarouselOptions\n  plugins?: CarouselPlugin\n  orientation?: \"horizontal\" | \"vertical\"\n  setApi?: (api: CarouselApi) => void\n}\n\ntype CarouselContextProps = {\n  carouselRef: ReturnType<typeof useEmblaCarousel>[0]\n  api: ReturnType<typeof useEmblaCarousel>[1]\n  scrollPrev: () => void\n  scrollNext: () => void\n  canScrollPrev: boolean\n  canScrollNext: boolean\n} & CarouselProps\n\nconst CarouselContext = React.createContext<CarouselContextProps | null>(null)\n\nfunction useCarousel() {\n  const context = React.useContext(CarouselContext)\n\n  if (!context) {\n    throw new Error(\"useCarousel must be used within a <Carousel />\")\n  }\n\n  return context\n}\n\nconst Carousel = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & CarouselProps\n>(\n  (\n    {\n      orientation = \"horizontal\",\n      opts,\n      setApi,\n      plugins,\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const [carouselRef, api] = useEmblaCarousel(\n      {\n        ...opts,\n        axis: orientation === \"horizontal\" ? \"x\" : \"y\",\n      },\n      plugins\n    )\n    const [canScrollPrev, setCanScrollPrev] = React.useState(false)\n    const [canScrollNext, setCanScrollNext] = React.useState(false)\n\n    const onSelect = React.useCallback((api: CarouselApi) => {\n      if (!api) {\n        return\n      }\n\n      setCanScrollPrev(api.canScrollPrev())\n      setCanScrollNext(api.canScrollNext())\n    }, [])\n\n    const scrollPrev = React.useCallback(() => {\n      api?.scrollPrev()\n    }, [api])\n\n    const scrollNext = React.useCallback(() => {\n      api?.scrollNext()\n    }, [api])\n\n    const handleKeyDown = React.useCallback(\n      (event: React.KeyboardEvent<HTMLDivElement>) => {\n        if (event.key === \"ArrowLeft\") {\n          event.preventDefault()\n          scrollPrev()\n        } else if (event.key === \"ArrowRight\") {\n          event.preventDefault()\n          scrollNext()\n        }\n      },\n      [scrollPrev, scrollNext]\n    )\n\n    React.useEffect(() => {\n      if (!api || !setApi) {\n        return\n      }\n\n      setApi(api)\n    }, [api, setApi])\n\n    React.useEffect(() => {\n      if (!api) {\n        return\n      }\n\n      onSelect(api)\n      api.on(\"reInit\", onSelect)\n      api.on(\"select\", onSelect)\n\n      return () => {\n        api?.off(\"select\", onSelect)\n      }\n    }, [api, onSelect])\n\n    return (\n      <CarouselContext.Provider\n        value={{\n          carouselRef,\n          api: api,\n          opts,\n          orientation:\n            orientation || (opts?.axis === \"y\" ? \"vertical\" : \"horizontal\"),\n          scrollPrev,\n          scrollNext,\n          canScrollPrev,\n          canScrollNext,\n        }}\n      >\n        <div\n          ref={ref}\n          onKeyDownCapture={handleKeyDown}\n          className={cn(\"relative\", className)}\n          role=\"region\"\n          aria-roledescription=\"carousel\"\n          {...props}\n        >\n          {children}\n        </div>\n      </CarouselContext.Provider>\n    )\n  }\n)\nCarousel.displayName = \"Carousel\"\n\nconst CarouselContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { carouselRef, orientation } = useCarousel()\n\n  return (\n    <div ref={carouselRef} className=\"overflow-hidden\">\n      <div\n        ref={ref}\n        className={cn(\n          \"flex\",\n          orientation === \"horizontal\" ? \"-ml-4\" : \"-mt-4 flex-col\",\n          className\n        )}\n        {...props}\n      />\n    </div>\n  )\n})\nCarouselContent.displayName = \"CarouselContent\"\n\nconst CarouselItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { orientation } = useCarousel()\n\n  return (\n    <div\n      ref={ref}\n      role=\"group\"\n      aria-roledescription=\"slide\"\n      className={cn(\n        \"min-w-0 shrink-0 grow-0 basis-full\",\n        orientation === \"horizontal\" ? \"pl-4\" : \"pt-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nCarouselItem.displayName = \"CarouselItem\"\n\nconst CarouselPrevious = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollPrev, canScrollPrev } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute  h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-left-12 top-1/2 -translate-y-1/2\"\n          : \"-top-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollPrev}\n      onClick={scrollPrev}\n      {...props}\n    >\n      <ArrowLeft className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Previous slide</span>\n    </Button>\n  )\n})\nCarouselPrevious.displayName = \"CarouselPrevious\"\n\nconst CarouselNext = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollNext, canScrollNext } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-right-12 top-1/2 -translate-y-1/2\"\n          : \"-bottom-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollNext}\n      onClick={scrollNext}\n      {...props}\n    >\n      <ArrowRight className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Next slide</span>\n    </Button>\n  )\n})\nCarouselNext.displayName = \"CarouselNext\"\n\nexport {\n  type CarouselApi,\n  Carousel,\n  CarouselContent,\n  CarouselItem,\n  CarouselPrevious,\n  CarouselNext,\n}\n","size_bytes":6210},"replit.md":{"content":"# OPUS - Project Summary\n\n> **📚 Documentação Completa**: Para documentação técnica detalhada, arquitetura, fluxos e changelog, consulte [DOCUMENTATION.md](./DOCUMENTATION.md)\n\n# Overview\n\nOPUS is a modular facilities management platform designed to streamline operations and enhance efficiency. It currently includes OPUS Clean for cleaning and facilities management and OPUS Manutenção for maintenance management. The platform offers web-based administration and mobile applications, supporting scheduling, work order management, QR code-based task execution, and public service requests. OPUS is built to serve multiple companies, sites, and zones, providing real-time analytics through a modern full-stack architecture, with the vision of offering a comprehensive, scalable solution for modern facilities management.\n\n# User Preferences\n\nPreferred communication style: Simple, everyday language.\n\n# System Architecture\n\n## UI/UX Decisions\n\n**Design System (Atualizado em 05/11/2025)**: O sistema implementa um design **predominantemente BRANCO e moderno**, com gradientes sutis que criam profundidade visual. As cores dos módulos (azul para Clean, laranja para Manutenção) aparecem apenas como identificação em badges, botões primários e bordas de ênfase. \n\nO frontend utiliza:\n- **shadcn/ui** com Radix UI primitives e Tailwind CSS\n- **Componentes modernos reutilizáveis**: ModernCard, ModernPageHeader, ModernCardContent\n- **Hook de tema dinâmico**: `use-module-theme` que adapta cores baseado no módulo ativo\n- **Gradientes sutis**: Backgrounds com gradientes white-to-light-gray que criam profundidade\n- **Glassmorphism**: Cards com efeito glass (backdrop-blur) para visual sofisticado\n- **Paleta neutra**: Fundos com gradientes suaves, sombras cinza discretas, bordas limpas\n- **Identificação por módulo**: Cor do módulo apenas em elementos focais (botões, badges, ícones)\n- **Responsividade**: Design otimizado para desktop e mobile com navegação streamlined\n\n**Variantes de Cards**:\n- `default`: Card branco limpo com borda sutil\n- `gradient`: Card com gradiente muito sutil (white-to-module-color/20)\n- `glass`: Card glassmorphism com backdrop-blur e gradiente translúcido\n- `featured`: Card com cor do módulo (destaque)\n\n**Páginas com Design Moderno Aplicado**:\n- Dashboard (ambos módulos) - gradientes de página e section, cards glass\n- Equipment (Manutenção) - gradientes modernos, cards gradient\n- Maintenance Plans (Manutenção) - gradientes de página, cards glass com calendário integrado\n- Checklists (Clean) - gradientes modernos, ModernCard com variantes gradient e glass\n\nMobile interfaces são otimizadas para elementos touch-friendly, incluindo sticky headers e funcionalidade pull-to-refresh.\n\n## Technical Implementations\n\n### Frontend\n\nDeveloped with React and TypeScript, using Wouter for routing and TanStack Query for data management. Vite handles development and build processes.\n\n### Backend\n\nAn Express.js server, written in TypeScript, follows RESTful API principles. It features a layered architecture and uses Drizzle ORM for type-safe interactions with PostgreSQL.\n\n## Feature Specifications\n\n### Multi-Tenancy\n\nThe platform implements a hierarchical multi-tenancy model (Companies > Sites > Zones) with robust role-based access controls and client-specific, module-isolated data filtering. Each module (OPUS Clean, OPUS Manutenção) has completely isolated data for sites, zones, work orders, QR codes, and configuration tables (service categories, checklist templates, SLA configs, equipment, maintenance checklist templates, maintenance plans).\n\n**Module-Specific Page Protection**: All module-specific pages include built-in verification to prevent cross-module access. Pages exclusive to OPUS Clean cannot be accessed when OPUS Manutenção is active, and vice versa. Users attempting to access restricted pages see a friendly error message directing them to switch modules.\n\n### Equipment Management (Maintenance Module)\n\nThe Maintenance module uses direct equipment selection for checklist assignment and maintenance planning. Equipment can be managed through the Equipment page and selected directly when creating:\n\n**Maintenance Checklist Templates**: Templates can target one or multiple specific equipment items using a multiselect interface. This allows both individual equipment targeting and group management by selecting multiple pieces of equipment that share similar maintenance procedures.\n\n**Maintenance Plans**: Plans support selecting multiple equipment items, with the system automatically generating work orders for each selected equipment based on the configured frequency and schedule.\n\nAll equipment is customer-specific and module-specific, managed through the Equipment page accessible via the sidebar in OPUS Manutenção.\n\n### QR Code System\n\nSupports two types of QR codes: Execution QRs for internal staff work order management and Public QRs for end-users to submit service requests, which automatically generate corrective work orders.\n\n### Work Order Management\n\nManages programmed, internal corrective, and public corrective work orders. It tracks status, SLA compliance, priority, operator assignments, allows comments with photo attachments, and supports re-opening. All analytics are derived from real-time PostgreSQL data.\n\n**Automated Monthly Work Order Generation (Maintenance Module)**: To optimize database performance, the system uses a dual approach for work order visibility and persistence:\n\n1. **Virtual Calendar Display**: The Maintenance Plans page (`/maintenance-plans`) includes an integrated calendar view that shows all future planned maintenance activities by calculating them on-the-fly based on maintenance plan frequency settings. Activities are color-coded by frequency (daily=green, weekly=blue, shift-based=orange, monthly=purple, quarterly=indigo, semi-annual=violet, annual=rose). This provides complete visibility of upcoming work without database overhead.\n\n2. **Deferred Database Creation**: When a maintenance plan is created, NO work orders are immediately generated in the database. Instead, on the last day of each month at 23:00, an automated scheduler runs and pre-generates actual work orders for the following month across all companies.\n\nThis approach balances operational planning needs (users can see future schedules) with database efficiency (only current/next month orders exist in the database).\n\n### Authentication and Authorization\n\nSupports Microsoft SSO (Entra ID) and email/password authentication. Security measures include JWT, Bcrypt for password hashing, rate limiting, data sanitization, CORS, Helmet.js, and SQL injection prevention. A custom role system provides granular, permission-based access for predefined roles with differentiated routing for web and mobile users.\n\n**Module Access Control**: The system implements strict module-based access control for both web and mobile platforms. Each user (stored in `users.modules` array) and customer (stored in `customers.modules` array) has assigned modules (`clean`, `maintenance`, or both). The `ModuleContext` validates module access on every route, automatically correcting invalid module selections and enforcing restrictions. Mobile users see a visual module indicator in the header, and the sidebar dynamically shows/hides the module selector based on user permissions (hidden if only 1 module, shown as dropdown if 2+ modules). This ensures collaborators registered for maintenance only see maintenance data and cannot access cleaning module features, and vice versa.\n\n### Dashboard\n\nProvides analytical charts for work orders, including distribution by priority and location, average completion time, and activity trends, all powered by real-time data. Dashboard goals are integrated with visual indicators.\n\n### User Management\n\nOffers full CRUD operations for users, including client user creation and custom role assignment, with clear indicators for roles and mobile access.\n\n## System Design Choices\n\nThe project is configured for the Replit cloud environment, with automated PostgreSQL provisioning, schema pushing, and dependency installation. The Vite dev server is compatible with Replit's proxy. The system is designed to be modular, supporting new operational modules with distinct theming and data isolation. The term \"Site\" has been renamed to \"Local\" in the UI for clarity, while retaining \"siteId\" in the backend.\n\n# External Dependencies\n\n## Database\n-   **PostgreSQL**: Primary relational database.\n-   **Neon**: Serverless PostgreSQL hosting.\n-   **Drizzle ORM**: Type-safe ORM for database interactions.\n\n## UI Components\n-   **Radix UI**: Accessible primitive UI components.\n-   **shadcn/ui**: Component library built on Radix UI and Tailwind CSS.\n-   **Tailwind CSS**: Utility-first CSS framework for styling.\n\n## Development Tools\n-   **Vite**: Fast build tool and development server.\n-   **TypeScript**: Superset of JavaScript for type-safe code.\n-   **TanStack Query**: Data fetching and state management library.\n-   **Wouter**: Lightweight React router.\n\n## Security & Authentication\n-   **JWT (jsonwebtoken)**: For creating and verifying access tokens.\n-   **Helmet**: Helps secure Express apps by setting various HTTP headers.\n-   **CORS**: Middleware for enabling Cross-Origin Resource Sharing.\n-   **Express Rate Limit**: Middleware for basic rate-limiting to prevent abuse.\n-   **Bcrypt**: For hashing passwords securely.\n-   **Microsoft Entra ID**: For single sign-on (SSO) capabilities.","size_bytes":9548},"client/src/components/create-work-order-modal.tsx":{"content":"import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Label } from \"@/components/ui/label\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useState } from \"react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { X, Save, Calendar, Timer, MapPin, User, Settings, AlertCircle, CheckSquare } from \"lucide-react\";\n\ninterface CreateWorkOrderModalProps {\n  customerId: string;\n  onClose: () => void;\n  onSuccess: () => void;\n}\n\nexport default function CreateWorkOrderModal({ customerId, onClose, onSuccess }: CreateWorkOrderModalProps) {\n  const [formData, setFormData] = useState({\n    title: \"\",\n    description: \"\",\n    type: \"corretiva_interna\",\n    priority: \"media\",\n    zoneId: \"\",\n    assignedUserId: \"unassigned\",\n    serviceId: \"\",\n    scheduledDate: \"\",\n    dueDate: \"\",\n    // Campos opcionais de horário\n    startTime: \"\",\n    endTime: \"\"\n  });\n  \n  const { toast } = useToast();\n\n  const { data: sites } = useQuery({\n    queryKey: [\"/api/customers\", customerId, \"sites\"],\n    enabled: !!customerId,\n  });\n\n  const { data: users } = useQuery({\n    queryKey: [\"/api/customers\", customerId, \"users\"],\n    enabled: !!customerId,\n  });\n\n  const { data: services } = useQuery({\n    queryKey: [\"/api/customers\", customerId, \"services\"],\n    enabled: !!customerId,\n  });\n\n  // Buscar dados do customer para pegar o companyId\n  const { data: customer } = useQuery({\n    queryKey: [\"/api/customers\", customerId],\n    enabled: !!customerId,\n  });\n\n  // Carregar todas as zones de todos os sites\n  const { data: allZones } = useQuery({\n    queryKey: [\"/api/customers\", customerId, \"all-zones\"],\n    queryFn: async () => {\n      if (!sites || !Array.isArray(sites)) return [];\n      \n      const zonePromises = sites.map(async (site: any) => {\n        const response = await apiRequest(\"GET\", `/api/sites/${site.id}/zones`);\n        const zones = await response.json() as any[];\n        return zones.map(zone => ({\n          ...zone,\n          siteName: site.name\n        }));\n      });\n      \n      const allSitesZones = await Promise.all(zonePromises);\n      return allSitesZones.flat();\n    },\n    enabled: !!sites && Array.isArray(sites),\n  });\n\n\n  const createWorkOrderMutation = useMutation({\n    mutationFn: async (data: any) => {\n      // Preparar dados para envio - converter strings de data para Date objects ou null\n      const submitData: any = {\n        title: data.title,\n        description: data.description || null,\n        type: data.type,\n        priority: data.priority,\n        status: \"aberta\",\n        zoneId: data.zoneId,\n        serviceId: data.serviceId || null,\n        companyId: (customer as any)?.companyId || \"company-opus-default\",\n        assignedUserId: data.assignedUserId === \"unassigned\" ? null : data.assignedUserId,\n        scheduledDate: data.scheduledDate || null,\n        dueDate: data.dueDate || null,\n        scheduledStartAt: null,\n        scheduledEndAt: null,\n      };\n      \n      // Calcular scheduledStartAt e scheduledEndAt se tiver horários\n      if (data.scheduledDate && data.startTime) {\n        const baseDate = new Date(data.scheduledDate);\n        const [hours, minutes] = data.startTime.split(':');\n        baseDate.setHours(parseInt(hours), parseInt(minutes), 0, 0);\n        submitData.scheduledStartAt = baseDate.toISOString();\n      }\n      \n      if (data.scheduledDate && data.endTime) {\n        const endDate = new Date(data.scheduledDate);\n        const [hours, minutes] = data.endTime.split(':');\n        endDate.setHours(parseInt(hours), parseInt(minutes), 0, 0);\n        submitData.scheduledEndAt = endDate.toISOString();\n      }\n      \n      return await apiRequest(\"POST\", \"/api/work-orders\", submitData);\n    },\n    onSuccess: () => {\n      toast({ title: \"Ordem de serviço criada com sucesso!\" });\n      onSuccess();\n    },\n    onError: (error: any) => {\n      let errorMessage = \"Erro ao criar ordem de serviço\";\n      let errorDetails = \"Verifique se todos os campos obrigatórios foram preenchidos corretamente.\";\n      \n      // Tentar extrair mensagem do erro\n      if (error?.message) {\n        // Se a mensagem for um JSON string, fazer parse\n        if (error.message.startsWith('{')) {\n          try {\n            const parsed = JSON.parse(error.message);\n            errorMessage = parsed.message || errorMessage;\n            errorDetails = parsed.details || errorDetails;\n          } catch (e) {\n            errorMessage = error.message;\n          }\n        } else {\n          errorMessage = error.message;\n        }\n      }\n      \n      // Se já tiver details separado, usar ele\n      if (error?.details) {\n        errorDetails = error.details;\n      }\n      \n      toast({ \n        title: errorMessage,\n        description: errorDetails,\n        variant: \"destructive\" \n      });\n    },\n  });\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (!formData.title || !formData.zoneId || !formData.serviceId) {\n      toast({\n        title: \"Campos obrigatórios\",\n        description: \"Preencha o título, selecione um local e um serviço\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    createWorkOrderMutation.mutate(formData);\n  };\n\n  const handleChange = (field: string, value: string) => {\n    setFormData(prev => ({ ...prev, [field]: value }));\n  };\n\n  return (\n    <Dialog open={true} onOpenChange={onClose}>\n      <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\" data-testid=\"create-work-order-modal\">\n        <DialogHeader>\n          <DialogTitle className=\"text-xl font-bold\">Nova Ordem de Serviço</DialogTitle>\n          <DialogDescription>\n            Preencha as informações para criar uma nova ordem de serviço\n          </DialogDescription>\n        </DialogHeader>\n        \n        <form onSubmit={handleSubmit} className=\"space-y-8\">\n          {/* Informações Básicas */}\n          <div className=\"space-y-4 p-4 bg-blue-50 rounded-lg border border-blue-200\">\n            <h4 className=\"font-semibold text-blue-900 flex items-center gap-2\">\n              <Settings className=\"w-4 h-4\" />\n              Informações Básicas\n            </h4>\n            \n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"title\">Título *</Label>\n                <Input\n                  id=\"title\"\n                  placeholder=\"Ex: Limpeza do banheiro masculino\"\n                  value={formData.title}\n                  onChange={(e) => handleChange(\"title\", e.target.value)}\n                  data-testid=\"input-title\"\n                  required\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"type\">Tipo de OS</Label>\n                <Select value={formData.type} onValueChange={(value) => handleChange(\"type\", value)}>\n                  <SelectTrigger data-testid=\"select-type\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"programada\">Programada</SelectItem>\n                    <SelectItem value=\"corretiva_interna\">Corretiva Interna</SelectItem>\n                    <SelectItem value=\"corretiva_publica\">Corretiva Pública</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"priority\">Prioridade</Label>\n                <Select value={formData.priority} onValueChange={(value) => handleChange(\"priority\", value)}>\n                  <SelectTrigger data-testid=\"select-priority\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"baixa\">Baixa</SelectItem>\n                    <SelectItem value=\"media\">Média</SelectItem>\n                    <SelectItem value=\"alta\">Alta</SelectItem>\n                    <SelectItem value=\"critica\">Crítica</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"assigned\">Responsável</Label>\n                <Select value={formData.assignedUserId} onValueChange={(value) => handleChange(\"assignedUserId\", value)}>\n                  <SelectTrigger data-testid=\"select-assigned-user\">\n                    <SelectValue placeholder=\"Selecione um responsável\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"unassigned\">Não atribuído</SelectItem>\n                    {(users as any[] || [])\n                      .filter((user: any) => user.role === \"operador\" || user.role === \"supervisor_site\")\n                      .map((user: any) => (\n                        <SelectItem key={user.id} value={user.id}>\n                          <div className=\"flex items-center gap-2\">\n                            <User className=\"w-4 h-4\" />\n                            {user.name}\n                          </div>\n                        </SelectItem>\n                      ))}\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"description\">Descrição</Label>\n              <Textarea\n                id=\"description\"\n                placeholder=\"Descreva detalhes sobre a ordem de serviço...\"\n                value={formData.description}\n                onChange={(e) => handleChange(\"description\", e.target.value)}\n                data-testid=\"textarea-description\"\n                rows={3}\n              />\n            </div>\n          </div>\n\n          {/* Local e Serviços */}\n          <div className=\"space-y-4 p-4 bg-green-50 rounded-lg border border-green-200\">\n            <h4 className=\"font-semibold text-green-900 flex items-center gap-2\">\n              <MapPin className=\"w-4 h-4\" />\n              Local e Serviços\n            </h4>\n            \n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"zone\">Local *</Label>\n                <Select value={formData.zoneId} onValueChange={(value) => handleChange(\"zoneId\", value)}>\n                  <SelectTrigger data-testid=\"select-zone\">\n                    <SelectValue placeholder=\"Selecione um local\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {!allZones ? (\n                      <SelectItem value=\"loading\" disabled>Carregando locais...</SelectItem>\n                    ) : Array.isArray(allZones) && allZones.length > 0 ? (\n                      allZones.map((zone: any) => (\n                        <SelectItem key={zone.id} value={zone.id}>\n                          <div>\n                            <div className=\"font-medium\">{zone.name}</div>\n                            <div className=\"text-xs text-gray-500\">{zone.siteName}</div>\n                          </div>\n                        </SelectItem>\n                      ))\n                    ) : (\n                      <SelectItem value=\"no-zones\" disabled>Nenhum local cadastrado</SelectItem>\n                    )}\n                  </SelectContent>\n                </Select>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"service\">Serviço *</Label>\n                <Select value={formData.serviceId} onValueChange={(value) => handleChange(\"serviceId\", value)}>\n                  <SelectTrigger data-testid=\"select-service\">\n                    <SelectValue placeholder=\"Selecione um serviço\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {(services as any[] || []).map((service: any) => (\n                      <SelectItem key={service.id} value={service.id}>\n                        <div>\n                          <div className=\"font-medium\">{service.name}</div>\n                          <div className=\"text-xs text-gray-500\">{service.description}</div>\n                        </div>\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n\n            </div>\n          </div>\n\n\n          {/* Datas de Planejamento */}\n          <div className=\"space-y-4 p-4 bg-amber-50 rounded-lg border border-amber-200\">\n            <h4 className=\"font-semibold text-amber-900 flex items-center gap-2\">\n              <Calendar className=\"w-4 h-4\" />\n              Datas de Planejamento\n            </h4>\n            \n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"scheduledDate\">Data Agendada</Label>\n                <Input\n                  id=\"scheduledDate\"\n                  type=\"date\"\n                  value={formData.scheduledDate}\n                  onChange={(e) => handleChange(\"scheduledDate\", e.target.value)}\n                  data-testid=\"input-scheduled-date\"\n                />\n              </div>\n\n              {/* Campos opcionais de horário */}\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"startTime\">Horário de Início (opcional)</Label>\n                <Input\n                  id=\"startTime\"\n                  type=\"time\"\n                  placeholder=\"Ex: 08:00\"\n                  value={formData.startTime}\n                  onChange={(e) => handleChange(\"startTime\", e.target.value)}\n                  data-testid=\"input-start-time\"\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"endTime\">Horário de Fim (opcional)</Label>\n                <Input\n                  id=\"endTime\"\n                  type=\"time\"\n                  placeholder=\"Ex: 18:00\"\n                  value={formData.endTime}\n                  onChange={(e) => handleChange(\"endTime\", e.target.value)}\n                  data-testid=\"input-end-time\"\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"dueDate\">Data Limite</Label>\n                <Input\n                  id=\"dueDate\"\n                  type=\"date\"\n                  value={formData.dueDate}\n                  onChange={(e) => handleChange(\"dueDate\", e.target.value)}\n                  data-testid=\"input-due-date\"\n                />\n              </div>\n            </div>\n          </div>\n\n          <div className=\"flex justify-end space-x-3 pt-4 border-t\">\n            <Button \n              type=\"button\" \n              variant=\"outline\" \n              onClick={onClose}\n              data-testid=\"button-cancel\"\n            >\n              Cancelar\n            </Button>\n            <Button \n              type=\"submit\"\n              disabled={createWorkOrderMutation.isPending}\n              data-testid=\"button-create\"\n            >\n              <Save className=\"w-4 h-4 mr-2\" />\n              {createWorkOrderMutation.isPending ? \"Criando...\" : \"Criar OS\"}\n            </Button>\n          </div>\n        </form>\n      </DialogContent>\n    </Dialog>\n  );\n}","size_bytes":15595},"client/src/components/ui/toggle.tsx":{"content":"import * as React from \"react\"\nimport * as TogglePrimitive from \"@radix-ui/react-toggle\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst toggleVariants = cva(\n  \"inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 gap-2\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        outline:\n          \"border border-input bg-transparent hover:bg-accent hover:text-accent-foreground\",\n      },\n      size: {\n        default: \"h-10 px-3 min-w-10\",\n        sm: \"h-9 px-2.5 min-w-9\",\n        lg: \"h-11 px-5 min-w-11\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst Toggle = React.forwardRef<\n  React.ElementRef<typeof TogglePrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, ...props }, ref) => (\n  <TogglePrimitive.Root\n    ref={ref}\n    className={cn(toggleVariants({ variant, size, className }))}\n    {...props}\n  />\n))\n\nToggle.displayName = TogglePrimitive.Root.displayName\n\nexport { Toggle, toggleVariants }\n","size_bytes":1527},"server/vite.ts":{"content":"import express, { type Express } from \"express\";\nimport fs from \"fs\";\nimport path from \"path\";\nimport { createServer as createViteServer, createLogger } from \"vite\";\nimport { type Server } from \"http\";\nimport viteConfig from \"../vite.config\";\nimport { nanoid } from \"nanoid\";\n\nconst viteLogger = createLogger();\n\nexport function log(message: string, source = \"express\") {\n  const formattedTime = new Date().toLocaleTimeString(\"en-US\", {\n    hour: \"numeric\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: true,\n  });\n\n  console.log(`${formattedTime} [${source}] ${message}`);\n}\n\nexport async function setupVite(app: Express, server: Server) {\n  const serverOptions = {\n    middlewareMode: true,\n    hmr: { server },\n    allowedHosts: true as const,\n  };\n\n  const vite = await createViteServer({\n    ...viteConfig,\n    configFile: false,\n    customLogger: {\n      ...viteLogger,\n      error: (msg, options) => {\n        viteLogger.error(msg, options);\n        process.exit(1);\n      },\n    },\n    server: serverOptions,\n    appType: \"custom\",\n  });\n\n  app.use((req, res, next) => {\n    res.setHeader('Cache-Control', 'no-store, no-cache, must-revalidate, proxy-revalidate');\n    res.setHeader('Pragma', 'no-cache');\n    res.setHeader('Expires', '0');\n    res.setHeader('Surrogate-Control', 'no-store');\n    next();\n  });\n\n  app.use(vite.middlewares);\n  app.use(\"*\", async (req, res, next) => {\n    const url = req.originalUrl;\n\n    // Skip API routes - let them be handled by the API middleware first\n    if (url.startsWith('/api/')) {\n      return next();\n    }\n\n    try {\n      const clientTemplate = path.resolve(\n        import.meta.dirname,\n        \"..\",\n        \"client\",\n        \"index.html\",\n      );\n\n      // always reload the index.html file from disk incase it changes\n      let template = await fs.promises.readFile(clientTemplate, \"utf-8\");\n      template = template.replace(\n        `src=\"/src/main.tsx\"`,\n        `src=\"/src/main.tsx?v=${nanoid()}\"`,\n      );\n      const page = await vite.transformIndexHtml(url, template);\n      res.status(200).set({ \"Content-Type\": \"text/html\" }).end(page);\n    } catch (e) {\n      vite.ssrFixStacktrace(e as Error);\n      next(e);\n    }\n  });\n}\n\nexport function serveStatic(app: Express) {\n  const distPath = path.resolve(import.meta.dirname, \"public\");\n\n  if (!fs.existsSync(distPath)) {\n    throw new Error(\n      `Could not find the build directory: ${distPath}, make sure to build the client first`,\n    );\n  }\n\n  app.use(express.static(distPath, {\n    maxAge: 0,\n    etag: false,\n    lastModified: false,\n    setHeaders: (res, path) => {\n      if (path.endsWith('.html')) {\n        res.setHeader('Cache-Control', 'no-store, no-cache, must-revalidate, proxy-revalidate');\n        res.setHeader('Pragma', 'no-cache');\n        res.setHeader('Expires', '0');\n      } else {\n        res.setHeader('Cache-Control', 'public, max-age=31536000, immutable');\n      }\n    }\n  }));\n\n  // fall through to index.html if the file doesn't exist\n  app.use(\"*\", (_req, res) => {\n    res.setHeader('Cache-Control', 'no-store, no-cache, must-revalidate, proxy-revalidate');\n    res.setHeader('Pragma', 'no-cache');\n    res.setHeader('Expires', '0');\n    res.sendFile(path.resolve(distPath, \"index.html\"));\n  });\n}\n","size_bytes":3262},"client/src/components/mobile/UsersMobile.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Search, User, Mail, Phone, Shield, Plus } from \"lucide-react\";\n\ninterface UsersMobileProps {\n  customerId: string;\n}\n\nexport default function UsersMobile({ customerId }: UsersMobileProps) {\n  const [searchTerm, setSearchTerm] = useState(\"\");\n\n  const { data: users, isLoading } = useQuery({\n    queryKey: [\"/api/customers\", customerId, \"users\"],\n    enabled: !!customerId,\n  });\n\n  const filteredUsers = (users as any[])?.filter((user: any) => {\n    return user.name?.toLowerCase().includes(searchTerm.toLowerCase()) ||\n           user.email?.toLowerCase().includes(searchTerm.toLowerCase());\n  }) || [];\n\n  const getRoleBadge = (role: string, id?: string) => {\n    const testId = id ? `badge-role-${role}-${id}` : `badge-role-${role}`;\n    switch (role) {\n      case \"admin\":\n        return <Badge className=\"bg-purple-500 text-white text-xs\" data-testid={testId}>Admin</Badge>;\n      case \"gestor_cliente\":\n        return <Badge className=\"bg-blue-500 text-white text-xs\" data-testid={testId}>Gestor</Badge>;\n      case \"supervisor_site\":\n        return <Badge className=\"bg-indigo-500 text-white text-xs\" data-testid={testId}>Supervisor</Badge>;\n      case \"operador\":\n        return <Badge className=\"bg-green-500 text-white text-xs\" data-testid={testId}>Operador</Badge>;\n      default:\n        return <Badge className=\"bg-gray-500 text-white text-xs\" data-testid={testId}>{role}</Badge>;\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"p-4 space-y-4\">\n        <div className=\"animate-pulse space-y-3\">\n          {[1,2,3].map(i => (\n            <div key={i} className=\"h-20 bg-gray-200 rounded-lg\"></div>\n          ))}\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gray-50 pb-20\">\n      {/* Header */}\n      <div className=\"bg-white border-b p-4 space-y-3 sticky top-0 z-10\">\n        <div className=\"flex items-center justify-between\">\n          <h2 className=\"text-lg font-semibold\">Usuários</h2>\n          <Button size=\"sm\" className=\"bg-blue-600\" data-testid=\"button-new-user\" disabled>\n            <Plus className=\"w-4 h-4 mr-2\" />\n            Novo\n          </Button>\n        </div>\n\n        {/* Busca */}\n        <div className=\"relative\">\n          <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4\" />\n          <Input\n            placeholder=\"Buscar usuário...\"\n            value={searchTerm}\n            onChange={(e) => setSearchTerm(e.target.value)}\n            className=\"pl-10\"\n            data-testid=\"input-search-users\"\n          />\n        </div>\n      </div>\n\n      {/* Stats */}\n      <div className=\"p-4 grid grid-cols-3 gap-3\">\n        <Card className=\"bg-gradient-to-br from-purple-500 to-purple-600 border-0\" data-testid=\"card-stats-admins\">\n          <CardContent className=\"p-3 text-center\">\n            <Shield className=\"w-5 h-5 text-white mx-auto mb-1\" />\n            <p className=\"text-xl font-bold text-white\" data-testid=\"text-count-admins\">\n              {(users as any[])?.filter((u: any) => u.role === 'admin').length || 0}\n            </p>\n            <p className=\"text-xs text-white/80\">Admins</p>\n          </CardContent>\n        </Card>\n\n        <Card className=\"bg-gradient-to-br from-blue-500 to-blue-600 border-0\" data-testid=\"card-stats-gestores\">\n          <CardContent className=\"p-3 text-center\">\n            <User className=\"w-5 h-5 text-white mx-auto mb-1\" />\n            <p className=\"text-xl font-bold text-white\" data-testid=\"text-count-gestores\">\n              {(users as any[])?.filter((u: any) => u.role === 'gestor_cliente').length || 0}\n            </p>\n            <p className=\"text-xs text-white/80\">Gestores</p>\n          </CardContent>\n        </Card>\n\n        <Card className=\"bg-gradient-to-br from-green-500 to-green-600 border-0\" data-testid=\"card-stats-operadores\">\n          <CardContent className=\"p-3 text-center\">\n            <User className=\"w-5 h-5 text-white mx-auto mb-1\" />\n            <p className=\"text-xl font-bold text-white\" data-testid=\"text-count-operadores\">\n              {(users as any[])?.filter((u: any) => u.role === 'operador').length || 0}\n            </p>\n            <p className=\"text-xs text-white/80\">Operadores</p>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Lista */}\n      <div className=\"p-4 space-y-3\">\n        <div className=\"flex items-center justify-between mb-3\">\n          <p className=\"text-sm text-gray-600\">{filteredUsers.length} usuários</p>\n        </div>\n        \n        {filteredUsers.length === 0 ? (\n          <Card>\n            <CardContent className=\"p-8 text-center text-gray-500\">\n              Nenhum usuário encontrado\n            </CardContent>\n          </Card>\n        ) : (\n          filteredUsers.map((user: any) => (\n            <Card key={user.id} className=\"hover:shadow-md transition-shadow\" data-testid={`card-user-${user.id}`}>\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-start justify-between mb-3\">\n                  <div className=\"flex items-center gap-3\">\n                    <div className=\"w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center shrink-0\">\n                      <User className=\"w-6 h-6 text-white\" />\n                    </div>\n                    <div>\n                      <p className=\"font-semibold text-gray-900\" data-testid={`text-user-name-${user.id}`}>\n                        {user.name}\n                      </p>\n                      {getRoleBadge(user.role, user.id)}\n                    </div>\n                  </div>\n                  {user.isActive ? (\n                    <Badge variant=\"outline\" className=\"bg-green-50 text-green-700 border-green-200 text-xs\" data-testid={`badge-status-active-${user.id}`}>Ativo</Badge>\n                  ) : (\n                    <Badge variant=\"outline\" className=\"bg-gray-50 text-gray-700 border-gray-200 text-xs\" data-testid={`badge-status-inactive-${user.id}`}>Inativo</Badge>\n                  )}\n                </div>\n\n                <div className=\"space-y-2 text-sm\">\n                  <div className=\"flex items-center gap-2 text-gray-600\">\n                    <Mail className=\"w-4 h-4\" />\n                    <span data-testid={`text-user-email-${user.id}`}>{user.email}</span>\n                  </div>\n                  {user.phone && (\n                    <div className=\"flex items-center gap-2 text-gray-600\">\n                      <Phone className=\"w-4 h-4\" />\n                      <span data-testid={`text-user-phone-${user.id}`}>{user.phone}</span>\n                    </div>\n                  )}\n                </div>\n              </CardContent>\n            </Card>\n          ))\n        )}\n      </div>\n    </div>\n  );\n}\n","size_bytes":7071},"client/src/pages/qr-codes.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useState, useEffect } from \"react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useClient } from \"@/contexts/ClientContext\";\nimport { useModule } from \"@/contexts/ModuleContext\";\nimport { useModuleTheme } from \"@/hooks/use-module-theme\";\nimport { ModernCard, ModernCardHeader, ModernCardContent } from \"@/components/ui/modern-card\";\nimport { ModernPageHeader } from \"@/components/ui/modern-page-header\";\nimport QRCode from \"qrcode\";\nimport { \n  QrCode as QrCodeIcon, \n  Download, \n  Plus, \n  Trash2,\n  FileText,\n  Printer,\n  Check,\n  Copy,\n  RefreshCw\n} from \"lucide-react\";\nimport jsPDF from 'jspdf';\nimport opusLogo from \"@assets/ChatGPT Image 8 de set. de 2025, 18_10_10_1757366528566.png\";\nimport grupoOpusLogo from \"@assets/logo-grupo-opus.png\";\nimport { cn } from \"@/lib/utils\";\n\nconst QR_SIZES_CM = [3, 4, 5, 6, 7, 8, 10, 12, 15];\nconst cmToPixels = (cm: number) => Math.round(cm * 28.35);\n\nexport default function QrCodes() {\n  const { activeClientId } = useClient();\n  const { currentModule } = useModule();\n  const theme = useModuleTheme();\n  const [selectedSite, setSelectedSite] = useState(\"\");\n  const [selectedZone, setSelectedZone] = useState(\"\");\n  const [pointName, setPointName] = useState(\"\");\n  const [pointCode, setPointCode] = useState(\"\");\n  const [qrSizeCm, setQrSizeCm] = useState(5);\n  const [qrCodeImages, setQrCodeImages] = useState<{[key: string]: string}>({});\n  const [selectedQrCodes, setSelectedQrCodes] = useState<string[]>([]);\n  const [isGeneratingPDF, setIsGeneratingPDF] = useState(false);\n  \n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  const { data: sites } = useQuery({\n    queryKey: [\"/api/customers\", activeClientId, \"sites\", { module: currentModule }],\n    enabled: !!activeClientId,\n  });\n\n  const { data: zones } = useQuery({\n    queryKey: [\"/api/sites\", selectedSite, \"zones\", { module: currentModule }],\n    enabled: !!selectedSite,\n  });\n\n  const { data: qrPoints, isLoading } = useQuery({\n    queryKey: [\"/api/customers\", activeClientId, \"qr-points\", { module: currentModule }],\n    enabled: !!activeClientId,\n  });\n\n  const createQrPointMutation = useMutation({\n    mutationFn: async (data: any) => {\n      return await apiRequest(\"POST\", `/api/customers/${activeClientId}/qr-points`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/customers\", activeClientId, \"qr-points\"] });\n      toast({ title: \"✅ QR Code criado com sucesso!\" });\n      setSelectedSite(\"\");\n      setSelectedZone(\"\");\n      setPointName(\"\");\n      setPointCode(\"\");\n      setQrSizeCm(5);\n    },\n    onError: () => {\n      toast({ \n        title: \"Erro ao criar QR Code\", \n        description: \"Tente novamente\",\n        variant: \"destructive\" \n      });\n    },\n  });\n\n  // Resetar zona quando mudar o site\n  useEffect(() => {\n    setSelectedZone(\"\");\n  }, [selectedSite]);\n\n  const handleCreateQrPoint = () => {\n    if (!selectedZone || !pointName) {\n      toast({ \n        title: \"Preencha todos os campos obrigatórios\", \n        description: \"Local e nome são obrigatórios\",\n        variant: \"destructive\" \n      });\n      return;\n    }\n\n    createQrPointMutation.mutate({\n      zoneId: selectedZone,\n      type: \"execucao\",\n      name: pointName,\n      sizeCm: qrSizeCm,\n      module: currentModule,\n      ...(pointCode ? { code: pointCode } : {}),\n    });\n  };\n\n  const handleRefresh = () => {\n    queryClient.invalidateQueries({ queryKey: [\"/api/customers\", activeClientId, \"qr-points\"] });\n    toast({ title: \"🔄 Atualizando lista...\" });\n  };\n\n  const generateQrCodeUrl = (type: string, code: string) => {\n    if (type === 'execucao') return code;\n    const baseUrl = window.location.origin;\n    return `${baseUrl}/qr-public/${code}`;\n  };\n\n  const generateQrCodeImage = async (url: string, sizeCm: number): Promise<string> => {\n    const sizePixels = cmToPixels(sizeCm);\n    try {\n      return await QRCode.toDataURL(url, {\n        width: sizePixels,\n        margin: 2,\n        color: { dark: '#000000', light: '#FFFFFF' }\n      });\n    } catch (error) {\n      console.error('Erro ao gerar QR code:', error);\n      return '';\n    }\n  };\n\n  useEffect(() => {\n    const generateAllQrCodes = async () => {\n      if (!qrPoints || (qrPoints as any[]).length === 0) return;\n\n      const newQrImages: {[key: string]: string} = {};\n      \n      for (const point of qrPoints as any[]) {\n        const url = generateQrCodeUrl(point.type, point.code);\n        const sizeCm = point.sizeCm || 5;\n        const qrCodeDataUrl = await generateQrCodeImage(url, sizeCm);\n        if (qrCodeDataUrl) {\n          newQrImages[point.id] = qrCodeDataUrl;\n        }\n      }\n      \n      setQrCodeImages(newQrImages);\n    };\n\n    generateAllQrCodes();\n  }, [qrPoints]);\n\n  const downloadPDF = async (point: any) => {\n    const url = generateQrCodeUrl(point.type, point.code);\n    const sizeCm = point.sizeCm || 5;\n    const qrCodeDataUrl = await generateQrCodeImage(url, sizeCm);\n    \n    const pdf = new jsPDF();\n    const pageWidth = 210;\n    const pageHeight = 297;\n    \n    // Cores baseadas no módulo\n    const moduleColor = currentModule === 'maintenance' \n      ? { r: 249, g: 115, b: 22 }  // orange-500\n      : { r: 59, g: 130, b: 246 };  // blue-500\n    \n    const moduleName = currentModule === 'maintenance' ? 'OPUS Manutenção' : 'OPUS Clean';\n    \n    // Header com cor do módulo\n    const headerHeight = 40;\n    pdf.setFillColor(moduleColor.r, moduleColor.g, moduleColor.b);\n    pdf.rect(0, 0, pageWidth, headerHeight, 'F');\n    \n    try {\n      const logoResponse = await fetch(opusLogo);\n      const logoBlob = await logoResponse.blob();\n      const logoBase64 = await new Promise<string>((resolve) => {\n        const reader = new FileReader();\n        reader.onload = () => resolve(reader.result as string);\n        reader.readAsDataURL(logoBlob);\n      });\n      \n      const logoWidth = 60;\n      const logoHeight = 24;\n      const logoX = (pageWidth - logoWidth) / 2;\n      const logoY = (headerHeight - logoHeight) / 2;\n      \n      pdf.addImage(logoBase64, 'PNG', logoX, logoY, logoWidth, logoHeight);\n    } catch (error) {\n      pdf.setFontSize(24);\n      pdf.setTextColor(255, 255, 255);\n      pdf.setFont('helvetica', 'bold');\n      pdf.text(moduleName, pageWidth / 2, headerHeight / 2 + 4, { align: 'center' });\n    }\n    \n    // QR Code com borda colorida arredondada e logo\n    const qrSizeMM = sizeCm * 10;\n    const borderMM = 7;\n    const logoHeightMM = 20; // Espaço para a logo no topo\n    const qrWithBorderMM = qrSizeMM + (borderMM * 2);\n    const totalBoxHeight = qrWithBorderMM + logoHeightMM; // Altura total incluindo logo\n    const qrX = (pageWidth - qrWithBorderMM) / 2;\n    const qrY = headerHeight + 30;\n    \n    // Borda com cor do módulo expandida (inclui espaço para logo)\n    pdf.setFillColor(moduleColor.r, moduleColor.g, moduleColor.b);\n    pdf.roundedRect(qrX, qrY, qrWithBorderMM, totalBoxHeight, 5, 5, 'F');\n    \n    // Logo Grupo OPUS no topo\n    const logoWidth = qrWithBorderMM * 0.7; // 70% da largura da caixa\n    const logoHeight = 15;\n    const logoX = qrX + (qrWithBorderMM - logoWidth) / 2;\n    const logoY = qrY + 3;\n    pdf.addImage(grupoOpusLogo, 'PNG', logoX, logoY, logoWidth, logoHeight);\n    \n    // Fundo branco para QR (abaixo da logo)\n    const qrStartY = qrY + logoHeightMM;\n    pdf.setFillColor(255, 255, 255);\n    pdf.rect(qrX + borderMM, qrStartY + borderMM, qrSizeMM, qrSizeMM, 'F');\n    \n    // QR Code\n    pdf.addImage(qrCodeDataUrl, 'PNG', qrX + borderMM, qrStartY + borderMM, qrSizeMM, qrSizeMM);\n    \n    // Badge EXECUÇÃO com cor do módulo\n    const badgeY = qrY + totalBoxHeight + 10;\n    const badgeWidth = 60;\n    const badgeHeight = 12;\n    const badgeX = (pageWidth - badgeWidth) / 2;\n    \n    pdf.setFillColor(moduleColor.r, moduleColor.g, moduleColor.b);\n    pdf.roundedRect(badgeX, badgeY, badgeWidth, badgeHeight, 3, 3, 'F');\n    \n    pdf.setFontSize(12);\n    pdf.setTextColor(255, 255, 255);\n    pdf.setFont('helvetica', 'bold');\n    pdf.text('EXECUÇÃO', pageWidth / 2, badgeY + 8, { align: 'center' });\n    \n    // Nome\n    pdf.setTextColor(30, 41, 59);\n    pdf.setFontSize(16);\n    pdf.text(point.name, pageWidth / 2, badgeY + 25, { align: 'center' });\n    \n    // Código\n    pdf.setTextColor(100, 116, 139);\n    pdf.setFontSize(11);\n    pdf.setFont('helvetica', 'normal');\n    pdf.text(`Código: ${point.code}`, pageWidth / 2, badgeY + 35, { align: 'center' });\n    \n    // Local\n    if (point.zoneName) {\n      pdf.setFontSize(10);\n      pdf.text(`Local: ${point.zoneName}`, pageWidth / 2, badgeY + 45, { align: 'center' });\n    }\n    \n    pdf.save(`qr_${point.name.replace(/\\s+/g, '_')}_${sizeCm}cm.pdf`);\n  };\n\n  const downloadMultiplePDF = async () => {\n    if (selectedQrCodes.length === 0) {\n      toast({ title: \"Selecione QR codes para imprimir\", variant: \"destructive\" });\n      return;\n    }\n\n    setIsGeneratingPDF(true);\n    const selectedPoints = (qrPoints as any[]).filter(point => selectedQrCodes.includes(point.id));\n    const pdf = new jsPDF();\n    \n    // Cores baseadas no módulo\n    const moduleColor = currentModule === 'maintenance' \n      ? { r: 249, g: 115, b: 22 }  // orange-500\n      : { r: 59, g: 130, b: 246 };  // blue-500\n    \n    const pageWidth = 210; // mm A4\n    const pageHeight = 297; // mm A4\n    const margin = 8; // margem reduzida\n    const spacing = 5; // espaço menor entre QR codes\n    const usableWidth = pageWidth - (margin * 2);\n    \n    let currentY = margin;\n    let currentX = margin;\n    let maxRowHeight = 0;\n    const borderMM = 5; // borda mais fina\n    const textHeight = 35; // espaço reduzido para texto\n    \n    for (let i = 0; i < selectedPoints.length; i++) {\n      const point = selectedPoints[i];\n      const sizeCm = point.sizeCm || 5;\n      const qrSizeMM = sizeCm * 10;\n      const logoHeightMM = Math.min(15, qrSizeMM * 0.3); // Logo proporcional ao QR\n      const qrWithBorderMM = qrSizeMM + (borderMM * 2);\n      const totalBoxHeight = qrWithBorderMM + logoHeightMM;\n      const totalItemHeight = totalBoxHeight + textHeight;\n      \n      // Se não cabe na linha atual, vai para próxima linha\n      if (currentX + qrWithBorderMM > pageWidth - margin && currentX > margin) {\n        currentY += maxRowHeight + spacing;\n        currentX = margin;\n        maxRowHeight = 0;\n      }\n      \n      // Se não cabe na página atual, cria nova página\n      if (currentY + totalItemHeight > pageHeight - margin) {\n        pdf.addPage();\n        currentY = margin;\n        currentX = margin;\n        maxRowHeight = 0;\n      }\n      \n      const url = generateQrCodeUrl(point.type, point.code);\n      const qrCodeDataUrl = await generateQrCodeImage(url, sizeCm);\n      \n      // Borda com cor do módulo expandida (inclui logo)\n      pdf.setFillColor(moduleColor.r, moduleColor.g, moduleColor.b);\n      pdf.roundedRect(currentX, currentY, qrWithBorderMM, totalBoxHeight, 5, 5, 'F');\n      \n      // Logo Grupo OPUS no topo (menor para múltiplos)\n      const logoWidth = qrWithBorderMM * 0.6;\n      const logoHeight = logoHeightMM * 0.7;\n      const logoX = currentX + (qrWithBorderMM - logoWidth) / 2;\n      const logoY = currentY + 2;\n      pdf.addImage(grupoOpusLogo, 'PNG', logoX, logoY, logoWidth, logoHeight);\n      \n      // Fundo branco para QR (abaixo da logo)\n      const qrStartY = currentY + logoHeightMM;\n      pdf.setFillColor(255, 255, 255);\n      pdf.rect(currentX + borderMM, qrStartY + borderMM, qrSizeMM, qrSizeMM, 'F');\n      \n      // QR Code\n      pdf.addImage(qrCodeDataUrl, 'PNG', currentX + borderMM, qrStartY + borderMM, qrSizeMM, qrSizeMM);\n      \n      // Badge com cor do módulo\n      const badgeY = currentY + totalBoxHeight + 3;\n      const badgeWidth = Math.min(40, qrWithBorderMM - 4);\n      const badgeHeight = 6;\n      const badgeX = currentX + (qrWithBorderMM - badgeWidth) / 2;\n      \n      pdf.setFillColor(moduleColor.r, moduleColor.g, moduleColor.b);\n      pdf.roundedRect(badgeX, badgeY, badgeWidth, badgeHeight, 2, 2, 'F');\n      \n      pdf.setFontSize(6);\n      pdf.setTextColor(255, 255, 255);\n      pdf.setFont('helvetica', 'bold');\n      pdf.text('EXECUÇÃO', currentX + qrWithBorderMM / 2, badgeY + 4, { align: 'center' });\n      \n      // Nome\n      pdf.setTextColor(30, 41, 59);\n      pdf.setFontSize(7);\n      const maxNameWidth = qrWithBorderMM - 2;\n      const nameParts = pdf.splitTextToSize(point.name, maxNameWidth);\n      pdf.text(nameParts[0], currentX + qrWithBorderMM / 2, badgeY + 12, { align: 'center' });\n      \n      // Código\n      pdf.setTextColor(100, 116, 139);\n      pdf.setFontSize(6);\n      pdf.setFont('helvetica', 'normal');\n      pdf.text(`${point.code}`, currentX + qrWithBorderMM / 2, badgeY + 18, { align: 'center' });\n      \n      // Atualiza posição X e altura máxima da linha\n      currentX += qrWithBorderMM + spacing;\n      maxRowHeight = Math.max(maxRowHeight, totalItemHeight);\n    }\n    \n    pdf.save(`qr_codes_multiplos_${selectedPoints.length}_itens.pdf`);\n    toast({ title: `${selectedPoints.length} QR codes baixados em PDF` });\n    setIsGeneratingPDF(false);\n  };\n\n  const deleteQrPointMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return await apiRequest(\"DELETE\", `/api/qr-points/${id}`);\n    },\n    onSuccess: () => {\n      toast({ title: \"QR Code excluído com sucesso\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/customers\", activeClientId, \"qr-points\"] });\n    },\n  });\n\n  const toggleSelection = (id: string) => {\n    setSelectedQrCodes(prev => \n      prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]\n    );\n  };\n\n  const toggleSelectAll = () => {\n    if (selectedQrCodes.length === (qrPoints as any[])?.length) {\n      setSelectedQrCodes([]);\n    } else {\n      setSelectedQrCodes((qrPoints as any[])?.map(p => p.id) || []);\n    }\n  };\n\n  return (\n    <>\n      <ModernPageHeader \n        title=\"QR Codes\"\n        description=\"Gerencie códigos QR para execução e serviços públicos\"\n        icon={QrCodeIcon}\n        stats={[\n          { \n            label: \"Total de QR Codes\", \n            value: (qrPoints as any[])?.length || 0,\n            icon: QrCodeIcon\n          }\n        ]}\n        actions={\n          <Button \n            onClick={handleRefresh}\n            className={cn(\"flex items-center gap-2\", theme.buttons.outline)}\n            size=\"sm\"\n          >\n            <RefreshCw className=\"w-4 h-4\" />\n            Atualizar\n          </Button>\n        }\n      />\n      \n      <div className={cn(\"flex-1 overflow-y-auto p-4 md:p-6 space-y-6\", theme.gradients.subtle)}>\n        <ModernCard variant=\"default\">\n          <ModernCardHeader icon={<Plus className=\"w-6 h-6\" />}>\n            Criar Novo QR Code\n          </ModernCardHeader>\n          <ModernCardContent>\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n              {/* Coluna Esquerda - Informações Principais */}\n              <div className=\"space-y-5\">\n                <div>\n                  <label className=\"text-sm font-semibold mb-2 flex items-center gap-2 text-gray-700\">\n                    <div className={cn(\"w-6 h-6 rounded-full flex items-center justify-center\", theme.backgrounds.light)}>\n                      <span className={cn(\"text-xs font-bold\", theme.text.primary)}>1</span>\n                    </div>\n                    Local <span className=\"text-red-500\">*</span>\n                  </label>\n                  <Select value={selectedSite} onValueChange={setSelectedSite}>\n                    <SelectTrigger \n                      data-testid=\"select-site\"\n                      className={`h-12 ${!selectedSite ? 'border-orange-300 bg-orange-50/30' : 'border-green-300 bg-green-50/30'}`}\n                    >\n                      <SelectValue placeholder=\"Selecione o local\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {(sites as any[])?.map((site: any) => (\n                        <SelectItem key={site.id} value={site.id}>\n                          {site.name}\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                  {!selectedSite && (\n                    <p className=\"text-xs text-orange-600 mt-1\">Escolha o local onde o QR será instalado</p>\n                  )}\n                </div>\n\n                <div>\n                  <label className=\"text-sm font-semibold mb-2 flex items-center gap-2 text-gray-700\">\n                    <div className={cn(\"w-6 h-6 rounded-full flex items-center justify-center\", theme.backgrounds.light)}>\n                      <span className={cn(\"text-xs font-bold\", theme.text.primary)}>2</span>\n                    </div>\n                    Zona <span className=\"text-red-500\">*</span>\n                  </label>\n                  <Select value={selectedZone} onValueChange={setSelectedZone} disabled={!selectedSite}>\n                    <SelectTrigger \n                      data-testid=\"select-zone\"\n                      className={`h-12 ${!selectedZone && selectedSite ? 'border-orange-300 bg-orange-50/30' : selectedZone ? 'border-green-300 bg-green-50/30' : ''}`}\n                    >\n                      <SelectValue placeholder={selectedSite ? \"Selecione a zona\" : \"Selecione o local primeiro\"} />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {(zones as any[])?.map((zone: any) => (\n                        <SelectItem key={zone.id} value={zone.id}>\n                          {zone.name}\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                  {!selectedSite && (\n                    <p className=\"text-xs text-gray-500 mt-1\">Primeiro selecione um local</p>\n                  )}\n                  {selectedSite && !selectedZone && (\n                    <p className=\"text-xs text-orange-600 mt-1\">Escolha a zona específica dentro do local</p>\n                  )}\n                </div>\n\n                <div>\n                  <label className=\"text-sm font-semibold mb-2 flex items-center gap-2 text-gray-700\">\n                    <div className={cn(\"w-6 h-6 rounded-full flex items-center justify-center\", theme.backgrounds.light)}>\n                      <span className={cn(\"text-xs font-bold\", theme.text.primary)}>3</span>\n                    </div>\n                    Nome do Ponto <span className=\"text-red-500\">*</span>\n                  </label>\n                  <Input\n                    placeholder=\"Ex: Sala de Reunião 1\"\n                    value={pointName}\n                    onChange={(e) => setPointName(e.target.value)}\n                    data-testid=\"input-point-name\"\n                    className={`h-12 ${!pointName ? 'border-orange-300 bg-orange-50/30' : 'border-green-300 bg-green-50/30'}`}\n                  />\n                  {!pointName && (\n                    <p className=\"text-xs text-orange-600 mt-1\">Digite um nome descritivo para o ponto</p>\n                  )}\n                </div>\n              </div>\n\n              {/* Coluna Direita - Detalhes Opcionais */}\n              <div className=\"space-y-5\">\n                <div>\n                  <label className=\"text-sm font-semibold mb-2 flex items-center gap-2 text-gray-700\">\n                    <FileText className=\"w-4 h-4 text-gray-500\" />\n                    Código Personalizado <span className=\"text-gray-400 text-xs\">(opcional)</span>\n                  </label>\n                  <Input\n                    placeholder=\"Ex: SR-001, QR-123\"\n                    value={pointCode}\n                    onChange={(e) => setPointCode(e.target.value)}\n                    data-testid=\"input-point-code\"\n                    className=\"h-12 border-gray-300\"\n                  />\n                  <p className=\"text-xs text-gray-500 mt-1\">Deixe em branco para gerar automaticamente</p>\n                </div>\n\n                <div>\n                  <label className=\"text-sm font-semibold mb-2 flex items-center gap-2 text-gray-700\">\n                    <QrCodeIcon className=\"w-4 h-4 text-gray-500\" />\n                    Tamanho do QR Code\n                  </label>\n                  <Select value={String(qrSizeCm)} onValueChange={(v) => setQrSizeCm(Number(v))}>\n                    <SelectTrigger data-testid=\"select-size\" className=\"h-12\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {QR_SIZES_CM.map(size => (\n                        <SelectItem key={size} value={String(size)}>\n                          {size} cm {size === 5 && '(recomendado)'} {size >= 10 && '(grande)'}\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                  <p className=\"text-xs text-gray-500 mt-1\">5 cm é ideal para a maioria dos casos</p>\n                </div>\n\n                <div className=\"pt-4\">\n                  <Button \n                    onClick={handleCreateQrPoint} \n                    className={cn(\"w-full h-14 text-base font-semibold\", theme.buttons.primary)}\n                    disabled={createQrPointMutation.isPending}\n                    data-testid=\"button-create-qr\"\n                  >\n                    {createQrPointMutation.isPending ? (\n                      <>\n                        <div className=\"w-5 h-5 mr-3 border-2 border-white border-t-transparent rounded-full animate-spin\" />\n                        Gerando QR Code...\n                      </>\n                    ) : (\n                      <>\n                        <QrCodeIcon className=\"w-5 h-5 mr-3\" />\n                        Criar QR Code\n                      </>\n                    )}\n                  </Button>\n                  {(!selectedSite || !selectedZone || !pointName) && (\n                    <p className=\"text-xs text-center text-orange-600 mt-2 font-medium\">\n                      ⚠️ Preencha todos os campos obrigatórios (*)\n                    </p>\n                  )}\n                </div>\n              </div>\n            </div>\n          </ModernCardContent>\n        </ModernCard>\n\n        {selectedQrCodes.length > 0 && (\n          <Card className={cn(theme.backgrounds.light, theme.borders.primary)}>\n            <CardContent className=\"py-4\">\n              <div className=\"flex items-center justify-between\">\n                <span className=\"text-sm font-medium\">\n                  {selectedQrCodes.length} selecionado{selectedQrCodes.length > 1 ? 's' : ''}\n                </span>\n                <div className=\"flex gap-2\">\n                  <Button \n                    variant=\"outline\" \n                    size=\"sm\" \n                    onClick={() => setSelectedQrCodes([])}\n                    disabled={isGeneratingPDF}\n                  >\n                    Limpar\n                  </Button>\n                  <Button \n                    size=\"sm\" \n                    onClick={downloadMultiplePDF}\n                    disabled={isGeneratingPDF}\n                  >\n                    {isGeneratingPDF ? (\n                      <>\n                        <div className=\"w-4 h-4 mr-2 border-2 border-white border-t-transparent rounded-full animate-spin\" />\n                        Gerando PDF...\n                      </>\n                    ) : (\n                      <>\n                        <Printer className=\"w-4 h-4 mr-2\" />\n                        Baixar PDF\n                      </>\n                    )}\n                  </Button>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        )}\n\n        <Card>\n          <CardHeader>\n            <div className=\"flex items-center justify-between\">\n              <CardTitle>QR Codes Cadastrados</CardTitle>\n              <div className=\"flex gap-2\">\n                <Button\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={handleRefresh}\n                  data-testid=\"button-refresh-qr\"\n                >\n                  <RefreshCw className=\"w-4 h-4 mr-2\" />\n                  Atualizar\n                </Button>\n                {(qrPoints as any[])?.length > 0 && (\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={toggleSelectAll}\n                    data-testid=\"button-select-all\"\n                  >\n                    {selectedQrCodes.length === (qrPoints as any[])?.length ? (\n                    <>\n                      <Copy className=\"w-4 h-4 mr-2\" />\n                      Desmarcar Todos\n                    </>\n                  ) : (\n                    <>\n                      <Check className=\"w-4 h-4 mr-2\" />\n                      Selecionar Todos\n                    </>\n                  )}\n                </Button>\n                )}\n              </div>\n            </div>\n          </CardHeader>\n          <CardContent>\n            {isLoading ? (\n              <p className=\"text-center text-muted-foreground py-8\">Carregando...</p>\n            ) : (qrPoints as any[])?.length === 0 ? (\n              <p className=\"text-center text-muted-foreground py-8\">Nenhum QR code cadastrado</p>\n            ) : (\n              <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n                {(qrPoints as any[])?.map((point: any) => {\n                  const sizeCm = point.sizeCm || 5;\n                  const isSelected = selectedQrCodes.includes(point.id);\n                  \n                  return (\n                    <Card key={point.id} className=\"relative\">\n                      <CardContent className=\"p-6\">\n                        {/* Checkbox */}\n                        <button\n                          onClick={() => toggleSelection(point.id)}\n                          className={cn(\n                            \"absolute top-4 left-4 w-6 h-6 rounded border-2 flex items-center justify-center\",\n                            isSelected ? cn(theme.backgrounds.primary, theme.borders.primary) : 'border-gray-300'\n                          )}\n                        >\n                          {isSelected && <Check className=\"w-4 h-4 text-white\" />}\n                        </button>\n\n                        {/* Badge Tipo */}\n                        <Badge className={cn(\"absolute top-4 right-4\", theme.backgrounds.primary)}>\n                          Execução\n                        </Badge>\n\n                        {/* QR Code com borda dinâmica */}\n                        <div className=\"flex justify-center my-4\">\n                          <div className=\"relative\">\n                            <div className={cn(\"p-4 rounded-2xl\", theme.backgrounds.primary)}>\n                              {qrCodeImages[point.id] && (\n                                <div className=\"bg-white p-2\">\n                                  <img \n                                    src={qrCodeImages[point.id]} \n                                    alt={point.name}\n                                    className=\"w-32 h-32\"\n                                  />\n                                </div>\n                              )}\n                            </div>\n                          </div>\n                        </div>\n\n                        {/* Badge Execução */}\n                        <div className=\"flex justify-center mb-3\">\n                          <Badge className={cn(theme.badges.light, \"px-4 py-1\")}>\n                            ⚡ Execução\n                          </Badge>\n                        </div>\n\n                        {/* Informações */}\n                        <div className=\"text-center space-y-1 mb-4\">\n                          <h3 className=\"font-bold text-base\">{point.name}</h3>\n                          <p className=\"text-sm text-muted-foreground\">Código: {point.code}</p>\n                          {point.zoneName && (\n                            <>\n                              <p className=\"text-xs text-muted-foreground\">Local: {point.zoneName}</p>\n                              {point.siteName && (\n                                <p className=\"text-xs text-muted-foreground\">\n                                  Endereço: {point.siteName}\n                                </p>\n                              )}\n                            </>\n                          )}\n                        </div>\n\n                        {/* Botões */}\n                        <Button \n                          className=\"w-full\"\n                          size=\"sm\"\n                          onClick={() => downloadPDF(point)}\n                        >\n                          <FileText className=\"w-4 h-4 mr-2\" />\n                          Baixar PDF\n                        </Button>\n\n                        {/* Ações extras */}\n                        <div className=\"grid grid-cols-2 gap-2 mt-2\">\n                          <Button \n                            variant=\"ghost\" \n                            size=\"sm\"\n                            onClick={() => {\n                              navigator.clipboard.writeText(point.code);\n                              toast({ title: \"Código copiado!\" });\n                            }}\n                          >\n                            <Copy className=\"w-4 h-4 mr-1\" />\n                            Copiar\n                          </Button>\n                          <Button \n                            variant=\"ghost\" \n                            size=\"sm\"\n                            className=\"text-red-600 hover:text-red-700\"\n                            onClick={() => deleteQrPointMutation.mutate(point.id)}\n                          >\n                            <Trash2 className=\"w-4 h-4 mr-1\" />\n                            Excluir\n                          </Button>\n                        </div>\n                      </CardContent>\n                    </Card>\n                  );\n                })}\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n    </>\n  );\n}\n","size_bytes":30668},"client/src/pages/services.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { \n  Settings, \n  Plus, \n  Edit, \n  Trash2, \n  Clock, \n  AlertTriangle,\n  Wrench,\n  Users,\n  Building,\n  Zap\n} from \"lucide-react\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\n\ninterface ServicesProps {\n  customerId: string;\n}\n\nconst serviceFormSchema = z.object({\n  name: z.string().min(1, \"Nome é obrigatório\"),\n  description: z.string().optional(),\n  categoryId: z.string().min(1, \"Categoria é obrigatória\"),\n  typeId: z.string().min(1, \"Tipo é obrigatório\"),\n  estimatedDurationMinutes: z.number().min(1).optional(),\n  priority: z.enum([\"baixa\", \"media\", \"alta\", \"critica\"]).default(\"media\"),\n});\n\ntype ServiceFormData = z.infer<typeof serviceFormSchema>;\n\nconst categoryLabels = {\n  // Hard Services\n  manutencao_eletrica: \"Manutenção Elétrica\",\n  manutencao_hidraulica: \"Manutenção Hidráulica\", \n  climatizacao_hvac: \"Climatização (HVAC)\",\n  elevadores_equipamentos: \"Elevadores e Equipamentos\",\n  sistemas_seguranca_fisica: \"Sistemas de Segurança Física\",\n  manutencao_preventiva: \"Manutenção Preventiva\",\n  manutencao_corretiva: \"Manutenção Corretiva\",\n  sistema_incendio: \"Sistema de Incêndio\",\n  telecomunicacoes_dados: \"Telecomunicações e Dados\",\n  infraestrutura_predial: \"Infraestrutura Predial\",\n  automacao_predial: \"Automação Predial\",\n  // Soft Services\n  limpeza_conservacao: \"Limpeza e Conservação\",\n  portaria_recepcao: \"Portaria e Recepção\",\n  jardinagem_paisagismo: \"Jardinagem e Paisagismo\",\n  seguranca_patrimonial: \"Segurança Patrimonial\",\n  servicos_administrativos: \"Serviços Administrativos\",\n  gestao_residuos: \"Gestão de Resíduos\",\n  controle_pragas: \"Controle de Pragas\",\n  catering_alimentacao: \"Catering e Alimentação\",\n  decoracao_ambientacao: \"Decoração e Ambientação\",\n  correio_interno: \"Correio Interno\",\n  atendimento_telefone: \"Atendimento Telefônico\"\n};\n\nconst typeLabels = {\n  hard_service: \"Hard Service\",\n  soft_service: \"Soft Service\"\n};\n\nconst priorityLabels = {\n  baixa: \"Baixa\",\n  media: \"Média\", \n  alta: \"Alta\",\n  critica: \"Crítica\"\n};\n\nexport default function Services({ customerId }: ServicesProps) {\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [editingService, setEditingService] = useState<any>(null);\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  const { data: services = [], isLoading } = useQuery<any[]>({\n    queryKey: [\"/api/customers\", customerId, \"services\"],\n    enabled: !!customerId,\n  });\n\n  // Get service types from database\n  const { data: serviceTypes = [] } = useQuery<any[]>({\n    queryKey: [\"/api/customers\", customerId, \"service-types\"],\n    enabled: !!customerId,\n  });\n\n  // Get service categories from database\n  const { data: serviceCategories = [] } = useQuery<any[]>({\n    queryKey: [\"/api/customers\", customerId, \"service-categories\"],\n    enabled: !!customerId,\n  });\n\n  const form = useForm<ServiceFormData>({\n    resolver: zodResolver(serviceFormSchema),\n    defaultValues: {\n      name: \"\",\n      description: \"\",\n      priority: \"media\",\n    },\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: ServiceFormData) => {\n      return apiRequest(\"POST\", `/api/services`, { ...data, customerId, module: 'maintenance' });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/customers\", customerId, \"services\"] });\n      setIsDialogOpen(false);\n      form.reset();\n      toast({\n        title: \"Serviço criado\",\n        description: \"O serviço foi criado com sucesso.\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Falha ao criar serviço.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async (data: ServiceFormData) => {\n      return apiRequest(\"PUT\", `/api/services/${editingService.id}`, { ...data, module: 'maintenance' });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/customers\", customerId, \"services\"] });\n      setIsDialogOpen(false);\n      setEditingService(null);\n      form.reset();\n      toast({\n        title: \"Serviço atualizado\",\n        description: \"O serviço foi atualizado com sucesso.\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Falha ao atualizar serviço.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (serviceId: string) => {\n      return apiRequest(\"DELETE\", `/api/services/${serviceId}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/customers\", customerId, \"services\"] });\n      toast({\n        title: \"Serviço excluído\",\n        description: \"O serviço foi excluído com sucesso.\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Falha ao excluir serviço.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleSubmit = (data: ServiceFormData) => {\n    if (editingService) {\n      updateMutation.mutate(data);\n    } else {\n      createMutation.mutate(data);\n    }\n  };\n\n  const handleEdit = (service: any) => {\n    setEditingService(service);\n    form.reset({\n      name: service.name,\n      description: service.description || \"\",\n      categoryId: service.categoryId,\n      typeId: service.typeId,\n      estimatedDurationMinutes: service.estimatedDurationMinutes || undefined,\n      priority: service.priority,\n    });\n    setIsDialogOpen(true);\n  };\n\n  const handleDelete = (serviceId: string) => {\n    if (confirm(\"Tem certeza que deseja excluir este serviço?\")) {\n      deleteMutation.mutate(serviceId);\n    }\n  };\n\n  const getCategoryIcon = (category: string) => {\n    const hardServiceCategories = [\"manutencao_eletrica\", \"manutencao_hidraulica\", \"climatizacao\", \"elevadores\", \"sistemas_seguranca\"];\n    \n    if (hardServiceCategories.includes(category)) {\n      switch (category) {\n        case \"manutencao_eletrica\": return <Zap className=\"w-4 h-4\" />;\n        case \"sistemas_seguranca\": return <AlertTriangle className=\"w-4 h-4\" />;\n        default: return <Wrench className=\"w-4 h-4\" />;\n      }\n    } else {\n      switch (category) {\n        case \"portaria_recepcao\": return <Users className=\"w-4 h-4\" />;\n        case \"jardinagem_paisagismo\": return <Building className=\"w-4 h-4\" />;\n        default: return <Settings className=\"w-4 h-4\" />;\n      }\n    }\n  };\n\n  const getPriorityColor = (priority: string) => {\n    switch (priority) {\n      case \"critica\": return \"bg-red-100 text-red-800\";\n      case \"alta\": return \"bg-orange-100 text-orange-800\";\n      case \"media\": return \"bg-yellow-100 text-yellow-800\";\n      case \"baixa\": return \"bg-green-100 text-green-800\";\n      default: return \"bg-gray-100 text-gray-800\";\n    }\n  };\n\n  const getTypeColor = (type: string) => {\n    return type === \"hard_service\" ? \"bg-blue-100 text-blue-800\" : \"bg-purple-100 text-purple-800\";\n  };\n\n  if (isLoading) {\n    return <div className=\"p-3 md:p-6\">Carregando serviços...</div>;\n  }\n\n  return (\n    <div className=\"p-3 md:p-6 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold text-gray-900\">Serviços de Facilities</h1>\n          <p className=\"text-gray-600\">Gerencie os serviços oferecidos pela empresa</p>\n        </div>\n        <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\n          <DialogTrigger asChild>\n            <Button \n              data-testid=\"button-add-service\"\n              onClick={() => {\n                setEditingService(null);\n                form.reset();\n              }}\n            >\n              <Plus className=\"w-4 h-4 mr-2\" />\n              Novo Serviço\n            </Button>\n          </DialogTrigger>\n          <DialogContent className=\"max-w-2xl max-h-[80vh] overflow-auto\">\n            <DialogHeader>\n              <DialogTitle>\n                {editingService ? \"Editar Serviço\" : \"Novo Serviço\"}\n              </DialogTitle>\n            </DialogHeader>\n            <Form {...form}>\n              <form onSubmit={form.handleSubmit(handleSubmit)} className=\"space-y-4\">\n                <FormField\n                  control={form.control}\n                  name=\"name\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Nome</FormLabel>\n                      <FormControl>\n                        <Input {...field} placeholder=\"Nome do serviço\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"typeId\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Tipo</FormLabel>\n                      <Select onValueChange={field.onChange} value={field.value}>\n                        <FormControl>\n                          <SelectTrigger>\n                            <SelectValue placeholder=\"Selecione o tipo\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          {serviceTypes.map((type: any) => (\n                            <SelectItem key={type.id} value={type.id}>\n                              {type.name}\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"categoryId\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Categoria</FormLabel>\n                      <Select onValueChange={field.onChange} value={field.value}>\n                        <FormControl>\n                          <SelectTrigger>\n                            <SelectValue placeholder=\"Selecione a categoria\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          {serviceCategories.map((category: any) => (\n                            <SelectItem key={category.id} value={category.id}>\n                              {category.name}\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"priority\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Prioridade</FormLabel>\n                      <Select onValueChange={field.onChange} value={field.value}>\n                        <FormControl>\n                          <SelectTrigger>\n                            <SelectValue placeholder=\"Selecione a prioridade\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          <SelectItem value=\"baixa\">Baixa</SelectItem>\n                          <SelectItem value=\"media\">Média</SelectItem>\n                          <SelectItem value=\"alta\">Alta</SelectItem>\n                          <SelectItem value=\"critica\">Crítica</SelectItem>\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"estimatedDurationMinutes\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Duração Estimada (minutos)</FormLabel>\n                      <FormControl>\n                        <Input \n                          type=\"number\" \n                          {...field} \n                          onChange={(e) => field.onChange(e.target.value ? parseInt(e.target.value) : undefined)}\n                          value={field.value || \"\"}\n                          placeholder=\"120\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"description\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Descrição</FormLabel>\n                      <FormControl>\n                        <Textarea {...field} placeholder=\"Descrição do serviço\" rows={3} />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <div className=\"flex gap-2 pt-4\">\n                  <Button \n                    type=\"submit\" \n                    data-testid=\"button-save-service\"\n                    disabled={createMutation.isPending || updateMutation.isPending}\n                  >\n                    {createMutation.isPending || updateMutation.isPending ? \"Salvando...\" : \"Salvar\"}\n                  </Button>\n                  <Button \n                    type=\"button\" \n                    variant=\"outline\" \n                    onClick={() => setIsDialogOpen(false)}\n                  >\n                    Cancelar\n                  </Button>\n                </div>\n              </form>\n            </Form>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      {services.length === 0 ? (\n        <Card>\n          <CardContent className=\"flex flex-col items-center justify-center py-16\">\n            <Settings className=\"w-12 h-12 text-gray-400 mb-4\" />\n            <h3 className=\"text-lg font-semibold text-gray-900 mb-2\">Nenhum serviço cadastrado</h3>\n            <p className=\"text-gray-600 text-center mb-4\">\n              Comece criando seus primeiros serviços de facilities\n            </p>\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n          {services.map((service: any) => (\n            <Card key={service.id} className=\"hover:shadow-lg transition-shadow\">\n              <CardHeader className=\"pb-3\">\n                <div className=\"flex items-start justify-between\">\n                  <div className=\"flex items-center space-x-3\">\n                    <div className=\"p-2 rounded-lg bg-blue-50\">\n                      {getCategoryIcon(service.category)}\n                    </div>\n                    <div>\n                      <CardTitle className=\"text-lg\">{service.name}</CardTitle>\n                    </div>\n                  </div>\n                  <div className=\"flex space-x-1\">\n                    <Button \n                      variant=\"ghost\" \n                      size=\"sm\"\n                      data-testid={`button-edit-service-${service.id}`}\n                      onClick={() => handleEdit(service)}\n                    >\n                      <Edit className=\"w-4 h-4\" />\n                    </Button>\n                    <Button \n                      variant=\"ghost\" \n                      size=\"sm\"\n                      data-testid={`button-delete-service-${service.id}`}\n                      onClick={() => handleDelete(service.id)}\n                    >\n                      <Trash2 className=\"w-4 h-4\" />\n                    </Button>\n                  </div>\n                </div>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                {service.description && (\n                  <p className=\"text-sm text-gray-600\">{service.description}</p>\n                )}\n                \n                <div className=\"flex flex-wrap gap-2\">\n                  {/* Bolinha do Tipo com texto */}\n                  <div className=\"flex items-center gap-2\">\n                    <div className=\"w-6 h-6 bg-purple-500 rounded-full flex items-center justify-center text-white text-xs font-bold\">\n                      T\n                    </div>\n                    <Badge className=\"bg-purple-100 text-purple-800\">\n                      {serviceTypes.find(t => t.id === service.typeId)?.name || 'Tipo'}\n                    </Badge>\n                  </div>\n                  \n                  {/* Bolinha da Categoria com texto */}\n                  <div className=\"flex items-center gap-2\">\n                    <div className=\"w-6 h-6 bg-slate-500 rounded-full flex items-center justify-center text-white text-xs font-bold\">\n                      C\n                    </div>\n                    <Badge variant=\"outline\">\n                      {serviceCategories.find(c => c.id === service.categoryId)?.name || 'Categoria'}\n                    </Badge>\n                  </div>\n                  \n                  <Badge className={getPriorityColor(service.priority)}>\n                    {priorityLabels[service.priority as keyof typeof priorityLabels]}\n                  </Badge>\n                </div>\n\n                {service.estimatedDurationMinutes && (\n                  <div className=\"flex items-center text-sm text-gray-600\">\n                    <Clock className=\"w-4 h-4 mr-2\" />\n                    {service.estimatedDurationMinutes} min\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      )}\n    </div>\n  );\n}","size_bytes":18685},"client/src/components/ui/textarea.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Textarea = React.forwardRef<\n  HTMLTextAreaElement,\n  React.ComponentProps<\"textarea\">\n>(({ className, ...props }, ref) => {\n  return (\n    <textarea\n      className={cn(\n        \"flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  )\n})\nTextarea.displayName = \"Textarea\"\n\nexport { Textarea }\n","size_bytes":689},"client/src/pages/floor-plan.tsx":{"content":"import React from 'react';\nimport { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Badge } from '@/components/ui/badge';\nimport { Label } from '@/components/ui/label';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';\nimport { Input } from '@/components/ui/input';\nimport { Textarea } from '@/components/ui/textarea';\nimport { useToast } from '@/hooks/use-toast';\nimport { Building, Edit3, X, RotateCcw, MapPin, Palette, Plus, Minus, Save, AlertCircle, Thermometer } from 'lucide-react';\nimport { apiRequest } from '@/lib/queryClient';\nimport { useClient } from '@/contexts/ClientContext';\nimport { useModule } from '@/contexts/ModuleContext';\n\nexport default function FloorPlanPage() {\n  const { activeClientId } = useClient();\n  const { currentModule } = useModule();\n  const [selectedSiteId, setSelectedSiteId] = React.useState<string>('');\n  const [isEditMode, setIsEditMode] = React.useState(false);\n  const [isHeatmapMode, setIsHeatmapMode] = React.useState(false);\n  const [editingZone, setEditingZone] = React.useState<any>(null);\n  const [zonePositions, setZonePositions] = React.useState<{[key: string]: {left: number, top: number}}>({});\n  const [zoneSizes, setZoneSizes] = React.useState<{[key: string]: number}>({});\n  const [hasUnsavedChanges, setHasUnsavedChanges] = React.useState(false);\n  const [draggingZone, setDraggingZone] = React.useState<string | null>(null);\n  const [dragStartPos, setDragStartPos] = React.useState({ x: 0, y: 0 });\n  const [dragOffset, setDragOffset] = React.useState({ x: 0, y: 0 });\n  const [dragStartTime, setDragStartTime] = React.useState(0);\n  const [isDragging, setIsDragging] = React.useState(false);\n  const [containerRect, setContainerRect] = React.useState<DOMRect | null>(null);\n  const animationFrameRef = React.useRef<number | null>(null);\n  const lastMousePos = React.useRef({ x: 0, y: 0 });\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  // Get customer data to fetch companyId\n  const { data: customer } = useQuery({\n    queryKey: [\"/api/customers\", activeClientId],\n    enabled: !!activeClientId,\n  });\n\n  const companyId = (customer as any)?.companyId;\n\n  // Get sites for the active customer only\n  const { data: sites, isLoading } = useQuery({\n    queryKey: ['/api/customers', activeClientId, 'sites', { module: currentModule }],\n    enabled: !!activeClientId,\n  });\n\n  // Get zones for selected site\n  const { data: zones } = useQuery({\n    queryKey: [\"/api/sites\", selectedSiteId, \"zones\", { module: currentModule }],\n    enabled: !!selectedSiteId,\n  });\n\n  // Get heatmap data for selected site\n  const { data: heatmapData } = useQuery({\n    queryKey: ['/api/companies', companyId, 'heatmap', selectedSiteId],\n    enabled: !!selectedSiteId && isHeatmapMode,\n  });\n\n  const allZones = zones as any[] || [];\n\n  // Update zone mutation\n  const updateZoneMutation = useMutation({\n    mutationFn: async (zoneData: any) => {\n      const { id, ...updateData } = zoneData;\n      const response = await apiRequest('PATCH', `/api/zones/${id}`, updateData);\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/sites\", selectedSiteId, \"zones\"] });\n      toast({\n        title: \"Zona atualizada\",\n        description: \"As alterações foram salvas com sucesso.\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Não foi possível salvar as alterações.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Save floor plan mutation\n  const saveFloorPlanMutation = useMutation({\n    mutationFn: async () => {\n      const promises: Promise<any>[] = [];\n      \n      // Save zone positions and sizes\n      allZones.forEach((zone: any) => {\n        const position = zonePositions[zone.id];\n        const size = zoneSizes[zone.id];\n        \n        let updateData: any = {};\n        \n        if (position) {\n          updateData.positionX = position.left.toString();\n          updateData.positionY = position.top.toString();\n        }\n        \n        if (size) {\n          updateData.sizeScale = (size / 120).toString(); // Convert to scale\n        }\n        \n        if (Object.keys(updateData).length > 0) {\n          promises.push(\n            apiRequest('PATCH', `/api/zones/${zone.id}`, updateData)\n          );\n        }\n      });\n      \n      await Promise.all(promises);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/sites\", selectedSiteId, \"zones\"] });\n      setHasUnsavedChanges(false);\n      toast({\n        title: \"Planta baixa salva!\",\n        description: \"O layout das zonas foi salvo no banco de dados.\",\n      });\n    },\n    onError: (error) => {\n      console.error('Erro ao salvar planta:', error);\n      toast({\n        title: \"Erro ao salvar planta\",\n        description: \"Não foi possível salvar o layout da planta baixa.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleSaveZone = async () => {\n    if (!editingZone) return;\n    \n    try {\n      const updatedZone = {\n        id: editingZone.id,\n        name: editingZone.name,\n        description: editingZone.description,\n        areaM2: editingZone.areaM2?.toString(),\n        category: editingZone.category,\n        siteId: editingZone.siteId,\n        isActive: editingZone.isActive\n      };\n      \n      await updateZoneMutation.mutateAsync(updatedZone);\n      setEditingZone(null);\n    } catch (error) {\n      console.error('Error saving zone:', error);\n    }\n  };\n\n  const handleMouseDown = (e: React.MouseEvent, zoneId: string) => {\n    if (!isEditMode) return;\n    e.preventDefault();\n    e.stopPropagation();\n    \n    setDragStartTime(Date.now());\n    setDragStartPos({ x: e.clientX, y: e.clientY });\n    setIsDragging(false);\n    \n    const container = (e.target as HTMLElement).closest('.zone-map-container');\n    const rect = container?.getBoundingClientRect();\n    if (rect) {\n      setContainerRect(rect);\n      const offsetX = e.clientX - rect.left;\n      const offsetY = e.clientY - rect.top;\n      setDragOffset({ x: offsetX, y: offsetY });\n      setDraggingZone(zoneId);\n      lastMousePos.current = { x: e.clientX, y: e.clientY };\n    }\n  };\n\n  // Ultra-smooth drag with requestAnimationFrame\n  const updateDragPosition = React.useCallback(() => {\n    if (!draggingZone || !containerRect) return;\n    \n    const { x, y } = lastMousePos.current;\n    const relX = ((x - containerRect.left) / containerRect.width) * 100;\n    const relY = ((y - containerRect.top) / containerRect.height) * 100;\n    \n    setZonePositions(prev => ({\n      ...prev,\n      [draggingZone]: {\n        left: Math.max(3, Math.min(97, relX)),\n        top: Math.max(3, Math.min(97, relY))\n      }\n    }));\n    setHasUnsavedChanges(true);\n  }, [draggingZone, containerRect]);\n  \n  const handleMouseMove = (e: React.MouseEvent) => {\n    if (!draggingZone || !isEditMode) return;\n    \n    const moveDistance = Math.sqrt(\n      Math.pow(e.clientX - dragStartPos.x, 2) + Math.pow(e.clientY - dragStartPos.y, 2)\n    );\n    \n    if (moveDistance > 0.5) { // Instantly responsive\n      if (!isDragging) {\n        setIsDragging(true);\n      }\n      \n      e.preventDefault();\n      lastMousePos.current = { x: e.clientX, y: e.clientY };\n      \n      if (animationFrameRef.current) {\n        cancelAnimationFrame(animationFrameRef.current);\n      }\n      \n      animationFrameRef.current = requestAnimationFrame(updateDragPosition);\n    }\n  };\n\n  const handleMouseUp = () => {\n    if (animationFrameRef.current) {\n      cancelAnimationFrame(animationFrameRef.current);\n      animationFrameRef.current = null;\n    }\n    \n    if (draggingZone && !isDragging && isEditMode) {\n      const clickDuration = Date.now() - dragStartTime;\n      if (clickDuration < 150) {\n        const zone = allZones.find(z => z.id === draggingZone);\n        if (zone) {\n          setEditingZone(zone);\n        }\n      }\n    }\n    \n    setDraggingZone(null);\n    setIsDragging(false);\n    setDragStartTime(0);\n    setContainerRect(null);\n  };\n  \n  // Global mouse events for ultra-smooth dragging\n  React.useEffect(() => {\n    if (!draggingZone) return;\n    \n    const handleGlobalMouseMove = (e: MouseEvent) => {\n      if (!draggingZone) return;\n      lastMousePos.current = { x: e.clientX, y: e.clientY };\n      \n      if (animationFrameRef.current) {\n        cancelAnimationFrame(animationFrameRef.current);\n      }\n      animationFrameRef.current = requestAnimationFrame(updateDragPosition);\n    };\n    \n    const handleGlobalMouseUp = () => {\n      handleMouseUp();\n    };\n    \n    document.addEventListener('mousemove', handleGlobalMouseMove);\n    document.addEventListener('mouseup', handleGlobalMouseUp);\n    document.body.style.userSelect = 'none';\n    \n    return () => {\n      document.removeEventListener('mousemove', handleGlobalMouseMove);\n      document.removeEventListener('mouseup', handleGlobalMouseUp);\n      document.body.style.userSelect = '';\n      if (animationFrameRef.current) {\n        cancelAnimationFrame(animationFrameRef.current);\n      }\n    };\n  }, [draggingZone, updateDragPosition]);\n\n  React.useEffect(() => {\n    const handleGlobalMouseUp = () => {\n      setDraggingZone(null);\n      setIsDragging(false);\n    };\n\n    if (draggingZone) {\n      document.addEventListener('mouseup', handleGlobalMouseUp);\n      return () => document.removeEventListener('mouseup', handleGlobalMouseUp);\n    }\n  }, [draggingZone]);\n\n  const resetPositions = () => {\n    const positions = [\n      { left: 20, top: 30 },\n      { left: 70, top: 20 },\n      { left: 50, top: 70 },\n      { left: 15, top: 75 },\n      { left: 80, top: 75 }\n    ];\n    \n    const resetPositions: {[key: string]: {left: number, top: number}} = {};\n    allZones.forEach((zone, index) => {\n      const position = positions[index] || positions[0];\n      resetPositions[zone.id] = position;\n    });\n    setZonePositions(resetPositions);\n  };\n\n  React.useEffect(() => {\n    if (sites && (sites as any[]).length > 0 && !selectedSiteId) {\n      setSelectedSiteId((sites as any[])[0].id);\n    }\n  }, [sites, selectedSiteId]);\n\n  // Load saved zone sizes and positions when zones data loads\n  React.useEffect(() => {\n    if (allZones.length > 0) {\n      const savedSizes: {[key: string]: number} = {};\n      const savedPositions: {[key: string]: {left: number, top: number}} = {};\n      \n      allZones.forEach((zone: any) => {\n        // Load saved sizes\n        if (zone.sizeScale) {\n          const savedSize = Math.round(120 * parseFloat(zone.sizeScale));\n          savedSizes[zone.id] = savedSize;\n        }\n        \n        // Load saved positions\n        if (zone.positionX !== null && zone.positionY !== null) {\n          savedPositions[zone.id] = {\n            left: parseFloat(zone.positionX),\n            top: parseFloat(zone.positionY)\n          };\n        }\n      });\n      \n      // Apply saved data\n      if (Object.keys(savedSizes).length > 0) {\n        setZoneSizes(prev => ({ ...prev, ...savedSizes }));\n      }\n      if (Object.keys(savedPositions).length > 0) {\n        setZonePositions(prev => ({ ...prev, ...savedPositions }));\n      }\n      \n    }\n  }, [allZones]);\n\n  const selectedSite = sites ? (sites as any[]).find(site => site.id === selectedSiteId) : null;\n\n  // Função para obter cores do heatmap baseado na performance\n  const getHeatmapColors = (zoneId: string) => {\n    if (!isHeatmapMode || !heatmapData) {\n      return null; // Retorna null se não for modo heatmap\n    }\n    \n    const heatmapZone = (heatmapData as any[])?.find((hz: any) => hz.zoneId === zoneId);\n    const slaPercentage = heatmapZone?.slaPercentage || 0;\n    \n    // Cores baseadas em performance (SLA)\n    if (slaPercentage >= 85) {\n      return { bg: 'bg-green-400', border: 'border-green-600', dot: 'bg-green-600', text: 'text-green-800' };\n    } else if (slaPercentage >= 70) {\n      return { bg: 'bg-yellow-400', border: 'border-yellow-600', dot: 'bg-yellow-600', text: 'text-yellow-800' };\n    } else if (slaPercentage >= 50) {\n      return { bg: 'bg-orange-400', border: 'border-orange-600', dot: 'bg-orange-600', text: 'text-orange-800' };\n    } else {\n      return { bg: 'bg-red-400', border: 'border-red-600', dot: 'bg-red-600', text: 'text-red-800' };\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-full\">\n        <div className=\"text-center\">\n          <Building className=\"w-8 h-8 text-muted-foreground mx-auto mb-2\" />\n          <p className=\"text-muted-foreground\">Carregando locais...</p>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"h-full flex flex-col bg-background\">\n      {/* Compact Header */}\n      <div className=\"flex items-center justify-between px-6 py-3 border-b bg-card/50 shadow-sm\">\n        <div className=\"flex items-center gap-3\">\n          <Building className=\"w-5 h-5 text-primary\" />\n          <h1 className=\"text-xl font-semibold\">Planta dos Locais</h1>\n          {selectedSite && (\n            <Badge variant=\"outline\" className=\"text-xs\">\n              {selectedSite.name}\n            </Badge>\n          )}\n        </div>\n        \n        <div className=\"flex items-center gap-3\">\n          {/* Site selector inline */}\n          {sites && Array.isArray(sites) && sites.length > 0 && (\n            <Select value={selectedSiteId} onValueChange={setSelectedSiteId}>\n              <SelectTrigger className=\"w-64\" data-testid=\"select-site\">\n                <SelectValue placeholder=\"Selecione um local\" />\n              </SelectTrigger>\n              <SelectContent>\n                {(sites as any[]).map((site) => (\n                  <SelectItem key={site.id} value={site.id}>\n                    <div className=\"flex items-center gap-2\">\n                      <MapPin className=\"w-4 h-4\" />\n                      <span>{site.name}</span>\n                    </div>\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          )}\n          \n          {/* Botão Mapa de Calor */}\n          <Button \n            variant={isHeatmapMode ? \"default\" : \"outline\"} \n            size=\"sm\" \n            onClick={() => {\n              setIsHeatmapMode(!isHeatmapMode);\n              if (!isHeatmapMode) {\n                setIsEditMode(false); // Sair do modo de edição ao entrar no heatmap\n              }\n            }}\n            data-testid=\"button-heatmap-mode\"\n          >\n            <Thermometer className=\"w-4 h-4 mr-1\" />\n            Mapa de Calor\n          </Button>\n          \n          <Button \n            variant={isEditMode ? \"destructive\" : \"outline\"} \n            size=\"sm\" \n            onClick={() => {\n              setIsEditMode(!isEditMode);\n              if (!isEditMode) {\n                setIsHeatmapMode(false); // Sair do modo heatmap ao entrar na edição\n              }\n            }}\n            data-testid=\"button-edit-mode\"\n            disabled={isHeatmapMode}\n          >\n            {isEditMode ? (\n              <>\n                <X className=\"w-4 h-4 mr-1\" />\n                Sair\n              </>\n            ) : (\n              <>\n                <Edit3 className=\"w-4 h-4 mr-1\" />\n                Editar\n              </>\n            )}\n          </Button>\n          \n          {isEditMode && (\n            <>\n              <Button \n                variant=\"outline\" \n                size=\"sm\" \n                onClick={resetPositions}\n                data-testid=\"button-reset-positions\"\n              >\n                <RotateCcw className=\"w-4 h-4 mr-1\" />\n                Resetar\n              </Button>\n\n              {hasUnsavedChanges && (\n                <Button \n                  variant=\"default\" \n                  size=\"sm\"\n                  onClick={() => saveFloorPlanMutation.mutate()}\n                  disabled={saveFloorPlanMutation.isPending}\n                  className=\"bg-green-600 hover:bg-green-700\"\n                  data-testid=\"button-save-floor-plan\"\n                >\n                  <Save className=\"w-4 h-4 mr-1\" />\n                  {saveFloorPlanMutation.isPending ? \"Salvando...\" : \"Salvar Planta\"}\n                </Button>\n              )}\n            </>\n          )}\n\n          {hasUnsavedChanges && (\n            <div className=\"flex items-center text-orange-600 ml-2\">\n              <AlertCircle className=\"w-4 h-4 mr-1\" />\n              <span className=\"text-sm\">Mudanças não salvas</span>\n            </div>\n          )}\n        </div>\n      </div>\n\n      {/* Main Content Area - Full Height */}\n      <div className=\"flex-1 overflow-hidden\">\n        {!zones || (zones as any[]).length === 0 ? (\n          <div className=\"flex items-center justify-center h-full\">\n            <div className=\"text-center\">\n              <Building className=\"w-16 h-16 text-muted-foreground mx-auto mb-4\" />\n              <h3 className=\"text-xl font-medium mb-2\">Nenhuma zona encontrada</h3>\n              <p className=\"text-muted-foreground\">\n                {selectedSite ? \n                  `Não há zonas cadastradas para ${selectedSite.name}` : \n                  'Selecione um local para visualizar suas zonas'\n                }\n              </p>\n            </div>\n          </div>\n        ) : (\n          <div className=\"h-full flex flex-col p-4\">\n            {/* Legend and Edit mode instructions */}\n            <div className=\"mb-3 flex justify-between items-start gap-4\">\n              {/* Legend - Dynamic based on mode */}\n              <div className=\"bg-white border border-gray-200 rounded-md p-3 shadow-sm\">\n                <h4 className=\"text-sm font-medium text-gray-700 mb-2\">\n                  {isHeatmapMode ? 'Legenda de Performance (SLA)' : 'Legenda das Categorias'}\n                </h4>\n                <div className=\"flex flex-wrap gap-3\">\n                  {isHeatmapMode ? (\n                    <>\n                      <div className=\"flex items-center gap-2\">\n                        <div className=\"w-4 h-4 bg-red-400 border border-red-600 rounded\"></div>\n                        <span className=\"text-xs text-gray-600\">Crítico (&lt; 50%)</span>\n                      </div>\n                      <div className=\"flex items-center gap-2\">\n                        <div className=\"w-4 h-4 bg-orange-400 border border-orange-600 rounded\"></div>\n                        <span className=\"text-xs text-gray-600\">Atenção (50-69%)</span>\n                      </div>\n                      <div className=\"flex items-center gap-2\">\n                        <div className=\"w-4 h-4 bg-yellow-400 border border-yellow-600 rounded\"></div>\n                        <span className=\"text-xs text-gray-600\">Regular (70-84%)</span>\n                      </div>\n                      <div className=\"flex items-center gap-2\">\n                        <div className=\"w-4 h-4 bg-green-400 border border-green-600 rounded\"></div>\n                        <span className=\"text-xs text-gray-600\">Excelente (&ge; 85%)</span>\n                      </div>\n                    </>\n                  ) : (\n                    <>\n                      <div className=\"flex items-center gap-2\">\n                        <div className=\"w-4 h-4 bg-blue-200 border border-blue-400 rounded\"></div>\n                        <span className=\"text-xs text-gray-600\">Banheiro</span>\n                      </div>\n                      <div className=\"flex items-center gap-2\">\n                        <div className=\"w-4 h-4 bg-green-200 border border-green-400 rounded\"></div>\n                        <span className=\"text-xs text-gray-600\">Escritório</span>\n                      </div>\n                      <div className=\"flex items-center gap-2\">\n                        <div className=\"w-4 h-4 bg-orange-200 border border-orange-400 rounded\"></div>\n                        <span className=\"text-xs text-gray-600\">Produção</span>\n                      </div>\n                      <div className=\"flex items-center gap-2\">\n                        <div className=\"w-4 h-4 bg-gray-200 border border-gray-400 rounded\"></div>\n                        <span className=\"text-xs text-gray-600\">Outras</span>\n                      </div>\n                    </>\n                  )}\n                </div>\n              </div>\n\n              {/* Edit mode instructions - compact */}\n              {isEditMode && (\n                <div className=\"bg-amber-50 border border-amber-200 rounded-md p-3 flex-shrink-0\">\n                  <div className=\"flex items-center justify-between\">\n                    <div className=\"flex items-center gap-2\">\n                      <Palette className=\"w-4 h-4 text-amber-600\" />\n                      <span className=\"text-sm font-medium text-amber-800\">\n                        Modo de Edição {isDragging && \"- Arrastando...\"}\n                      </span>\n                    </div>\n                    <div className=\"text-xs text-amber-700 ml-4\">\n                      Clique rápido: editar • Arraste: mover • +/-: redimensionar\n                    </div>\n                  </div>\n                </div>\n              )}\n            </div>\n\n            {/* Large Visual Map - Full Available Height */}\n            <div \n              className={`flex-1 bg-gradient-to-br from-slate-50 to-slate-100 rounded-lg p-8 relative zone-map-container border-2 ${\n                isEditMode ? 'border-dashed border-amber-300' : 'border-slate-200'\n              }`} \n              data-testid=\"zone-map\"\n              onMouseMove={handleMouseMove}\n              onMouseUp={handleMouseUp}\n            >\n              <div className=\"absolute inset-6 bg-white/90 backdrop-blur-sm border border-slate-300 rounded-lg shadow-sm select-none\">\n                \n                {/* Site title */}\n                <div className=\"absolute top-4 left-6 text-lg font-medium text-foreground\">\n                  {selectedSite?.name} - {isHeatmapMode ? 'Mapa de Calor' : 'Planta Baixa'} \n                  {isEditMode && <span className=\"text-amber-600\">(Editando)</span>}\n                  {isHeatmapMode && <span className=\"text-orange-600\">(Modo Performance)</span>}\n                </div>\n\n                {/* Zone blocks with better positioning */}\n                {(zones as any[] || []).map((zone: any, index: number) => {\n                  const area = parseFloat(zone.areaM2 || '0');\n                  const allAreas = (zones as any[] || []).map((z: any) => parseFloat(z.areaM2 || '0'));\n                  const maxArea = Math.max(...allAreas);\n                  const minArea = Math.min(...allAreas.filter(a => a > 0));\n                  \n                  // Calculate proportional size\n                  const minSize = 120;\n                  const maxSize = 200;\n                  const sizeRatio = area > 0 ? (area - minArea) / (maxArea - minArea) : 0;\n                  const calculatedSize = minSize + (sizeRatio * (maxSize - minSize));\n                  const size = Math.max(minSize, calculatedSize);\n                  \n                  // Color coding - Heatmap mode ou categoria\n                  const getZoneColors = (category: string) => {\n                    switch (category?.toLowerCase()) {\n                      case 'banheiro':\n                        return { bg: 'bg-blue-200', border: 'border-blue-400', dot: 'bg-blue-400', text: 'text-blue-600' };\n                      case 'escritorio':\n                        return { bg: 'bg-green-200', border: 'border-green-400', dot: 'bg-green-400', text: 'text-green-600' };\n                      case 'producao':\n                        return { bg: 'bg-orange-200', border: 'border-orange-400', dot: 'bg-orange-400', text: 'text-orange-600' };\n                      default:\n                        return { bg: 'bg-gray-200', border: 'border-gray-400', dot: 'bg-gray-400', text: 'text-gray-600' };\n                    }\n                  };\n                  \n                  // Usar cores do heatmap se estiver no modo heatmap, senão usar cores da categoria\n                  const heatmapColors = getHeatmapColors(zone.id);\n                  const colors = heatmapColors || getZoneColors(zone.category);\n                  \n                  // Better default positioning\n                  const defaultPositions = [\n                    { left: 25, top: 25 },\n                    { left: 65, top: 25 }, \n                    { left: 25, top: 65 },\n                    { left: 65, top: 65 },\n                    { left: 45, top: 45 }\n                  ];\n                  \n                  const position = zonePositions[zone.id] || defaultPositions[index] || defaultPositions[0];\n                  const customSize = zoneSizes[zone.id] || size;\n                  \n                  return (\n                    <div \n                      key={zone.id}\n                      className={`absolute ${colors.bg} border-2 ${colors.border} rounded-lg flex flex-col items-center justify-center transition-all duration-200 shadow-md ${\n                        isEditMode ? 'cursor-move' : 'cursor-pointer'\n                      } ${\n                        draggingZone === zone.id && isDragging ? 'z-50 scale-110 shadow-xl opacity-90' : \n                        draggingZone === zone.id ? 'z-40' : \n                        isEditMode ? 'hover:scale-105 hover:shadow-lg' : 'hover:opacity-80'\n                      }`}\n                      style={{\n                        width: `${customSize}px`,\n                        height: `${customSize}px`,\n                        left: `${position.left}%`,\n                        top: `${position.top}%`,\n                        transform: 'translate(-50%, -50%)'\n                      }}\n                      onMouseDown={(e) => handleMouseDown(e, zone.id)}\n                      data-testid={`zone-${zone.id}`}\n                    >\n                      {/* Zone content */}\n                      <div className={`w-3 h-3 ${colors.dot} rounded-full mb-1`}></div>\n                      <div className={`text-xs font-medium ${colors.text} text-center px-2`}>\n                        {zone.name}\n                      </div>\n                      <div className=\"text-xs text-gray-500 text-center\">\n                        {isHeatmapMode ? (\n                          <>\n                            {(() => {\n                              const heatmapZone = (heatmapData as any[])?.find((hz: any) => hz.zoneId === zone.id);\n                              return `${heatmapZone?.slaPercentage || 0}% SLA`;\n                            })()} \n                          </>\n                        ) : (\n                          `${zone.areaM2}m²`\n                        )}\n                      </div>\n                      \n                      {/* BOTÕES DENTRO DO CARD - CANTO SUPERIOR DIREITO */}\n                      {isEditMode && (\n                        <div \n                          className=\"absolute -top-2 -right-2 flex gap-1\" \n                          style={{ \n                            pointerEvents: 'auto', \n                            zIndex: 1000 \n                          }}\n                          onMouseDown={(e) => {\n                            e.stopPropagation();\n                            e.preventDefault();\n                          }}\n                        >\n                          <button\n                            className=\"w-6 h-6 flex items-center justify-center bg-blue-500 hover:bg-blue-600 text-white rounded-full shadow-xl transition-all duration-200 hover:scale-110 border-2 border-white cursor-pointer\"\n                            style={{ pointerEvents: 'auto' }}\n                            onMouseDown={(e) => {\n                              e.stopPropagation();\n                              e.preventDefault();\n                            }}\n                            onPointerDown={(e) => {\n                              e.stopPropagation();\n                              e.preventDefault();\n                            }}\n                            onClick={async (e) => {\n                              e.stopPropagation();\n                              e.preventDefault();\n                              const currentSize = zoneSizes[zone.id] || 120;\n                              const newSize = Math.min(400, currentSize + 25);\n                              \n                              // Update local state immediately\n                              setZoneSizes(prev => ({ ...prev, [zone.id]: newSize }));\n                              setHasUnsavedChanges(true);\n                            }}\n                            title={`Aumentar ${zone.name}`}\n                          >\n                            <Plus className=\"w-3 h-3\" />\n                          </button>\n                          <button\n                            className=\"w-6 h-6 flex items-center justify-center bg-red-500 hover:bg-red-600 text-white rounded-full shadow-xl transition-all duration-200 hover:scale-110 border-2 border-white cursor-pointer\"\n                            style={{ pointerEvents: 'auto' }}\n                            onMouseDown={(e) => {\n                              e.stopPropagation();\n                              e.preventDefault();\n                            }}\n                            onPointerDown={(e) => {\n                              e.stopPropagation();\n                              e.preventDefault();\n                            }}\n                            onClick={async (e) => {\n                              e.stopPropagation();\n                              e.preventDefault();\n                              const currentSize = zoneSizes[zone.id] || 120;\n                              const newSize = Math.max(60, currentSize - 25);\n                              \n                              // Update local state immediately\n                              setZoneSizes(prev => ({ ...prev, [zone.id]: newSize }));\n                              setHasUnsavedChanges(true);\n                            }}\n                            title={`Diminuir ${zone.name}`}\n                          >\n                            <Minus className=\"w-3 h-3\" />\n                          </button>\n                        </div>\n                      )}\n                    </div>\n                  );\n                })}\n\n              </div>\n            </div>\n          </div>\n        )}\n\n        {/* Edit Zone Dialog */}\n        <Dialog open={!!editingZone} onOpenChange={(open) => !open && setEditingZone(null)}>\n          <DialogContent className=\"sm:max-w-md\" data-testid=\"dialog-edit-zone\">\n            <DialogHeader>\n              <DialogTitle>Editar Zona: {editingZone?.name}</DialogTitle>\n            </DialogHeader>\n            {editingZone && (\n              <div className=\"space-y-4\">\n                <div>\n                  <Label htmlFor=\"zone-name\">Nome</Label>\n                  <Input\n                    id=\"zone-name\"\n                    value={editingZone.name}\n                    onChange={(e) => setEditingZone({...editingZone, name: e.target.value})}\n                    data-testid=\"input-zone-name\"\n                  />\n                </div>\n\n                <div>\n                  <Label htmlFor=\"zone-description\">Descrição</Label>\n                  <Textarea\n                    id=\"zone-description\"\n                    value={editingZone.description || ''}\n                    onChange={(e) => setEditingZone({...editingZone, description: e.target.value})}\n                    data-testid=\"textarea-zone-description\"\n                  />\n                </div>\n\n                <div>\n                  <Label htmlFor=\"zone-area\">Área (m²)</Label>\n                  <Input\n                    id=\"zone-area\"\n                    type=\"number\"\n                    value={editingZone.areaM2 || ''}\n                    onChange={(e) => setEditingZone({...editingZone, areaM2: e.target.value})}\n                    data-testid=\"input-zone-area\"\n                  />\n                </div>\n\n                <div>\n                  <Label htmlFor=\"zone-category\">Categoria</Label>\n                  <Select value={editingZone.category} onValueChange={(value) => setEditingZone({...editingZone, category: value})}>\n                    <SelectTrigger data-testid=\"select-zone-category\">\n                      <SelectValue placeholder=\"Selecione uma categoria\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"banheiro\">Banheiro</SelectItem>\n                      <SelectItem value=\"escritorio\">Escritório</SelectItem>\n                      <SelectItem value=\"producao\">Produção</SelectItem>\n                      <SelectItem value=\"deposito\">Depósito</SelectItem>\n                      <SelectItem value=\"recepcao\">Recepção</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n\n                <div className=\"flex justify-end gap-2 pt-4\">\n                  <Button variant=\"outline\" onClick={() => setEditingZone(null)}>\n                    Cancelar\n                  </Button>\n                  <Button onClick={handleSaveZone} disabled={updateZoneMutation.isPending} data-testid=\"button-save-zone\">\n                    {updateZoneMutation.isPending ? \"Salvando...\" : \"Salvar\"}\n                  </Button>\n                </div>\n              </div>\n            )}\n          </DialogContent>\n        </Dialog>\n      </div>\n    </div>\n  );\n}","size_bytes":33764},"server/db.ts":{"content":"import { Pool } from 'pg';\nimport { drizzle } from 'drizzle-orm/node-postgres';\nimport * as schema from \"@shared/schema\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\n    \"DATABASE_URL must be set. Did you forget to provision a database?\",\n  );\n}\n\nexport const pool = new Pool({ connectionString: process.env.DATABASE_URL });\nexport const db = drizzle({ client: pool, schema });","size_bytes":386},"client/src/components/ProtectedRoute.tsx":{"content":"import { useAuth } from '@/hooks/useAuth';\nimport { useToast } from '@/hooks/use-toast';\nimport { useEffect } from 'react';\nimport { useLocation } from 'wouter';\n\ninterface ProtectedRouteProps {\n  children: React.ReactNode;\n  requireAdmin?: boolean;\n  requireManageClients?: boolean;\n  requireManageUsers?: boolean;\n  requireManageWorkOrders?: boolean;\n  requireViewReports?: boolean;\n  requireViewAuditLogs?: boolean;\n  fallbackPath?: string;\n}\n\nexport function ProtectedRoute({ \n  children, \n  requireAdmin = false,\n  requireManageClients = false,\n  requireManageUsers = false,\n  requireManageWorkOrders = false,\n  requireViewReports = false,\n  requireViewAuditLogs = false,\n  fallbackPath = '/'\n}: ProtectedRouteProps) {\n  const { \n    user, \n    isAuthenticated, \n    canManageClients, \n    canManageUsers,\n    canManageWorkOrders,\n    canViewReports,\n    isAdmin\n  } = useAuth();\n  const { toast } = useToast();\n  const [, setLocation] = useLocation();\n\n  useEffect(() => {\n    if (!isAuthenticated) {\n      toast({\n        title: 'Acesso negado',\n        description: 'Você precisa estar logado para acessar esta página.',\n        variant: 'destructive',\n      });\n      setLocation('/login');\n      return;\n    }\n\n    if (requireAdmin && user?.role !== 'admin') {\n      toast({\n        title: 'Acesso restrito',\n        description: 'Apenas administradores podem acessar esta página.',\n        variant: 'destructive',\n      });\n      setLocation(fallbackPath);\n      return;\n    }\n\n    if (requireManageClients && !canManageClients) {\n      toast({\n        title: 'Acesso restrito',\n        description: 'Você não tem permissão para gerenciar clientes.',\n        variant: 'destructive',\n      });\n      setLocation(fallbackPath);\n      return;\n    }\n\n    if (requireManageUsers && !canManageUsers) {\n      toast({\n        title: 'Acesso restrito',\n        description: 'Você não tem permissão para gerenciar usuários.',\n        variant: 'destructive',\n      });\n      setLocation(fallbackPath);\n      return;\n    }\n\n    if (requireManageWorkOrders && !canManageWorkOrders) {\n      toast({\n        title: 'Acesso restrito',\n        description: 'Você não tem permissão para gerenciar ordens de serviço.',\n        variant: 'destructive',\n      });\n      setLocation(fallbackPath);\n      return;\n    }\n\n    if (requireViewReports && !canViewReports) {\n      toast({\n        title: 'Acesso restrito',\n        description: 'Você não tem permissão para visualizar relatórios.',\n        variant: 'destructive',\n      });\n      setLocation(fallbackPath);\n      return;\n    }\n\n    if (requireViewAuditLogs && !isAdmin) {\n      toast({\n        title: 'Acesso restrito',\n        description: 'Apenas administradores podem visualizar logs de auditoria.',\n        variant: 'destructive',\n      });\n      setLocation(fallbackPath);\n      return;\n    }\n  }, [\n    isAuthenticated, \n    user, \n    requireAdmin, \n    requireManageClients, \n    requireManageUsers,\n    requireManageWorkOrders,\n    requireViewReports,\n    requireViewAuditLogs,\n    canManageClients, \n    canManageUsers,\n    canManageWorkOrders,\n    canViewReports,\n    isAdmin,\n    toast, \n    setLocation, \n    fallbackPath\n  ]);\n\n  // Se não passou na verificação, não renderizar nada\n  if (!isAuthenticated) return null;\n  if (requireAdmin && user?.role !== 'admin') return null;\n  if (requireManageClients && !canManageClients) return null;\n  if (requireManageUsers && !canManageUsers) return null;\n  if (requireManageWorkOrders && !canManageWorkOrders) return null;\n  if (requireViewReports && !canViewReports) return null;\n  if (requireViewAuditLogs && !isAdmin) return null;\n\n  return <>{children}</>;\n}\n","size_bytes":3690},"client/src/pages/login-mobile.tsx":{"content":"import { useState } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { login, setAuthState } from \"@/lib/auth\";\nimport { User, Lock, Eye, EyeOff } from \"lucide-react\";\nimport opusLogo from \"@assets/ChatGPT Image 8 de set. de 2025, 18_10_10_1757366528566.png\";\n\nexport default function LoginMobile() {\n  const [, setLocation] = useLocation();\n  const [isLoading, setIsLoading] = useState(false);\n  const [showPassword, setShowPassword] = useState(false);\n  const [credentials, setCredentials] = useState({\n    username: \"\",\n    password: \"\"\n  });\n  const { toast } = useToast();\n\n  const handleLogin = async (e: React.FormEvent) => {\n    e.preventDefault();\n    setIsLoading(true);\n\n    try {\n      const { user, token } = await login(credentials);\n      setAuthState(user, token);\n      \n      // Redirecionar baseado no role do usuário\n      if (user.role === 'operador') {\n        setLocation(\"/mobile\");\n      } else {\n        // Admin, gestor, supervisor vão para a versão desktop\n        setLocation(\"/\");\n      }\n      \n      toast({\n        title: \"Login realizado com sucesso\",\n        description: `Bem-vindo, ${user.name}!`,\n      });\n    } catch (error) {\n      toast({\n        title: \"Erro no login\",\n        description: \"Verifique suas credenciais e tente novamente.\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 flex items-center justify-center p-4\">\n      \n      {/* Container principal adaptado para mobile */}\n      <div className=\"w-full max-w-md mx-auto bg-white rounded-3xl shadow-2xl overflow-hidden\">\n        \n        {/* Hero Section adaptada para mobile */}\n        <div className=\"relative bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900 p-8 text-white overflow-hidden\">\n          {/* Background pattern */}\n          <div className=\"absolute inset-0 opacity-10\">\n            <svg className=\"w-full h-full\" viewBox=\"0 0 100 100\" xmlns=\"http://www.w3.org/2000/svg\">\n              <defs>\n                <pattern id=\"grid\" width=\"10\" height=\"10\" patternUnits=\"userSpaceOnUse\">\n                  <path d=\"M 10 0 L 0 0 0 10\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"0.5\"/>\n                </pattern>\n              </defs>\n              <rect width=\"100\" height=\"100\" fill=\"url(#grid)\" />\n            </svg>\n          </div>\n          \n          {/* Content */}\n          <div className=\"relative z-10 text-center space-y-6\">\n            {/* Logo */}\n            <div className=\"mb-8\">\n              <div className=\"w-24 h-24 mx-auto bg-white/95 rounded-2xl p-4 shadow-xl\">\n                <img \n                  src={opusLogo} \n                  alt=\"OPUS\" \n                  className=\"w-full h-full object-contain\"\n                />\n              </div>\n            </div>\n            \n            {/* Hero Text */}\n            <div className=\"space-y-3\">\n              <p className=\"text-sm text-slate-300 leading-relaxed\">\n                Plataforma inteligente para gestão completa de facilities\n              </p>\n            </div>\n            \n            {/* Features compactas */}\n            <div className=\"grid grid-cols-1 gap-2 text-center\">\n              <div className=\"flex items-center justify-center space-x-2\">\n                <div className=\"w-1.5 h-1.5 bg-blue-400 rounded-full\"></div>\n                <span className=\"text-xs text-slate-300\">Gestão em tempo real</span>\n              </div>\n              <div className=\"flex items-center justify-center space-x-2\">\n                <div className=\"w-1.5 h-1.5 bg-blue-400 rounded-full\"></div>\n                <span className=\"text-xs text-slate-300\">Interface móvel otimizada</span>\n              </div>\n            </div>\n          </div>\n          \n          {/* Decorative elements */}\n          <div className=\"absolute top-4 right-4 w-16 h-16 bg-blue-500/20 rounded-full blur-xl\"></div>\n          <div className=\"absolute bottom-4 left-4 w-12 h-12 bg-indigo-500/20 rounded-full blur-xl\"></div>\n        </div>\n\n        {/* Login Form Section */}\n        <div className=\"p-8\">\n          <div className=\"space-y-6\">\n            \n            {/* Header */}\n            <div className=\"text-center space-y-2\">\n              <h2 className=\"text-2xl font-bold text-slate-900\">Entrar</h2>\n              <p className=\"text-slate-600 text-sm\">Acesse sua conta para continuar</p>\n            </div>\n\n            {/* Login Form */}\n            <Card className=\"border-0 shadow-none\">\n              <CardContent className=\"p-0\">\n                <form onSubmit={handleLogin} className=\"space-y-5\">\n                  \n                  {/* Username Field */}\n                  <div className=\"space-y-2\">\n                    <label htmlFor=\"username\" className=\"text-sm font-medium text-slate-900\">\n                      Usuário\n                    </label>\n                    <div className=\"relative\">\n                      <User className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-slate-400\" />\n                      <Input\n                        id=\"username\"\n                        data-testid=\"input-username-mobile\"\n                        type=\"text\"\n                        placeholder=\"Digite seu usuário\"\n                        value={credentials.username}\n                        onChange={(e) => setCredentials(prev => ({ ...prev, username: e.target.value }))}\n                        className=\"pl-10 h-12 border-slate-200 focus:border-blue-500 focus:ring-blue-500 bg-slate-50 focus:bg-white transition-all duration-200\"\n                        required\n                      />\n                    </div>\n                  </div>\n\n                  {/* Password Field */}\n                  <div className=\"space-y-2\">\n                    <label htmlFor=\"password\" className=\"text-sm font-medium text-slate-900\">\n                      Senha\n                    </label>\n                    <div className=\"relative\">\n                      <Lock className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-slate-400\" />\n                      <Input\n                        id=\"password\"\n                        data-testid=\"input-password-mobile\"\n                        type={showPassword ? \"text\" : \"password\"}\n                        placeholder=\"Digite sua senha\"\n                        value={credentials.password}\n                        onChange={(e) => setCredentials(prev => ({ ...prev, password: e.target.value }))}\n                        className=\"pl-10 pr-10 h-12 border-slate-200 focus:border-blue-500 focus:ring-blue-500 bg-slate-50 focus:bg-white transition-all duration-200\"\n                        required\n                      />\n                      <button\n                        type=\"button\"\n                        onClick={() => setShowPassword(!showPassword)}\n                        className=\"absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-slate-600 transition-colors\"\n                        tabIndex={-1}\n                      >\n                        {showPassword ? <EyeOff className=\"h-4 w-4\" /> : <Eye className=\"h-4 w-4\" />}\n                      </button>\n                    </div>\n                  </div>\n\n                  {/* Login Button */}\n                  <Button \n                    type=\"submit\" \n                    data-testid=\"button-login-mobile\"\n                    className=\"w-full h-12 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-semibold rounded-xl shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all duration-200\" \n                    disabled={isLoading}\n                  >\n                    {isLoading ? (\n                      <div className=\"flex items-center space-x-2\">\n                        <div className=\"w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin\"></div>\n                        <span>Entrando...</span>\n                      </div>\n                    ) : (\n                      \"Entrar\"\n                    )}\n                  </Button>\n\n                </form>\n              </CardContent>\n            </Card>\n\n            {/* Link para Desktop */}\n            <div className=\"text-center pt-2\">\n              <button\n                type=\"button\"\n                onClick={() => setLocation(\"/\")}\n                className=\"text-sm text-blue-600 hover:text-blue-800 font-medium\"\n                data-testid=\"link-desktop-version\"\n              >\n                Acessar versão desktop\n              </button>\n            </div>\n\n            {/* Footer */}\n            <div className=\"text-center pt-4\">\n              <p className=\"text-xs text-slate-500\">\n                © 2025 OPUS. Todos os direitos reservados.\n              </p>\n            </div>\n\n          </div>\n        </div>\n\n      </div>\n    </div>\n  );\n}","size_bytes":9174},"client/src/components/ui/chart.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as RechartsPrimitive from \"recharts\"\n\nimport { cn } from \"@/lib/utils\"\n\n// Format: { THEME_NAME: CSS_SELECTOR }\nconst THEMES = { light: \"\", dark: \".dark\" } as const\n\nexport type ChartConfig = {\n  [k in string]: {\n    label?: React.ReactNode\n    icon?: React.ComponentType\n  } & (\n    | { color?: string; theme?: never }\n    | { color?: never; theme: Record<keyof typeof THEMES, string> }\n  )\n}\n\ntype ChartContextProps = {\n  config: ChartConfig\n}\n\nconst ChartContext = React.createContext<ChartContextProps | null>(null)\n\nfunction useChart() {\n  const context = React.useContext(ChartContext)\n\n  if (!context) {\n    throw new Error(\"useChart must be used within a <ChartContainer />\")\n  }\n\n  return context\n}\n\nconst ChartContainer = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    config: ChartConfig\n    children: React.ComponentProps<\n      typeof RechartsPrimitive.ResponsiveContainer\n    >[\"children\"]\n  }\n>(({ id, className, children, config, ...props }, ref) => {\n  const uniqueId = React.useId()\n  const chartId = `chart-${id || uniqueId.replace(/:/g, \"\")}`\n\n  return (\n    <ChartContext.Provider value={{ config }}>\n      <div\n        data-chart={chartId}\n        ref={ref}\n        className={cn(\n          \"flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none\",\n          className\n        )}\n        {...props}\n      >\n        <ChartStyle id={chartId} config={config} />\n        <RechartsPrimitive.ResponsiveContainer>\n          {children}\n        </RechartsPrimitive.ResponsiveContainer>\n      </div>\n    </ChartContext.Provider>\n  )\n})\nChartContainer.displayName = \"Chart\"\n\nconst ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {\n  const colorConfig = Object.entries(config).filter(\n    ([, config]) => config.theme || config.color\n  )\n\n  if (!colorConfig.length) {\n    return null\n  }\n\n  return (\n    <style\n      dangerouslySetInnerHTML={{\n        __html: Object.entries(THEMES)\n          .map(\n            ([theme, prefix]) => `\n${prefix} [data-chart=${id}] {\n${colorConfig\n  .map(([key, itemConfig]) => {\n    const color =\n      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||\n      itemConfig.color\n    return color ? `  --color-${key}: ${color};` : null\n  })\n  .join(\"\\n\")}\n}\n`\n          )\n          .join(\"\\n\"),\n      }}\n    />\n  )\n}\n\nconst ChartTooltip = RechartsPrimitive.Tooltip\n\nconst ChartTooltipContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &\n    React.ComponentProps<\"div\"> & {\n      hideLabel?: boolean\n      hideIndicator?: boolean\n      indicator?: \"line\" | \"dot\" | \"dashed\"\n      nameKey?: string\n      labelKey?: string\n    }\n>(\n  (\n    {\n      active,\n      payload,\n      className,\n      indicator = \"dot\",\n      hideLabel = false,\n      hideIndicator = false,\n      label,\n      labelFormatter,\n      labelClassName,\n      formatter,\n      color,\n      nameKey,\n      labelKey,\n    },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    const tooltipLabel = React.useMemo(() => {\n      if (hideLabel || !payload?.length) {\n        return null\n      }\n\n      const [item] = payload\n      const key = `${labelKey || item?.dataKey || item?.name || \"value\"}`\n      const itemConfig = getPayloadConfigFromPayload(config, item, key)\n      const value =\n        !labelKey && typeof label === \"string\"\n          ? config[label as keyof typeof config]?.label || label\n          : itemConfig?.label\n\n      if (labelFormatter) {\n        return (\n          <div className={cn(\"font-medium\", labelClassName)}>\n            {labelFormatter(value, payload)}\n          </div>\n        )\n      }\n\n      if (!value) {\n        return null\n      }\n\n      return <div className={cn(\"font-medium\", labelClassName)}>{value}</div>\n    }, [\n      label,\n      labelFormatter,\n      payload,\n      hideLabel,\n      labelClassName,\n      config,\n      labelKey,\n    ])\n\n    if (!active || !payload?.length) {\n      return null\n    }\n\n    const nestLabel = payload.length === 1 && indicator !== \"dot\"\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl\",\n          className\n        )}\n      >\n        {!nestLabel ? tooltipLabel : null}\n        <div className=\"grid gap-1.5\">\n          {payload.map((item, index) => {\n            const key = `${nameKey || item.name || item.dataKey || \"value\"}`\n            const itemConfig = getPayloadConfigFromPayload(config, item, key)\n            const indicatorColor = color || item.payload.fill || item.color\n\n            return (\n              <div\n                key={item.dataKey}\n                className={cn(\n                  \"flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground\",\n                  indicator === \"dot\" && \"items-center\"\n                )}\n              >\n                {formatter && item?.value !== undefined && item.name ? (\n                  formatter(item.value, item.name, item, index, item.payload)\n                ) : (\n                  <>\n                    {itemConfig?.icon ? (\n                      <itemConfig.icon />\n                    ) : (\n                      !hideIndicator && (\n                        <div\n                          className={cn(\n                            \"shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]\",\n                            {\n                              \"h-2.5 w-2.5\": indicator === \"dot\",\n                              \"w-1\": indicator === \"line\",\n                              \"w-0 border-[1.5px] border-dashed bg-transparent\":\n                                indicator === \"dashed\",\n                              \"my-0.5\": nestLabel && indicator === \"dashed\",\n                            }\n                          )}\n                          style={\n                            {\n                              \"--color-bg\": indicatorColor,\n                              \"--color-border\": indicatorColor,\n                            } as React.CSSProperties\n                          }\n                        />\n                      )\n                    )}\n                    <div\n                      className={cn(\n                        \"flex flex-1 justify-between leading-none\",\n                        nestLabel ? \"items-end\" : \"items-center\"\n                      )}\n                    >\n                      <div className=\"grid gap-1.5\">\n                        {nestLabel ? tooltipLabel : null}\n                        <span className=\"text-muted-foreground\">\n                          {itemConfig?.label || item.name}\n                        </span>\n                      </div>\n                      {item.value && (\n                        <span className=\"font-mono font-medium tabular-nums text-foreground\">\n                          {item.value.toLocaleString()}\n                        </span>\n                      )}\n                    </div>\n                  </>\n                )}\n              </div>\n            )\n          })}\n        </div>\n      </div>\n    )\n  }\n)\nChartTooltipContent.displayName = \"ChartTooltip\"\n\nconst ChartLegend = RechartsPrimitive.Legend\n\nconst ChartLegendContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> &\n    Pick<RechartsPrimitive.LegendProps, \"payload\" | \"verticalAlign\"> & {\n      hideIcon?: boolean\n      nameKey?: string\n    }\n>(\n  (\n    { className, hideIcon = false, payload, verticalAlign = \"bottom\", nameKey },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    if (!payload?.length) {\n      return null\n    }\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"flex items-center justify-center gap-4\",\n          verticalAlign === \"top\" ? \"pb-3\" : \"pt-3\",\n          className\n        )}\n      >\n        {payload.map((item) => {\n          const key = `${nameKey || item.dataKey || \"value\"}`\n          const itemConfig = getPayloadConfigFromPayload(config, item, key)\n\n          return (\n            <div\n              key={item.value}\n              className={cn(\n                \"flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground\"\n              )}\n            >\n              {itemConfig?.icon && !hideIcon ? (\n                <itemConfig.icon />\n              ) : (\n                <div\n                  className=\"h-2 w-2 shrink-0 rounded-[2px]\"\n                  style={{\n                    backgroundColor: item.color,\n                  }}\n                />\n              )}\n              {itemConfig?.label}\n            </div>\n          )\n        })}\n      </div>\n    )\n  }\n)\nChartLegendContent.displayName = \"ChartLegend\"\n\n// Helper to extract item config from a payload.\nfunction getPayloadConfigFromPayload(\n  config: ChartConfig,\n  payload: unknown,\n  key: string\n) {\n  if (typeof payload !== \"object\" || payload === null) {\n    return undefined\n  }\n\n  const payloadPayload =\n    \"payload\" in payload &&\n    typeof payload.payload === \"object\" &&\n    payload.payload !== null\n      ? payload.payload\n      : undefined\n\n  let configLabelKey: string = key\n\n  if (\n    key in payload &&\n    typeof payload[key as keyof typeof payload] === \"string\"\n  ) {\n    configLabelKey = payload[key as keyof typeof payload] as string\n  } else if (\n    payloadPayload &&\n    key in payloadPayload &&\n    typeof payloadPayload[key as keyof typeof payloadPayload] === \"string\"\n  ) {\n    configLabelKey = payloadPayload[\n      key as keyof typeof payloadPayload\n    ] as string\n  }\n\n  return configLabelKey in config\n    ? config[configLabelKey]\n    : config[key as keyof typeof config]\n}\n\nexport {\n  ChartContainer,\n  ChartTooltip,\n  ChartTooltipContent,\n  ChartLegend,\n  ChartLegendContent,\n  ChartStyle,\n}\n","size_bytes":10481},"client/src/components/ui/popover.tsx":{"content":"import * as React from \"react\"\nimport * as PopoverPrimitive from \"@radix-ui/react-popover\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Popover = PopoverPrimitive.Root\n\nconst PopoverTrigger = PopoverPrimitive.Trigger\n\nconst PopoverContent = React.forwardRef<\n  React.ElementRef<typeof PopoverPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <PopoverPrimitive.Portal>\n    <PopoverPrimitive.Content\n      ref={ref}\n      align={align}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </PopoverPrimitive.Portal>\n))\nPopoverContent.displayName = PopoverPrimitive.Content.displayName\n\nexport { Popover, PopoverTrigger, PopoverContent }\n","size_bytes":1280},"client/src/components/ui/button.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst buttonVariants = cva(\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-primary text-primary-foreground hover:bg-primary/90\",\n        destructive:\n          \"bg-destructive text-destructive-foreground hover:bg-destructive/90\",\n        outline:\n          \"border border-input bg-background hover:bg-accent hover:text-accent-foreground\",\n        secondary:\n          \"bg-secondary text-secondary-foreground hover:bg-secondary/80\",\n        ghost: \"hover:bg-accent hover:text-accent-foreground\",\n        link: \"text-primary underline-offset-4 hover:underline\",\n      },\n      size: {\n        default: \"h-10 px-4 py-2\",\n        sm: \"h-9 rounded-md px-3\",\n        lg: \"h-11 rounded-md px-8\",\n        icon: \"h-10 w-10\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nexport interface ButtonProps\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\n    VariantProps<typeof buttonVariants> {\n  asChild?: boolean\n}\n\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\n  ({ className, variant, size, asChild = false, ...props }, ref) => {\n    const Comp = asChild ? Slot : \"button\"\n    return (\n      <Comp\n        className={cn(buttonVariants({ variant, size, className }))}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nButton.displayName = \"Button\"\n\nexport { Button, buttonVariants }\n","size_bytes":1901},"client/src/components/ui/sidebar.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { VariantProps, cva } from \"class-variance-authority\"\nimport { PanelLeft } from \"lucide-react\"\n\nimport { useIsMobile } from \"@/hooks/use-mobile\"\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Separator } from \"@/components/ui/separator\"\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from \"@/components/ui/sheet\"\nimport { Skeleton } from \"@/components/ui/skeleton\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\"\n\nconst SIDEBAR_COOKIE_NAME = \"sidebar_state\"\nconst SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7\nconst SIDEBAR_WIDTH = \"16rem\"\nconst SIDEBAR_WIDTH_MOBILE = \"18rem\"\nconst SIDEBAR_WIDTH_ICON = \"3rem\"\nconst SIDEBAR_KEYBOARD_SHORTCUT = \"b\"\n\ntype SidebarContextProps = {\n  state: \"expanded\" | \"collapsed\"\n  open: boolean\n  setOpen: (open: boolean) => void\n  openMobile: boolean\n  setOpenMobile: (open: boolean) => void\n  isMobile: boolean\n  toggleSidebar: () => void\n}\n\nconst SidebarContext = React.createContext<SidebarContextProps | null>(null)\n\nfunction useSidebar() {\n  const context = React.useContext(SidebarContext)\n  if (!context) {\n    throw new Error(\"useSidebar must be used within a SidebarProvider.\")\n  }\n\n  return context\n}\n\nconst SidebarProvider = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    defaultOpen?: boolean\n    open?: boolean\n    onOpenChange?: (open: boolean) => void\n  }\n>(\n  (\n    {\n      defaultOpen = true,\n      open: openProp,\n      onOpenChange: setOpenProp,\n      className,\n      style,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const isMobile = useIsMobile()\n    const [openMobile, setOpenMobile] = React.useState(false)\n\n    // This is the internal state of the sidebar.\n    // We use openProp and setOpenProp for control from outside the component.\n    const [_open, _setOpen] = React.useState(defaultOpen)\n    const open = openProp ?? _open\n    const setOpen = React.useCallback(\n      (value: boolean | ((value: boolean) => boolean)) => {\n        const openState = typeof value === \"function\" ? value(open) : value\n        if (setOpenProp) {\n          setOpenProp(openState)\n        } else {\n          _setOpen(openState)\n        }\n\n        // This sets the cookie to keep the sidebar state.\n        document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`\n      },\n      [setOpenProp, open]\n    )\n\n    // Helper to toggle the sidebar.\n    const toggleSidebar = React.useCallback(() => {\n      return isMobile\n        ? setOpenMobile((open) => !open)\n        : setOpen((open) => !open)\n    }, [isMobile, setOpen, setOpenMobile])\n\n    // Adds a keyboard shortcut to toggle the sidebar.\n    React.useEffect(() => {\n      const handleKeyDown = (event: KeyboardEvent) => {\n        if (\n          event.key === SIDEBAR_KEYBOARD_SHORTCUT &&\n          (event.metaKey || event.ctrlKey)\n        ) {\n          event.preventDefault()\n          toggleSidebar()\n        }\n      }\n\n      window.addEventListener(\"keydown\", handleKeyDown)\n      return () => window.removeEventListener(\"keydown\", handleKeyDown)\n    }, [toggleSidebar])\n\n    // We add a state so that we can do data-state=\"expanded\" or \"collapsed\".\n    // This makes it easier to style the sidebar with Tailwind classes.\n    const state = open ? \"expanded\" : \"collapsed\"\n\n    const contextValue = React.useMemo<SidebarContextProps>(\n      () => ({\n        state,\n        open,\n        setOpen,\n        isMobile,\n        openMobile,\n        setOpenMobile,\n        toggleSidebar,\n      }),\n      [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]\n    )\n\n    return (\n      <SidebarContext.Provider value={contextValue}>\n        <TooltipProvider delayDuration={0}>\n          <div\n            style={\n              {\n                \"--sidebar-width\": SIDEBAR_WIDTH,\n                \"--sidebar-width-icon\": SIDEBAR_WIDTH_ICON,\n                ...style,\n              } as React.CSSProperties\n            }\n            className={cn(\n              \"group/sidebar-wrapper flex min-h-svh w-full has-[[data-variant=inset]]:bg-sidebar\",\n              className\n            )}\n            ref={ref}\n            {...props}\n          >\n            {children}\n          </div>\n        </TooltipProvider>\n      </SidebarContext.Provider>\n    )\n  }\n)\nSidebarProvider.displayName = \"SidebarProvider\"\n\nconst Sidebar = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    side?: \"left\" | \"right\"\n    variant?: \"sidebar\" | \"floating\" | \"inset\"\n    collapsible?: \"offcanvas\" | \"icon\" | \"none\"\n  }\n>(\n  (\n    {\n      side = \"left\",\n      variant = \"sidebar\",\n      collapsible = \"offcanvas\",\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const { isMobile, state, openMobile, setOpenMobile } = useSidebar()\n\n    if (collapsible === \"none\") {\n      return (\n        <div\n          className={cn(\n            \"flex h-full w-[--sidebar-width] flex-col bg-sidebar text-sidebar-foreground\",\n            className\n          )}\n          ref={ref}\n          {...props}\n        >\n          {children}\n        </div>\n      )\n    }\n\n    if (isMobile) {\n      return (\n        <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>\n          <SheetContent\n            data-sidebar=\"sidebar\"\n            data-mobile=\"true\"\n            className=\"w-[--sidebar-width] bg-sidebar p-0 text-sidebar-foreground [&>button]:hidden\"\n            style={\n              {\n                \"--sidebar-width\": SIDEBAR_WIDTH_MOBILE,\n              } as React.CSSProperties\n            }\n            side={side}\n          >\n            <SheetHeader className=\"sr-only\">\n              <SheetTitle>Sidebar</SheetTitle>\n              <SheetDescription>Displays the mobile sidebar.</SheetDescription>\n            </SheetHeader>\n            <div className=\"flex h-full w-full flex-col\">{children}</div>\n          </SheetContent>\n        </Sheet>\n      )\n    }\n\n    return (\n      <div\n        ref={ref}\n        className=\"group peer hidden text-sidebar-foreground md:block\"\n        data-state={state}\n        data-collapsible={state === \"collapsed\" ? collapsible : \"\"}\n        data-variant={variant}\n        data-side={side}\n      >\n        {/* This is what handles the sidebar gap on desktop */}\n        <div\n          className={cn(\n            \"relative w-[--sidebar-width] bg-transparent transition-[width] duration-200 ease-linear\",\n            \"group-data-[collapsible=offcanvas]:w-0\",\n            \"group-data-[side=right]:rotate-180\",\n            variant === \"floating\" || variant === \"inset\"\n              ? \"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4))]\"\n              : \"group-data-[collapsible=icon]:w-[--sidebar-width-icon]\"\n          )}\n        />\n        <div\n          className={cn(\n            \"fixed inset-y-0 z-10 hidden h-svh w-[--sidebar-width] transition-[left,right,width] duration-200 ease-linear md:flex\",\n            side === \"left\"\n              ? \"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]\"\n              : \"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]\",\n            // Adjust the padding for floating and inset variants.\n            variant === \"floating\" || variant === \"inset\"\n              ? \"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4)_+2px)]\"\n              : \"group-data-[collapsible=icon]:w-[--sidebar-width-icon] group-data-[side=left]:border-r group-data-[side=right]:border-l\",\n            className\n          )}\n          {...props}\n        >\n          <div\n            data-sidebar=\"sidebar\"\n            className=\"flex h-full w-full flex-col bg-sidebar group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:border-sidebar-border group-data-[variant=floating]:shadow\"\n          >\n            {children}\n          </div>\n        </div>\n      </div>\n    )\n  }\n)\nSidebar.displayName = \"Sidebar\"\n\nconst SidebarTrigger = React.forwardRef<\n  React.ElementRef<typeof Button>,\n  React.ComponentProps<typeof Button>\n>(({ className, onClick, ...props }, ref) => {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <Button\n      ref={ref}\n      data-sidebar=\"trigger\"\n      variant=\"ghost\"\n      size=\"icon\"\n      className={cn(\"h-7 w-7\", className)}\n      onClick={(event) => {\n        onClick?.(event)\n        toggleSidebar()\n      }}\n      {...props}\n    >\n      <PanelLeft />\n      <span className=\"sr-only\">Toggle Sidebar</span>\n    </Button>\n  )\n})\nSidebarTrigger.displayName = \"SidebarTrigger\"\n\nconst SidebarRail = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\">\n>(({ className, ...props }, ref) => {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <button\n      ref={ref}\n      data-sidebar=\"rail\"\n      aria-label=\"Toggle Sidebar\"\n      tabIndex={-1}\n      onClick={toggleSidebar}\n      title=\"Toggle Sidebar\"\n      className={cn(\n        \"absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] hover:after:bg-sidebar-border group-data-[side=left]:-right-4 group-data-[side=right]:left-0 sm:flex\",\n        \"[[data-side=left]_&]:cursor-w-resize [[data-side=right]_&]:cursor-e-resize\",\n        \"[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize\",\n        \"group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full group-data-[collapsible=offcanvas]:hover:bg-sidebar\",\n        \"[[data-side=left][data-collapsible=offcanvas]_&]:-right-2\",\n        \"[[data-side=right][data-collapsible=offcanvas]_&]:-left-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarRail.displayName = \"SidebarRail\"\n\nconst SidebarInset = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"main\">\n>(({ className, ...props }, ref) => {\n  return (\n    <main\n      ref={ref}\n      className={cn(\n        \"relative flex w-full flex-1 flex-col bg-background\",\n        \"md:peer-data-[variant=inset]:m-2 md:peer-data-[state=collapsed]:peer-data-[variant=inset]:ml-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarInset.displayName = \"SidebarInset\"\n\nconst SidebarInput = React.forwardRef<\n  React.ElementRef<typeof Input>,\n  React.ComponentProps<typeof Input>\n>(({ className, ...props }, ref) => {\n  return (\n    <Input\n      ref={ref}\n      data-sidebar=\"input\"\n      className={cn(\n        \"h-8 w-full bg-background shadow-none focus-visible:ring-2 focus-visible:ring-sidebar-ring\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarInput.displayName = \"SidebarInput\"\n\nconst SidebarHeader = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"header\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n})\nSidebarHeader.displayName = \"SidebarHeader\"\n\nconst SidebarFooter = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"footer\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n})\nSidebarFooter.displayName = \"SidebarFooter\"\n\nconst SidebarSeparator = React.forwardRef<\n  React.ElementRef<typeof Separator>,\n  React.ComponentProps<typeof Separator>\n>(({ className, ...props }, ref) => {\n  return (\n    <Separator\n      ref={ref}\n      data-sidebar=\"separator\"\n      className={cn(\"mx-2 w-auto bg-sidebar-border\", className)}\n      {...props}\n    />\n  )\n})\nSidebarSeparator.displayName = \"SidebarSeparator\"\n\nconst SidebarContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"content\"\n      className={cn(\n        \"flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarContent.displayName = \"SidebarContent\"\n\nconst SidebarGroup = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"group\"\n      className={cn(\"relative flex w-full min-w-0 flex-col p-2\", className)}\n      {...props}\n    />\n  )\n})\nSidebarGroup.displayName = \"SidebarGroup\"\n\nconst SidebarGroupLabel = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & { asChild?: boolean }\n>(({ className, asChild = false, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"div\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"group-label\"\n      className={cn(\n        \"flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium text-sidebar-foreground/70 outline-none ring-sidebar-ring transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        \"group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarGroupLabel.displayName = \"SidebarGroupLabel\"\n\nconst SidebarGroupAction = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\"> & { asChild?: boolean }\n>(({ className, asChild = false, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"group-action\"\n      className={cn(\n        \"absolute right-3 top-3.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 after:md:hidden\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarGroupAction.displayName = \"SidebarGroupAction\"\n\nconst SidebarGroupContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    data-sidebar=\"group-content\"\n    className={cn(\"w-full text-sm\", className)}\n    {...props}\n  />\n))\nSidebarGroupContent.displayName = \"SidebarGroupContent\"\n\nconst SidebarMenu = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    data-sidebar=\"menu\"\n    className={cn(\"flex w-full min-w-0 flex-col gap-1\", className)}\n    {...props}\n  />\n))\nSidebarMenu.displayName = \"SidebarMenu\"\n\nconst SidebarMenuItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    data-sidebar=\"menu-item\"\n    className={cn(\"group/menu-item relative\", className)}\n    {...props}\n  />\n))\nSidebarMenuItem.displayName = \"SidebarMenuItem\"\n\nconst sidebarMenuButtonVariants = cva(\n  \"peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-none ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-[[data-sidebar=menu-action]]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:!size-8 group-data-[collapsible=icon]:!p-2 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\",\n        outline:\n          \"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]\",\n      },\n      size: {\n        default: \"h-8 text-sm\",\n        sm: \"h-7 text-xs\",\n        lg: \"h-12 text-sm group-data-[collapsible=icon]:!p-0\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst SidebarMenuButton = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\"> & {\n    asChild?: boolean\n    isActive?: boolean\n    tooltip?: string | React.ComponentProps<typeof TooltipContent>\n  } & VariantProps<typeof sidebarMenuButtonVariants>\n>(\n  (\n    {\n      asChild = false,\n      isActive = false,\n      variant = \"default\",\n      size = \"default\",\n      tooltip,\n      className,\n      ...props\n    },\n    ref\n  ) => {\n    const Comp = asChild ? Slot : \"button\"\n    const { isMobile, state } = useSidebar()\n\n    const button = (\n      <Comp\n        ref={ref}\n        data-sidebar=\"menu-button\"\n        data-size={size}\n        data-active={isActive}\n        className={cn(sidebarMenuButtonVariants({ variant, size }), className)}\n        {...props}\n      />\n    )\n\n    if (!tooltip) {\n      return button\n    }\n\n    if (typeof tooltip === \"string\") {\n      tooltip = {\n        children: tooltip,\n      }\n    }\n\n    return (\n      <Tooltip>\n        <TooltipTrigger asChild>{button}</TooltipTrigger>\n        <TooltipContent\n          side=\"right\"\n          align=\"center\"\n          hidden={state !== \"collapsed\" || isMobile}\n          {...tooltip}\n        />\n      </Tooltip>\n    )\n  }\n)\nSidebarMenuButton.displayName = \"SidebarMenuButton\"\n\nconst SidebarMenuAction = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\"> & {\n    asChild?: boolean\n    showOnHover?: boolean\n  }\n>(({ className, asChild = false, showOnHover = false, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"menu-action\"\n      className={cn(\n        \"absolute right-1 top-1.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 peer-hover/menu-button:text-sidebar-accent-foreground [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 after:md:hidden\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        showOnHover &&\n          \"group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 peer-data-[active=true]/menu-button:text-sidebar-accent-foreground md:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarMenuAction.displayName = \"SidebarMenuAction\"\n\nconst SidebarMenuBadge = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    data-sidebar=\"menu-badge\"\n    className={cn(\n      \"pointer-events-none absolute right-1 flex h-5 min-w-5 select-none items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums text-sidebar-foreground\",\n      \"peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground\",\n      \"peer-data-[size=sm]/menu-button:top-1\",\n      \"peer-data-[size=default]/menu-button:top-1.5\",\n      \"peer-data-[size=lg]/menu-button:top-2.5\",\n      \"group-data-[collapsible=icon]:hidden\",\n      className\n    )}\n    {...props}\n  />\n))\nSidebarMenuBadge.displayName = \"SidebarMenuBadge\"\n\nconst SidebarMenuSkeleton = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    showIcon?: boolean\n  }\n>(({ className, showIcon = false, ...props }, ref) => {\n  // Random width between 50 to 90%.\n  const width = React.useMemo(() => {\n    return `${Math.floor(Math.random() * 40) + 50}%`\n  }, [])\n\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"menu-skeleton\"\n      className={cn(\"flex h-8 items-center gap-2 rounded-md px-2\", className)}\n      {...props}\n    >\n      {showIcon && (\n        <Skeleton\n          className=\"size-4 rounded-md\"\n          data-sidebar=\"menu-skeleton-icon\"\n        />\n      )}\n      <Skeleton\n        className=\"h-4 max-w-[--skeleton-width] flex-1\"\n        data-sidebar=\"menu-skeleton-text\"\n        style={\n          {\n            \"--skeleton-width\": width,\n          } as React.CSSProperties\n        }\n      />\n    </div>\n  )\n})\nSidebarMenuSkeleton.displayName = \"SidebarMenuSkeleton\"\n\nconst SidebarMenuSub = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    data-sidebar=\"menu-sub\"\n    className={cn(\n      \"mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l border-sidebar-border px-2.5 py-0.5\",\n      \"group-data-[collapsible=icon]:hidden\",\n      className\n    )}\n    {...props}\n  />\n))\nSidebarMenuSub.displayName = \"SidebarMenuSub\"\n\nconst SidebarMenuSubItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ ...props }, ref) => <li ref={ref} {...props} />)\nSidebarMenuSubItem.displayName = \"SidebarMenuSubItem\"\n\nconst SidebarMenuSubButton = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentProps<\"a\"> & {\n    asChild?: boolean\n    size?: \"sm\" | \"md\"\n    isActive?: boolean\n  }\n>(({ asChild = false, size = \"md\", isActive, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"menu-sub-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(\n        \"flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 text-sidebar-foreground outline-none ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 [&>svg]:text-sidebar-accent-foreground\",\n        \"data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground\",\n        size === \"sm\" && \"text-xs\",\n        size === \"md\" && \"text-sm\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarMenuSubButton.displayName = \"SidebarMenuSubButton\"\n\nexport {\n  Sidebar,\n  SidebarContent,\n  SidebarFooter,\n  SidebarGroup,\n  SidebarGroupAction,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarHeader,\n  SidebarInput,\n  SidebarInset,\n  SidebarMenu,\n  SidebarMenuAction,\n  SidebarMenuBadge,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarMenuSkeleton,\n  SidebarMenuSub,\n  SidebarMenuSubButton,\n  SidebarMenuSubItem,\n  SidebarProvider,\n  SidebarRail,\n  SidebarSeparator,\n  SidebarTrigger,\n  useSidebar,\n}\n","size_bytes":23567},"client/src/pages/not-found.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { AlertCircle } from \"lucide-react\";\n\nexport default function NotFound() {\n  return (\n    <div className=\"min-h-screen w-full flex items-center justify-center bg-gray-50\">\n      <Card className=\"w-full max-w-md mx-4\">\n        <CardContent className=\"pt-6\">\n          <div className=\"flex mb-4 gap-2\">\n            <AlertCircle className=\"h-8 w-8 text-red-500\" />\n            <h1 className=\"text-2xl font-bold text-gray-900\">404 Page Not Found</h1>\n          </div>\n\n          <p className=\"mt-4 text-sm text-gray-600\">\n            Did you forget to add the page to the router?\n          </p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":711},"client/src/components/mobile/ReportsMobile.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { BarChart3, TrendingUp, Clock, Target, Users, Download, RefreshCw } from \"lucide-react\";\n\ninterface ReportsMobileProps {\n  customerId: string;\n}\n\nexport default function ReportsMobile({ customerId }: ReportsMobileProps) {\n  const [period, setPeriod] = useState(\"mes\");\n  const [lastUpdate, setLastUpdate] = useState(new Date());\n\n  const { data: metrics, isLoading, refetch } = useQuery({\n    queryKey: [\"/api/customers\", customerId, \"reports/metrics\"],\n    enabled: !!customerId,\n  });\n\n  const handleRefresh = () => {\n    refetch();\n    setLastUpdate(new Date());\n  };\n\n  const reportMetrics = [\n    { \n      title: \"Taxa de Conclusão\", \n      value: `${(metrics as any)?.completionRate || 0}%`, \n      icon: Target,\n      color: \"text-green-600\",\n      bg: \"bg-green-50\",\n      trend: \"+5%\"\n    },\n    { \n      title: \"Tempo Médio\", \n      value: `${(metrics as any)?.avgTime || 0}h`, \n      icon: Clock,\n      color: \"text-blue-600\",\n      bg: \"bg-blue-50\",\n      trend: \"-2h\"\n    },\n    { \n      title: \"Conformidade SLA\", \n      value: `${(metrics as any)?.slaCompliance || 0}%`, \n      icon: TrendingUp,\n      color: \"text-purple-600\",\n      bg: \"bg-purple-50\",\n      trend: \"+8%\"\n    },\n    { \n      title: \"Operadores Ativos\", \n      value: (metrics as any)?.activeOperators || 0, \n      icon: Users,\n      color: \"text-orange-600\",\n      bg: \"bg-orange-50\",\n      trend: \"+2\"\n    },\n  ];\n\n  const reportTypes = [\n    { title: \"Ordens de Serviço\", description: \"Análise de OS por status, prioridade e tipo\", icon: BarChart3, color: \"text-blue-600\" },\n    { title: \"Performance SLA\", description: \"Conformidade e tempo de resposta\", icon: Target, color: \"text-green-600\" },\n    { title: \"Produtividade\", description: \"Análise de tempo e eficiência\", icon: TrendingUp, color: \"text-purple-600\" },\n    { title: \"Operadores\", description: \"Desempenho por operador\", icon: Users, color: \"text-orange-600\" },\n  ];\n\n  if (isLoading) {\n    return (\n      <div className=\"p-4 space-y-4\">\n        <div className=\"animate-pulse space-y-3\">\n          {[1,2,3].map(i => (\n            <div key={i} className=\"h-20 bg-gray-200 rounded-lg\"></div>\n          ))}\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gray-50 pb-20\">\n      {/* Header */}\n      <div className=\"bg-white border-b p-4 space-y-3 sticky top-0 z-10\">\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <h2 className=\"text-lg font-semibold\">Relatórios</h2>\n            <p className=\"text-sm text-gray-600\" data-testid=\"text-last-update-reports\">\n              Atualizado: {lastUpdate.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}\n            </p>\n          </div>\n          <Button variant=\"ghost\" size=\"sm\" onClick={handleRefresh} data-testid=\"button-refresh-reports\">\n            <RefreshCw className=\"w-4 h-4\" />\n          </Button>\n        </div>\n\n        {/* Filtro de Período */}\n        <Select value={period} onValueChange={setPeriod}>\n          <SelectTrigger className=\"w-full\" data-testid=\"select-period-filter\">\n            <SelectValue placeholder=\"Período\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"hoje\" data-testid=\"select-item-period-hoje\">Hoje</SelectItem>\n            <SelectItem value=\"semana\" data-testid=\"select-item-period-semana\">Esta Semana</SelectItem>\n            <SelectItem value=\"mes\" data-testid=\"select-item-period-mes\">Este Mês</SelectItem>\n            <SelectItem value=\"ano\" data-testid=\"select-item-period-ano\">Este Ano</SelectItem>\n          </SelectContent>\n        </Select>\n      </div>\n\n      {/* Métricas */}\n      <div className=\"p-4 grid grid-cols-2 gap-3\">\n        {reportMetrics.map((metric) => (\n          <Card key={metric.title} className=\"border-0 shadow-sm\" data-testid={`card-metric-${metric.title.toLowerCase().replace(/\\s+/g, '-')}`}>\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-start justify-between mb-2\">\n                <div className={`w-10 h-10 ${metric.bg} rounded-lg flex items-center justify-center`}>\n                  <metric.icon className={`w-5 h-5 ${metric.color}`} />\n                </div>\n                <span className=\"text-xs font-semibold text-green-600\" data-testid={`text-trend-${metric.title.toLowerCase().replace(/\\s+/g, '-')}`}>\n                  {metric.trend}\n                </span>\n              </div>\n              <p className=\"text-2xl font-bold text-gray-900\" data-testid={`text-value-${metric.title.toLowerCase().replace(/\\s+/g, '-')}`}>\n                {metric.value}\n              </p>\n              <p className=\"text-xs text-gray-600 mt-1\">{metric.title}</p>\n            </CardContent>\n          </Card>\n        ))}\n      </div>\n\n      {/* Tipos de Relatórios */}\n      <div className=\"p-4 space-y-3\">\n        <h3 className=\"text-sm font-semibold text-gray-700 mb-3\">Relatórios Disponíveis</h3>\n        \n        {reportTypes.map((report) => (\n          <Card key={report.title} className=\"hover:shadow-md transition-shadow\" data-testid={`card-report-${report.title.toLowerCase().replace(/\\s+/g, '-')}`}>\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-start justify-between\">\n                <div className=\"flex items-start gap-3 flex-1\">\n                  <div className=\"w-12 h-12 bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl flex items-center justify-center shrink-0\">\n                    <report.icon className={`w-6 h-6 ${report.color}`} />\n                  </div>\n                  <div className=\"flex-1\">\n                    <p className=\"font-semibold text-gray-900\" data-testid={`text-report-title-${report.title.toLowerCase().replace(/\\s+/g, '-')}`}>\n                      {report.title}\n                    </p>\n                    <p className=\"text-sm text-gray-600 mt-1\">{report.description}</p>\n                  </div>\n                </div>\n                <Button variant=\"ghost\" size=\"sm\" className=\"shrink-0\" data-testid={`button-download-${report.title.toLowerCase().replace(/\\s+/g, '-')}`} disabled>\n                  <Download className=\"w-4 h-4\" />\n                </Button>\n              </div>\n            </CardContent>\n          </Card>\n        ))}\n      </div>\n\n      {/* Export Section */}\n      <div className=\"p-4\">\n        <Card className=\"bg-gradient-to-br from-blue-500 to-indigo-600 border-0 shadow-lg\">\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center justify-between\">\n              <div className=\"text-white\">\n                <p className=\"font-semibold mb-1\">Exportar Relatórios</p>\n                <p className=\"text-sm text-white/80\">Baixe relatórios completos em PDF ou Excel</p>\n              </div>\n              <Button size=\"sm\" className=\"bg-white text-blue-600 hover:bg-gray-100\" data-testid=\"button-export-all\" disabled>\n                <Download className=\"w-4 h-4 mr-2\" />\n                Exportar\n              </Button>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","size_bytes":7409},"client/src/pages/login.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { login, setAuthState } from \"@/lib/auth\";\nimport { useIsMobile } from \"@/hooks/use-mobile\";\nimport { User, Lock, Eye, EyeOff } from \"lucide-react\";\nimport opusLogo from \"@assets/ChatGPT Image 8 de set. de 2025, 18_10_10_1757366528566.png\";\n\nexport default function Login() {\n  const [, setLocation] = useLocation();\n  const [isLoading, setIsLoading] = useState(false);\n  const [showPassword, setShowPassword] = useState(false);\n  const [credentials, setCredentials] = useState({\n    username: \"\",\n    password: \"\"\n  });\n  const { toast } = useToast();\n  const isMobile = useIsMobile();\n\n  // Redirecionar automaticamente para versão móvel se detectar dispositivo móvel\n  useEffect(() => {\n    if (isMobile) {\n      setLocation(\"/login-mobile\");\n    }\n  }, [isMobile, setLocation]);\n\n  const handleLogin = async (e: React.FormEvent) => {\n    e.preventDefault();\n    setIsLoading(true);\n\n    try {\n      const { user, token } = await login(credentials);\n      setAuthState(user, token);\n      \n      toast({\n        title: \"Login realizado com sucesso\",\n        description: `Bem-vindo, ${user.name}!`,\n      });\n      \n      // Aguardar para garantir que o estado foi salvo no localStorage\n      await new Promise(resolve => setTimeout(resolve, 500));\n      \n      // Check available modules for the user\n      try {\n        const modulesResponse = await fetch(\"/api/auth/user-modules\", {\n          headers: {\n            \"Authorization\": `Bearer ${token}`,\n          },\n        });\n        const modulesData = await modulesResponse.json();\n        const availableModules = modulesData.modules || [];\n        \n        // If user has access to multiple modules, show module selection\n        if (availableModules.length > 1) {\n          setLocation(\"/module-selection\");\n          return;\n        }\n      } catch (error) {\n        console.error(\"Error checking available modules:\", error);\n        // Continue with normal flow if module check fails\n      }\n      \n      // Redirecionar baseado no role do usuário usando wouter\n      if (user.role === 'operador') {\n        setLocation(\"/mobile\");\n      } else {\n        setLocation(\"/\");\n      }\n    } catch (error) {\n      toast({\n        title: \"Erro no login\",\n        description: \"Verifique suas credenciais e tente novamente.\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen w-full bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 flex items-center justify-center p-2 sm:p-4 overflow-x-hidden\">\n      {/* Container principal */}\n      <div className=\"w-full max-w-5xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-0 bg-white rounded-2xl shadow-2xl overflow-hidden min-h-[500px]\">\n        \n        {/* Lado esquerdo - Hero Section */}\n        <div className=\"relative bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900 p-4 lg:p-8 flex flex-col justify-center items-center text-white overflow-hidden\">\n          {/* Background pattern */}\n          <div className=\"absolute inset-0 opacity-10\">\n            <svg className=\"w-full h-full\" viewBox=\"0 0 100 100\" xmlns=\"http://www.w3.org/2000/svg\">\n              <defs>\n                <pattern id=\"grid\" width=\"10\" height=\"10\" patternUnits=\"userSpaceOnUse\">\n                  <path d=\"M 10 0 L 0 0 0 10\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"0.5\"/>\n                </pattern>\n              </defs>\n              <rect width=\"100\" height=\"100\" fill=\"url(#grid)\" />\n            </svg>\n          </div>\n          \n          {/* Content */}\n          <div className=\"relative z-10 text-center space-y-4\">\n            {/* Logo */}\n            <div className=\"mb-6\">\n              <div className=\"w-32 h-32 mx-auto bg-white/95 rounded-2xl p-4 shadow-xl\">\n                <img \n                  src={opusLogo} \n                  alt=\"OPUS\" \n                  className=\"w-full h-full object-contain\"\n                />\n              </div>\n            </div>\n            \n            {/* Hero Text */}\n            <div className=\"space-y-3\">\n              <p className=\"text-lg text-slate-300 max-w-sm mx-auto leading-relaxed\">\n                Plataforma inteligente para gestão completa de facilities e infraestrutura corporativa\n              </p>\n            </div>\n            \n            {/* Features */}\n            <div className=\"grid grid-cols-1 gap-3 mt-6 text-left max-w-sm mx-auto\">\n              <div className=\"flex items-center space-x-3\">\n                <div className=\"w-2 h-2 bg-blue-400 rounded-full\"></div>\n                <span className=\"text-sm text-slate-300\">Gestão em tempo real</span>\n              </div>\n              <div className=\"flex items-center space-x-3\">\n                <div className=\"w-2 h-2 bg-blue-400 rounded-full\"></div>\n                <span className=\"text-sm text-slate-300\">Relatórios inteligentes</span>\n              </div>\n              <div className=\"flex items-center space-x-3\">\n                <div className=\"w-2 h-2 bg-blue-400 rounded-full\"></div>\n                <span className=\"text-sm text-slate-300\">Controle multi-site</span>\n              </div>\n            </div>\n          </div>\n          \n          {/* Decorative elements */}\n          <div className=\"absolute top-10 right-10 w-32 h-32 bg-blue-500/20 rounded-full blur-2xl\"></div>\n          <div className=\"absolute bottom-10 left-10 w-24 h-24 bg-indigo-500/20 rounded-full blur-2xl\"></div>\n        </div>\n\n        {/* Lado direito - Login Form */}\n        <div className=\"p-6 lg:p-8 flex flex-col justify-center\">\n          <div className=\"w-full max-w-sm mx-auto space-y-6\">\n            \n            {/* Header */}\n            <div className=\"text-center space-y-1\">\n              <h2 className=\"text-2xl font-bold text-slate-900\">Entrar</h2>\n              <p className=\"text-sm text-slate-600\">Acesse sua conta para continuar</p>\n            </div>\n\n            {/* Login Form */}\n            <Card className=\"border-0 shadow-none\">\n              <CardContent className=\"p-0\">\n                <form onSubmit={handleLogin} className=\"space-y-4\">\n                  \n                  {/* Username Field */}\n                  <div className=\"space-y-2\">\n                    <label htmlFor=\"username\" className=\"text-sm font-medium text-slate-900\">\n                      Usuário\n                    </label>\n                    <div className=\"relative\">\n                      <User className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-slate-400\" />\n                      <Input\n                        id=\"username\"\n                        data-testid=\"input-username\"\n                        type=\"text\"\n                        placeholder=\"Digite seu usuário\"\n                        value={credentials.username}\n                        onChange={(e) => setCredentials(prev => ({ ...prev, username: e.target.value }))}\n                        className=\"pl-11 h-10 border-slate-200 focus:border-blue-500 focus:ring-blue-500 bg-slate-50 focus:bg-white transition-all duration-200\"\n                        required\n                      />\n                    </div>\n                  </div>\n\n                  {/* Password Field */}\n                  <div className=\"space-y-2\">\n                    <label htmlFor=\"password\" className=\"text-sm font-medium text-slate-900\">\n                      Senha\n                    </label>\n                    <div className=\"relative\">\n                      <Lock className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-slate-400\" />\n                      <Input\n                        id=\"password\"\n                        data-testid=\"input-password\"\n                        type={showPassword ? \"text\" : \"password\"}\n                        placeholder=\"Digite sua senha\"\n                        value={credentials.password}\n                        onChange={(e) => setCredentials(prev => ({ ...prev, password: e.target.value }))}\n                        className=\"pl-11 pr-11 h-10 border-slate-200 focus:border-blue-500 focus:ring-blue-500 bg-slate-50 focus:bg-white transition-all duration-200\"\n                        required\n                      />\n                      <button\n                        type=\"button\"\n                        onClick={() => setShowPassword(!showPassword)}\n                        className=\"absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-slate-600 transition-colors\"\n                        tabIndex={-1}\n                      >\n                        {showPassword ? <EyeOff className=\"h-5 w-5\" /> : <Eye className=\"h-5 w-5\" />}\n                      </button>\n                    </div>\n                  </div>\n\n                  {/* Remember me & Forgot password */}\n                  <div className=\"flex items-center justify-between\">\n                    <label className=\"flex items-center space-x-2 cursor-pointer\">\n                      <input type=\"checkbox\" className=\"rounded border-slate-300 text-blue-600 focus:ring-blue-500\" />\n                      <span className=\"text-sm text-slate-600\">Lembrar-me</span>\n                    </label>\n                    <a href=\"#\" className=\"text-sm text-blue-600 hover:text-blue-800 font-medium\">\n                      Esqueceu a senha?\n                    </a>\n                  </div>\n\n                  {/* Login Button */}\n                  <Button \n                    type=\"submit\" \n                    data-testid=\"button-login\"\n                    className=\"w-full h-10 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-semibold rounded-lg shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all duration-200\" \n                    disabled={isLoading}\n                  >\n                    {isLoading ? (\n                      <div className=\"flex items-center space-x-2\">\n                        <div className=\"w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin\"></div>\n                        <span>Entrando...</span>\n                      </div>\n                    ) : (\n                      \"Entrar\"\n                    )}\n                  </Button>\n\n                </form>\n              </CardContent>\n            </Card>\n\n            {/* Footer */}\n            <div className=\"text-center space-y-4\">\n              <div className=\"relative\">\n                <div className=\"absolute inset-0 flex items-center\">\n                  <div className=\"w-full border-t border-slate-200\"></div>\n                </div>\n                <div className=\"relative flex justify-center text-sm\">\n                  <span className=\"px-4 bg-white text-slate-500\">Precisa de ajuda?</span>\n                </div>\n              </div>\n              \n              <p className=\"text-xs text-slate-500\">\n                © 2025 OPUS. Todos os direitos reservados.\n              </p>\n            </div>\n\n          </div>\n        </div>\n\n      </div>\n    </div>\n  );\n}","size_bytes":11303},"client/src/components/site-map.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport React, { useState } from \"react\";\nimport { \n  Building, \n  MapPin, \n  Users, \n  Ruler,\n  Activity,\n  Eye,\n  Edit3,\n  Save,\n  X,\n  Palette,\n  Move,\n  RotateCcw,\n  ZoomIn,\n  ZoomOut,\n  Maximize,\n  Grid3x3\n} from \"lucide-react\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\n\ninterface SiteMapProps {\n  companyId: string;\n}\n\nexport default function SiteMap({ companyId }: SiteMapProps) {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  \n  const { data: sites, isLoading } = useQuery({\n    queryKey: [\"/api/companies\", companyId, \"sites\"],\n    enabled: !!companyId,\n  });\n\n  const [selectedSiteId, setSelectedSiteId] = useState<string>(\"\");\n  const [allZones, setAllZones] = useState<any[]>([]);\n  const [isEditMode, setIsEditMode] = useState<boolean>(false);\n  const [editingZone, setEditingZone] = useState<any>(null);\n  const [zonePositions, setZonePositions] = useState<{[key: string]: {left: number, top: number}}>({});\n  const [zoneSizes, setZoneSizes] = useState<{[key: string]: number}>({});\n  const [zoneColors, setZoneColors] = useState<{[key: string]: string}>({});\n  const [draggingZone, setDraggingZone] = useState<string | null>(null);\n  const [dragOffset, setDragOffset] = useState<{x: number, y: number}>({x: 0, y: 0});\n  const [isDragging, setIsDragging] = useState<boolean>(false);\n  const [dragStartTime, setDragStartTime] = useState<number>(0);\n  const [dragStartPos, setDragStartPos] = useState<{x: number, y: number}>({x: 0, y: 0});\n  const [mapScale, setMapScale] = useState<number>(1);\n  const [mapOffset, setMapOffset] = useState<{x: number, y: number}>({x: 0, y: 0});\n  const [isPanning, setIsPanning] = useState<boolean>(false);\n  const [panStartPos, setPanStartPos] = useState<{x: number, y: number}>({x: 0, y: 0});\n  const [showGrid, setShowGrid] = useState<boolean>(true);\n  const [snapToGrid, setSnapToGrid] = useState<boolean>(true);\n  const [hoveredZone, setHoveredZone] = useState<string | null>(null);\n\n  const { data: zones } = useQuery({\n    queryKey: [\"/api/sites\", selectedSiteId, \"zones\"],\n    enabled: !!selectedSiteId,\n  });\n\n  // Mutation to update zone\n  const updateZoneMutation = useMutation({\n    mutationFn: async (zoneData: any) => {\n      const { id, ...updateData } = zoneData;\n      const response = await apiRequest('PATCH', `/api/zones/${id}`, updateData);\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/sites\", selectedSiteId, \"zones\"] });\n      toast({\n        title: \"Zona atualizada\",\n        description: \"As alterações foram salvas com sucesso.\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Não foi possível salvar as alterações.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Mutation to delete zone\n  const deleteZoneMutation = useMutation({\n    mutationFn: async (zoneId: string) => {\n      await apiRequest('DELETE', `/api/zones/${zoneId}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/sites\", selectedSiteId, \"zones\"] });\n      toast({\n        title: \"Zona excluída\",\n        description: \"A zona foi removida com sucesso.\",\n      });\n      setEditingZone(null);\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Não foi possível excluir a zona.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleDeleteZone = async () => {\n    if (!editingZone) return;\n    \n    if (confirm(`Deseja realmente excluir a zona \"${editingZone.name}\"? Esta ação não pode ser desfeita.`)) {\n      await deleteZoneMutation.mutateAsync(editingZone.id);\n    }\n  };\n\n  // Initialize positions and sizes when zones change\n  React.useEffect(() => {\n    if (zones) {\n      setAllZones(zones as any[]);\n      \n      // Load positions from database or set defaults\n      const loadedPositions: {[key: string]: {left: number, top: number}} = {};\n      const loadedSizes: {[key: string]: number} = {};\n      \n      (zones as any[]).forEach((zone, index) => {\n        // Use database positions if available, otherwise use defaults\n        if (zone.positionX && zone.positionY) {\n          loadedPositions[zone.id] = {\n            left: parseFloat(zone.positionX),\n            top: parseFloat(zone.positionY)\n          };\n        } else {\n          // Default positions for zones without saved positions\n          const defaultPositions = [\n            { left: 20, top: 30 },\n            { left: 70, top: 20 },\n            { left: 50, top: 70 },\n            { left: 15, top: 75 },\n            { left: 80, top: 75 }\n          ];\n          const position = defaultPositions[index] || defaultPositions[0];\n          loadedPositions[zone.id] = position;\n        }\n        \n        // Load size scale from database or use default\n        if (zone.sizeScale) {\n          loadedSizes[zone.id] = parseFloat(zone.sizeScale);\n        }\n      });\n      \n      setZonePositions(loadedPositions);\n      setZoneSizes(loadedSizes);\n    }\n  }, [zones]);\n\n  // Helper functions\n  const snapPosition = (pos: {left: number, top: number}) => {\n    if (!snapToGrid) return pos;\n    const gridSize = 5; // 5% grid\n    return {\n      left: Math.round(pos.left / gridSize) * gridSize,\n      top: Math.round(pos.top / gridSize) * gridSize\n    };\n  };\n\n  const handleZoomIn = () => {\n    setMapScale(prev => Math.min(prev * 1.25, 3));\n  };\n\n  const handleZoomOut = () => {\n    setMapScale(prev => Math.max(prev / 1.25, 0.3));\n  };\n\n  const resetView = () => {\n    setMapScale(1);\n    setMapOffset({x: 0, y: 0});\n  };\n\n  // Functions for edit mode\n  const handleZoneClick = (zone: any, e: React.MouseEvent) => {\n    if (isEditMode && !isDragging) {\n      e.stopPropagation();\n      const timeSinceStart = Date.now() - dragStartTime;\n      const moveDistance = Math.sqrt(\n        Math.pow(e.clientX - dragStartPos.x, 2) + Math.pow(e.clientY - dragStartPos.y, 2)\n      );\n      // Só abre o modal se foi um clique real (pouco movimento e tempo)\n      if (timeSinceStart < 300 && moveDistance < 10) {\n        setEditingZone(zone);\n      }\n    }\n  };\n\n  const handleSaveZone = async () => {\n    if (!editingZone) return;\n    \n    try {\n      const updatedZone = {\n        id: editingZone.id,\n        name: editingZone.name,\n        description: editingZone.description,\n        areaM2: editingZone.areaM2?.toString(),\n        category: editingZone.category,\n        siteId: editingZone.siteId,\n        isActive: editingZone.isActive\n      };\n      \n      await updateZoneMutation.mutateAsync(updatedZone);\n      setEditingZone(null);\n    } catch (error) {\n      console.error('Erro ao salvar zona:', error);\n      toast({\n        title: \"Erro\",\n        description: \"Não foi possível salvar as alterações. Tente novamente.\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const handleMouseDown = (e: React.MouseEvent, zoneId: string) => {\n    if (!isEditMode) return;\n    e.preventDefault();\n    e.stopPropagation();\n    \n    setDragStartTime(Date.now());\n    setDragStartPos({ x: e.clientX, y: e.clientY });\n    setIsDragging(false);\n    setDraggingZone(zoneId);\n    \n    // Simplified visual feedback\n    const zoneElement = e.target as HTMLElement;\n    zoneElement.style.zIndex = '1000';\n    zoneElement.style.transform = 'scale(1.02)';\n    zoneElement.style.transition = 'none';\n    zoneElement.style.cursor = 'grabbing';\n  };\n\n  const handleMouseMove = (e: React.MouseEvent) => {\n    if (isPanning) {\n      const deltaX = e.clientX - panStartPos.x;\n      const deltaY = e.clientY - panStartPos.y;\n      setMapOffset(prev => ({\n        x: prev.x + deltaX,\n        y: prev.y + deltaY\n      }));\n      setPanStartPos({ x: e.clientX, y: e.clientY });\n      return;\n    }\n    \n    if (!draggingZone || !isEditMode) return;\n    \n    // Ultra-responsive drag detection\n    setIsDragging(true);\n    e.preventDefault();\n    \n    const rect = (e.currentTarget as HTMLElement).getBoundingClientRect();\n    const x = ((e.clientX - rect.left) / rect.width) * 100;\n    const y = ((e.clientY - rect.top) / rect.height) * 100;\n    \n    let newPosition = { \n      left: Math.max(2, Math.min(98, x)), \n      top: Math.max(2, Math.min(98, y)) \n    };\n    \n    // Apply snap to grid\n    if (snapToGrid) {\n      newPosition = snapPosition(newPosition);\n    }\n    \n    setZonePositions(prev => ({\n      ...prev,\n      [draggingZone]: newPosition\n    }));\n  };\n\n  const handleMouseUp = () => {\n    if (isPanning) {\n      setIsPanning(false);\n      return;\n    }\n    \n    // Save position and size to database when dragging ends\n    if (draggingZone && isDragging) {\n      const zone = allZones.find(z => z.id === draggingZone);\n      const position = zonePositions[draggingZone];\n      const currentSize = zoneSizes[draggingZone];\n      \n      if (zone && position) {\n        updateZoneMutation.mutate({\n          id: zone.id,\n          name: zone.name,\n          description: zone.description,\n          areaM2: zone.areaM2?.toString(),\n          category: zone.category,\n          siteId: zone.siteId,\n          isActive: zone.isActive,\n          positionX: position.left.toFixed(2),\n          positionY: position.top.toFixed(2),\n          sizeScale: currentSize ? (currentSize / 100).toFixed(2) : \"1.00\",\n        });\n      }\n    }\n    \n    // Remove visual feedback immediately\n    if (draggingZone) {\n      const zoneElement = document.querySelector(`[data-zone-id=\"${draggingZone}\"]`) as HTMLElement;\n      if (zoneElement) {\n        zoneElement.style.zIndex = '';\n        zoneElement.style.transform = '';\n        zoneElement.style.cursor = '';\n        zoneElement.style.transition = 'all 0.15s ease';\n      }\n    }\n    \n    // Reset immediately for better responsiveness\n    setDraggingZone(null);\n    setDragOffset({ x: 0, y: 0 });\n    setIsDragging(false);\n  };\n\n  // Pan functionality\n  const handleMapMouseDown = (e: React.MouseEvent) => {\n    if (e.button === 1 || (e.button === 0 && e.ctrlKey)) { // Middle click or Ctrl+click\n      e.preventDefault();\n      setIsPanning(true);\n      setPanStartPos({ x: e.clientX, y: e.clientY });\n    }\n  };\n\n  // Add global mouse and wheel events\n  React.useEffect(() => {\n    const handleGlobalMouseUp = () => {\n      if (draggingZone) {\n        const zoneElement = document.querySelector(`[data-zone-id=\"${draggingZone}\"]`) as HTMLElement;\n        if (zoneElement) {\n          zoneElement.style.zIndex = '';\n          zoneElement.style.transform = '';\n          zoneElement.style.cursor = '';\n          zoneElement.style.transition = 'all 0.15s ease';\n        }\n      }\n      \n      setDraggingZone(null);\n      setDragOffset({ x: 0, y: 0 });\n      setIsDragging(false);\n      setIsPanning(false);\n    };\n    \n    const handleGlobalMouseMove = (e: MouseEvent) => {\n      if (isPanning) {\n        const deltaX = e.clientX - panStartPos.x;\n        const deltaY = e.clientY - panStartPos.y;\n        setMapOffset(prev => ({\n          x: prev.x + deltaX,\n          y: prev.y + deltaY\n        }));\n        setPanStartPos({ x: e.clientX, y: e.clientY });\n      }\n    };\n\n    const handleWheel = (e: WheelEvent) => {\n      if (isEditMode && e.ctrlKey) {\n        e.preventDefault();\n        const delta = e.deltaY > 0 ? -1 : 1;\n        if (delta > 0) {\n          handleZoomIn();\n        } else {\n          handleZoomOut();\n        }\n      }\n    };\n    \n    if (draggingZone || isPanning) {\n      document.addEventListener('mouseup', handleGlobalMouseUp);\n      document.addEventListener('mousemove', handleGlobalMouseMove);\n    }\n\n    if (isEditMode) {\n      document.addEventListener('wheel', handleWheel, { passive: false });\n    }\n    \n    return () => {\n      document.removeEventListener('mouseup', handleGlobalMouseUp);\n      document.removeEventListener('mousemove', handleGlobalMouseMove);\n      document.removeEventListener('wheel', handleWheel);\n    };\n  }, [draggingZone, isPanning, panStartPos, isEditMode]);\n\n  const resetPositions = () => {\n    const positions = [\n      { left: 20, top: 30 },\n      { left: 70, top: 20 },\n      { left: 50, top: 70 },\n      { left: 15, top: 75 },\n      { left: 80, top: 75 }\n    ];\n    \n    const resetPositions: {[key: string]: {left: number, top: number}} = {};\n    allZones.forEach((zone, index) => {\n      const position = positions[index] || positions[0];\n      resetPositions[zone.id] = snapToGrid ? snapPosition(position) : position;\n    });\n    setZonePositions(resetPositions);\n  };\n\n  // Keyboard shortcuts\n  React.useEffect(() => {\n    const handleKeyDown = (e: KeyboardEvent) => {\n      if (e.key === 'Escape') {\n        setEditingZone(null);\n        setDraggingZone(null);\n        setIsDragging(false);\n      } else if (e.key === 'g' && e.ctrlKey) {\n        e.preventDefault();\n        setShowGrid(!showGrid);\n      } else if (e.key === 's' && e.ctrlKey) {\n        e.preventDefault();\n        setSnapToGrid(!snapToGrid);\n      } else if (e.key === '=' && e.ctrlKey) {\n        e.preventDefault();\n        handleZoomIn();\n      } else if (e.key === '-' && e.ctrlKey) {\n        e.preventDefault();\n        handleZoomOut();\n      } else if (e.key === '0' && e.ctrlKey) {\n        e.preventDefault();\n        resetView();\n      }\n    };\n    \n    if (isEditMode) {\n      document.addEventListener('keydown', handleKeyDown);\n      return () => document.removeEventListener('keydown', handleKeyDown);\n    }\n  }, [isEditMode, showGrid, snapToGrid]);\n\n  // Get zones for the first site by default\n  React.useEffect(() => {\n    if (sites && (sites as any[]).length > 0 && !selectedSiteId) {\n      setSelectedSiteId((sites as any[])[0].id);\n    }\n  }, [sites]);\n\n  const selectedSite = (sites as any[] || []).find((site: any) => site.id === selectedSiteId);\n\n  if (isLoading) {\n    return (\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"text-lg font-semibold text-foreground\">Mapa de Metragem dos Locais</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"text-center py-8\">\n            <p className=\"text-muted-foreground\">Carregando locais...</p>\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  return (\n    <Card>\n      <CardHeader>\n        <CardTitle className=\"flex items-center gap-2 justify-between text-lg font-semibold text-foreground\">\n          <div className=\"flex items-center gap-2\">\n            <Building className=\"w-5 h-5\" />\n            Mapa de Metragem dos Locais\n          </div>\n          <div className=\"flex items-center gap-2\">\n            <Button \n              variant={isEditMode ? \"destructive\" : \"outline\"} \n              size=\"sm\" \n              onClick={() => setIsEditMode(!isEditMode)}\n              data-testid=\"button-edit-mode\"\n            >\n              {isEditMode ? (\n                <>\n                  <X className=\"w-4 h-4 mr-1\" />\n                  Sair da Edição\n                </>\n              ) : (\n                <>\n                  <Edit3 className=\"w-4 h-4 mr-1\" />\n                  Editar Mapa\n                </>\n              )}\n            </Button>\n            {isEditMode && (\n              <Button \n                variant=\"outline\" \n                size=\"sm\" \n                onClick={resetPositions}\n                data-testid=\"button-reset-positions\"\n              >\n                <RotateCcw className=\"w-4 h-4 mr-1\" />\n                Resetar\n              </Button>\n            )}\n          </div>\n        </CardTitle>\n      </CardHeader>\n      <CardContent>\n        {/* Site selector */}\n        {sites && (sites as any[]).length > 0 && (\n          <div className=\"mb-6\">\n            <Select value={selectedSiteId} onValueChange={setSelectedSiteId}>\n              <SelectTrigger className=\"w-48\">\n                <SelectValue placeholder=\"Selecione um local\" />\n              </SelectTrigger>\n              <SelectContent>\n                {(sites as any[]).map((site: any) => (\n                  <SelectItem key={site.id} value={site.id}>\n                    {site.name}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n        )}\n\n        {!sites || (sites as any[]).length === 0 ? (\n          <div className=\"text-center py-8\">\n            <Building className=\"w-12 h-12 text-muted-foreground mx-auto mb-4\" />\n            <p className=\"text-muted-foreground\">Nenhum local cadastrado</p>\n            <p className=\"text-sm text-muted-foreground mt-2\">\n              Cadastre locais para visualizar o mapa de metragem\n            </p>\n          </div>\n        ) : !zones || (zones as any[]).length === 0 ? (\n          <div className=\"text-center py-8\">\n            <Ruler className=\"w-12 h-12 text-muted-foreground mx-auto mb-4\" />\n            <p className=\"text-muted-foreground\">Nenhuma zona cadastrada</p>\n            <p className=\"text-sm text-muted-foreground mt-2\">\n              {selectedSite ? `Cadastre zonas para ${selectedSite.name}` : 'Selecione um local'}\n            </p>\n          </div>\n        ) : (\n          <div>\n            {/* Edit mode controls */}\n            {isEditMode && (\n              <div className=\"mb-4 space-y-4\">\n                <div className=\"p-4 bg-amber-50 border border-amber-200 rounded-lg\">\n                  <div className=\"flex items-center gap-2 mb-2\">\n                    <Palette className=\"w-4 h-4 text-amber-600\" />\n                    <span className=\"text-sm font-medium text-amber-800\">\n                      Modo de Edição Ativo {isDragging && \"- Arrastando...\"} {isPanning && \"- Movendo Visualização...\"}\n                    </span>\n                  </div>\n                  <p className=\"text-xs text-amber-700\">\n                    • <strong>Clique rápido</strong> na zona para editar<br/>\n                    • <strong>Arraste</strong> para reposicionar<br/>\n                    • <strong>Ctrl+Clique</strong> para mover visualização<br/>\n                    • <strong>Atalhos:</strong> Ctrl+G (grade), Ctrl+S (ajustar), Ctrl +/- (zoom), ESC (cancelar)\n                  </p>\n                </div>\n                \n                {/* Advanced Controls */}\n                <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                  {/* Zoom Controls */}\n                  <div className=\"flex items-center justify-between p-3 bg-background border rounded-lg\">\n                    <div className=\"flex items-center gap-2\">\n                      <ZoomIn className=\"w-4 h-4 text-muted-foreground\" />\n                      <span className=\"text-sm font-medium\">Zoom</span>\n                    </div>\n                    <div className=\"flex items-center gap-1\">\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={handleZoomOut}\n                        className=\"h-8 w-8 p-0\"\n                      >\n                        <ZoomOut className=\"w-3 h-3\" />\n                      </Button>\n                      <span className=\"text-sm text-muted-foreground min-w-[3rem] text-center\">\n                        {Math.round(mapScale * 100)}%\n                      </span>\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={handleZoomIn}\n                        className=\"h-8 w-8 p-0\"\n                      >\n                        <ZoomIn className=\"w-3 h-3\" />\n                      </Button>\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={resetView}\n                        className=\"h-8 w-8 p-0\"\n                      >\n                        <Maximize className=\"w-3 h-3\" />\n                      </Button>\n                    </div>\n                  </div>\n\n                  {/* Grid Controls */}\n                  <div className=\"flex items-center justify-between p-3 bg-background border rounded-lg\">\n                    <div className=\"flex items-center gap-2\">\n                      <Grid3x3 className=\"w-4 h-4 text-muted-foreground\" />\n                      <span className=\"text-sm font-medium\">Grade</span>\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      <Button\n                        variant={showGrid ? \"default\" : \"outline\"}\n                        size=\"sm\"\n                        onClick={() => setShowGrid(!showGrid)}\n                        className=\"h-8 text-xs\"\n                      >\n                        {showGrid ? \"Ocultar\" : \"Mostrar\"}\n                      </Button>\n                      <Button\n                        variant={snapToGrid ? \"default\" : \"outline\"}\n                        size=\"sm\"\n                        onClick={() => setSnapToGrid(!snapToGrid)}\n                        className=\"h-8 text-xs\"\n                      >\n                        Ajustar\n                      </Button>\n                    </div>\n                  </div>\n\n                  {/* Reset Controls */}\n                  <div className=\"flex items-center justify-between p-3 bg-background border rounded-lg\">\n                    <div className=\"flex items-center gap-2\">\n                      <RotateCcw className=\"w-4 h-4 text-muted-foreground\" />\n                      <span className=\"text-sm font-medium\">Resetar</span>\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={resetPositions}\n                        className=\"h-8 text-xs\"\n                      >\n                        Posições\n                      </Button>\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={resetView}\n                        className=\"h-8 text-xs\"\n                      >\n                        Visualização\n                      </Button>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            )}\n\n            {/* Visual map of zones with area metrics */}\n            <div \n              className={`bg-muted/50 rounded-lg p-4 relative min-h-96 mb-6 zone-map-container overflow-hidden ${isEditMode ? 'border-2 border-dashed border-amber-300' : ''}`} \n              data-testid=\"zone-map\"\n              onMouseMove={handleMouseMove}\n              onMouseUp={handleMouseUp}\n              onMouseDown={handleMapMouseDown}\n              onContextMenu={(e) => e.preventDefault()}\n              style={{\n                cursor: isPanning ? 'grabbing' : isEditMode ? 'grab' : 'default',\n                userSelect: 'none'\n              }}\n            >\n              <div \n                className=\"absolute inset-4 bg-background border-2 border-border rounded select-none\"\n                style={{\n                  transform: `scale(${mapScale}) translate(${mapOffset.x / mapScale}px, ${mapOffset.y / mapScale}px)`,\n                  transformOrigin: 'center center',\n                  transition: isDragging || isPanning ? 'none' : 'transform 0.15s ease-out',\n                  willChange: 'transform'\n                }}\n              >\n                \n                {/* Grid overlay for snap-to-grid visualization */}\n                {isEditMode && showGrid && (\n                  <div \n                    className=\"absolute inset-0 pointer-events-none\"\n                    style={{\n                      backgroundImage: 'linear-gradient(to right, rgba(0,0,0,0.1) 1px, transparent 1px), linear-gradient(to bottom, rgba(0,0,0,0.1) 1px, transparent 1px)',\n                      backgroundSize: '5% 5%'\n                    }}\n                  />\n                )}\n                \n                {/* Drop zone indicator */}\n                {isDragging && (\n                  <div className=\"absolute inset-0 pointer-events-none bg-primary/5 border-2 border-dashed border-primary/30 rounded-lg\" />\n                )}\n                \n                {/* Site title */}\n                <div className=\"absolute top-2 left-4 text-sm font-medium text-foreground z-50\">\n                  {selectedSite?.name} - Mapa de Áreas {isEditMode && <span className=\"text-amber-600\">(Editando)</span>}\n                  {isEditMode && (\n                    <div className=\"text-xs text-muted-foreground mt-1\">\n                      Zoom: {Math.round(mapScale * 100)}% | Grade: {showGrid ? 'Ativa' : 'Inativa'} | Ajuste: {snapToGrid ? 'Ativo' : 'Inativo'}\n                    </div>\n                  )}\n                </div>\n\n                {/* Dynamic zone blocks based on actual data with proportional sizing */}\n                {(zones as any[] || []).map((zone: any, index: number) => {\n                  const area = parseFloat(zone.areaM2 || '0');\n                  const allAreas = (zones as any[] || []).map((z: any) => parseFloat(z.areaM2 || '0'));\n                  const maxArea = Math.max(...allAreas);\n                  const minArea = Math.min(...allAreas.filter(a => a > 0));\n                  \n                  // Calculate proportional size (min 80px, max 180px for better visibility)\n                  const minSize = 80;\n                  const maxSize = 180;\n                  const sizeRatio = area > 0 ? (area - minArea) / (maxArea - minArea) : 0;\n                  const calculatedSize = minSize + (sizeRatio * (maxSize - minSize));\n                  const size = Math.max(minSize, calculatedSize);\n                  \n                  // Color coding by category\n                  const getZoneColors = (category: string) => {\n                    switch (category?.toLowerCase()) {\n                      case 'banheiro':\n                        return { bg: 'bg-blue-200', border: 'border-blue-400', dot: 'bg-blue-400', text: 'text-blue-600' };\n                      case 'escritorio':\n                        return { bg: 'bg-green-200', border: 'border-green-400', dot: 'bg-green-400', text: 'text-green-600' };\n                      case 'producao':\n                        return { bg: 'bg-orange-200', border: 'border-orange-400', dot: 'bg-orange-400', text: 'text-orange-600' };\n                      default:\n                        return { bg: 'bg-gray-200', border: 'border-gray-400', dot: 'bg-gray-400', text: 'text-gray-600' };\n                    }\n                  };\n                  \n                  const colors = getZoneColors(zone.category);\n                  \n                  // Better positioning: sort by size and arrange accordingly\n                  const sortedZones = [...(zones as any[] || [])].sort((a, b) => parseFloat(b.areaM2 || '0') - parseFloat(a.areaM2 || '0'));\n                  const sortedIndex = sortedZones.findIndex(z => z.id === zone.id);\n                  \n                  // Use custom positions if available, otherwise use default positions\n                  const defaultPositions = [\n                    { left: 20, top: 30 }, // Large area - center left\n                    { left: 70, top: 20 }, // Medium area - top right  \n                    { left: 50, top: 70 }, // Small area - bottom center\n                    { left: 15, top: 75 }, // Extra position\n                    { left: 80, top: 75 }  // Extra position\n                  ];\n                  \n                  const position = zonePositions[zone.id] || defaultPositions[sortedIndex] || defaultPositions[0];\n                  const customSize = zoneSizes[zone.id] || size;\n                  \n                  const isDraggingThis = draggingZone === zone.id;\n                  const isHovered = hoveredZone === zone.id;\n                  \n                  return (\n                    <div \n                      key={zone.id}\n                      data-zone-id={zone.id}\n                      className={`absolute ${colors.bg} border-2 rounded-lg flex items-center justify-center transition-all duration-200 select-none ${\n                        isDraggingThis ? 'z-50 border-primary shadow-2xl' : isHovered ? 'z-40 border-primary/50' : `${colors.border} shadow-md`\n                      } ${\n                        isEditMode ? 'cursor-move hover:shadow-lg' : 'cursor-pointer hover:shadow-md'\n                      } ${\n                        isHovered && !isDraggingThis ? 'ring-2 ring-primary/50' : ''\n                      }`}\n                      style={{\n                        width: `${customSize}px`,\n                        height: `${customSize}px`,\n                        left: `${position.left}%`,\n                        top: `${position.top}%`,\n                        transform: `translate(-50%, -50%) ${isDraggingThis ? 'scale(1.03)' : isHovered ? 'scale(1.01)' : 'scale(1)'}`,\n                        zIndex: isDraggingThis ? 1000 : isHovered ? 100 : 10,\n                        boxShadow: isDraggingThis ? '0 8px 25px rgba(0,0,0,0.3)' : isHovered ? '0 4px 15px rgba(0,0,0,0.1)' : '',\n                        transition: isDraggingThis ? 'none' : 'all 0.15s ease'\n                      }}\n                      onMouseDown={(e) => handleMouseDown(e, zone.id)}\n                      onClick={(e) => handleZoneClick(zone, e)}\n                      onMouseEnter={() => setHoveredZone(zone.id)}\n                      onMouseLeave={() => setHoveredZone(null)}\n                      data-testid={`zone-${zone.id}`}\n                    >\n                      <div className=\"text-center p-1 relative pointer-events-none\">\n                        <div className={`w-3 h-3 ${colors.dot} rounded-full mx-auto mb-1`}></div>\n                        <span className=\"text-xs font-semibold text-foreground block leading-tight truncate\">\n                          {zone.name}\n                        </span>\n                        <span className=\"text-sm font-bold text-foreground block mt-1\">\n                          {area > 0 ? `${area}m²` : 'Sem área'}\n                        </span>\n                        {zone.category && (\n                          <span className={`text-xs ${colors.text} block mt-1 capitalize`}>\n                            {zone.category}\n                          </span>\n                        )}\n                        \n                        {/* Tooltip for edit mode */}\n                        {isEditMode && isHovered && (\n                          <div className=\"absolute -top-8 left-1/2 transform -translate-x-1/2 bg-black/75 text-white text-[10px] px-2 py-1 rounded whitespace-nowrap z-50 pointer-events-none\">\n                            Arraste para mover • Clique para editar\n                          </div>\n                        )}\n                        \n                        {/* Size controls when in edit mode */}\n                        {isEditMode && (\n                          <div className=\"absolute -top-2 -right-2 flex flex-col gap-1 pointer-events-auto\">\n                            <button\n                              className=\"w-6 h-6 bg-blue-500 text-white rounded-full text-xs font-bold hover:bg-blue-600 flex items-center justify-center transition-colors shadow-md\"\n                              onClick={(e) => {\n                                e.stopPropagation();\n                                e.preventDefault();\n                                const currentSize = zoneSizes[zone.id] || size;\n                                setZoneSizes(prev => ({\n                                  ...prev,\n                                  [zone.id]: Math.min(250, currentSize + 15)\n                                }));\n                              }}\n                              data-testid={`button-increase-${zone.id}`}\n                              title=\"Aumentar tamanho\"\n                            >\n                              +\n                            </button>\n                            <button\n                              className=\"w-6 h-6 bg-red-500 text-white rounded-full text-xs font-bold hover:bg-red-600 flex items-center justify-center transition-colors shadow-md\"\n                              onClick={(e) => {\n                                e.stopPropagation();\n                                e.preventDefault();\n                                const currentSize = zoneSizes[zone.id] || size;\n                                setZoneSizes(prev => ({\n                                  ...prev,\n                                  [zone.id]: Math.max(50, currentSize - 15)\n                                }));\n                              }}\n                              data-testid={`button-decrease-${zone.id}`}\n                              title=\"Diminuir tamanho\"\n                            >\n                              -\n                            </button>\n                          </div>\n                        )}\n                      </div>\n                    </div>\n                  );\n                })}\n\n              </div>\n            </div>\n\n            {/* Area summary */}\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4 mb-4\">\n              <div className=\"text-center p-4 bg-muted/30 rounded-lg\">\n                <div className=\"text-2xl font-bold text-foreground\">\n                  {(zones as any[] || []).reduce((total, zone) => total + parseFloat(zone.areaM2 || '0'), 0).toLocaleString()}m²\n                </div>\n                <div className=\"text-sm text-muted-foreground\">Área Total do Site</div>\n              </div>\n              <div className=\"text-center p-4 bg-muted/30 rounded-lg\">\n                <div className=\"text-2xl font-bold text-foreground\">{(zones as any[] || []).length}</div>\n                <div className=\"text-sm text-muted-foreground\">Zonas Cadastradas</div>\n              </div>\n              <div className=\"text-center p-4 bg-muted/30 rounded-lg\">\n                <div className=\"text-2xl font-bold text-foreground\">\n                  {(zones as any[] || []).filter(zone => parseFloat(zone.areaM2 || '0') > 0).length}\n                </div>\n                <div className=\"text-sm text-muted-foreground\">Com Área Definida</div>\n              </div>\n            </div>\n          </div>\n        )}\n        \n        {/* Legend */}\n        {zones && (zones as any[]).length > 0 && (\n          <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 p-4 bg-muted/30 rounded-lg\">\n            <div className=\"flex items-center space-x-2\">\n              <div className=\"w-4 h-4 bg-blue-400 rounded-full\"></div>\n              <span className=\"text-xs text-muted-foreground\">Banheiro</span>\n            </div>\n            <div className=\"flex items-center space-x-2\">\n              <div className=\"w-4 h-4 bg-green-400 rounded-full\"></div>\n              <span className=\"text-xs text-muted-foreground\">Escritório</span>\n            </div>\n            <div className=\"flex items-center space-x-2\">\n              <div className=\"w-4 h-4 bg-orange-400 rounded-full\"></div>\n              <span className=\"text-xs text-muted-foreground\">Produção</span>\n            </div>\n            <div className=\"flex items-center space-x-2\">\n              <Ruler className=\"w-4 h-4 text-muted-foreground\" />\n              <span className=\"text-xs text-muted-foreground\">Tamanho = Área</span>\n            </div>\n          </div>\n        )}\n\n        {/* Zone editing dialog */}\n        <Dialog open={!!editingZone} onOpenChange={() => setEditingZone(null)}>\n          <DialogContent className=\"sm:max-w-md\">\n            <DialogHeader>\n              <DialogTitle>Editar Zona: {editingZone?.name}</DialogTitle>\n            </DialogHeader>\n            {editingZone && (\n              <div className=\"space-y-4\">\n                <div>\n                  <Label htmlFor=\"area\">Área (m²)</Label>\n                  <Input\n                    id=\"area\"\n                    type=\"number\"\n                    value={editingZone.areaM2}\n                    onChange={(e) => setEditingZone({...editingZone, areaM2: e.target.value})}\n                    placeholder=\"Ex: 25.5\"\n                    data-testid=\"input-zone-area\"\n                  />\n                </div>\n                \n                <div>\n                  <Label htmlFor=\"category\">Categoria</Label>\n                  <Select value={editingZone.category} onValueChange={(value) => setEditingZone({...editingZone, category: value})}>\n                    <SelectTrigger data-testid=\"select-zone-category\">\n                      <SelectValue placeholder=\"Selecione uma categoria\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"banheiro\">Banheiro</SelectItem>\n                      <SelectItem value=\"escritorio\">Escritório</SelectItem>\n                      <SelectItem value=\"producao\">Produção</SelectItem>\n                      <SelectItem value=\"deposito\">Depósito</SelectItem>\n                      <SelectItem value=\"recepcao\">Recepção</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n\n                <div className=\"text-sm text-muted-foreground p-3 bg-blue-50 rounded-lg\">\n                  <p className=\"font-medium mb-1\">💡 Dica de Edição:</p>\n                  <p>Use os botões + e - que aparecem na zona para ajustar o tamanho visual, ou arraste a zona para reposicioná-la no mapa.</p>\n                </div>\n\n                <div className=\"flex justify-between pt-4\">\n                  <Button \n                    variant=\"destructive\" \n                    onClick={handleDeleteZone} \n                    disabled={deleteZoneMutation.isPending}\n                    data-testid=\"button-delete-zone\"\n                  >\n                    {deleteZoneMutation.isPending ? \"Excluindo...\" : \"Excluir Zona\"}\n                  </Button>\n                  <div className=\"flex gap-2\">\n                    <Button variant=\"outline\" onClick={() => setEditingZone(null)}>\n                      Cancelar\n                    </Button>\n                    <Button onClick={handleSaveZone} disabled={updateZoneMutation.isPending} data-testid=\"button-save-zone\">\n                      {updateZoneMutation.isPending ? \"Salvando...\" : \"Salvar\"}\n                    </Button>\n                  </div>\n                </div>\n              </div>\n            )}\n          </DialogContent>\n        </Dialog>\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":39043},"client/src/components/mobile/ScheduleMobile.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Calendar, Clock, MapPin, Plus, RefreshCw } from \"lucide-react\";\n\ninterface ScheduleMobileProps {\n  customerId: string;\n}\n\nexport default function ScheduleMobile({ customerId }: ScheduleMobileProps) {\n  const [frequencyFilter, setFrequencyFilter] = useState(\"todas\");\n  const [lastUpdate, setLastUpdate] = useState(new Date());\n\n  const { data: activities, isLoading, refetch } = useQuery({\n    queryKey: [\"/api/customers\", customerId, \"cleaning-activities\"],\n    enabled: !!customerId,\n  });\n\n  const handleRefresh = () => {\n    refetch();\n    setLastUpdate(new Date());\n  };\n\n  const filteredActivities = (activities as any[])?.filter((activity: any) => {\n    return frequencyFilter === \"todas\" || activity.frequency === frequencyFilter;\n  }) || [];\n\n  const totalDiaria = (activities as any[])?.filter((a: any) => a.frequency === 'diaria').length || 0;\n  const totalSemanal = (activities as any[])?.filter((a: any) => a.frequency === 'semanal').length || 0;\n  const totalMensal = (activities as any[])?.filter((a: any) => a.frequency === 'mensal').length || 0;\n\n  const getFrequencyBadge = (frequency: string, id?: string) => {\n    const testId = id ? `badge-frequency-${frequency}-${id}` : `badge-frequency-${frequency}`;\n    switch (frequency) {\n      case \"diaria\":\n        return <Badge className=\"bg-blue-500 text-white text-xs\" data-testid={testId}>Diária</Badge>;\n      case \"semanal\":\n        return <Badge className=\"bg-green-500 text-white text-xs\" data-testid={testId}>Semanal</Badge>;\n      case \"mensal\":\n        return <Badge className=\"bg-purple-500 text-white text-xs\" data-testid={testId}>Mensal</Badge>;\n      case \"turno\":\n        return <Badge className=\"bg-orange-500 text-white text-xs\" data-testid={testId}>Por Turno</Badge>;\n      default:\n        return <Badge className=\"bg-gray-500 text-white text-xs\" data-testid={testId}>{frequency}</Badge>;\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"p-4 space-y-4\">\n        <div className=\"animate-pulse space-y-3\">\n          {[1,2,3].map(i => (\n            <div key={i} className=\"h-24 bg-gray-200 rounded-lg\"></div>\n          ))}\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gray-50 pb-20\">\n      {/* Header */}\n      <div className=\"bg-white border-b p-4 space-y-3 sticky top-0 z-10\">\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <h2 className=\"text-lg font-semibold\">Cronograma</h2>\n            <p className=\"text-sm text-gray-600\" data-testid=\"text-last-update-schedule\">\n              Atualizado: {lastUpdate.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}\n            </p>\n          </div>\n          <div className=\"flex gap-2\">\n            <Button variant=\"ghost\" size=\"sm\" onClick={handleRefresh} data-testid=\"button-refresh-schedule\">\n              <RefreshCw className=\"w-4 h-4\" />\n            </Button>\n            <Button size=\"sm\" className=\"bg-blue-600\" data-testid=\"button-new-activity\" disabled>\n              <Plus className=\"w-4 h-4 mr-2\" />\n              Nova\n            </Button>\n          </div>\n        </div>\n\n        {/* Filtro */}\n        <Select value={frequencyFilter} onValueChange={setFrequencyFilter}>\n          <SelectTrigger className=\"w-full\" data-testid=\"select-frequency-filter\">\n            <SelectValue placeholder=\"Frequência\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"todas\" data-testid=\"select-item-frequency-todas\">Todas</SelectItem>\n            <SelectItem value=\"diaria\" data-testid=\"select-item-frequency-diaria\">Diária</SelectItem>\n            <SelectItem value=\"semanal\" data-testid=\"select-item-frequency-semanal\">Semanal</SelectItem>\n            <SelectItem value=\"mensal\" data-testid=\"select-item-frequency-mensal\">Mensal</SelectItem>\n            <SelectItem value=\"turno\" data-testid=\"select-item-frequency-turno\">Por Turno</SelectItem>\n          </SelectContent>\n        </Select>\n      </div>\n\n      {/* Stats */}\n      <div className=\"p-4 grid grid-cols-3 gap-3\">\n        <Card className=\"bg-gradient-to-br from-blue-500 to-blue-600 border-0 shadow-lg\" data-testid=\"card-stats-diaria\">\n          <CardContent className=\"p-3 text-center\">\n            <Calendar className=\"w-5 h-5 text-white mx-auto mb-1\" />\n            <p className=\"text-xl font-bold text-white\" data-testid=\"text-count-diaria\">{totalDiaria}</p>\n            <p className=\"text-xs text-white/80\">Diárias</p>\n          </CardContent>\n        </Card>\n\n        <Card className=\"bg-gradient-to-br from-green-500 to-green-600 border-0 shadow-lg\" data-testid=\"card-stats-semanal\">\n          <CardContent className=\"p-3 text-center\">\n            <Calendar className=\"w-5 h-5 text-white mx-auto mb-1\" />\n            <p className=\"text-xl font-bold text-white\" data-testid=\"text-count-semanal\">{totalSemanal}</p>\n            <p className=\"text-xs text-white/80\">Semanais</p>\n          </CardContent>\n        </Card>\n\n        <Card className=\"bg-gradient-to-br from-purple-500 to-purple-600 border-0 shadow-lg\" data-testid=\"card-stats-mensal\">\n          <CardContent className=\"p-3 text-center\">\n            <Calendar className=\"w-5 h-5 text-white mx-auto mb-1\" />\n            <p className=\"text-xl font-bold text-white\" data-testid=\"text-count-mensal\">{totalMensal}</p>\n            <p className=\"text-xs text-white/80\">Mensais</p>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Lista */}\n      <div className=\"p-4 space-y-3\">\n        <p className=\"text-sm text-gray-600 mb-3\">{filteredActivities.length} atividades programadas</p>\n        \n        {filteredActivities.length === 0 ? (\n          <Card>\n            <CardContent className=\"p-8 text-center text-gray-500\">\n              Nenhuma atividade encontrada\n            </CardContent>\n          </Card>\n        ) : (\n          filteredActivities.map((activity: any) => (\n            <Card key={activity.id} className=\"hover:shadow-md transition-shadow\" data-testid={`card-activity-${activity.id}`}>\n              <CardContent className=\"p-4\">\n                <div className=\"space-y-3\">\n                  {/* Header */}\n                  <div className=\"flex items-start justify-between\">\n                    <div className=\"flex-1\">\n                      <p className=\"font-semibold text-gray-900 mb-1\" data-testid={`text-activity-name-${activity.id}`}>\n                        {activity.name || 'Sem nome'}\n                      </p>\n                      {getFrequencyBadge(activity.frequency, activity.id)}\n                    </div>\n                  </div>\n\n                  {/* Detalhes */}\n                  <div className=\"space-y-2 text-sm\">\n                    {activity.description && (\n                      <p className=\"text-gray-600\" data-testid={`text-activity-description-${activity.id}`}>\n                        {activity.description}\n                      </p>\n                    )}\n\n                    <div className=\"flex items-center gap-2 text-gray-600\">\n                      <MapPin className=\"w-4 h-4\" />\n                      <span data-testid={`text-activity-zone-${activity.id}`}>\n                        {activity.zoneName || 'Local não especificado'}\n                      </span>\n                    </div>\n\n                    {activity.time && (\n                      <div className=\"flex items-center gap-2 text-gray-600\">\n                        <Clock className=\"w-4 h-4\" />\n                        <span data-testid={`text-activity-time-${activity.id}`}>{activity.time}</span>\n                      </div>\n                    )}\n                  </div>\n\n                  {activity.isActive ? (\n                    <Badge variant=\"outline\" className=\"bg-green-50 text-green-700 border-green-200 text-xs\" data-testid={`badge-status-active-${activity.id}`}>Ativo</Badge>\n                  ) : (\n                    <Badge variant=\"outline\" className=\"bg-gray-50 text-gray-700 border-gray-200 text-xs\" data-testid={`badge-status-inactive-${activity.id}`}>Inativo</Badge>\n                  )}\n                </div>\n              </CardContent>\n            </Card>\n          ))\n        )}\n      </div>\n    </div>\n  );\n}\n","size_bytes":8541},"client/src/pages/reports.tsx":{"content":"import Header from \"@/components/layout/header\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport { useState } from \"react\";\nimport { useClient } from \"@/contexts/ClientContext\";\nimport { useModule } from \"@/contexts/ModuleContext\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport jsPDF from \"jspdf\";\nimport autoTable from \"jspdf-autotable\";\nimport * as XLSX from \"xlsx\";\nimport { \n  Download, \n  FileText, \n  TrendingUp, \n  Clock, \n  Target,\n  Users,\n  MapPin,\n  Calendar,\n  BarChart3,\n  PieChart,\n  AlertCircle,\n  FileSpreadsheet,\n  Download as DownloadIcon,\n  RefreshCw,\n  Activity,\n  Timer,\n  CheckCircle2,\n  Building2,\n  Zap\n} from \"lucide-react\";\n\n// Types for report data\ninterface MetricsData {\n  completedWorkOrders?: number;\n  completedWorkOrdersChange?: string;\n  averageSLA?: number;\n  averageSLAChange?: string;\n  totalAreaCleaned?: number;\n  totalAreaCleanedChange?: string;\n  averageExecutionTime?: number;\n  averageExecutionTimeChange?: string;\n  period?: string;\n}\n\ninterface WorkOrderStatusData {\n  status: string;\n  label: string;\n  count: number;\n  color: string;\n}\n\ninterface SLAPerformanceData {\n  totalSLA?: number;\n  categories?: {\n    category: string;\n    label: string;\n    percentage: number;\n  }[];\n}\n\nexport default function Reports() {\n  const { activeClientId } = useClient();\n  const { currentModule } = useModule();\n  const [dateRange, setDateRange] = useState(\"30\");\n  const [selectedReportType, setSelectedReportType] = useState<string | null>(null);\n  const [isGenerating, setIsGenerating] = useState<string | null>(null);\n  const [isRefreshing, setIsRefreshing] = useState(false);\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  // API Queries with proper array-based keys\n  const { data: reportsMetrics, isLoading: isLoadingMetrics, error: errorMetrics, refetch: refetchMetrics } = useQuery({\n    queryKey: [\"/api/customers\", activeClientId, \"reports\", \"metrics\", { period: dateRange, module: currentModule }],\n    queryFn: () => fetch(`/api/customers/${activeClientId}/reports/metrics?period=${dateRange}&module=${currentModule}`).then(res => res.json()),\n    enabled: !!activeClientId,\n  });\n\n  const { data: workOrdersStatus, isLoading: isLoadingStatus, error: errorStatus, refetch: refetchStatus } = useQuery({\n    queryKey: [\"/api/customers\", activeClientId, \"reports\", \"work-orders-status\", { period: dateRange, module: currentModule }],\n    queryFn: () => fetch(`/api/customers/${activeClientId}/reports/work-orders-status?period=${dateRange}&module=${currentModule}`).then(res => res.json()),\n    enabled: !!activeClientId,\n  });\n\n  const { data: slaPerformance, isLoading: isLoadingSLA, error: errorSLA, refetch: refetchSLA } = useQuery({\n    queryKey: [\"/api/customers\", activeClientId, \"reports\", \"sla-performance\", { period: dateRange }],\n    queryFn: () => fetch(`/api/customers/${activeClientId}/reports/sla-performance?period=${dateRange}`).then(res => res.json()),\n    enabled: !!activeClientId,\n  });\n\n  // NOVAS QUERIES ESPECÍFICAS PARA CADA TIPO DE RELATÓRIO\n  const { data: generalReport, isLoading: isLoadingGeneral, refetch: refetchGeneral } = useQuery({\n    queryKey: [\"/api/customers\", activeClientId, \"reports\", \"general\", { period: dateRange }],\n    queryFn: () => fetch(`/api/customers/${activeClientId}/reports/general?period=${dateRange}`).then(res => res.json()),\n    enabled: !!activeClientId,\n  });\n\n  const { data: slaAnalysis, isLoading: isLoadingSLAAnalysis, refetch: refetchSLAAnalysis } = useQuery({\n    queryKey: [\"/api/customers\", activeClientId, \"reports\", \"sla-analysis\", { period: dateRange }],\n    queryFn: () => fetch(`/api/customers/${activeClientId}/reports/sla-analysis?period=${dateRange}`).then(res => res.json()),\n    enabled: !!activeClientId,\n  });\n\n  const { data: productivityReport, isLoading: isLoadingProductivity, refetch: refetchProductivity } = useQuery({\n    queryKey: [\"/api/customers\", activeClientId, \"reports\", \"productivity\", { period: dateRange }],\n    queryFn: () => fetch(`/api/customers/${activeClientId}/reports/productivity?period=${dateRange}`).then(res => res.json()),\n    enabled: !!activeClientId,\n  });\n\n  const { data: operatorPerformance, isLoading: isLoadingOperators, refetch: refetchOperators } = useQuery({\n    queryKey: [\"/api/customers\", activeClientId, \"reports\", \"operators\", { period: dateRange }],\n    queryFn: () => fetch(`/api/customers/${activeClientId}/reports/operators?period=${dateRange}`).then(res => res.json()),\n    enabled: !!activeClientId,\n  });\n\n  const { data: locationAnalysis, isLoading: isLoadingLocations, refetch: refetchLocations } = useQuery({\n    queryKey: [\"/api/customers\", activeClientId, \"reports\", \"locations\", { period: dateRange }],\n    queryFn: () => fetch(`/api/customers/${activeClientId}/reports/locations?period=${dateRange}`).then(res => res.json()),\n    enabled: !!activeClientId,\n  });\n\n  const { data: temporalAnalysis, isLoading: isLoadingTemporal, refetch: refetchTemporal } = useQuery({\n    queryKey: [\"/api/customers\", activeClientId, \"reports\", \"temporal\", { period: dateRange }],\n    queryFn: () => fetch(`/api/customers/${activeClientId}/reports/temporal?period=${dateRange}`).then(res => res.json()),\n    enabled: !!activeClientId,\n  });\n\n  // Helper function to safely access nested properties\n  const safeGet = (obj: any, key: string, defaultValue: any = 0) => {\n    return obj && typeof obj === 'object' && key in obj ? obj[key] : defaultValue;\n  };\n\n  // Refresh all data\n  const refreshData = async () => {\n    setIsRefreshing(true);\n    try {\n      await Promise.all([\n        refetchMetrics(),\n        refetchStatus(),\n        refetchSLA(),\n        refetchGeneral(),\n        refetchSLAAnalysis(),\n        refetchProductivity(),\n        refetchOperators(),\n        refetchLocations(),\n        refetchTemporal()\n      ]);\n      toast({\n        title: \"✅ Dados atualizados!\",\n        description: \"Todas as informações foram atualizadas com sucesso.\",\n      });\n    } catch (error) {\n      toast({\n        title: \"❌ Erro ao atualizar\",\n        description: \"Não foi possível atualizar os dados. Tente novamente.\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsRefreshing(false);\n    }\n  };\n\n  // Generate and download report\n  const generateReport = async (reportType: string, format: 'pdf' | 'csv' | 'excel') => {\n    setIsGenerating(`${reportType}-${format}`);\n    \n    try {\n      // Get the appropriate data based on report type\n      let reportData: any = {};\n      let filename = `relatorio-${reportType}-${dateRange}dias`;\n\n      switch (reportType) {\n        case 'geral':\n          reportData = {\n            metrics: reportsMetrics || {},\n            workOrders: workOrdersStatus || [],\n            slaData: slaPerformance || {},\n            generalData: generalReport || {},\n            period: `${dateRange} dias`,\n            generatedAt: new Date().toISOString(),\n            reportType: 'Relatório Geral'\n          };\n          break;\n        case 'sla':\n          reportData = {\n            slaData: slaPerformance || {},\n            slaAnalysisData: slaAnalysis || {},\n            period: `${dateRange} dias`,\n            generatedAt: new Date().toISOString(),\n            reportType: 'Relatório de SLA'\n          };\n          break;\n        case 'produtividade':\n          reportData = {\n            ...(productivityReport || {}),\n            period: `${dateRange} dias`,\n            generatedAt: new Date().toISOString(),\n            reportType: 'Relatório de Produtividade'\n          };\n          break;\n        case 'operadores':\n          reportData = {\n            ...(operatorPerformance || {}),\n            period: `${dateRange} dias`,\n            generatedAt: new Date().toISOString(),\n            reportType: 'Relatório de Operadores'\n          };\n          break;\n        case 'locais':\n          reportData = {\n            ...(locationAnalysis || {}),\n            period: `${dateRange} dias`,\n            generatedAt: new Date().toISOString(),\n            reportType: 'Relatório por Locais'\n          };\n          break;\n        case 'temporal':\n          reportData = {\n            ...(temporalAnalysis || {}),\n            period: `${dateRange} dias`,\n            generatedAt: new Date().toISOString(),\n            reportType: 'Relatório Temporal'\n          };\n          break;\n      }\n\n      if (format === 'csv') {\n        generateCSV(reportData, filename);\n      } else if (format === 'excel') {\n        generateExcel(reportData, filename);\n      } else {\n        generatePDF(reportData, filename);\n      }\n\n      toast({\n        title: \"✅ Relatório gerado com sucesso!\",\n        description: `${reportType.charAt(0).toUpperCase() + reportType.slice(1)} em formato ${format.toUpperCase()} baixado.`,\n      });\n\n    } catch (error) {\n      console.error('Erro ao gerar relatório:', error);\n      toast({\n        title: \"❌ Erro ao gerar relatório\",\n        description: \"Ocorreu um erro ao gerar o relatório. Tente novamente.\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsGenerating(null);\n    }\n  };\n\n  // Generate CSV content and download\n  const generateCSV = (data: any, filename: string) => {\n    let csv = `Relatório,${data.reportType}\\n`;\n    csv += `Período,${data.period}\\n`;\n    csv += `Gerado em,${new Date(data.generatedAt).toLocaleString('pt-BR')}\\n\\n`;\n\n    // Relatório de Produtividade\n    if (data.productivity) {\n      csv += \"MÉTRICAS DE PRODUTIVIDADE\\n\";\n      csv += `Métrica,Valor\\n`;\n      csv += `OS por Dia,${safeGet(data.productivity, 'workOrdersPerDay', 0)}\\n`;\n      csv += `Tempo Médio de Conclusão (min),${safeGet(data.productivity, 'averageCompletionTime', 0)}\\n`;\n      csv += `Área Limpa por Hora (m²/h),${safeGet(data.productivity, 'areaCleanedPerHour', 0)}\\n`;\n      csv += `Tarefas por Operador,${safeGet(data.productivity, 'tasksPerOperator', 0)}\\n`;\n      csv += `Score de Qualidade (%),${safeGet(data.productivity, 'qualityScore', 0)}\\n\\n`;\n      \n      csv += \"MÉTRICAS DE EFICIÊNCIA\\n\";\n      csv += `Métrica,Valor\\n`;\n      csv += `Utilização de Recursos (%),${safeGet(data.efficiency, 'resourceUtilization', 0)}\\n`;\n      csv += `Uptime de Equipamentos (%),${safeGet(data.efficiency, 'equipmentUptime', 0)}\\n`;\n      csv += `Desperdício de Material (%),${safeGet(data.efficiency, 'materialWaste', 0)}\\n`;\n      csv += `Consumo de Energia (kWh),${safeGet(data.efficiency, 'energyConsumption', 0)}\\n`;\n      csv += `Eficiência de Custo (%),${safeGet(data.efficiency, 'costEfficiency', 0)}\\n\\n`;\n      \n      if (data.trends && Array.isArray(data.trends)) {\n        csv += \"TENDÊNCIAS MENSAIS\\n\";\n        csv += \"Mês,Produtividade (%),Eficiência (%)\\n\";\n        data.trends.forEach((trend: any) => {\n          csv += `${trend.month},${trend.productivity},${trend.efficiency}\\n`;\n        });\n      }\n    }\n\n    // Relatório de Operadores\n    if (data.operators) {\n      if (data.operators.topPerformers && Array.isArray(data.operators.topPerformers)) {\n        csv += \"TOP PERFORMERS\\n\";\n        csv += \"Operador,Rank,Pontuação,Melhoria\\n\";\n        data.operators.topPerformers.forEach((performer: any) => {\n          csv += `${performer.name},${performer.rank},${performer.score},${performer.improvement}\\n`;\n        });\n        csv += \"\\n\";\n      }\n      \n      if (data.operators.operators && Array.isArray(data.operators.operators)) {\n        csv += \"OPERADORES INDIVIDUAIS\\n\";\n        csv += \"Nome,Tarefas,Eficiência (%),Qualidade,Pontualidade (%),Experiência,Certificação\\n\";\n        data.operators.operators.slice(0, 10).forEach((op: any) => {\n          csv += `${op.name},${op.tasksCompleted},${op.efficiency},${op.qualityScore},${op.punctuality},${op.experienceLevel},${op.certification}\\n`;\n        });\n      }\n    }\n\n    // Relatório de Locais\n    if (data.locations) {\n      if (data.locations.sites && Array.isArray(data.locations.sites)) {\n        csv += \"SITES\\n\";\n        csv += \"Nome,Zonas,OS Total,Concluídas,Eficiência (%),Área (m²),Utilização (%)\\n\";\n        data.locations.sites.forEach((site: any) => {\n          csv += `${site.name},${site.totalZones},${site.totalWorkOrders},${site.completedWorkOrders},${site.efficiency},${site.area},${site.utilizationRate}\\n`;\n        });\n        csv += \"\\n\";\n      }\n      \n      if (data.locations.zones && Array.isArray(data.locations.zones)) {\n        csv += \"ZONAS\\n\";\n        csv += \"Nome,Site,OS Total,Concluídas,Tempo Médio (min),Prioridade,Última Limpeza\\n\";\n        data.locations.zones.forEach((zone: any) => {\n          csv += `${zone.name},${zone.siteName},${zone.totalWorkOrders},${zone.completedWorkOrders},${zone.averageTime},${zone.priority},${zone.lastCleaning}\\n`;\n        });\n      }\n    }\n\n    // Relatório Temporal\n    if (data.temporal) {\n      if (data.temporal.historicalTrends && Array.isArray(data.temporal.historicalTrends)) {\n        csv += \"TENDÊNCIAS HISTÓRICAS\\n\";\n        csv += \"Período,OS Concluídas,SLA (%),Eficiência (%)\\n\";\n        data.temporal.historicalTrends.forEach((trend: any) => {\n          csv += `${trend.period},${trend.workOrders},${trend.sla},${trend.efficiency}\\n`;\n        });\n      }\n    }\n\n    // Dados gerais (para relatórios que ainda usam o formato antigo)\n    if (data.metrics) {\n      csv += \"MÉTRICAS GERAIS\\n\";\n      csv += `Métrica,Valor\\n`;\n      csv += `OS Concluídas,${safeGet(data.metrics, 'completedWorkOrders', 0)}\\n`;\n      csv += `SLA Médio,${safeGet(data.metrics, 'averageSLA', 0)}%\\n`;\n      csv += `Área Limpa (m²),${safeGet(data.metrics, 'totalAreaCleaned', 0)}\\n`;\n      csv += `Tempo Médio (min),${safeGet(data.metrics, 'averageExecutionTime', 0)}\\n\\n`;\n    }\n\n    if (data.workOrders && Array.isArray(data.workOrders)) {\n      csv += \"ORDENS DE SERVIÇO POR STATUS\\n\";\n      csv += \"Status,Quantidade\\n\";\n      data.workOrders.forEach((wo: WorkOrderStatusData) => {\n        csv += `${wo.label || wo.status},${wo.count}\\n`;\n      });\n      csv += \"\\n\";\n    }\n\n    if (data.slaData && safeGet(data.slaData, 'categories', null)) {\n      csv += \"PERFORMANCE SLA\\n\";\n      csv += \"Categoria,Percentual\\n\";\n      safeGet(data.slaData, 'categories', []).forEach((cat: any) => {\n        csv += `${cat.label},${cat.percentage}%\\n`;\n      });\n    }\n\n    downloadFile(csv, `${filename}.csv`, 'text/csv');\n  };\n\n  // Generate real Excel file and download\n  const generateExcel = (data: any, filename: string) => {\n    const workbook = XLSX.utils.book_new();\n\n    // Create summary sheet\n    const summaryData: any[][] = [\n      ['GRUPO OPUS - RELATÓRIO DE LIMPEZA'],\n      [''],\n      ['Tipo', data.reportType],\n      ['Período', data.period],\n      ['Gerado em', new Date(data.generatedAt).toLocaleString('pt-BR')],\n      ['']\n    ];\n\n    // Relatório de Produtividade\n    if (data.productivity) {\n      summaryData.push(['MÉTRICAS DE PRODUTIVIDADE']);\n      summaryData.push(['']);\n      summaryData.push(['Métrica', 'Valor']);\n      summaryData.push(['OS por Dia', safeGet(data.productivity, 'workOrdersPerDay', 0)]);\n      summaryData.push(['Tempo Médio de Conclusão (min)', safeGet(data.productivity, 'averageCompletionTime', 0)]);\n      summaryData.push(['Área Limpa por Hora (m²/h)', safeGet(data.productivity, 'areaCleanedPerHour', 0)]);\n      summaryData.push(['Tarefas por Operador', safeGet(data.productivity, 'tasksPerOperator', 0)]);\n      summaryData.push(['Score de Qualidade (%)', safeGet(data.productivity, 'qualityScore', 0)]);\n      summaryData.push(['']);\n      summaryData.push(['MÉTRICAS DE EFICIÊNCIA']);\n      summaryData.push(['']);\n      summaryData.push(['Métrica', 'Valor']);\n      summaryData.push(['Utilização de Recursos (%)', safeGet(data.efficiency, 'resourceUtilization', 0)]);\n      summaryData.push(['Uptime de Equipamentos (%)', safeGet(data.efficiency, 'equipmentUptime', 0)]);\n      summaryData.push(['Desperdício de Material (%)', safeGet(data.efficiency, 'materialWaste', 0)]);\n      summaryData.push(['Consumo de Energia (kWh)', safeGet(data.efficiency, 'energyConsumption', 0)]);\n      summaryData.push(['Eficiência de Custo (%)', safeGet(data.efficiency, 'costEfficiency', 0)]);\n      \n      const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);\n      XLSX.utils.book_append_sheet(workbook, summarySheet, \"Resumo\");\n      \n      // Tendências mensais\n      if (data.trends && Array.isArray(data.trends)) {\n        const trendsData: any[][] = [\n          ['TENDÊNCIAS MENSAIS'],\n          [''],\n          ['Mês', 'Produtividade (%)', 'Eficiência (%)']\n        ];\n        data.trends.forEach((trend: any) => {\n          trendsData.push([trend.month, trend.productivity, trend.efficiency]);\n        });\n        const trendsSheet = XLSX.utils.aoa_to_sheet(trendsData);\n        XLSX.utils.book_append_sheet(workbook, trendsSheet, \"Tendências Mensais\");\n      }\n    }\n    // Relatório de Operadores\n    else if (data.operators) {\n      if (data.operators.topPerformers && Array.isArray(data.operators.topPerformers)) {\n        const topPerformersData: any[][] = [\n          ['TOP PERFORMERS'],\n          [''],\n          ['Operador', 'Rank', 'Pontuação', 'Melhoria']\n        ];\n        data.operators.topPerformers.forEach((performer: any) => {\n          topPerformersData.push([performer.name, performer.rank, performer.score, performer.improvement]);\n        });\n        const topPerformersSheet = XLSX.utils.aoa_to_sheet(topPerformersData);\n        XLSX.utils.book_append_sheet(workbook, topPerformersSheet, \"Top Performers\");\n      }\n      \n      if (data.operators.operators && Array.isArray(data.operators.operators)) {\n        const operatorsData: any[][] = [\n          ['OPERADORES INDIVIDUAIS'],\n          [''],\n          ['Nome', 'Tarefas', 'Eficiência (%)', 'Qualidade', 'Pontualidade (%)', 'Experiência', 'Certificação']\n        ];\n        data.operators.operators.forEach((op: any) => {\n          operatorsData.push([op.name, op.tasksCompleted, op.efficiency, op.qualityScore, op.punctuality, op.experienceLevel, op.certification]);\n        });\n        const operatorsSheet = XLSX.utils.aoa_to_sheet(operatorsData);\n        XLSX.utils.book_append_sheet(workbook, operatorsSheet, \"Operadores\");\n      }\n      \n      const summarySheet = XLSX.utils.aoa_to_sheet([['Relatório de Operadores']]);\n      XLSX.utils.book_append_sheet(workbook, summarySheet, \"Resumo\");\n    }\n    // Relatório de Locais\n    else if (data.locations) {\n      if (data.locations.sites && Array.isArray(data.locations.sites)) {\n        const sitesData: any[][] = [\n          ['LOCAIS'],\n          [''],\n          ['Nome', 'Zonas', 'OS Total', 'Concluídas', 'Eficiência (%)', 'Área (m²)', 'Utilização (%)']\n        ];\n        data.locations.sites.forEach((site: any) => {\n          sitesData.push([site.name, site.totalZones, site.totalWorkOrders, site.completedWorkOrders, site.efficiency, site.area, site.utilizationRate]);\n        });\n        const sitesSheet = XLSX.utils.aoa_to_sheet(sitesData);\n        XLSX.utils.book_append_sheet(workbook, sitesSheet, \"Locais\");\n      }\n      \n      if (data.locations.zones && Array.isArray(data.locations.zones)) {\n        const zonesData: any[][] = [\n          ['ZONAS'],\n          [''],\n          ['Nome', 'Local', 'OS Total', 'Concluídas', 'Tempo Médio (min)', 'Prioridade', 'Última Limpeza']\n        ];\n        data.locations.zones.forEach((zone: any) => {\n          zonesData.push([zone.name, zone.siteName, zone.totalWorkOrders, zone.completedWorkOrders, zone.averageTime, zone.priority, zone.lastCleaning]);\n        });\n        const zonesSheet = XLSX.utils.aoa_to_sheet(zonesData);\n        XLSX.utils.book_append_sheet(workbook, zonesSheet, \"Zonas\");\n      }\n      \n      const summarySheet = XLSX.utils.aoa_to_sheet([['Relatório por Locais']]);\n      XLSX.utils.book_append_sheet(workbook, summarySheet, \"Resumo\");\n    }\n    // Dados gerais (para relatórios que ainda usam o formato antigo)\n    else {\n      summaryData.push(['RESUMO EXECUTIVO']);\n      summaryData.push(['']);\n      summaryData.push(['Métrica', 'Valor']);\n      if (data.metrics) {\n        summaryData.push(['OS Concluídas', safeGet(data.metrics, 'completedWorkOrders', 0)]);\n        summaryData.push(['SLA Médio (%)', safeGet(data.metrics, 'averageSLA', 0)]);\n        summaryData.push(['Área Limpa (m²)', safeGet(data.metrics, 'totalAreaCleaned', 0)]);\n        summaryData.push(['Tempo Médio (min)', safeGet(data.metrics, 'averageExecutionTime', 0)]);\n      }\n      \n      const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);\n      XLSX.utils.book_append_sheet(workbook, summarySheet, \"Resumo\");\n\n      // Create work orders sheet if data exists\n      if (data.workOrders && Array.isArray(data.workOrders)) {\n        const workOrdersData = [\n          ['ORDENS DE SERVIÇO POR STATUS'],\n          [''],\n          ['Status', 'Quantidade']\n        ];\n        \n        data.workOrders.forEach((wo: WorkOrderStatusData) => {\n          workOrdersData.push([wo.label || wo.status, wo.count.toString()]);\n        });\n\n        const workOrdersSheet = XLSX.utils.aoa_to_sheet(workOrdersData);\n        XLSX.utils.book_append_sheet(workbook, workOrdersSheet, \"Ordens de Serviço\");\n      }\n\n      // Create SLA sheet if data exists\n      if (data.slaData && safeGet(data.slaData, 'categories', null)) {\n        const slaData = [\n          ['PERFORMANCE SLA'],\n          [''],\n          ['SLA Total (%)', safeGet(data.slaData, 'totalSLA', 0)],\n          [''],\n          ['Categoria', 'Percentual (%)']\n        ];\n        \n        safeGet(data.slaData, 'categories', []).forEach((cat: any) => {\n          slaData.push([cat.label, cat.percentage]);\n        });\n\n        const slaSheet = XLSX.utils.aoa_to_sheet(slaData);\n        XLSX.utils.book_append_sheet(workbook, slaSheet, \"SLA Performance\");\n      }\n    }\n\n    // Download the Excel file\n    XLSX.writeFile(workbook, `${filename}.xlsx`);\n  };\n\n  // Generate real PDF and download\n  const generatePDF = (data: any, filename: string) => {\n    const doc = new jsPDF();\n    \n    // Header\n    doc.setFontSize(20);\n    doc.setTextColor(30, 58, 138); // Navy blue\n    doc.text('GRUPO OPUS', 20, 20);\n    doc.setFontSize(16);\n    doc.text(data.reportType, 20, 30);\n    \n    // Report info\n    doc.setFontSize(10);\n    doc.setTextColor(0, 0, 0);\n    doc.text(`Período: ${data.period}`, 20, 45);\n    doc.text(`Gerado em: ${new Date(data.generatedAt).toLocaleString('pt-BR')}`, 20, 50);\n    \n    let yPosition = 65;\n\n    // KPI Summary\n    if (data.metrics) {\n      doc.setFontSize(14);\n      doc.setTextColor(30, 58, 138);\n      doc.text('RESUMO EXECUTIVO', 20, yPosition);\n      yPosition += 10;\n\n      const kpiData = [\n        ['Métrica', 'Valor'],\n        ['OS Concluídas', safeGet(data.metrics, 'completedWorkOrders', 0).toString()],\n        ['SLA Médio', `${safeGet(data.metrics, 'averageSLA', 0)}%`],\n        ['Área Limpa', `${safeGet(data.metrics, 'totalAreaCleaned', 0)} m²`],\n        ['Tempo Médio', `${safeGet(data.metrics, 'averageExecutionTime', 0)} min`]\n      ];\n\n      autoTable(doc, {\n        head: [kpiData[0]],\n        body: kpiData.slice(1),\n        startY: yPosition,\n        theme: 'grid',\n        headStyles: { fillColor: [30, 58, 138] },\n        margin: { left: 20 }\n      });\n\n      yPosition = (doc as any).lastAutoTable.finalY + 15;\n    }\n\n    // Work Orders Table\n    if (data.workOrders && Array.isArray(data.workOrders) && data.workOrders.length > 0) {\n      doc.setFontSize(14);\n      doc.setTextColor(30, 58, 138);\n      doc.text('ORDENS DE SERVIÇO', 20, yPosition);\n      yPosition += 10;\n\n      const workOrdersTableData = data.workOrders.map((wo: WorkOrderStatusData) => [\n        wo.label || wo.status,\n        wo.count.toString()\n      ]);\n\n      autoTable(doc, {\n        head: [['Status', 'Quantidade']],\n        body: workOrdersTableData,\n        startY: yPosition,\n        theme: 'grid',\n        headStyles: { fillColor: [30, 58, 138] },\n        margin: { left: 20 }\n      });\n\n      yPosition = (doc as any).lastAutoTable.finalY + 15;\n    }\n\n    // SLA Performance\n    if (data.slaData && safeGet(data.slaData, 'categories', null)) {\n      doc.setFontSize(14);\n      doc.setTextColor(30, 58, 138);\n      doc.text('PERFORMANCE SLA', 20, yPosition);\n      yPosition += 5;\n\n      doc.setFontSize(12);\n      doc.setTextColor(0, 0, 0);\n      doc.text(`SLA Total: ${safeGet(data.slaData, 'totalSLA', 0)}%`, 20, yPosition + 10);\n      yPosition += 20;\n\n      const slaTableData = safeGet(data.slaData, 'categories', []).map((cat: any) => [\n        cat.label,\n        `${cat.percentage}%`\n      ]);\n\n      autoTable(doc, {\n        head: [['Categoria', 'Percentual']],\n        body: slaTableData,\n        startY: yPosition,\n        theme: 'grid',\n        headStyles: { fillColor: [30, 58, 138] },\n        margin: { left: 20 }\n      });\n    }\n\n    // Footer\n    const pageCount = doc.getNumberOfPages();\n    for (let i = 1; i <= pageCount; i++) {\n      doc.setPage(i);\n      doc.setFontSize(8);\n      doc.setTextColor(128, 128, 128);\n      doc.text(`Página ${i} de ${pageCount}`, doc.internal.pageSize.width - 40, doc.internal.pageSize.height - 10);\n      doc.text('Relatório gerado automaticamente pelo sistema OPUS CLEAN', 20, doc.internal.pageSize.height - 10);\n    }\n\n    // Save the PDF\n    doc.save(`${filename}.pdf`);\n  };\n\n  // Download file helper\n  const downloadFile = (content: string, filename: string, mimeType: string) => {\n    const blob = new Blob([content], { type: mimeType });\n    const url = window.URL.createObjectURL(blob);\n    const link = document.createElement('a');\n    link.href = url;\n    link.download = filename;\n    document.body.appendChild(link);\n    link.click();\n    document.body.removeChild(link);\n    window.URL.revokeObjectURL(url);\n  };\n\n  // Report type definitions\n  const reportTypes = [\n    {\n      id: \"geral\",\n      title: \"Relatório Geral\",\n      description: \"Visão completa das operações com todos os KPIs principais\",\n      icon: FileText,\n      color: \"bg-blue-500\",\n      gradient: \"from-blue-50 to-blue-100\"\n    },\n    {\n      id: \"sla\",\n      title: \"Análise de SLA\",\n      description: \"Performance detalhada de cumprimento de prazos\",\n      icon: Target,\n      color: \"bg-green-500\",\n      gradient: \"from-green-50 to-green-100\"\n    },\n    {\n      id: \"produtividade\",\n      title: \"Produtividade\",\n      description: \"Métricas de eficiência e produtividade operacional\",\n      icon: TrendingUp,\n      color: \"bg-purple-500\",\n      gradient: \"from-purple-50 to-purple-100\"\n    },\n    {\n      id: \"operadores\",\n      title: \"Performance de Operadores\",\n      description: \"Análise individual e comparativa dos operadores\",\n      icon: Users,\n      color: \"bg-orange-500\",\n      gradient: \"from-orange-50 to-orange-100\"\n    },\n    {\n      id: \"locais\",\n      title: \"Análise por Locais\",\n      description: \"Distribuição e performance por zona e site\",\n      icon: MapPin,\n      color: \"bg-indigo-500\",\n      gradient: \"from-indigo-50 to-indigo-100\"\n    },\n    {\n      id: \"temporal\",\n      title: \"Análise Temporal\",\n      description: \"Tendências e padrões ao longo do tempo\",\n      icon: Clock,\n      color: \"bg-red-500\",\n      gradient: \"from-red-50 to-red-100\"\n    }\n  ];\n\n  // KPI Cards\n  const kpiCards = [\n    {\n      title: \"OS Concluídas\",\n      value: safeGet(reportsMetrics, 'completedWorkOrders', 0).toLocaleString(),\n      change: safeGet(reportsMetrics, 'completedWorkOrdersChange', '0%'),\n      trend: safeGet(reportsMetrics, 'completedWorkOrdersChange', '0%').startsWith('+') ? \"up\" : \"down\",\n      icon: CheckCircle2,\n      color: \"text-green-600\",\n      bgColor: \"bg-green-50\",\n      borderColor: \"border-green-200\"\n    },\n    {\n      title: \"SLA Médio\",\n      value: `${safeGet(reportsMetrics, 'averageSLA', 0)}%`,\n      change: safeGet(reportsMetrics, 'averageSLAChange', '0%'),\n      trend: safeGet(reportsMetrics, 'averageSLAChange', '0%').startsWith('+') ? \"up\" : \"down\",\n      icon: Target,\n      color: \"text-blue-600\",\n      bgColor: \"bg-blue-50\",\n      borderColor: \"border-blue-200\"\n    },\n    {\n      title: \"Área Limpa (m²)\",\n      value: safeGet(reportsMetrics, 'totalAreaCleaned', 0).toLocaleString(),\n      change: safeGet(reportsMetrics, 'totalAreaCleanedChange', '0%'),\n      trend: safeGet(reportsMetrics, 'totalAreaCleanedChange', '0%').startsWith('+') ? \"up\" : \"down\",\n      icon: Building2,\n      color: \"text-purple-600\",\n      bgColor: \"bg-purple-50\",\n      borderColor: \"border-purple-200\"\n    },\n    {\n      title: \"Tempo Médio (min)\",\n      value: safeGet(reportsMetrics, 'averageExecutionTime', 0).toString(),\n      change: safeGet(reportsMetrics, 'averageExecutionTimeChange', '0%'),\n      trend: safeGet(reportsMetrics, 'averageExecutionTimeChange', '0%').startsWith('+') ? \"up\" : \"down\",\n      icon: Timer,\n      color: \"text-orange-600\",\n      bgColor: \"bg-orange-50\",\n      borderColor: \"border-orange-200\"\n    }\n  ];\n\n  // COMPONENTES DE VISUALIZAÇÃO ESPECÍFICOS PARA CADA TIPO DE RELATÓRIO\n\n  const GeneralReportView = ({ data }: { data: any }) => (\n    <Card className=\"border-0 shadow-lg\">\n      <CardHeader>\n        <CardTitle className=\"flex items-center space-x-2\">\n          <FileText className=\"w-5 h-5 text-blue-600\" />\n          <span>Relatório Geral - Visão Completa das Operações</span>\n        </CardTitle>\n      </CardHeader>\n      <CardContent>\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6\">\n          {/* Overview */}\n          <div className=\"space-y-4\">\n            <h3 className=\"text-lg font-semibold text-slate-800\">📊 Visão Geral</h3>\n            <div className=\"space-y-2\">\n              <div className=\"flex justify-between\">\n                <span className=\"text-sm text-slate-600\">Total de OS:</span>\n                <span className=\"font-semibold\">{data.overview?.totalWorkOrders || 0}</span>\n              </div>\n              <div className=\"flex justify-between\">\n                <span className=\"text-sm text-slate-600\">Concluídas:</span>\n                <span className=\"font-semibold text-green-600\">{data.overview?.completedWorkOrders || 0}</span>\n              </div>\n              <div className=\"flex justify-between\">\n                <span className=\"text-sm text-slate-600\">Pendentes:</span>\n                <span className=\"font-semibold text-amber-600\">{data.overview?.pendingWorkOrders || 0}</span>\n              </div>\n              <div className=\"flex justify-between\">\n                <span className=\"text-sm text-slate-600\">Taxa de Conclusão:</span>\n                <span className=\"font-semibold text-blue-600\">{data.overview?.completionRate || 0}%</span>\n              </div>\n            </div>\n          </div>\n\n          {/* Efficiency */}\n          <div className=\"space-y-4\">\n            <h3 className=\"text-lg font-semibold text-slate-800\">⚡ Eficiência</h3>\n            <div className=\"space-y-2\">\n              <div className=\"flex justify-between\">\n                <span className=\"text-sm text-slate-600\">Eficiência Geral:</span>\n                <span className=\"font-semibold\">{data.efficiency?.overallEfficiency || 0}%</span>\n              </div>\n              <div className=\"flex justify-between\">\n                <span className=\"text-sm text-slate-600\">Índice de Qualidade:</span>\n                <span className=\"font-semibold\">{data.efficiency?.qualityIndex || 0}%</span>\n              </div>\n              <div className=\"flex justify-between\">\n                <span className=\"text-sm text-slate-600\">Utilização de Recursos:</span>\n                <span className=\"font-semibold\">{data.efficiency?.resourceUtilization || 0}%</span>\n              </div>\n              <div className=\"flex justify-between\">\n                <span className=\"text-sm text-slate-600\">Tempo Médio:</span>\n                <span className=\"font-semibold\">{data.efficiency?.averageCompletionTime || 0} min</span>\n              </div>\n            </div>\n          </div>\n\n          {/* Financial */}\n          <div className=\"space-y-4\">\n            <h3 className=\"text-lg font-semibold text-slate-800\">💰 Financeiro</h3>\n            <div className=\"space-y-2\">\n              <div className=\"flex justify-between\">\n                <span className=\"text-sm text-slate-600\">Custo Total:</span>\n                <span className=\"font-semibold\">R$ {(data.financial?.totalCost || 0).toFixed(2)}</span>\n              </div>\n              <div className=\"flex justify-between\">\n                <span className=\"text-sm text-slate-600\">Custo por OS:</span>\n                <span className=\"font-semibold\">R$ {(data.financial?.costPerWorkOrder || 0).toFixed(2)}</span>\n              </div>\n              <div className=\"flex justify-between\">\n                <span className=\"text-sm text-slate-600\">Utilização do Orçamento:</span>\n                <span className=\"font-semibold\">{data.financial?.budgetUtilization || 0}%</span>\n              </div>\n              <div className=\"flex justify-between\">\n                <span className=\"text-sm text-slate-600\">Economia:</span>\n                <span className=\"font-semibold text-green-600\">R$ {(data.financial?.savings || 0).toFixed(2)}</span>\n              </div>\n            </div>\n          </div>\n\n          {/* Compliance */}\n          <div className=\"space-y-4\">\n            <h3 className=\"text-lg font-semibold text-slate-800\">🎯 Compliance</h3>\n            <div className=\"space-y-2\">\n              <div className=\"flex justify-between\">\n                <span className=\"text-sm text-slate-600\">SLA Compliance:</span>\n                <span className=\"font-semibold\">{data.compliance?.slaCompliance || 0}%</span>\n              </div>\n              <div className=\"flex justify-between\">\n                <span className=\"text-sm text-slate-600\">Incidentes de Segurança:</span>\n                <span className=\"font-semibold\">{data.compliance?.safetyIncidents || 0}</span>\n              </div>\n              <div className=\"flex justify-between\">\n                <span className=\"text-sm text-slate-600\">Score de Qualidade:</span>\n                <span className=\"font-semibold\">{data.compliance?.qualityScore || 0}%</span>\n              </div>\n              <div className=\"flex justify-between\">\n                <span className=\"text-sm text-slate-600\">Score de Auditoria:</span>\n                <span className=\"font-semibold\">{data.compliance?.auditScore || 0}%</span>\n              </div>\n            </div>\n          </div>\n        </div>\n      </CardContent>\n    </Card>\n  );\n\n  const SLAAnalysisView = ({ data }: { data: any }) => (\n    <Card className=\"border-0 shadow-lg\">\n      <CardHeader>\n        <CardTitle className=\"flex items-center space-x-2\">\n          <Target className=\"w-5 h-5 text-green-600\" />\n          <span>Análise de SLA - Performance de Cumprimento de Prazos</span>\n        </CardTitle>\n      </CardHeader>\n      <CardContent>\n        <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n          {/* SLA Breakdown */}\n          <div className=\"space-y-4\">\n            <h3 className=\"text-lg font-semibold text-slate-800\">📋 Breakdown por Categoria</h3>\n            <div className=\"space-y-3\">\n              {data.slaBreakdown?.map((item: any, index: number) => (\n                <div key={index} className=\"bg-slate-50 p-4 rounded-lg\">\n                  <div className=\"flex justify-between items-center mb-2\">\n                    <span className=\"font-medium\">{item.category}</span>\n                    <span className=\"text-lg font-bold text-green-600\">{item.percentage}%</span>\n                  </div>\n                  <div className=\"text-sm text-slate-600\">\n                    {item.met} de {item.total} cumpridos\n                  </div>\n                  <div className=\"w-full bg-slate-200 rounded-full h-2 mt-2\">\n                    <div \n                      className=\"bg-green-500 h-2 rounded-full\" \n                      style={{ width: `${item.percentage}%` }}\n                    ></div>\n                  </div>\n                </div>\n              ))}\n            </div>\n          </div>\n\n          {/* Time Distribution */}\n          <div className=\"space-y-4\">\n            <h3 className=\"text-lg font-semibold text-slate-800\">⏱️ Distribuição de Tempo</h3>\n            <div className=\"space-y-3\">\n              {data.timeDistribution?.map((item: any, index: number) => (\n                <div key={index} className=\"bg-slate-50 p-4 rounded-lg\">\n                  <div className=\"flex justify-between items-center mb-2\">\n                    <span className=\"font-medium\">{item.range}</span>\n                    <span className=\"text-lg font-bold text-blue-600\">{item.percentage}%</span>\n                  </div>\n                  <div className=\"text-sm text-slate-600\">\n                    {item.count} ordens de serviço\n                  </div>\n                  <div className=\"w-full bg-slate-200 rounded-full h-2 mt-2\">\n                    <div \n                      className=\"bg-blue-500 h-2 rounded-full\" \n                      style={{ width: `${item.percentage}%` }}\n                    ></div>\n                  </div>\n                </div>\n              ))}\n            </div>\n            <div className=\"bg-amber-50 p-4 rounded-lg mt-4\">\n              <div className=\"flex justify-between\">\n                <span className=\"text-sm text-slate-600\">Tempo Médio de Resposta:</span>\n                <span className=\"font-semibold\">{data.averageResponseTime || \"N/A\"}</span>\n              </div>\n              <div className=\"flex justify-between\">\n                <span className=\"text-sm text-slate-600\">Alertas Críticos:</span>\n                <span className=\"font-semibold text-red-600\">{data.criticalAlerts || 0}</span>\n              </div>\n            </div>\n          </div>\n        </div>\n      </CardContent>\n    </Card>\n  );\n\n  const ProductivityReportView = ({ data }: { data: any }) => (\n    <Card className=\"border-0 shadow-lg\">\n      <CardHeader>\n        <CardTitle className=\"flex items-center space-x-2\">\n          <TrendingUp className=\"w-5 h-5 text-purple-600\" />\n          <span>Produtividade - Métricas de Eficiência Operacional</span>\n        </CardTitle>\n      </CardHeader>\n      <CardContent>\n        <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n          {/* Productivity Metrics */}\n          <div className=\"space-y-4\">\n            <h3 className=\"text-lg font-semibold text-slate-800\">📈 Métricas de Produtividade</h3>\n            <div className=\"space-y-3\">\n              {[\n                { label: \"OS por Dia\", value: data.productivity?.workOrdersPerDay, unit: \"\" },\n                { label: \"Tempo Médio de Conclusão\", value: data.productivity?.averageCompletionTime, unit: \" min\" },\n                { label: \"Área Limpa por Hora\", value: data.productivity?.areaCleanedPerHour, unit: \" m²/h\" },\n                { label: \"Tarefas por Operador\", value: data.productivity?.tasksPerOperator, unit: \"\" },\n                { label: \"Score de Qualidade\", value: data.productivity?.qualityScore, unit: \"%\" }\n              ].map((metric, index) => (\n                <div key={index} className=\"bg-purple-50 p-3 rounded-lg\">\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-sm text-slate-600\">{metric.label}:</span>\n                    <span className=\"font-semibold text-purple-700\">{metric.value || 0}{metric.unit}</span>\n                  </div>\n                </div>\n              ))}\n            </div>\n          </div>\n\n          {/* Efficiency Metrics */}\n          <div className=\"space-y-4\">\n            <h3 className=\"text-lg font-semibold text-slate-800\">⚡ Métricas de Eficiência</h3>\n            <div className=\"space-y-3\">\n              {[\n                { label: \"Utilização de Recursos\", value: data.efficiency?.resourceUtilization, unit: \"%\" },\n                { label: \"Uptime de Equipamentos\", value: data.efficiency?.equipmentUptime, unit: \"%\" },\n                { label: \"Desperdício de Material\", value: data.efficiency?.materialWaste, unit: \"%\" },\n                { label: \"Consumo de Energia\", value: data.efficiency?.energyConsumption, unit: \" kWh\" },\n                { label: \"Eficiência de Custo\", value: data.efficiency?.costEfficiency, unit: \"%\" }\n              ].map((metric, index) => (\n                <div key={index} className=\"bg-green-50 p-3 rounded-lg\">\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-sm text-slate-600\">{metric.label}:</span>\n                    <span className=\"font-semibold text-green-700\">{metric.value || 0}{metric.unit}</span>\n                  </div>\n                </div>\n              ))}\n            </div>\n          </div>\n\n          {/* Trends */}\n          <div className=\"space-y-4\">\n            <h3 className=\"text-lg font-semibold text-slate-800\">📊 Tendências Mensais</h3>\n            <div className=\"space-y-3\">\n              {data.trends?.map((trend: any, index: number) => (\n                <div key={index} className=\"bg-slate-50 p-3 rounded-lg\">\n                  <div className=\"text-sm font-medium text-slate-800 mb-2\">{trend.month}</div>\n                  <div className=\"grid grid-cols-2 gap-2 text-xs\">\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-slate-600\">Produtividade:</span>\n                      <span className=\"font-semibold\">{trend.productivity}%</span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-slate-600\">Eficiência:</span>\n                      <span className=\"font-semibold\">{trend.efficiency}%</span>\n                    </div>\n                  </div>\n                </div>\n              ))}\n            </div>\n          </div>\n        </div>\n      </CardContent>\n    </Card>\n  );\n\n  const OperatorPerformanceView = ({ data }: { data: any }) => (\n    <Card className=\"border-0 shadow-lg\">\n      <CardHeader>\n        <CardTitle className=\"flex items-center space-x-2\">\n          <Users className=\"w-5 h-5 text-orange-600\" />\n          <span>Performance de Operadores - Análise Individual</span>\n        </CardTitle>\n      </CardHeader>\n      <CardContent>\n        <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n          {/* Team Stats */}\n          <div className=\"space-y-4\">\n            <h3 className=\"text-lg font-semibold text-slate-800\">👥 Estatísticas da Equipe</h3>\n            <div className=\"space-y-3\">\n              {[\n                { label: \"Total de Operadores\", value: data.teamStats?.totalOperators },\n                { label: \"Eficiência Média\", value: `${data.teamStats?.averageEfficiency || 0}%` },\n                { label: \"Top Performer\", value: data.teamStats?.topPerformer || \"N/A\" },\n                { label: \"Precisam Melhoria\", value: data.teamStats?.improvementNeeded },\n                { label: \"Treinamento Concluído\", value: data.teamStats?.trainingCompleted }\n              ].map((stat, index) => (\n                <div key={index} className=\"bg-orange-50 p-3 rounded-lg\">\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-sm text-slate-600\">{stat.label}:</span>\n                    <span className=\"font-semibold text-orange-700\">{stat.value}</span>\n                  </div>\n                </div>\n              ))}\n            </div>\n          </div>\n\n          {/* Rankings */}\n          <div className=\"space-y-4\">\n            <h3 className=\"text-lg font-semibold text-slate-800\">🏆 Ranking</h3>\n            <div className=\"space-y-3\">\n              {data.rankings?.map((rank: any, index: number) => (\n                <div key={index} className=\"bg-slate-50 p-4 rounded-lg\">\n                  <div className=\"flex items-center justify-between mb-2\">\n                    <div className=\"flex items-center space-x-2\">\n                      <span className=\"text-lg font-bold text-slate-700\">#{rank.position}</span>\n                      <span className=\"font-medium\">{rank.operator}</span>\n                    </div>\n                    <span className=\"text-lg font-bold text-blue-600\">{rank.score}</span>\n                  </div>\n                  <div className=\"text-sm text-slate-600\">\n                    Melhoria: <span className={`font-semibold ${rank.improvement.startsWith('+') ? 'text-green-600' : 'text-red-600'}`}>\n                      {rank.improvement}\n                    </span>\n                  </div>\n                </div>\n              ))}\n            </div>\n          </div>\n\n          {/* Individual Operators */}\n          <div className=\"space-y-4\">\n            <h3 className=\"text-lg font-semibold text-slate-800\">👤 Operadores Individuais</h3>\n            <div className=\"space-y-3 max-h-96 overflow-y-auto\">\n              {data.operators?.slice(0, 5).map((op: any, index: number) => (\n                <div key={index} className=\"bg-slate-50 p-3 rounded-lg\">\n                  <div className=\"font-medium text-slate-800 mb-2\">{op.name}</div>\n                  <div className=\"grid grid-cols-2 gap-1 text-xs\">\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-slate-600\">Tarefas:</span>\n                      <span className=\"font-semibold\">{op.tasksCompleted}</span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-slate-600\">Eficiência:</span>\n                      <span className=\"font-semibold\">{op.efficiency}%</span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-slate-600\">Qualidade:</span>\n                      <span className=\"font-semibold\">{op.qualityScore}</span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-slate-600\">Pontualidade:</span>\n                      <span className=\"font-semibold\">{op.punctuality}%</span>\n                    </div>\n                  </div>\n                  <div className=\"mt-2 flex justify-between items-center\">\n                    <span className=\"text-xs text-slate-600\">{op.experienceLevel}</span>\n                    <span className={`text-xs px-2 py-1 rounded ${op.certification === 'Ativo' ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-700'}`}>\n                      {op.certification}\n                    </span>\n                  </div>\n                </div>\n              ))}\n            </div>\n          </div>\n        </div>\n      </CardContent>\n    </Card>\n  );\n\n  const LocationAnalysisView = ({ data }: { data: any }) => (\n    <Card className=\"border-0 shadow-lg\">\n      <CardHeader>\n        <CardTitle className=\"flex items-center space-x-2\">\n          <MapPin className=\"w-5 h-5 text-indigo-600\" />\n          <span>Análise por Locais - Distribuição por Zona e Site</span>\n        </CardTitle>\n      </CardHeader>\n      <CardContent>\n        <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n          {/* Sites */}\n          <div className=\"space-y-4\">\n            <h3 className=\"text-lg font-semibold text-slate-800\">🏢 Sites</h3>\n            <div className=\"space-y-3\">\n              {data.sites?.map((site: any, index: number) => (\n                <div key={index} className=\"bg-indigo-50 p-4 rounded-lg\">\n                  <div className=\"font-medium text-slate-800 mb-2\">{site.name}</div>\n                  <div className=\"grid grid-cols-2 gap-2 text-sm\">\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-slate-600\">Zonas:</span>\n                      <span className=\"font-semibold\">{site.totalZones}</span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-slate-600\">OS Total:</span>\n                      <span className=\"font-semibold\">{site.totalWorkOrders}</span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-slate-600\">Concluídas:</span>\n                      <span className=\"font-semibold text-green-600\">{site.completedWorkOrders}</span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-slate-600\">Eficiência:</span>\n                      <span className=\"font-semibold text-blue-600\">{site.efficiency}%</span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-slate-600\">Área:</span>\n                      <span className=\"font-semibold\">{site.area} m²</span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-slate-600\">Utilização:</span>\n                      <span className=\"font-semibold\">{site.utilizationRate}%</span>\n                    </div>\n                  </div>\n                </div>\n              ))}\n            </div>\n          </div>\n\n          {/* Zones */}\n          <div className=\"space-y-4\">\n            <h3 className=\"text-lg font-semibold text-slate-800\">📍 Zonas</h3>\n            <div className=\"space-y-3 max-h-96 overflow-y-auto\">\n              {data.zones?.map((zone: any, index: number) => (\n                <div key={index} className=\"bg-slate-50 p-3 rounded-lg\">\n                  <div className=\"font-medium text-slate-800 mb-1\">{zone.name}</div>\n                  <div className=\"text-xs text-slate-600 mb-2\">{zone.siteName}</div>\n                  <div className=\"grid grid-cols-2 gap-1 text-xs\">\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-slate-600\">OS Total:</span>\n                      <span className=\"font-semibold\">{zone.totalWorkOrders}</span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-slate-600\">Concluídas:</span>\n                      <span className=\"font-semibold\">{zone.completedWorkOrders}</span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-slate-600\">Tempo Médio:</span>\n                      <span className=\"font-semibold\">{zone.averageTime} min</span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-slate-600\">Prioridade:</span>\n                      <span className={`font-semibold ${zone.priority === 'Alta' ? 'text-red-600' : zone.priority === 'Média' ? 'text-amber-600' : 'text-green-600'}`}>\n                        {zone.priority}\n                      </span>\n                    </div>\n                  </div>\n                  <div className=\"mt-2 text-xs text-slate-600\">\n                    Última limpeza: {zone.lastCleaning}\n                  </div>\n                </div>\n              ))}\n            </div>\n          </div>\n        </div>\n      </CardContent>\n    </Card>\n  );\n\n  const TemporalAnalysisView = ({ data }: { data: any }) => (\n    <Card className=\"border-0 shadow-lg\">\n      <CardHeader>\n        <CardTitle className=\"flex items-center space-x-2\">\n          <Clock className=\"w-5 h-5 text-red-600\" />\n          <span>Análise Temporal - Tendências e Padrões</span>\n        </CardTitle>\n      </CardHeader>\n      <CardContent>\n        <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n          {/* Historical Trends */}\n          <div className=\"space-y-4\">\n            <h3 className=\"text-lg font-semibold text-slate-800\">📈 Tendências Históricas</h3>\n            <div className=\"space-y-3\">\n              {data.trends?.map((trend: any, index: number) => (\n                <div key={index} className=\"bg-red-50 p-4 rounded-lg\">\n                  <div className=\"font-medium text-slate-800 mb-2\">{trend.period}</div>\n                  <div className=\"space-y-1 text-sm\">\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-slate-600\">Work Orders:</span>\n                      <span className=\"font-semibold\">{trend.workOrders}</span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-slate-600\">Eficiência:</span>\n                      <span className=\"font-semibold text-blue-600\">{trend.efficiency}%</span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-slate-600\">Custo:</span>\n                      <span className=\"font-semibold\">R$ {trend.cost}</span>\n                    </div>\n                  </div>\n                </div>\n              ))}\n            </div>\n          </div>\n\n          {/* Weekly Patterns */}\n          <div className=\"space-y-4\">\n            <h3 className=\"text-lg font-semibold text-slate-800\">📅 Padrões Semanais</h3>\n            <div className=\"space-y-3\">\n              {data.patterns?.map((pattern: any, index: number) => (\n                <div key={index} className=\"bg-slate-50 p-3 rounded-lg\">\n                  <div className=\"flex justify-between items-center mb-2\">\n                    <span className=\"font-medium text-slate-800\">{pattern.day}</span>\n                    <span className=\"text-sm font-semibold text-blue-600\">{pattern.avgWorkOrders} OS</span>\n                  </div>\n                  <div className=\"text-xs text-slate-600\">\n                    Pico: {pattern.peak}\n                  </div>\n                </div>\n              ))}\n            </div>\n          </div>\n\n          {/* Forecasts */}\n          <div className=\"space-y-4\">\n            <h3 className=\"text-lg font-semibold text-slate-800\">🔮 Previsões</h3>\n            <div className=\"space-y-3\">\n              {data.forecasts?.map((forecast: any, index: number) => (\n                <div key={index} className=\"bg-green-50 p-4 rounded-lg\">\n                  <div className=\"font-medium text-slate-800 mb-2\">{forecast.period}</div>\n                  <div className=\"space-y-1 text-sm\">\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-slate-600\">Previsão:</span>\n                      <span className=\"font-semibold text-green-600\">{forecast.predicted} OS</span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-slate-600\">Confiança:</span>\n                      <span className=\"font-semibold\">{forecast.confidence}%</span>\n                    </div>\n                  </div>\n                  <div className=\"w-full bg-slate-200 rounded-full h-2 mt-2\">\n                    <div \n                      className=\"bg-green-500 h-2 rounded-full\" \n                      style={{ width: `${forecast.confidence}%` }}\n                    ></div>\n                  </div>\n                </div>\n              ))}\n            </div>\n          </div>\n        </div>\n      </CardContent>\n    </Card>\n  );\n\n  return (\n    <>\n      <Header \n        title=\"Relatórios e Analytics\" \n        description=\"Dashboard completo com análises e geração de relatórios personalizados\"\n      >\n        <div className=\"flex items-center space-x-3\">\n          <Select value={dateRange} onValueChange={setDateRange}>\n            <SelectTrigger className=\"w-40\" data-testid=\"select-date-range\">\n              <Calendar className=\"w-4 h-4 mr-2\" />\n              <SelectValue />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"7\">Últimos 7 dias</SelectItem>\n              <SelectItem value=\"30\">Últimos 30 dias</SelectItem>\n              <SelectItem value=\"90\">Últimos 90 dias</SelectItem>\n              <SelectItem value=\"365\">Último ano</SelectItem>\n            </SelectContent>\n          </Select>\n          <Button \n            variant=\"outline\" \n            onClick={refreshData}\n            disabled={isRefreshing}\n            data-testid=\"button-refresh-data\"\n          >\n            <RefreshCw className={`w-4 h-4 mr-2 ${isRefreshing ? 'animate-spin' : ''}`} />\n            {isRefreshing ? 'Atualizando...' : 'Atualizar'}\n          </Button>\n        </div>\n      </Header>\n      \n      <main className=\"flex-1 overflow-auto p-6 bg-gradient-to-br from-slate-50 to-blue-50\">\n        {/* KPI Dashboard */}\n        <div className=\"mb-8\">\n          <div className=\"flex items-center justify-between mb-4\">\n            <h2 className=\"text-2xl font-bold text-slate-900\">Dashboard de KPIs</h2>\n            <Badge variant=\"outline\" className=\"text-slate-600\">\n              Últimos {dateRange} dias\n            </Badge>\n          </div>\n          \n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6\">\n            {isLoadingMetrics ? (\n              Array.from({ length: 4 }).map((_, i) => (\n                <Card key={i} className=\"border-0 shadow-lg\">\n                  <CardContent className=\"p-6\">\n                    <div className=\"flex items-center justify-between\">\n                      <div className=\"flex-1\">\n                        <Skeleton className=\"h-4 w-24 mb-3\" />\n                        <Skeleton className=\"h-8 w-20 mb-2\" />\n                        <Skeleton className=\"h-3 w-32\" />\n                      </div>\n                      <Skeleton className=\"w-12 h-12 rounded-full\" />\n                    </div>\n                  </CardContent>\n                </Card>\n              ))\n            ) : errorMetrics ? (\n              <div className=\"col-span-full\">\n                <Alert variant=\"destructive\">\n                  <AlertCircle className=\"h-4 w-4\" />\n                  <AlertDescription>\n                    Erro ao carregar métricas: {errorMetrics.message}\n                  </AlertDescription>\n                </Alert>\n              </div>\n            ) : (\n              kpiCards.map((kpi) => {\n                const Icon = kpi.icon;\n                return (\n                  <Card key={kpi.title} className={`border-0 shadow-lg hover:shadow-xl transition-all duration-300 ${kpi.borderColor} border-l-4`}>\n                    <CardContent className=\"p-6\">\n                      <div className=\"flex items-center justify-between\">\n                        <div className=\"flex-1\">\n                          <p className=\"text-sm font-medium text-slate-600 mb-1\">{kpi.title}</p>\n                          <p className=\"text-3xl font-bold text-slate-900 mb-2\" data-testid={`kpi-value-${kpi.title.toLowerCase().replace(/\\s+/g, '-')}`}>\n                            {kpi.value}\n                          </p>\n                          <div className=\"flex items-center\">\n                            <TrendingUp className={`w-3 h-3 mr-1 ${kpi.trend === 'up' ? 'text-green-500' : 'text-red-500'}`} />\n                            <p className={`text-xs font-medium ${kpi.trend === 'up' ? 'text-green-600' : 'text-red-600'}`}>\n                              {kpi.change} vs. período anterior\n                            </p>\n                          </div>\n                        </div>\n                        <div className={`w-14 h-14 ${kpi.bgColor} rounded-xl flex items-center justify-center`}>\n                          <Icon className={`w-7 h-7 ${kpi.color}`} />\n                        </div>\n                      </div>\n                    </CardContent>\n                  </Card>\n                );\n              })\n            )}\n          </div>\n        </div>\n\n        <Separator className=\"my-8\" />\n\n        {/* Report Generation Section */}\n        <div className=\"mb-8\">\n          <div className=\"text-center mb-8\">\n            <h2 className=\"text-3xl font-bold text-slate-900 mb-2\">Geração de Relatórios</h2>\n            <p className=\"text-slate-600 max-w-2xl mx-auto\">\n              Selecione o tipo de relatório e formato desejado para gerar análises detalhadas dos dados\n            </p>\n          </div>\n          \n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n            {reportTypes.map((report) => {\n              const Icon = report.icon;\n              const isSelected = selectedReportType === report.id;\n              \n              return (\n                <Card \n                  key={report.id} \n                  className={`cursor-pointer transition-all duration-300 border-0 shadow-lg hover:shadow-xl transform hover:-translate-y-1 ${\n                    isSelected ? \"ring-2 ring-blue-500 shadow-2xl scale-105\" : \"\"\n                  }`}\n                  onClick={() => setSelectedReportType(isSelected ? null : report.id)}\n                >\n                  <CardContent className=\"p-6\">\n                    <div className={`w-full h-32 rounded-lg bg-gradient-to-br ${report.gradient} mb-4 flex items-center justify-center`}>\n                      <Icon className={`w-12 h-12 text-white p-2 ${report.color} rounded-lg`} />\n                    </div>\n                    \n                    <h3 className=\"text-lg font-bold text-slate-900 mb-2\">\n                      {report.title}\n                    </h3>\n                    <p className=\"text-sm text-slate-600 mb-4 leading-relaxed\">\n                      {report.description}\n                    </p>\n                    \n                    {isSelected && (\n                      <div className=\"space-y-3 mt-4 pt-4 border-t border-slate-200\">\n                        <p className=\"text-xs font-semibold text-slate-700 uppercase tracking-wide\">\n                          Escolha o formato:\n                        </p>\n                        <div className=\"grid grid-cols-3 gap-2\">\n                          <Button \n                            size=\"sm\" \n                            variant=\"outline\"\n                            className=\"flex-1 text-xs py-2\"\n                            onClick={(e) => {\n                              e.stopPropagation();\n                              generateReport(report.id, 'pdf');\n                            }}\n                            disabled={isGenerating === `${report.id}-pdf`}\n                            data-testid={`button-generate-${report.id}-pdf`}\n                          >\n                            {isGenerating === `${report.id}-pdf` ? (\n                              <RefreshCw className=\"w-3 h-3 mr-1 animate-spin\" />\n                            ) : (\n                              <FileText className=\"w-3 h-3 mr-1\" />\n                            )}\n                            PDF\n                          </Button>\n                          <Button \n                            size=\"sm\" \n                            variant=\"outline\"\n                            className=\"flex-1 text-xs py-2\"\n                            onClick={(e) => {\n                              e.stopPropagation();\n                              generateReport(report.id, 'csv');\n                            }}\n                            disabled={isGenerating === `${report.id}-csv`}\n                            data-testid={`button-generate-${report.id}-csv`}\n                          >\n                            {isGenerating === `${report.id}-csv` ? (\n                              <RefreshCw className=\"w-3 h-3 mr-1 animate-spin\" />\n                            ) : (\n                              <FileSpreadsheet className=\"w-3 h-3 mr-1\" />\n                            )}\n                            CSV\n                          </Button>\n                          <Button \n                            size=\"sm\" \n                            variant=\"outline\"\n                            className=\"flex-1 text-xs py-2\"\n                            onClick={(e) => {\n                              e.stopPropagation();\n                              generateReport(report.id, 'excel');\n                            }}\n                            disabled={isGenerating === `${report.id}-excel`}\n                            data-testid={`button-generate-${report.id}-excel`}\n                          >\n                            {isGenerating === `${report.id}-excel` ? (\n                              <RefreshCw className=\"w-3 h-3 mr-1 animate-spin\" />\n                            ) : (\n                              <FileSpreadsheet className=\"w-3 h-3 mr-1\" />\n                            )}\n                            Excel\n                          </Button>\n                        </div>\n                      </div>\n                    )}\n                  </CardContent>\n                </Card>\n              );\n            })}\n          </div>\n\n          {/* VISUALIZAÇÕES ESPECÍFICAS PARA CADA TIPO DE RELATÓRIO */}\n          {selectedReportType && (\n            <div className=\"mt-8\">\n              {selectedReportType === 'geral' && generalReport && (\n                <GeneralReportView data={generalReport} />\n              )}\n              {selectedReportType === 'sla' && slaAnalysis && (\n                <SLAAnalysisView data={slaAnalysis} />\n              )}\n              {selectedReportType === 'produtividade' && productivityReport && (\n                <ProductivityReportView data={productivityReport} />\n              )}\n              {selectedReportType === 'operadores' && operatorPerformance && (\n                <OperatorPerformanceView data={operatorPerformance} />\n              )}\n              {selectedReportType === 'locais' && locationAnalysis && (\n                <LocationAnalysisView data={locationAnalysis} />\n              )}\n              {selectedReportType === 'temporal' && temporalAnalysis && (\n                <TemporalAnalysisView data={temporalAnalysis} />\n              )}\n            </div>\n          )}\n        </div>\n\n        <Separator className=\"my-8\" />\n\n        {/* Analytics Charts */}\n        <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8\">\n          {/* Work Orders Chart */}\n          <Card className=\"border-0 shadow-lg\">\n            <CardHeader>\n              <div className=\"flex items-center justify-between\">\n                <CardTitle className=\"flex items-center space-x-2\">\n                  <BarChart3 className=\"w-5 h-5\" />\n                  <span>Ordens de Serviço por Status</span>\n                </CardTitle>\n                <Button \n                  variant=\"outline\" \n                  size=\"sm\" \n                  onClick={() => generateReport('geral', 'csv')}\n                  data-testid=\"button-export-work-orders-csv\"\n                >\n                  <Download className=\"w-4 h-4 mr-2\" />\n                  Exportar\n                </Button>\n              </div>\n            </CardHeader>\n            <CardContent>\n              <div className=\"space-y-4\">\n                {isLoadingStatus ? (\n                  <div className=\"space-y-3\">\n                    {Array.from({ length: 4 }).map((_, i) => (\n                      <div key={i} className=\"flex items-center justify-between p-4 bg-slate-50 rounded-lg\">\n                        <div className=\"flex items-center space-x-3\">\n                          <Skeleton className=\"w-4 h-4 rounded\" />\n                          <Skeleton className=\"h-4 w-24\" />\n                        </div>\n                        <Skeleton className=\"h-4 w-8\" />\n                      </div>\n                    ))}\n                  </div>\n                ) : errorStatus ? (\n                  <Alert variant=\"destructive\">\n                    <AlertCircle className=\"h-4 w-4\" />\n                    <AlertDescription>\n                      Erro ao carregar dados de status: {errorStatus.message}\n                    </AlertDescription>\n                  </Alert>\n                ) : workOrdersStatus && Array.isArray(workOrdersStatus) && workOrdersStatus.length > 0 ? (\n                  workOrdersStatus.map((status: WorkOrderStatusData) => (\n                    <div key={status.status} className=\"flex items-center justify-between p-4 bg-slate-50 rounded-lg hover:bg-slate-100 transition-colors\" data-testid={`status-item-${status.status}`}>\n                      <div className=\"flex items-center space-x-3\">\n                        <div className={`w-4 h-4 ${status.color} rounded-full`}></div>\n                        <span className=\"text-sm font-medium text-slate-700\">{status.label}</span>\n                      </div>\n                      <Badge variant=\"secondary\" className=\"font-bold\" data-testid={`status-count-${status.status}`}>\n                        {status.count}\n                      </Badge>\n                    </div>\n                  ))\n                ) : (\n                  <div className=\"text-center py-8\">\n                    <Activity className=\"w-12 h-12 text-slate-300 mx-auto mb-2\" />\n                    <p className=\"text-sm text-slate-500\">Nenhum dado disponível</p>\n                  </div>\n                )}\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* SLA Performance Chart */}\n          <Card className=\"border-0 shadow-lg\">\n            <CardHeader>\n              <div className=\"flex items-center justify-between\">\n                <CardTitle className=\"flex items-center space-x-2\">\n                  <Target className=\"w-5 h-5\" />\n                  <span>Performance de SLA</span>\n                </CardTitle>\n                <Button \n                  variant=\"outline\" \n                  size=\"sm\" \n                  onClick={() => generateReport('sla', 'csv')}\n                  data-testid=\"button-export-sla-csv\"\n                >\n                  <Download className=\"w-4 h-4 mr-2\" />\n                  Exportar\n                </Button>\n              </div>\n            </CardHeader>\n            <CardContent>\n              <div className=\"space-y-6\">\n                {isLoadingSLA ? (\n                  <div>\n                    <div className=\"text-center mb-6\">\n                      <Skeleton className=\"h-16 w-24 mx-auto mb-2\" />\n                      <Skeleton className=\"h-4 w-20 mx-auto\" />\n                    </div>\n                    <div className=\"space-y-4\">\n                      {Array.from({ length: 3 }).map((_, i) => (\n                        <div key={i} className=\"flex items-center justify-between\">\n                          <Skeleton className=\"h-4 w-20\" />\n                          <div className=\"flex items-center space-x-2\">\n                            <Skeleton className=\"w-24 h-3 rounded-full\" />\n                            <Skeleton className=\"h-4 w-10\" />\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  </div>\n                ) : errorSLA ? (\n                  <Alert variant=\"destructive\">\n                    <AlertCircle className=\"h-4 w-4\" />\n                    <AlertDescription>\n                      Erro ao carregar dados de SLA: {errorSLA.message}\n                    </AlertDescription>\n                  </Alert>\n                ) : (\n                  <div>\n                    <div className=\"text-center mb-6 p-6 bg-gradient-to-r from-green-50 to-blue-50 rounded-lg\">\n                      <div className=\"text-5xl font-bold text-green-600 mb-2\" data-testid=\"sla-total-average\">\n                        {safeGet(slaPerformance, 'totalSLA', 0)}%\n                      </div>\n                      <div className=\"text-sm font-medium text-slate-600\">SLA Médio Geral</div>\n                    </div>\n                    \n                    <div className=\"space-y-4\">\n                      {slaPerformance && safeGet(slaPerformance, 'categories', null) && Array.isArray(safeGet(slaPerformance, 'categories', [])) ? (\n                        safeGet(slaPerformance, 'categories', []).map((category: any) => (\n                          <div key={category.category} className=\"flex items-center justify-between p-3 bg-slate-50 rounded-lg\" data-testid={`sla-category-${category.category}`}>\n                            <span className=\"text-sm font-medium text-slate-700\">{category.label}</span>\n                            <div className=\"flex items-center space-x-3\">\n                              <div className=\"w-32 h-3 bg-slate-200 rounded-full overflow-hidden\">\n                                <div \n                                  className={`h-full rounded-full transition-all duration-500 ${\n                                    category.category === 'onTime' ? 'bg-green-500' :\n                                    category.category === 'atRisk' ? 'bg-yellow-500' :\n                                    'bg-red-500'\n                                  }`}\n                                  style={{ width: `${Math.min(category.percentage, 100)}%` }}\n                                ></div>\n                              </div>\n                              <Badge variant=\"outline\" className=\"font-bold\" data-testid={`sla-percentage-${category.category}`}>\n                                {category.percentage}%\n                              </Badge>\n                            </div>\n                          </div>\n                        ))\n                      ) : (\n                        <div className=\"text-center py-8\">\n                          <Target className=\"w-12 h-12 text-slate-300 mx-auto mb-2\" />\n                          <p className=\"text-sm text-slate-500\">Nenhum dado disponível</p>\n                        </div>\n                      )}\n                    </div>\n                  </div>\n                )}\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* Quick Export Options */}\n        <Card className=\"border-0 shadow-lg\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center space-x-2\">\n              <Zap className=\"w-5 h-5 text-blue-600\" />\n              <span>Exportação Rápida</span>\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\n              {/* Relatório Completo PDF */}\n              <div className=\"group\">\n                <Button \n                  className=\"w-full h-20 flex flex-col items-center justify-center space-y-3 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1\"\n                  onClick={() => generateReport('geral', 'pdf')}\n                  disabled={isGenerating === 'geral-pdf'}\n                  data-testid=\"button-quick-export-all-pdf\"\n                >\n                  {isGenerating === 'geral-pdf' ? (\n                    <RefreshCw className=\"w-6 h-6 animate-spin\" />\n                  ) : (\n                    <FileText className=\"w-6 h-6\" />\n                  )}\n                  <span className=\"text-sm font-medium\">\n                    {isGenerating === 'geral-pdf' ? 'Gerando...' : 'Relatório Completo PDF'}\n                  </span>\n                </Button>\n              </div>\n              \n              {/* Análise SLA CSV */}\n              <div className=\"group\">\n                <Button \n                  variant=\"outline\"\n                  className=\"w-full h-20 flex flex-col items-center justify-center space-y-3 border-2 border-green-200 hover:border-green-400 hover:bg-green-50 text-green-700 hover:text-green-800 shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1\"\n                  onClick={() => generateReport('sla', 'csv')}\n                  disabled={isGenerating === 'sla-csv'}\n                  data-testid=\"button-quick-export-sla-csv\"\n                >\n                  {isGenerating === 'sla-csv' ? (\n                    <RefreshCw className=\"w-6 h-6 animate-spin\" />\n                  ) : (\n                    <Target className=\"w-6 h-6\" />\n                  )}\n                  <span className=\"text-sm font-medium\">\n                    {isGenerating === 'sla-csv' ? 'Gerando...' : 'Análise SLA CSV'}\n                  </span>\n                </Button>\n              </div>\n              \n              {/* Produtividade Excel */}\n              <div className=\"group\">\n                <Button \n                  variant=\"outline\"\n                  className=\"w-full h-20 flex flex-col items-center justify-center space-y-3 border-2 border-purple-200 hover:border-purple-400 hover:bg-purple-50 text-purple-700 hover:text-purple-800 shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1\"\n                  onClick={() => generateReport('produtividade', 'excel')}\n                  disabled={isGenerating === 'produtividade-excel'}\n                  data-testid=\"button-quick-export-productivity-excel\"\n                >\n                  {isGenerating === 'produtividade-excel' ? (\n                    <RefreshCw className=\"w-6 h-6 animate-spin\" />\n                  ) : (\n                    <TrendingUp className=\"w-6 h-6\" />\n                  )}\n                  <span className=\"text-sm font-medium\">\n                    {isGenerating === 'produtividade-excel' ? 'Gerando...' : 'Produtividade Excel'}\n                  </span>\n                </Button>\n              </div>\n            </div>\n            \n            {/* Informações adicionais */}\n            <div className=\"mt-6 p-4 bg-gradient-to-r from-slate-50 to-blue-50 rounded-lg border border-slate-200\">\n              <div className=\"flex items-center space-x-3\">\n                <div className=\"w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center\">\n                  <Download className=\"w-4 h-4 text-blue-600\" />\n                </div>\n                <div className=\"flex-1\">\n                  <p className=\"text-sm font-medium text-slate-900\">Downloads Instantâneos</p>\n                  <p className=\"text-xs text-slate-600\">Relatórios baseados nos dados dos últimos {dateRange} dias • Geração automática com dados reais</p>\n                </div>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </main>\n    </>\n  );\n}","size_bytes":78713},"client/src/pages/dashboard-backup.tsx":{"content":"import React from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\n// Date picker component would be imported here if needed\nimport { Separator } from \"@/components/ui/separator\";\nimport { \n  BarChart,\n  Bar,\n  XAxis,\n  YAxis,\n  CartesianGrid,\n  Tooltip,\n  Legend,\n  PieChart,\n  Pie,\n  Cell,\n  LineChart,\n  Line,\n  AreaChart,\n  Area,\n  ResponsiveContainer\n} from 'recharts';\nimport { \n  TrendingUp, \n  TrendingDown, \n  Users, \n  Clock, \n  CheckCircle, \n  AlertTriangle,\n  MapPin,\n  Calendar,\n  Filter,\n  BarChart3,\n  PieChart as PieChartIcon,\n  Activity,\n  Target,\n  Zap,\n  Award,\n  RefreshCcw,\n  Download,\n  Settings,\n  Building,\n  ClipboardList\n} from \"lucide-react\";\n\ninterface DashboardProps {\n  companyId: string;\n}\n\nexport default function Dashboard({ companyId }: DashboardProps) {\n  const [dateRange, setDateRange] = React.useState<any>(null);\n  const [selectedSite, setSelectedSite] = React.useState<string>(\"todos\");\n  const [selectedPeriod, setSelectedPeriod] = React.useState<string>(\"hoje\");\n\n  // Queries\n  const { data: stats, isLoading: statsLoading } = useQuery({\n    queryKey: [\"/api/companies\", companyId, \"dashboard-stats\"],\n    enabled: !!companyId,\n  });\n\n  const { data: workOrders } = useQuery({\n    queryKey: [\"/api/companies\", companyId, \"work-orders\"],\n    enabled: !!companyId,\n  });\n\n  const { data: sites } = useQuery({\n    queryKey: [\"/api/companies\", companyId, \"sites\"],\n    enabled: !!companyId,\n  });\n\n  // Mock data for charts (in production this would come from APIs)\n  const productivityData = [\n    { name: 'Seg', eficiencia: 85, sla: 92, qualidade: 88 },\n    { name: 'Ter', eficiencia: 88, sla: 85, qualidade: 91 },\n    { name: 'Qua', eficiencia: 92, sla: 89, qualidade: 89 },\n    { name: 'Qui', eficiencia: 87, sla: 94, qualidade: 92 },\n    { name: 'Sex', eficiencia: 90, sla: 88, qualidade: 90 },\n    { name: 'Sáb', eficiencia: 78, sla: 82, qualidade: 85 },\n    { name: 'Dom', eficiencia: 75, sla: 79, qualidade: 83 }\n  ];\n\n  const statusDistribution = [\n    { name: 'Concluídas', value: 68, color: '#10b981' },\n    { name: 'Em Andamento', value: 22, color: '#3b82f6' },\n    { name: 'Pendentes', value: 7, color: '#f59e0b' },\n    { name: 'Atrasadas', value: 3, color: '#ef4444' }\n  ];\n\n  const sitePerformance = [\n    { site: 'Escritório Administrativo', os_concluidas: 45, eficiencia: 87, sla: 92 },\n    { site: 'Fábrica Principal', os_concluidas: 68, eficiencia: 75, sla: 88 },\n    { site: 'Centro Logístico', os_concluidas: 32, eficiencia: 93, sla: 95 },\n    { site: 'Laboratório', os_concluidas: 24, eficiencia: 89, sla: 91 }\n  ];\n\n  const monthlyTrend = [\n    { mes: 'Jan', os_total: 320, os_concluidas: 298, sla_medio: 89 },\n    { mes: 'Fev', os_total: 285, os_concluidas: 267, sla_medio: 91 },\n    { mes: 'Mar', os_total: 310, os_concluidas: 295, sla_medio: 88 },\n    { mes: 'Abr', os_total: 298, os_concluidas: 287, sla_medio: 92 },\n    { mes: 'Mai', os_total: 325, os_concluidas: 312, sla_medio: 94 },\n    { mes: 'Jun', os_total: 342, os_concluidas: 324, sla_medio: 92 }\n  ];\n\n  if (statsLoading) {\n    return (\n      <div className=\"flex-1 flex items-center justify-center bg-gradient-to-br from-slate-50 to-slate-100\">\n        <div className=\"text-center\">\n          <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4\"></div>\n          <p className=\"text-muted-foreground\">Carregando dashboard...</p>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50\">\n      {/* Modern Header */}\n      <div className=\"bg-white border-b border-slate-200 shadow-sm\">\n        <div className=\"px-6 py-4\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center space-x-4\">\n              <div className=\"flex items-center space-x-3\">\n                <div className=\"w-10 h-10 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-lg flex items-center justify-center\">\n                  <BarChart3 className=\"w-6 h-6 text-white\" />\n                </div>\n                <div>\n                  <h1 className=\"text-2xl font-bold text-slate-900\">Dashboard Analytics</h1>\n                  <p className=\"text-sm text-slate-600\">Visão geral das operações em tempo real</p>\n                </div>\n              </div>\n            </div>\n            \n            {/* Filters and Controls */}\n            <div className=\"flex items-center space-x-3\">\n              <Select value={selectedPeriod} onValueChange={setSelectedPeriod}>\n                <SelectTrigger className=\"w-36\">\n                  <Calendar className=\"w-4 h-4 mr-2\" />\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"hoje\">Hoje</SelectItem>\n                  <SelectItem value=\"ontem\">Ontem</SelectItem>\n                  <SelectItem value=\"semana\">Esta Semana</SelectItem>\n                  <SelectItem value=\"mes\">Este Mês</SelectItem>\n                  <SelectItem value=\"trimestre\">Trimestre</SelectItem>\n                </SelectContent>\n              </Select>\n\n              <Select value={selectedSite} onValueChange={setSelectedSite}>\n                <SelectTrigger className=\"w-48\">\n                  <Building className=\"w-4 h-4 mr-2\" />\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"todos\">Todas as Unidades</SelectItem>\n                  {(sites as any[] || []).map((site: any) => (\n                    <SelectItem key={site.id} value={site.id}>\n                      {site.name}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n\n              <Button variant=\"outline\" size=\"sm\">\n                <RefreshCcw className=\"w-4 h-4 mr-2\" />\n                Atualizar\n              </Button>\n\n              <Button variant=\"outline\" size=\"sm\">\n                <Download className=\"w-4 h-4 mr-2\" />\n                Exportar\n              </Button>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {/* Main Content */}\n      <div className=\"p-6 space-y-6\">\n        {/* KPI Cards Row */}\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6\">\n          {/* Eficiência Operacional */}\n          <Card className=\"bg-gradient-to-br from-emerald-50 to-emerald-100 border-emerald-200\">\n            <CardContent className=\"p-6\">\n              <div className=\"flex items-center justify-between\">\n                <div className=\"space-y-2\">\n                  <p className=\"text-sm font-medium text-emerald-700\">Eficiência Operacional</p>\n                  <div className=\"flex items-baseline space-x-2\">\n                    <span className=\"text-3xl font-bold text-emerald-900\">87.5%</span>\n                    <div className=\"flex items-center text-sm text-emerald-600\">\n                      <TrendingUp className=\"w-4 h-4 mr-1\" />\n                      +5.2%\n                    </div>\n                  </div>\n                  <p className=\"text-xs text-emerald-600\">vs. semana anterior</p>\n                </div>\n                <div className=\"w-12 h-12 bg-emerald-500 rounded-full flex items-center justify-center\">\n                  <Target className=\"w-6 h-6 text-white\" />\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* SLA Compliance */}\n          <Card className=\"bg-gradient-to-br from-blue-50 to-blue-100 border-blue-200\">\n            <CardContent className=\"p-6\">\n              <div className=\"flex items-center justify-between\">\n                <div className=\"space-y-2\">\n                  <p className=\"text-sm font-medium text-blue-700\">SLA Compliance</p>\n                  <div className=\"flex items-baseline space-x-2\">\n                    <span className=\"text-3xl font-bold text-blue-900\">92.3%</span>\n                    <div className=\"flex items-center text-sm text-blue-600\">\n                      <TrendingUp className=\"w-4 h-4 mr-1\" />\n                      +2.1%\n                    </div>\n                  </div>\n                  <p className=\"text-xs text-blue-600\">meta: 90%</p>\n                </div>\n                <div className=\"w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center\">\n                  <Clock className=\"w-6 h-6 text-white\" />\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Ordens de Serviço */}\n          <Card className=\"bg-gradient-to-br from-purple-50 to-purple-100 border-purple-200\">\n            <CardContent className=\"p-6\">\n              <div className=\"flex items-center justify-between\">\n                <div className=\"space-y-2\">\n                  <p className=\"text-sm font-medium text-purple-700\">OS Concluídas Hoje</p>\n                  <div className=\"flex items-baseline space-x-2\">\n                    <span className=\"text-3xl font-bold text-purple-900\">156</span>\n                    <div className=\"flex items-center text-sm text-red-600\">\n                      <TrendingDown className=\"w-4 h-4 mr-1\" />\n                      -3.2%\n                    </div>\n                  </div>\n                  <p className=\"text-xs text-purple-600\">de 169 programadas</p>\n                </div>\n                <div className=\"w-12 h-12 bg-purple-500 rounded-full flex items-center justify-center\">\n                  <ClipboardList className=\"w-6 h-6 text-white\" />\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Qualidade */}\n          <Card className=\"bg-gradient-to-br from-orange-50 to-orange-100 border-orange-200\">\n            <CardContent className=\"p-6\">\n              <div className=\"flex items-center justify-between\">\n                <div className=\"space-y-2\">\n                  <p className=\"text-sm font-medium text-orange-700\">Índice de Qualidade</p>\n                  <div className=\"flex items-baseline space-x-2\">\n                    <span className=\"text-3xl font-bold text-orange-900\">9.1/10</span>\n                    <div className=\"flex items-center text-sm text-orange-600\">\n                      <TrendingUp className=\"w-4 h-4 mr-1\" />\n                      +0.3\n                    </div>\n                  </div>\n                  <p className=\"text-xs text-orange-600\">avaliações do mês</p>\n                </div>\n                <div className=\"w-12 h-12 bg-orange-500 rounded-full flex items-center justify-center\">\n                  <Award className=\"w-6 h-6 text-white\" />\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* Charts Grid */}\n        <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n          {/* Performance Chart */}\n          <Card className=\"lg:col-span-2\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center space-x-2\">\n                <BarChart3 className=\"w-5 h-5 text-blue-600\" />\n                <span>Performance Semanal</span>\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <ResponsiveContainer width=\"100%\" height={300}>\n                <BarChart data={productivityData}>\n                  <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#e2e8f0\" />\n                  <XAxis dataKey=\"name\" stroke=\"#64748b\" />\n                  <YAxis stroke=\"#64748b\" />\n                  <Tooltip \n                    contentStyle={{ \n                      backgroundColor: '#ffffff', \n                      border: '1px solid #e2e8f0',\n                      borderRadius: '8px',\n                      boxShadow: '0 10px 25px rgba(0,0,0,0.1)'\n                    }} \n                  />\n                  <Legend />\n                  <Bar dataKey=\"eficiencia\" fill=\"#3b82f6\" name=\"Eficiência %\" radius={[4, 4, 0, 0]} />\n                  <Bar dataKey=\"sla\" fill=\"#10b981\" name=\"SLA %\" radius={[4, 4, 0, 0]} />\n                  <Bar dataKey=\"qualidade\" fill=\"#f59e0b\" name=\"Qualidade %\" radius={[4, 4, 0, 0]} />\n                </BarChart>\n              </ResponsiveContainer>\n            </CardContent>\n          </Card>\n\n          {/* Status Distribution */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center space-x-2\">\n                <PieChartIcon className=\"w-5 h-5 text-green-600\" />\n                <span>Status das OS</span>\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <ResponsiveContainer width=\"100%\" height={300}>\n                <PieChart>\n                  <Pie\n                    data={statusDistribution}\n                    cx=\"50%\"\n                    cy=\"50%\"\n                    innerRadius={60}\n                    outerRadius={120}\n                    paddingAngle={5}\n                    dataKey=\"value\"\n                  >\n                    {statusDistribution.map((entry, index) => (\n                      <Cell key={`cell-${index}`} fill={entry.color} />\n                    ))}\n                  </Pie>\n                  <Tooltip \n                    formatter={(value) => [`${value}%`, 'Percentual']}\n                    contentStyle={{ \n                      backgroundColor: '#ffffff', \n                      border: '1px solid #e2e8f0',\n                      borderRadius: '8px'\n                    }} \n                  />\n                </PieChart>\n              </ResponsiveContainer>\n              <div className=\"mt-4 space-y-2\">\n                {statusDistribution.map((item, index) => (\n                  <div key={index} className=\"flex items-center justify-between\">\n                    <div className=\"flex items-center space-x-2\">\n                      <div \n                        className=\"w-3 h-3 rounded-full\" \n                        style={{ backgroundColor: item.color }}\n                      ></div>\n                      <span className=\"text-sm text-slate-600\">{item.name}</span>\n                    </div>\n                    <span className=\"text-sm font-medium\">{item.value}%</span>\n                  </div>\n                ))}\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* Site Performance and Trends */}\n        <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n          {/* Site Performance */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center space-x-2\">\n                <Building className=\"w-5 h-5 text-purple-600\" />\n                <span>Performance por Unidade</span>\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <ResponsiveContainer width=\"100%\" height={300}>\n                <BarChart data={sitePerformance} layout=\"horizontal\">\n                  <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#e2e8f0\" />\n                  <XAxis type=\"number\" stroke=\"#64748b\" />\n                  <YAxis dataKey=\"site\" type=\"category\" width={120} stroke=\"#64748b\" />\n                  <Tooltip \n                    contentStyle={{ \n                      backgroundColor: '#ffffff', \n                      border: '1px solid #e2e8f0',\n                      borderRadius: '8px'\n                    }} \n                  />\n                  <Bar dataKey=\"os_concluidas\" fill=\"#8b5cf6\" name=\"OS Concluídas\" radius={[0, 4, 4, 0]} />\n                </BarChart>\n              </ResponsiveContainer>\n            </CardContent>\n          </Card>\n\n          {/* Monthly Trend */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center space-x-2\">\n                <Activity className=\"w-5 h-5 text-indigo-600\" />\n                <span>Tendência Mensal</span>\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <ResponsiveContainer width=\"100%\" height={300}>\n                <AreaChart data={monthlyTrend}>\n                  <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#e2e8f0\" />\n                  <XAxis dataKey=\"mes\" stroke=\"#64748b\" />\n                  <YAxis stroke=\"#64748b\" />\n                  <Tooltip \n                    contentStyle={{ \n                      backgroundColor: '#ffffff', \n                      border: '1px solid #e2e8f0',\n                      borderRadius: '8px'\n                    }} \n                  />\n                  <Area \n                    type=\"monotone\" \n                    dataKey=\"os_total\" \n                    stackId=\"1\" \n                    stroke=\"#6366f1\" \n                    fill=\"#6366f1\" \n                    fillOpacity={0.6}\n                    name=\"OS Total\"\n                  />\n                  <Area \n                    type=\"monotone\" \n                    dataKey=\"os_concluidas\" \n                    stackId=\"2\" \n                    stroke=\"#10b981\" \n                    fill=\"#10b981\" \n                    fillOpacity={0.8}\n                    name=\"OS Concluídas\"\n                  />\n                </AreaChart>\n              </ResponsiveContainer>\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* Quick Actions and Alerts */}\n        <div className=\"grid grid-cols-1 lg:grid-cols-4 gap-6\">\n          {/* Alertas Críticos */}\n          <Card className=\"lg:col-span-3\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center space-x-2\">\n                <AlertTriangle className=\"w-5 h-5 text-red-600\" />\n                <span>Alertas e Notificações</span>\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"space-y-3\">\n                <div className=\"flex items-center space-x-3 p-3 bg-red-50 border border-red-200 rounded-lg\">\n                  <div className=\"w-2 h-2 bg-red-500 rounded-full animate-pulse\"></div>\n                  <div className=\"flex-1\">\n                    <p className=\"text-sm font-medium text-red-900\">SLA Crítico - Banheiro Administrativo</p>\n                    <p className=\"text-xs text-red-600\">Vencido há 2h 15min • OS #4521</p>\n                  </div>\n                  <Badge variant=\"destructive\">Crítico</Badge>\n                </div>\n                \n                <div className=\"flex items-center space-x-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg\">\n                  <div className=\"w-2 h-2 bg-yellow-500 rounded-full\"></div>\n                  <div className=\"flex-1\">\n                    <p className=\"text-sm font-medium text-yellow-900\">Operador Ausente - Turno Noite</p>\n                    <p className=\"text-xs text-yellow-600\">Maria Santos não marcou presença • Site Produção</p>\n                  </div>\n                  <Badge className=\"bg-yellow-500 text-white\">Atenção</Badge>\n                </div>\n\n                <div className=\"flex items-center space-x-3 p-3 bg-blue-50 border border-blue-200 rounded-lg\">\n                  <div className=\"w-2 h-2 bg-blue-500 rounded-full\"></div>\n                  <div className=\"flex-1\">\n                    <p className=\"text-sm font-medium text-blue-900\">Meta de Eficiência Atingida</p>\n                    <p className=\"text-xs text-blue-600\">Centro Logístico superou 95% • Parabéns!</p>\n                  </div>\n                  <Badge className=\"bg-blue-500 text-white\">Sucesso</Badge>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Quick Actions */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-lg\">Ações Rápidas</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-3\">\n              <Button className=\"w-full justify-start\" variant=\"outline\">\n                <ClipboardList className=\"w-4 h-4 mr-2\" />\n                Nova OS\n              </Button>\n              <Button className=\"w-full justify-start\" variant=\"outline\">\n                <Users className=\"w-4 h-4 mr-2\" />\n                Operadores\n              </Button>\n              <Button className=\"w-full justify-start\" variant=\"outline\">\n                <MapPin className=\"w-4 h-4 mr-2\" />\n                Planta da Unidade\n              </Button>\n              <Button className=\"w-full justify-start\" variant=\"outline\">\n                <Settings className=\"w-4 h-4 mr-2\" />\n                Configurações\n              </Button>\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n    </div>\n  );\n}","size_bytes":20821},"client/src/hooks/usePermissions.ts":{"content":"import { useState, useEffect, useMemo } from 'react';\nimport { useAuth } from './useAuth';\nimport { useQuery } from '@tanstack/react-query';\n\nexport type PermissionKey = \n  | 'dashboard_view'\n  | 'workorders_view' | 'workorders_create' | 'workorders_edit' | 'workorders_delete' | 'workorders_comment' | 'workorders_evaluate'\n  | 'schedule_view' | 'schedule_create' | 'schedule_edit' | 'schedule_delete'\n  | 'checklists_view' | 'checklists_create' | 'checklists_edit' | 'checklists_delete'\n  | 'qrcodes_view' | 'qrcodes_create' | 'qrcodes_edit' | 'qrcodes_delete'\n  | 'floor_plan_view' | 'floor_plan_edit'\n  | 'heatmap_view'\n  | 'sites_view' | 'sites_create' | 'sites_edit' | 'sites_delete'\n  | 'users_view' | 'users_create' | 'users_edit' | 'users_delete'\n  | 'customers_view' | 'customers_create' | 'customers_edit' | 'customers_delete'\n  | 'reports_view'\n  | 'audit_logs_view'\n  | 'service_settings_view' | 'service_settings_edit'\n  | 'roles_manage'\n  | 'opus_users_view' | 'opus_users_create' | 'opus_users_edit' | 'opus_users_delete'\n  | 'client_users_view' | 'client_users_create' | 'client_users_edit' | 'client_users_delete';\n\nexport interface CustomRole {\n  id: string;\n  companyId: string;\n  name: string;\n  description?: string;\n  isSystemRole: boolean;\n  isActive: boolean;\n  permissions: PermissionKey[];\n}\n\nexport interface UserRoleAssignment {\n  id: string;\n  userId: string;\n  roleId: string;\n  customerId?: string;\n  role: CustomRole;\n}\n\nexport function usePermissions() {\n  const { user, isAuthenticated } = useAuth();\n\n  // Buscar roles e permissões do usuário\n  const { data: userRoles = [], isLoading } = useQuery<UserRoleAssignment[]>({\n    queryKey: ['/api/users', user?.id, 'roles'],\n    enabled: !!user?.id && isAuthenticated,\n  });\n\n  // Calcular permissões consolidadas\n  const permissions = useMemo(() => {\n    if (!userRoles.length) return new Set<PermissionKey>();\n    \n    const allPermissions = new Set<PermissionKey>();\n    \n    userRoles.forEach((assignment: UserRoleAssignment) => {\n      assignment.role.permissions.forEach(permission => {\n        allPermissions.add(permission);\n      });\n    });\n    \n    return allPermissions;\n  }, [userRoles]);\n\n  // Função para verificar permissão específica\n  const hasPermission = (permission: PermissionKey, customerId?: string): boolean => {\n    if (!isAuthenticated || !user) return false;\n    \n    // Admin sempre tem todas as permissões\n    if (user.role === 'admin') return true;\n    \n    // Se especificou cliente, verificar permissões específicas\n    if (customerId) {\n      const customerSpecificRole = userRoles.find(\n        (assignment: UserRoleAssignment) => assignment.customerId === customerId\n      );\n      if (customerSpecificRole) {\n        return customerSpecificRole.role.permissions.includes(permission);\n      }\n    }\n    \n    // Verificar permissões gerais\n    return permissions.has(permission);\n  };\n\n  // Funções de conveniência para cada área do sistema\n  const can = {\n    // Dashboard\n    viewDashboard: (customerId?: string) => hasPermission('dashboard_view', customerId),\n    \n    // Ordens de Serviço\n    viewWorkOrders: (customerId?: string) => hasPermission('workorders_view', customerId),\n    createWorkOrders: (customerId?: string) => hasPermission('workorders_create', customerId),\n    editWorkOrders: (customerId?: string) => hasPermission('workorders_edit', customerId),\n    deleteWorkOrders: (customerId?: string) => hasPermission('workorders_delete', customerId),\n    commentWorkOrders: (customerId?: string) => hasPermission('workorders_comment', customerId),\n    evaluateWorkOrders: (customerId?: string) => hasPermission('workorders_evaluate', customerId),\n    \n    // Plano de Limpeza\n    viewSchedule: (customerId?: string) => hasPermission('schedule_view', customerId),\n    createSchedule: (customerId?: string) => hasPermission('schedule_create', customerId),\n    editSchedule: (customerId?: string) => hasPermission('schedule_edit', customerId),\n    deleteSchedule: (customerId?: string) => hasPermission('schedule_delete', customerId),\n    \n    // Checklists\n    viewChecklists: (customerId?: string) => hasPermission('checklists_view', customerId),\n    createChecklists: (customerId?: string) => hasPermission('checklists_create', customerId),\n    editChecklists: (customerId?: string) => hasPermission('checklists_edit', customerId),\n    deleteChecklists: (customerId?: string) => hasPermission('checklists_delete', customerId),\n    \n    // QR Codes\n    viewQRCodes: (customerId?: string) => hasPermission('qrcodes_view', customerId),\n    createQRCodes: (customerId?: string) => hasPermission('qrcodes_create', customerId),\n    editQRCodes: (customerId?: string) => hasPermission('qrcodes_edit', customerId),\n    deleteQRCodes: (customerId?: string) => hasPermission('qrcodes_delete', customerId),\n    \n    // Planta dos Locais\n    viewFloorPlan: (customerId?: string) => hasPermission('floor_plan_view', customerId),\n    editFloorPlan: (customerId?: string) => hasPermission('floor_plan_edit', customerId),\n    \n    // Mapa de Calor\n    viewHeatmap: (customerId?: string) => hasPermission('heatmap_view', customerId),\n    \n    // Sites\n    viewSites: (customerId?: string) => hasPermission('sites_view', customerId),\n    createSites: (customerId?: string) => hasPermission('sites_create', customerId),\n    editSites: (customerId?: string) => hasPermission('sites_edit', customerId),\n    deleteSites: (customerId?: string) => hasPermission('sites_delete', customerId),\n    \n    // Usuários\n    viewUsers: (customerId?: string) => hasPermission('users_view', customerId),\n    createUsers: (customerId?: string) => hasPermission('users_create', customerId),\n    editUsers: (customerId?: string) => hasPermission('users_edit', customerId),\n    deleteUsers: (customerId?: string) => hasPermission('users_delete', customerId),\n    \n    // Usuários OPUS (funcionários da empresa)\n    viewOpusUsers: () => hasPermission('opus_users_view'),\n    createOpusUsers: () => hasPermission('opus_users_create'),\n    editOpusUsers: () => hasPermission('opus_users_edit'),\n    deleteOpusUsers: () => hasPermission('opus_users_delete'),\n    \n    // Usuários de Cliente\n    viewClientUsers: (customerId?: string) => hasPermission('client_users_view', customerId),\n    createClientUsers: (customerId?: string) => hasPermission('client_users_create', customerId),\n    editClientUsers: (customerId?: string) => hasPermission('client_users_edit', customerId),\n    deleteClientUsers: (customerId?: string) => hasPermission('client_users_delete', customerId),\n    \n    // Clientes (apenas admin)\n    viewCustomers: () => user?.role === 'admin' && hasPermission('customers_view'),\n    createCustomers: () => user?.role === 'admin' && hasPermission('customers_create'),\n    editCustomers: () => user?.role === 'admin' && hasPermission('customers_edit'),\n    deleteCustomers: () => user?.role === 'admin' && hasPermission('customers_delete'),\n    \n    // Relatórios\n    viewReports: (customerId?: string) => hasPermission('reports_view', customerId),\n    \n    // Logs de Auditoria\n    viewAuditLogs: (customerId?: string) => hasPermission('audit_logs_view', customerId),\n    \n    // Configurações de Serviço\n    viewServiceSettings: (customerId?: string) => hasPermission('service_settings_view', customerId),\n    editServiceSettings: (customerId?: string) => hasPermission('service_settings_edit', customerId),\n    \n    // Gerenciamento de Roles (apenas super admin)\n    manageRoles: () => hasPermission('roles_manage'),\n    \n    // Verificar se é SUPER ADMIN (tem todas as permissões incluindo roles_manage)\n    isSuperAdmin: () => hasPermission('roles_manage'),\n\n    // === FUNÇÕES DE ACESSO ÀS ÁREAS ===\n    // Estas verificam se o usuário pode acessar uma área específica do sistema\n    \n    // Área: Dashboard\n    canAccessDashboard: (customerId?: string) => hasPermission('dashboard_view', customerId),\n    \n    // Área: Ordens de Serviço\n    canAccessWorkOrders: (customerId?: string) => hasPermission('workorders_view', customerId),\n    \n    // Área: Plano de Limpeza\n    canAccessSchedule: (customerId?: string) => hasPermission('schedule_view', customerId),\n    \n    // Área: Checklists\n    canAccessChecklists: (customerId?: string) => hasPermission('checklists_view', customerId),\n    \n    // Área: QR Codes\n    canAccessQRCodes: (customerId?: string) => hasPermission('qrcodes_view', customerId),\n    \n    // Área: Planta dos Locais\n    canAccessFloorPlan: (customerId?: string) => hasPermission('floor_plan_view', customerId),\n    \n    // Área: Mapa de Calor\n    canAccessHeatmap: (customerId?: string) => hasPermission('heatmap_view', customerId),\n    \n    // Área: Sites/Locais\n    canAccessSites: (customerId?: string) => hasPermission('sites_view', customerId),\n    \n    // Área: Usuários (geral - para clientes)\n    canAccessUsers: (customerId?: string) => hasPermission('users_view', customerId),\n    \n    // Área: Usuários OPUS (funcionários da empresa OPUS)\n    canAccessOpusUsers: () => hasPermission('opus_users_view'),\n    \n    // Área: Usuários de Cliente\n    canAccessClientUsers: (customerId?: string) => hasPermission('client_users_view', customerId),\n    \n    // Área: Clientes (apenas admin OPUS)\n    canAccessCustomers: () => user?.role === 'admin' && hasPermission('customers_view'),\n    \n    // Área: Relatórios\n    canAccessReports: (customerId?: string) => hasPermission('reports_view', customerId),\n    \n    // Área: Logs de Auditoria\n    canAccessAuditLogs: (customerId?: string) => hasPermission('audit_logs_view', customerId),\n    \n    // Área: Configurações de Serviço\n    canAccessSettings: (customerId?: string) => hasPermission('service_settings_view', customerId),\n    \n    // Área: Gerenciamento de Funções/Roles\n    canAccessRoles: () => hasPermission('roles_manage'),\n  };\n\n  // Lista de todas as permissões disponíveis\n  const availablePermissions: { key: PermissionKey; label: string; category: string }[] = [\n    // Dashboard\n    { key: 'dashboard_view', label: 'Visualizar Dashboard', category: 'Dashboard' },\n    \n    // Ordens de Serviço\n    { key: 'workorders_view', label: 'Visualizar Ordens de Serviço', category: 'Ordens de Serviço' },\n    { key: 'workorders_create', label: 'Criar Ordens de Serviço', category: 'Ordens de Serviço' },\n    { key: 'workorders_edit', label: 'Editar Ordens de Serviço', category: 'Ordens de Serviço' },\n    { key: 'workorders_delete', label: 'Excluir Ordens de Serviço', category: 'Ordens de Serviço' },\n    { key: 'workorders_comment', label: 'Comentar em Ordens de Serviço', category: 'Ordens de Serviço' },\n    { key: 'workorders_evaluate', label: 'Avaliar Ordens de Serviço', category: 'Ordens de Serviço' },\n    \n    // Plano de Limpeza\n    { key: 'schedule_view', label: 'Visualizar Plano de Limpeza', category: 'Plano de Limpeza' },\n    { key: 'schedule_create', label: 'Criar Plano de Limpeza', category: 'Plano de Limpeza' },\n    { key: 'schedule_edit', label: 'Editar Plano de Limpeza', category: 'Plano de Limpeza' },\n    { key: 'schedule_delete', label: 'Excluir Plano de Limpeza', category: 'Plano de Limpeza' },\n    \n    // Checklists\n    { key: 'checklists_view', label: 'Visualizar Checklists', category: 'Checklists' },\n    { key: 'checklists_create', label: 'Criar Checklists', category: 'Checklists' },\n    { key: 'checklists_edit', label: 'Editar Checklists', category: 'Checklists' },\n    { key: 'checklists_delete', label: 'Excluir Checklists', category: 'Checklists' },\n    \n    // QR Codes\n    { key: 'qrcodes_view', label: 'Visualizar QR Codes', category: 'QR Codes' },\n    { key: 'qrcodes_create', label: 'Criar QR Codes', category: 'QR Codes' },\n    { key: 'qrcodes_edit', label: 'Editar QR Codes', category: 'QR Codes' },\n    { key: 'qrcodes_delete', label: 'Excluir QR Codes', category: 'QR Codes' },\n    \n    // Planta dos Locais\n    { key: 'floor_plan_view', label: 'Visualizar Planta dos Locais', category: 'Planta dos Locais' },\n    { key: 'floor_plan_edit', label: 'Editar Planta dos Locais', category: 'Planta dos Locais' },\n    \n    // Mapa de Calor\n    { key: 'heatmap_view', label: 'Visualizar Mapa de Calor', category: 'Mapa de Calor' },\n    \n    // Locais\n    { key: 'sites_view', label: 'Visualizar Locais', category: 'Locais' },\n    { key: 'sites_create', label: 'Criar Locais', category: 'Locais' },\n    { key: 'sites_edit', label: 'Editar Locais', category: 'Locais' },\n    { key: 'sites_delete', label: 'Excluir Locais', category: 'Locais' },\n    \n    // Usuários\n    { key: 'users_view', label: 'Visualizar Usuários', category: 'Usuários' },\n    { key: 'users_create', label: 'Criar Usuários', category: 'Usuários' },\n    { key: 'users_edit', label: 'Editar Usuários', category: 'Usuários' },\n    { key: 'users_delete', label: 'Excluir Usuários', category: 'Usuários' },\n    \n    // Clientes\n    { key: 'customers_view', label: 'Visualizar Clientes', category: 'Clientes' },\n    { key: 'customers_create', label: 'Criar Clientes', category: 'Clientes' },\n    { key: 'customers_edit', label: 'Editar Clientes', category: 'Clientes' },\n    { key: 'customers_delete', label: 'Excluir Clientes', category: 'Clientes' },\n    \n    // Relatórios\n    { key: 'reports_view', label: 'Visualizar Relatórios', category: 'Relatórios' },\n    \n    // Logs de Auditoria\n    { key: 'audit_logs_view', label: 'Visualizar Logs de Auditoria', category: 'Auditoria' },\n    \n    // Configurações\n    { key: 'service_settings_view', label: 'Visualizar Configurações', category: 'Configurações' },\n    { key: 'service_settings_edit', label: 'Editar Configurações', category: 'Configurações' },\n    \n    // Gerenciamento de Roles\n    { key: 'roles_manage', label: 'Gerenciar Funções', category: 'Administração' },\n    \n    // Usuários OPUS\n    { key: 'opus_users_view', label: 'Visualizar Usuários OPUS', category: 'Usuários OPUS' },\n    { key: 'opus_users_create', label: 'Criar Usuários OPUS', category: 'Usuários OPUS' },\n    { key: 'opus_users_edit', label: 'Editar Usuários OPUS', category: 'Usuários OPUS' },\n    { key: 'opus_users_delete', label: 'Excluir Usuários OPUS', category: 'Usuários OPUS' },\n    \n    // Usuários de Cliente\n    { key: 'client_users_view', label: 'Visualizar Usuários de Cliente', category: 'Usuários de Cliente' },\n    { key: 'client_users_create', label: 'Criar Usuários de Cliente', category: 'Usuários de Cliente' },\n    { key: 'client_users_edit', label: 'Editar Usuários de Cliente', category: 'Usuários de Cliente' },\n    { key: 'client_users_delete', label: 'Excluir Usuários de Cliente', category: 'Usuários de Cliente' },\n  ];\n\n  // Detectar se o usuário é \"mobile-only\" (Operador)\n  // Operadores têm apenas 4 permissões específicas e não devem acessar a web\n  const isMobileOnlyUser = useMemo(() => {\n    if (!isAuthenticated || !user) return false;\n    \n    // Admin nunca é mobile-only\n    if (user.role === 'admin') return false;\n    \n    // Se não tem custom roles, usar fallback do role enum\n    if (userRoles.length === 0) {\n      return user.role === 'operador';\n    }\n    \n    // Verificar se tem apenas permissões mobile (4 específicas)\n    const mobilePermissions: PermissionKey[] = ['dashboard_view', 'workorders_view', 'workorders_edit', 'checklists_view'];\n    const webOnlyPermissions: PermissionKey[] = [\n      'sites_view', 'users_view', 'customers_view', 'reports_view', \n      'audit_logs_view', 'roles_manage', 'opus_users_view', 'client_users_view',\n      'schedule_view', 'qrcodes_view', 'floor_plan_view', 'heatmap_view',\n      'service_settings_view'\n    ];\n    \n    // Se tem alguma permissão web, não é mobile-only\n    const hasWebPermissions = webOnlyPermissions.some(perm => permissions.has(perm));\n    if (hasWebPermissions) return false;\n    \n    // Se tem pelo menos 3 das 4 permissões mobile e nenhuma web, é mobile-only\n    const mobilePermCount = mobilePermissions.filter(perm => permissions.has(perm)).length;\n    return mobilePermCount >= 3;\n  }, [isAuthenticated, user, userRoles, permissions]);\n\n  return {\n    permissions,\n    userRoles,\n    hasPermission,\n    can,\n    availablePermissions,\n    isLoading,\n    isAuthenticated,\n    isMobileOnlyUser,\n  };\n}\n\nexport default usePermissions;","size_bytes":16314},"postcss.config.js":{"content":"export default {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {},\n  },\n}\n","size_bytes":80},"check-customers-vm.sh":{"content":"#!/bin/bash\necho \"🔍 VERIFICANDO CLIENTES\"\necho \"=====================\"\n\necho \"\"\necho \"1️⃣ Total de customers no banco:\"\npsql $DATABASE_URL -t -c \"SELECT COUNT(*) FROM customers;\" 2>/dev/null | xargs\n\necho \"\"\necho \"2️⃣ Lista de customers:\"\npsql $DATABASE_URL -c \"SELECT id, name, company_id FROM customers LIMIT 5;\" 2>/dev/null\n\necho \"\"\necho \"3️⃣ API de customers (deve retornar lista JSON):\"\ncurl -s http://localhost:3007/api/companies/company-opus-default/customers | head -100\n","size_bytes":494},"client/src/components/layout/sidebar.tsx":{"content":"import { useEffect } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport opusCleanLogo from \"@assets/ChatGPT Image 8 de set. de 2025, 18_10_10_1757366528566.png\";\nimport opusMaintenanceLogo from \"@assets/imagem_2025-11-04_222430878_1762305949679.png\";\nimport { \n  Building, \n  Calendar, \n  ChartBar, \n  ClipboardList, \n  Home, \n  QrCode, \n  Users, \n  LogOut,\n  Fan,\n  Map,\n  Menu,\n  X,\n  ChevronLeft,\n  Settings,\n  Shield,\n  Cog,\n  Activity,\n  TrendingUp,\n  Wrench,\n  List,\n  CalendarCheck,\n  Tag\n} from \"lucide-react\";\nimport { Link, useLocation } from \"wouter\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { logout } from \"@/lib/auth\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { usePermissions } from \"@/hooks/usePermissions\";\nimport { useClient } from \"@/contexts/ClientContext\";\nimport { useModule, MODULE_CONFIGS } from \"@/contexts/ModuleContext\";\n\ninterface SidebarProps {\n  isCollapsed: boolean;\n  onToggleCollapse: () => void;\n}\n\nexport default function Sidebar({ isCollapsed, onToggleCollapse }: SidebarProps) {\n  const [location, setLocation] = useLocation();\n  const { toast } = useToast();\n  const { user, canManageClients } = useAuth();\n  const { can } = usePermissions();\n  const { activeClientId, setActiveClientId, activeClient, customers } = useClient();\n  const { currentModule, setModule, moduleConfig, allowedModules, hasMultipleModules } = useModule();\n  \n  // Usuários do tipo customer_user não podem alterar o cliente\n  const isCustomerUser = user?.userType === 'customer_user';\n  \n  // Calcular módulos permitidos baseado na interseção entre módulos do usuário e do cliente ativo\n  const clientModules = (activeClient?.modules || []) as ('clean' | 'maintenance')[];\n  const effectiveAllowedModules = allowedModules.filter(module => clientModules.includes(module));\n  const effectiveHasMultipleModules = effectiveAllowedModules.length > 1;\n\n  // Auto-corrigir módulo quando cliente ativo mudar\n  useEffect(() => {\n    if (activeClient && effectiveAllowedModules.length > 0) {\n      // Se o módulo atual não está disponível para o cliente ativo, trocar para o primeiro disponível\n      if (!effectiveAllowedModules.includes(currentModule)) {\n        const newModule = effectiveAllowedModules[0];\n        console.log(`[SIDEBAR] Módulo ${currentModule} não disponível para cliente ${activeClient.name}. Trocando para ${newModule}`);\n        setModule(newModule);\n      }\n    }\n  }, [activeClient, effectiveAllowedModules, currentModule, setModule]);\n\n  const handleLogout = async () => {\n    try {\n      await logout();\n      toast({\n        title: \"Logout realizado\",\n        description: \"Você foi desconectado com sucesso.\",\n      });\n      // Forçar recarregamento da página para voltar ao login\n      window.location.reload();\n    } catch (error) {\n      toast({\n        title: \"Erro no logout\",\n        description: \"Houve um problema ao fazer logout.\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  // Criar menu baseado em permissões granulares e módulo atual\n  const menuItems = [\n    // Dashboard - sempre disponível se tiver acesso ao sistema\n    ...(can.viewDashboard(activeClientId) ? [{ path: \"/\", label: \"Dashboard\", icon: Home }] : []),\n    \n    // Ordens de Serviço\n    ...(can.viewWorkOrders(activeClientId) ? [{ path: \"/workorders\", label: \"Ordens de Serviço\", icon: ClipboardList }] : []),\n    \n    // OPUS Clean - Menu items específicos\n    ...(currentModule === 'clean' && can.viewSchedule(activeClientId) ? [{ path: \"/schedule\", label: \"Plano de Limpeza\", icon: Calendar }] : []),\n    ...(currentModule === 'clean' && can.viewChecklists(activeClientId) ? [{ path: \"/checklists\", label: \"Checklists\", icon: Fan }] : []),\n    \n    // OPUS Manutenção - Menu items específicos\n    ...(currentModule === 'maintenance' && can.viewQRCodes(activeClientId) ? [{ path: \"/equipment\", label: \"Equipamentos\", icon: Wrench }] : []),\n    ...(currentModule === 'maintenance' && can.viewSchedule(activeClientId) ? [{ path: \"/maintenance-plans\", label: \"Planos de Manutenção\", icon: CalendarCheck }] : []),\n    ...(currentModule === 'maintenance' && can.viewChecklists(activeClientId) ? [{ path: \"/maintenance-checklist-templates\", label: \"Checklists\", icon: List }] : []),\n    \n    // QR Codes - disponível em ambos os módulos\n    ...(can.viewQRCodes(activeClientId) ? [{ path: \"/qrcodes\", label: \"QR Codes\", icon: QrCode }] : []),\n    \n    // Planta dos Locais\n    ...(can.viewFloorPlan(activeClientId) ? [{ path: \"/floor-plan\", label: \"Planta dos Locais\", icon: Map }] : []),\n    \n    // Relatórios\n    ...(can.viewReports(activeClientId) ? [{ path: \"/reports\", label: \"Relatórios\", icon: ChartBar }] : []),\n    \n    // Usuários OPUS (apenas para quem tem permissão)\n    ...(can.viewOpusUsers() ? [{ path: \"/users\", label: \"Usuários OPUS\", icon: Users }] : []),\n    \n    // Clientes (apenas admin)\n    ...(can.viewCustomers() ? [{ path: \"/customers\", label: \"Clientes\", icon: Building }] : []),\n    \n    // Configurações do Sistema (contexto específico de cliente)\n    ...(activeClientId && can.viewServiceSettings(activeClientId) ? [{ path: \"/service-settings\", label: \"Configurações\", icon: Cog }] : []),\n    \n    // Funções (apenas super admin)\n    ...(can.manageRoles() ? [{ path: \"/roles\", label: \"Funções\", icon: Shield }] : []),\n  ];\n\n  return (\n    <div className={`${isCollapsed ? 'w-16' : 'w-64'} bg-gradient-to-b from-slate-50 via-white to-slate-50/50 border-r border-slate-200 shadow-lg flex flex-col transition-all duration-300`} data-testid=\"sidebar\">\n      {/* Header */}\n      <div className={`${isCollapsed ? 'p-5' : 'py-8 px-6'} border-b border-slate-200 relative bg-gradient-to-br from-white to-slate-100`}>\n        <div className=\"flex items-center justify-between\">\n          <div className={`flex items-center ${isCollapsed ? 'justify-center w-full' : 'justify-start'}`}>\n            <img \n              src={currentModule === 'maintenance' ? opusMaintenanceLogo : opusCleanLogo} \n              alt={currentModule === 'maintenance' ? 'OPUS FACILITY' : 'OPUS CLEAN'} \n              className={`${\n                currentModule === 'maintenance' \n                  ? (isCollapsed ? 'h-14 w-auto' : 'h-20 w-auto max-w-full')\n                  : (isCollapsed ? 'h-12 w-auto' : 'h-16 w-auto max-w-full')\n              } object-contain transition-all duration-300`}\n            />\n          </div>\n          {!isCollapsed && (\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={onToggleCollapse}\n              className=\"h-8 w-8 p-0 flex-shrink-0 hover:bg-primary/10 border border-border/50\"\n              data-testid=\"toggle-sidebar\"\n            >\n              <ChevronLeft className={`w-4 h-4 transition-transform text-foreground ${isCollapsed ? 'rotate-180' : ''}`} />\n            </Button>\n          )}\n          {isCollapsed && (\n            <div className=\"absolute top-2 right-2\">\n              <Button\n                variant=\"ghost\"\n                size=\"sm\"\n                onClick={onToggleCollapse}\n                className=\"h-6 w-6 p-0 flex-shrink-0 hover:bg-primary/10 border border-border/50\"\n                data-testid=\"toggle-sidebar\"\n              >\n                <ChevronLeft className={`w-3 h-3 transition-transform text-foreground rotate-180`} />\n              </Button>\n            </div>\n          )}\n        </div>\n      </div>\n\n      {/* Company Selector - apenas para admin/opus users */}\n      {!isCollapsed && !isCustomerUser && customers.length > 0 && (\n        <div className=\"px-6 pt-1 pb-3 border-b border-slate-200 bg-gradient-to-br from-slate-50 to-white\">\n          <label className=\"block text-sm font-semibold text-slate-700 mb-2\">Cliente Ativo</label>\n          <Select value={activeClientId} onValueChange={setActiveClientId}>\n            <SelectTrigger data-testid=\"company-selector\" className=\"bg-white shadow-sm border-slate-300 hover:border-slate-400 transition-colors\">\n              <SelectValue placeholder=\"Selecione um cliente\" />\n            </SelectTrigger>\n            <SelectContent>\n              {customers.map((customer) => (\n                <SelectItem key={customer.id} value={customer.id}>\n                  {customer.name}\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n        </div>\n      )}\n      \n      {/* Nome do Cliente fixo para customer_user */}\n      {!isCollapsed && isCustomerUser && activeClient && (\n        <div className=\"px-6 pt-1 pb-3 border-b border-slate-200 bg-gradient-to-br from-slate-50 to-white\">\n          <label className=\"block text-sm font-semibold text-slate-500 mb-2\">Cliente</label>\n          <div className=\"px-3 py-2 bg-gradient-to-br from-blue-50 to-slate-50 border border-blue-200 rounded-md shadow-sm\">\n            <p className=\"text-sm font-medium text-slate-700\">{activeClient.name}</p>\n          </div>\n        </div>\n      )}\n\n      {/* Module/Platform Selector - mostrar se o USUÁRIO tem múltiplos módulos */}\n      {!isCollapsed && hasMultipleModules && (\n        <div className=\"px-6 pt-1 pb-3 border-b border-slate-200 bg-gradient-to-br from-slate-50 to-white\">\n          <label className=\"block text-sm font-semibold text-slate-700 mb-2\">Plataforma</label>\n          <Select value={currentModule} onValueChange={(value) => setModule(value as 'clean' | 'maintenance')}>\n            <SelectTrigger data-testid=\"module-selector\" className=\"bg-white shadow-sm border-slate-300 hover:border-slate-400 transition-colors\">\n              <SelectValue />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"clean\" disabled={!effectiveAllowedModules.includes('clean')}>\n                <span className=\"flex items-center gap-2\">\n                  <Building className=\"w-4 h-4 text-blue-600\" />\n                  {MODULE_CONFIGS.clean.displayName}\n                </span>\n              </SelectItem>\n              <SelectItem value=\"maintenance\" disabled={!effectiveAllowedModules.includes('maintenance')}>\n                <span className=\"flex items-center gap-2\">\n                  <Cog className=\"w-4 h-4 text-orange-600\" />\n                  {MODULE_CONFIGS.maintenance.displayName}\n                </span>\n              </SelectItem>\n            </SelectContent>\n          </Select>\n        </div>\n      )}\n      \n      {/* Module Indicator - para usuários com módulo único */}\n      {!isCollapsed && !hasMultipleModules && (\n        <div className=\"px-6 pt-1 pb-3 border-b border-slate-200 bg-gradient-to-br from-slate-50 to-white\">\n          <label className=\"block text-sm font-semibold text-slate-500 mb-2\">Plataforma</label>\n          <div className={`px-3 py-2 border rounded-md shadow-sm ${\n            currentModule === 'maintenance'\n              ? 'bg-gradient-to-br from-orange-50 to-amber-50 border-orange-200'\n              : 'bg-gradient-to-br from-blue-50 to-slate-50 border-blue-200'\n          }`}>\n            <div className=\"flex items-center gap-2\">\n              {currentModule === 'maintenance' ? (\n                <Cog className=\"w-4 h-4 text-orange-600\" />\n              ) : (\n                <Building className=\"w-4 h-4 text-blue-600\" />\n              )}\n              <p className=\"text-sm font-medium text-slate-700\">\n                {MODULE_CONFIGS[currentModule].displayName}\n              </p>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Navigation */}\n      <nav className=\"flex-1 p-4 space-y-2\">\n        {menuItems.map((item) => {\n          const Icon = item.icon;\n          const isActive = location === item.path;\n          \n          // Gradiente baseado no módulo ativo\n          const activeGradient = currentModule === 'maintenance'\n            ? 'bg-gradient-to-r from-orange-500 to-amber-600 text-white shadow-md hover:shadow-lg'\n            : 'bg-gradient-to-r from-blue-600 to-cyan-600 text-white shadow-md hover:shadow-lg';\n          \n          return (\n            <Link key={item.path} href={item.path}>\n              <Button\n                variant={isActive ? \"default\" : \"ghost\"}\n                className={`w-full ${isCollapsed ? 'justify-center px-0' : 'justify-start space-x-3'} transition-all duration-200 ${\n                  isActive \n                    ? activeGradient\n                    : \"hover:bg-slate-100 hover:text-slate-900\"\n                }`}\n                data-testid={`nav-${item.path.slice(1) || 'dashboard'}`}\n                title={isCollapsed ? item.label : undefined}\n              >\n                <Icon className=\"w-5 h-5\" />\n                {!isCollapsed && <span className=\"font-medium\">{item.label}</span>}\n              </Button>\n            </Link>\n          );\n        })}\n      </nav>\n\n      {/* User Profile */}\n      <div className=\"p-4 border-t border-slate-200 bg-gradient-to-br from-slate-50 to-white\">\n        {isCollapsed ? (\n          <div className=\"flex justify-center\">\n            <div className=\"w-8 h-8 bg-secondary rounded-full flex items-center justify-center\">\n              <span className=\"text-sm font-medium text-secondary-foreground\">AD</span>\n            </div>\n          </div>\n        ) : (\n          <div className=\"flex items-center space-x-3 p-2\">\n            <div className=\"w-8 h-8 bg-secondary rounded-full flex items-center justify-center\">\n              <span className=\"text-sm font-medium text-secondary-foreground\">AD</span>\n            </div>\n            <div className=\"flex-1\">\n              <p className=\"text-sm font-medium text-foreground\">Administrador</p>\n              <p className=\"text-xs text-muted-foreground\">Admin</p>\n            </div>\n            <Button \n              variant=\"ghost\" \n              size=\"sm\" \n              onClick={handleLogout}\n              data-testid=\"logout-button\"\n              title=\"Sair\"\n            >\n              <LogOut className=\"w-4 h-4\" />\n            </Button>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n","size_bytes":14159},"client/src/components/ui/progress.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ProgressPrimitive from \"@radix-ui/react-progress\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Progress = React.forwardRef<\n  React.ElementRef<typeof ProgressPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>\n>(({ className, value, ...props }, ref) => (\n  <ProgressPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative h-4 w-full overflow-hidden rounded-full bg-secondary\",\n      className\n    )}\n    {...props}\n  >\n    <ProgressPrimitive.Indicator\n      className=\"h-full w-full flex-1 bg-primary transition-all\"\n      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}\n    />\n  </ProgressPrimitive.Root>\n))\nProgress.displayName = ProgressPrimitive.Root.displayName\n\nexport { Progress }\n","size_bytes":791},"client/src/components/ui/context-menu.tsx":{"content":"import * as React from \"react\"\nimport * as ContextMenuPrimitive from \"@radix-ui/react-context-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ContextMenu = ContextMenuPrimitive.Root\n\nconst ContextMenuTrigger = ContextMenuPrimitive.Trigger\n\nconst ContextMenuGroup = ContextMenuPrimitive.Group\n\nconst ContextMenuPortal = ContextMenuPrimitive.Portal\n\nconst ContextMenuSub = ContextMenuPrimitive.Sub\n\nconst ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup\n\nconst ContextMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <ContextMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </ContextMenuPrimitive.SubTrigger>\n))\nContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName\n\nconst ContextMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName\n\nconst ContextMenuContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Portal>\n    <ContextMenuPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"z-50 max-h-[--radix-context-menu-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md animate-in fade-in-80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </ContextMenuPrimitive.Portal>\n))\nContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName\n\nconst ContextMenuItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName\n\nconst ContextMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <ContextMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.CheckboxItem>\n))\nContextMenuCheckboxItem.displayName =\n  ContextMenuPrimitive.CheckboxItem.displayName\n\nconst ContextMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <ContextMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.RadioItem>\n))\nContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName\n\nconst ContextMenuLabel = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold text-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName\n\nconst ContextMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName\n\nconst ContextMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nContextMenuShortcut.displayName = \"ContextMenuShortcut\"\n\nexport {\n  ContextMenu,\n  ContextMenuTrigger,\n  ContextMenuContent,\n  ContextMenuItem,\n  ContextMenuCheckboxItem,\n  ContextMenuRadioItem,\n  ContextMenuLabel,\n  ContextMenuSeparator,\n  ContextMenuShortcut,\n  ContextMenuGroup,\n  ContextMenuPortal,\n  ContextMenuSub,\n  ContextMenuSubContent,\n  ContextMenuSubTrigger,\n  ContextMenuRadioGroup,\n}\n","size_bytes":7428},"tailwind.config.ts":{"content":"import type { Config } from \"tailwindcss\";\n\nexport default {\n  darkMode: [\"class\"],\n  content: [\"./client/index.html\", \"./client/src/**/*.{js,jsx,ts,tsx}\"],\n  theme: {\n    extend: {\n      borderRadius: {\n        lg: \"var(--radius)\",\n        md: \"calc(var(--radius) - 2px)\",\n        sm: \"calc(var(--radius) - 4px)\",\n      },\n      colors: {\n        background: \"var(--background)\",\n        foreground: \"var(--foreground)\",\n        card: {\n          DEFAULT: \"var(--card)\",\n          foreground: \"var(--card-foreground)\",\n        },\n        popover: {\n          DEFAULT: \"var(--popover)\",\n          foreground: \"var(--popover-foreground)\",\n        },\n        primary: {\n          DEFAULT: \"var(--primary)\",\n          foreground: \"var(--primary-foreground)\",\n        },\n        secondary: {\n          DEFAULT: \"var(--secondary)\",\n          foreground: \"var(--secondary-foreground)\",\n        },\n        muted: {\n          DEFAULT: \"var(--muted)\",\n          foreground: \"var(--muted-foreground)\",\n        },\n        accent: {\n          DEFAULT: \"var(--accent)\",\n          foreground: \"var(--accent-foreground)\",\n        },\n        destructive: {\n          DEFAULT: \"var(--destructive)\",\n          foreground: \"var(--destructive-foreground)\",\n        },\n        border: \"var(--border)\",\n        input: \"var(--input)\",\n        ring: \"var(--ring)\",\n        chart: {\n          \"1\": \"var(--chart-1)\",\n          \"2\": \"var(--chart-2)\",\n          \"3\": \"var(--chart-3)\",\n          \"4\": \"var(--chart-4)\",\n          \"5\": \"var(--chart-5)\",\n        },\n        sidebar: {\n          DEFAULT: \"var(--sidebar)\",\n          foreground: \"var(--sidebar-foreground)\",\n          primary: \"var(--sidebar-primary)\",\n          \"primary-foreground\": \"var(--sidebar-primary-foreground)\",\n          accent: \"var(--sidebar-accent)\",\n          \"accent-foreground\": \"var(--sidebar-accent-foreground)\",\n          border: \"var(--sidebar-border)\",\n          ring: \"var(--sidebar-ring)\",\n        },\n      },\n      fontFamily: {\n        sans: [\"var(--font-sans)\"],\n        serif: [\"var(--font-serif)\"],\n        mono: [\"var(--font-mono)\"],\n      },\n      keyframes: {\n        \"accordion-down\": {\n          from: {\n            height: \"0\",\n          },\n          to: {\n            height: \"var(--radix-accordion-content-height)\",\n          },\n        },\n        \"accordion-up\": {\n          from: {\n            height: \"var(--radix-accordion-content-height)\",\n          },\n          to: {\n            height: \"0\",\n          },\n        },\n      },\n      animation: {\n        \"accordion-down\": \"accordion-down 0.2s ease-out\",\n        \"accordion-up\": \"accordion-up 0.2s ease-out\",\n      },\n      rotate: {\n        '360': '360deg',\n      },\n    },\n  },\n  plugins: [require(\"tailwindcss-animate\"), require(\"@tailwindcss/typography\")],\n} satisfies Config;\n","size_bytes":2805},"client/src/components/mobile/ServiceSettingsMobile.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { \n  Tag, \n  Layers, \n  Settings as SettingsIcon, \n  Target, \n  Building, \n  Users as UsersIcon,\n  Plus,\n  Edit,\n  Trash2\n} from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport Sites from \"@/pages/sites\";\nimport Users from \"@/pages/users\";\nimport Services from \"@/pages/services\";\n\ninterface ServiceSettingsMobileProps {\n  customerId: string;\n}\n\n// Schemas para validação\nconst serviceTypeSchema = z.object({\n  name: z.string().min(1, \"Nome é obrigatório\"),\n  description: z.string().optional(),\n  code: z.string().min(1, \"Código é obrigatório\"),\n});\n\n// CATEGORIAS - FUNCIONALIDADE COMENTADA (MANTER PARA REFERÊNCIA FUTURA)\n/* const serviceCategorySchema = z.object({\n  name: z.string().min(1, \"Nome é obrigatório\"),\n  description: z.string().optional(),\n  code: z.string().min(1, \"Código é obrigatório\"),\n  typeId: z.string().min(1, \"Tipo é obrigatório\"),\n}); */\n\nconst dashboardGoalSchema = z.object({\n  goalType: z.string().min(1, \"Tipo de meta é obrigatório\"),\n  goalValue: z.string().min(1, \"Valor da meta é obrigatório\"),\n  currentPeriod: z.string().min(1, \"Período é obrigatório\"),\n});\n\nexport default function ServiceSettingsMobile({ customerId }: ServiceSettingsMobileProps) {\n  const [activeTab, setActiveTab] = useState(\"types\");\n  const [isTypeDialogOpen, setIsTypeDialogOpen] = useState(false);\n  // const [isCategoryDialogOpen, setIsCategoryDialogOpen] = useState(false); // CATEGORIAS - COMENTADO\n  const [isGoalDialogOpen, setIsGoalDialogOpen] = useState(false);\n  const [editingType, setEditingType] = useState<any>(null);\n  // const [editingCategory, setEditingCategory] = useState<any>(null); // CATEGORIAS - COMENTADO\n  const [editingGoal, setEditingGoal] = useState<any>(null);\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  // Invalidate cache when customer changes\n  useEffect(() => {\n    if (customerId) {\n      queryClient.invalidateQueries({ queryKey: [\"/api/customers\"] });\n    }\n  }, [customerId, queryClient]);\n\n  // Queries\n  const { data: serviceTypes = [], isLoading: loadingTypes } = useQuery({\n    queryKey: [\"/api/customers\", customerId, \"service-types\"],\n    enabled: !!customerId,\n  });\n\n  // CATEGORIAS - COMENTADO\n  /* const { data: serviceCategories = [], isLoading: loadingCategories } = useQuery({\n    queryKey: [\"/api/customers\", customerId, \"service-categories\"],\n    enabled: !!customerId,\n  }); */\n\n  const { data: dashboardGoals = [], isLoading: loadingGoals } = useQuery({\n    queryKey: [\"/api/customers\", customerId, \"dashboard-goals\"],\n    enabled: !!customerId,\n  });\n\n  // Forms\n  const typeForm = useForm({\n    resolver: zodResolver(serviceTypeSchema),\n    defaultValues: {\n      name: \"\",\n      description: \"\",\n      code: \"\",\n    },\n  });\n\n  // CATEGORIAS - COMENTADO\n  /* const categoryForm = useForm({\n    resolver: zodResolver(serviceCategorySchema),\n    defaultValues: {\n      name: \"\",\n      description: \"\",\n      code: \"\",\n      typeId: \"\",\n    },\n  }); */\n\n  const goalForm = useForm({\n    resolver: zodResolver(dashboardGoalSchema),\n    defaultValues: {\n      goalType: \"\",\n      goalValue: \"\",\n      currentPeriod: new Date().toISOString().slice(0, 7),\n    },\n  });\n\n  // Mutations - Types\n  const createTypeMutation = useMutation({\n    mutationFn: (data: any) => apiRequest(\"POST\", `/api/customers/${customerId}/service-types`, data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/customers\", customerId, \"service-types\"] });\n      setIsTypeDialogOpen(false);\n      typeForm.reset();\n      toast({ title: \"Tipo de serviço criado com sucesso!\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro ao criar tipo de serviço\", variant: \"destructive\" });\n    },\n  });\n\n  const updateTypeMutation = useMutation({\n    mutationFn: ({ id, data }: { id: string; data: any }) => \n      apiRequest(\"PUT\", `/api/customers/${customerId}/service-types/${id}`, data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/customers\", customerId, \"service-types\"] });\n      setIsTypeDialogOpen(false);\n      setEditingType(null);\n      typeForm.reset();\n      toast({ title: \"Tipo de serviço atualizado com sucesso!\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro ao atualizar tipo de serviço\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteTypeMutation = useMutation({\n    mutationFn: (id: string) => apiRequest(\"DELETE\", `/api/customers/${customerId}/service-types/${id}`),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/customers\", customerId, \"service-types\"] });\n      toast({ title: \"Tipo de serviço excluído com sucesso!\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro ao excluir tipo de serviço\", variant: \"destructive\" });\n    },\n  });\n\n  // CATEGORIAS - MUTATIONS COMENTADAS\n  /* const createCategoryMutation = useMutation({\n    mutationFn: (data: any) => apiRequest(\"POST\", `/api/customers/${customerId}/service-categories`, data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/customers\", customerId, \"service-categories\"] });\n      setIsCategoryDialogOpen(false);\n      categoryForm.reset();\n      toast({ title: \"Categoria criada com sucesso!\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro ao criar categoria\", variant: \"destructive\" });\n    },\n  });\n\n  const updateCategoryMutation = useMutation({\n    mutationFn: ({ id, data }: { id: string; data: any }) => \n      apiRequest(\"PUT\", `/api/customers/${customerId}/service-categories/${id}`, data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/customers\", customerId, \"service-categories\"] });\n      setIsCategoryDialogOpen(false);\n      setEditingCategory(null);\n      categoryForm.reset();\n      toast({ title: \"Categoria atualizada com sucesso!\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro ao atualizar categoria\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteCategoryMutation = useMutation({\n    mutationFn: (id: string) => apiRequest(\"DELETE\", `/api/customers/${customerId}/service-categories/${id}`),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/customers\", customerId, \"service-categories\"] });\n      toast({ title: \"Categoria excluída com sucesso!\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro ao excluir categoria\", variant: \"destructive\" });\n    },\n  }); */\n\n  // Mutations - Goals\n  const createGoalMutation = useMutation({\n    mutationFn: (data: any) => apiRequest(\"POST\", `/api/customers/${customerId}/dashboard-goals`, data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/customers\", customerId, \"dashboard-goals\"] });\n      setIsGoalDialogOpen(false);\n      goalForm.reset();\n      toast({ title: \"Meta criada com sucesso!\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro ao criar meta\", variant: \"destructive\" });\n    },\n  });\n\n  const updateGoalMutation = useMutation({\n    mutationFn: ({ id, data }: { id: string; data: any }) => \n      apiRequest(\"PUT\", `/api/customers/${customerId}/dashboard-goals/${id}`, data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/customers\", customerId, \"dashboard-goals\"] });\n      setIsGoalDialogOpen(false);\n      setEditingGoal(null);\n      goalForm.reset();\n      toast({ title: \"Meta atualizada com sucesso!\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro ao atualizar meta\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteGoalMutation = useMutation({\n    mutationFn: (id: string) => apiRequest(\"DELETE\", `/api/customers/${customerId}/dashboard-goals/${id}`),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/customers\", customerId, \"dashboard-goals\"] });\n      toast({ title: \"Meta excluída com sucesso!\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro ao excluir meta\", variant: \"destructive\" });\n    },\n  });\n\n  // Handlers\n  const onSubmitType = (data: any) => {\n    if (editingType) {\n      updateTypeMutation.mutate({ id: editingType.id, data });\n    } else {\n      createTypeMutation.mutate(data);\n    }\n  };\n\n  // CATEGORIAS - HANDLER COMENTADO\n  /* const onSubmitCategory = (data: any) => {\n    if (editingCategory) {\n      updateCategoryMutation.mutate({ id: editingCategory.id, data });\n    } else {\n      createCategoryMutation.mutate(data);\n    }\n  }; */\n\n  const onSubmitGoal = (data: any) => {\n    if (editingGoal) {\n      updateGoalMutation.mutate({ id: editingGoal.id, data });\n    } else {\n      createGoalMutation.mutate(data);\n    }\n  };\n\n  const handleEditType = (type: any) => {\n    setEditingType(type);\n    typeForm.reset({\n      name: type.name,\n      description: type.description || \"\",\n      code: type.code,\n    });\n    setIsTypeDialogOpen(true);\n  };\n\n  // CATEGORIAS - HANDLER COMENTADO\n  /* const handleEditCategory = (category: any) => {\n    setEditingCategory(category);\n    categoryForm.reset({\n      name: category.name,\n      description: category.description || \"\",\n      code: category.code,\n      typeId: category.typeId,\n    });\n    setIsCategoryDialogOpen(true);\n  }; */\n\n  const handleEditGoal = (goal: any) => {\n    setEditingGoal(goal);\n    goalForm.reset({\n      goalType: goal.goalType,\n      goalValue: goal.goalValue,\n      currentPeriod: goal.currentPeriod,\n    });\n    setIsGoalDialogOpen(true);\n  };\n\n  const getTypeName = (typeId: string) => {\n    const type = (serviceTypes as any[]).find(t => t.id === typeId);\n    return type?.name || \"Tipo não encontrado\";\n  };\n\n  const getGoalTypeLabel = (goalType: string) => {\n    const labels: Record<string, string> = {\n      'eficiencia_operacional': 'Eficiência Operacional (%)',\n      'sla_compliance': 'SLA Compliance (%)',\n      'os_concluidas_mes': 'OS Concluídas no Mês',\n      'indice_qualidade': 'Índice de Qualidade (0-10)',\n      'performance_mensal': 'Performance Mensal (%)',\n    };\n    return labels[goalType] || goalType;\n  };\n\n  const getGoalTypeColor = (goalType: string) => {\n    const colors: Record<string, string> = {\n      'eficiencia_operacional': 'bg-emerald-500',\n      'sla_compliance': 'bg-blue-500',\n      'os_concluidas_mes': 'bg-purple-500',\n      'indice_qualidade': 'bg-orange-500',\n      'performance_mensal': 'bg-indigo-500',\n    };\n    return colors[goalType] || 'bg-gray-500';\n  };\n\n  if (loadingTypes || /* loadingCategories || */ loadingGoals) { // CATEGORIAS - LOADING COMENTADO\n    return (\n      <div className=\"min-h-screen bg-gray-50 pb-20\">\n        <div className=\"bg-gradient-to-br from-purple-600 via-indigo-600 to-blue-600 p-6 pb-4\">\n          <div className=\"animate-pulse flex items-center gap-4\">\n            <div className=\"w-14 h-14 bg-white/20 rounded-2xl\"></div>\n            <div className=\"flex-1\">\n              <div className=\"h-6 bg-white/20 rounded w-40 mb-2\"></div>\n              <div className=\"h-4 bg-white/10 rounded w-32\"></div>\n            </div>\n          </div>\n        </div>\n        <div className=\"p-4 space-y-4\">\n          <div className=\"animate-pulse\">\n            {[1,2,3].map(i => (\n              <div key={i} className=\"h-24 bg-gray-200 rounded-xl mb-3\"></div>\n            ))}\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gray-50 pb-20\">\n      {/* Header */}\n      <div className=\"bg-gradient-to-br from-purple-600 via-indigo-600 to-blue-600 p-6 pb-4\">\n        <div className=\"flex items-center gap-4\">\n          <div className=\"w-14 h-14 bg-white/20 backdrop-blur-sm rounded-2xl flex items-center justify-center ring-4 ring-white/20\">\n            <SettingsIcon className=\"w-7 h-7 text-white\" />\n          </div>\n          <div>\n            <h1 className=\"text-2xl font-bold text-white\">Configurações</h1>\n            <p className=\"text-sm text-white/80\">Sistema de serviços</p>\n          </div>\n        </div>\n      </div>\n\n      <Tabs value={activeTab} onValueChange={setActiveTab} className=\"w-full\">\n        {/* Tabs com scroll horizontal */}\n        <div className=\"bg-white border-b sticky top-0 z-10 overflow-x-auto\">\n          <TabsList className=\"flex gap-1 bg-transparent w-max min-w-full px-4 py-2\">\n            <TabsTrigger \n              value=\"types\" \n              className=\"flex items-center gap-1.5 text-xs rounded-xl px-4 py-2.5 data-[state=active]:bg-purple-100 data-[state=active]:text-purple-900 whitespace-nowrap\"\n              data-testid=\"tab-types\"\n            >\n              <Tag className=\"w-4 h-4\" />\n              Tipos\n            </TabsTrigger>\n            {/* CATEGORIAS - ABA COMENTADA */}\n            {/* <TabsTrigger \n              value=\"categories\" \n              className=\"flex items-center gap-1.5 text-xs rounded-xl px-4 py-2.5 data-[state=active]:bg-purple-100 data-[state=active]:text-purple-900 whitespace-nowrap\"\n              data-testid=\"tab-categories\"\n            >\n              <Layers className=\"w-4 h-4\" />\n              Categorias\n            </TabsTrigger> */}\n            <TabsTrigger \n              value=\"services\" \n              className=\"flex items-center gap-1.5 text-xs rounded-xl px-4 py-2.5 data-[state=active]:bg-purple-100 data-[state=active]:text-purple-900 whitespace-nowrap\"\n              data-testid=\"tab-services\"\n            >\n              <SettingsIcon className=\"w-4 h-4\" />\n              Serviços\n            </TabsTrigger>\n            <TabsTrigger \n              value=\"goals\" \n              className=\"flex items-center gap-1.5 text-xs rounded-xl px-4 py-2.5 data-[state=active]:bg-purple-100 data-[state=active]:text-purple-900 whitespace-nowrap\"\n              data-testid=\"tab-goals\"\n            >\n              <Target className=\"w-4 h-4\" />\n              Metas\n            </TabsTrigger>\n            <TabsTrigger \n              value=\"sites\" \n              className=\"flex items-center gap-1.5 text-xs rounded-xl px-4 py-2.5 data-[state=active]:bg-purple-100 data-[state=active]:text-purple-900 whitespace-nowrap\"\n              data-testid=\"tab-sites\"\n            >\n              <Building className=\"w-4 h-4\" />\n              Sites\n            </TabsTrigger>\n            <TabsTrigger \n              value=\"users\" \n              className=\"flex items-center gap-1.5 text-xs rounded-xl px-4 py-2.5 data-[state=active]:bg-purple-100 data-[state=active]:text-purple-900 whitespace-nowrap\"\n              data-testid=\"tab-users\"\n            >\n              <UsersIcon className=\"w-4 h-4\" />\n              Usuários\n            </TabsTrigger>\n          </TabsList>\n        </div>\n\n        {/* Aba Tipos */}\n        <TabsContent value=\"types\" className=\"p-4 space-y-4\">\n          <Card>\n            <CardHeader>\n              <div className=\"flex items-center justify-between\">\n                <CardTitle className=\"flex items-center gap-2 text-base\">\n                  <Tag className=\"w-5 h-5\" />\n                  Tipos de Serviços\n                </CardTitle>\n                <Dialog open={isTypeDialogOpen} onOpenChange={setIsTypeDialogOpen}>\n                  <DialogTrigger asChild>\n                    <Button \n                      size=\"sm\"\n                      onClick={() => {\n                        setEditingType(null);\n                        typeForm.reset({ name: \"\", description: \"\", code: \"\" });\n                      }}\n                      data-testid=\"button-create-type\"\n                    >\n                      <Plus className=\"w-4 h-4 mr-1\" />\n                      Novo\n                    </Button>\n                  </DialogTrigger>\n                  <DialogContent className=\"max-w-[90vw]\">\n                    <DialogHeader>\n                      <DialogTitle className=\"text-base\">\n                        {editingType ? \"Editar Tipo\" : \"Novo Tipo\"}\n                      </DialogTitle>\n                    </DialogHeader>\n                    <Form {...typeForm}>\n                      <form onSubmit={typeForm.handleSubmit(onSubmitType)} className=\"space-y-4\">\n                        <FormField\n                          control={typeForm.control}\n                          name=\"name\"\n                          render={({ field }) => (\n                            <FormItem>\n                              <FormLabel className=\"text-sm\">Nome</FormLabel>\n                              <FormControl>\n                                <Input placeholder=\"Ex: Hard Service\" {...field} data-testid=\"input-type-name\" className=\"text-sm\" />\n                              </FormControl>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n                        <FormField\n                          control={typeForm.control}\n                          name=\"code\"\n                          render={({ field }) => (\n                            <FormItem>\n                              <FormLabel className=\"text-sm\">Código</FormLabel>\n                              <FormControl>\n                                <Input placeholder=\"Ex: hard_service\" {...field} data-testid=\"input-type-code\" className=\"text-sm\" />\n                              </FormControl>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n                        <FormField\n                          control={typeForm.control}\n                          name=\"description\"\n                          render={({ field }) => (\n                            <FormItem>\n                              <FormLabel className=\"text-sm\">Descrição</FormLabel>\n                              <FormControl>\n                                <Textarea \n                                  placeholder=\"Descrição do tipo\" \n                                  {...field} \n                                  data-testid=\"input-type-description\"\n                                  className=\"text-sm\"\n                                  rows={3}\n                                />\n                              </FormControl>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n                        <div className=\"flex justify-end space-x-2 pt-2\">\n                          <Button \n                            type=\"button\" \n                            variant=\"outline\" \n                            onClick={() => setIsTypeDialogOpen(false)}\n                            size=\"sm\"\n                          >\n                            Cancelar\n                          </Button>\n                          <Button \n                            type=\"submit\" \n                            disabled={createTypeMutation.isPending || updateTypeMutation.isPending}\n                            data-testid=\"button-save-type\"\n                            size=\"sm\"\n                          >\n                            {editingType ? \"Atualizar\" : \"Criar\"}\n                          </Button>\n                        </div>\n                      </form>\n                    </Form>\n                  </DialogContent>\n                </Dialog>\n              </div>\n            </CardHeader>\n            <CardContent>\n              {(serviceTypes as any[]).length === 0 ? (\n                <div className=\"text-center py-8\">\n                  <Tag className=\"w-12 h-12 text-muted-foreground mx-auto mb-4\" />\n                  <p className=\"text-sm text-muted-foreground\">Nenhum tipo cadastrado</p>\n                </div>\n              ) : (\n                <div className=\"space-y-3\">\n                  {(serviceTypes as any[]).map((type: any) => (\n                    <div key={type.id} className=\"border rounded-lg p-3 bg-white\" data-testid={`card-type-${type.id}`}>\n                      <div className=\"flex items-start justify-between gap-3\">\n                        <div className=\"flex-1 min-w-0\">\n                          <div className=\"flex items-center gap-2 mb-1 flex-wrap\">\n                            <h3 className=\"text-sm font-semibold truncate\" data-testid={`text-type-name-${type.id}`}>{type.name}</h3>\n                            <Badge variant=\"outline\" className=\"text-xs\" data-testid={`badge-type-code-${type.id}`}>{type.code}</Badge>\n                            {type.isActive ? (\n                              <Badge className=\"bg-green-100 text-green-800 text-xs\" data-testid={`badge-type-status-${type.id}`}>Ativo</Badge>\n                            ) : (\n                              <Badge variant=\"outline\" className=\"text-xs\" data-testid={`badge-type-status-${type.id}`}>Inativo</Badge>\n                            )}\n                          </div>\n                          {type.description && (\n                            <p className=\"text-xs text-muted-foreground mb-1 line-clamp-2\" data-testid={`text-type-description-${type.id}`}>{type.description}</p>\n                          )}\n                          <p className=\"text-xs text-muted-foreground\" data-testid={`text-type-categories-${type.id}`}>\n                            Categorias: {(serviceCategories as any[]).filter(c => c.typeId === type.id).length}\n                          </p>\n                        </div>\n                        <div className=\"flex items-center gap-1\">\n                          <Button \n                            variant=\"ghost\" \n                            size=\"sm\"\n                            className=\"h-8 w-8 p-0\"\n                            onClick={() => handleEditType(type)}\n                            data-testid={`button-edit-type-${type.id}`}\n                          >\n                            <Edit className=\"w-4 h-4\" />\n                          </Button>\n                          <Button \n                            variant=\"ghost\" \n                            size=\"sm\"\n                            className=\"h-8 w-8 p-0 text-red-600\"\n                            onClick={() => deleteTypeMutation.mutate(type.id)}\n                            data-testid={`button-delete-type-${type.id}`}\n                          >\n                            <Trash2 className=\"w-4 h-4\" />\n                          </Button>\n                        </div>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        {/* CATEGORIAS - TODO O CONTEÚDO DA ABA COMENTADO */}\n        {/* <TabsContent value=\"categories\" className=\"p-4 space-y-4\">\n          <Card>\n            <CardHeader>\n              <div className=\"flex items-center justify-between\">\n                <CardTitle className=\"flex items-center gap-2 text-base\">\n                  <Layers className=\"w-5 h-5\" />\n                  Categorias\n                </CardTitle>\n                <Dialog open={isCategoryDialogOpen} onOpenChange={setIsCategoryDialogOpen}>\n                  <DialogTrigger asChild>\n                    <Button \n                      size=\"sm\"\n                      onClick={() => {\n                        setEditingCategory(null);\n                        categoryForm.reset({ name: \"\", description: \"\", code: \"\", typeId: \"\" });\n                      }}\n                      data-testid=\"button-create-category\"\n                    >\n                      <Plus className=\"w-4 h-4 mr-1\" />\n                      Nova\n                    </Button>\n                  </DialogTrigger>\n                  <DialogContent className=\"max-w-[90vw]\">\n                    <DialogHeader>\n                      <DialogTitle className=\"text-base\">\n                        {editingCategory ? \"Editar Categoria\" : \"Nova Categoria\"}\n                      </DialogTitle>\n                    </DialogHeader>\n                    <Form {...categoryForm}>\n                      <form onSubmit={categoryForm.handleSubmit(onSubmitCategory)} className=\"space-y-4\">\n                        <FormField\n                          control={categoryForm.control}\n                          name=\"typeId\"\n                          render={({ field }) => (\n                            <FormItem>\n                              <FormLabel className=\"text-sm\">Tipo de Serviço</FormLabel>\n                              <Select onValueChange={field.onChange} value={field.value}>\n                                <FormControl>\n                                  <SelectTrigger data-testid=\"select-category-type\" className=\"text-sm\">\n                                    <SelectValue placeholder=\"Selecione o tipo\" />\n                                  </SelectTrigger>\n                                </FormControl>\n                                <SelectContent>\n                                  {(serviceTypes as any[]).map((type: any) => (\n                                    <SelectItem key={type.id} value={type.id} data-testid={`select-item-type-${type.id}`}>\n                                      {type.name}\n                                    </SelectItem>\n                                  ))}\n                                </SelectContent>\n                              </Select>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n                        <FormField\n                          control={categoryForm.control}\n                          name=\"name\"\n                          render={({ field }) => (\n                            <FormItem>\n                              <FormLabel className=\"text-sm\">Nome</FormLabel>\n                              <FormControl>\n                                <Input placeholder=\"Ex: Manutenção Elétrica\" {...field} data-testid=\"input-category-name\" className=\"text-sm\" />\n                              </FormControl>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n                        <FormField\n                          control={categoryForm.control}\n                          name=\"code\"\n                          render={({ field }) => (\n                            <FormItem>\n                              <FormLabel className=\"text-sm\">Código</FormLabel>\n                              <FormControl>\n                                <Input placeholder=\"Ex: manutencao_eletrica\" {...field} data-testid=\"input-category-code\" className=\"text-sm\" />\n                              </FormControl>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n                        <FormField\n                          control={categoryForm.control}\n                          name=\"description\"\n                          render={({ field }) => (\n                            <FormItem>\n                              <FormLabel className=\"text-sm\">Descrição</FormLabel>\n                              <FormControl>\n                                <Textarea \n                                  placeholder=\"Descrição da categoria\" \n                                  {...field} \n                                  data-testid=\"input-category-description\"\n                                  className=\"text-sm\"\n                                  rows={3}\n                                />\n                              </FormControl>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n                        <div className=\"flex justify-end space-x-2 pt-2\">\n                          <Button \n                            type=\"button\" \n                            variant=\"outline\" \n                            onClick={() => setIsCategoryDialogOpen(false)}\n                            size=\"sm\"\n                          >\n                            Cancelar\n                          </Button>\n                          <Button \n                            type=\"submit\" \n                            disabled={createCategoryMutation.isPending || updateCategoryMutation.isPending}\n                            data-testid=\"button-save-category\"\n                            size=\"sm\"\n                          >\n                            {editingCategory ? \"Atualizar\" : \"Criar\"}\n                          </Button>\n                        </div>\n                      </form>\n                    </Form>\n                  </DialogContent>\n                </Dialog>\n              </div>\n            </CardHeader>\n            <CardContent>\n              {(serviceCategories as any[]).length === 0 ? (\n                <div className=\"text-center py-8\">\n                  <Layers className=\"w-12 h-12 text-muted-foreground mx-auto mb-4\" />\n                  <p className=\"text-sm text-muted-foreground\">Nenhuma categoria cadastrada</p>\n                </div>\n              ) : (\n                <div className=\"space-y-3\">\n                  {(serviceCategories as any[]).map((category: any) => (\n                    <div key={category.id} className=\"border rounded-lg p-3 bg-white\" data-testid={`card-category-${category.id}`}>\n                      <div className=\"flex items-start justify-between gap-3\">\n                        <div className=\"flex-1 min-w-0\">\n                          <div className=\"flex items-center gap-2 mb-1 flex-wrap\">\n                            <h3 className=\"text-sm font-semibold truncate\" data-testid={`text-category-name-${category.id}`}>{category.name}</h3>\n                            <Badge variant=\"outline\" className=\"text-xs\" data-testid={`badge-category-code-${category.id}`}>{category.code}</Badge>\n                          </div>\n                          {category.description && (\n                            <p className=\"text-xs text-muted-foreground mb-1 line-clamp-2\" data-testid={`text-category-description-${category.id}`}>{category.description}</p>\n                          )}\n                          <p className=\"text-xs text-muted-foreground\" data-testid={`text-category-type-${category.id}`}>\n                            Tipo: {getTypeName(category.typeId)}\n                          </p>\n                        </div>\n                        <div className=\"flex items-center gap-1\">\n                          <Button \n                            variant=\"ghost\" \n                            size=\"sm\"\n                            className=\"h-8 w-8 p-0\"\n                            onClick={() => handleEditCategory(category)}\n                            data-testid={`button-edit-category-${category.id}`}\n                          >\n                            <Edit className=\"w-4 h-4\" />\n                          </Button>\n                          <Button \n                            variant=\"ghost\" \n                            size=\"sm\"\n                            className=\"h-8 w-8 p-0 text-red-600\"\n                            onClick={() => deleteCategoryMutation.mutate(category.id)}\n                            data-testid={`button-delete-category-${category.id}`}\n                          >\n                            <Trash2 className=\"w-4 h-4\" />\n                          </Button>\n                        </div>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent> */}\n\n        {/* Aba Serviços */}\n        <TabsContent value=\"services\" className=\"mt-0\">\n          <Services customerId={customerId} />\n        </TabsContent>\n\n        {/* Aba Metas */}\n        <TabsContent value=\"goals\" className=\"p-4 space-y-4\">\n          <Card>\n            <CardHeader>\n              <div className=\"flex items-center justify-between\">\n                <CardTitle className=\"flex items-center gap-2 text-base\">\n                  <Target className=\"w-5 h-5\" />\n                  Metas do Dashboard\n                </CardTitle>\n                <Dialog open={isGoalDialogOpen} onOpenChange={setIsGoalDialogOpen}>\n                  <DialogTrigger asChild>\n                    <Button \n                      size=\"sm\"\n                      onClick={() => {\n                        setEditingGoal(null);\n                        goalForm.reset({ \n                          goalType: \"\", \n                          goalValue: \"\", \n                          currentPeriod: new Date().toISOString().slice(0, 7) \n                        });\n                      }}\n                      data-testid=\"button-create-goal\"\n                    >\n                      <Plus className=\"w-4 h-4 mr-1\" />\n                      Nova\n                    </Button>\n                  </DialogTrigger>\n                  <DialogContent className=\"max-w-[90vw]\">\n                    <DialogHeader>\n                      <DialogTitle className=\"text-base\">\n                        {editingGoal ? \"Editar Meta\" : \"Nova Meta\"}\n                      </DialogTitle>\n                    </DialogHeader>\n                    <Form {...goalForm}>\n                      <form onSubmit={goalForm.handleSubmit(onSubmitGoal)} className=\"space-y-4\">\n                        <FormField\n                          control={goalForm.control}\n                          name=\"goalType\"\n                          render={({ field }) => (\n                            <FormItem>\n                              <FormLabel className=\"text-sm\">Tipo de Meta</FormLabel>\n                              <Select onValueChange={field.onChange} value={field.value}>\n                                <FormControl>\n                                  <SelectTrigger data-testid=\"select-goal-type\" className=\"text-sm\">\n                                    <SelectValue placeholder=\"Selecione o tipo\" />\n                                  </SelectTrigger>\n                                </FormControl>\n                                <SelectContent>\n                                  <SelectItem value=\"eficiencia_operacional\" data-testid=\"select-item-goal-eficiencia\">\n                                    Eficiência Operacional (%)\n                                  </SelectItem>\n                                  <SelectItem value=\"sla_compliance\" data-testid=\"select-item-goal-sla\">\n                                    SLA Compliance (%)\n                                  </SelectItem>\n                                  <SelectItem value=\"os_concluidas_mes\" data-testid=\"select-item-goal-os\">\n                                    OS Concluídas no Mês\n                                  </SelectItem>\n                                  <SelectItem value=\"indice_qualidade\" data-testid=\"select-item-goal-qualidade\">\n                                    Índice de Qualidade (0-10)\n                                  </SelectItem>\n                                  <SelectItem value=\"performance_mensal\" data-testid=\"select-item-goal-performance\">\n                                    Performance Mensal (%)\n                                  </SelectItem>\n                                </SelectContent>\n                              </Select>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n                        <FormField\n                          control={goalForm.control}\n                          name=\"goalValue\"\n                          render={({ field }) => (\n                            <FormItem>\n                              <FormLabel className=\"text-sm\">Valor da Meta</FormLabel>\n                              <FormControl>\n                                <Input \n                                  type=\"number\" \n                                  placeholder=\"Ex: 95\" \n                                  {...field} \n                                  data-testid=\"input-goal-value\" \n                                  className=\"text-sm\"\n                                />\n                              </FormControl>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n                        <FormField\n                          control={goalForm.control}\n                          name=\"currentPeriod\"\n                          render={({ field }) => (\n                            <FormItem>\n                              <FormLabel className=\"text-sm\">Período</FormLabel>\n                              <FormControl>\n                                <Input \n                                  type=\"month\" \n                                  {...field} \n                                  data-testid=\"input-goal-period\" \n                                  className=\"text-sm\"\n                                />\n                              </FormControl>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n                        <div className=\"flex justify-end space-x-2 pt-2\">\n                          <Button \n                            type=\"button\" \n                            variant=\"outline\" \n                            onClick={() => setIsGoalDialogOpen(false)}\n                            size=\"sm\"\n                          >\n                            Cancelar\n                          </Button>\n                          <Button \n                            type=\"submit\" \n                            disabled={createGoalMutation.isPending || updateGoalMutation.isPending}\n                            data-testid=\"button-save-goal\"\n                            size=\"sm\"\n                          >\n                            {editingGoal ? \"Atualizar\" : \"Criar\"}\n                          </Button>\n                        </div>\n                      </form>\n                    </Form>\n                  </DialogContent>\n                </Dialog>\n              </div>\n            </CardHeader>\n            <CardContent>\n              {(dashboardGoals as any[]).length === 0 ? (\n                <div className=\"text-center py-8\">\n                  <Target className=\"w-12 h-12 text-muted-foreground mx-auto mb-4\" />\n                  <p className=\"text-sm text-muted-foreground\">Nenhuma meta cadastrada</p>\n                </div>\n              ) : (\n                <div className=\"space-y-3\">\n                  {(dashboardGoals as any[]).map((goal: any) => (\n                    <div key={goal.id} className=\"border rounded-lg p-3 bg-white\" data-testid={`card-goal-${goal.id}`}>\n                      <div className=\"flex items-start justify-between gap-3\">\n                        <div className=\"flex-1 min-w-0\">\n                          <div className=\"flex items-center gap-2 mb-2\">\n                            <div className={`w-3 h-3 rounded-full ${getGoalTypeColor(goal.goalType)}`}></div>\n                            <h3 className=\"text-sm font-semibold\" data-testid={`text-goal-type-${goal.id}`}>\n                              {getGoalTypeLabel(goal.goalType)}\n                            </h3>\n                          </div>\n                          <div className=\"flex items-center gap-4 text-xs text-muted-foreground\">\n                            <span data-testid={`text-goal-value-${goal.id}`}>Meta: <strong>{goal.goalValue}</strong></span>\n                            <span data-testid={`text-goal-period-${goal.id}`}>Período: {goal.currentPeriod}</span>\n                          </div>\n                        </div>\n                        <div className=\"flex items-center gap-1\">\n                          <Button \n                            variant=\"ghost\" \n                            size=\"sm\"\n                            className=\"h-8 w-8 p-0\"\n                            onClick={() => handleEditGoal(goal)}\n                            data-testid={`button-edit-goal-${goal.id}`}\n                          >\n                            <Edit className=\"w-4 h-4\" />\n                          </Button>\n                          <Button \n                            variant=\"ghost\" \n                            size=\"sm\"\n                            className=\"h-8 w-8 p-0 text-red-600\"\n                            onClick={() => deleteGoalMutation.mutate(goal.id)}\n                            data-testid={`button-delete-goal-${goal.id}`}\n                          >\n                            <Trash2 className=\"w-4 h-4\" />\n                          </Button>\n                        </div>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        {/* Aba Sites */}\n        <TabsContent value=\"sites\" className=\"mt-0\">\n          <Sites customerId={customerId} />\n        </TabsContent>\n\n        {/* Aba Usuários */}\n        <TabsContent value=\"users\" className=\"mt-0\">\n          <Users customerId={customerId} />\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n}\n","size_bytes":42024},"client/src/pages/admin-mobile.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { useClient } from \"@/contexts/ClientContext\";\nimport { useModule } from \"@/contexts/ModuleContext\";\nimport { \n  Home, \n  ClipboardList, \n  Building, \n  Users, \n  QrCode, \n  Calendar,\n  List,\n  BarChart3,\n  Plus,\n  Menu,\n  X,\n  LogOut,\n  User,\n  Settings,\n  ArrowLeft,\n  Cog,\n  TrendingUp,\n  Target,\n  Activity,\n  CheckCircle,\n  Clock,\n  AlertTriangle,\n  Zap,\n  Search,\n  ChevronLeft,\n  ChevronRight,\n  MapPin,\n  Timer\n} from \"lucide-react\";\nimport { PieChart, Pie, Cell, ResponsiveContainer, BarChart, Bar, XAxis, YAxis, Tooltip, Legend } from \"recharts\";\nimport { useLocation } from \"wouter\";\nimport { getAuthState, logout } from \"@/lib/auth\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport Sites from \"@/pages/sites\";\nimport Services from \"@/pages/services\";\nimport Checklists from \"@/pages/checklists\";\nimport AdminDashboards from \"@/pages/admin-dashboards\";\nimport WorkOrdersMobile from \"@/components/mobile/WorkOrdersMobile\";\nimport UsersMobile from \"@/components/mobile/UsersMobile\";\nimport QRCodesMobile from \"@/components/mobile/QRCodesMobile\";\nimport ScheduleMobile from \"@/components/mobile/ScheduleMobile\";\nimport SettingsMobile from \"@/components/mobile/SettingsMobile\";\nimport ServiceSettingsMobile from \"@/components/mobile/ServiceSettingsMobile\";\nimport ReportsMobile from \"@/components/mobile/ReportsMobile\";\n\ninterface AdminMobileProps {\n  companyId: string;\n}\n\nfunction DashboardsBI({ customerId }: { customerId: string }) {\n  const { currentModule } = useModule();\n  const [period, setPeriod] = useState(\"hoje\");\n  const [siteFilter, setSiteFilter] = useState(\"todos\");\n\n  // Buscar dados do dashboard\n  const { data: dashStats, isLoading: statsLoading } = useQuery({\n    queryKey: [\"/api/customers\", customerId, \"dashboard-stats\", period, siteFilter],\n    enabled: !!customerId,\n  });\n\n  // Buscar analytics\n  const { data: analytics, isLoading: analyticsLoading } = useQuery({\n    queryKey: [\"/api/customers\", customerId, \"analytics\", period, siteFilter],\n    enabled: !!customerId,\n  });\n\n  // Buscar sites para filtro\n  const { data: sites } = useQuery({\n    queryKey: [\"/api/customers\", customerId, \"sites\", { module: currentModule }],\n    enabled: !!customerId,\n  });\n\n  if (statsLoading || analyticsLoading) {\n    return (\n      <div className=\"p-4 space-y-4\">\n        <div className=\"animate-pulse\">\n          <div className=\"h-6 bg-gray-200 rounded mb-2\"></div>\n          <div className=\"grid grid-cols-2 gap-3\">\n            {[1,2,3,4].map(i => (\n              <div key={i} className=\"h-20 bg-gray-200 rounded\"></div>\n            ))}\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  const stats = (dashStats || {}) as any;\n  const chartData = (analytics || {}) as any;\n\n  // Prepare data for charts - usar dados corretos do stats (que já conta vencidas)\n  const statusChartData = [\n    { name: 'Abertas', value: stats.openWorkOrders || 0, percentage: 0 },\n    { name: 'Concluídas', value: stats.completedWorkOrders || 0, percentage: 0 },\n    { name: 'Vencidas', value: stats.overdueWorkOrders || 0, percentage: 0 },\n  ].map(item => {\n    const totalOS = (stats.openWorkOrders || 0) + (stats.completedWorkOrders || 0) + (stats.overdueWorkOrders || 0);\n    return {\n      ...item,\n      percentage: totalOS > 0 ? Math.round((item.value / totalOS) * 100) : 0\n    };\n  }).filter(item => item.value > 0 || item.name === 'Vencidas'); // Sempre mostrar vencidas mesmo se zero\n\n  // Dados de prioridade das OSs\n  const priorityData = [\n    { name: 'Alta', value: Math.floor((stats.openWorkOrders || 0) * 0.2), color: '#ef4444' },\n    { name: 'Média', value: Math.floor((stats.openWorkOrders || 0) * 0.5), color: '#f59e0b' },\n    { name: 'Baixa', value: Math.floor((stats.openWorkOrders || 0) * 0.3), color: '#10b981' },\n  ].filter(item => item.value > 0);\n\n  const COLORS = {\n    'Concluídas': '#10b981',\n    'Abertas': '#3b82f6',\n    'Vencidas': '#ef4444',\n    'Em Andamento': '#f59e0b',\n    'Canceladas': '#6b7280'\n  };\n\n  // Total OS\n  const totalOS = (stats.openWorkOrders || 0) + (stats.completedWorkOrders || 0) + (stats.overdueWorkOrders || 0) + (stats.inProgressWorkOrders || 0);\n\n  return (\n    <div className=\"p-3 space-y-3 bg-gray-50 min-h-screen pb-20\">\n      {/* Header Moderno */}\n      <div className=\"bg-gradient-to-r from-blue-600 to-indigo-600 rounded-2xl p-4 shadow-lg\">\n        <div className=\"flex items-center justify-between mb-3\">\n          <div>\n            <h1 className=\"text-lg font-bold text-white flex items-center gap-2\">\n              <BarChart3 className=\"w-5 h-5\" />\n              Dashboards BI\n            </h1>\n            <p className=\"text-xs text-blue-100 mt-0.5\">Analytics em tempo real</p>\n          </div>\n          <div className=\"w-10 h-10 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center\">\n            <Activity className=\"w-5 h-5 text-white\" />\n          </div>\n        </div>\n\n        {/* Filtros */}\n        <div className=\"flex gap-2 overflow-x-auto pb-1\">\n          {[\"hoje\", \"ontem\", \"semana\", \"mes\"].map((p) => (\n            <button \n              key={p}\n              onClick={() => setPeriod(p)}\n              className={`px-4 py-1.5 rounded-lg text-xs font-semibold whitespace-nowrap transition-all ${\n                period === p \n                  ? \"bg-white text-blue-600 shadow-md\" \n                  : \"bg-white/20 text-white hover:bg-white/30\"\n              }`}\n            >\n              {p.charAt(0).toUpperCase() + p.slice(1)}\n            </button>\n          ))}\n        </div>\n      </div>\n\n      {/* Filtro de Sites */}\n      <select \n        value={siteFilter} \n        onChange={(e) => setSiteFilter(e.target.value)}\n        className=\"w-full px-4 py-2.5 bg-white border-0 rounded-xl text-sm font-medium shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500\"\n      >\n        <option value=\"todos\">📍 Todos os Locais</option>\n        {(sites || []).map((site: any) => (\n          <option key={site.id} value={site.id}>📍 {site.name}</option>\n        ))}\n      </select>\n\n      {/* KPIs Principais - Design Moderno */}\n      <div className=\"grid grid-cols-2 gap-2.5\">\n        <div className=\"bg-white rounded-2xl p-4 shadow-sm border border-blue-100\">\n          <div className=\"flex items-center gap-2 mb-2\">\n            <div className=\"w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center\">\n              <ClipboardList className=\"w-4 h-4 text-blue-600\" />\n            </div>\n            <span className=\"text-xs font-medium text-gray-600\">Total OS</span>\n          </div>\n          <p className=\"text-3xl font-bold text-gray-900\">{totalOS}</p>\n          <p className=\"text-xs text-gray-500 mt-1\">{stats.efficiency || 0}% eficiência</p>\n        </div>\n\n        <div className=\"bg-white rounded-2xl p-4 shadow-sm border border-green-100\">\n          <div className=\"flex items-center gap-2 mb-2\">\n            <div className=\"w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center\">\n              <CheckCircle className=\"w-4 h-4 text-green-600\" />\n            </div>\n            <span className=\"text-xs font-medium text-gray-600\">Concluídas</span>\n          </div>\n          <p className=\"text-3xl font-bold text-green-600\">{stats.completedWorkOrders || 0}</p>\n          <p className=\"text-xs text-gray-500 mt-1\">Finalizadas</p>\n        </div>\n\n        <div className=\"bg-white rounded-2xl p-4 shadow-sm border border-orange-100\">\n          <div className=\"flex items-center gap-2 mb-2\">\n            <div className=\"w-8 h-8 bg-orange-100 rounded-lg flex items-center justify-center\">\n              <Clock className=\"w-4 h-4 text-orange-600\" />\n            </div>\n            <span className=\"text-xs font-medium text-gray-600\">Abertas</span>\n          </div>\n          <p className=\"text-3xl font-bold text-orange-600\">{stats.openWorkOrders || 0}</p>\n          <p className=\"text-xs text-gray-500 mt-1\">Pendentes</p>\n        </div>\n\n        <div className=\"bg-white rounded-2xl p-4 shadow-sm border border-red-100\">\n          <div className=\"flex items-center gap-2 mb-2\">\n            <div className=\"w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center\">\n              <AlertTriangle className=\"w-4 h-4 text-red-600\" />\n            </div>\n            <span className=\"text-xs font-medium text-gray-600\">Vencidas</span>\n          </div>\n          <p className=\"text-3xl font-bold text-red-600\">{stats.overdueWorkOrders || 0}</p>\n          <p className=\"text-xs text-gray-500 mt-1\">Atrasadas</p>\n        </div>\n      </div>\n\n      {/* Gráfico de Distribuição por Prioridade */}\n      {priorityData.length > 0 && (\n        <div className=\"bg-white rounded-2xl p-4 shadow-sm\">\n          <div className=\"flex items-center gap-2 mb-3\">\n            <div className=\"w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center\">\n              <AlertTriangle className=\"w-4 h-4 text-purple-600\" />\n            </div>\n            <div>\n              <h3 className=\"text-sm font-semibold text-gray-900\">Distribuição por Prioridade</h3>\n              <p className=\"text-xs text-gray-500\">{stats.openWorkOrders || 0} OSs abertas</p>\n            </div>\n          </div>\n          <div className=\"h-56\">\n            <ResponsiveContainer width=\"100%\" height=\"100%\">\n              <BarChart data={priorityData}>\n                <XAxis \n                  dataKey=\"name\" \n                  tick={{ fontSize: 10 }}\n                  stroke=\"#9ca3af\"\n                />\n                <YAxis \n                  tick={{ fontSize: 10 }}\n                  stroke=\"#9ca3af\"\n                />\n                <Tooltip \n                  contentStyle={{ \n                    backgroundColor: '#fff', \n                    border: 'none',\n                    borderRadius: '12px',\n                    boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)'\n                  }}\n                  formatter={(value: any) => [value, 'OSs']}\n                />\n                <Bar dataKey=\"value\" radius={[12, 12, 0, 0]} label={{ position: 'top', fontSize: 12, fontWeight: 'bold' }}>\n                  {priorityData.map((entry: any, index: number) => (\n                    <Cell key={`cell-${index}`} fill={entry.color} />\n                  ))}\n                </Bar>\n              </BarChart>\n            </ResponsiveContainer>\n          </div>\n          {/* Legend Cards */}\n          <div className=\"grid grid-cols-3 gap-2 mt-3\">\n            {priorityData.map((item: any, index: number) => (\n              <div key={index} className=\"bg-gray-50 rounded-lg p-2 text-center\">\n                <div \n                  className=\"w-3 h-3 rounded-full mx-auto mb-1\" \n                  style={{ backgroundColor: item.color }}\n                ></div>\n                <p className=\"text-xs text-gray-600 font-medium\">{item.name}</p>\n                <p className=\"text-lg font-bold text-gray-900\">{item.value}</p>\n              </div>\n            ))}\n          </div>\n        </div>\n      )}\n\n      {/* Gráfico de Barras Verticais - Distribuição de Status */}\n      {statusChartData.length > 0 && (\n        <div className=\"bg-white rounded-2xl p-4 shadow-sm\">\n          <div className=\"flex items-center gap-2 mb-3\">\n            <div className=\"w-8 h-8 bg-indigo-100 rounded-lg flex items-center justify-center\">\n              <Activity className=\"w-4 h-4 text-indigo-600\" />\n            </div>\n            <div>\n              <h3 className=\"text-sm font-semibold text-gray-900\">Distribuição por Status</h3>\n              <p className=\"text-xs text-gray-500\">{totalOS} ordens de serviço</p>\n            </div>\n          </div>\n          <div className=\"h-60\">\n            <ResponsiveContainer width=\"100%\" height=\"100%\">\n              <BarChart data={statusChartData}>\n                <XAxis \n                  dataKey=\"name\" \n                  tick={{ fontSize: 10 }}\n                  stroke=\"#9ca3af\"\n                  angle={-15}\n                  textAnchor=\"end\"\n                  height={50}\n                />\n                <YAxis \n                  tick={{ fontSize: 10 }}\n                  stroke=\"#9ca3af\"\n                />\n                <Tooltip \n                  contentStyle={{ \n                    backgroundColor: '#fff', \n                    border: 'none',\n                    borderRadius: '12px',\n                    boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)'\n                  }}\n                  formatter={(value: any, name: string) => [value, 'Quantidade']}\n                />\n                <Bar dataKey=\"value\" radius={[12, 12, 0, 0]} label={{ position: 'top', fontSize: 12, fontWeight: 'bold' }}>\n                  {statusChartData.map((entry: any, index: number) => (\n                    <Cell key={`cell-${index}`} fill={COLORS[entry.name as keyof typeof COLORS] || '#6b7280'} />\n                  ))}\n                </Bar>\n              </BarChart>\n            </ResponsiveContainer>\n          </div>\n          {/* Stats Cards */}\n          <div className=\"grid grid-cols-3 gap-2 mt-3\">\n            {statusChartData.map((item: any, index: number) => (\n              <div key={index} className=\"bg-gray-50 rounded-lg p-2 text-center\">\n                <div \n                  className=\"w-3 h-3 rounded-full mx-auto mb-1\" \n                  style={{ backgroundColor: COLORS[item.name as keyof typeof COLORS] || '#6b7280' }}\n                ></div>\n                <p className=\"text-xs text-gray-600 font-medium\">{item.name}</p>\n                <p className=\"text-lg font-bold text-gray-900\">{item.value}</p>\n                <p className=\"text-xs text-gray-500\">{item.percentage}%</p>\n              </div>\n            ))}\n          </div>\n        </div>\n      )}\n\n      {/* Métricas de Performance */}\n      <div className=\"bg-white rounded-2xl p-4 shadow-sm\">\n        <div className=\"flex items-center gap-2 mb-3\">\n          <div className=\"w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center\">\n            <Target className=\"w-4 h-4 text-green-600\" />\n          </div>\n          <div>\n            <h3 className=\"text-sm font-semibold text-gray-900\">Indicadores de Qualidade</h3>\n            <p className=\"text-xs text-gray-500\">Métricas de performance</p>\n          </div>\n        </div>\n        <div className=\"grid grid-cols-3 gap-3\">\n          <div className=\"text-center\">\n            <p className=\"text-2xl font-bold text-blue-600\">{stats.slaCompliance || 0}%</p>\n            <p className=\"text-xs text-gray-500 mt-1\">SLA</p>\n          </div>\n          <div className=\"text-center border-x border-gray-100\">\n            <p className=\"text-2xl font-bold text-green-600\">{stats.qualityIndex || '-'}</p>\n            <p className=\"text-xs text-gray-500 mt-1\">Qualidade</p>\n          </div>\n          <div className=\"text-center\">\n            <p className=\"text-2xl font-bold text-purple-600\">{stats.activeOperators || 0}</p>\n            <p className=\"text-xs text-gray-500 mt-1\">Operadores</p>\n          </div>\n        </div>\n      </div>\n\n      {/* Infraestrutura */}\n      <div className=\"bg-white rounded-2xl p-4 shadow-sm\">\n        <div className=\"flex items-center gap-2 mb-3\">\n          <div className=\"w-8 h-8 bg-cyan-100 rounded-lg flex items-center justify-center\">\n            <Building className=\"w-4 h-4 text-cyan-600\" />\n          </div>\n          <div>\n            <h3 className=\"text-sm font-semibold text-gray-900\">Infraestrutura</h3>\n            <p className=\"text-xs text-gray-500\">Visão geral dos locais</p>\n          </div>\n        </div>\n        <div className=\"grid grid-cols-2 gap-3\">\n          <div className=\"bg-gray-50 rounded-xl p-3 text-center\">\n            <p className=\"text-2xl font-bold text-gray-900\">{stats.totalSites || 0}</p>\n            <p className=\"text-xs text-gray-500 mt-1\">Locais</p>\n          </div>\n          <div className=\"bg-gray-50 rounded-xl p-3 text-center\">\n            <p className=\"text-2xl font-bold text-gray-900\">{stats.totalZones || 0}</p>\n            <p className=\"text-xs text-gray-500 mt-1\">Zonas</p>\n          </div>\n        </div>\n      </div>\n\n      {/* Alertas e Notificações */}\n      <Card className=\"bg-white border-0 shadow-sm\">\n        <CardHeader className=\"pb-3\">\n          <CardTitle className=\"text-sm flex items-center gap-2\">\n            <AlertTriangle className=\"w-4 h-4 text-orange-600\" />\n            Alertas e Notificações\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"pt-0\">\n          <div className=\"space-y-2\">\n            {stats.overdueWorkOrders > 0 && (\n              <div className=\"p-3 bg-red-50 border-l-3 border-red-400 rounded-r\">\n                <p className=\"text-sm font-medium text-red-800\">⚠️ OS Vencidas</p>\n                <p className=\"text-xs text-red-700\">{stats.overdueWorkOrders} ordens estão atrasadas</p>\n              </div>\n            )}\n            {stats.slaCompliance < 80 && (\n              <div className=\"p-3 bg-yellow-50 border-l-3 border-yellow-400 rounded-r\">\n                <p className=\"text-sm font-medium text-yellow-800\">📊 SLA Baixo</p>\n                <p className=\"text-xs text-yellow-700\">Compliance atual: {stats.slaCompliance}%</p>\n              </div>\n            )}\n            {stats.efficiency > 85 && (\n              <div className=\"p-3 bg-green-50 border-l-3 border-green-400 rounded-r\">\n                <p className=\"text-sm font-medium text-green-800\">🎯 Excelente Performance</p>\n                <p className=\"text-xs text-green-700\">Eficiência de {stats.efficiency}%</p>\n              </div>\n            )}\n            {stats.overdueWorkOrders === 0 && stats.slaCompliance >= 80 && stats.efficiency <= 85 && (\n              <div className=\"p-3 bg-blue-50 border-l-3 border-blue-400 rounded-r\">\n                <p className=\"text-sm font-medium text-blue-800\">ℹ️ Sistema Normal</p>\n                <p className=\"text-xs text-blue-700\">Todas as métricas estão dentro dos parâmetros</p>\n              </div>\n            )}\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n\nexport default function AdminMobile({ companyId }: AdminMobileProps) {\n  const { currentModule } = useModule();\n  const [, setLocation] = useLocation();\n  const [isMenuOpen, setIsMenuOpen] = useState(false);\n  const [currentPage, setCurrentPage] = useState<string>(\"dashboard\");\n  const { toast } = useToast();\n  const { user } = getAuthState();\n  const { activeClientId, setActiveClientId } = useClient();\n  \n  // Usuários do tipo customer_user não podem alterar o cliente\n  const isCustomerUser = (user as any)?.customerId ? true : false;\n\n  // Get all customers from OPUS\n  const OPUS_COMPANY_ID = \"company-opus-default\";\n  const { data: customers } = useQuery({\n    queryKey: [\"/api/companies\", OPUS_COMPANY_ID, \"customers\"],\n    enabled: !isCustomerUser, // Só buscar se não for customer_user\n  });\n\n  const { data: selectedCustomer } = useQuery({\n    queryKey: [\"/api/customers\", activeClientId],\n    enabled: !!activeClientId,\n  });\n\n  const { data: stats } = useQuery({\n    queryKey: [\"/api/customers\", activeClientId, \"dashboard-stats/total/todos\"],\n    enabled: !!activeClientId,\n  });\n\n  const { data: workOrders = [] } = useQuery({\n    queryKey: [\"/api/customers\", activeClientId, \"work-orders\", { module: currentModule }],\n    enabled: !!activeClientId,\n  });\n\n  const { data: sites = [] } = useQuery({\n    queryKey: [\"/api/customers\", activeClientId, \"sites\", { module: currentModule }],\n    enabled: !!activeClientId,\n  });\n\n  const handleLogout = async () => {\n    try {\n      await logout();\n      setLocation(\"/login\");\n      toast({\n        title: \"Logout realizado\",\n        description: \"Você foi desconectado com sucesso.\",\n      });\n    } catch (error) {\n      toast({\n        title: \"Erro no logout\",\n        description: \"Houve um problema ao fazer logout.\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const quickActions = [\n    { icon: ClipboardList, label: \"Nova OS\", page: \"workorders\", color: \"bg-blue-500\" },\n    { icon: Building, label: \"Locais\", page: \"sites\", color: \"bg-green-500\" },\n    { icon: Settings, label: \"Serviços\", page: \"services\", color: \"bg-indigo-500\" },\n    { icon: Cog, label: \"Config\", page: \"service-settings\", color: \"bg-purple-500\" },\n    { icon: QrCode, label: \"QR Codes\", page: \"qrcodes\", color: \"bg-orange-500\" },\n    { icon: Calendar, label: \"Cronograma\", page: \"schedule\", color: \"bg-pink-500\" },\n  ];\n\n  const recentOS = (workOrders as any[]).slice(0, 3);\n  const pendingOS = (workOrders as any[]).filter((os: any) => os.status === 'aberta' || os.status === 'vencida').length;\n  const completedToday = (workOrders as any[]).filter((os: any) => {\n    const today = new Date().toDateString();\n    const osDate = new Date(os.createdAt).toDateString();\n    return os.status === 'concluida' && osDate === today;\n  }).length;\n\n  const renderPageContent = () => {\n    switch (currentPage) {\n      case \"sites\":\n        return <Sites customerId={activeClientId} />;\n      case \"services\":\n        return <Services customerId={activeClientId} />;\n      case \"service-settings\":\n        return <ServiceSettingsMobile customerId={activeClientId} />;\n      case \"settings\":\n        return <SettingsMobile onNavigate={setCurrentPage} />;\n      case \"schedule\":\n        return <ScheduleMobile customerId={activeClientId} />;\n      case \"qrcodes\":\n        return <QRCodesMobile customerId={activeClientId} />;\n      case \"checklists\":\n        return <Checklists />;\n      case \"workorders\":\n        return <WorkOrdersMobile customerId={activeClientId} />;\n      case \"users\":\n        return <UsersMobile customerId={activeClientId} />;\n      case \"reports\":\n        return <ReportsMobile customerId={activeClientId} />;\n      case \"dashboards\":\n        return <DashboardsBI customerId={activeClientId} />;\n      default:\n        return renderDashboard();\n    }\n  };\n\n  const renderDashboard = () => (\n    <div className=\"p-4 space-y-5\">\n      {/* Stats Cards */}\n      <div className=\"grid grid-cols-2 gap-3\">\n        <Card className=\"bg-gradient-to-br from-orange-500 to-orange-600 border-0 shadow-lg\">\n          <CardContent className=\"p-4\">\n            <div className=\"flex flex-col space-y-2\">\n              <div className=\"flex items-center justify-between\">\n                <ClipboardList className=\"w-8 h-8 text-white/90\" />\n                <div className=\"px-2 py-1 bg-white/20 rounded-full\">\n                  <p className=\"text-xs font-semibold text-white\">OS</p>\n                </div>\n              </div>\n              <div>\n                <p className=\"text-3xl font-bold text-white\">{pendingOS}</p>\n                <p className=\"text-sm text-white/80 font-medium\">Pendentes</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card className=\"bg-gradient-to-br from-green-500 to-green-600 border-0 shadow-lg\">\n          <CardContent className=\"p-4\">\n            <div className=\"flex flex-col space-y-2\">\n              <div className=\"flex items-center justify-between\">\n                <BarChart3 className=\"w-8 h-8 text-white/90\" />\n                <div className=\"px-2 py-1 bg-white/20 rounded-full\">\n                  <p className=\"text-xs font-semibold text-white\">Hoje</p>\n                </div>\n              </div>\n              <div>\n                <p className=\"text-3xl font-bold text-white\">{completedToday}</p>\n                <p className=\"text-sm text-white/80 font-medium\">Concluídas</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card className=\"bg-gradient-to-br from-blue-500 to-blue-600 border-0 shadow-lg\">\n          <CardContent className=\"p-4\">\n            <div className=\"flex flex-col space-y-2\">\n              <div className=\"flex items-center justify-between\">\n                <Building className=\"w-8 h-8 text-white/90\" />\n                <div className=\"px-2 py-1 bg-white/20 rounded-full\">\n                  <p className=\"text-xs font-semibold text-white\">Total</p>\n                </div>\n              </div>\n              <div>\n                <p className=\"text-3xl font-bold text-white\">{(sites as any[]).length}</p>\n                <p className=\"text-sm text-white/80 font-medium\">Locais</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card className=\"bg-gradient-to-br from-purple-500 to-purple-600 border-0 shadow-lg\">\n          <CardContent className=\"p-4\">\n            <div className=\"flex flex-col space-y-2\">\n              <div className=\"flex items-center justify-between\">\n                <Users className=\"w-8 h-8 text-white/90\" />\n                <div className=\"px-2 py-1 bg-white/20 rounded-full\">\n                  <p className=\"text-xs font-semibold text-white\">Ativos</p>\n                </div>\n              </div>\n              <div>\n                <p className=\"text-3xl font-bold text-white\">{(stats as any)?.totalUsers || 0}</p>\n                <p className=\"text-sm text-white/80 font-medium\">Usuários</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Quick Actions */}\n      <Card className=\"bg-white border-0 shadow-md\">\n        <CardHeader className=\"pb-3\">\n          <CardTitle className=\"text-base flex items-center gap-2 text-slate-800\">\n            <div className=\"w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center\">\n              <Plus className=\"w-4 h-4 text-blue-600\" />\n            </div>\n            Ações Rápidas\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-3 gap-2\">\n            {quickActions.map((action) => (\n              <button\n                key={action.page}\n                className=\"flex flex-col items-center p-3 rounded-xl bg-gradient-to-br from-slate-50 to-slate-100 hover:from-blue-50 hover:to-blue-100 transition-all active:scale-95\"\n                onClick={() => setCurrentPage(action.page)}\n              >\n                <div className={`w-11 h-11 ${action.color} rounded-xl flex items-center justify-center shadow-md mb-2`}>\n                  <action.icon className=\"w-5 h-5 text-white\" />\n                </div>\n                <span className=\"text-xs font-semibold text-slate-700 text-center leading-tight\">{action.label}</span>\n              </button>\n            ))}\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Recent Work Orders */}\n      <Card className=\"bg-white border-0 shadow-md\">\n        <CardHeader className=\"pb-3\">\n          <div className=\"flex items-center justify-between\">\n            <CardTitle className=\"text-base flex items-center gap-2 text-slate-800\">\n              <div className=\"w-8 h-8 bg-orange-100 rounded-lg flex items-center justify-center\">\n                <ClipboardList className=\"w-4 h-4 text-orange-600\" />\n              </div>\n              Ordens Recentes\n            </CardTitle>\n            <Button \n              variant=\"ghost\" \n              size=\"sm\"\n              className=\"text-blue-600 hover:text-blue-700 text-xs font-semibold\"\n              onClick={() => setCurrentPage(\"workorders\")}\n            >\n              Ver Todas\n            </Button>\n          </div>\n        </CardHeader>\n        <CardContent>\n          {recentOS.length === 0 ? (\n            <div className=\"text-center py-8\">\n              <div className=\"w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-3\">\n                <ClipboardList className=\"w-8 h-8 text-slate-400\" />\n              </div>\n              <p className=\"text-sm text-slate-500\">Nenhuma ordem recente</p>\n            </div>\n          ) : (\n            <div className=\"space-y-2\">\n              {recentOS.map((os: any) => (\n                <div key={os.id} className=\"p-3 border-l-4 rounded-r-lg bg-slate-50 hover:bg-slate-100 transition-colors\"\n                  style={{\n                    borderLeftColor: \n                      os.status === 'concluida' ? '#22c55e' :\n                      os.status === 'vencida' ? '#ef4444' : '#3b82f6'\n                  }}\n                >\n                  <div className=\"flex items-start justify-between gap-2\">\n                    <div className=\"flex-1 min-w-0\">\n                      <p className=\"font-semibold text-slate-900 text-sm truncate\">{os.title}</p>\n                      <p className=\"text-xs text-slate-600 mt-0.5\">{os.siteName}</p>\n                    </div>\n                    <Badge \n                      variant=\"outline\" \n                      className={`text-xs font-semibold shrink-0 ${\n                        os.status === 'concluida' ? 'bg-green-100 text-green-700 border-green-300' :\n                        os.status === 'vencida' ? 'bg-red-100 text-red-700 border-red-300' :\n                        'bg-blue-100 text-blue-700 border-blue-300'\n                      }`}\n                    >\n                      {os.status === 'concluida' ? 'Concluída' :\n                       os.status === 'vencida' ? 'Vencida' : \n                       os.status === 'aberta' ? 'Aberta' : os.status}\n                    </Badge>\n                  </div>\n                </div>\n              ))}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Site Overview */}\n      <Card className=\"bg-white border-0 shadow-md\">\n        <CardHeader className=\"pb-3\">\n          <div className=\"flex items-center justify-between\">\n            <CardTitle className=\"text-base flex items-center gap-2 text-slate-800\">\n              <div className=\"w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center\">\n                <Building className=\"w-4 h-4 text-blue-600\" />\n              </div>\n              Locais Ativos\n            </CardTitle>\n            <Button \n              variant=\"ghost\" \n              size=\"sm\"\n              className=\"text-blue-600 hover:text-blue-700 text-xs font-semibold\"\n              onClick={() => setCurrentPage(\"sites\")}\n            >\n              Gerenciar\n            </Button>\n          </div>\n        </CardHeader>\n        <CardContent>\n          {(sites as any[]).length === 0 ? (\n            <div className=\"text-center py-8\">\n              <div className=\"w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-3\">\n                <Building className=\"w-8 h-8 text-slate-400\" />\n              </div>\n              <p className=\"text-sm text-slate-500\">Nenhum local cadastrado</p>\n            </div>\n          ) : (\n            <div className=\"space-y-2\">\n              {(sites as any[]).slice(0, 3).map((site: any) => (\n                <div key={site.id} className=\"p-3 rounded-lg bg-gradient-to-br from-blue-50 to-indigo-50 border border-blue-100 hover:shadow-sm transition-shadow\">\n                  <div className=\"flex items-center space-x-3\">\n                    <div className=\"w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center shadow-sm shrink-0\">\n                      <Building className=\"w-5 h-5 text-white\" />\n                    </div>\n                    <div className=\"flex-1 min-w-0\">\n                      <p className=\"font-semibold text-slate-900 text-sm truncate\">{site.name}</p>\n                      <p className=\"text-xs text-slate-600 truncate\">{site.address || 'Endereço não informado'}</p>\n                    </div>\n                  </div>\n                </div>\n              ))}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 relative\">\n      {/* Header Mobile */}\n      <div className=\"bg-white/90 backdrop-blur-lg border-b border-white/20 shadow-lg sticky top-0 z-50\">\n        <div className=\"px-4 py-4 space-y-3\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center space-x-3\">\n              {currentPage !== \"dashboard\" && (\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={() => setCurrentPage(\"dashboard\")}\n                  className=\"p-2\"\n                >\n                  <ArrowLeft className=\"w-5 h-5\" />\n                </Button>\n              )}\n              <div className=\"w-10 h-10 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-xl flex items-center justify-center\">\n                <span className=\"text-white font-bold text-lg\">O</span>\n              </div>\n              <div>\n                <h1 className=\"text-lg font-bold text-slate-900\">OPUS CLEAN</h1>\n                <p className=\"text-sm text-slate-600\">\n                  {currentPage === \"dashboard\" ? \"Visão Geral\" : \n                   currentPage === \"sites\" ? \"Locais\" :\n                   currentPage === \"services\" ? \"Serviços\" :\n                   currentPage === \"service-settings\" ? \"Configurações\" :\n                   currentPage === \"schedule\" ? \"Cronograma\" :\n                   currentPage === \"qrcodes\" ? \"QR Codes\" :\n                   currentPage === \"checklists\" ? \"Checklists\" :\n                   currentPage === \"workorders\" ? \"Ordens de Serviço\" :\n                   currentPage === \"users\" ? \"Usuários\" :\n                   currentPage === \"reports\" ? \"Relatórios\" :\n                   currentPage === \"dashboards\" ? \"Dashboards\" : \"Visão Geral\"}\n                </p>\n              </div>\n            </div>\n            <div className=\"flex items-center space-x-2\">\n              <Button \n                variant=\"ghost\" \n                size=\"sm\"\n                onClick={() => setIsMenuOpen(!isMenuOpen)}\n                className=\"text-slate-600\"\n              >\n                {isMenuOpen ? <X className=\"w-5 h-5\" /> : <Menu className=\"w-5 h-5\" />}\n              </Button>\n            </div>\n          </div>\n          \n          {/* Seletor de Cliente para Admin OPUS */}\n          {!isCustomerUser && (\n            <div className=\"w-full\">\n              <Select value={activeClientId} onValueChange={setActiveClientId}>\n                <SelectTrigger className=\"w-full bg-white/50 text-sm h-10\" data-testid=\"mobile-customer-selector\">\n                  <SelectValue placeholder=\"Selecione um cliente\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {(customers as any[])?.map((customer: any) => (\n                    <SelectItem key={customer.id} value={customer.id}>\n                      {customer.name}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n          )}\n          \n          {/* Nome do Cliente fixo para customer_user */}\n          {isCustomerUser && selectedCustomer && (\n            <div className=\"w-full px-3 py-2 bg-blue-50 border border-blue-200 rounded-lg\">\n              <p className=\"text-xs text-blue-600 font-medium\">Cliente</p>\n              <p className=\"text-sm font-semibold text-blue-900\">{(selectedCustomer as any).name}</p>\n            </div>\n          )}\n        </div>\n      </div>\n\n      {/* Slide Menu */}\n      {isMenuOpen && (\n        <div className=\"fixed inset-0 bg-black/60 backdrop-blur-sm z-50 transition-opacity\" onClick={() => setIsMenuOpen(false)}>\n          <div className=\"absolute right-0 top-0 h-full w-80 bg-white shadow-2xl flex flex-col animate-in slide-in-from-right\" onClick={(e) => e.stopPropagation()}>\n            {/* Header */}\n            <div className=\"p-6 bg-gradient-to-br from-blue-600 to-indigo-700 flex-shrink-0\">\n              <div className=\"flex items-center space-x-3\">\n                <div className=\"w-14 h-14 bg-white/20 backdrop-blur-sm rounded-2xl flex items-center justify-center ring-2 ring-white/30\">\n                  <User className=\"w-7 h-7 text-white\" />\n                </div>\n                <div>\n                  <p className=\"font-bold text-white text-lg\">{user?.name}</p>\n                  <p className=\"text-sm text-white/80\">{user?.role}</p>\n                </div>\n              </div>\n            </div>\n            \n            {/* Menu Items - Scrollable */}\n            <div className=\"flex-1 overflow-y-auto p-4 space-y-1\">\n              <Button \n                variant=\"ghost\" \n                className=\"w-full justify-start h-11 rounded-lg hover:bg-blue-50 hover:text-blue-700 transition-colors\" \n                onClick={() => { setCurrentPage(\"dashboard\"); setIsMenuOpen(false); }}\n              >\n                <Home className=\"w-5 h-5 mr-3\" />\n                Visão Geral\n              </Button>\n              <Button \n                variant=\"ghost\" \n                className=\"w-full justify-start h-11 rounded-lg hover:bg-blue-50 hover:text-blue-700 transition-colors\" \n                onClick={() => { setCurrentPage(\"dashboards\"); setIsMenuOpen(false); }}\n              >\n                <BarChart3 className=\"w-5 h-5 mr-3\" />\n                Dashboards\n              </Button>\n              <Button \n                variant=\"ghost\" \n                className=\"w-full justify-start h-11 rounded-lg hover:bg-blue-50 hover:text-blue-700 transition-colors\" \n                onClick={() => { setCurrentPage(\"workorders\"); setIsMenuOpen(false); }}\n              >\n                <ClipboardList className=\"w-5 h-5 mr-3\" />\n                Ordens de Serviço\n              </Button>\n              <Button \n                variant=\"ghost\" \n                className=\"w-full justify-start h-11 rounded-lg hover:bg-blue-50 hover:text-blue-700 transition-colors\" \n                onClick={() => { setCurrentPage(\"service-settings\"); setIsMenuOpen(false); }}\n              >\n                <Cog className=\"w-5 h-5 mr-3\" />\n                Configurações\n              </Button>\n              <Button \n                variant=\"ghost\" \n                className=\"w-full justify-start h-11 rounded-lg hover:bg-blue-50 hover:text-blue-700 transition-colors\" \n                onClick={() => { setCurrentPage(\"schedule\"); setIsMenuOpen(false); }}\n              >\n                <Calendar className=\"w-5 h-5 mr-3\" />\n                Cronograma\n              </Button>\n              <Button \n                variant=\"ghost\" \n                className=\"w-full justify-start h-11 rounded-lg hover:bg-blue-50 hover:text-blue-700 transition-colors\" \n                onClick={() => { setCurrentPage(\"qrcodes\"); setIsMenuOpen(false); }}\n              >\n                <QrCode className=\"w-5 h-5 mr-3\" />\n                QR Codes\n              </Button>\n              <Button \n                variant=\"ghost\" \n                className=\"w-full justify-start h-11 rounded-lg hover:bg-blue-50 hover:text-blue-700 transition-colors\" \n                onClick={() => { setCurrentPage(\"checklists\"); setIsMenuOpen(false); }}\n              >\n                <List className=\"w-5 h-5 mr-3\" />\n                Checklists\n              </Button>\n              <Button \n                variant=\"ghost\" \n                className=\"w-full justify-start h-11 rounded-lg hover:bg-blue-50 hover:text-blue-700 transition-colors\" \n                onClick={() => { setCurrentPage(\"reports\"); setIsMenuOpen(false); }}\n              >\n                <BarChart3 className=\"w-5 h-5 mr-3\" />\n                Relatórios\n              </Button>\n            </div>\n            \n            {/* Footer - Fixed */}\n            <div className=\"flex-shrink-0 p-4 border-t bg-slate-50\">\n              <Button \n                variant=\"ghost\" \n                className=\"w-full justify-start h-12 text-red-600 hover:text-red-700 hover:bg-red-50 rounded-lg font-semibold transition-colors\" \n                onClick={handleLogout}\n              >\n                <LogOut className=\"w-5 h-5 mr-3\" />\n                Sair da Conta\n              </Button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {renderPageContent()}\n    </div>\n  );\n}\n\n// Componente CleaningScheduleMobile - Calendário otimizado para mobile\nfunction CleaningScheduleMobile({ companyId }: { companyId: string }) {\n  const [currentDate, setCurrentDate] = useState(new Date());\n  const [viewMode, setViewMode] = useState<\"week\" | \"month\">(\"month\");\n\n  const { data: activities = [], isLoading } = useQuery({\n    queryKey: [\"/api/companies\", companyId, \"cleaning-activities\"],\n    enabled: !!companyId,\n  });\n\n  const { data: zones = [] } = useQuery({\n    queryKey: [\"/api/companies\", companyId, \"zones\"],\n    enabled: !!companyId,\n  });\n\n  // Funções para navegação de data\n  const goToPrevious = () => {\n    if (viewMode === \"month\") {\n      setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1));\n    } else {\n      setCurrentDate(new Date(currentDate.getTime() - 7 * 24 * 60 * 60 * 1000));\n    }\n  };\n\n  const goToNext = () => {\n    if (viewMode === \"month\") {\n      setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1));\n    } else {\n      setCurrentDate(new Date(currentDate.getTime() + 7 * 24 * 60 * 60 * 1000));\n    }\n  };\n\n  const goToToday = () => {\n    setCurrentDate(new Date());\n  };\n\n  // Função para obter as cores das frequências\n  const getFrequencyColor = (frequency: string) => {\n    switch (frequency) {\n      case \"diaria\":\n        return \"bg-green-500 text-white\";\n      case \"semanal\":\n        return \"bg-blue-500 text-white\";\n      case \"mensal\":\n        return \"bg-purple-500 text-white\";\n      case \"turno\":\n        return \"bg-orange-500 text-white\";\n      default:\n        return \"bg-gray-500 text-white\";\n    }\n  };\n\n  // Renderizar calendário mensal\n  const renderMonthCalendar = () => {\n    const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);\n    const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);\n    const startDate = new Date(firstDay);\n    startDate.setDate(startDate.getDate() - firstDay.getDay());\n\n    const days = [];\n    const currentDay = new Date(startDate);\n\n    for (let i = 0; i < 42; i++) {\n      const day = new Date(currentDay);\n      const isCurrentMonth = day.getMonth() === currentDate.getMonth();\n      const isToday = day.toDateString() === new Date().toDateString();\n\n      days.push(\n        <div\n          key={i}\n          className={`p-2 min-h-[60px] border-r border-b border-gray-100 ${\n            !isCurrentMonth ? \"bg-gray-50 text-gray-400\" : \"bg-white\"\n          } ${isToday ? \"bg-blue-50 border-blue-200\" : \"\"}`}\n        >\n          <div className={`text-sm font-medium ${isToday ? \"text-blue-600\" : \"\"}`}>\n            {day.getDate()}\n          </div>\n          <div className=\"mt-1 space-y-1\">\n            {(activities as any[])\n              .filter((activity: any) => {\n                // Simples lógica para mostrar atividades baseado na frequência\n                if (activity.frequency === \"diaria\") return true;\n                if (activity.frequency === \"semanal\") return day.getDay() === 1; // Segundas\n                if (activity.frequency === \"mensal\") return day.getDate() === 1; // Primeiro dia do mês\n                return false;\n              })\n              .slice(0, 2)\n              .map((activity: any, idx: number) => (\n                <div\n                  key={`${activity.id}-${idx}`}\n                  className={`text-xs px-1.5 py-0.5 rounded truncate ${getFrequencyColor(activity.frequency)}`}\n                >\n                  {activity.name}\n                </div>\n              ))}\n          </div>\n        </div>\n      );\n\n      currentDay.setDate(currentDay.getDate() + 1);\n    }\n\n    return (\n      <div className=\"bg-white rounded-lg border\">\n        {/* Cabeçalho dos dias da semana */}\n        <div className=\"grid grid-cols-7 border-b\">\n          {[\"Dom\", \"Seg\", \"Ter\", \"Qua\", \"Qui\", \"Sex\", \"Sab\"].map((day) => (\n            <div key={day} className=\"p-3 text-center text-sm font-medium text-gray-600 border-r last:border-r-0\">\n              {day}\n            </div>\n          ))}\n        </div>\n        {/* Grid dos dias */}\n        <div className=\"grid grid-cols-7\">{days}</div>\n      </div>\n    );\n  };\n\n  // Renderizar calendário semanal\n  const renderWeekCalendar = () => {\n    const startOfWeek = new Date(currentDate);\n    startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());\n\n    const days = [];\n    for (let i = 0; i < 7; i++) {\n      const day = new Date(startOfWeek);\n      day.setDate(startOfWeek.getDate() + i);\n      const isToday = day.toDateString() === new Date().toDateString();\n\n      days.push(\n        <div key={i} className=\"flex-1 min-h-[200px] p-3 border-r last:border-r-0\">\n          <div className={`text-center pb-2 border-b mb-3 ${isToday ? \"text-blue-600 font-bold\" : \"\"}`}>\n            <div className=\"text-xs text-gray-500\">\n              {day.toLocaleDateString(\"pt-BR\", { weekday: \"short\" })}\n            </div>\n            <div className=\"text-lg font-semibold\">{day.getDate()}</div>\n          </div>\n          <div className=\"space-y-2\">\n            {(activities as any[])\n              .filter((activity: any) => {\n                if (activity.frequency === \"diaria\") return true;\n                if (activity.frequency === \"semanal\") return day.getDay() === 1;\n                if (activity.frequency === \"mensal\") return day.getDate() === 1;\n                return false;\n              })\n              .map((activity: any, idx: number) => (\n                <div\n                  key={`${activity.id}-${idx}`}\n                  className={`text-xs p-2 rounded-lg ${getFrequencyColor(activity.frequency)}`}\n                >\n                  <div className=\"font-medium truncate\">{activity.name}</div>\n                  {(zones as any[]).find((z: any) => z.id === activity.zoneId) && (\n                    <div className=\"text-xs opacity-75 mt-1 flex items-center gap-1\">\n                      <MapPin className=\"w-3 h-3\" />\n                      {(zones as any[]).find((z: any) => z.id === activity.zoneId)?.name}\n                    </div>\n                  )}\n                </div>\n              ))}\n          </div>\n        </div>\n      );\n    }\n\n    return (\n      <div className=\"bg-white rounded-lg border\">\n        <div className=\"flex\">{days}</div>\n      </div>\n    );\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"p-4 space-y-4\">\n        <div className=\"animate-pulse\">\n          <div className=\"h-6 bg-gray-200 rounded w-1/2 mb-4\"></div>\n          <div className=\"h-40 bg-gray-200 rounded\"></div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-3 space-y-4 bg-slate-50 min-h-screen\">\n      {/* Header com controles */}\n      <div className=\"space-y-3\">\n        <div className=\"flex items-center justify-between\">\n          <h1 className=\"text-lg font-bold text-slate-900 flex items-center gap-2\">\n            <Calendar className=\"w-5 h-5 text-blue-600\" />\n            Plano de Limpeza\n          </h1>\n          <Button size=\"sm\" variant=\"outline\" onClick={goToToday}>\n            Hoje\n          </Button>\n        </div>\n\n        {/* Navegação de data */}\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-2\">\n            <Button size=\"sm\" variant=\"outline\" onClick={goToPrevious}>\n              <ChevronLeft className=\"w-4 h-4\" />\n            </Button>\n            <div className=\"text-base font-semibold text-gray-900 min-w-[140px] text-center\">\n              {viewMode === \"month\"\n                ? currentDate.toLocaleDateString(\"pt-BR\", { month: \"long\", year: \"numeric\" })\n                : `${currentDate.toLocaleDateString(\"pt-BR\", { day: \"2-digit\", month: \"short\" })}`}\n            </div>\n            <Button size=\"sm\" variant=\"outline\" onClick={goToNext}>\n              <ChevronRight className=\"w-4 h-4\" />\n            </Button>\n          </div>\n\n          {/* Toggle de visualização */}\n          <div className=\"flex bg-gray-100 rounded-lg p-1\">\n            <Button\n              size=\"sm\"\n              variant={viewMode === \"week\" ? \"default\" : \"ghost\"}\n              className=\"text-xs px-3\"\n              onClick={() => setViewMode(\"week\")}\n            >\n              Semana\n            </Button>\n            <Button\n              size=\"sm\"\n              variant={viewMode === \"month\" ? \"default\" : \"ghost\"}\n              className=\"text-xs px-3\"\n              onClick={() => setViewMode(\"month\")}\n            >\n              Mês\n            </Button>\n          </div>\n        </div>\n      </div>\n\n      {/* Calendário */}\n      {viewMode === \"month\" ? renderMonthCalendar() : renderWeekCalendar()}\n\n      {/* Lista de atividades abaixo do calendário */}\n      <Card>\n        <CardHeader className=\"pb-3\">\n          <CardTitle className=\"text-sm flex items-center gap-2\">\n            <List className=\"w-4 h-4\" />\n            Atividades Programadas ({(activities as any[]).length})\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-3\">\n          {(activities as any[]).slice(0, 5).map((activity: any) => (\n            <div key={activity.id} className=\"flex items-center justify-between p-3 bg-gray-50 rounded-lg\">\n              <div className=\"flex-1\">\n                <div className=\"flex items-center gap-2\">\n                  <div className={`w-2 h-2 rounded-full ${getFrequencyColor(activity.frequency).split(' ')[0]}`}></div>\n                  <span className=\"text-sm font-medium text-gray-900\">{activity.name}</span>\n                </div>\n                <div className=\"flex items-center gap-4 mt-1\">\n                  <div className=\"flex items-center gap-1 text-xs text-gray-600\">\n                    <MapPin className=\"w-3 h-3\" />\n                    {(zones as any[]).find((z: any) => z.id === activity.zoneId)?.name || \"Local não encontrado\"}\n                  </div>\n                  <div className=\"flex items-center gap-1 text-xs text-gray-600\">\n                    <Timer className=\"w-3 h-3\" />\n                    {activity.frequency === \"diaria\" ? \"Diário\" : \n                     activity.frequency === \"semanal\" ? \"Semanal\" :\n                     activity.frequency === \"mensal\" ? \"Mensal\" : \"Por Turno\"}\n                  </div>\n                </div>\n              </div>\n            </div>\n          ))}\n          {(activities as any[]).length === 0 && (\n            <div className=\"text-center py-6 text-gray-500\">\n              <Calendar className=\"w-8 h-8 mx-auto mb-2 text-gray-300\" />\n              <p className=\"text-sm\">Nenhuma atividade programada</p>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}","size_bytes":50870},"client/src/pages/checklists.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { ModernCard, ModernCardContent, ModernCardHeader } from \"@/components/ui/modern-card\";\nimport { ModernPageHeader } from \"@/components/ui/modern-page-header\";\nimport { useModuleTheme } from \"@/hooks/use-module-theme\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Popover, PopoverContent, PopoverTrigger } from \"@/components/ui/popover\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useClient } from \"@/contexts/ClientContext\";\nimport { useModule } from \"@/contexts/ModuleContext\";\nimport { useLocation } from \"wouter\";\nimport { cn } from \"@/lib/utils\";\nimport { Plus, Edit3, Trash2, FileText, List, Eye, ChevronDown } from \"lucide-react\";\nimport type { ChecklistTemplate } from \"@shared/schema\";\n\nfunction MultiSelect({\n  label,\n  options,\n  value,\n  onChange,\n  placeholder,\n  disabled,\n  \"data-testid\": dataTestId,\n}: {\n  label: string;\n  options: { value: string; label: string }[];\n  value: string[];\n  onChange: (vals: string[]) => void;\n  placeholder?: string;\n  disabled?: boolean;\n  \"data-testid\"?: string;\n}) {\n  const [open, setOpen] = useState(false);\n  \n  const toggleOption = (optionValue: string) => {\n    if (value.includes(optionValue)) {\n      onChange(value.filter(v => v !== optionValue));\n    } else {\n      onChange([...value, optionValue]);\n    }\n  };\n\n  const selectedLabels = options\n    .filter(opt => value.includes(opt.value))\n    .map(opt => opt.label)\n    .join(\", \");\n\n  return (\n    <div className=\"space-y-2\">\n      <Label>{label}</Label>\n      <Popover open={open} onOpenChange={setOpen}>\n        <PopoverTrigger asChild>\n          <Button\n            variant=\"outline\"\n            role=\"combobox\"\n            aria-expanded={open}\n            className=\"w-full justify-between\"\n            disabled={disabled}\n            data-testid={dataTestId}\n          >\n            <span className=\"truncate\">\n              {selectedLabels || placeholder || \"Selecione...\"}\n            </span>\n            <ChevronDown className=\"ml-2 h-4 w-4 shrink-0 opacity-50\" />\n          </Button>\n        </PopoverTrigger>\n        <PopoverContent className=\"w-full p-0\" align=\"start\">\n          <div className=\"max-h-64 overflow-auto p-2\">\n            {options.length === 0 ? (\n              <div className=\"p-2 text-sm text-muted-foreground\">\n                {placeholder || \"Sem opções\"}\n              </div>\n            ) : (\n              <div className=\"space-y-1\">\n                {options.map((option) => (\n                  <div\n                    key={option.value}\n                    className=\"flex items-center space-x-2 p-2 hover:bg-accent rounded-sm cursor-pointer\"\n                    onClick={() => toggleOption(option.value)}\n                  >\n                    <Checkbox\n                      checked={value.includes(option.value)}\n                      onCheckedChange={() => toggleOption(option.value)}\n                    />\n                    <label className=\"flex-1 cursor-pointer text-sm\">\n                      {option.label}\n                    </label>\n                  </div>\n                ))}\n              </div>\n            )}\n          </div>\n        </PopoverContent>\n      </Popover>\n      <div className=\"text-xs text-slate-500\">\n        {value?.length ? `${value.length} selecionado(s)` : \"Nenhum selecionado\"}\n      </div>\n    </div>\n  );\n}\n\n\ninterface ChecklistItem {\n  id: string;\n  type: 'text' | 'number' | 'photo' | 'checkbox';\n  label: string;\n  required: boolean;\n  description?: string;\n  options?: string[]; // Para tipo checkbox - lista de opções\n  validation?: {\n    minLength?: number;\n    maxLength?: number;\n    minValue?: number;\n    maxValue?: number;\n    photoRequired?: boolean;\n    photoMinCount?: number;\n    photoMaxCount?: number;\n    minChecked?: number; // Mínimo de checks obrigatórios\n    maxChecked?: number; // Máximo de checks permitidos\n  };\n}\n\ninterface Checklist {\n  id: string;\n  name: string;\n  description: string;\n  items: ChecklistItem[];\n  companyId: string;\n  createdAt: string;\n  updatedAt: string;\n}\n\nexport default function Checklists() {\n  const { activeClientId } = useClient();\n  const { currentModule } = useModule();\n  const [, setLocation] = useLocation();\n\n  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);\n  const [editingChecklist, setEditingChecklist] = useState<Checklist | null>(null);\n  const [checklistForm, setChecklistForm] = useState({\n    name: \"\",\n    description: \"\",\n    siteIds: [] as string[],\n    zoneIds: [] as string[],\n    serviceId: \"\",\n    items: [] as ChecklistItem[]\n  });\n  const [newItem, setNewItem] = useState<Partial<ChecklistItem>>({\n    type: 'text',\n    label: \"\",\n    required: false,\n    description: \"\",\n    options: [],\n    validation: {}\n  });\n\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  const { data: checklists = [], isLoading } = useQuery<ChecklistTemplate[]>({\n    queryKey: [\"/api/customers\", activeClientId, \"checklist-templates\"],\n    enabled: !!activeClientId,\n  });\n\n  const { data: sites = [] } = useQuery({\n    queryKey: [\"/api/customers\", activeClientId, \"sites\", { module: currentModule }],\n    enabled: !!activeClientId,\n  });\n\n  const { data: services = [] } = useQuery({\n    queryKey: [\"/api/customers\", activeClientId, \"services\"],\n    enabled: !!activeClientId,\n  });\n\n  // Buscar zonas quando um site é selecionado\n  const { data: zones = [] } = useQuery({\n    queryKey: [\"/api/zones\", (checklistForm.siteIds || []).join(\",\"), { module: currentModule }],\n    enabled: Array.isArray(checklistForm.siteIds) && checklistForm.siteIds.length > 0,\n    queryFn: async () => {\n      const ids = checklistForm.siteIds;\n      if (!ids?.length) return [];\n      if (ids.length === 1) {\n        const qs = new URLSearchParams();\n        qs.set(\"module\", currentModule);\n        const r = await fetch(`/api/sites/${ids[0]}/zones?${qs.toString()}`);\n        if (!r.ok) throw new Error(\"Falha ao carregar zonas\");\n        return r.json();\n      }\n      const qs = new URLSearchParams();\n      qs.set(\"siteIds\", ids.join(\",\"));\n      qs.set(\"module\", currentModule);\n      const r = await fetch(`/api/zones?${qs.toString()}`);\n      if (!r.ok) throw new Error(\"Falha ao carregar zonas\");\n      return r.json();\n    }\n  });\n\n  // Redirect if not in clean module\n  useEffect(() => {\n    if (currentModule !== 'clean') {\n      setLocation('/');\n    }\n  }, [currentModule, setLocation]);\n\n  const createChecklistMutation = useMutation({\n    mutationFn: async (data: typeof checklistForm) => {\n      const response = await apiRequest(\"POST\", `/api/customers/${activeClientId}/checklist-templates`, data);\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/customers\", activeClientId, \"checklist-templates\"] });\n      setIsCreateDialogOpen(false);\n      resetForm();\n      toast({\n        title: \"Checklist criado\",\n        description: \"O checklist foi criado com sucesso.\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Erro ao criar checklist\",\n        description: \"Houve um problema ao criar o checklist.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateChecklistMutation = useMutation({\n    mutationFn: async (data: typeof checklistForm & { id: string }) => {\n      const response = await apiRequest(\"PUT\", `/api/customers/${activeClientId}/checklist-templates/${data.id}`, data);\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/customers\", activeClientId, \"checklist-templates\"] });\n      setIsCreateDialogOpen(false);\n      setEditingChecklist(null);\n      resetForm();\n      toast({\n        title: \"Checklist atualizado\",\n        description: \"O checklist foi atualizado com sucesso.\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Erro ao atualizar checklist\",\n        description: \"Houve um problema ao atualizar o checklist.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteChecklistMutation = useMutation({\n    mutationFn: async (checklistId: string) => {\n      await apiRequest(\"DELETE\", `/api/customers/${activeClientId}/checklist-templates/${checklistId}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/customers\", activeClientId, \"checklist-templates\"] });\n      toast({\n        title: \"Checklist excluído\",\n        description: \"O checklist foi excluído com sucesso.\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Erro ao excluir checklist\",\n        description: \"Houve um problema ao excluir o checklist.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const resetForm = () => {\n    setChecklistForm({\n      name: \"\",\n      description: \"\",\n      siteIds: [],\n      zoneIds: [],\n      serviceId: \"\",\n      items: []\n    });\n    setNewItem({\n      type: 'text',\n      label: \"\",\n      required: false,\n      description: \"\",\n      options: [],\n      validation: {}\n    });\n  };\n\n  const addItem = () => {\n    if (!newItem.label?.trim()) {\n      toast({\n        title: \"Campo obrigatório\",\n        description: \"O rótulo do item é obrigatório.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    const item: ChecklistItem = {\n      id: Date.now().toString(),\n      type: newItem.type as ChecklistItem['type'],\n      label: newItem.label,\n      required: newItem.required || false,\n      description: newItem.description || \"\",\n      options: newItem.options || [],\n      validation: newItem.validation || {}\n    };\n\n    setChecklistForm(prev => ({\n      ...prev,\n      items: [...prev.items, item]\n    }));\n\n    setNewItem({\n      type: 'text',\n      label: \"\",\n      required: false,\n      description: \"\",\n      options: [],\n      validation: {}\n    });\n  };\n\n  const removeItem = (itemId: string) => {\n    setChecklistForm(prev => ({\n      ...prev,\n      items: prev.items.filter(item => item.id !== itemId)\n    }));\n  };\n\n  const handleEdit = (checklist: any) => {\n    setEditingChecklist(checklist);\n    setChecklistForm({\n      name: checklist.name,\n      description: checklist.description,\n      siteIds: checklist.siteIds || (checklist.siteId ? [String(checklist.siteId)] : []),\n      zoneIds: checklist.zoneIds || (checklist.zoneId ? [String(checklist.zoneId)] : []),\n      serviceId: checklist.serviceId || \"\",\n      items: checklist.items\n    });\n    setIsCreateDialogOpen(true);\n  };\n\n  const handleSubmit = () => {\n    if (!checklistForm.name.trim()) {\n      toast({\n        title: \"Campo obrigatório\",\n        description: \"O nome do checklist é obrigatório.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (!checklistForm.siteIds?.length) {\n      toast({\n        title: \"Campo obrigatório\",\n        description: \"Selecione um local para o checklist.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (!checklistForm.zoneIds?.length) {\n      toast({\n        title: \"Campo obrigatório\",\n        description: \"Selecione uma zona para o checklist.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (!checklistForm.serviceId) {\n      toast({\n        title: \"Campo obrigatório\",\n        description: \"Selecione um serviço para o checklist.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (checklistForm.items.length === 0) {\n      toast({\n        title: \"Itens obrigatórios\",\n        description: \"Adicione pelo menos um item ao checklist.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (editingChecklist) {\n      updateChecklistMutation.mutate({\n        ...checklistForm,\n        id: editingChecklist.id\n      });\n    } else {\n      createChecklistMutation.mutate(checklistForm);\n    }\n  };\n\n  const getTypeIcon = (type: string) => {\n    switch (type) {\n      case 'photo': return <Eye className=\"w-4 h-4\" />;\n      case 'number': return <span className=\"w-4 h-4 text-center text-xs font-bold\">#</span>;\n      default: return <FileText className=\"w-4 h-4\" />;\n    }\n  };\n\n  const getTypeLabel = (type: string) => {\n    switch (type) {\n      case 'photo': return 'Foto';\n      case 'number': return 'Número';\n      case 'checkbox': return 'Checkbox';\n      default: return 'Texto';\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"h-full bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 p-6\">\n        <div className=\"text-center space-y-4\">\n          <div className=\"w-16 h-16 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mx-auto\"></div>\n          <p className=\"text-slate-600\">Carregando checklists...</p>\n        </div>\n      </div>\n    );\n  }\n\n  const theme = useModuleTheme();\n\n  return (\n    <div className={cn(\"min-h-screen\", theme.gradients.page)}>\n      <ModernPageHeader \n        title=\"Checklists\"\n        description=\"Gerencie checklists para padronizar ordens de serviço\"\n        icon={List}\n        stats={[\n          {\n            label: \"Total de Checklists\",\n            value: Array.isArray(checklists) ? checklists.length : 0,\n            icon: FileText\n          }\n        ]}\n        actions={\n          <Button \n            onClick={() => setIsCreateDialogOpen(true)}\n            className={cn(theme.buttons.primary)}\n            data-testid=\"button-create-checklist\"\n          >\n            <Plus className=\"w-4 h-4 mr-2\" />\n            Novo Checklist\n          </Button>\n        }\n      />\n      \n      {/* Dialog */}\n      <div className={cn(\"flex-1 overflow-y-auto p-4 md:p-6 space-y-6\", theme.gradients.section)}>\n        <Dialog open={isCreateDialogOpen} onOpenChange={(open) => {\n          setIsCreateDialogOpen(open);\n          if (!open) {\n            setEditingChecklist(null);\n            resetForm();\n          }\n        }}>\n          <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\">\n            <DialogHeader>\n              <DialogTitle>\n                {editingChecklist ? \"Editar Checklist\" : \"Criar Novo Checklist\"}\n              </DialogTitle>\n            </DialogHeader>\n            \n            <div className=\"space-y-6\">\n                  {/* Form básico */}\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"name\">Nome do Checklist</Label>\n                      <Input\n                        id=\"name\"\n                        data-testid=\"input-checklist-name\"\n                        value={checklistForm.name}\n                        onChange={(e) => setChecklistForm(prev => ({ ...prev, name: e.target.value }))}\n                        placeholder=\"Ex: Limpeza de Banheiros\"\n                      />\n                    </div>\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"description\">Descrição</Label>\n                      <Textarea\n                        id=\"description\"\n                        data-testid=\"input-checklist-description\"\n                        value={checklistForm.description}\n                        onChange={(e) => setChecklistForm(prev => ({ ...prev, description: e.target.value }))}\n                        placeholder=\"Descrição do checklist...\"\n                        rows={2}\n                      />\n                    </div>\n                  </div>\n\n                  {/* Vinculação obrigatória */}\n                  <div className=\"grid grid-cols-3 gap-4\">\n                    <div className=\"space-y-2\">\n                      <MultiSelect\n  label=\"Local *\"\n  options={(sites as any[] || []).map((s: any) => ({ value: String(s.id), label: s.name }))}\n  value={checklistForm.siteIds || []}\n  onChange={(vals) => setChecklistForm(prev => ({ ...prev, siteIds: vals, zoneIds: [] }))}\n  placeholder=\"Selecione um ou mais locais\"\n  data-testid=\"multiselect-checklist-sites\"\n/>\n                    </div>\n                    <div className=\"space-y-2\">\n                      <MultiSelect\n  label=\"Zona *\"\n  options={(zones as any[] || []).map((z: any) => ({ value: String(z.id), label: z.name }))}\n  value={checklistForm.zoneIds || []}\n  onChange={(vals) => setChecklistForm(prev => ({ ...prev, zoneIds: vals }))}\n  placeholder={(checklistForm.siteIds?.length ?? 0) > 0 ? \"Selecione uma ou mais zonas\" : \"Selecione ao menos um local\"}\n  disabled={!(checklistForm.siteIds?.length)}\n  data-testid=\"multiselect-checklist-zones\"\n/>\n                    </div>\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"serviceId\">Serviço <span className=\"text-red-500\">*</span></Label>\n                      <Select \n                        value={checklistForm.serviceId} \n                        onValueChange={(value) => setChecklistForm(prev => ({ ...prev, serviceId: value }))}\n                      >\n                        <SelectTrigger data-testid=\"select-checklist-service\">\n                          <SelectValue placeholder=\"Selecione o serviço\" />\n                        </SelectTrigger>\n                        <SelectContent>\n                          {(services as any[]).map((service) => (\n                            <SelectItem key={service.id} value={service.id}>\n                              {service.name}\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                    </div>\n                  </div>\n\n                  {/* Adicionar item */}\n                  <Card>\n                    <CardHeader>\n                      <CardTitle className=\"text-lg\">Adicionar Item</CardTitle>\n                    </CardHeader>\n                    <CardContent className=\"space-y-4\">\n                      <div className=\"grid grid-cols-3 gap-4\">\n                        <div className=\"space-y-2\">\n                          <Label>Tipo</Label>\n                          <Select \n                            value={newItem.type} \n                            onValueChange={(value) => setNewItem(prev => ({ ...prev, type: value as ChecklistItem['type'] }))}\n                          >\n                            <SelectTrigger data-testid=\"select-item-type\">\n                              <SelectValue />\n                            </SelectTrigger>\n                            <SelectContent>\n                              <SelectItem value=\"text\">Texto</SelectItem>\n                              <SelectItem value=\"number\">Número</SelectItem>\n                              <SelectItem value=\"photo\">Foto</SelectItem>\n                              <SelectItem value=\"checkbox\">Checkbox</SelectItem>\n                            </SelectContent>\n                          </Select>\n                        </div>\n                        <div className=\"space-y-2\">\n                          <Label>Rótulo</Label>\n                          <Input\n                            data-testid=\"input-item-label\"\n                            value={newItem.label}\n                            onChange={(e) => setNewItem(prev => ({ ...prev, label: e.target.value }))}\n                            placeholder=\"Ex: Limpeza concluída?\"\n                          />\n                        </div>\n                        <div className=\"space-y-2\">\n                          <Label>Observações</Label>\n                          <Input\n                            data-testid=\"input-item-description\"\n                            value={newItem.description}\n                            onChange={(e) => setNewItem(prev => ({ ...prev, description: e.target.value }))}\n                            placeholder=\"Instruções opcionais...\"\n                          />\n                        </div>\n                      </div>\n\n                      {/* Configurações avançadas baseadas no tipo */}\n                      {newItem.type && (\n                        <Card className=\"bg-slate-50\">\n                          <CardHeader className=\"pb-3\">\n                            <CardTitle className=\"text-sm\">Configurações Avançadas - {getTypeLabel(newItem.type || 'text')}</CardTitle>\n                          </CardHeader>\n                          <CardContent className=\"space-y-3\">\n                            {/* Configurações para Texto */}\n                            {newItem.type === 'text' && (\n                              <div className=\"grid grid-cols-2 gap-4\">\n                                <div className=\"space-y-1\">\n                                  <Label className=\"text-xs\">Mínimo de caracteres</Label>\n                                  <Input\n                                    type=\"number\"\n                                    placeholder=\"Ex: 10\"\n                                    value={newItem.validation?.minLength || \"\"}\n                                    onChange={(e) => setNewItem(prev => ({\n                                      ...prev,\n                                      validation: {\n                                        ...prev.validation,\n                                        minLength: e.target.value ? parseInt(e.target.value) : undefined\n                                      }\n                                    }))}\n                                    className=\"h-8 text-xs\"\n                                  />\n                                </div>\n                                <div className=\"space-y-1\">\n                                  <Label className=\"text-xs\">Máximo de caracteres</Label>\n                                  <Input\n                                    type=\"number\"\n                                    placeholder=\"Ex: 500\"\n                                    value={newItem.validation?.maxLength || \"\"}\n                                    onChange={(e) => setNewItem(prev => ({\n                                      ...prev,\n                                      validation: {\n                                        ...prev.validation,\n                                        maxLength: e.target.value ? parseInt(e.target.value) : undefined\n                                      }\n                                    }))}\n                                    className=\"h-8 text-xs\"\n                                  />\n                                </div>\n                              </div>\n                            )}\n\n                            {/* Configurações para Número */}\n                            {newItem.type === 'number' && (\n                              <div className=\"grid grid-cols-2 gap-4\">\n                                <div className=\"space-y-1\">\n                                  <Label className=\"text-xs\">Valor mínimo</Label>\n                                  <Input\n                                    type=\"number\"\n                                    placeholder=\"Ex: 0\"\n                                    value={newItem.validation?.minValue || \"\"}\n                                    onChange={(e) => setNewItem(prev => ({\n                                      ...prev,\n                                      validation: {\n                                        ...prev.validation,\n                                        minValue: e.target.value ? parseInt(e.target.value) : undefined\n                                      }\n                                    }))}\n                                    className=\"h-8 text-xs\"\n                                  />\n                                </div>\n                                <div className=\"space-y-1\">\n                                  <Label className=\"text-xs\">Valor máximo</Label>\n                                  <Input\n                                    type=\"number\"\n                                    placeholder=\"Ex: 100\"\n                                    value={newItem.validation?.maxValue || \"\"}\n                                    onChange={(e) => setNewItem(prev => ({\n                                      ...prev,\n                                      validation: {\n                                        ...prev.validation,\n                                        maxValue: e.target.value ? parseInt(e.target.value) : undefined\n                                      }\n                                    }))}\n                                    className=\"h-8 text-xs\"\n                                  />\n                                </div>\n                              </div>\n                            )}\n\n                            {/* Configurações para Foto */}\n                            {newItem.type === 'photo' && (\n                              <div className=\"space-y-3\">\n                                <div className=\"grid grid-cols-2 gap-4\">\n                                  <div className=\"space-y-1\">\n                                    <Label className=\"text-xs\">Mínimo de fotos</Label>\n                                    <Input\n                                      type=\"number\"\n                                      placeholder=\"Ex: 1\"\n                                      value={newItem.validation?.photoMinCount || \"\"}\n                                      onChange={(e) => setNewItem(prev => ({\n                                        ...prev,\n                                        validation: {\n                                          ...prev.validation,\n                                          photoMinCount: e.target.value ? parseInt(e.target.value) : undefined\n                                        }\n                                      }))}\n                                      className=\"h-8 text-xs\"\n                                    />\n                                  </div>\n                                  <div className=\"space-y-1\">\n                                    <Label className=\"text-xs\">Máximo de fotos</Label>\n                                    <Input\n                                      type=\"number\"\n                                      placeholder=\"Ex: 5\"\n                                      value={newItem.validation?.photoMaxCount || \"\"}\n                                      onChange={(e) => setNewItem(prev => ({\n                                        ...prev,\n                                        validation: {\n                                          ...prev.validation,\n                                          photoMaxCount: e.target.value ? parseInt(e.target.value) : undefined\n                                        }\n                                      }))}\n                                      className=\"h-8 text-xs\"\n                                    />\n                                  </div>\n                                </div>\n                                <div className=\"flex items-center space-x-2\">\n                                  <Switch\n                                    checked={newItem.validation?.photoRequired || false}\n                                    onCheckedChange={(checked) => setNewItem(prev => ({\n                                      ...prev,\n                                      validation: {\n                                        ...prev.validation,\n                                      photoRequired: checked\n                                      }\n                                    }))}\n                                  />\n                                  <Label className=\"text-xs\">Foto obrigatória (independente do campo obrigatório)</Label>\n                                </div>\n                              </div>\n                            )}\n\n                            {/* Configurações para Checkbox */}\n                            {newItem.type === 'checkbox' && (\n                              <div className=\"space-y-3\">\n                                <div className=\"space-y-2\">\n                                  <Label className=\"text-xs\">Opções do Checkbox</Label>\n                                  <div className=\"space-y-2\">\n                                    {(newItem.options || []).map((option, index) => (\n                                      <div key={index} className=\"flex gap-2\">\n                                        <Input\n                                          value={option}\n                                          onChange={(e) => {\n                                            const newOptions = [...(newItem.options || [])];\n                                            newOptions[index] = e.target.value;\n                                            setNewItem(prev => ({ ...prev, options: newOptions }));\n                                          }}\n                                          className=\"h-8 text-xs flex-1\"\n                                          placeholder={`Opção ${index + 1}`}\n                                        />\n                                        <Button\n                                          variant=\"ghost\"\n                                          size=\"sm\"\n                                          onClick={() => {\n                                            const newOptions = (newItem.options || []).filter((_, i) => i !== index);\n                                            setNewItem(prev => ({ ...prev, options: newOptions }));\n                                          }}\n                                          className=\"h-8\"\n                                        >\n                                          <Trash2 className=\"w-3 h-3\" />\n                                        </Button>\n                                      </div>\n                                    ))}\n                                    <Button\n                                      variant=\"outline\"\n                                      size=\"sm\"\n                                      onClick={() => {\n                                        setNewItem(prev => ({\n                                          ...prev,\n                                          options: [...(prev.options || []), '']\n                                        }));\n                                      }}\n                                      className=\"h-8 w-full\"\n                                    >\n                                      <Plus className=\"w-3 h-3 mr-2\" /> Adicionar Opção\n                                    </Button>\n                                  </div>\n                                </div>\n                                <div className=\"grid grid-cols-2 gap-4\">\n                                  <div className=\"space-y-1\">\n                                    <Label className=\"text-xs\">Mínimo de checks</Label>\n                                    <Input\n                                      type=\"number\"\n                                      placeholder=\"Ex: 1\"\n                                      value={newItem.validation?.minChecked || \"\"}\n                                      onChange={(e) => setNewItem(prev => ({\n                                        ...prev,\n                                        validation: {\n                                          ...prev.validation,\n                                          minChecked: e.target.value ? parseInt(e.target.value) : undefined\n                                        }\n                                      }))}\n                                      className=\"h-8 text-xs\"\n                                    />\n                                  </div>\n                                  <div className=\"space-y-1\">\n                                    <Label className=\"text-xs\">Máximo de checks</Label>\n                                    <Input\n                                      type=\"number\"\n                                      placeholder=\"Ex: 3\"\n                                      value={newItem.validation?.maxChecked || \"\"}\n                                      onChange={(e) => setNewItem(prev => ({\n                                        ...prev,\n                                        validation: {\n                                          ...prev.validation,\n                                          maxChecked: e.target.value ? parseInt(e.target.value) : undefined\n                                        }\n                                      }))}\n                                      className=\"h-8 text-xs\"\n                                    />\n                                  </div>\n                                </div>\n                              </div>\n                            )}\n                          </CardContent>\n                        </Card>\n                      )}\n\n                      <div className=\"flex items-center justify-between\">\n                        <div className=\"flex items-center space-x-2\">\n                          <Switch\n                            data-testid=\"switch-item-required\"\n                            checked={newItem.required}\n                            onCheckedChange={(checked) => setNewItem(prev => ({ ...prev, required: checked }))}\n                          />\n                          <Label>Campo obrigatório</Label>\n                        </div>\n                        <Button \n                          onClick={addItem} \n                          variant=\"outline\"\n                          data-testid=\"button-add-item\"\n                        >\n                          <Plus className=\"w-4 h-4 mr-2\" />\n                          Adicionar Item\n                        </Button>\n                      </div>\n                    </CardContent>\n                  </Card>\n\n                  {/* Lista de itens */}\n                  {checklistForm.items.length > 0 && (\n                    <Card>\n                      <CardHeader>\n                        <CardTitle className=\"text-lg\">Itens do Checklist ({checklistForm.items.length})</CardTitle>\n                      </CardHeader>\n                      <CardContent>\n                        <div className=\"space-y-3\">\n                          {checklistForm.items.map((item, index) => (\n                            <div key={item.id} className=\"flex items-center justify-between p-3 border rounded-lg bg-slate-50\">\n                              <div className=\"flex items-center space-x-3 flex-1\">\n                                <span className=\"text-sm font-medium text-slate-500\">#{index + 1}</span>\n                                <div className=\"flex items-center space-x-2\">\n                                  {getTypeIcon(item.type)}\n                                  <Badge variant=\"outline\">{getTypeLabel(item.type)}</Badge>\n                                </div>\n                                <div className=\"flex-1\">\n                                  <p className=\"font-medium\">{item.label}</p>\n                                  {item.description && (\n                                    <p className=\"text-sm text-slate-600\">{item.description}</p>\n                                  )}\n                                  {/* Mostrar opções do checkbox */}\n                                  {item.type === 'checkbox' && item.options && item.options.length > 0 && (\n                                    <div className=\"mt-2\">\n                                      <p className=\"text-xs text-slate-500 mb-1\">Opções:</p>\n                                      <div className=\"flex flex-wrap gap-1\">\n                                        {item.options.map((option, optIndex) => (\n                                          <Badge key={optIndex} variant=\"secondary\" className=\"text-xs\">\n                                            {option}\n                                          </Badge>\n                                        ))}\n                                      </div>\n                                    </div>\n                                  )}\n                                  {/* Mostrar configurações de validação aplicadas */}\n                                  {item.validation && Object.keys(item.validation).length > 0 && (\n                                    <div className=\"flex flex-wrap gap-1 mt-1\">\n                                      {item.validation.minLength && (\n                                        <Badge variant=\"outline\" className=\"text-xs bg-blue-50\">\n                                          Mín: {item.validation.minLength} chars\n                                        </Badge>\n                                      )}\n                                      {item.validation.maxLength && (\n                                        <Badge variant=\"outline\" className=\"text-xs bg-blue-50\">\n                                          Máx: {item.validation.maxLength} chars\n                                        </Badge>\n                                      )}\n                                      {item.validation.minValue !== undefined && (\n                                        <Badge variant=\"outline\" className=\"text-xs bg-green-50\">\n                                          Mín: {item.validation.minValue}\n                                        </Badge>\n                                      )}\n                                      {item.validation.maxValue !== undefined && (\n                                        <Badge variant=\"outline\" className=\"text-xs bg-green-50\">\n                                          Máx: {item.validation.maxValue}\n                                        </Badge>\n                                      )}\n                                      {item.validation.photoMinCount && (\n                                        <Badge variant=\"outline\" className=\"text-xs bg-purple-50\">\n                                          Mín: {item.validation.photoMinCount} fotos\n                                        </Badge>\n                                      )}\n                                      {item.validation.photoMaxCount && (\n                                        <Badge variant=\"outline\" className=\"text-xs bg-purple-50\">\n                                          Máx: {item.validation.photoMaxCount} fotos\n                                        </Badge>\n                                      )}\n                                      {item.validation.photoRequired && (\n                                        <Badge variant=\"outline\" className=\"text-xs bg-orange-50\">\n                                          Foto obrigatória\n                                        </Badge>\n                                      )}\n                                      {item.validation.minChecked && (\n                                        <Badge variant=\"outline\" className=\"text-xs bg-indigo-50\">\n                                          Mín: {item.validation.minChecked} checks\n                                        </Badge>\n                                      )}\n                                      {item.validation.maxChecked && (\n                                        <Badge variant=\"outline\" className=\"text-xs bg-indigo-50\">\n                                          Máx: {item.validation.maxChecked} checks\n                                        </Badge>\n                                      )}\n                                    </div>\n                                  )}\n                                </div>\n                                <div className=\"flex flex-col space-y-1\">\n                                  {item.required && (\n                                    <Badge className=\"bg-red-100 text-red-800 text-xs\">Obrigatório</Badge>\n                                  )}\n                                </div>\n                              </div>\n                              <Button\n                                variant=\"ghost\"\n                                size=\"sm\"\n                                onClick={() => removeItem(item.id)}\n                                data-testid={`button-remove-item-${index}`}\n                              >\n                                <Trash2 className=\"w-4 h-4 text-red-500\" />\n                              </Button>\n                            </div>\n                          ))}\n                        </div>\n                      </CardContent>\n                    </Card>\n                  )}\n\n                  {/* Botões de ação */}\n                  <div className=\"flex justify-end space-x-3\">\n                    <Button \n                      variant=\"outline\" \n                      onClick={() => {\n                        setIsCreateDialogOpen(false);\n                        setEditingChecklist(null);\n                        resetForm();\n                      }}\n                    >\n                      Cancelar\n                    </Button>\n                    <Button \n                      onClick={handleSubmit}\n                      disabled={createChecklistMutation.isPending || updateChecklistMutation.isPending}\n                      data-testid=\"button-save-checklist\"\n                    >\n                      {createChecklistMutation.isPending || updateChecklistMutation.isPending \n                        ? \"Salvando...\" \n                        : editingChecklist ? \"Atualizar\" : \"Criar\"\n                      }\n                    </Button>\n                  </div>\n                </div>\n          </DialogContent>\n        </Dialog>\n\n        {/* Content */}\n        {!Array.isArray(checklists) || checklists.length === 0 ? (\n          <ModernCard variant=\"glass\">\n            <ModernCardContent className=\"p-12 text-center\">\n              <List className={cn(\"w-16 h-16 mx-auto mb-4\", theme.text.primary)} />\n              <h3 className=\"text-xl font-semibold text-slate-900 mb-2\">\n                Nenhum checklist criado\n              </h3>\n              <p className=\"text-slate-600 mb-6\">\n                Crie seu primeiro checklist para padronizar ordens de serviço.\n              </p>\n              <Button \n                onClick={() => setIsCreateDialogOpen(true)}\n                className={cn(theme.buttons.primary)}\n              >\n                <Plus className=\"w-4 h-4 mr-2\" />\n                Criar Primeiro Checklist\n              </Button>\n            </ModernCardContent>\n          </ModernCard>\n        ) : (\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n            {Array.isArray(checklists) && checklists.map((checklist: any) => (\n              <ModernCard key={checklist.id} variant=\"gradient\">\n                <CardHeader>\n                  <div className=\"flex items-start justify-between\">\n                    <div className=\"flex-1\">\n                      <CardTitle className=\"text-lg\">{checklist.name}</CardTitle>\n                      <p className=\"text-sm text-slate-600 mt-1\">{checklist.description}</p>\n                    </div>\n                    <div className=\"flex space-x-1\">\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={() => handleEdit(checklist)}\n                        data-testid={`button-edit-checklist-${checklist.id}`}\n                      >\n                        <Edit3 className=\"w-4 h-4\" />\n                      </Button>\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={() => deleteChecklistMutation.mutate(checklist.id)}\n                        data-testid={`button-delete-checklist-${checklist.id}`}\n                      >\n                        <Trash2 className=\"w-4 h-4 text-red-500\" />\n                      </Button>\n                    </div>\n                  </div>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"space-y-2\">\n                    <div className=\"flex items-center justify-between text-sm\">\n                      <span className=\"text-slate-600\">Total de itens:</span>\n                      <Badge variant=\"outline\">{Array.isArray(checklist.items) ? checklist.items.length : 0}</Badge>\n                    </div>\n                    <div className=\"flex items-center justify-between text-sm\">\n                      <span className=\"text-slate-600\">Obrigatórios:</span>\n                      <Badge variant=\"outline\" className=\"bg-red-50 text-red-700\">\n                        {Array.isArray(checklist.items) ? checklist.items.filter((item: any) => item.required).length : 0}\n                      </Badge>\n                    </div>\n                    <div className=\"text-xs text-slate-500\">\n                      Criado em: {checklist.createdAt ? new Date(checklist.createdAt).toLocaleDateString('pt-BR') : 'N/A'}\n                    </div>\n                  </div>\n                </CardContent>\n              </ModernCard>\n            ))}\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}","size_bytes":45569},"client/src/components/ui/collapsible.tsx":{"content":"\"use client\"\n\nimport * as CollapsiblePrimitive from \"@radix-ui/react-collapsible\"\n\nconst Collapsible = CollapsiblePrimitive.Root\n\nconst CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger\n\nconst CollapsibleContent = CollapsiblePrimitive.CollapsibleContent\n\nexport { Collapsible, CollapsibleTrigger, CollapsibleContent }\n","size_bytes":329},"client/src/components/ui/resizable.tsx":{"content":"\"use client\"\n\nimport { GripVertical } from \"lucide-react\"\nimport * as ResizablePrimitive from \"react-resizable-panels\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ResizablePanelGroup = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (\n  <ResizablePrimitive.PanelGroup\n    className={cn(\n      \"flex h-full w-full data-[panel-group-direction=vertical]:flex-col\",\n      className\n    )}\n    {...props}\n  />\n)\n\nconst ResizablePanel = ResizablePrimitive.Panel\n\nconst ResizableHandle = ({\n  withHandle,\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {\n  withHandle?: boolean\n}) => (\n  <ResizablePrimitive.PanelResizeHandle\n    className={cn(\n      \"relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90\",\n      className\n    )}\n    {...props}\n  >\n    {withHandle && (\n      <div className=\"z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border\">\n        <GripVertical className=\"h-2.5 w-2.5\" />\n      </div>\n    )}\n  </ResizablePrimitive.PanelResizeHandle>\n)\n\nexport { ResizablePanelGroup, ResizablePanel, ResizableHandle }\n","size_bytes":1723},"client/src/components/ui/calendar.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight } from \"lucide-react\"\nimport { DayPicker } from \"react-day-picker\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nexport type CalendarProps = React.ComponentProps<typeof DayPicker>\n\nfunction Calendar({\n  className,\n  classNames,\n  showOutsideDays = true,\n  ...props\n}: CalendarProps) {\n  return (\n    <DayPicker\n      showOutsideDays={showOutsideDays}\n      className={cn(\"p-3\", className)}\n      classNames={{\n        months: \"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0\",\n        month: \"space-y-4\",\n        caption: \"flex justify-center pt-1 relative items-center\",\n        caption_label: \"text-sm font-medium\",\n        nav: \"space-x-1 flex items-center\",\n        nav_button: cn(\n          buttonVariants({ variant: \"outline\" }),\n          \"h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100\"\n        ),\n        nav_button_previous: \"absolute left-1\",\n        nav_button_next: \"absolute right-1\",\n        table: \"w-full border-collapse space-y-1\",\n        head_row: \"flex\",\n        head_cell:\n          \"text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]\",\n        row: \"flex w-full mt-2\",\n        cell: \"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20\",\n        day: cn(\n          buttonVariants({ variant: \"ghost\" }),\n          \"h-9 w-9 p-0 font-normal aria-selected:opacity-100\"\n        ),\n        day_range_end: \"day-range-end\",\n        day_selected:\n          \"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground\",\n        day_today: \"bg-accent text-accent-foreground\",\n        day_outside:\n          \"day-outside text-muted-foreground aria-selected:bg-accent/50 aria-selected:text-muted-foreground\",\n        day_disabled: \"text-muted-foreground opacity-50\",\n        day_range_middle:\n          \"aria-selected:bg-accent aria-selected:text-accent-foreground\",\n        day_hidden: \"invisible\",\n        ...classNames,\n      }}\n      components={{\n        IconLeft: ({ className, ...props }) => (\n          <ChevronLeft className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n        IconRight: ({ className, ...props }) => (\n          <ChevronRight className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n      }}\n      {...props}\n    />\n  )\n}\nCalendar.displayName = \"Calendar\"\n\nexport { Calendar }\n","size_bytes":2695},"client/src/pages/mobile-dashboard.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { getAuthState, canOnlyViewOwnWorkOrders } from \"@/lib/auth\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { QrCode, ClipboardList, Clock, CheckCircle, AlertCircle, Camera, User, LogOut, MapPin, Calendar, Filter, RefreshCw } from \"lucide-react\";\nimport { useLocation } from \"wouter\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { logout } from \"@/lib/auth\";\nimport { queryClient } from \"@/lib/queryClient\";\nimport { useModule } from \"@/contexts/ModuleContext\";\nimport { MobileHeader } from \"@/components/mobile-header\";\n\ninterface WorkOrder {\n  id: string;\n  number: number;\n  title: string;\n  description: string;\n  status: string;\n  priority: string;\n  type: string;\n  assignedUserId: string | null;\n  siteName: string;\n  zoneName: string;\n  dueDate: string;\n  createdAt: string;\n}\n\nexport default function MobileDashboard() {\n  const { currentModule } = useModule();\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const { user } = getAuthState();\n  const [dateFilter, setDateFilter] = useState<'hoje' | 'ontem' | 'semana' | 'todos'>('todos');\n  const [isRefreshing, setIsRefreshing] = useState(false);\n  \n  // Get customerId - some users may not have customerId, use assignedClientId as fallback\n  const effectiveCustomerId = user ? ((user as any).customerId || (user as any).assignedClientId) : null;\n  \n  // Get current location context from localStorage (set by QR scanner)\n  const currentLocation = JSON.parse(localStorage.getItem('current-location') || 'null');\n  \n  // Buscar as OS - o hook precisa ser chamado antes de qualquer return\n  const { data: workOrders = [], isLoading } = useQuery({\n    queryKey: [\"/api/customers\", effectiveCustomerId, \"work-orders\", { module: currentModule, userId: user?.id, zoneId: currentLocation?.zoneId }],\n    enabled: !!effectiveCustomerId && !!user,\n    queryFn: async () => {\n      const params = new URLSearchParams();\n      \n      // Add module filter\n      if (currentModule) {\n        params.append('module', currentModule);\n      }\n      \n      // If we have a current location (from QR scan), filter by zone\n      if (currentLocation?.zoneId) {\n        params.append('zoneId', currentLocation.zoneId);\n      }\n      \n      // If user is an operator, filter by assignedTo\n      if (user?.id) {\n        params.append('assignedTo', user.id);\n      }\n      \n      const url = `/api/customers/${effectiveCustomerId}/work-orders?${params.toString()}`;\n      \n      const response = await fetch(url);\n      if (!response.ok) throw new Error('Failed to fetch work orders');\n      return response.json();\n    }\n  });\n  \n  // Verificar se o usuário é colaborador\n  if (!user || !canOnlyViewOwnWorkOrders(user)) {\n    return (\n      <div className=\"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center\">\n        <div className=\"text-center space-y-4\">\n          <p className=\"text-slate-600\">Redirecionando...</p>\n        </div>\n      </div>\n    );\n  }\n\n  // If no customer assigned, show error\n  if (!effectiveCustomerId) {\n    return (\n      <div className=\"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4\">\n        <Card className=\"max-w-md\">\n          <CardContent className=\"p-6 text-center\">\n            <AlertCircle className=\"w-16 h-16 text-red-500 mx-auto mb-4\" />\n            <h2 className=\"text-xl font-bold text-slate-900 mb-2\">Acesso Negado</h2>\n            <p className=\"text-slate-600\">\n              Seu usuário não está associado a nenhum cliente. Entre em contato com o administrador.\n            </p>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  // Função para filtrar OS por data\n  const filterWorkOrdersByDate = (orders: WorkOrder[]) => {\n    const today = new Date();\n    const yesterday = new Date();\n    yesterday.setDate(today.getDate() - 1);\n    const oneWeekAgo = new Date();\n    oneWeekAgo.setDate(today.getDate() - 7);\n\n    switch (dateFilter) {\n      case 'hoje':\n        return orders.filter(wo => {\n          const orderDate = new Date(wo.dueDate || wo.createdAt);\n          return orderDate.toDateString() === today.toDateString();\n        });\n      case 'ontem':\n        return orders.filter(wo => {\n          const orderDate = new Date(wo.dueDate || wo.createdAt);\n          return orderDate.toDateString() === yesterday.toDateString();\n        });\n      case 'semana':\n        return orders.filter(wo => {\n          const orderDate = new Date(wo.dueDate || wo.createdAt);\n          return orderDate >= oneWeekAgo && orderDate <= today;\n        });\n      case 'todos':\n      default:\n        return orders;\n    }\n  };\n\n  const filteredWorkOrders = filterWorkOrdersByDate(workOrders);\n\n  // Separar as OS em categorias\n  const availableOrders = filteredWorkOrders.filter(wo => \n    !wo.assignedUserId && wo.status !== 'concluida' && wo.status !== 'cancelada' && wo.status !== 'pausada'\n  );\n  \n  const myPendingOrders = filteredWorkOrders.filter(wo => \n    wo.assignedUserId === user.id && wo.status !== 'concluida' && wo.status !== 'cancelada' && wo.status !== 'pausada'\n  );\n  \n  const myPausedOrders = filteredWorkOrders.filter(wo => \n    wo.status === 'pausada'\n  );\n  \n  const myCompletedOrders = filteredWorkOrders.filter(wo => \n    wo.assignedUserId === user.id && wo.status === 'concluida'\n  );\n\n  const handleRefresh = async () => {\n    setIsRefreshing(true);\n    await queryClient.invalidateQueries({ \n      queryKey: [\"/api/customers\", effectiveCustomerId, \"work-orders\"] \n    });\n    setTimeout(() => setIsRefreshing(false), 1000);\n    toast({\n      title: \"Atualizado!\",\n      description: \"Lista de ordens de serviço atualizada.\",\n    });\n  };\n\n  const handleLogout = async () => {\n    try {\n      await logout();\n      setLocation(\"/login\");\n      toast({\n        title: \"Logout realizado\",\n        description: \"Você foi desconectado com sucesso.\",\n      });\n    } catch (error) {\n      toast({\n        title: \"Erro no logout\",\n        description: \"Houve um problema ao fazer logout.\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const handleQrScanner = () => {\n    setLocation(\"/mobile/qr-scanner\");\n  };\n\n  const getStatusColor = (status: string) => {\n    switch (status.toLowerCase()) {\n      case 'aberta': return 'bg-blue-100 text-blue-800 border-blue-200';\n      case 'em_andamento': return 'bg-yellow-100 text-yellow-800 border-yellow-200';\n      case 'concluida': return 'bg-green-100 text-green-800 border-green-200';\n      case 'pausada': return 'bg-orange-100 text-orange-800 border-orange-200';\n      case 'cancelada': return 'bg-red-100 text-red-800 border-red-200';\n      case 'vencida': return 'bg-red-100 text-red-800 border-red-200';\n      default: return 'bg-gray-100 text-gray-800 border-gray-200';\n    }\n  };\n\n  const getPriorityColor = (priority: string) => {\n    switch (priority.toLowerCase()) {\n      case 'baixa': return 'bg-green-500';\n      case 'media': return 'bg-yellow-500';\n      case 'alta': return 'bg-orange-500';\n      case 'critica': return 'bg-red-500';\n      default: return 'bg-gray-500';\n    }\n  };\n\n  // Formata DATE (scheduledDate, dueDate) - apenas data, sem hora\n  const formatDate = (dateString: string) => {\n    if (!dateString) return '-';\n    const match = dateString.match(/^(\\d{4})-(\\d{2})-(\\d{2})/);\n    if (match) {\n      const [, year, month, day] = match;\n      return `${day}/${month}/${year}`;\n    }\n    return dateString;\n  };\n\n  // Formata TIMESTAMP (createdAt, completedAt, startedAt) - data e hora\n  const formatDateTime = (dateString: string) => {\n    if (!dateString) return '-';\n    return new Date(dateString).toLocaleString('pt-BR', {\n      day: '2-digit',\n      month: '2-digit',\n      year: 'numeric',\n      hour: '2-digit',\n      minute: '2-digit'\n    });\n  };\n\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center\">\n        <div className=\"text-center space-y-4\">\n          <div className=\"w-16 h-16 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mx-auto\"></div>\n          <p className=\"text-slate-600\">Carregando suas ordens de serviço...</p>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 overflow-x-hidden\">\n      {/* Header Mobile com indicador de módulo */}\n      <MobileHeader\n        title={user.name}\n        subtitle=\"Colaborador\"\n        actions={\n          <>\n            <Button \n              variant=\"ghost\" \n              size=\"sm\"\n              onClick={handleRefresh}\n              className=\"text-white hover:bg-white/20\"\n              data-testid=\"button-refresh-mobile\"\n            >\n              <RefreshCw className={`w-5 h-5 transition-transform duration-1000 ${isRefreshing ? 'rotate-360' : ''}`} />\n            </Button>\n            <Button \n              variant=\"ghost\" \n              size=\"sm\"\n              onClick={handleLogout}\n              className=\"text-white hover:bg-white/20\"\n            >\n              <LogOut className=\"w-5 h-5\" />\n            </Button>\n          </>\n        }\n      />\n\n      <div className=\"p-4 space-y-6\">\n        {/* Filtros de Data */}\n        <Card className=\"bg-white/80 backdrop-blur-sm border-white/20\">\n          <CardHeader className=\"pb-3\">\n            <CardTitle className=\"text-sm font-semibold text-slate-700 flex items-center gap-2\">\n              <Filter className=\"w-4 h-4\" />\n              Filtrar por Data\n            </CardTitle>\n          </CardHeader>\n          <CardContent className=\"pt-0\">\n            <div className=\"grid grid-cols-2 gap-2\">\n              <Button\n                variant={dateFilter === 'hoje' ? 'default' : 'outline'}\n                size=\"sm\"\n                onClick={() => setDateFilter('hoje')}\n                className={`text-xs ${dateFilter === 'hoje' \n                  ? 'bg-blue-600 text-white hover:bg-blue-700' \n                  : 'border-blue-200 text-blue-700 hover:bg-blue-50'\n                }`}\n                data-testid=\"filter-hoje\"\n              >\n                <Calendar className=\"w-3 h-3 mr-1\" />\n                Hoje\n              </Button>\n              \n              <Button\n                variant={dateFilter === 'ontem' ? 'default' : 'outline'}\n                size=\"sm\"\n                onClick={() => setDateFilter('ontem')}\n                className={`text-xs ${dateFilter === 'ontem' \n                  ? 'bg-blue-600 text-white hover:bg-blue-700' \n                  : 'border-blue-200 text-blue-700 hover:bg-blue-50'\n                }`}\n                data-testid=\"filter-ontem\"\n              >\n                <Clock className=\"w-3 h-3 mr-1\" />\n                Ontem\n              </Button>\n              \n              <Button\n                variant={dateFilter === 'semana' ? 'default' : 'outline'}\n                size=\"sm\"\n                onClick={() => setDateFilter('semana')}\n                className={`text-xs ${dateFilter === 'semana' \n                  ? 'bg-blue-600 text-white hover:bg-blue-700' \n                  : 'border-blue-200 text-blue-700 hover:bg-blue-50'\n                }`}\n                data-testid=\"filter-semana\"\n              >\n                <Calendar className=\"w-3 h-3 mr-1\" />\n                Esta Semana\n              </Button>\n              \n              <Button\n                variant={dateFilter === 'todos' ? 'default' : 'outline'}\n                size=\"sm\"\n                onClick={() => setDateFilter('todos')}\n                className={`text-xs ${dateFilter === 'todos' \n                  ? 'bg-blue-600 text-white hover:bg-blue-700' \n                  : 'border-blue-200 text-blue-700 hover:bg-blue-50'\n                }`}\n                data-testid=\"filter-todos\"\n              >\n                <ClipboardList className=\"w-3 h-3 mr-1\" />\n                Todas\n              </Button>\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Location Context */}\n        {currentLocation && (\n          <Card className=\"bg-blue-50 border-blue-200\">\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center space-x-3\">\n                <MapPin className=\"w-5 h-5 text-blue-600\" />\n                <div>\n                  <p className=\"text-sm font-medium text-blue-900\">Local Ativo</p>\n                  <p className=\"text-xs text-blue-700\">{currentLocation.zoneName}</p>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={() => {\n                      localStorage.removeItem('current-location');\n                      window.location.reload();\n                    }}\n                    className=\"text-xs text-blue-600 hover:text-blue-700 p-0 h-auto mt-1\"\n                  >\n                    Ver todas as OS\n                  </Button>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        )}\n\n        {/* Stats Cards */}\n        <div className=\"grid grid-cols-2 gap-3\">\n          <Card \n            className=\"bg-white/80 backdrop-blur-sm border-white/20 cursor-pointer hover:shadow-lg transition-shadow active:scale-95\"\n            onClick={() => {\n              document.getElementById('disponiveis-section')?.scrollIntoView({ \n                behavior: 'smooth', \n                block: 'start' \n              });\n            }}\n            data-testid=\"card-disponiveis\"\n          >\n            <CardContent className=\"p-3\">\n              <div className=\"flex flex-col items-center justify-center space-y-1\">\n                <div className=\"w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center\">\n                  <AlertCircle className=\"w-5 h-5 text-orange-600\" />\n                </div>\n                <p className=\"text-xl font-bold text-slate-900\">{availableOrders.length}</p>\n                <p className=\"text-xs text-slate-600 text-center\">Disponíveis</p>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card \n            className=\"bg-white/80 backdrop-blur-sm border-white/20 cursor-pointer hover:shadow-lg transition-shadow active:scale-95\"\n            onClick={() => {\n              document.getElementById('pendentes-section')?.scrollIntoView({ \n                behavior: 'smooth', \n                block: 'start' \n              });\n            }}\n            data-testid=\"card-pendentes\"\n          >\n            <CardContent className=\"p-3\">\n              <div className=\"flex flex-col items-center justify-center space-y-1\">\n                <div className=\"w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center\">\n                  <ClipboardList className=\"w-5 h-5 text-blue-600\" />\n                </div>\n                <p className=\"text-xl font-bold text-slate-900\">{myPendingOrders.length}</p>\n                <p className=\"text-xs text-slate-600 text-center\">Pendentes</p>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card \n            className=\"bg-white/80 backdrop-blur-sm border-white/20 cursor-pointer hover:shadow-lg transition-shadow active:scale-95\"\n            onClick={() => {\n              document.getElementById('pausadas-section')?.scrollIntoView({ \n                behavior: 'smooth', \n                block: 'start' \n              });\n            }}\n            data-testid=\"card-pausadas\"\n          >\n            <CardContent className=\"p-3\">\n              <div className=\"flex flex-col items-center justify-center space-y-1\">\n                <div className=\"w-10 h-10 bg-amber-100 rounded-full flex items-center justify-center\">\n                  <Clock className=\"w-5 h-5 text-amber-600\" />\n                </div>\n                <p className=\"text-xl font-bold text-slate-900\">{myPausedOrders.length}</p>\n                <p className=\"text-xs text-slate-600 text-center\">Pausadas</p>\n              </div>\n            </CardContent>\n          </Card>\n          \n          <Card \n            className=\"bg-white/80 backdrop-blur-sm border-white/20 cursor-pointer hover:shadow-lg transition-shadow active:scale-95\"\n            onClick={() => {\n              document.getElementById('concluidas-section')?.scrollIntoView({ \n                behavior: 'smooth', \n                block: 'start' \n              });\n            }}\n            data-testid=\"card-concluidas\"\n          >\n            <CardContent className=\"p-3\">\n              <div className=\"flex flex-col items-center justify-center space-y-1\">\n                <div className=\"w-10 h-10 bg-emerald-100 rounded-full flex items-center justify-center\">\n                  <CheckCircle className=\"w-5 h-5 text-emerald-600\" />\n                </div>\n                <p className=\"text-xl font-bold text-slate-900\">{myCompletedOrders.length}</p>\n                <p className=\"text-xs text-slate-600 text-center\">Concluídas</p>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* QR Scanner Button */}\n        <Card className=\"bg-gradient-to-r from-blue-600 to-indigo-700 text-white border-0 shadow-xl\">\n          <CardContent className=\"p-6\">\n            <Button \n              onClick={handleQrScanner}\n              data-testid=\"button-qr-scanner\"\n              className=\"w-full bg-white/20 hover:bg-white/30 text-white border-white/30 h-16 text-lg font-semibold\"\n              size=\"lg\"\n            >\n              <div className=\"flex items-center space-x-3\">\n                <div className=\"w-10 h-10 bg-white/30 rounded-full flex items-center justify-center\">\n                  <QrCode className=\"w-6 h-6\" />\n                </div>\n                <div className=\"text-left\">\n                  <div className=\"text-lg font-bold\">Escanear QR Code</div>\n                  <div className=\"text-sm opacity-90\">Iniciar nova ordem de serviço</div>\n                </div>\n              </div>\n            </Button>\n          </CardContent>\n        </Card>\n\n        {/* Work Orders List - Disponíveis */}\n        {availableOrders.length > 0 && (\n          <div className=\"space-y-4\" id=\"disponiveis-section\">\n            <h2 className=\"text-xl font-bold text-orange-900 flex items-center gap-2\">\n              <AlertCircle className=\"w-6 h-6\" />\n              OS Disponíveis ({availableOrders.length})\n            </h2>\n\n            {availableOrders.map((workOrder) => (\n              <Card key={workOrder.id} className=\"bg-orange-50/80 backdrop-blur-sm border-orange-200 shadow-lg\">\n                <CardHeader className=\"pb-3\">\n                  <div className=\"flex items-start justify-between gap-3\">\n                    <div className=\"space-y-1 flex-1 min-w-0\">\n                      <div className=\"flex items-center gap-2 mb-1\">\n                        <Badge variant=\"outline\" className=\"bg-orange-600 text-white border-orange-700 font-bold\">\n                          OS #{workOrder.number}\n                        </Badge>\n                      </div>\n                      <CardTitle className=\"text-lg text-orange-900 break-words\">{workOrder.title}</CardTitle>\n                      <div className=\"flex items-center space-x-2 text-sm text-orange-700\">\n                        <MapPin className=\"w-4 h-4\" />\n                        <span>{workOrder.siteName} - {workOrder.zoneName}</span>\n                      </div>\n                    </div>\n                    <div className=\"flex flex-col items-end space-y-2\">\n                      <div className={`w-3 h-3 rounded-full ${getPriorityColor(workOrder.priority)}`}></div>\n                      <Badge variant=\"outline\" className=\"bg-orange-100 text-orange-800 border-orange-200\">\n                        Disponível\n                      </Badge>\n                    </div>\n                  </div>\n                </CardHeader>\n                <CardContent className=\"pt-0\">\n                  <p className=\"text-orange-800 mb-3\">{workOrder.description}</p>\n                  <div className=\"flex items-center justify-between text-sm text-orange-600 mb-3\">\n                    <div className=\"flex items-center space-x-1\">\n                      <Clock className=\"w-4 h-4\" />\n                      <span>Prazo: {formatDate(workOrder.dueDate)}</span>\n                    </div>\n                    <span className=\"font-medium capitalize\">{workOrder.type.replace('_', ' ')}</span>\n                  </div>\n                  <Button \n                    className=\"w-full bg-orange-600 hover:bg-orange-700\" \n                    data-testid={`button-view-order-${workOrder.id}`}\n                    onClick={() => setLocation(`/mobile/work-order-details/${workOrder.id}`)}\n                  >\n                    Ver Detalhes\n                  </Button>\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        )}\n\n        {/* Work Orders List - Minhas Pendentes */}\n        <div className=\"space-y-4\" id=\"pendentes-section\">\n          <h2 className=\"text-xl font-bold text-slate-900 flex items-center gap-2\">\n            <ClipboardList className=\"w-6 h-6\" />\n            Minhas Pendentes\n          </h2>\n\n          {myPendingOrders.length === 0 ? (\n            <Card className=\"bg-white/80 backdrop-blur-sm border-white/20\">\n              <CardContent className=\"p-6 text-center\">\n                <CheckCircle className=\"w-16 h-16 text-green-500 mx-auto mb-4\" />\n                <h3 className=\"text-lg font-semibold text-slate-900 mb-2\">\n                  Tudo em dia!\n                </h3>\n                <p className=\"text-slate-600\">\n                  Você não tem ordens de serviço pendentes no momento.\n                </p>\n              </CardContent>\n            </Card>\n          ) : (\n            myPendingOrders.map((workOrder) => (\n              <Card key={workOrder.id} className=\"bg-white/80 backdrop-blur-sm border-white/20 shadow-lg\">\n                <CardHeader className=\"pb-3\">\n                  <div className=\"flex items-start justify-between gap-3\">\n                    <div className=\"space-y-1 flex-1 min-w-0\">\n                      <div className=\"flex items-center gap-2 mb-1\">\n                        <Badge variant=\"outline\" className=\"bg-blue-600 text-white border-blue-700 font-bold\">\n                          OS #{workOrder.number}\n                        </Badge>\n                      </div>\n                      <CardTitle className=\"text-lg break-words\">{workOrder.title}</CardTitle>\n                      <div className=\"flex items-center space-x-2 text-sm text-slate-600\">\n                        <MapPin className=\"w-4 h-4\" />\n                        <span>{workOrder.siteName} - {workOrder.zoneName}</span>\n                      </div>\n                    </div>\n                    <div className=\"flex flex-col items-end space-y-2\">\n                      <div className={`w-3 h-3 rounded-full ${getPriorityColor(workOrder.priority)}`}></div>\n                      <Badge variant=\"outline\" className={getStatusColor(workOrder.status)}>\n                        {workOrder.status.replace('_', ' ')}\n                      </Badge>\n                    </div>\n                  </div>\n                </CardHeader>\n                <CardContent className=\"pt-0\">\n                  <p className=\"text-slate-700 mb-3\">{workOrder.description}</p>\n                  <div className=\"flex items-center justify-between text-sm text-slate-500\">\n                    <div className=\"flex items-center space-x-1\">\n                      <Clock className=\"w-4 h-4\" />\n                      <span>Prazo: {formatDate(workOrder.dueDate)}</span>\n                    </div>\n                    <span className=\"font-medium capitalize\">{workOrder.type.replace('_', ' ')}</span>\n                  </div>\n                  <Button \n                    className=\"w-full mt-4\" \n                    data-testid={`button-view-order-${workOrder.id}`}\n                    onClick={() => setLocation(`/mobile/work-order-details/${workOrder.id}`)}\n                  >\n                    Ver Detalhes\n                  </Button>\n                </CardContent>\n              </Card>\n            ))\n          )}\n        </div>\n\n        {/* Work Orders List - Pausadas */}\n        {myPausedOrders.length > 0 && (\n          <div className=\"space-y-4\" id=\"pausadas-section\">\n            <h2 className=\"text-xl font-bold text-amber-900 flex items-center gap-2\">\n              <Clock className=\"w-6 h-6\" />\n              OSs Pausadas ({myPausedOrders.length})\n            </h2>\n\n            {myPausedOrders.map((workOrder) => (\n              <Card key={workOrder.id} className=\"bg-amber-50/80 backdrop-blur-sm border-amber-200 shadow-lg\">\n                <CardHeader className=\"pb-3\">\n                  <div className=\"flex items-start justify-between gap-3\">\n                    <div className=\"space-y-1 flex-1 min-w-0\">\n                      <div className=\"flex items-center gap-2 mb-1\">\n                        <Badge variant=\"outline\" className=\"bg-amber-600 text-white border-amber-700 font-bold\">\n                          OS #{workOrder.number}\n                        </Badge>\n                      </div>\n                      <CardTitle className=\"text-lg text-amber-900 break-words\">{workOrder.title}</CardTitle>\n                      <div className=\"flex items-center space-x-2 text-sm text-amber-700\">\n                        <MapPin className=\"w-4 h-4\" />\n                        <span>{workOrder.siteName} - {workOrder.zoneName}</span>\n                      </div>\n                    </div>\n                    <div className=\"flex flex-col items-end space-y-2\">\n                      <div className={`w-3 h-3 rounded-full ${getPriorityColor(workOrder.priority)}`}></div>\n                      <Badge variant=\"outline\" className=\"bg-amber-100 text-amber-800 border-amber-200\">\n                        Pausada\n                      </Badge>\n                    </div>\n                  </div>\n                </CardHeader>\n                <CardContent className=\"pt-0\">\n                  <p className=\"text-amber-800 mb-3\">{workOrder.description}</p>\n                  <div className=\"flex items-center justify-between text-sm text-amber-600 mb-3\">\n                    <div className=\"flex items-center space-x-1\">\n                      <Clock className=\"w-4 h-4\" />\n                      <span>Prazo: {formatDate(workOrder.dueDate)}</span>\n                    </div>\n                    <span className=\"font-medium capitalize\">{workOrder.type.replace('_', ' ')}</span>\n                  </div>\n                  <Button \n                    className=\"w-full bg-amber-600 hover:bg-amber-700\" \n                    data-testid={`button-view-order-${workOrder.id}`}\n                    onClick={() => setLocation(`/mobile/work-order-details/${workOrder.id}`)}\n                  >\n                    Retomar OS\n                  </Button>\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        )}\n\n        {/* Work Orders List - Minhas Concluídas */}\n        {myCompletedOrders.length > 0 && (\n          <div className=\"space-y-4\" id=\"concluidas-section\">\n            <h2 className=\"text-xl font-bold text-emerald-900 flex items-center gap-2\">\n              <CheckCircle className=\"w-6 h-6\" />\n              Minhas Concluídas ({myCompletedOrders.length})\n            </h2>\n\n            {myCompletedOrders.map((workOrder) => (\n              <Card key={workOrder.id} className=\"bg-emerald-50/80 backdrop-blur-sm border-emerald-200 shadow-lg\">\n                <CardHeader className=\"pb-3\">\n                  <div className=\"flex items-start justify-between gap-3\">\n                    <div className=\"space-y-1 flex-1 min-w-0\">\n                      <div className=\"flex items-center gap-2 mb-1\">\n                        <Badge variant=\"outline\" className=\"bg-emerald-600 text-white border-emerald-700 font-bold\">\n                          OS #{workOrder.number}\n                        </Badge>\n                      </div>\n                      <CardTitle className=\"text-lg text-emerald-900 break-words\">{workOrder.title}</CardTitle>\n                      <div className=\"flex items-center space-x-2 text-sm text-emerald-700\">\n                        <MapPin className=\"w-4 h-4\" />\n                        <span>{workOrder.siteName} - {workOrder.zoneName}</span>\n                      </div>\n                    </div>\n                    <Badge variant=\"outline\" className=\"bg-green-100 text-green-800 border-green-200\">\n                      Concluída\n                    </Badge>\n                  </div>\n                </CardHeader>\n                <CardContent className=\"pt-0\">\n                  <p className=\"text-emerald-800 mb-3 text-sm\">{workOrder.description}</p>\n                  <div className=\"flex items-center justify-between text-sm text-emerald-600\">\n                    <div className=\"flex items-center space-x-1\">\n                      <Clock className=\"w-4 h-4\" />\n                      <span>Concluída em: {formatDateTime(workOrder.createdAt)}</span>\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}","size_bytes":29476},"client/src/components/ui/slider.tsx":{"content":"import * as React from \"react\"\nimport * as SliderPrimitive from \"@radix-ui/react-slider\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Slider = React.forwardRef<\n  React.ElementRef<typeof SliderPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <SliderPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex w-full touch-none select-none items-center\",\n      className\n    )}\n    {...props}\n  >\n    <SliderPrimitive.Track className=\"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary\">\n      <SliderPrimitive.Range className=\"absolute h-full bg-primary\" />\n    </SliderPrimitive.Track>\n    <SliderPrimitive.Thumb className=\"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50\" />\n  </SliderPrimitive.Root>\n))\nSlider.displayName = SliderPrimitive.Root.displayName\n\nexport { Slider }\n","size_bytes":1077},"client/src/pages/customers.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useLocation } from \"wouter\";\nimport { z } from \"zod\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { Plus, Edit, Trash2, Search, Users, Building2 } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport type { Customer, InsertCustomer } from \"@shared/schema\";\n\nconst customerFormSchema = z.object({\n  name: z.string().min(2, \"Nome deve ter pelo menos 2 caracteres\"),\n  email: z.string().email(\"E-mail inválido\").optional().or(z.literal(\"\")),\n  phone: z.string().optional(),\n  document: z.string().optional(),\n  address: z.string().optional(),\n  city: z.string().optional(),\n  state: z.string().optional(),\n  zipCode: z.string().optional(),\n  contactPerson: z.string().optional(),\n  notes: z.string().optional(),\n  modules: z.array(z.enum(['clean', 'maintenance'])).min(1, \"Selecione pelo menos um módulo\"),\n});\n\ntype CustomerFormData = z.infer<typeof customerFormSchema>;\n\ninterface CustomersPageProps {\n  companyId: string;\n}\n\nexport default function CustomersPage({ companyId }: CustomersPageProps) {\n  const [location, navigate] = useLocation();\n  const { toast } = useToast();\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);\n  const [isEditDialogOpen, setIsEditDialogOpen] = useState(false);\n  const [editingCustomer, setEditingCustomer] = useState<Customer | null>(null);\n\n  // Company ID comes from props\n\n  const { data: customers = [], isLoading } = useQuery<Customer[]>({\n    queryKey: [\"/api/companies\", companyId, \"customers\"],\n  });\n\n  const createCustomerMutation = useMutation({\n    mutationFn: async (data: CustomerFormData) => {\n      return await apiRequest(\"POST\", `/api/companies/${companyId}/customers`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/companies\", companyId, \"customers\"] });\n      setIsCreateDialogOpen(false);\n      toast({ title: \"Cliente criado com sucesso!\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro ao criar cliente\", variant: \"destructive\" });\n    },\n  });\n\n  const updateCustomerMutation = useMutation({\n    mutationFn: async (data: { id: string } & Partial<CustomerFormData>) => {\n      const { id, ...updateData } = data;\n      return await apiRequest(\"PUT\", `/api/customers/${id}`, updateData);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/companies\", companyId, \"customers\"] });\n      setIsEditDialogOpen(false);\n      setEditingCustomer(null);\n      toast({ title: \"Cliente atualizado com sucesso!\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro ao atualizar cliente\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteCustomerMutation = useMutation({\n    mutationFn: async (customerId: string) => {\n      return await apiRequest(\"DELETE\", `/api/customers/${customerId}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/companies\", companyId, \"customers\"] });\n      toast({ title: \"Cliente removido com sucesso!\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro ao remover cliente\", variant: \"destructive\" });\n    },\n  });\n\n  const createForm = useForm<CustomerFormData>({\n    resolver: zodResolver(customerFormSchema),\n    defaultValues: {\n      name: \"\",\n      email: \"\",\n      phone: \"\",\n      document: \"\",\n      address: \"\",\n      city: \"\",\n      state: \"\",\n      zipCode: \"\",\n      contactPerson: \"\",\n      notes: \"\",\n      modules: ['clean'],\n    },\n  });\n\n  const editForm = useForm<CustomerFormData>({\n    resolver: zodResolver(customerFormSchema),\n    defaultValues: {\n      name: \"\",\n      email: \"\",\n      phone: \"\",\n      document: \"\",\n      address: \"\",\n      city: \"\",\n      state: \"\",\n      zipCode: \"\",\n      contactPerson: \"\",\n      notes: \"\",\n      modules: [],\n    },\n  });\n\n  const handleCreateCustomer = (data: CustomerFormData) => {\n    createCustomerMutation.mutate(data);\n  };\n\n  const handleEditCustomer = (customer: Customer) => {\n    setEditingCustomer(customer);\n    editForm.reset({\n      name: customer.name,\n      email: customer.email || \"\",\n      phone: customer.phone || \"\",\n      document: customer.document || \"\",\n      address: customer.address || \"\",\n      city: customer.city || \"\",\n      state: customer.state || \"\",\n      zipCode: customer.zipCode || \"\",\n      contactPerson: customer.contactPerson || \"\",\n      notes: customer.notes || \"\",\n      modules: (customer.modules || ['clean']) as ('clean' | 'maintenance')[],\n    });\n    setIsEditDialogOpen(true);\n  };\n\n  const handleUpdateCustomer = (data: CustomerFormData) => {\n    if (!editingCustomer) return;\n    updateCustomerMutation.mutate({ id: editingCustomer.id, ...data });\n  };\n\n  const handleDeleteCustomer = (customerId: string) => {\n    if (confirm(\"Tem certeza que deseja remover este cliente?\")) {\n      deleteCustomerMutation.mutate(customerId);\n    }\n  };\n\n  const getModulesBadges = (customer: Customer) => {\n    const modules = customer.modules || [];\n    \n    return (\n      <div className=\"flex flex-wrap gap-1\">\n        {modules.includes('clean') && (\n          <Badge className=\"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200\" data-testid={`badge-module-clean-${customer.id}`}>\n            Clean\n          </Badge>\n        )}\n        {modules.includes('maintenance') && (\n          <Badge className=\"bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200\" data-testid={`badge-module-maintenance-${customer.id}`}>\n            Manutenção\n          </Badge>\n        )}\n      </div>\n    );\n  };\n\n  const filteredCustomers = customers\n    .filter(customer => customer.isActive) // Mostrar apenas clientes ativos\n    .filter(customer =>\n      customer.name.toLowerCase().includes(searchTerm.toLowerCase()) ||\n      (customer.email && customer.email.toLowerCase().includes(searchTerm.toLowerCase())) ||\n      (customer.document && customer.document.includes(searchTerm))\n    );\n\n  if (isLoading) {\n    return (\n      <div className=\"p-6\">\n        <div className=\"animate-pulse space-y-4\">\n          <div className=\"h-8 bg-muted rounded w-1/3\"></div>\n          <div className=\"h-64 bg-muted rounded\"></div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div className=\"flex items-center space-x-3\">\n          <div className=\"p-2 bg-primary/10 rounded-lg\">\n            <Users className=\"w-6 h-6 text-primary\" />\n          </div>\n          <div>\n            <h1 className=\"text-2xl font-bold text-primary\">Clientes</h1>\n            <p className=\"text-muted-foreground\">Gerencie os clientes da sua empresa</p>\n          </div>\n        </div>\n        <Button \n          onClick={() => setIsCreateDialogOpen(true)}\n          className=\"bg-primary hover:bg-primary/90\"\n          data-testid=\"button-create-customer\"\n        >\n          <Plus className=\"w-4 h-4 mr-2\" />\n          Novo Cliente\n        </Button>\n      </div>\n\n      {/* Search */}\n      <Card>\n        <CardContent className=\"pt-6\">\n          <div className=\"relative max-w-md\">\n            <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n            <Input\n              placeholder=\"Buscar clientes...\"\n              value={searchTerm}\n              onChange={(e) => setSearchTerm(e.target.value)}\n              className=\"pl-10\"\n              data-testid=\"input-search-customers\"\n            />\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Customers Table */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center space-x-2\">\n            <Building2 className=\"w-5 h-5\" />\n            <span>Lista de Clientes ({filteredCustomers.length})</span>\n          </CardTitle>\n          <CardDescription>\n            Gerencie informações dos seus clientes\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          {filteredCustomers.length === 0 ? (\n            <div className=\"text-center py-12\">\n              <Users className=\"w-12 h-12 text-muted-foreground mx-auto mb-4\" />\n              <h3 className=\"text-lg font-semibold text-muted-foreground mb-2\">\n                {searchTerm ? \"Nenhum cliente encontrado\" : \"Nenhum cliente cadastrado\"}\n              </h3>\n              <p className=\"text-sm text-muted-foreground mb-4\">\n                {searchTerm \n                  ? \"Tente buscar com outros termos\" \n                  : \"Crie o primeiro cliente para começar\"\n                }\n              </p>\n              {!searchTerm && (\n                <Button \n                  onClick={() => setIsCreateDialogOpen(true)}\n                  data-testid=\"button-create-first-customer\"\n                >\n                  <Plus className=\"w-4 h-4 mr-2\" />\n                  Criar Primeiro Cliente\n                </Button>\n              )}\n            </div>\n          ) : (\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Nome</TableHead>\n                  <TableHead>E-mail</TableHead>\n                  <TableHead>Telefone</TableHead>\n                  <TableHead>Documento</TableHead>\n                  <TableHead>Cidade</TableHead>\n                  <TableHead>Módulos</TableHead>\n                  <TableHead>Status</TableHead>\n                  <TableHead>Ações</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {filteredCustomers.map((customer) => (\n                  <TableRow key={customer.id}>\n                    <TableCell className=\"font-medium\">{customer.name}</TableCell>\n                    <TableCell>{customer.email || \"-\"}</TableCell>\n                    <TableCell>{customer.phone || \"-\"}</TableCell>\n                    <TableCell>{customer.document || \"-\"}</TableCell>\n                    <TableCell>{customer.city || \"-\"}</TableCell>\n                    <TableCell>{getModulesBadges(customer)}</TableCell>\n                    <TableCell>\n                      {customer.isActive ? (\n                        <Badge className=\"bg-chart-2/10 text-chart-2\">Ativo</Badge>\n                      ) : (\n                        <Badge variant=\"outline\">Inativo</Badge>\n                      )}\n                    </TableCell>\n                    <TableCell>\n                      <div className=\"flex items-center space-x-2\">\n                        <Button \n                          variant=\"ghost\" \n                          size=\"sm\"\n                          onClick={() => handleEditCustomer(customer)}\n                          data-testid={`button-edit-customer-${customer.id}`}\n                        >\n                          <Edit className=\"w-4 h-4\" />\n                        </Button>\n                        <Button \n                          variant=\"ghost\" \n                          size=\"sm\"\n                          onClick={() => handleDeleteCustomer(customer.id)}\n                          data-testid={`button-delete-customer-${customer.id}`}\n                        >\n                          <Trash2 className=\"w-4 h-4\" />\n                        </Button>\n                      </div>\n                    </TableCell>\n                  </TableRow>\n                ))}\n              </TableBody>\n            </Table>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Create Customer Dialog */}\n      <Dialog open={isCreateDialogOpen} onOpenChange={setIsCreateDialogOpen}>\n        <DialogContent className=\"max-w-lg max-h-[85vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>Novo Cliente</DialogTitle>\n            <DialogDescription>\n              Preencha as informações do novo cliente\n            </DialogDescription>\n          </DialogHeader>\n          <Form {...createForm}>\n            <form onSubmit={createForm.handleSubmit(handleCreateCustomer)} className=\"space-y-4\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                <FormField\n                  control={createForm.control}\n                  name=\"name\"\n                  render={({ field }) => (\n                    <FormItem className=\"col-span-2\">\n                      <FormLabel>Nome *</FormLabel>\n                      <FormControl>\n                        <Input placeholder=\"Nome do cliente\" {...field} data-testid=\"input-create-customer-name\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                \n                <FormField\n                  control={createForm.control}\n                  name=\"email\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>E-mail</FormLabel>\n                      <FormControl>\n                        <Input type=\"email\" placeholder=\"email@exemplo.com\" {...field} data-testid=\"input-create-customer-email\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={createForm.control}\n                  name=\"phone\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Telefone</FormLabel>\n                      <FormControl>\n                        <Input placeholder=\"(11) 99999-9999\" {...field} data-testid=\"input-create-customer-phone\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={createForm.control}\n                  name=\"document\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>CPF/CNPJ</FormLabel>\n                      <FormControl>\n                        <Input placeholder=\"000.000.000-00\" {...field} data-testid=\"input-create-customer-document\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={createForm.control}\n                  name=\"contactPerson\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Pessoa de Contato</FormLabel>\n                      <FormControl>\n                        <Input placeholder=\"Nome do contato\" {...field} data-testid=\"input-create-customer-contact\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={createForm.control}\n                  name=\"address\"\n                  render={({ field }) => (\n                    <FormItem className=\"col-span-2\">\n                      <FormLabel>Endereço</FormLabel>\n                      <FormControl>\n                        <Input placeholder=\"Rua, número, bairro\" {...field} data-testid=\"input-create-customer-address\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={createForm.control}\n                  name=\"city\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Cidade</FormLabel>\n                      <FormControl>\n                        <Input placeholder=\"São Paulo\" {...field} data-testid=\"input-create-customer-city\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={createForm.control}\n                  name=\"state\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Estado</FormLabel>\n                      <FormControl>\n                        <Input placeholder=\"SP\" {...field} data-testid=\"input-create-customer-state\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={createForm.control}\n                  name=\"zipCode\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>CEP</FormLabel>\n                      <FormControl>\n                        <Input placeholder=\"00000-000\" {...field} data-testid=\"input-create-customer-zip\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={createForm.control}\n                  name=\"modules\"\n                  render={({ field }) => (\n                    <FormItem className=\"col-span-2\">\n                      <FormLabel>Módulos Disponíveis *</FormLabel>\n                      <div className=\"flex items-center space-x-4 pt-2\">\n                        <div className=\"flex items-center space-x-2\">\n                          <Checkbox\n                            id=\"create-module-clean\"\n                            checked={field.value?.includes('clean')}\n                            onCheckedChange={(checked) => {\n                              const currentModules = field.value || [];\n                              if (checked) {\n                                field.onChange([...currentModules, 'clean']);\n                              } else {\n                                field.onChange(currentModules.filter((m: string) => m !== 'clean'));\n                              }\n                            }}\n                            data-testid=\"checkbox-create-customer-module-clean\"\n                          />\n                          <label htmlFor=\"create-module-clean\" className=\"text-sm font-medium\">\n                            OPUS Clean\n                          </label>\n                        </div>\n                        <div className=\"flex items-center space-x-2\">\n                          <Checkbox\n                            id=\"create-module-maintenance\"\n                            checked={field.value?.includes('maintenance')}\n                            onCheckedChange={(checked) => {\n                              const currentModules = field.value || [];\n                              if (checked) {\n                                field.onChange([...currentModules, 'maintenance']);\n                              } else {\n                                field.onChange(currentModules.filter((m: string) => m !== 'maintenance'));\n                              }\n                            }}\n                            data-testid=\"checkbox-create-customer-module-maintenance\"\n                          />\n                          <label htmlFor=\"create-module-maintenance\" className=\"text-sm font-medium\">\n                            OPUS Manutenção\n                          </label>\n                        </div>\n                      </div>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={createForm.control}\n                  name=\"notes\"\n                  render={({ field }) => (\n                    <FormItem className=\"col-span-2\">\n                      <FormLabel>Observações</FormLabel>\n                      <FormControl>\n                        <Textarea placeholder=\"Observações sobre o cliente\" {...field} data-testid=\"textarea-create-customer-notes\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n\n              <div className=\"flex justify-end space-x-2\">\n                <Button type=\"button\" variant=\"outline\" onClick={() => setIsCreateDialogOpen(false)}>\n                  Cancelar\n                </Button>\n                <Button type=\"submit\" disabled={createCustomerMutation.isPending} data-testid=\"button-submit-create-customer\">\n                  {createCustomerMutation.isPending ? \"Criando...\" : \"Criar Cliente\"}\n                </Button>\n              </div>\n            </form>\n          </Form>\n        </DialogContent>\n      </Dialog>\n\n      {/* Edit Customer Dialog */}\n      <Dialog open={isEditDialogOpen} onOpenChange={setIsEditDialogOpen}>\n        <DialogContent className=\"max-w-lg max-h-[85vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>Editar Cliente</DialogTitle>\n            <DialogDescription>\n              Altere as informações do cliente\n            </DialogDescription>\n          </DialogHeader>\n          <Form {...editForm}>\n            <form onSubmit={editForm.handleSubmit(handleUpdateCustomer)} className=\"space-y-4\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                <FormField\n                  control={editForm.control}\n                  name=\"name\"\n                  render={({ field }) => (\n                    <FormItem className=\"col-span-2\">\n                      <FormLabel>Nome *</FormLabel>\n                      <FormControl>\n                        <Input placeholder=\"Nome do cliente\" {...field} data-testid=\"input-edit-customer-name\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                \n                <FormField\n                  control={editForm.control}\n                  name=\"email\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>E-mail</FormLabel>\n                      <FormControl>\n                        <Input type=\"email\" placeholder=\"email@exemplo.com\" {...field} data-testid=\"input-edit-customer-email\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={editForm.control}\n                  name=\"phone\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Telefone</FormLabel>\n                      <FormControl>\n                        <Input placeholder=\"(11) 99999-9999\" {...field} data-testid=\"input-edit-customer-phone\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={editForm.control}\n                  name=\"document\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>CPF/CNPJ</FormLabel>\n                      <FormControl>\n                        <Input placeholder=\"000.000.000-00\" {...field} data-testid=\"input-edit-customer-document\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={editForm.control}\n                  name=\"contactPerson\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Pessoa de Contato</FormLabel>\n                      <FormControl>\n                        <Input placeholder=\"Nome do contato\" {...field} data-testid=\"input-edit-customer-contact\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={editForm.control}\n                  name=\"address\"\n                  render={({ field }) => (\n                    <FormItem className=\"col-span-2\">\n                      <FormLabel>Endereço</FormLabel>\n                      <FormControl>\n                        <Input placeholder=\"Rua, número, bairro\" {...field} data-testid=\"input-edit-customer-address\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={editForm.control}\n                  name=\"city\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Cidade</FormLabel>\n                      <FormControl>\n                        <Input placeholder=\"São Paulo\" {...field} data-testid=\"input-edit-customer-city\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={editForm.control}\n                  name=\"state\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Estado</FormLabel>\n                      <FormControl>\n                        <Input placeholder=\"SP\" {...field} data-testid=\"input-edit-customer-state\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={editForm.control}\n                  name=\"zipCode\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>CEP</FormLabel>\n                      <FormControl>\n                        <Input placeholder=\"00000-000\" {...field} data-testid=\"input-edit-customer-zip\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={editForm.control}\n                  name=\"modules\"\n                  render={({ field }) => (\n                    <FormItem className=\"col-span-2\">\n                      <FormLabel>Módulos Disponíveis *</FormLabel>\n                      <div className=\"flex items-center space-x-4 pt-2\">\n                        <div className=\"flex items-center space-x-2\">\n                          <Checkbox\n                            id=\"edit-module-clean\"\n                            checked={field.value?.includes('clean')}\n                            onCheckedChange={(checked) => {\n                              const currentModules = field.value || [];\n                              if (checked) {\n                                field.onChange([...currentModules, 'clean']);\n                              } else {\n                                field.onChange(currentModules.filter((m: string) => m !== 'clean'));\n                              }\n                            }}\n                            data-testid=\"checkbox-edit-customer-module-clean\"\n                          />\n                          <label htmlFor=\"edit-module-clean\" className=\"text-sm font-medium\">\n                            OPUS Clean\n                          </label>\n                        </div>\n                        <div className=\"flex items-center space-x-2\">\n                          <Checkbox\n                            id=\"edit-module-maintenance\"\n                            checked={field.value?.includes('maintenance')}\n                            onCheckedChange={(checked) => {\n                              const currentModules = field.value || [];\n                              if (checked) {\n                                field.onChange([...currentModules, 'maintenance']);\n                              } else {\n                                field.onChange(currentModules.filter((m: string) => m !== 'maintenance'));\n                              }\n                            }}\n                            data-testid=\"checkbox-edit-customer-module-maintenance\"\n                          />\n                          <label htmlFor=\"edit-module-maintenance\" className=\"text-sm font-medium\">\n                            OPUS Manutenção\n                          </label>\n                        </div>\n                      </div>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={editForm.control}\n                  name=\"notes\"\n                  render={({ field }) => (\n                    <FormItem className=\"col-span-2\">\n                      <FormLabel>Observações</FormLabel>\n                      <FormControl>\n                        <Textarea placeholder=\"Observações sobre o cliente\" {...field} data-testid=\"textarea-edit-customer-notes\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n\n              <div className=\"flex justify-end space-x-2\">\n                <Button type=\"button\" variant=\"outline\" onClick={() => setIsEditDialogOpen(false)}>\n                  Cancelar\n                </Button>\n                <Button type=\"submit\" disabled={updateCustomerMutation.isPending} data-testid=\"button-submit-edit-customer\">\n                  {updateCustomerMutation.isPending ? \"Salvando...\" : \"Salvar Alterações\"}\n                </Button>\n              </div>\n            </form>\n          </Form>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}","size_bytes":30549},"deploy-vm.sh":{"content":"#!/bin/bash\nset -euo pipefail\n\nAPP_DIR=\"/home/opus/apps/newfacilities\"\ncd \"$APP_DIR\"\n\necho \"==> 1) Verificando .env\"\ngrep -q '^PORT=' .env || echo 'PORT=3007' >> .env\nsed -i 's/^PORT=.*/PORT=3007/' .env\ngrep -q '^NODE_ENV=' .env || echo 'NODE_ENV=production' >> .env\nsed -i 's/^NODE_ENV=.*/NODE_ENV=production/' .env\ngrep -q '^DATABASE_URL=' .env || { echo \"❌ ERRO: DATABASE_URL não configurado no .env!\"; exit 1; }\n\necho \"==> 2) Instalando dependências\"\nnpm ci\n\necho \"==> 3) Build completo (frontend + backend)\"\nnpm run build\n\necho \"==> 4) Verificando arquivos gerados\"\nif [ ! -f \"dist/public/index.html\" ]; then\n  echo \"❌ ERRO: dist/public/index.html não foi gerado!\"\n  exit 1\nfi\nif [ ! -f \"dist/index.js\" ]; then\n  echo \"❌ ERRO: dist/index.js não foi gerado!\"\n  exit 1\nfi\n\necho \"==> 5) Configurando PM2\"\ncat > ecosystem.config.cjs <<'CJS'\nmodule.exports = {\n  apps: [{\n    name: \"newfacilities\",\n    script: \"./dist/index.js\",\n    cwd: \"/home/opus/apps/newfacilities\",\n    env: { \n      NODE_ENV: \"production\", \n      PORT: \"3007\" \n    }\n  }]\n}\nCJS\n\necho \"==> 6) Iniciando aplicação\"\npm2 delete newfacilities 2>/dev/null || true\npm2 start ecosystem.config.cjs --update-env\n\necho \"==> 7) Verificando status\"\npm2 list\n\necho \"\"\necho \"✅ Deploy concluído!\"\necho \"📋 Verifique os logs com: pm2 logs newfacilities\"\necho \"🌐 App rodando na porta 3007\"\n","size_bytes":1366},".local/state/replit/agent/progress_tracker.md":{"content":"[x] 1. Install the required packages\n[x] 2. Configure the workflow with webview output and port 5000\n[x] 3. Run npm install to ensure all dependencies are installed\n[x] 4. Restart the workflow to see if the project is working\n[x] 5. Verify the project is working using screenshot\n[x] 6. Create PostgreSQL database\n[x] 7. Import database dump (db_dump_2025-10-29_165255.sql)\n[x] 8. Verify database populated with all data (27 tables, 687+ records)\n[x] 9. Import and setup completed successfully\n[x] 10. Fixed customer listing - using logged user's companyId (App.tsx)\n[x] 11. Fixed ClientContext - using logged user's companyId for customer selector\n[x] 12. Added filter to show only active customers in dropdown and customer page\n[x] 13. Verified FAURECIA and TECNOFIBRA appearing correctly for admin user\n[x] 14. Completed migration to Replit environment - all dependencies installed and workflow configured\n[x] 15. Database populated successfully with 687 work orders, 19 users, 4 customers, 7 sites, 28 zones\n[x] 16. Application restarted and running correctly with database connection\n[x] 17. Project import and database setup completed - ready for development\n[x] 18. Refactored \"Cliente Ativo\" selector to use ClientContext directly\n[x] 19. Removed duplicate queries - now using shared context for customer list\n[x] 20. Sidebar now shows only customers the user has access to (filtered by company and active status)\n[x] 21. Fixed alignment of \"Total OS\" text in dashboard donut chart - perfectly centered\n[x] 22. Fixed user deletion error - now deletes related records (roles, sites) before deleting user","size_bytes":1610},"client/src/contexts/ModuleContext.tsx":{"content":"import { createContext, useContext, useState, useEffect } from 'react';\nimport { useLocation } from 'wouter';\nimport { useUserModules } from '@/hooks/useUserModules';\nimport { useClient } from './ClientContext';\n\nexport type ModuleType = 'clean' | 'maintenance';\n\ninterface ModuleConfig {\n  id: ModuleType;\n  name: string;\n  displayName: string;\n  primaryColor: string;\n  secondaryColor: string;\n  accentColor: string;\n  description: string;\n  icon: string;\n}\n\nexport const MODULE_CONFIGS: Record<ModuleType, ModuleConfig> = {\n  clean: {\n    id: 'clean',\n    name: 'clean',\n    displayName: 'OPUS Clean',\n    primaryColor: '#1e3a8a',\n    secondaryColor: '#3b82f6',\n    accentColor: '#60a5fa',\n    description: 'Gestão de Limpeza e Facilities',\n    icon: '🧹',\n  },\n  maintenance: {\n    id: 'maintenance',\n    name: 'maintenance',\n    displayName: 'OPUS Manutenção',\n    primaryColor: '#FF9800',\n    secondaryColor: '#FB8C00',\n    accentColor: '#FFB74D',\n    description: 'Gestão de Manutenção',\n    icon: '🔧',\n  },\n};\n\ninterface ModuleContextType {\n  currentModule: ModuleType;\n  moduleConfig: ModuleConfig;\n  setModule: (module: ModuleType) => void;\n  getModuleRoute: (path: string) => string;\n  allowedModules: ModuleType[];\n  canAccessModule: (module: ModuleType) => boolean;\n  hasMultipleModules: boolean;\n}\n\nconst ModuleContext = createContext<ModuleContextType | undefined>(undefined);\n\nexport function ModuleProvider({ children }: { children: React.ReactNode }) {\n  const { \n    allowedModules, \n    defaultModule, \n    canAccessModule, \n    getValidModule,\n    hasMultipleModules,\n    isLoading \n  } = useUserModules();\n\n  // Inicializar com null e esperar os dados carregarem\n  const [currentModule, setCurrentModule] = useState<ModuleType | null>(null);\n\n  const moduleConfig = currentModule ? MODULE_CONFIGS[currentModule] : MODULE_CONFIGS.clean;\n  \n  // Importar ClientContext para sincronizar módulo com cliente\n  const { activeClient, customers, setActiveClientId } = useClient();\n  \n  // Hook de navegação para redirecionamento automático\n  const [, setLocation] = useLocation();\n\n  // Inicializar o módulo apenas DEPOIS que os dados do usuário carregarem\n  useEffect(() => {\n    if (!isLoading && currentModule === null) {\n      // Se não tem módulos configurados, forçar 'clean' como padrão seguro\n      const safeDefaultModule = allowedModules.length > 0 ? defaultModule : 'clean';\n      \n      // Primeira inicialização - usar localStorage ou defaultModule\n      const stored = localStorage.getItem('opus:currentModule');\n      const storedModule = (stored === 'clean' || stored === 'maintenance') ? stored : null;\n      \n      // Validar se o módulo salvo é permitido\n      if (storedModule && allowedModules.length > 0 && canAccessModule(storedModule)) {\n        console.log(`[MODULE] Inicializando com módulo salvo: ${storedModule}`);\n        setCurrentModule(storedModule);\n      } else {\n        console.log(`[MODULE] Inicializando com módulo padrão: ${safeDefaultModule}`);\n        setCurrentModule(safeDefaultModule);\n      }\n    }\n  }, [isLoading, allowedModules, currentModule, canAccessModule, defaultModule]);\n\n  // Sincronizar módulo quando o cliente mudar\n  useEffect(() => {\n    if (!activeClient || !currentModule) return;\n    \n    const clientModules = activeClient.modules || [];\n    \n    // Se o cliente só tem um módulo e é diferente do atual, trocar automaticamente\n    if (clientModules.length === 1) {\n      const clientModule = clientModules[0] as ModuleType;\n      \n      // Verificar se o usuário pode acessar esse módulo e se é diferente do atual\n      if (canAccessModule(clientModule) && clientModule !== currentModule) {\n        console.log(`[MODULE] Cliente \"${activeClient.name}\" possui apenas módulo \"${clientModule}\", trocando automaticamente...`);\n        setCurrentModule(clientModule);\n        \n        // Redirecionar para a tela inicial\n        console.log(`[MODULE] Redirecionando para tela inicial do módulo \"${clientModule}\"...`);\n        setLocation('/');\n      }\n    }\n    // Se o cliente tem múltiplos módulos mas o módulo atual não é suportado pelo cliente\n    else if (clientModules.length > 1 && !clientModules.includes(currentModule)) {\n      // Trocar para o primeiro módulo do cliente que o usuário pode acessar\n      const validModule = clientModules.find(m => canAccessModule(m as ModuleType));\n      if (validModule) {\n        console.log(`[MODULE] Módulo atual não suportado pelo cliente, trocando para \"${validModule}\"...`);\n        setCurrentModule(validModule as ModuleType);\n        \n        // Redirecionar para a tela inicial\n        console.log(`[MODULE] Redirecionando para tela inicial do módulo \"${validModule}\"...`);\n        setLocation('/');\n      }\n    }\n  }, [activeClient, currentModule, canAccessModule, setLocation]);\n\n  useEffect(() => {\n    if (currentModule) {\n      localStorage.setItem('opus:currentModule', currentModule);\n      \n      document.documentElement.setAttribute('data-module', currentModule);\n      \n      document.documentElement.style.setProperty('--module-primary', moduleConfig.primaryColor);\n      document.documentElement.style.setProperty('--module-secondary', moduleConfig.secondaryColor);\n      document.documentElement.style.setProperty('--module-accent', moduleConfig.accentColor);\n    }\n  }, [currentModule, moduleConfig]);\n\n  const setModule = (module: ModuleType) => {\n    // Validar se o usuário pode acessar o módulo antes de trocar\n    if (canAccessModule(module)) {\n      setCurrentModule(module);\n      \n      // NOVO: Ao trocar de módulo, selecionar automaticamente o primeiro cliente ativo que possui esse módulo\n      if (customers && customers.length > 0) {\n        const firstClientWithModule = customers.find(\n          customer => customer.isActive && customer.modules?.includes(module)\n        );\n        \n        if (firstClientWithModule && firstClientWithModule.id !== activeClient?.id) {\n          console.log(`[MODULE] Trocando para primeiro cliente ativo com módulo \"${module}\": ${firstClientWithModule.name}`);\n          setActiveClientId(firstClientWithModule.id);\n          setLocation('/');\n        }\n      }\n    } else {\n      console.warn(`[MODULE] Tentativa de acesso negada ao módulo: ${module}`);\n      // Se tentou acessar módulo não autorizado, forçar defaultModule\n      setCurrentModule(defaultModule);\n    }\n  };\n\n  const getModuleRoute = (path: string) => {\n    const cleanPath = path.startsWith('/') ? path : `/${path}`;\n    return `/${currentModule}${cleanPath}`;\n  };\n\n  // Se ainda está carregando, não renderizar nada\n  if (isLoading || currentModule === null) {\n    return (\n      <div className=\"flex items-center justify-center h-screen\">\n        <div className=\"text-center\">\n          <div className=\"w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4\"></div>\n          <p className=\"text-gray-600\">Carregando...</p>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <ModuleContext.Provider\n      value={{\n        currentModule,\n        moduleConfig,\n        setModule,\n        getModuleRoute,\n        allowedModules,\n        canAccessModule,\n        hasMultipleModules,\n      }}\n    >\n      {children}\n    </ModuleContext.Provider>\n  );\n}\n\nexport function useModule() {\n  const context = useContext(ModuleContext);\n  if (!context) {\n    throw new Error('useModule must be used within ModuleProvider');\n  }\n  return context;\n}\n","size_bytes":7500},"client/src/pages/module-selector.tsx":{"content":"import { useLocation } from 'wouter';\nimport { Building2, Wrench } from 'lucide-react';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { MODULE_CONFIGS, ModuleType } from '@/contexts/ModuleContext';\n\nexport default function ModuleSelector() {\n  const [, setLocation] = useLocation();\n\n  const handleModuleSelect = (moduleType: ModuleType) => {\n    localStorage.setItem('opus:currentModule', moduleType);\n    setLocation(`/${moduleType}/dashboard`);\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-800 flex items-center justify-center p-4\">\n      <div className=\"max-w-4xl w-full\">\n        <div className=\"text-center mb-8\">\n          <h1 className=\"text-4xl font-bold text-slate-900 dark:text-white mb-2\">\n            Plataforma OPUS\n          </h1>\n          <p className=\"text-lg text-slate-600 dark:text-slate-300\">\n            Selecione o módulo que deseja acessar\n          </p>\n        </div>\n\n        <div className=\"grid md:grid-cols-2 gap-6\">\n          <Card \n            className=\"cursor-pointer hover:shadow-lg transition-all hover:scale-105 border-2 hover:border-blue-500\"\n            onClick={() => handleModuleSelect('clean')}\n            data-testid=\"card-module-clean\"\n          >\n            <CardHeader className=\"text-center\">\n              <div className=\"w-16 h-16 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center mx-auto mb-4\">\n                <Building2 className=\"w-8 h-8 text-blue-600 dark:text-blue-400\" />\n              </div>\n              <CardTitle className=\"text-2xl text-blue-900 dark:text-blue-400\">\n                {MODULE_CONFIGS.clean.displayName}\n              </CardTitle>\n              <CardDescription className=\"text-base\">\n                {MODULE_CONFIGS.clean.description}\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              <Button \n                className=\"w-full bg-blue-600 hover:bg-blue-700 text-white\"\n                data-testid=\"button-select-clean\"\n              >\n                Acessar OPUS Clean\n              </Button>\n            </CardContent>\n          </Card>\n\n          <Card \n            className=\"cursor-pointer hover:shadow-lg transition-all hover:scale-105 border-2 hover:border-orange-500\"\n            onClick={() => handleModuleSelect('maintenance')}\n            data-testid=\"card-module-maintenance\"\n          >\n            <CardHeader className=\"text-center\">\n              <div className=\"w-16 h-16 bg-orange-100 dark:bg-orange-900 rounded-full flex items-center justify-center mx-auto mb-4\">\n                <Wrench className=\"w-8 h-8 text-orange-600 dark:text-orange-400\" />\n              </div>\n              <CardTitle className=\"text-2xl text-orange-900 dark:text-orange-400\">\n                {MODULE_CONFIGS.maintenance.displayName}\n              </CardTitle>\n              <CardDescription className=\"text-base\">\n                {MODULE_CONFIGS.maintenance.description}\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              <Button \n                className=\"w-full bg-orange-600 hover:bg-orange-700 text-white\"\n                data-testid=\"button-select-maintenance\"\n              >\n                Acessar OPUS Manutenção\n              </Button>\n            </CardContent>\n          </Card>\n        </div>\n\n        <div className=\"mt-8 text-center\">\n          <p className=\"text-sm text-slate-500 dark:text-slate-400\">\n            Sistema modular de gestão de facilities\n          </p>\n        </div>\n      </div>\n    </div>\n  );\n}\n","size_bytes":3728},"client/src/pages/equipment.tsx":{"content":"import { ModernCard, ModernCardContent, ModernCardHeader } from \"@/components/ui/modern-card\";\nimport { ModernPageHeader } from \"@/components/ui/modern-page-header\";\nimport { useModuleTheme } from \"@/hooks/use-module-theme\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Label } from \"@/components/ui/label\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useState, useEffect } from \"react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useModule } from \"@/contexts/ModuleContext\";\nimport { useLocation } from \"wouter\";\nimport { cn } from \"@/lib/utils\";\nimport { \n  Plus, \n  Edit, \n  Trash2,\n  Wrench,\n  RefreshCw,\n  Settings,\n  Package\n} from \"lucide-react\";\n\ninterface EquipmentProps {\n  customerId: string;\n}\n\nexport default function Equipment({ customerId }: EquipmentProps) {\n  const { currentModule } = useModule();\n  const theme = useModuleTheme();\n  const [, setLocation] = useLocation();\n  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);\n  const [isEditDialogOpen, setIsEditDialogOpen] = useState(false);\n  const [editingEquipment, setEditingEquipment] = useState<any>(null);\n  \n  // Form states\n  const [selectedSiteId, setSelectedSiteId] = useState(\"\");\n  const [selectedZoneId, setSelectedZoneId] = useState(\"\");\n  const [equipmentName, setEquipmentName] = useState(\"\");\n  const [equipmentType, setEquipmentType] = useState(\"\");\n  const [manufacturer, setManufacturer] = useState(\"\");\n  const [model, setModel] = useState(\"\");\n  const [serialNumber, setSerialNumber] = useState(\"\");\n  const [installationDate, setInstallationDate] = useState(\"\");\n  const [warrantyExpiry, setWarrantyExpiry] = useState(\"\");\n  const [status, setStatus] = useState(\"operacional\");\n  const [description, setDescription] = useState(\"\");\n\n  const { toast } = useToast();\n\n  // Fetch customer data\n  const { data: customer } = useQuery({\n    queryKey: [`/api/customers/${customerId}`],\n    enabled: !!customerId,\n  });\n\n  // Fetch sites\n  const { data: sites } = useQuery({\n    queryKey: [`/api/customers/${customerId}/sites`, { module: currentModule }],\n    enabled: !!customerId,\n  });\n\n  // Fetch zones for selected site\n  const { data: zones } = useQuery({\n    queryKey: [`/api/sites/${selectedSiteId}/zones`, { module: currentModule }],\n    enabled: !!selectedSiteId,\n  });\n\n  // Fetch equipment\n  const { data: equipment, isLoading } = useQuery({\n    queryKey: [`/api/customers/${customerId}/equipment`],\n    enabled: !!customerId,\n  });\n\n  // Redirect if not in maintenance module\n  useEffect(() => {\n    if (currentModule !== 'maintenance') {\n      setLocation('/');\n    }\n  }, [currentModule, setLocation]);\n\n  const createEquipmentMutation = useMutation({\n    mutationFn: async (data: any) => {\n      return await apiRequest(\"POST\", \"/api/equipment\", data);\n    },\n    onSuccess: () => {\n      toast({ title: \"Equipamento criado com sucesso\" });\n      queryClient.invalidateQueries({ queryKey: [`/api/customers/${customerId}/equipment`] });\n      setIsCreateDialogOpen(false);\n      resetForm();\n    },\n    onError: () => {\n      toast({ \n        title: \"Erro ao criar equipamento\", \n        variant: \"destructive\" \n      });\n    },\n  });\n\n  const updateEquipmentMutation = useMutation({\n    mutationFn: async (data: any) => {\n      return await apiRequest(\"PUT\", `/api/equipment/${data.id}`, data);\n    },\n    onSuccess: () => {\n      toast({ title: \"Equipamento atualizado com sucesso\" });\n      queryClient.invalidateQueries({ queryKey: [`/api/customers/${customerId}/equipment`] });\n      setIsEditDialogOpen(false);\n      setEditingEquipment(null);\n      resetForm();\n    },\n    onError: () => {\n      toast({ \n        title: \"Erro ao atualizar equipamento\", \n        variant: \"destructive\" \n      });\n    },\n  });\n\n  const deleteEquipmentMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return await apiRequest(\"DELETE\", `/api/equipment/${id}`);\n    },\n    onSuccess: () => {\n      toast({ title: \"Equipamento excluído com sucesso\" });\n      queryClient.invalidateQueries({ queryKey: [`/api/customers/${customerId}/equipment`] });\n    },\n    onError: () => {\n      toast({ \n        title: \"Erro ao excluir equipamento\", \n        variant: \"destructive\" \n      });\n    },\n  });\n\n  const resetForm = () => {\n    setSelectedSiteId(\"\");\n    setSelectedZoneId(\"\");\n    setEquipmentName(\"\");\n    setEquipmentType(\"\");\n    setManufacturer(\"\");\n    setModel(\"\");\n    setSerialNumber(\"\");\n    setInstallationDate(\"\");\n    setWarrantyExpiry(\"\");\n    setStatus(\"operacional\");\n    setDescription(\"\");\n  };\n\n  const handleCreate = () => {\n    const companyId = (customer as any)?.companyId;\n    if (!companyId || !selectedSiteId) {\n      toast({ \n        title: \"Preencha todos os campos obrigatórios\", \n        variant: \"destructive\" \n      });\n      return;\n    }\n\n    createEquipmentMutation.mutate({\n      companyId,\n      customerId,\n      siteId: selectedSiteId,\n      zoneId: selectedZoneId || null,\n      name: equipmentName,\n      equipmentType,\n      manufacturer: manufacturer || null,\n      model: model || null,\n      serialNumber: serialNumber || null,\n      installationDate: installationDate || null,\n      warrantyExpiry: warrantyExpiry || null,\n      status,\n      description: description || null,\n      module: currentModule,\n    });\n  };\n\n  const handleEdit = (equip: any) => {\n    setEditingEquipment(equip);\n    setSelectedSiteId(equip.siteId);\n    setSelectedZoneId(equip.zoneId || \"\");\n    setEquipmentName(equip.name);\n    setEquipmentType(equip.equipmentType);\n    setManufacturer(equip.manufacturer || \"\");\n    setModel(equip.model || \"\");\n    setSerialNumber(equip.serialNumber || \"\");\n    setInstallationDate(equip.installationDate || \"\");\n    setWarrantyExpiry(equip.warrantyExpiry || \"\");\n    setStatus(equip.status);\n    setDescription(equip.description || \"\");\n    setIsEditDialogOpen(true);\n  };\n\n  const handleUpdate = () => {\n    const companyId = (customer as any)?.companyId;\n    if (!editingEquipment || !companyId) return;\n\n    updateEquipmentMutation.mutate({\n      id: editingEquipment.id,\n      companyId,\n      customerId,\n      siteId: selectedSiteId,\n      zoneId: selectedZoneId || null,\n      name: equipmentName,\n      equipmentType,\n      manufacturer: manufacturer || null,\n      model: model || null,\n      serialNumber: serialNumber || null,\n      installationDate: installationDate || null,\n      warrantyExpiry: warrantyExpiry || null,\n      status,\n      description: description || null,\n    });\n  };\n\n  const handleDelete = (id: string) => {\n    if (confirm(\"Tem certeza que deseja excluir este equipamento?\")) {\n      deleteEquipmentMutation.mutate(id);\n    }\n  };\n\n  // Get site and zone names for display\n  const getSiteName = (siteId: string) => {\n    if (!Array.isArray(sites)) return \"N/A\";\n    return sites.find((s: any) => s.id === siteId)?.name || \"N/A\";\n  };\n\n  const getZoneName = (zoneId: string | null) => {\n    if (!zoneId) return \"N/A\";\n    // We need to fetch all zones for this\n    return zoneId;\n  };\n\n  return (\n    <>\n      <ModernPageHeader \n        title=\"Equipamentos\"\n        description=\"Gerencie equipamentos e ativos de manutenção\"\n        icon={Wrench}\n        stats={[\n          { \n            label: \"Total de Equipamentos\", \n            value: Array.isArray(equipment) ? equipment.length : 0,\n            icon: Package\n          },\n          {\n            label: \"Operacionais\",\n            value: Array.isArray(equipment) ? equipment.filter((e: any) => e.status === 'operacional').length : 0,\n            icon: Settings\n          }\n        ]}\n        actions={\n          <Button \n            onClick={() => window.location.reload()}\n            className={cn(\"flex items-center gap-2\", theme.buttons.outline)}\n            size=\"sm\"\n          >\n            <RefreshCw className=\"w-4 h-4\" />\n            Atualizar\n          </Button>\n        }\n      />\n      \n      <div className={cn(\"flex-1 overflow-y-auto p-4 md:p-6 space-y-6\", theme.gradients.section)}>\n        <ModernCard variant=\"gradient\">\n          <ModernCardHeader icon={<Wrench className=\"w-6 h-6\" />}>\n            Lista de Equipamentos\n          </ModernCardHeader>\n          <ModernCardContent>\n            <div className=\"mb-4 flex justify-end\">\n              <Dialog open={isCreateDialogOpen} onOpenChange={setIsCreateDialogOpen}>\n                <DialogTrigger asChild>\n                  <Button \n                    className={theme.buttons.primary}\n                    data-testid=\"button-create-equipment\"\n                  >\n                    <Plus className=\"mr-2 h-4 w-4\" />\n                    Novo Equipamento\n                  </Button>\n                </DialogTrigger>\n              <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n                <DialogHeader>\n                  <DialogTitle>Criar Novo Equipamento</DialogTitle>\n                  <DialogDescription>\n                    Cadastre um novo equipamento no sistema\n                  </DialogDescription>\n                </DialogHeader>\n                \n                <div className=\"grid gap-4 py-4\">\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"site\">Local *</Label>\n                      <Select value={selectedSiteId} onValueChange={setSelectedSiteId}>\n                        <SelectTrigger data-testid=\"select-site\">\n                          <SelectValue placeholder=\"Selecione um local\" />\n                        </SelectTrigger>\n                        <SelectContent>\n                          {Array.isArray(sites) && sites.map((site: any) => (\n                            <SelectItem key={site.id} value={site.id}>\n                              {site.name}\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                    </div>\n\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"zone\">Zona (Opcional)</Label>\n                      <Select value={selectedZoneId} onValueChange={setSelectedZoneId} disabled={!selectedSiteId}>\n                        <SelectTrigger data-testid=\"select-zone\">\n                          <SelectValue placeholder=\"Selecione uma zona\" />\n                        </SelectTrigger>\n                        <SelectContent>\n                          {Array.isArray(zones) && zones.map((zone: any) => (\n                            <SelectItem key={zone.id} value={zone.id}>\n                              {zone.name}\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                    </div>\n                  </div>\n\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"name\">Nome do Equipamento *</Label>\n                      <Input\n                        id=\"name\"\n                        data-testid=\"input-equipment-name\"\n                        value={equipmentName}\n                        onChange={(e) => setEquipmentName(e.target.value)}\n                        placeholder=\"Ex: Ar Condicionado\"\n                      />\n                    </div>\n\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"type\">Tipo de Equipamento *</Label>\n                      <Select value={equipmentType} onValueChange={setEquipmentType}>\n                        <SelectTrigger data-testid=\"select-equipment-type\">\n                          <SelectValue placeholder=\"Selecione o tipo\" />\n                        </SelectTrigger>\n                        <SelectContent>\n                          <SelectItem value=\"hvac\">HVAC</SelectItem>\n                          <SelectItem value=\"eletrico\">Elétrico</SelectItem>\n                          <SelectItem value=\"hidraulico\">Hidráulico</SelectItem>\n                          <SelectItem value=\"mecanico\">Mecânico</SelectItem>\n                          <SelectItem value=\"eletronico\">Eletrônico</SelectItem>\n                          <SelectItem value=\"outro\">Outro</SelectItem>\n                        </SelectContent>\n                      </Select>\n                    </div>\n                  </div>\n\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"status\">Status</Label>\n                      <Select value={status} onValueChange={setStatus}>\n                        <SelectTrigger data-testid=\"select-status\">\n                          <SelectValue />\n                        </SelectTrigger>\n                        <SelectContent>\n                          <SelectItem value=\"operacional\">Operacional</SelectItem>\n                          <SelectItem value=\"em_manutencao\">Em Manutenção</SelectItem>\n                          <SelectItem value=\"inoperante\">Inoperante</SelectItem>\n                          <SelectItem value=\"aposentado\">Aposentado</SelectItem>\n                        </SelectContent>\n                      </Select>\n                    </div>\n\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"manufacturer\">Fabricante</Label>\n                      <Input\n                        id=\"manufacturer\"\n                        data-testid=\"input-manufacturer\"\n                        value={manufacturer}\n                        onChange={(e) => setManufacturer(e.target.value)}\n                        placeholder=\"Ex: Samsung\"\n                      />\n                    </div>\n                  </div>\n\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"model\">Modelo</Label>\n                      <Input\n                        id=\"model\"\n                        data-testid=\"input-model\"\n                        value={model}\n                        onChange={(e) => setModel(e.target.value)}\n                        placeholder=\"Ex: AR9000\"\n                      />\n                    </div>\n\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"serialNumber\">Número de Série</Label>\n                      <Input\n                        id=\"serialNumber\"\n                        data-testid=\"input-serial-number\"\n                        value={serialNumber}\n                        onChange={(e) => setSerialNumber(e.target.value)}\n                        placeholder=\"SN123456\"\n                      />\n                    </div>\n                  </div>\n\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"installationDate\">Data de Instalação</Label>\n                      <Input\n                        id=\"installationDate\"\n                        type=\"date\"\n                        data-testid=\"input-installation-date\"\n                        value={installationDate}\n                        onChange={(e) => setInstallationDate(e.target.value)}\n                      />\n                    </div>\n\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"warrantyExpiry\">Vencimento da Garantia</Label>\n                      <Input\n                        id=\"warrantyExpiry\"\n                        type=\"date\"\n                        data-testid=\"input-warranty-expiry\"\n                        value={warrantyExpiry}\n                        onChange={(e) => setWarrantyExpiry(e.target.value)}\n                      />\n                    </div>\n                  </div>\n\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"description\">Descrição</Label>\n                    <Textarea\n                      id=\"description\"\n                      data-testid=\"input-description\"\n                      value={description}\n                      onChange={(e) => setDescription(e.target.value)}\n                      placeholder=\"Informações adicionais sobre o equipamento\"\n                      rows={3}\n                    />\n                  </div>\n                </div>\n\n                <div className=\"flex justify-end gap-2\">\n                  <Button\n                    variant=\"outline\"\n                    onClick={() => setIsCreateDialogOpen(false)}\n                    data-testid=\"button-cancel\"\n                  >\n                    Cancelar\n                  </Button>\n                  <Button\n                    onClick={handleCreate}\n                    disabled={createEquipmentMutation.isPending}\n                    data-testid=\"button-save\"\n                  >\n                    {createEquipmentMutation.isPending ? \"Criando...\" : \"Criar Equipamento\"}\n                  </Button>\n                </div>\n              </DialogContent>\n            </Dialog>\n            </div>\n\n            {isLoading ? (\n              <div className=\"text-center py-8\">\n                <div className=\"w-16 h-16 border-4 border-orange-100 border-t-orange-600 rounded-full animate-spin mx-auto\"></div>\n                <p className=\"mt-4 text-gray-600\">Carregando equipamentos...</p>\n              </div>\n            ) : !Array.isArray(equipment) || equipment.length === 0 ? (\n              <div className=\"text-center py-12\">\n                <Package className=\"w-16 h-16 mx-auto text-gray-300 mb-4\" />\n                <p className=\"text-gray-500 text-lg font-medium\">Nenhum equipamento cadastrado</p>\n                <p className=\"text-gray-400 text-sm mt-1\">Clique em \"Novo Equipamento\" para começar</p>\n              </div>\n            ) : (\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>Código</TableHead>\n                    <TableHead>Nome</TableHead>\n                    <TableHead>Tipo</TableHead>\n                    <TableHead>Local</TableHead>\n                    <TableHead>Status</TableHead>\n                    <TableHead>Fabricante</TableHead>\n                    <TableHead>Modelo</TableHead>\n                    <TableHead className=\"text-right\">Ações</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {Array.isArray(equipment) && equipment.map((equip: any) => (\n                    <TableRow key={equip.id} data-testid={`row-equipment-${equip.id}`}>\n                      <TableCell className=\"font-mono text-sm\">\n                        {equip.internalCode || \"-\"}\n                      </TableCell>\n                      <TableCell className=\"font-medium\">{equip.name}</TableCell>\n                      <TableCell className=\"capitalize\">{equip.equipmentType}</TableCell>\n                      <TableCell>{getSiteName(equip.siteId)}</TableCell>\n                      <TableCell>\n                        <span className={`inline-flex items-center px-2 py-1 rounded text-xs font-medium ${\n                          equip.status === 'operacional' ? 'bg-green-100 text-green-800' :\n                          equip.status === 'em_manutencao' ? 'bg-yellow-100 text-yellow-800' :\n                          equip.status === 'inoperante' ? 'bg-red-100 text-red-800' :\n                          'bg-gray-100 text-gray-800'\n                        }`}>\n                          {equip.status === 'operacional' ? 'Operacional' :\n                           equip.status === 'em_manutencao' ? 'Em Manutenção' :\n                           equip.status === 'inoperante' ? 'Inoperante' :\n                           'Aposentado'}\n                        </span>\n                      </TableCell>\n                      <TableCell>{equip.manufacturer || \"-\"}</TableCell>\n                      <TableCell>{equip.model || \"-\"}</TableCell>\n                      <TableCell className=\"text-right\">\n                        <div className=\"flex justify-end gap-2\">\n                          <Button\n                            variant=\"ghost\"\n                            size=\"sm\"\n                            onClick={() => handleEdit(equip)}\n                            data-testid={`button-edit-${equip.id}`}\n                          >\n                            <Edit className=\"h-4 w-4\" />\n                          </Button>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"sm\"\n                            onClick={() => handleDelete(equip.id)}\n                            data-testid={`button-delete-${equip.id}`}\n                          >\n                            <Trash2 className=\"h-4 w-4 text-destructive\" />\n                          </Button>\n                        </div>\n                      </TableCell>\n                    </TableRow>\n                  ))}\n                </TableBody>\n              </Table>\n            )}\n          </ModernCardContent>\n        </ModernCard>\n\n        {/* Edit Dialog - Similar structure to create dialog */}\n        <Dialog open={isEditDialogOpen} onOpenChange={setIsEditDialogOpen}>\n          <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n            <DialogHeader>\n              <DialogTitle>Editar Equipamento</DialogTitle>\n              <DialogDescription>\n                Atualize as informações do equipamento\n              </DialogDescription>\n            </DialogHeader>\n            \n            <div className=\"grid gap-4 py-4\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"edit-site\">Local *</Label>\n                  <Select value={selectedSiteId} onValueChange={setSelectedSiteId}>\n                    <SelectTrigger>\n                      <SelectValue placeholder=\"Selecione um local\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {Array.isArray(sites) && sites.map((site: any) => (\n                        <SelectItem key={site.id} value={site.id}>\n                          {site.name}\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"edit-zone\">Zona (Opcional)</Label>\n                  <Select value={selectedZoneId} onValueChange={setSelectedZoneId} disabled={!selectedSiteId}>\n                    <SelectTrigger>\n                      <SelectValue placeholder=\"Selecione uma zona\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {Array.isArray(zones) && zones.map((zone: any) => (\n                        <SelectItem key={zone.id} value={zone.id}>\n                          {zone.name}\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label>Nome do Equipamento *</Label>\n                  <Input\n                    value={equipmentName}\n                    onChange={(e) => setEquipmentName(e.target.value)}\n                  />\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label>Tipo de Equipamento *</Label>\n                  <Select value={equipmentType} onValueChange={setEquipmentType}>\n                    <SelectTrigger>\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"hvac\">HVAC</SelectItem>\n                      <SelectItem value=\"eletrico\">Elétrico</SelectItem>\n                      <SelectItem value=\"hidraulico\">Hidráulico</SelectItem>\n                      <SelectItem value=\"mecanico\">Mecânico</SelectItem>\n                      <SelectItem value=\"eletronico\">Eletrônico</SelectItem>\n                      <SelectItem value=\"outro\">Outro</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label>Status</Label>\n                  <Select value={status} onValueChange={setStatus}>\n                    <SelectTrigger>\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"operacional\">Operacional</SelectItem>\n                      <SelectItem value=\"em_manutencao\">Em Manutenção</SelectItem>\n                      <SelectItem value=\"inoperante\">Inoperante</SelectItem>\n                      <SelectItem value=\"aposentado\">Aposentado</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label>Fabricante</Label>\n                  <Input\n                    value={manufacturer}\n                    onChange={(e) => setManufacturer(e.target.value)}\n                  />\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label>Modelo</Label>\n                  <Input\n                    value={model}\n                    onChange={(e) => setModel(e.target.value)}\n                  />\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label>Número de Série</Label>\n                  <Input\n                    value={serialNumber}\n                    onChange={(e) => setSerialNumber(e.target.value)}\n                  />\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label>Data de Instalação</Label>\n                  <Input\n                    type=\"date\"\n                    value={installationDate}\n                    onChange={(e) => setInstallationDate(e.target.value)}\n                  />\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label>Vencimento da Garantia</Label>\n                  <Input\n                    type=\"date\"\n                    value={warrantyExpiry}\n                    onChange={(e) => setWarrantyExpiry(e.target.value)}\n                  />\n                </div>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label>Descrição</Label>\n                <Textarea\n                  value={description}\n                  onChange={(e) => setDescription(e.target.value)}\n                  rows={3}\n                />\n              </div>\n            </div>\n\n            <div className=\"flex justify-end gap-2\">\n              <Button\n                variant=\"outline\"\n                onClick={() => {\n                  setIsEditDialogOpen(false);\n                  setEditingEquipment(null);\n                  resetForm();\n                }}\n              >\n                Cancelar\n              </Button>\n              <Button\n                onClick={handleUpdate}\n                disabled={updateEquipmentMutation.isPending}\n              >\n                {updateEquipmentMutation.isPending ? \"Atualizando...\" : \"Atualizar\"}\n              </Button>\n            </div>\n          </DialogContent>\n        </Dialog>\n      </div>\n    </>\n  );\n}\n","size_bytes":28185},"client/src/pages/maintenance-plans.tsx":{"content":"import { ModernCard, ModernCardContent, ModernCardHeader } from \"@/components/ui/modern-card\";\nimport { ModernPageHeader } from \"@/components/ui/modern-page-header\";\nimport { useModuleTheme } from \"@/hooks/use-module-theme\";\nimport { Button } from \"@/components/ui/button\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { useState, useMemo } from \"react\";\nimport { useClient } from \"@/contexts/ClientContext\";\nimport { useModule } from \"@/contexts/ModuleContext\";\nimport { useLocation } from \"wouter\";\nimport { cn } from \"@/lib/utils\";\nimport { \n  Plus, \n  Calendar, \n  Clock, \n  MapPin,\n  Eye,\n  Edit,\n  Copy,\n  Trash2,\n  ChevronLeft,\n  ChevronRight,\n  User,\n  Timer,\n  Save,\n  Settings,\n  Wrench,\n  RefreshCw,\n  CalendarRange\n} from \"lucide-react\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from \"@/components/ui/dialog\";\nimport { Label } from \"@/components/ui/label\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useEffect } from \"react\";\nimport { Popover, PopoverContent, PopoverTrigger } from \"@/components/ui/popover\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { ChevronDown } from \"lucide-react\";\n\nexport default function MaintenancePlans() {\n  const { activeClientId } = useClient();\n  const { currentModule } = useModule();\n  const theme = useModuleTheme();\n  const queryClient = useQueryClient();\n  const { toast } = useToast();\n  const [, setLocation] = useLocation();\n\n  const [viewMode, setViewMode] = useState<\"monthly\" | \"list\">(\"monthly\");\n  const [siteFilter, setSiteFilter] = useState(\"todos\");\n  const [currentDate, setCurrentDate] = useState(new Date());\n  const [showCreateModal, setShowCreateModal] = useState(false);\n  const [showDayDetailsModal, setShowDayDetailsModal] = useState(false);\n  const [selectedDay, setSelectedDay] = useState<number | null>(null);\n  const [selectedActivities, setSelectedActivities] = useState<any[]>([]);\n  const [showActivityDetailsModal, setShowActivityDetailsModal] = useState(false);\n  const [showEditActivityModal, setShowEditActivityModal] = useState(false);\n  const [selectedActivity, setSelectedActivity] = useState<any>(null);\n  const [selectedForDeletion, setSelectedForDeletion] = useState<string[]>([]);\n\n  const { data: activities, isLoading } = useQuery({\n    queryKey: [\"/api/customers\", activeClientId, \"maintenance-activities\"],\n    enabled: !!activeClientId,\n  });\n\n  const { data: sites } = useQuery({\n    queryKey: [\"/api/customers\", activeClientId, \"sites\", { module: currentModule }],\n    enabled: !!activeClientId,\n  });\n\n  const { data: zones } = useQuery({\n    queryKey: [\"/api/customers\", activeClientId, \"zones\", { module: currentModule }],\n    enabled: !!activeClientId,\n  });\n\n  const { data: users } = useQuery({\n    queryKey: [\"/api/customers\", activeClientId, \"users\"],\n    enabled: !!activeClientId,\n  });\n\n  const { data: equipment } = useQuery({\n    queryKey: [\"/api/customers\", activeClientId, \"equipment\"],\n    enabled: !!activeClientId,\n  });\n\n  // Redirect if not in maintenance module\n  useEffect(() => {\n    if (currentModule !== 'maintenance') {\n      setLocation('/');\n    }\n  }, [currentModule, setLocation]);\n\n  // Mutation to delete maintenance activity\n  const deleteMaintenanceActivityMutation = useMutation({\n    mutationFn: async (activityId: string) => {\n      await apiRequest('DELETE', `/api/maintenance-activities/${activityId}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/customers\", activeClientId, \"maintenance-activities\"] });\n      toast({\n        title: \"Atividade excluída\",\n        description: \"A atividade de manutenção foi removida com sucesso.\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Não foi possível excluir a atividade.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleDeleteActivity = async (activity: any) => {\n    if (confirm(`Deseja realmente excluir a atividade \"${activity.name}\"? Esta ação não pode ser desfeita.`)) {\n      await deleteMaintenanceActivityMutation.mutateAsync(activity.id);\n    }\n  };\n\n  // Mutation para gerar OSs manualmente (teste)\n  const generateWorkOrdersMutation = useMutation({\n    mutationFn: async () => {\n      const response = await apiRequest('POST', '/api/scheduler/regenerate-monthly-maintenance', {});\n      return response;\n    },\n    onSuccess: (data: any) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/customers\", activeClientId, \"work-orders\"] });\n      toast({\n        title: \"OSs geradas com sucesso!\",\n        description: `${data.totalGenerated} ordens de serviço foram criadas para o próximo mês.`,\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Erro ao gerar OSs\",\n        description: \"Ocorreu um erro ao gerar as ordens de serviço.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const getFrequencyBadge = (frequency: string) => {\n    switch (frequency) {\n      case \"diaria\":\n        return <Badge className=\"bg-chart-2/10 text-chart-2\">Diária</Badge>;\n      case \"semanal\":\n        return <Badge className=\"bg-chart-4/10 text-chart-4\">Semanal</Badge>;\n      case \"mensal\":\n        return <Badge className=\"bg-primary/10 text-primary\">Mensal</Badge>;\n      case \"trimestral\":\n        return <Badge className=\"bg-indigo-100/80 text-indigo-700\">Trimestral</Badge>;\n      case \"semestral\":\n        return <Badge className=\"bg-violet-100/80 text-violet-700\">Semestral</Badge>;\n      case \"anual\":\n        return <Badge className=\"bg-rose-100/80 text-rose-700\">Anual</Badge>;\n      case \"turno\":\n        return <Badge className=\"bg-chart-1/10 text-chart-1\">Por Turno</Badge>;\n      default:\n        return <Badge variant=\"outline\">Personalizada</Badge>;\n    }\n  };\n\n  const getTypeBadge = (type: string) => {\n    switch (type) {\n      case \"preventiva\":\n        return <Badge className=\"bg-green-100/80 text-green-700\">Preventiva</Badge>;\n      case \"preditiva\":\n        return <Badge className=\"bg-blue-100/80 text-blue-700\">Preditiva</Badge>;\n      case \"corretiva\":\n        return <Badge className=\"bg-orange-100/80 text-orange-700\">Corretiva</Badge>;\n      default:\n        return <Badge variant=\"outline\">Não definido</Badge>;\n    }\n  };\n\n  // Função para gerar o calendário mensal\n  const generateMonthCalendar = () => {\n    const year = currentDate.getFullYear();\n    const month = currentDate.getMonth();\n    const firstDay = new Date(year, month, 1);\n    const lastDay = new Date(year, month + 1, 0);\n    const firstDayOfWeek = firstDay.getDay(); // 0 = domingo\n    const daysInMonth = lastDay.getDate();\n    \n    const calendar = [];\n    let day = 1;\n    \n    // Criar as semanas do mês\n    for (let week = 0; week < 6; week++) {\n      const weekDays = [];\n      \n      for (let dayOfWeek = 0; dayOfWeek < 7; dayOfWeek++) {\n        if (week === 0 && dayOfWeek < firstDayOfWeek) {\n          // Dias vazios antes do primeiro dia do mês\n          weekDays.push(null);\n        } else if (day > daysInMonth) {\n          // Dias vazios depois do último dia do mês\n          weekDays.push(null);\n        } else {\n          // Dias válidos do mês\n          weekDays.push(day);\n          day++;\n        }\n      }\n      \n      calendar.push(weekDays);\n      \n      // Se todos os dias do mês já foram adicionados, parar\n      if (day > daysInMonth) break;\n    }\n    \n    return calendar;\n  };\n\n  // Função para obter zona por ID\n  const getZoneName = (zoneId: string) => {\n    const zone = (zones as any[] || []).find((z: any) => z.id === zoneId);\n    return zone?.name || 'Local não encontrado';\n  };\n\n  // Função para obter responsável por ID\n  const getAssignedUserName = (userId: string) => {\n    const user = (users as any[] || []).find((u: any) => u.id === userId);\n    return user?.name || 'Não atribuído';\n  };\n\n  // Função para obter SLA baseado no tipo de atividade\n  const getSLAForActivity = (activity: any) => {\n    return `${activity.slaMinutes || 60}min`;\n  };\n\n  // Função para obter equipamentos relacionados a uma zona\n  const getEquipmentForZone = (zoneId: string) => {\n    return (equipment as any[] || []).filter((e: any) => e.zoneId === zoneId);\n  };\n\n  // Função para obter nomes dos equipamentos por IDs\n  const getEquipmentNames = (equipmentIds: string[]) => {\n    if (!equipmentIds || equipmentIds.length === 0) return [];\n    return (equipment as any[] || [])\n      .filter((e: any) => equipmentIds.includes(e.id))\n      .map((e: any) => e.name);\n  };\n\n  // Função para calcular próxima data de execução\n  const getNextExecutionDate = (activity: any) => {\n    const now = new Date();\n    const lastExecution = activity.lastExecutedAt ? new Date(activity.lastExecutedAt) : null;\n    \n    if (!lastExecution) return 'Nunca executado';\n    \n    let nextDate = new Date(lastExecution);\n    \n    switch (activity.frequency) {\n      case 'diaria':\n        nextDate.setDate(nextDate.getDate() + 1);\n        break;\n      case 'semanal':\n        nextDate.setDate(nextDate.getDate() + 7);\n        break;\n      case 'mensal':\n        nextDate.setMonth(nextDate.getMonth() + 1);\n        break;\n      case 'trimestral':\n        nextDate.setMonth(nextDate.getMonth() + 3);\n        break;\n      case 'semestral':\n        nextDate.setMonth(nextDate.getMonth() + 6);\n        break;\n      case 'anual':\n        nextDate.setFullYear(nextDate.getFullYear() + 1);\n        break;\n      default:\n        return 'Frequência personalizada';\n    }\n    \n    return nextDate.toLocaleDateString('pt-BR');\n  };\n\n  // Função para obter atividades de um dia específico\n  const getActivitiesForDay = (day: number) => {\n    if (!activities) return [];\n    \n    return (activities as any[]).filter((activity: any) => {\n      if (activity.frequency === 'diaria') return true;\n      if (activity.frequency === 'semanal') {\n        const dayOfWeek = new Date(currentDate.getFullYear(), currentDate.getMonth(), day).getDay();\n        const weekDays = activity.frequencyConfig?.weekDays || [];\n        const dayMap: Record<string, number> = {\n          'domingo': 0, 'segunda': 1, 'terca': 2, 'quarta': 3,\n          'quinta': 4, 'sexta': 5, 'sabado': 6\n        };\n        return weekDays.some((d: string) => dayMap[d] === dayOfWeek);\n      }\n      if (activity.frequency === 'mensal') {\n        return day === (activity.frequencyConfig?.monthDay || 1);\n      }\n      if (activity.frequency === 'trimestral') {\n        const startDate = new Date(activity.startDate);\n        const currentMonth = currentDate.getMonth();\n        const startMonth = startDate.getMonth();\n        const monthDiff = (currentMonth - startMonth + 12) % 12;\n        return monthDiff % 3 === 0 && day === (activity.frequencyConfig?.monthDay || 1);\n      }\n      if (activity.frequency === 'semestral') {\n        const startDate = new Date(activity.startDate);\n        const currentMonth = currentDate.getMonth();\n        const startMonth = startDate.getMonth();\n        const monthDiff = (currentMonth - startMonth + 12) % 12;\n        return monthDiff % 6 === 0 && day === (activity.frequencyConfig?.monthDay || 1);\n      }\n      if (activity.frequency === 'anual') {\n        const startDate = new Date(activity.startDate);\n        const currentMonth = currentDate.getMonth();\n        const startMonth = startDate.getMonth();\n        return currentMonth === startMonth && day === (activity.frequencyConfig?.monthDay || 1);\n      }\n      return false;\n    });\n  };\n\n  // Função para navegar pelos meses\n  const navigateMonth = (direction: 'prev' | 'next') => {\n    setCurrentDate(prev => {\n      const newDate = new Date(prev);\n      if (direction === 'prev') {\n        newDate.setMonth(prev.getMonth() - 1);\n      } else {\n        newDate.setMonth(prev.getMonth() + 1);\n      }\n      return newDate;\n    });\n  };\n\n  // Função para abrir detalhes do dia\n  const openDayDetails = (day: number) => {\n    const dayActivities = getActivitiesForDay(day);\n    setSelectedDay(day);\n    setSelectedActivities(dayActivities);\n    setShowDayDetailsModal(true);\n  };\n\n  // Função para formatar data selecionada\n  const getSelectedDateFormatted = () => {\n    if (!selectedDay) return '';\n    const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), selectedDay);\n    return date.toLocaleDateString('pt-BR', { \n      weekday: 'long', \n      year: 'numeric', \n      month: 'long', \n      day: 'numeric' \n    });\n  };\n\n  if (isLoading) {\n    return (\n      <>\n        <ModernPageHeader \n          title=\"Plano de Manutenção\" \n          description=\"Gerenciamento de atividades programadas\"\n          icon={CalendarRange}\n        />\n        <div className=\"flex-1 flex items-center justify-center\">\n          <div className=\"text-center space-y-4\">\n            <div className=\"w-16 h-16 border-4 border-orange-100 border-t-orange-600 rounded-full animate-spin mx-auto\"></div>\n            <p className=\"text-gray-600\">Carregando plano de manutenção...</p>\n          </div>\n        </div>\n      </>\n    );\n  }\n\n  return (\n    <>\n      <ModernPageHeader \n        title=\"Plano de Manutenção\" \n        description=\"Gerenciamento de atividades de manutenção programadas\"\n        icon={CalendarRange}\n        actions={\n          <div className=\"flex items-center gap-2\">\n            <Select value={viewMode} onValueChange={(value: \"monthly\" | \"list\") => setViewMode(value)}>\n              <SelectTrigger className=\"w-32\" data-testid=\"select-view-mode\">\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"monthly\">📆 Mensal</SelectItem>\n                <SelectItem value=\"list\">📋 Lista</SelectItem>\n              </SelectContent>\n            </Select>\n            <Button \n              onClick={() => generateWorkOrdersMutation.mutate()}\n              variant=\"outline\"\n              disabled={generateWorkOrdersMutation.isPending}\n              data-testid=\"button-generate-work-orders\"\n              className={cn(\"flex items-center gap-2\", theme.buttons.outline)}\n            >\n              <Settings className=\"w-4 h-4\" />\n              {generateWorkOrdersMutation.isPending ? 'Gerando...' : 'Gerar OSs'}\n            </Button>\n            <Button \n              onClick={() => setShowCreateModal(true)}\n              className={theme.buttons.primary}\n              data-testid=\"button-create-activity\"\n            >\n              <Plus className=\"w-4 h-4 mr-2\" />\n              Nova Atividade\n            </Button>\n          </div>\n        }\n      />\n      \n      <div className={cn(\"flex-1 overflow-y-auto p-4 md:p-6 space-y-6\", theme.gradients.section)}>\n        {/* Filters and Stats Combined */}\n        <ModernCard variant=\"glass\">\n          <ModernCardContent>\n            {/* Stats Row */}\n            <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 mb-6\">\n              <div className=\"flex items-center gap-3\">\n                <div className={cn(\"w-10 h-10 rounded-lg flex items-center justify-center\", theme.backgrounds.light)}>\n                  <Wrench className={cn(\"w-5 h-5\", theme.text.primary)} />\n                </div>\n                <div>\n                  <p className=\"text-xs text-muted-foreground\">Ativas</p>\n                  <p className=\"text-xl font-bold text-foreground\">\n                    {(activities as any[])?.filter((a: any) => a.isActive).length || 0}\n                  </p>\n                </div>\n              </div>\n\n              <div className=\"flex items-center gap-3\">\n                <div className=\"w-10 h-10 bg-green-50 rounded-lg flex items-center justify-center\">\n                  <Clock className=\"w-5 h-5 text-green-600\" />\n                </div>\n                <div>\n                  <p className=\"text-xs text-muted-foreground\">Preventivas</p>\n                  <p className=\"text-xl font-bold text-green-600\">\n                    {(activities as any[])?.filter((a: any) => a.type === 'preventiva').length || 0}\n                  </p>\n                </div>\n              </div>\n\n              <div className=\"flex items-center gap-3\">\n                <div className=\"w-10 h-10 bg-blue-50 rounded-lg flex items-center justify-center\">\n                  <Timer className=\"w-5 h-5 text-blue-600\" />\n                </div>\n                <div>\n                  <p className=\"text-xs text-muted-foreground\">Preditivas</p>\n                  <p className=\"text-xl font-bold text-blue-600\">\n                    {(activities as any[])?.filter((a: any) => a.type === 'preditiva').length || 0}\n                  </p>\n                </div>\n              </div>\n\n              <div className=\"flex items-center gap-3\">\n                <div className=\"w-10 h-10 bg-gray-50 rounded-lg flex items-center justify-center\">\n                  <MapPin className=\"w-5 h-5 text-gray-600\" />\n                </div>\n                <div>\n                  <p className=\"text-xs text-muted-foreground\">Equipamentos</p>\n                  <p className=\"text-xl font-bold text-foreground\">\n                    {new Set((activities as any[])?.flatMap((a: any) => a.equipmentIds || [])).size || 0}\n                  </p>\n                </div>\n              </div>\n            </div>\n\n            {/* Filters Row */}\n            <div className=\"flex flex-wrap gap-3 pt-4 border-t\">\n              <Select value={siteFilter} onValueChange={setSiteFilter}>\n                <SelectTrigger className=\"w-44\" data-testid=\"select-site-filter\">\n                  <SelectValue placeholder=\"Filtrar por local\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"todos\">Todos os Locais</SelectItem>\n                  {(sites as any[])?.map((site: any) => (\n                    <SelectItem key={site.id} value={site.id}>\n                      {site.name}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n              \n              <Select defaultValue=\"todas\">\n                <SelectTrigger className=\"w-44\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"todas\">Todas Frequências</SelectItem>\n                  <SelectItem value=\"diaria\">Diária</SelectItem>\n                  <SelectItem value=\"semanal\">Semanal</SelectItem>\n                  <SelectItem value=\"mensal\">Mensal</SelectItem>\n                  <SelectItem value=\"trimestral\">Trimestral</SelectItem>\n                  <SelectItem value=\"semestral\">Semestral</SelectItem>\n                  <SelectItem value=\"anual\">Anual</SelectItem>\n                  <SelectItem value=\"turno\">Por Turno</SelectItem>\n                </SelectContent>\n              </Select>\n\n              <Select defaultValue=\"todos\">\n                <SelectTrigger className=\"w-44\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"todos\">Todos os Tipos</SelectItem>\n                  <SelectItem value=\"preventiva\">Preventiva</SelectItem>\n                  <SelectItem value=\"preditiva\">Preditiva</SelectItem>\n                  <SelectItem value=\"corretiva\">Corretiva</SelectItem>\n                </SelectContent>\n              </Select>\n\n              <Select defaultValue=\"ativas\">\n                <SelectTrigger className=\"w-44\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"ativas\">Ativas</SelectItem>\n                  <SelectItem value=\"inativas\">Inativas</SelectItem>\n                  <SelectItem value=\"todas\">Todas</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n          </ModernCardContent>\n        </ModernCard>\n\n        {/* Calendar Views or Activities List */}\n        {viewMode === \"monthly\" ? (\n          <ModernCard variant=\"gradient\">\n            <ModernCardHeader icon={<Calendar className=\"w-5 h-5\" />}>\n              <div className=\"flex items-center justify-between w-full\">\n                <span>Calendário de Manutenção</span>\n                <div className=\"flex items-center gap-2\">\n                  <Button \n                    variant=\"ghost\" \n                    size=\"icon\"\n                    onClick={() => navigateMonth('prev')}\n                    className=\"h-8 w-8 hover:bg-muted rounded-lg\"\n                    data-testid=\"button-prev-month\"\n                  >\n                    <ChevronLeft className=\"w-4 h-4\" />\n                  </Button>\n                  <div className=\"px-4 py-1 bg-muted/50 rounded-lg\">\n                    <span className=\"font-semibold text-sm\">\n                      {currentDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' }).replace(/^\\w/, c => c.toUpperCase())}\n                    </span>\n                  </div>\n                  <Button \n                    variant=\"ghost\" \n                    size=\"icon\"\n                    onClick={() => navigateMonth('next')}\n                    className=\"h-8 w-8 hover:bg-muted rounded-lg\"\n                    data-testid=\"button-next-month\"\n                  >\n                    <ChevronRight className=\"w-4 h-4\" />\n                  </Button>\n                </div>\n              </div>\n            </ModernCardHeader>\n\n            <ModernCardContent>\n              {/* Legenda compacta e moderna */}\n              <div className=\"flex flex-wrap gap-2 mb-6 p-3 bg-white rounded-xl border border-slate-200 shadow-sm\">\n                <div className=\"flex items-center gap-1.5\">\n                  <div className=\"w-3 h-3 bg-green-500 rounded-full shadow-sm\"></div>\n                  <span className=\"text-xs font-medium text-slate-600\">Diária</span>\n                </div>\n                <div className=\"flex items-center gap-1.5\">\n                  <div className=\"w-3 h-3 bg-blue-500 rounded-full shadow-sm\"></div>\n                  <span className=\"text-xs font-medium text-slate-600\">Semanal</span>\n                </div>\n                <div className=\"flex items-center gap-1.5\">\n                  <div className=\"w-3 h-3 bg-orange-500 rounded-full shadow-sm\"></div>\n                  <span className=\"text-xs font-medium text-slate-600\">Turno</span>\n                </div>\n                <div className=\"flex items-center gap-1.5\">\n                  <div className=\"w-3 h-3 bg-purple-500 rounded-full shadow-sm\"></div>\n                  <span className=\"text-xs font-medium text-slate-600\">Mensal</span>\n                </div>\n                <div className=\"flex items-center gap-1.5\">\n                  <div className=\"w-3 h-3 bg-indigo-500 rounded-full shadow-sm\"></div>\n                  <span className=\"text-xs font-medium text-slate-600\">Trimestral</span>\n                </div>\n                <div className=\"flex items-center gap-1.5\">\n                  <div className=\"w-3 h-3 bg-violet-500 rounded-full shadow-sm\"></div>\n                  <span className=\"text-xs font-medium text-slate-600\">Semestral</span>\n                </div>\n                <div className=\"flex items-center gap-1.5\">\n                  <div className=\"w-3 h-3 bg-rose-500 rounded-full shadow-sm\"></div>\n                  <span className=\"text-xs font-medium text-slate-600\">Anual</span>\n                </div>\n              </div>\n\n              {/* Cabeçalho da semana moderno */}\n              <div className=\"grid grid-cols-7 gap-3 mb-3\">\n                {['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'].map(day => (\n                  <div key={day} className=\"py-2 text-center font-semibold text-xs uppercase tracking-wider text-slate-500\">\n                    {day}\n                  </div>\n                ))}\n              </div>\n\n              {/* Calendário moderno */}\n              <div className=\"grid grid-cols-7 gap-3\">\n                {generateMonthCalendar().map((week, weekIndex) => \n                  week.map((day, dayIndex) => {\n                    const dayActivities = day ? getActivitiesForDay(day) : [];\n                    const isToday = day && \n                      day === new Date().getDate() && \n                      currentDate.getMonth() === new Date().getMonth() && \n                      currentDate.getFullYear() === new Date().getFullYear();\n                    \n                    return (\n                      <div \n                        key={`${weekIndex}-${dayIndex}`} \n                        className={`rounded-xl p-3 min-h-28 transition-all duration-300 ${\n                          day \n                            ? `bg-white border ${\n                                isToday \n                                  ? 'border-orange-400 shadow-lg ring-2 ring-orange-200' \n                                  : 'border-slate-200 hover:border-orange-300'\n                              } hover:shadow-lg cursor-pointer transform hover:-translate-y-0.5`\n                            : 'bg-slate-50/50 border border-transparent pointer-events-none'\n                        }`}\n                        onClick={() => day && openDayDetails(day)}\n                        data-testid={day ? `calendar-day-${day}` : `calendar-empty-${weekIndex}-${dayIndex}`}\n                      >\n                        {day && (\n                          <>\n                            <div className=\"flex items-center justify-between mb-2\">\n                              <span className={`text-base font-bold ${\n                                isToday ? 'text-orange-600' : 'text-slate-700'\n                              }`}>\n                                {day}\n                              </span>\n                              {dayActivities.length > 0 && (\n                                <span className=\"flex items-center justify-center w-5 h-5 text-[10px] font-bold bg-gradient-to-br from-orange-500 to-orange-600 text-white rounded-full shadow-sm\">\n                                  {dayActivities.length}\n                                </span>\n                              )}\n                            </div>\n                            <div className=\"space-y-1.5\">\n                              {dayActivities.slice(0, 2).map((activity: any, idx: number) => {\n                                // Gradientes por frequência\n                                const frequencyGradient = \n                                  activity.frequency === 'diaria' ? 'bg-gradient-to-r from-green-500 to-emerald-600' :\n                                  activity.frequency === 'semanal' ? 'bg-gradient-to-r from-blue-500 to-cyan-600' :\n                                  activity.frequency === 'turno' ? 'bg-gradient-to-r from-orange-500 to-amber-600' :\n                                  activity.frequency === 'mensal' ? 'bg-gradient-to-r from-purple-500 to-fuchsia-600' :\n                                  activity.frequency === 'trimestral' ? 'bg-gradient-to-r from-indigo-500 to-blue-700' :\n                                  activity.frequency === 'semestral' ? 'bg-gradient-to-r from-violet-500 to-purple-700' :\n                                  activity.frequency === 'anual' ? 'bg-gradient-to-r from-rose-500 to-pink-600' :\n                                  'bg-gradient-to-r from-slate-500 to-slate-600';\n                                \n                                return (\n                                  <div\n                                    key={idx}\n                                    className={`text-[10px] px-2 py-1 rounded-md text-white ${frequencyGradient} truncate font-medium shadow-md`}\n                                    title={activity.name}\n                                  >\n                                    {activity.name.length > 15 ? activity.name.substring(0, 15) + '...' : activity.name}\n                                  </div>\n                                );\n                              })}\n                              {dayActivities.length > 2 && (\n                                <div \n                                  className=\"text-[10px] text-orange-600 bg-orange-50 px-2 py-1 rounded-md text-center cursor-pointer hover:bg-orange-100 font-medium transition-colors\"\n                                  onClick={(e) => {\n                                    e.stopPropagation();\n                                    openDayDetails(day);\n                                  }}\n                                >\n                                  +{dayActivities.length - 2} mais\n                                </div>\n                              )}\n                            </div>\n                          </>\n                        )}\n                      </div>\n                    );\n                  })\n                )}\n              </div>\n            </ModernCardContent>\n          </ModernCard>\n        ) : (\n          // List View\n          <ModernCard variant=\"default\">\n            <ModernCardHeader icon={<Calendar className=\"w-5 h-5\" />}>\n              Lista de Atividades de Manutenção\n            </ModernCardHeader>\n            <ModernCardContent>\n              {(activities as any[])?.length === 0 ? (\n                <div className=\"text-center py-12 text-gray-500\">\n                  <Wrench className=\"w-16 h-16 mx-auto mb-4 opacity-30\" />\n                  <p className=\"text-lg font-medium\">Nenhuma atividade cadastrada</p>\n                  <p className=\"text-sm mt-1\">Clique em \"Nova Atividade\" para começar</p>\n                </div>\n              ) : (\n                <div className=\"space-y-3\">\n                  {(activities as any[])?.map((activity: any) => (\n                    <Card key={activity.id} className=\"hover:shadow-md transition-shadow\">\n                      <CardContent className=\"p-4\">\n                        <div className=\"flex items-start justify-between\">\n                          <div className=\"flex-1\">\n                            <div className=\"flex items-center gap-2 mb-2\">\n                              <h3 className=\"font-bold text-lg\">{activity.name}</h3>\n                              {getTypeBadge(activity.type)}\n                              {getFrequencyBadge(activity.frequency)}\n                              {!activity.isActive && (\n                                <Badge variant=\"secondary\">Inativa</Badge>\n                              )}\n                            </div>\n                            {activity.description && (\n                              <p className=\"text-sm text-gray-600 mb-3\">{activity.description}</p>\n                            )}\n                            <div className=\"grid grid-cols-2 md:grid-cols-4 gap-3 text-sm mb-3\">\n                              <div className=\"flex items-center gap-2\">\n                                <MapPin className=\"w-4 h-4 text-gray-400\" />\n                                <span className=\"text-gray-600\">\n                                  {getZoneName(activity.zoneId)}\n                                </span>\n                              </div>\n                              <div className=\"flex items-center gap-2\">\n                                <User className=\"w-4 h-4 text-gray-400\" />\n                                <span className=\"text-gray-600\">\n                                  {getAssignedUserName(activity.assignedUserId || '')}\n                                </span>\n                              </div>\n                              <div className=\"flex items-center gap-2\">\n                                <Clock className=\"w-4 h-4 text-gray-400\" />\n                                <span className=\"text-gray-600\">SLA: {getSLAForActivity(activity)}</span>\n                              </div>\n                              <div className=\"flex items-center gap-2\">\n                                <Timer className=\"w-4 h-4 text-gray-400\" />\n                                <span className=\"text-gray-600\">\n                                  Próxima: {getNextExecutionDate(activity)}\n                                </span>\n                              </div>\n                            </div>\n                            {activity.equipmentIds && activity.equipmentIds.length > 0 && (\n                              <div className=\"flex items-center gap-2 flex-wrap\">\n                                <span className=\"text-xs text-gray-500\">Equipamentos:</span>\n                                {getEquipmentNames(activity.equipmentIds).map((name: string, idx: number) => (\n                                  <Badge key={idx} variant=\"outline\" className=\"text-xs\">\n                                    {name}\n                                  </Badge>\n                                ))}\n                              </div>\n                            )}\n                          </div>\n                          <div className=\"flex gap-2 ml-4\">\n                            <Button\n                              variant=\"ghost\"\n                              size=\"sm\"\n                              onClick={() => {\n                                setSelectedActivity(activity);\n                                setShowActivityDetailsModal(true);\n                              }}\n                              data-testid={`button-view-${activity.id}`}\n                            >\n                              <Eye className=\"w-4 h-4\" />\n                            </Button>\n                            <Button\n                              variant=\"ghost\"\n                              size=\"sm\"\n                              onClick={() => {\n                                setSelectedActivity(activity);\n                                setShowEditActivityModal(true);\n                              }}\n                              data-testid={`button-edit-${activity.id}`}\n                            >\n                              <Edit className=\"w-4 h-4\" />\n                            </Button>\n                            <Button\n                              variant=\"ghost\"\n                              size=\"sm\"\n                              onClick={() => handleDeleteActivity(activity)}\n                              data-testid={`button-delete-${activity.id}`}\n                            >\n                              <Trash2 className=\"w-4 h-4 text-destructive\" />\n                            </Button>\n                          </div>\n                        </div>\n                      </CardContent>\n                    </Card>\n                  ))}\n                </div>\n              )}\n            </ModernCardContent>\n          </ModernCard>\n        )}\n\n        {/* Modal de Detalhes do Dia */}\n        <Dialog open={showDayDetailsModal} onOpenChange={setShowDayDetailsModal}>\n          <DialogContent className=\"max-w-3xl max-h-[85vh] overflow-y-auto\">\n            <DialogHeader>\n              <DialogTitle className=\"text-xl font-bold flex items-center gap-2\">\n                <Calendar className=\"w-5 h-5 text-orange-600\" />\n                Atividades do dia {selectedDay && selectedDay.toString().padStart(2, '0')}\n              </DialogTitle>\n              <DialogDescription className=\"text-base\">\n                {getSelectedDateFormatted()}\n              </DialogDescription>\n            </DialogHeader>\n\n            <div className=\"space-y-3\">\n              {selectedActivities.length > 0 ? (\n                selectedActivities.map((activity: any, index: number) => (\n                  <Card \n                    key={activity.id} \n                    className={`hover:shadow-md transition-all duration-200 ${\n                      selectedForDeletion.includes(activity.id) ? 'ring-2 ring-destructive' : ''\n                    }`}\n                  >\n                    <CardContent className=\"p-4\">\n                      <div className=\"flex items-start justify-between gap-4\">\n                        <div className=\"flex items-start gap-3 flex-1\">\n                          <input\n                            type=\"checkbox\"\n                            checked={selectedForDeletion.includes(activity.id)}\n                            onChange={(e) => {\n                              if (e.target.checked) {\n                                setSelectedForDeletion(prev => [...prev, activity.id]);\n                              } else {\n                                setSelectedForDeletion(prev => prev.filter(id => id !== activity.id));\n                              }\n                            }}\n                            className=\"mt-1.5\"\n                            data-testid={`checkbox-activity-${activity.id}`}\n                          />\n                          <div className=\"flex-1\">\n                            <div className=\"flex items-center gap-2 flex-wrap mb-2\">\n                              <h4 className=\"font-bold text-base\">{activity.name}</h4>\n                              {getTypeBadge(activity.type)}\n                              {getFrequencyBadge(activity.frequency)}\n                            </div>\n                            {activity.description && (\n                              <p className=\"text-sm text-gray-600 mb-2\">{activity.description}</p>\n                            )}\n                            <div className=\"grid grid-cols-2 gap-2 text-sm text-gray-500 mb-2\">\n                              <div className=\"flex items-center gap-1\">\n                                <MapPin className=\"w-3 h-3\" />\n                                <span>{getZoneName(activity.zoneId)}</span>\n                              </div>\n                              <div className=\"flex items-center gap-1\">\n                                <User className=\"w-3 h-3\" />\n                                <span>{getAssignedUserName(activity.assignedUserId || '')}</span>\n                              </div>\n                              <div className=\"flex items-center gap-1\">\n                                <Clock className=\"w-3 h-3\" />\n                                <span>SLA: {getSLAForActivity(activity)}</span>\n                              </div>\n                              {activity.startTime && (\n                                <div className=\"flex items-center gap-1\">\n                                  <Timer className=\"w-3 h-3\" />\n                                  <span>{activity.startTime}</span>\n                                </div>\n                              )}\n                            </div>\n                            {activity.equipmentIds && activity.equipmentIds.length > 0 && (\n                              <div className=\"flex items-center gap-1 flex-wrap\">\n                                <span className=\"text-xs text-gray-500\">Equipamentos:</span>\n                                {getEquipmentNames(activity.equipmentIds).map((name: string, idx: number) => (\n                                  <Badge key={idx} variant=\"outline\" className=\"text-xs\">\n                                    {name}\n                                  </Badge>\n                                ))}\n                              </div>\n                            )}\n                          </div>\n                        </div>\n                        <div className=\"flex gap-1\">\n                          <Button\n                            variant=\"ghost\"\n                            size=\"sm\"\n                            onClick={() => {\n                              setSelectedActivity(activity);\n                              setShowDayDetailsModal(false);\n                              setShowActivityDetailsModal(true);\n                            }}\n                            title=\"Ver detalhes\"\n                            data-testid={`button-view-day-activity-${activity.id}`}\n                          >\n                            <Eye className=\"w-4 h-4\" />\n                          </Button>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"sm\"\n                            onClick={() => {\n                              setSelectedActivity(activity);\n                              setShowDayDetailsModal(false);\n                              setShowEditActivityModal(true);\n                            }}\n                            title=\"Editar\"\n                            data-testid={`button-edit-day-activity-${activity.id}`}\n                          >\n                            <Edit className=\"w-4 h-4\" />\n                          </Button>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"sm\"\n                            onClick={() => handleDeleteActivity(activity)}\n                            title=\"Deletar\"\n                            data-testid={`button-delete-day-activity-${activity.id}`}\n                          >\n                            <Trash2 className=\"w-4 h-4 text-destructive\" />\n                          </Button>\n                        </div>\n                      </div>\n                    </CardContent>\n                  </Card>\n                ))\n              ) : (\n                <div className=\"text-center py-12 text-gray-500\">\n                  <Calendar className=\"w-16 h-16 mx-auto mb-4 opacity-30\" />\n                  <p className=\"text-lg font-medium mb-2\">\n                    Este dia não possui atividades de manutenção agendadas.\n                  </p>\n                  <Button \n                    onClick={() => {\n                      setShowDayDetailsModal(false);\n                      setShowCreateModal(true);\n                    }}\n                    data-testid=\"button-create-activity-for-day\"\n                    size=\"sm\"\n                  >\n                    <Plus className=\"w-4 h-4 mr-2\" />\n                    Criar Atividade\n                  </Button>\n                </div>\n              )}\n            </div>\n\n            <div className=\"flex items-center justify-between mt-4 pt-3 border-t text-sm\">\n              <div className=\"text-gray-500\">\n                {selectedActivities.length > 0 && (\n                  `Total: ${selectedActivities.reduce((acc, activity) => acc + (activity.estimatedDuration || 30), 0)}min`\n                )}\n              </div>\n              <div className=\"flex gap-2 flex-wrap\">\n                {selectedActivities.length > 0 && (\n                  <>\n                    <Button \n                      variant=\"destructive\" \n                      size=\"sm\"\n                      onClick={async () => {\n                        if (window.confirm(`Tem certeza que deseja deletar TODAS as ${selectedActivities.length} atividade(s) deste dia?`)) {\n                          try {\n                            const allIds = selectedActivities.map(a => a.id);\n                            await Promise.all(\n                              allIds.map(id => apiRequest('DELETE', `/api/maintenance-activities/${id}`))\n                            );\n                            toast({\n                              title: \"Atividades Deletadas\",\n                              description: `${selectedActivities.length} atividade(s) foram removidas com sucesso!`,\n                            });\n                            queryClient.invalidateQueries({ queryKey: [\"/api/customers\", activeClientId, \"maintenance-activities\"] });\n                            setSelectedForDeletion([]);\n                            setShowDayDetailsModal(false);\n                          } catch (error) {\n                            toast({\n                              title: \"Erro ao Deletar\",\n                              description: \"Não foi possível deletar as atividades\",\n                              variant: \"destructive\"\n                            });\n                          }\n                        }\n                      }}\n                      data-testid=\"button-delete-all-day\"\n                    >\n                      <Trash2 className=\"w-4 h-4 mr-1\" />\n                      Deletar Todas ({selectedActivities.length})\n                    </Button>\n                    \n                    {selectedForDeletion.length > 0 && (\n                      <Button \n                        variant=\"destructive\" \n                        size=\"sm\"\n                        onClick={async () => {\n                          if (window.confirm(`Tem certeza que deseja deletar ${selectedForDeletion.length} atividade(s) selecionada(s)?`)) {\n                            try {\n                              await Promise.all(\n                                selectedForDeletion.map(id => apiRequest('DELETE', `/api/maintenance-activities/${id}`))\n                              );\n                              toast({\n                                title: \"Atividades Deletadas\",\n                                description: `${selectedForDeletion.length} atividade(s) selecionada(s) foram removidas com sucesso!`,\n                              });\n                              queryClient.invalidateQueries({ queryKey: [\"/api/customers\", activeClientId, \"maintenance-activities\"] });\n                              setSelectedForDeletion([]);\n                            } catch (error) {\n                              toast({\n                                title: \"Erro ao Deletar\",\n                                description: \"Não foi possível deletar as atividades selecionadas\",\n                                variant: \"destructive\"\n                              });\n                            }\n                          }\n                        }}\n                        data-testid=\"button-delete-selected\"\n                      >\n                        <Trash2 className=\"w-4 h-4 mr-1\" />\n                        Deletar Selecionadas ({selectedForDeletion.length})\n                      </Button>\n                    )}\n                  </>\n                )}\n                \n                <Button variant=\"outline\" size=\"sm\" onClick={() => setShowDayDetailsModal(false)}>\n                  Fechar\n                </Button>\n                \n                {selectedActivities.length > 0 && (\n                  <Button \n                    size=\"sm\"\n                    onClick={() => {\n                      setShowDayDetailsModal(false);\n                      setShowCreateModal(true);\n                    }}\n                    data-testid=\"button-add-more-activities\"\n                  >\n                    <Plus className=\"w-4 h-4 mr-1\" />\n                    Nova Atividade\n                  </Button>\n                )}\n              </div>\n            </div>\n          </DialogContent>\n        </Dialog>\n\n        {/* Modal de Criação de Atividade */}\n        {showCreateModal && (\n          <CreateMaintenanceActivityModal\n            activeClientId={activeClientId}\n            onClose={() => setShowCreateModal(false)}\n            onSuccess={() => {\n              setShowCreateModal(false);\n              queryClient.invalidateQueries({ queryKey: [\"/api/customers\", activeClientId, \"maintenance-activities\"] });\n            }}\n          />\n        )}\n\n        {/* Modal de Detalhes da Atividade */}\n        <Dialog open={showActivityDetailsModal} onOpenChange={setShowActivityDetailsModal}>\n          <DialogContent className=\"max-w-md max-h-[90vh] overflow-y-auto\">\n            <DialogHeader>\n              <DialogTitle className=\"text-lg font-semibold\">Detalhes da Atividade</DialogTitle>\n              <DialogDescription>\n                Informações completas sobre a atividade selecionada.\n              </DialogDescription>\n            </DialogHeader>\n            {selectedActivity && (\n              <div className=\"space-y-4\">\n                <div>\n                  <h3 className=\"font-semibold text-gray-900\">{selectedActivity.name}</h3>\n                  {selectedActivity.description && (\n                    <p className=\"text-sm text-gray-600 mt-1\">{selectedActivity.description}</p>\n                  )}\n                </div>\n                \n                <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                  <div>\n                    <span className=\"font-medium text-gray-700\">Tipo:</span>\n                    <p className=\"text-gray-600 mt-1\">{getTypeBadge(selectedActivity.type)}</p>\n                  </div>\n                  <div>\n                    <span className=\"font-medium text-gray-700\">Frequência:</span>\n                    <p className=\"text-gray-600 mt-1\">{getFrequencyBadge(selectedActivity.frequency)}</p>\n                  </div>\n                  <div>\n                    <span className=\"font-medium text-gray-700\">Status:</span>\n                    <p className=\"text-gray-600\">{selectedActivity.isActive ? 'Ativa' : 'Inativa'}</p>\n                  </div>\n                  <div>\n                    <span className=\"font-medium text-gray-700\">Local:</span>\n                    <p className=\"text-gray-600\">{getZoneName(selectedActivity.zoneId)}</p>\n                  </div>\n                  <div>\n                    <span className=\"font-medium text-gray-700\">SLA:</span>\n                    <p className=\"text-gray-600\">{getSLAForActivity(selectedActivity)}</p>\n                  </div>\n                  <div className=\"col-span-2\">\n                    <span className=\"font-medium text-gray-700\">Responsável:</span>\n                    <p className=\"text-gray-600\">{getAssignedUserName(selectedActivity.assignedUserId || '')}</p>\n                  </div>\n                </div>\n              </div>\n            )}\n          </DialogContent>\n        </Dialog>\n\n        {/* Modal de Edição da Atividade */}\n        <Dialog open={showEditActivityModal} onOpenChange={setShowEditActivityModal}>\n          <DialogContent className=\"max-w-md\">\n            <DialogHeader>\n              <DialogTitle className=\"text-lg font-semibold\">Editar Atividade</DialogTitle>\n              <DialogDescription>\n                Modifique as informações da atividade abaixo.\n              </DialogDescription>\n            </DialogHeader>\n            {selectedActivity && (\n              <div className=\"space-y-4\">\n                <div>\n                  <Label htmlFor=\"edit-name\">Nome da Atividade</Label>\n                  <Input \n                    id=\"edit-name\"\n                    defaultValue={selectedActivity.name}\n                    className=\"mt-1\"\n                  />\n                </div>\n                \n                <div>\n                  <Label htmlFor=\"edit-description\">Descrição</Label>\n                  <Textarea \n                    id=\"edit-description\"\n                    defaultValue={selectedActivity.description || ''}\n                    className=\"mt-1\"\n                  />\n                </div>\n\n                <div>\n                  <Label htmlFor=\"edit-type\">Tipo de Manutenção</Label>\n                  <Select defaultValue={selectedActivity.type}>\n                    <SelectTrigger className=\"mt-1\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"preventiva\">Preventiva</SelectItem>\n                      <SelectItem value=\"preditiva\">Preditiva</SelectItem>\n                      <SelectItem value=\"corretiva\">Corretiva</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n                \n                <div>\n                  <Label htmlFor=\"edit-frequency\">Frequência</Label>\n                  <Select defaultValue={selectedActivity.frequency}>\n                    <SelectTrigger className=\"mt-1\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"diaria\">Diária</SelectItem>\n                      <SelectItem value=\"semanal\">Semanal</SelectItem>\n                      <SelectItem value=\"mensal\">Mensal</SelectItem>\n                      <SelectItem value=\"trimestral\">Trimestral</SelectItem>\n                      <SelectItem value=\"semestral\">Semestral</SelectItem>\n                      <SelectItem value=\"anual\">Anual</SelectItem>\n                      <SelectItem value=\"turno\">Por Turno</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n                \n                <div className=\"flex justify-end gap-2 pt-4\">\n                  <Button \n                    type=\"button\" \n                    variant=\"outline\" \n                    onClick={() => setShowEditActivityModal(false)}\n                  >\n                    Cancelar\n                  </Button>\n                  <Button \n                    type=\"button\"\n                    onClick={() => {\n                      toast({\n                        title: \"Em Desenvolvimento\",\n                        description: \"Funcionalidade de edição será implementada em breve\",\n                      });\n                      setShowEditActivityModal(false);\n                    }}\n                  >\n                    Salvar Alterações\n                  </Button>\n                </div>\n              </div>\n            )}\n          </DialogContent>\n        </Dialog>\n      </div>\n    </>\n  );\n}\n\n// MultiSelect Component\nfunction MultiSelect({\n  label,\n  options,\n  value,\n  onChange,\n  placeholder,\n  disabled,\n  required,\n  \"data-testid\": dataTestId,\n}: {\n  label: string;\n  options: { value: string; label: string }[];\n  value: string[];\n  onChange: (vals: string[]) => void;\n  placeholder?: string;\n  disabled?: boolean;\n  required?: boolean;\n  \"data-testid\"?: string;\n}) {\n  const [open, setOpen] = useState(false);\n  \n  const toggleOption = (optionValue: string) => {\n    if (value.includes(optionValue)) {\n      onChange(value.filter(v => v !== optionValue));\n    } else {\n      onChange([...value, optionValue]);\n    }\n  };\n\n  const selectedLabels = options\n    .filter(opt => value.includes(opt.value))\n    .map(opt => opt.label)\n    .join(\", \");\n\n  return (\n    <div className=\"space-y-2\">\n      <Label>{label} {required && \"*\"}</Label>\n      <Popover open={open} onOpenChange={setOpen}>\n        <PopoverTrigger asChild>\n          <Button\n            variant=\"outline\"\n            role=\"combobox\"\n            aria-expanded={open}\n            className=\"w-full justify-between\"\n            disabled={disabled}\n            data-testid={dataTestId}\n          >\n            <span className=\"truncate\">\n              {selectedLabels || placeholder || \"Selecione...\"}\n            </span>\n            <ChevronDown className=\"ml-2 h-4 w-4 shrink-0 opacity-50\" />\n          </Button>\n        </PopoverTrigger>\n        <PopoverContent className=\"w-full p-0\" align=\"start\">\n          <div className=\"max-h-64 overflow-auto p-2\">\n            {options.length === 0 ? (\n              <div className=\"p-2 text-sm text-muted-foreground\">\n                {placeholder || \"Sem opções\"}\n              </div>\n            ) : (\n              <div className=\"space-y-1\">\n                {options.map((option) => (\n                  <div\n                    key={option.value}\n                    className=\"flex items-center space-x-2 p-2 hover:bg-accent rounded-sm cursor-pointer\"\n                    onClick={() => toggleOption(option.value)}\n                  >\n                    <Checkbox\n                      checked={value.includes(option.value)}\n                      onCheckedChange={() => toggleOption(option.value)}\n                    />\n                    <label className=\"flex-1 cursor-pointer text-sm\">\n                      {option.label}\n                    </label>\n                  </div>\n                ))}\n              </div>\n            )}\n          </div>\n        </PopoverContent>\n      </Popover>\n      <div className=\"text-xs text-slate-500\">\n        {value?.length ? `${value.length} selecionado(s)` : \"Nenhum selecionado\"}\n      </div>\n    </div>\n  );\n}\n\n// Componente de Modal para Criação de Atividade de Manutenção\ninterface CreateMaintenanceActivityModalProps {\n  activeClientId: string;\n  onClose: () => void;\n  onSuccess: () => void;\n}\n\nfunction CreateMaintenanceActivityModal({ activeClientId, onClose, onSuccess }: CreateMaintenanceActivityModalProps) {\n  const { currentModule } = useModule();\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  \n  const [formData, setFormData] = useState({\n    name: \"\",\n    description: \"\",\n    type: \"preventiva\",\n    frequency: \"mensal\",\n    startDate: \"\",\n    frequencyConfig: {\n      weekDays: [] as string[],\n      monthDay: 1,\n      turnShifts: [] as string[],\n      timesPerDay: 1\n    },\n    equipmentIds: [] as string[],\n    siteIds: [] as string[],\n    zoneIds: [] as string[],\n    checklistTemplateId: \"\",\n    startTime: \"\",\n    endTime: \"\",\n    isActive: true\n  });\n\n  const { data: equipment } = useQuery({\n    queryKey: [\"/api/customers\", activeClientId, \"equipment\"],\n    enabled: !!activeClientId,\n  });\n\n  const { data: sites } = useQuery({\n    queryKey: [\"/api/customers\", activeClientId, \"sites\", { module: currentModule }],\n    enabled: !!activeClientId,\n  });\n\n  // Fetch zones based on selected sites\n  const { data: zones = [] } = useQuery({\n    queryKey: [\"/api/zones\", (formData.siteIds || []).join(\",\"), { module: currentModule }],\n    enabled: Array.isArray(formData.siteIds) && formData.siteIds.length > 0,\n    queryFn: async () => {\n      const ids = formData.siteIds;\n      if (!ids || ids.length === 0) return [];\n      const qs = new URLSearchParams();\n      qs.set(\"siteIds\", ids.join(\",\"));\n      qs.set(\"module\", currentModule);\n      const res = await fetch(`/api/zones?${qs.toString()}`);\n      if (!res.ok) throw new Error('Failed to fetch zones');\n      return res.json();\n    },\n  });\n\n  const { data: checklistTemplates } = useQuery({\n    queryKey: [\"/api/customers\", activeClientId, \"maintenance-checklist-templates\"],\n    enabled: !!activeClientId,\n  });\n\n  // Filtrar zonas baseado nos sites selecionados\n  const filteredZones = useMemo(() => {\n    if (!formData.siteIds || formData.siteIds.length === 0 || !zones) return [];\n    return (zones as any[]).filter((zone: any) => formData.siteIds.includes(zone.siteId));\n  }, [zones, formData.siteIds]);\n\n  // Filtrar checklists baseado nos equipamentos selecionados (interseção)\n  // Só mostra checklists que estão vinculados a TODOS os equipamentos selecionados\n  const availableChecklistTemplates = useMemo(() => {\n    // Se nenhum equipamento selecionado, não mostrar checklists\n    if (!formData.equipmentIds || formData.equipmentIds.length === 0) {\n      return [];\n    }\n    \n    if (!checklistTemplates || !Array.isArray(checklistTemplates)) {\n      return [];\n    }\n\n    // Filtrar checklists que contêm TODOS os equipamentos selecionados\n    return (checklistTemplates as any[]).filter((template: any) => {\n      if (!template.equipmentIds || !Array.isArray(template.equipmentIds)) {\n        return false;\n      }\n      \n      // Verifica se o template contém TODOS os equipamentos selecionados\n      return formData.equipmentIds.every((equipId: string) => \n        template.equipmentIds.includes(equipId)\n      );\n    });\n  }, [checklistTemplates, formData.equipmentIds]);\n\n  const handleChange = (field: string, value: any) => {\n    setFormData(prev => {\n      const newData = { ...prev, [field]: value };\n      \n      // Limpar checklist quando equipamentos mudam (será necessário reselecionar)\n      if (field === 'equipmentIds') {\n        newData.checklistTemplateId = \"\";\n      }\n      \n      // Limpar zonas quando sites mudam\n      if (field === 'siteIds') {\n        newData.zoneIds = [];\n      }\n      \n      // Reset frequency config quando muda frequência\n      if (field === 'frequency') {\n        newData.frequencyConfig = {\n          weekDays: [],\n          monthDay: 1,\n          turnShifts: [],\n          timesPerDay: 1\n        };\n      }\n      \n      return newData;\n    });\n  };\n\n  const handleFrequencyConfigChange = (configField: string, value: any) => {\n    setFormData(prev => ({\n      ...prev,\n      frequencyConfig: {\n        ...prev.frequencyConfig,\n        [configField]: value\n      }\n    }));\n  };\n\n  const createActivityMutation = useMutation({\n    mutationFn: async (data: any) => {\n      const site = (sites as any[])?.find(s => data.siteIds?.includes(s.id));\n      const companyId = site?.companyId || \"company-opus-default\";\n      const submitData = {\n        ...data,\n        companyId,\n        activeClientId,\n        checklistTemplateId: data.checklistTemplateId || null,\n        equipmentIds: data.equipmentIds || [],\n      };\n      return { activity: await apiRequest(\"POST\", \"/api/maintenance-activities\", submitData), companyId };\n    },\n    onSuccess: async (result: any) => {\n      toast({ \n        title: \"Plano de Manutenção Criado!\", \n        description: \"As ordens de serviço serão geradas automaticamente no final de cada mês.\" \n      });\n      \n      queryClient.invalidateQueries({ \n        queryKey: [\"/api/customers\", activeClientId, \"maintenance-activities\"] \n      });\n      \n      onSuccess();\n    },\n    onError: () => {\n      toast({ \n        title: \"Erro ao criar atividade de manutenção\", \n        variant: \"destructive\" \n      });\n    },\n  });\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    // Validate required fields\n    if (!formData.name || !formData.startDate) {\n      toast({\n        title: \"Campos obrigatórios\",\n        description: \"Preencha todos os campos obrigatórios\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    // Validate sites and zones\n    if (!formData.siteIds || formData.siteIds.length === 0) {\n      toast({\n        title: \"Locais obrigatórios\",\n        description: \"Selecione ao menos um local\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    if (!formData.zoneIds || formData.zoneIds.length === 0) {\n      toast({\n        title: \"Zonas obrigatórias\",\n        description: \"Selecione ao menos uma zona\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    // Validate checklist\n    if (!formData.checklistTemplateId) {\n      toast({\n        title: \"Checklist obrigatório\",\n        description: \"Selecione um checklist para o plano de manutenção\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    // Validate equipment selection\n    if (!formData.equipmentIds || formData.equipmentIds.length === 0) {\n      toast({\n        title: \"Equipamentos obrigatórios\",\n        description: \"Selecione ao menos um equipamento\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    // Validar configuração de frequência\n    if (formData.frequency === \"diaria\" && formData.frequencyConfig.timesPerDay < 1) {\n      toast({\n        title: \"Frequência diária inválida\",\n        description: \"Informe quantas vezes por dia a atividade deve ser realizada\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    if (formData.frequency === \"semanal\" && formData.frequencyConfig.weekDays.length === 0) {\n      toast({\n        title: \"Dias da semana obrigatórios\",\n        description: \"Selecione pelo menos um dia da semana\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    if (formData.frequency === \"turno\" && formData.frequencyConfig.turnShifts.length === 0) {\n      toast({\n        title: \"Turnos obrigatórios\", \n        description: \"Selecione pelo menos um turno\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    createActivityMutation.mutate(formData);\n  };\n\n  return (\n    <Dialog open={true} onOpenChange={onClose}>\n      <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\" data-testid=\"create-activity-modal\">\n        <DialogHeader>\n          <DialogTitle className=\"text-xl font-bold\">Nova Atividade de Manutenção</DialogTitle>\n          <DialogDescription>\n            Preencha as informações para criar uma nova atividade de manutenção programada\n          </DialogDescription>\n        </DialogHeader>\n        \n        <form onSubmit={handleSubmit} className=\"space-y-6\">\n          {/* Informações Básicas */}\n          <div className=\"space-y-4 p-4 bg-orange-50 rounded-lg border border-orange-200\">\n            <h4 className=\"font-semibold text-orange-900 flex items-center gap-2\">\n              <Settings className=\"w-4 h-4\" />\n              Informações Básicas\n            </h4>\n            \n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"name\">Nome da Atividade *</Label>\n                <Input\n                  id=\"name\"\n                  placeholder=\"Ex: Manutenção preventiva HVAC\"\n                  value={formData.name}\n                  onChange={(e) => handleChange(\"name\", e.target.value)}\n                  data-testid=\"input-name\"\n                  required\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"type\">Tipo de Manutenção *</Label>\n                <Select value={formData.type} onValueChange={(value) => handleChange(\"type\", value)}>\n                  <SelectTrigger data-testid=\"select-type\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"preventiva\">Preventiva</SelectItem>\n                    <SelectItem value=\"preditiva\">Preditiva</SelectItem>\n                    <SelectItem value=\"corretiva\">Corretiva</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"frequency\">Frequência</Label>\n                <Select value={formData.frequency} onValueChange={(value) => handleChange(\"frequency\", value)}>\n                  <SelectTrigger data-testid=\"select-frequency\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"diaria\">Diária</SelectItem>\n                    <SelectItem value=\"semanal\">Semanal</SelectItem>\n                    <SelectItem value=\"mensal\">Mensal</SelectItem>\n                    <SelectItem value=\"trimestral\">Trimestral</SelectItem>\n                    <SelectItem value=\"semestral\">Semestral</SelectItem>\n                    <SelectItem value=\"anual\">Anual</SelectItem>\n                    <SelectItem value=\"turno\">Por Turno</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"startDate\">Data de Início *</Label>\n                <Input\n                  id=\"startDate\"\n                  type=\"date\"\n                  value={formData.startDate}\n                  onChange={(e) => handleChange(\"startDate\", e.target.value)}\n                  data-testid=\"input-start-date\"\n                  required\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"startTime\">Horário de Início (opcional)</Label>\n                <Input\n                  id=\"startTime\"\n                  type=\"time\"\n                  placeholder=\"Ex: 08:00\"\n                  value={formData.startTime}\n                  onChange={(e) => handleChange(\"startTime\", e.target.value)}\n                  data-testid=\"input-start-time\"\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"endTime\">Horário de Fim (opcional)</Label>\n                <Input\n                  id=\"endTime\"\n                  type=\"time\"\n                  placeholder=\"Ex: 18:00\"\n                  value={formData.endTime}\n                  onChange={(e) => handleChange(\"endTime\", e.target.value)}\n                  data-testid=\"input-end-time\"\n                />\n              </div>\n\n              <div className=\"md:col-span-2 space-y-2\">\n                <Label htmlFor=\"description\">Descrição</Label>\n                <Textarea\n                  id=\"description\"\n                  placeholder=\"Descreva detalhes da atividade de manutenção...\"\n                  value={formData.description}\n                  onChange={(e) => handleChange(\"description\", e.target.value)}\n                  data-testid=\"textarea-description\"\n                  rows={3}\n                />\n              </div>\n\n              {/* Configuração de Frequência */}\n              {formData.frequency === \"diaria\" && (\n                <div key=\"daily-config\" className=\"space-y-2\">\n                  <Label htmlFor=\"timesPerDay\">Quantas vezes por dia? *</Label>\n                  <Select \n                    key=\"times-per-day-select\"\n                    value={formData.frequencyConfig.timesPerDay.toString()} \n                    onValueChange={(value) => handleFrequencyConfigChange(\"timesPerDay\", parseInt(value))}\n                  >\n                    <SelectTrigger data-testid=\"select-times-per-day\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"1\">1 vez por dia</SelectItem>\n                      <SelectItem value=\"2\">2 vezes por dia</SelectItem>\n                      <SelectItem value=\"3\">3 vezes por dia</SelectItem>\n                      <SelectItem value=\"4\">4 vezes por dia</SelectItem>\n                      <SelectItem value=\"5\">5 vezes por dia</SelectItem>\n                      <SelectItem value=\"6\">6 vezes por dia</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n              )}\n\n              {formData.frequency === \"semanal\" && (\n                <div key=\"weekly-config\" className=\"md:col-span-2 space-y-2\">\n                  <Label>Dias da Semana *</Label>\n                  <div className=\"grid grid-cols-4 gap-2\">\n                    {[\n                      { value: 'domingo', label: 'Domingo' },\n                      { value: 'segunda', label: 'Segunda' },\n                      { value: 'terca', label: 'Terça' },\n                      { value: 'quarta', label: 'Quarta' },\n                      { value: 'quinta', label: 'Quinta' },\n                      { value: 'sexta', label: 'Sexta' },\n                      { value: 'sabado', label: 'Sábado' }\n                    ].map(day => (\n                      <label key={day.value} className=\"flex items-center gap-2 cursor-pointer\">\n                        <input\n                          type=\"checkbox\"\n                          checked={formData.frequencyConfig.weekDays.includes(day.value)}\n                          onChange={(e) => {\n                            const currentDays = formData.frequencyConfig.weekDays;\n                            if (e.target.checked) {\n                              handleFrequencyConfigChange(\"weekDays\", [...currentDays, day.value]);\n                            } else {\n                              handleFrequencyConfigChange(\"weekDays\", currentDays.filter(d => d !== day.value));\n                            }\n                          }}\n                          className=\"rounded\"\n                          data-testid={`checkbox-weekday-${day.value}`}\n                        />\n                        <span className=\"text-sm\">{day.label}</span>\n                      </label>\n                    ))}\n                  </div>\n                </div>\n              )}\n\n              {formData.frequency === \"mensal\" && (\n                <div key=\"monthly-config\" className=\"space-y-2\">\n                  <Label htmlFor=\"monthDay\">Dia do Mês *</Label>\n                  <Select \n                    value={formData.frequencyConfig.monthDay.toString()} \n                    onValueChange={(value) => handleFrequencyConfigChange(\"monthDay\", parseInt(value))}\n                  >\n                    <SelectTrigger data-testid=\"select-month-day\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {Array.from({ length: 31 }, (_, i) => i + 1).map(day => (\n                        <SelectItem key={day} value={day.toString()}>\n                          Dia {day}\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n              )}\n\n              {formData.frequency === \"turno\" && (\n                <div key=\"shift-config\" className=\"md:col-span-2 space-y-2\">\n                  <Label>Turnos *</Label>\n                  <div className=\"grid grid-cols-3 gap-2\">\n                    {[\n                      { value: 'manha', label: 'Manhã' },\n                      { value: 'tarde', label: 'Tarde' },\n                      { value: 'noite', label: 'Noite' }\n                    ].map(shift => (\n                      <label key={shift.value} className=\"flex items-center gap-2 cursor-pointer\">\n                        <input\n                          type=\"checkbox\"\n                          checked={formData.frequencyConfig.turnShifts.includes(shift.value)}\n                          onChange={(e) => {\n                            const currentShifts = formData.frequencyConfig.turnShifts;\n                            if (e.target.checked) {\n                              handleFrequencyConfigChange(\"turnShifts\", [...currentShifts, shift.value]);\n                            } else {\n                              handleFrequencyConfigChange(\"turnShifts\", currentShifts.filter(s => s !== shift.value));\n                            }\n                          }}\n                          className=\"rounded\"\n                          data-testid={`checkbox-shift-${shift.value}`}\n                        />\n                        <span className=\"text-sm\">{shift.label}</span>\n                      </label>\n                    ))}\n                  </div>\n                </div>\n              )}\n            </div>\n          </div>\n\n          {/* Local e Equipamento */}\n          <div className=\"space-y-4 p-4 bg-blue-50 rounded-lg border border-blue-200\">\n            <h4 className=\"font-semibold text-blue-900 flex items-center gap-2\">\n              <MapPin className=\"w-4 h-4\" />\n              Local e Equipamento\n            </h4>\n            \n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <MultiSelect\n                  label=\"Local\"\n                  options={(sites as any[])?.map((site: any) => ({\n                    value: site.id,\n                    label: site.name\n                  })) || []}\n                  value={formData.siteIds}\n                  onChange={(value) => handleChange(\"siteIds\", value)}\n                  placeholder=\"Selecione um ou mais locais\"\n                  required\n                  data-testid=\"multiselect-sites\"\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <MultiSelect\n                  label=\"Zona\"\n                  options={filteredZones?.map((zone: any) => ({\n                    value: zone.id,\n                    label: zone.name\n                  })) || []}\n                  value={formData.zoneIds}\n                  onChange={(value) => handleChange(\"zoneIds\", value)}\n                  placeholder={formData.siteIds.length > 0 ? \"Selecione uma ou mais zonas\" : \"Selecione ao menos um local\"}\n                  disabled={!formData.siteIds || formData.siteIds.length === 0}\n                  required\n                  data-testid=\"multiselect-zones\"\n                />\n              </div>\n\n              <div className=\"md:col-span-2 space-y-2\">\n                <MultiSelect\n                  label=\"Equipamentos\"\n                  options={(equipment as any[])?.map((equip: any) => ({\n                    value: equip.id,\n                    label: equip.name\n                  })) || []}\n                  value={formData.equipmentIds}\n                  onChange={(value) => handleChange(\"equipmentIds\", value)}\n                  placeholder=\"Selecione um ou mais equipamentos\"\n                  required\n                  data-testid=\"multiselect-equipment\"\n                />\n              </div>\n\n              <div className=\"md:col-span-2 space-y-2\">\n                <Label htmlFor=\"checklist\">Checklist (obrigatório)</Label>\n                <Select \n                  value={formData.checklistTemplateId} \n                  onValueChange={(value) => handleChange(\"checklistTemplateId\", value)}\n                  disabled={!formData.equipmentIds || formData.equipmentIds.length === 0}\n                >\n                  <SelectTrigger data-testid=\"select-checklist\">\n                    <SelectValue \n                      placeholder={\n                        !formData.equipmentIds || formData.equipmentIds.length === 0\n                          ? \"Selecione equipamentos primeiro\"\n                          : availableChecklistTemplates.length === 0\n                          ? \"Nenhum checklist disponível para os equipamentos selecionados\"\n                          : \"Selecione um checklist\"\n                      } \n                    />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {availableChecklistTemplates.map((template: any) => (\n                      <SelectItem key={template.id} value={template.id}>\n                        {template.name}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n          </div>\n\n          {/* Botões de Ação */}\n          <div className=\"flex justify-end gap-3 pt-4 border-t\">\n            <Button \n              type=\"button\" \n              variant=\"outline\" \n              onClick={onClose}\n              data-testid=\"button-cancel\"\n            >\n              Cancelar\n            </Button>\n            <Button \n              type=\"submit\" \n              disabled={createActivityMutation.isPending}\n              data-testid=\"button-submit\"\n            >\n              {createActivityMutation.isPending ? (\n                <>\n                  <Clock className=\"w-4 h-4 mr-2 animate-spin\" />\n                  Criando...\n                </>\n              ) : (\n                <>\n                  <Save className=\"w-4 h-4 mr-2\" />\n                  Criar Atividade\n                </>\n              )}\n            </Button>\n          </div>\n        </form>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","size_bytes":78995},"ARCHITECTURE.md":{"content":"# OPUS - Arquitetura do Sistema\n\n## Visão Geral\n\nOPUS é uma plataforma modular de gestão de facilities projetada para otimizar operações e aumentar a eficiência. O sistema oferece dois módulos principais: **OPUS Clean** para gestão de limpeza e **OPUS Manutenção** para gestão de manutenção, cada um com isolamento completo de dados e interface personalizada.\n\n### Características Principais\n\n- **Arquitetura Modular**: Dois módulos operacionais independentes com dados completamente isolados\n- **Multi-Tenancy Hierárquico**: Suporte a múltiplas empresas, clientes e locais\n- **Interface Web + Mobile**: Administração web completa e aplicativos móveis para operadores\n- **Sistema de QR Codes**: Gestão de tarefas via QR codes e solicitações públicas de serviço\n- **Analytics em Tempo Real**: Dashboards e relatórios alimentados por dados ao vivo do PostgreSQL\n\n---\n\n## Arquitetura Técnica\n\n### Stack Tecnológico\n\n#### Frontend\n- **React 18** com TypeScript\n- **Vite** para build e desenvolvimento\n- **Wouter** para roteamento\n- **TanStack Query v5** para gerenciamento de estado e cache\n- **shadcn/ui** com Radix UI para componentes\n- **Tailwind CSS** para estilização\n\n#### Backend\n- **Node.js** com Express.js\n- **TypeScript** para type safety\n- **Drizzle ORM** para acesso ao banco de dados\n- **PostgreSQL** (Neon) como banco de dados principal\n\n#### Segurança\n- **JWT** para autenticação\n- **Bcrypt** para hash de senhas\n- **Helmet.js** para headers HTTP seguros\n- **CORS** configurado\n- **Rate Limiting** para proteção contra abuso\n- **Microsoft Entra ID** para SSO corporativo\n\n### Estrutura de Diretórios\n\n```\n/\n├── client/                 # Frontend React\n│   └── src/\n│       ├── components/     # Componentes reutilizáveis\n│       ├── contexts/       # Contextos React (Module, Client, Auth)\n│       ├── pages/          # Páginas da aplicação\n│       └── lib/            # Utilitários e configurações\n├── server/                 # Backend Express\n│   ├── index.ts           # Entry point\n│   ├── routes.ts          # Rotas da API\n│   ├── storage.ts         # Camada de dados\n│   └── vite.ts            # Integração Vite\n└── shared/\n    └── schema.ts          # Schema Drizzle compartilhado\n```\n\n---\n\n## Modelo de Dados e Multi-Tenancy\n\n### Hierarquia Organizacional\n\n```\nCompanies (Empresas)\n    └── Customers (Clientes)\n        └── Sites (Locais)\n            └── Zones (Zonas)\n                ├── Work Orders (Ordens de Serviço)\n                ├── QR Code Points (Pontos QR)\n                └── Equipment (Equipamentos)\n```\n\n### Isolamento por Módulo\n\n**17 tabelas** implementam isolamento completo por módulo (`module: 'clean' | 'maintenance'`):\n\n**Tabelas Principais**:\n- `sites` - Locais com isolamento por módulo\n- `zones` - Zonas associadas a locais do módulo\n- `work_orders` - Ordens de serviço por módulo\n- `qr_code_points` - Pontos QR por módulo\n- `services` - Serviços disponíveis por módulo\n- `cleaning_activities` - Atividades de limpeza (OPUS Clean)\n- `dashboard_goals` - Metas do dashboard por módulo\n- `service_types` - Tipos de serviço por módulo\n\n**Tabelas de Configuração**:\n- `service_categories` - Categorias de serviço por módulo\n- `checklist_templates` - Templates de checklist por módulo\n- `sla_configs` - Configurações de SLA por módulo\n- `equipment` - Equipamentos por módulo\n- `maintenance_checklist_templates` - Templates de manutenção\n- `maintenance_plans` - Planos de manutenção\n\n**Padrão de Filtragem em 3 Camadas**:\n```typescript\n// Exemplo: Buscar equipamentos do módulo\n1. Filtrar Sites por module\n2. Filtrar Zones por module (via Sites filtrados)\n3. Filtrar Equipment por module (via Zones filtradas)\n```\n\n---\n\n## Funcionalidades do Sistema\n\n### 1. Gestão de Usuários e Autenticação\n\n#### Métodos de Autenticação\n- **Email/Senha**: Autenticação tradicional com Bcrypt\n- **Microsoft SSO**: Integração com Entra ID para empresas\n\n#### Sistema de Roles Personalizado\n- **Roles Predefinidos**: Admin, Gestor Cliente, Supervisor Local, Operador, Auditor\n- **Permissões Granulares**: Controle baseado em permissões por role\n- **Acesso Mobile**: Indicador de quem pode acessar interface mobile\n- **Roteamento Diferenciado**: Rotas específicas para web e mobile\n\n#### Gerenciamento de Usuários\n- CRUD completo de usuários\n- Atribuição de múltiplos roles customizados\n- Vinculação a empresas e clientes\n- Indicadores visuais de roles e acesso mobile\n\n### 2. Gestão Organizacional\n\n#### Empresas (Companies)\n- Gerenciamento de empresas no sistema\n- Configurações e dados corporativos\n- Associação de clientes\n\n#### Clientes (Customers)\n- Cadastro de clientes por empresa\n- Dados de contato (CNPJ, email, telefone, endereço)\n- Status ativo/inativo\n- Visualização de locais associados\n\n#### Locais (Sites)\n- Cadastro de locais por cliente\n- Isolamento por módulo (Clean/Manutenção)\n- Informações detalhadas (endereço, contato, horários)\n- Status e tipo de local\n\n#### Zonas (Zones)\n- Subdivisões de locais\n- Isolamento por módulo\n- Informações específicas (tamanho em m², descrição)\n- Vinculação a locais do mesmo módulo\n\n### 3. Sistema de QR Codes\n\n#### QR Codes de Execução (Internos)\n- **Propósito**: Gestão de trabalho para operadores internos\n- **Fluxo**: Operador escaneia QR → Visualiza ordem de serviço → Executa checklist\n- **Características**:\n  - Vinculados a zonas específicas\n  - Geram ordens de serviço programadas\n  - Suportam checklists dinâmicos\n  - Rastreamento de execução e tempo\n\n#### QR Codes Públicos\n- **Propósito**: Solicitações de serviço por usuários finais\n- **Fluxo**: Usuário escaneia QR → Preenche formulário → Sistema cria ordem corretiva\n- **Características**:\n  - Acesso público (sem autenticação)\n  - Captura de localização\n  - Upload de fotos\n  - Criação automática de ordem corretiva\n\n### 4. Gestão de Ordens de Serviço\n\n#### Tipos de Ordens\n1. **Programadas**: Geradas por agendamento de atividades\n2. **Corretivas Internas**: Criadas manualmente por gestores\n3. **Corretivas Públicas**: Geradas via QR codes públicos\n\n#### Status e Ciclo de Vida\n- **Em aberto**: Aguardando execução\n- **Em progresso**: Operador iniciou trabalho\n- **Concluída**: Trabalho finalizado com checklist\n- **Cancelada**: Ordem cancelada\n- **Reabertura**: Suporte para reabrir ordens concluídas\n\n#### Recursos Avançados\n- **Prioridades**: Baixa, Média, Alta, Urgente\n- **SLA**: Rastreamento de cumprimento de prazos\n- **Atribuição**: Vinculação a operadores específicos\n- **Comentários**: Sistema de notas com anexo de fotos\n- **Avaliação**: Rating de 1-5 estrelas ao concluir\n- **Analytics**: Todas as métricas derivadas de dados reais\n\n### 5. Checklists Dinâmicos\n\n#### Templates de Checklist\n- Criação de templates reutilizáveis\n- Isolamento por módulo\n- Items com tipos variados (texto, sim/não, número, foto)\n- Versionamento de templates\n\n#### Execução de Checklist\n- Preenchimento durante execução da ordem\n- Validação de campos obrigatórios\n- Captura de fotos como evidência\n- Timestamp de conclusão\n\n### 6. Agendamento e Atividades\n\n#### OPUS Clean - Atividades de Limpeza\n- **Atividades Recorrentes**:\n  - Padrões: Diária, Semanal, Mensal, Anual\n  - Frequência customizada (ex: a cada 3 dias)\n  - Dias específicos da semana\n  - Múltiplas ocorrências por dia\n- **Geração Automática**: Ordens criadas conforme agenda\n- **Configuração**:\n  - Horários específicos\n  - Zonas associadas\n  - Templates de checklist\n  - SLA por atividade\n\n#### OPUS Manutenção - Planos de Manutenção\n- **Tipos de Manutenção**:\n  - Preventiva\n  - Corretiva\n  - Preditiva\n- **Associação de Equipamentos**:\n  - Vinculação de múltiplos equipamentos ao plano\n  - Templates de checklist por tipo de equipamento\n  - Frequência de manutenção configurável\n- **Gestão de Equipamentos**:\n  - Cadastro com especificações técnicas\n  - Número de série e localização\n  - Status operacional\n  - Histórico de manutenções\n\n### 7. Configurações do Sistema\n\n#### Tipos e Categorias de Serviço\n- Organização hierárquica (Tipo → Categoria)\n- Isolamento por módulo\n- Códigos e descrições customizáveis\n\n#### Configurações de SLA\n- Definição de prazos por prioridade\n- Configuração específica por módulo\n- Aplicação automática em ordens\n\n#### Metas de Dashboard\n- Definição de metas operacionais\n- Períodos customizáveis (mensal, trimestral, anual)\n- Indicadores visuais de desempenho\n\n### 8. Dashboard e Analytics\n\n#### Métricas em Tempo Real\n- **Distribuição de Ordens**:\n  - Por prioridade (gráfico pizza)\n  - Por local (gráfico barras)\n  - Por status\n- **Performance**:\n  - Tempo médio de conclusão\n  - Taxa de cumprimento de SLA\n  - Ordens concluídas vs. abertas\n- **Tendências Temporais**:\n  - Evolução de atividades\n  - Padrões sazonais\n  - Comparativos com metas\n\n#### Relatórios Avançados\n- **Relatório Geral**: Visão consolidada de operações\n- **Análise de SLA**: Cumprimento de prazos detalhado\n- **Produtividade**: Performance por operador\n- **Análise por Local**: Distribuição geográfica\n- **Análise Temporal**: Padrões ao longo do tempo\n- **Exportação**: Geração de PDF e Excel\n\n### 9. Interface Mobile\n\n#### Características Mobile-First\n- Design responsivo e touch-friendly\n- Headers fixos para navegação\n- Pull-to-refresh em listas\n- Otimização para conexões lentas\n\n#### Funcionalidades Mobile\n- Escaneamento de QR codes\n- Execução de checklists offline-ready\n- Captura e upload de fotos\n- Visualização de ordens atribuídas\n- Navegação simplificada\n\n### 10. Auditoria e Rastreabilidade\n\n#### Logs de Auditoria\n- Registro de todas ações críticas\n- Informações capturadas:\n  - Usuário executor\n  - Timestamp preciso\n  - Tipo de ação (criação, edição, exclusão)\n  - Dados modificados (JSON diff)\n  - Metadados contextuais\n\n#### Rastreamento de Mudanças\n- Histórico completo de ordens\n- Registro de status changes\n- Comentários timestamped\n- Fotos com metadata\n\n---\n\n## OPUS Clean - Módulo de Limpeza\n\n### Identidade Visual\n- **Cor Principal**: Azul Navy (#1e3a8a)\n- **Tema**: Profissionalismo e confiabilidade\n\n### Funcionalidades Específicas\n\n#### Gestão de Atividades de Limpeza\n- Agendamento recorrente flexível\n- Múltiplas frequências e padrões\n- Geração automática de ordens programadas\n- Checklists específicos para limpeza\n\n#### Tipos de Serviço\n- Limpeza geral\n- Sanitização\n- Higienização especializada\n- Coleta de resíduos\n\n#### Categorias Customizáveis\n- Ambientes (escritórios, banheiros, áreas comuns)\n- Superfícies (vidros, pisos, carpetes)\n- Equipamentos (aspiradores, lavadoras)\n\n---\n\n## OPUS Manutenção - Módulo de Manutenção\n\n### Identidade Visual\n- **Cor Principal**: Laranja (#FF9800)\n- **Tema**: Energia e ação\n\n### Funcionalidades Específicas\n\n#### Gestão de Equipamentos\n- Cadastro completo de ativos\n- Especificações técnicas detalhadas\n- Localização e tracking\n- Histórico de intervenções\n\n#### Planos de Manutenção\n- Manutenção preventiva programada\n- Manutenção corretiva sob demanda\n- Manutenção preditiva baseada em dados\n- Templates por tipo de equipamento\n\n#### Checklist Templates de Manutenção\n- Procedimentos específicos por equipamento\n- Inspeções técnicas\n- Testes de funcionalidade\n- Registro de medições e parâmetros\n\n---\n\n## Padrões de Desenvolvimento\n\n### Backend - Camada de Dados\n\n```typescript\n// Interface de Storage define contratos\ninterface IStorage {\n  getWorkOrdersByCustomer(customerId: string, module?: 'clean' | 'maintenance'): Promise<WorkOrder[]>;\n}\n\n// Implementação filtra por módulo quando fornecido\nasync getWorkOrdersByCustomer(customerId: string, module?: 'clean' | 'maintenance') {\n  const customerSites = await this.db\n    .select()\n    .from(sites)\n    .where(module ? and(eq(sites.customerId, customerId), eq(sites.module, module)) : eq(sites.customerId, customerId));\n  // ... resto da lógica\n}\n```\n\n### Frontend - Queries com Módulo\n\n```typescript\n// Hook useModule fornece contexto do módulo atual\nconst { currentModule } = useModule();\n\n// Queries incluem módulo no queryKey para cache isolado\nconst { data: workOrders } = useQuery({\n  queryKey: [`/api/customers/${customerId}/work-orders`, { module: currentModule }],\n  enabled: !!customerId,\n});\n```\n\n### API - Routes com Query Params\n\n```typescript\n// Rotas aceitam parâmetro module via query string\napp.get(\"/api/customers/:customerId/work-orders\", async (req, res) => {\n  const module = req.query.module as 'clean' | 'maintenance' | undefined;\n  const workOrders = await storage.getWorkOrdersByCustomer(req.params.customerId, module);\n  res.json(workOrders);\n});\n```\n\n---\n\n## Segurança e Compliance\n\n### Autenticação e Autorização\n- JWT com expiração configurável\n- Refresh tokens para sessões longas\n- Rate limiting por IP e usuário\n- Validação de permissões em cada rota\n\n### Proteção de Dados\n- Senhas nunca armazenadas em plain text\n- Bcrypt com salt rounds configurável\n- Sanitização de inputs\n- Prevenção de SQL injection via ORM\n- CORS restrito a domínios autorizados\n\n### Auditoria\n- Logs completos de ações críticas\n- Rastreamento de mudanças em dados sensíveis\n- Retenção de logs configurável\n- Exportação de dados para compliance\n\n---\n\n## Escalabilidade e Performance\n\n### Otimizações de Query\n- Índices em campos frequentemente consultados\n- Queries otimizadas com joins eficientes\n- Paginação em listagens grandes\n- Cache de queries com TanStack Query\n\n### Arquitetura Preparada para Escala\n- Separação clara de responsabilidades\n- Stateless backend (JWT)\n- Database connection pooling\n- Pronto para load balancing horizontal\n\n---\n\n## Roadmap de Funcionalidades Futuras\n\n### Em Consideração\n- Notificações push para mobile\n- Integração com sistemas externos (ERP, CMMS)\n- IA para previsão de manutenções\n- Geolocalização em tempo real de operadores\n- Assinatura digital em checklists\n- Integração com IoT para sensores\n\n---\n\n## Conclusão\n\nOPUS é uma plataforma robusta e escalável para gestão de facilities, oferecendo isolamento completo entre módulos operacionais, interface intuitiva tanto para gestores quanto operadores, e analytics em tempo real para tomada de decisões informadas. A arquitetura moderna e tecnologias de ponta garantem performance, segurança e facilidade de manutenção.\n","size_bytes":14623},"client/src/pages/maintenance-checklist-templates.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Popover, PopoverContent, PopoverTrigger } from \"@/components/ui/popover\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useModule } from \"@/contexts/ModuleContext\";\nimport { useLocation } from \"wouter\";\nimport { Plus, Edit3, Trash2, List, FileText, Eye, Hash, ChevronDown } from \"lucide-react\";\nimport { nanoid } from \"nanoid\";\n\ninterface ChecklistItem {\n  id: string;\n  type: 'text' | 'number' | 'photo' | 'checkbox';\n  label: string;\n  required: boolean;\n  description?: string;\n  options?: string[]; // Para tipo checkbox - lista de opções\n  validation?: {\n    minLength?: number;\n    maxLength?: number;\n    minValue?: number;\n    maxValue?: number;\n    photoMinCount?: number;\n    photoMaxCount?: number;\n    minChecked?: number; // Mínimo de checks obrigatórios\n    maxChecked?: number; // Máximo de checks permitidos\n  };\n}\n\ninterface MaintenanceChecklistTemplatesProps {\n  customerId: string;\n}\n\nfunction MultiSelect({\n  label,\n  options,\n  value,\n  onChange,\n  placeholder,\n  disabled,\n  \"data-testid\": dataTestId,\n}: {\n  label: string;\n  options: { value: string; label: string }[];\n  value: string[];\n  onChange: (vals: string[]) => void;\n  placeholder?: string;\n  disabled?: boolean;\n  \"data-testid\"?: string;\n}) {\n  const [open, setOpen] = useState(false);\n  \n  const toggleOption = (optionValue: string) => {\n    if (value.includes(optionValue)) {\n      onChange(value.filter(v => v !== optionValue));\n    } else {\n      onChange([...value, optionValue]);\n    }\n  };\n\n  const selectedLabels = options\n    .filter(opt => value.includes(opt.value))\n    .map(opt => opt.label)\n    .join(\", \");\n\n  return (\n    <div className=\"space-y-2\">\n      <Label>{label}</Label>\n      <Popover open={open} onOpenChange={setOpen}>\n        <PopoverTrigger asChild>\n          <Button\n            variant=\"outline\"\n            role=\"combobox\"\n            aria-expanded={open}\n            className=\"w-full justify-between\"\n            disabled={disabled}\n            data-testid={dataTestId}\n          >\n            <span className=\"truncate\">\n              {selectedLabels || placeholder || \"Selecione...\"}\n            </span>\n            <ChevronDown className=\"ml-2 h-4 w-4 shrink-0 opacity-50\" />\n          </Button>\n        </PopoverTrigger>\n        <PopoverContent className=\"w-full p-0\" align=\"start\">\n          <div className=\"max-h-64 overflow-auto p-2\">\n            {options.length === 0 ? (\n              <div className=\"p-2 text-sm text-muted-foreground\">\n                {placeholder || \"Sem opções\"}\n              </div>\n            ) : (\n              <div className=\"space-y-1\">\n                {options.map((option) => (\n                  <div\n                    key={option.value}\n                    className=\"flex items-center space-x-2 p-2 hover:bg-accent rounded-sm cursor-pointer\"\n                    onClick={() => toggleOption(option.value)}\n                  >\n                    <Checkbox\n                      checked={value.includes(option.value)}\n                      onCheckedChange={() => toggleOption(option.value)}\n                    />\n                    <label className=\"flex-1 cursor-pointer text-sm\">\n                      {option.label}\n                    </label>\n                  </div>\n                ))}\n              </div>\n            )}\n          </div>\n        </PopoverContent>\n      </Popover>\n      <div className=\"text-xs text-slate-500\">\n        {value?.length ? `${value.length} selecionado(s)` : \"Nenhum selecionado\"}\n      </div>\n    </div>\n  );\n}\n\nexport default function MaintenanceChecklistTemplates({ customerId }: MaintenanceChecklistTemplatesProps) {\n  const { toast } = useToast();\n  const { currentModule } = useModule();\n  const [, setLocation] = useLocation();\n\n  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);\n  const [editingTemplate, setEditingTemplate] = useState<any>(null);\n  \n  // Form states\n  const [templateForm, setTemplateForm] = useState({\n    name: \"\",\n    description: \"\",\n    serviceId: \"\",\n    siteIds: [] as string[],\n    zoneIds: [] as string[],\n    equipmentIds: [] as string[],\n    version: \"1.0\",\n    items: [] as ChecklistItem[]\n  });\n\n  const [newItem, setNewItem] = useState<Partial<ChecklistItem>>({\n    type: 'text',\n    label: \"\",\n    required: false,\n    description: \"\",\n    options: [],\n    validation: {}\n  });\n\n  // Fetch customer data\n  const { data: customer } = useQuery({\n    queryKey: [`/api/customers/${customerId}`],\n    enabled: !!customerId,\n  });\n\n  // Fetch templates\n  const { data: templates, isLoading } = useQuery({\n    queryKey: [`/api/customers/${customerId}/maintenance-checklist-templates`, { module: currentModule }],\n    enabled: !!customerId,\n  });\n\n  // Fetch sites\n  const { data: sites = [] } = useQuery({\n    queryKey: [`/api/customers/${customerId}/sites`, { module: currentModule }],\n    enabled: !!customerId,\n  });\n\n  // Fetch services (filtrado por módulo de manutenção)\n  const { data: services = [] } = useQuery({\n    queryKey: [`/api/customers/${customerId}/services`, { module: currentModule }],\n    enabled: !!customerId,\n  });\n\n  // Fetch zones based on selected sites\n  const { data: zones = [] } = useQuery({\n    queryKey: [\"/api/zones\", (templateForm.siteIds || []).join(\",\"), { module: currentModule }],\n    enabled: Array.isArray(templateForm.siteIds) && templateForm.siteIds.length > 0,\n    queryFn: async () => {\n      const ids = templateForm.siteIds;\n      if (!ids || ids.length === 0) return [];\n      const qs = new URLSearchParams();\n      qs.set(\"siteIds\", ids.join(\",\"));\n      qs.set(\"module\", currentModule);\n      const res = await fetch(`/api/zones?${qs.toString()}`);\n      if (!res.ok) throw new Error('Failed to fetch zones');\n      return res.json();\n    },\n  });\n\n  // Fetch all equipment for displaying names in the table\n  const { data: allEquipment = [] } = useQuery({\n    queryKey: [`/api/customers/${customerId}/equipment`],\n    enabled: !!customerId,\n  });\n\n  // Fetch equipment for selected zones (for the form)\n  const { data: equipment = [] } = useQuery({\n    queryKey: [\"/api/equipment\", (templateForm.zoneIds || []).join(\",\"), { module: currentModule }],\n    enabled: Array.isArray(templateForm.zoneIds) && templateForm.zoneIds.length > 0,\n    queryFn: async () => {\n      const ids = templateForm.zoneIds;\n      if (!ids || ids.length === 0) return [];\n      const qs = new URLSearchParams();\n      qs.set(\"zoneIds\", ids.join(\",\"));\n      qs.set(\"module\", currentModule);\n      const res = await fetch(`/api/equipment?${qs.toString()}`);\n      if (!res.ok) throw new Error('Failed to fetch equipment');\n      return res.json();\n    },\n  });\n\n  // Redirect if not in maintenance module\n  useEffect(() => {\n    if (currentModule !== 'maintenance') {\n      setLocation('/');\n    }\n  }, [currentModule, setLocation]);\n\n  const createTemplateMutation = useMutation({\n    mutationFn: async (data: any) => {\n      return await apiRequest(\"POST\", \"/api/maintenance-checklist-templates\", data);\n    },\n    onSuccess: () => {\n      toast({ title: \"Template criado com sucesso\" });\n      queryClient.invalidateQueries({ queryKey: [`/api/customers/${customerId}/maintenance-checklist-templates`] });\n      setIsCreateDialogOpen(false);\n      resetForm();\n    },\n    onError: () => {\n      toast({ \n        title: \"Erro ao criar template\", \n        variant: \"destructive\" \n      });\n    },\n  });\n\n  const updateTemplateMutation = useMutation({\n    mutationFn: async (data: any) => {\n      return await apiRequest(\"PUT\", `/api/maintenance-checklist-templates/${data.id}`, data);\n    },\n    onSuccess: () => {\n      toast({ title: \"Template atualizado com sucesso\" });\n      queryClient.invalidateQueries({ queryKey: [`/api/customers/${customerId}/maintenance-checklist-templates`] });\n      setIsCreateDialogOpen(false);\n      setEditingTemplate(null);\n      resetForm();\n    },\n    onError: () => {\n      toast({ \n        title: \"Erro ao atualizar template\", \n        variant: \"destructive\" \n      });\n    },\n  });\n\n  const deleteTemplateMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return await apiRequest(\"DELETE\", `/api/maintenance-checklist-templates/${id}`);\n    },\n    onSuccess: () => {\n      toast({ title: \"Template excluído com sucesso\" });\n      queryClient.invalidateQueries({ queryKey: [`/api/customers/${customerId}/maintenance-checklist-templates`] });\n    },\n    onError: () => {\n      toast({ \n        title: \"Erro ao excluir template\", \n        variant: \"destructive\" \n      });\n    },\n  });\n\n  const resetForm = () => {\n    setTemplateForm({\n      name: \"\",\n      description: \"\",\n      serviceId: \"\",\n      siteIds: [],\n      zoneIds: [],\n      equipmentIds: [],\n      version: \"1.0\",\n      items: []\n    });\n    setNewItem({\n      type: 'text',\n      label: \"\",\n      required: false,\n      description: \"\",\n      options: [],\n      validation: {}\n    });\n  };\n\n  const handleAddItem = () => {\n    if (!newItem.label) {\n      toast({ \n        title: \"Rótulo obrigatório\", \n        description: \"Digite um rótulo para o item\", \n        variant: \"destructive\" \n      });\n      return;\n    }\n\n    const item: ChecklistItem = {\n      id: nanoid(),\n      type: newItem.type || 'text',\n      label: newItem.label,\n      required: newItem.required || false,\n      description: newItem.description,\n      options: newItem.options,\n      validation: newItem.validation\n    };\n\n    setTemplateForm(prev => ({\n      ...prev,\n      items: [...prev.items, item]\n    }));\n\n    // Reset new item\n    setNewItem({\n      type: 'text',\n      label: \"\",\n      required: false,\n      description: \"\",\n      options: [],\n      validation: {}\n    });\n  };\n\n  const handleRemoveItem = (itemId: string) => {\n    setTemplateForm(prev => ({\n      ...prev,\n      items: prev.items.filter(item => item.id !== itemId)\n    }));\n  };\n\n  const handleSubmit = () => {\n    const companyId = (customer as any)?.companyId;\n    if (!companyId || !templateForm.name) {\n      toast({ \n        title: \"Preencha todos os campos obrigatórios\", \n        variant: \"destructive\" \n      });\n      return;\n    }\n\n    if (!templateForm.serviceId) {\n      toast({\n        title: \"Serviço obrigatório\",\n        description: \"Selecione um serviço para o checklist.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (!templateForm.equipmentIds || templateForm.equipmentIds.length === 0) {\n      toast({\n        title: \"Equipamento obrigatório\",\n        description: \"Selecione pelo menos um equipamento para o checklist.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (templateForm.items.length === 0) {\n      toast({\n        title: \"Itens obrigatórios\",\n        description: \"Adicione pelo menos um item ao checklist.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    const data = {\n      companyId,\n      customerId,\n      name: templateForm.name,\n      description: templateForm.description || null,\n      siteIds: templateForm.siteIds && templateForm.siteIds.length > 0 ? templateForm.siteIds : null,\n      zoneIds: templateForm.zoneIds && templateForm.zoneIds.length > 0 ? templateForm.zoneIds : null,\n      equipmentIds: templateForm.equipmentIds,\n      serviceId: templateForm.serviceId,\n      version: templateForm.version,\n      items: templateForm.items,\n      module: currentModule,\n    };\n\n    if (editingTemplate) {\n      updateTemplateMutation.mutate({ ...data, id: editingTemplate.id });\n    } else {\n      createTemplateMutation.mutate(data);\n    }\n  };\n\n  const handleEdit = (template: any) => {\n    setEditingTemplate(template);\n    setTemplateForm({\n      name: template.name,\n      description: template.description || \"\",\n      serviceId: template.serviceId || \"\",\n      siteIds: template.siteIds || [],\n      zoneIds: template.zoneIds || [],\n      equipmentIds: template.equipmentIds || [],\n      version: template.version,\n      items: template.items || []\n    });\n    setIsCreateDialogOpen(true);\n  };\n\n  const handleDelete = (id: string) => {\n    if (confirm(\"Tem certeza que deseja excluir este template?\")) {\n      deleteTemplateMutation.mutate(id);\n    }\n  };\n\n  const getTypeIcon = (type: string) => {\n    switch (type) {\n      case 'photo': return <Eye className=\"w-4 h-4\" />;\n      case 'number': return <Hash className=\"w-4 h-4\" />;\n      case 'checkbox': return <List className=\"w-4 h-4\" />;\n      default: return <FileText className=\"w-4 h-4\" />;\n    }\n  };\n\n  const getTypeLabel = (type: string) => {\n    switch (type) {\n      case 'photo': return 'Foto';\n      case 'number': return 'Número';\n      case 'checkbox': return 'Checkbox';\n      default: return 'Texto';\n    }\n  };\n\n  const getSiteName = (siteId: string | null) => {\n    if (!siteId) return null;\n    return (sites as any[])?.find(s => s.id === siteId)?.name || null;\n  };\n\n  const getZoneName = (zoneId: string | null) => {\n    if (!zoneId) return null;\n    return (zones as any[])?.find(z => z.id === zoneId)?.name || null;\n  };\n\n  const getEquipmentNames = (equipmentIds: string[]) => {\n    if (!equipmentIds || equipmentIds.length === 0) return [];\n    return equipmentIds.map(id => {\n      const eq = (allEquipment as any[])?.find(e => e.id === id);\n      return eq ? eq.name : id;\n    });\n  };\n\n  const getServiceName = (serviceId: string | null) => {\n    if (!serviceId) return null;\n    return (services as any[])?.find(s => s.id === serviceId)?.name || null;\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"h-full bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 p-6\">\n        <div className=\"text-center space-y-4\">\n          <div className=\"w-16 h-16 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mx-auto\"></div>\n          <p className=\"text-slate-600\">Carregando templates...</p>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"h-full overflow-auto bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50\">\n      {/* Header */}\n      <div className=\"bg-white/80 backdrop-blur-xl border-b border-white/20 shadow-lg shadow-blue-500/5 sticky top-0 z-50\">\n        <div className=\"px-8 py-6\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center space-x-4\">\n              <div className=\"w-12 h-12 bg-gradient-to-br from-purple-600 via-purple-700 to-indigo-800 rounded-2xl flex items-center justify-center shadow-lg\">\n                <List className=\"w-7 h-7 text-white\" />\n              </div>\n              <div>\n                <h1 className=\"text-3xl font-bold bg-gradient-to-r from-slate-900 via-purple-900 to-indigo-900 bg-clip-text text-transparent\">\n                  Checklists\n                </h1>\n                <p className=\"text-sm text-slate-600\">\n                  Gerencie os templates de checklist de manutenção\n                </p>\n              </div>\n            </div>\n            <Dialog open={isCreateDialogOpen} onOpenChange={(open) => {\n              setIsCreateDialogOpen(open);\n              if (!open) {\n                setEditingTemplate(null);\n                resetForm();\n              }\n            }}>\n              <Button \n                className=\"bg-gradient-to-r from-purple-600 to-indigo-700 hover:from-purple-700 hover:to-indigo-800\"\n                onClick={() => setIsCreateDialogOpen(true)}\n                data-testid=\"button-create-template\"\n              >\n                <Plus className=\"w-4 h-4 mr-2\" />\n                Novo Template\n              </Button>\n              <DialogContent className=\"max-w-5xl max-h-[90vh] overflow-y-auto\">\n                <DialogHeader>\n                  <DialogTitle>\n                    {editingTemplate ? \"Editar Template\" : \"Criar Novo Template\"}\n                  </DialogTitle>\n                </DialogHeader>\n                \n                <div className=\"space-y-6\">\n                  {/* Form básico */}\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"name\">Nome do Template *</Label>\n                      <Input\n                        id=\"name\"\n                        data-testid=\"input-template-name\"\n                        value={templateForm.name}\n                        onChange={(e) => setTemplateForm(prev => ({ ...prev, name: e.target.value }))}\n                        placeholder=\"Ex: Manutenção Preventiva HVAC\"\n                      />\n                    </div>\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"version\">Versão</Label>\n                      <Input\n                        id=\"version\"\n                        data-testid=\"input-template-version\"\n                        value={templateForm.version}\n                        onChange={(e) => setTemplateForm(prev => ({ ...prev, version: e.target.value }))}\n                        placeholder=\"1.0\"\n                      />\n                    </div>\n                  </div>\n\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"description\">Descrição</Label>\n                    <Textarea\n                      id=\"description\"\n                      data-testid=\"input-template-description\"\n                      value={templateForm.description}\n                      onChange={(e) => setTemplateForm(prev => ({ ...prev, description: e.target.value }))}\n                      placeholder=\"Descrição do template...\"\n                      rows={2}\n                    />\n                  </div>\n\n                  {/* Serviço */}\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"service\">Serviço *</Label>\n                    <Select\n                      value={templateForm.serviceId || \"\"}\n                      onValueChange={(value) => setTemplateForm(prev => ({ ...prev, serviceId: value }))}\n                    >\n                      <SelectTrigger data-testid=\"select-template-service\">\n                        <SelectValue placeholder=\"Selecione um serviço\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        {(services as any[])?.map((service: any) => (\n                          <SelectItem key={service.id} value={service.id}>\n                            {service.name}\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                    <p className=\"text-xs text-slate-500\">\n                      Vincule este template a um serviço específico\n                    </p>\n                  </div>\n\n                  {/* Local e Zona */}\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <MultiSelect\n                      label=\"Local *\"\n                      options={(sites as any[])?.map(site => ({ value: site.id, label: site.name })) || []}\n                      value={templateForm.siteIds || []}\n                      onChange={(vals) => setTemplateForm(prev => ({ ...prev, siteIds: vals, zoneIds: [] }))}\n                      placeholder=\"Selecione um ou mais locais\"\n                      data-testid=\"select-template-sites\"\n                    />\n\n                    <MultiSelect\n                      label=\"Zona *\"\n                      options={(zones as any[])?.map(zone => ({ value: zone.id, label: zone.name })) || []}\n                      value={templateForm.zoneIds || []}\n                      onChange={(vals) => setTemplateForm(prev => ({ ...prev, zoneIds: vals }))}\n                      placeholder={(templateForm.siteIds?.length ?? 0) > 0 ? \"Selecione uma ou mais zonas\" : \"Selecione ao menos um local\"}\n                      disabled={!(templateForm.siteIds?.length)}\n                      data-testid=\"select-template-zones\"\n                    />\n                  </div>\n\n                  {/* Seleção de Equipamentos */}\n                  <MultiSelect\n                    label=\"Equipamentos *\"\n                    options={(equipment as any[])?.map(eq => ({ \n                      value: eq.id, \n                      label: `${eq.name}${eq.internalCode ? ` (${eq.internalCode})` : ''}` \n                    })) || []}\n                    value={templateForm.equipmentIds || []}\n                    onChange={(val) => setTemplateForm(prev => ({ ...prev, equipmentIds: val }))}\n                    placeholder={\n                      equipment.length === 0 \n                        ? (templateForm.zoneIds?.length > 0 ? \"Nenhum equipamento nas zonas selecionadas\" : \"Selecione zonas primeiro\")\n                        : \"Selecione um ou mais equipamentos\"\n                    }\n                    disabled={!equipment.length}\n                    data-testid=\"select-template-equipment\"\n                  />\n\n                  {/* Adicionar item */}\n                  <Card>\n                    <CardHeader>\n                      <CardTitle className=\"text-lg\">Adicionar Item ao Checklist</CardTitle>\n                    </CardHeader>\n                    <CardContent className=\"space-y-4\">\n                      <div className=\"grid grid-cols-3 gap-4\">\n                        <div className=\"space-y-2\">\n                          <Label>Tipo</Label>\n                          <Select \n                            value={newItem.type} \n                            onValueChange={(value) => setNewItem(prev => ({ \n                              ...prev, \n                              type: value as ChecklistItem['type'],\n                              options: [],\n                              validation: {}\n                            }))}\n                          >\n                            <SelectTrigger data-testid=\"select-item-type\">\n                              <SelectValue />\n                            </SelectTrigger>\n                            <SelectContent>\n                              <SelectItem value=\"text\">Texto</SelectItem>\n                              <SelectItem value=\"number\">Número</SelectItem>\n                              <SelectItem value=\"photo\">Foto</SelectItem>\n                              <SelectItem value=\"checkbox\">Checkbox</SelectItem>\n                            </SelectContent>\n                          </Select>\n                        </div>\n                        <div className=\"space-y-2\">\n                          <Label>Rótulo *</Label>\n                          <Input\n                            data-testid=\"input-item-label\"\n                            value={newItem.label}\n                            onChange={(e) => setNewItem(prev => ({ ...prev, label: e.target.value }))}\n                            placeholder=\"Ex: Verificar pressão\"\n                          />\n                        </div>\n                        <div className=\"space-y-2\">\n                          <Label>Observações</Label>\n                          <Input\n                            data-testid=\"input-item-description\"\n                            value={newItem.description}\n                            onChange={(e) => setNewItem(prev => ({ ...prev, description: e.target.value }))}\n                            placeholder=\"Instruções opcionais...\"\n                          />\n                        </div>\n                      </div>\n\n                      {/* Configurações avançadas */}\n                      {newItem.type && (\n                        <Card className=\"bg-slate-50\">\n                          <CardHeader className=\"pb-3\">\n                            <CardTitle className=\"text-sm\">Configurações - {getTypeLabel(newItem.type)}</CardTitle>\n                          </CardHeader>\n                          <CardContent className=\"space-y-3\">\n                            {/* Texto */}\n                            {newItem.type === 'text' && (\n                              <div className=\"grid grid-cols-2 gap-4\">\n                                <div className=\"space-y-1\">\n                                  <Label className=\"text-xs\">Mínimo de caracteres</Label>\n                                  <Input\n                                    type=\"number\"\n                                    placeholder=\"Ex: 10\"\n                                    value={newItem.validation?.minLength || \"\"}\n                                    onChange={(e) => setNewItem(prev => ({\n                                      ...prev,\n                                      validation: {\n                                        ...prev.validation,\n                                        minLength: e.target.value ? parseInt(e.target.value) : undefined\n                                      }\n                                    }))}\n                                    className=\"h-8 text-xs\"\n                                  />\n                                </div>\n                                <div className=\"space-y-1\">\n                                  <Label className=\"text-xs\">Máximo de caracteres</Label>\n                                  <Input\n                                    type=\"number\"\n                                    placeholder=\"Ex: 500\"\n                                    value={newItem.validation?.maxLength || \"\"}\n                                    onChange={(e) => setNewItem(prev => ({\n                                      ...prev,\n                                      validation: {\n                                        ...prev.validation,\n                                        maxLength: e.target.value ? parseInt(e.target.value) : undefined\n                                      }\n                                    }))}\n                                    className=\"h-8 text-xs\"\n                                  />\n                                </div>\n                              </div>\n                            )}\n\n                            {/* Número */}\n                            {newItem.type === 'number' && (\n                              <div className=\"grid grid-cols-2 gap-4\">\n                                <div className=\"space-y-1\">\n                                  <Label className=\"text-xs\">Valor mínimo</Label>\n                                  <Input\n                                    type=\"number\"\n                                    placeholder=\"Ex: 0\"\n                                    value={newItem.validation?.minValue || \"\"}\n                                    onChange={(e) => setNewItem(prev => ({\n                                      ...prev,\n                                      validation: {\n                                        ...prev.validation,\n                                        minValue: e.target.value ? parseInt(e.target.value) : undefined\n                                      }\n                                    }))}\n                                    className=\"h-8 text-xs\"\n                                  />\n                                </div>\n                                <div className=\"space-y-1\">\n                                  <Label className=\"text-xs\">Valor máximo</Label>\n                                  <Input\n                                    type=\"number\"\n                                    placeholder=\"Ex: 100\"\n                                    value={newItem.validation?.maxValue || \"\"}\n                                    onChange={(e) => setNewItem(prev => ({\n                                      ...prev,\n                                      validation: {\n                                        ...prev.validation,\n                                        maxValue: e.target.value ? parseInt(e.target.value) : undefined\n                                      }\n                                    }))}\n                                    className=\"h-8 text-xs\"\n                                  />\n                                </div>\n                              </div>\n                            )}\n\n                            {/* Foto */}\n                            {newItem.type === 'photo' && (\n                              <div className=\"grid grid-cols-2 gap-4\">\n                                <div className=\"space-y-1\">\n                                  <Label className=\"text-xs\">Mínimo de fotos</Label>\n                                  <Input\n                                    type=\"number\"\n                                    placeholder=\"Ex: 1\"\n                                    value={newItem.validation?.photoMinCount || \"\"}\n                                    onChange={(e) => setNewItem(prev => ({\n                                      ...prev,\n                                      validation: {\n                                        ...prev.validation,\n                                        photoMinCount: e.target.value ? parseInt(e.target.value) : undefined\n                                      }\n                                    }))}\n                                    className=\"h-8 text-xs\"\n                                  />\n                                </div>\n                                <div className=\"space-y-1\">\n                                  <Label className=\"text-xs\">Máximo de fotos</Label>\n                                  <Input\n                                    type=\"number\"\n                                    placeholder=\"Ex: 5\"\n                                    value={newItem.validation?.photoMaxCount || \"\"}\n                                    onChange={(e) => setNewItem(prev => ({\n                                      ...prev,\n                                      validation: {\n                                        ...prev.validation,\n                                        photoMaxCount: e.target.value ? parseInt(e.target.value) : undefined\n                                      }\n                                    }))}\n                                    className=\"h-8 text-xs\"\n                                  />\n                                </div>\n                              </div>\n                            )}\n\n                            {/* Checkbox */}\n                            {newItem.type === 'checkbox' && (\n                              <div className=\"space-y-3\">\n                                <div className=\"space-y-2\">\n                                  <Label className=\"text-xs\">Opções do Checkbox</Label>\n                                  <div className=\"space-y-2\">\n                                    {(newItem.options || []).map((option, index) => (\n                                      <div key={index} className=\"flex gap-2\">\n                                        <Input\n                                          value={option}\n                                          onChange={(e) => {\n                                            const newOptions = [...(newItem.options || [])];\n                                            newOptions[index] = e.target.value;\n                                            setNewItem(prev => ({ ...prev, options: newOptions }));\n                                          }}\n                                          className=\"h-8 text-xs flex-1\"\n                                          placeholder={`Opção ${index + 1}`}\n                                          data-testid={`input-checkbox-option-${index}`}\n                                        />\n                                        <Button\n                                          variant=\"ghost\"\n                                          size=\"sm\"\n                                          onClick={() => {\n                                            const newOptions = (newItem.options || []).filter((_, i) => i !== index);\n                                            setNewItem(prev => ({ ...prev, options: newOptions }));\n                                          }}\n                                          className=\"h-8\"\n                                          data-testid={`button-remove-option-${index}`}\n                                        >\n                                          <Trash2 className=\"w-3 h-3\" />\n                                        </Button>\n                                      </div>\n                                    ))}\n                                    <Button\n                                      variant=\"outline\"\n                                      size=\"sm\"\n                                      onClick={() => {\n                                        setNewItem(prev => ({\n                                          ...prev,\n                                          options: [...(prev.options || []), '']\n                                        }));\n                                      }}\n                                      className=\"h-8 w-full\"\n                                      data-testid=\"button-add-checkbox-option\"\n                                    >\n                                      <Plus className=\"w-3 h-3 mr-2\" /> Adicionar Opção\n                                    </Button>\n                                  </div>\n                                </div>\n                                <div className=\"grid grid-cols-2 gap-4\">\n                                  <div className=\"space-y-1\">\n                                    <Label className=\"text-xs\">Mínimo de checks</Label>\n                                    <Input\n                                      type=\"number\"\n                                      placeholder=\"Ex: 1\"\n                                      value={newItem.validation?.minChecked || \"\"}\n                                      onChange={(e) => setNewItem(prev => ({\n                                        ...prev,\n                                        validation: {\n                                          ...prev.validation,\n                                          minChecked: e.target.value ? parseInt(e.target.value) : undefined\n                                        }\n                                      }))}\n                                      className=\"h-8 text-xs\"\n                                      data-testid=\"input-min-checked\"\n                                    />\n                                  </div>\n                                  <div className=\"space-y-1\">\n                                    <Label className=\"text-xs\">Máximo de checks</Label>\n                                    <Input\n                                      type=\"number\"\n                                      placeholder=\"Ex: 3\"\n                                      value={newItem.validation?.maxChecked || \"\"}\n                                      onChange={(e) => setNewItem(prev => ({\n                                        ...prev,\n                                        validation: {\n                                          ...prev.validation,\n                                          maxChecked: e.target.value ? parseInt(e.target.value) : undefined\n                                        }\n                                      }))}\n                                      className=\"h-8 text-xs\"\n                                      data-testid=\"input-max-checked\"\n                                    />\n                                  </div>\n                                </div>\n                              </div>\n                            )}\n\n                            {/* Campo obrigatório */}\n                            <div className=\"flex items-center space-x-2 pt-2\">\n                              <Switch\n                                id=\"required\"\n                                checked={newItem.required}\n                                onCheckedChange={(checked) => setNewItem(prev => ({ ...prev, required: checked }))}\n                              />\n                              <Label htmlFor=\"required\" className=\"text-sm cursor-pointer\">\n                                Campo obrigatório\n                              </Label>\n                            </div>\n                          </CardContent>\n                        </Card>\n                      )}\n\n                      <Button \n                        onClick={handleAddItem} \n                        className=\"w-full\"\n                        data-testid=\"button-add-item\"\n                      >\n                        <Plus className=\"w-4 h-4 mr-2\" />\n                        Adicionar Item\n                      </Button>\n                    </CardContent>\n                  </Card>\n\n                  {/* Lista de itens adicionados */}\n                  {templateForm.items.length > 0 && (\n                    <Card>\n                      <CardHeader>\n                        <CardTitle className=\"text-lg\">Itens do Checklist ({templateForm.items.length})</CardTitle>\n                      </CardHeader>\n                      <CardContent>\n                        <div className=\"space-y-2\">\n                          {templateForm.items.map((item, index) => (\n                            <div \n                              key={item.id} \n                              className=\"flex items-center justify-between p-3 bg-slate-50 rounded-lg hover:bg-slate-100\"\n                              data-testid={`item-${item.id}`}\n                            >\n                              <div className=\"flex items-center space-x-3 flex-1\">\n                                <span className=\"text-sm font-medium text-slate-500 w-8\">\n                                  {index + 1}.\n                                </span>\n                                <div className=\"flex items-center space-x-2\">\n                                  {getTypeIcon(item.type)}\n                                  <Badge variant=\"outline\" className=\"text-xs\">\n                                    {getTypeLabel(item.type)}\n                                  </Badge>\n                                </div>\n                                <div className=\"flex-1\">\n                                  <div className=\"font-medium text-sm\">{item.label}</div>\n                                  {item.description && (\n                                    <div className=\"text-xs text-slate-500\">{item.description}</div>\n                                  )}\n                                </div>\n                                {item.required && (\n                                  <Badge variant=\"destructive\" className=\"text-xs\">Obrigatório</Badge>\n                                )}\n                              </div>\n                              <Button\n                                variant=\"ghost\"\n                                size=\"sm\"\n                                onClick={() => handleRemoveItem(item.id)}\n                                data-testid={`button-remove-item-${item.id}`}\n                              >\n                                <Trash2 className=\"w-4 h-4 text-red-500\" />\n                              </Button>\n                            </div>\n                          ))}\n                        </div>\n                      </CardContent>\n                    </Card>\n                  )}\n\n                  {/* Actions */}\n                  <div className=\"flex justify-end space-x-2 pt-4\">\n                    <Button \n                      variant=\"outline\" \n                      onClick={() => {\n                        setIsCreateDialogOpen(false);\n                        setEditingTemplate(null);\n                        resetForm();\n                      }}\n                      data-testid=\"button-cancel\"\n                    >\n                      Cancelar\n                    </Button>\n                    <Button \n                      onClick={handleSubmit}\n                      disabled={createTemplateMutation.isPending || updateTemplateMutation.isPending}\n                      data-testid=\"button-save-template\"\n                    >\n                      {editingTemplate ? \"Atualizar\" : \"Criar\"} Template\n                    </Button>\n                  </div>\n                </div>\n              </DialogContent>\n            </Dialog>\n          </div>\n        </div>\n      </div>\n\n      {/* Content */}\n      <div className=\"p-8\">\n        <Card>\n          <CardHeader>\n            <CardTitle>Checklists de Manutenção</CardTitle>\n          </CardHeader>\n          <CardContent>\n            {!templates || (templates as any[]).length === 0 ? (\n              <div className=\"text-center py-12\">\n                <List className=\"w-16 h-16 mx-auto text-slate-300 mb-4\" />\n                <p className=\"text-slate-500\">Nenhum template cadastrado</p>\n              </div>\n            ) : (\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>Nome</TableHead>\n                    <TableHead>Serviço</TableHead>\n                    <TableHead>Local</TableHead>\n                    <TableHead>Zona</TableHead>\n                    <TableHead>Aplicado a</TableHead>\n                    <TableHead>Versão</TableHead>\n                    <TableHead>Itens</TableHead>\n                    <TableHead className=\"text-right\">Ações</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {(templates as any[]).map((template) => (\n                    <TableRow key={template.id} data-testid={`row-template-${template.id}`}>\n                      <TableCell className=\"font-medium\">{template.name}</TableCell>\n                      <TableCell>\n                        {template.serviceId ? (\n                          <Badge variant=\"outline\" className=\"bg-green-50 text-green-700 border-green-200\">\n                            {getServiceName(template.serviceId)}\n                          </Badge>\n                        ) : (\n                          <span className=\"text-slate-400 text-xs\">-</span>\n                        )}\n                      </TableCell>\n                      <TableCell>\n                        {template.siteId ? (\n                          <Badge variant=\"outline\">{getSiteName(template.siteId)}</Badge>\n                        ) : (\n                          <span className=\"text-slate-400\">-</span>\n                        )}\n                      </TableCell>\n                      <TableCell>\n                        {template.zoneId ? (\n                          <Badge variant=\"outline\">{getZoneName(template.zoneId)}</Badge>\n                        ) : (\n                          <span className=\"text-slate-400\">-</span>\n                        )}\n                      </TableCell>\n                      <TableCell>\n                        <div className=\"flex flex-wrap gap-1\">\n                          {template.equipmentIds && template.equipmentIds.length > 0 ? (\n                            getEquipmentNames(template.equipmentIds).map((name: string, idx: number) => (\n                              <Badge key={template.equipmentIds[idx]} variant=\"default\" className=\"text-xs bg-purple-600\">\n                                {name}\n                              </Badge>\n                            ))\n                          ) : (\n                            <span className=\"text-slate-400 text-xs\">Todos equipamentos</span>\n                          )}\n                        </div>\n                      </TableCell>\n                      <TableCell>\n                        <Badge variant=\"secondary\">{template.version}</Badge>\n                      </TableCell>\n                      <TableCell>\n                        <Badge>{(template.items || []).length}</Badge>\n                      </TableCell>\n                      <TableCell className=\"text-right\">\n                        <div className=\"flex justify-end space-x-2\">\n                          <Button\n                            variant=\"ghost\"\n                            size=\"sm\"\n                            onClick={() => handleEdit(template)}\n                            data-testid={`button-edit-${template.id}`}\n                          >\n                            <Edit3 className=\"w-4 h-4\" />\n                          </Button>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"sm\"\n                            onClick={() => handleDelete(template.id)}\n                            data-testid={`button-delete-${template.id}`}\n                          >\n                            <Trash2 className=\"w-4 h-4 text-red-500\" />\n                          </Button>\n                        </div>\n                      </TableCell>\n                    </TableRow>\n                  ))}\n                </TableBody>\n              </Table>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","size_bytes":45673},"ANALISE_ESTADO_ATUAL_MANUTENCAO.md":{"content":"# Análise do Estado Atual - OPUS Manutenção\n\n**Data:** Novembro 2025  \n**Objetivo:** Transformar OPUS Manutenção em sistema baseado em EQUIPAMENTOS\n\n---\n\n## 1. ESTADO ATUAL DO SISTEMA\n\n### 1.1 Tabelas Existentes Relevantes\n\n#### Hierarquia Multi-Tenancy (COMPARTILHADA)\n```\ncompanies → customers → sites → zones\n```\n\n**Tabelas:**\n- `companies` - Empresas (ex: OPUS)\n- `customers` - Clientes contratantes (ex: FAURECIA)\n- `sites` - Locais físicos do cliente (ex: Fábrica São Paulo)\n- `zones` - Zonas/áreas dentro de um site (ex: Sala 301, Banheiro 1º andar)\n\n#### Work Orders (COMPARTILHADA com discriminador `module`)\n- `work_orders` - Ordens de serviço\n  - **Campo `module`**: 'clean' | 'maintenance'\n  - **Campo `cleaningActivityId`**: FK para cleaning_activities (só Clean)\n  - **FALTAM**: `maintenanceActivityId`, `equipmentId` (para Manutenção)\n  \n#### Checklists (ATUALMENTE SÓ CLEAN)\n- `checklist_templates` - Templates de checklist\n  - Campos: `companyId`, `serviceId`, `siteId`, `zoneId`, `name`, `items` (JSONB)\n  - **Vinculado a**: service, site, zone (NÃO vinculado a equipamento)\n  - **Usado por**: cleaning_activities\n\n#### Atividades de Limpeza (SÓ CLEAN)\n- `cleaning_activities` - Atividades programadas de limpeza\n  - Campos: `companyId`, `serviceId`, `siteId`, `zoneId`, `frequency`, `checklistTemplateId`\n  - **Modelo**: Atividade vinculada a uma ZONA/LOCAL\n  - **Campo `module`**: default 'clean'\n\n#### Serviços (COMPARTILHADA com discriminador `module`)\n- `services` - Serviços disponíveis\n  - **Campo `module`**: 'clean' | 'maintenance'\n  - Campos: `name`, `description`, `estimatedDurationMinutes`, `customerId`\n\n---\n\n## 2. FLUXO ATUAL DO OPUS CLEAN\n\n### Modelo de Operação (ZONE-BASED)\n```\n1. Cliente (customer) possui Sites\n2. Sites possuem Zones (locais/áreas)\n3. Cleaning Activity é criada para uma ZONE\n   └─ Vincula: serviceId, zoneId, checklistTemplateId, frequency\n4. Sistema gera Work Orders programadas baseadas na atividade\n5. Operador executa Work Order escaneando QR da zona\n   └─ Preenche checklist vinculado à zona\n```\n\n### Páginas Frontend (Clean)\n- `/schedule` - Plano de Limpeza (lista cleaning_activities)\n- `/checklists` - Gerenciamento de checklist templates\n- `/workorders` - Ordens de serviço (compartilhado)\n- `/qrcodes` - QR Codes por zona\n\n### Rotas Backend (Clean)\n```\nGET  /api/companies/:companyId/cleaning-activities?module=clean\nPOST /api/cleaning-activities\nGET  /api/companies/:companyId/checklist-templates\nPOST /api/companies/:companyId/checklist-templates\n```\n\n---\n\n## 3. PROBLEMAS IDENTIFICADOS PARA MANUTENÇÃO\n\n### 3.1 Modelo Atual NÃO Serve para Manutenção\n\n**Problema 1: Checklist por ZONA ≠ Checklist por EQUIPAMENTO**\n- Clean: \"Limpar Sala 301\" → checklist vinculado à zona \"Sala 301\"\n- Manutenção: \"Manutenção do Compressor XYZ\" → checklist vinculado ao EQUIPAMENTO \"Compressor XYZ\"\n\n**Problema 2: Falta Entidade EQUIPAMENTO**\n- Não existe tabela `equipment`\n- Não há como cadastrar:\n  - Equipamentos por zona\n  - Tipo de equipamento\n  - Dados técnicos (fabricante, modelo, série)\n  - Localização física (zoneId)\n\n**Problema 3: Work Orders NÃO têm vínculo com Equipamento**\n- `work_orders.equipmentId` não existe\n- Não dá para rastrear histórico de manutenções por equipamento\n\n**Problema 4: Cleaning Activities NÃO serve para Manutenção**\n- `cleaning_activities` é específico para limpeza\n- Precisamos de `maintenance_plans` com lógica própria\n\n---\n\n## 4. MODELO ALVO PARA MANUTENÇÃO (EQUIPMENT-BASED)\n\n### 4.1 Novo Fluxo Proposto\n```\n1. Cliente (customer) possui Sites\n2. Sites possuem Zones (locais/áreas)\n3. EQUIPAMENTOS são cadastrados em Zones\n   └─ Cada equipamento tem: name, type, manufacturer, model, serialNumber\n4. CHECKLIST DE MANUTENÇÃO é criado POR EQUIPAMENTO (ou tipo)\n   └─ Exemplo: \"Checklist Manutenção Preventiva - Compressor\"\n5. PLANO DE MANUTENÇÃO vincula equipamentos + checklists\n   └─ Define periodicidade, tipo (preventiva/corretiva)\n6. Sistema gera Work Orders de manutenção para equipamentos\n7. Técnico executa WO escaneando QR do EQUIPAMENTO\n   └─ Preenche checklist vinculado ao equipamento\n```\n\n### 4.2 Novas Entidades Necessárias\n\n#### 1. `equipment` (Equipamentos)\n```typescript\n{\n  id: varchar,\n  companyId: varchar (FK),\n  customerId: varchar (FK),\n  siteId: varchar (FK),\n  zoneId: varchar (FK),          // Localização física\n  name: varchar,\n  internalCode: varchar,          // Código interno do cliente\n  equipmentType: varchar,         // \"Compressor\", \"HVAC\", \"Elevador\"\n  manufacturer: varchar,\n  model: varchar,\n  serialNumber: varchar,\n  purchaseDate: date,\n  warrantyExpiry: date,\n  technicalSpecs: jsonb,          // Especificações técnicas\n  qrCodeUrl: varchar,             // QR Code do equipamento\n  isActive: boolean,\n  module: 'maintenance'\n}\n```\n\n#### 2. `maintenance_checklist_templates` (Templates de Checklist de Manutenção)\n```typescript\n{\n  id: varchar,\n  companyId: varchar (FK),\n  customerId: varchar (FK),\n  name: varchar,\n  description: text,\n  equipmentType: varchar,         // \"Compressor\", \"HVAC\", etc (opcional)\n  equipmentId: varchar (FK),      // Checklist específico de UM equipamento (opcional)\n  version: integer,               // Versionamento\n  items: jsonb,                   // Array de itens do checklist\n  isActive: boolean,\n  module: 'maintenance'\n}\n```\n\n#### 3. `maintenance_checklist_executions` (Execuções de Checklist)\n```typescript\n{\n  id: varchar,\n  checklistTemplateId: varchar (FK),\n  equipmentId: varchar (FK),\n  workOrderId: varchar (FK),\n  startedAt: timestamp,\n  finishedAt: timestamp,\n  status: 'in_progress' | 'completed' | 'cancelled',\n  executedByUserId: varchar (FK),\n  checklistData: jsonb,           // Respostas do checklist\n  observations: text,\n  attachments: jsonb\n}\n```\n\n#### 4. `maintenance_plans` (Planos de Manutenção)\n```typescript\n{\n  id: varchar,\n  companyId: varchar (FK),\n  customerId: varchar (FK),\n  name: varchar,\n  description: text,\n  type: 'preventiva' | 'preditiva' | 'inspecao',\n  isActive: boolean,\n  module: 'maintenance'\n}\n```\n\n#### 5. `maintenance_plan_equipments` (Equipamentos no Plano)\n```typescript\n{\n  id: varchar,\n  planId: varchar (FK),\n  equipmentId: varchar (FK),\n  checklistTemplateId: varchar (FK),\n  frequency: 'diaria' | 'semanal' | 'mensal' | 'trimestral',\n  frequencyConfig: jsonb,\n  nextExecutionAt: timestamp,\n  lastExecutionAt: timestamp,\n  isActive: boolean\n}\n```\n\n---\n\n## 5. DECISÕES DE ARQUITETURA\n\n### 5.1 Reutilizar vs Criar Novas Tabelas\n\n**DECISÃO: CRIAR TABELAS ESPECÍFICAS para Manutenção**\n\n**Razões:**\n1. **Isolamento Claro**: `cleaning_activities` é específico de limpeza\n   - Mantém backwards compatibility\n   - Não quebra Clean\n   \n2. **Campos Específicos**: Manutenção precisa de:\n   - `equipmentId` (não existe em cleaning_activities)\n   - `equipmentType`\n   - `technicalSpecs`\n   \n3. **Facilita Evolução**: Cada módulo evolui independentemente\n\n### 5.2 Work Orders: Compartilhar ou Separar?\n\n**DECISÃO: COMPARTILHAR `work_orders` com discriminador `module`**\n\n**Razões:**\n1. Work orders são conceito universal (Clean + Manutenção + futuros módulos)\n2. Relatórios consolidados de todas as ordens\n3. Apenas adicionar campos:\n   - `maintenanceActivityId` (FK para maintenance_plans)\n   - `equipmentId` (FK para equipment)\n\n### 5.3 QR Codes: Zona vs Equipamento\n\n**DECISÃO: QR Codes PODEM ser vinculados a EQUIPAMENTOS**\n\n**Implementação:**\n- Tabela `qr_code_points` já existe\n- Adicionar campo opcional `equipmentId`\n- Quando escanear QR:\n  - Se tem `zoneId` → Clean (limpar zona)\n  - Se tem `equipmentId` → Manutenção (manutenção do equipamento)\n\n---\n\n## 6. CAMPOS A ADICIONAR EM TABELAS EXISTENTES\n\n### 6.1 `work_orders`\n```typescript\n// ADICIONAR:\nmaintenanceActivityId: varchar().references(() => maintenancePlans.id)\nequipmentId: varchar().references(() => equipment.id)\n```\n\n### 6.2 `qr_code_points`\n```typescript\n// ADICIONAR:\nequipmentId: varchar().references(() => equipment.id)\n```\n\n---\n\n## 7. COMPATIBILIDADE E MIGRAÇÃO\n\n### 7.1 Backwards Compatibility\n\n**OPUS Clean continua funcionando 100%:**\n- Todas as tabelas de Clean permanecem\n- `cleaning_activities` não é alterado\n- Páginas `/schedule`, `/checklists` permanecem iguais\n- Rotas de Clean não mudam\n\n### 7.2 Estratégia de Migração\n\n**Fase 1: Adicionar Novas Tabelas**\n```sql\n-- Criar tabelas novas:\nCREATE TABLE equipment (...)\nCREATE TABLE maintenance_checklist_templates (...)\nCREATE TABLE maintenance_checklist_executions (...)\nCREATE TABLE maintenance_plans (...)\nCREATE TABLE maintenance_plan_equipments (...)\n```\n\n**Fase 2: Adicionar Campos Opcionais**\n```sql\n-- work_orders\nALTER TABLE work_orders ADD COLUMN equipment_id VARCHAR;\nALTER TABLE work_orders ADD COLUMN maintenance_activity_id VARCHAR;\n\n-- qr_code_points\nALTER TABLE qr_code_points ADD COLUMN equipment_id VARCHAR;\n```\n\n**Fase 3: Popular Equipamentos (se já existir WOs de manutenção)**\n- Se já existem work orders com `module='maintenance'`:\n  - Criar equipamentos genéricos baseados nas zones\n  - Migrar work orders antigas para novos equipamentos\n\n### 7.3 Rollback Plan\n\nSe der problema:\n1. Manter feature flag `ENABLE_MAINTENANCE_MODULE` = false\n2. Todas as novas tabelas ficam vazias mas não quebram nada\n3. Clean continua operando normalmente\n4. Remover tabelas novas se necessário (sem impacto)\n\n---\n\n## 8. IMPACTO NO SISTEMA\n\n### 8.1 Backend\n\n**Storage Layer (`server/storage.ts`):**\n- ✅ Adicionar interface para equipamentos\n- ✅ Adicionar CRUD de maintenance checklists\n- ✅ Adicionar CRUD de maintenance plans\n- ✅ Atualizar work orders para suportar equipmentId\n\n**Routes (`server/routes.ts`):**\n- ✅ Adicionar rotas de equipamentos\n- ✅ Adicionar rotas de maintenance checklists\n- ✅ Adicionar rotas de maintenance plans\n\n### 8.2 Frontend\n\n**Novas Páginas (só visíveis quando `currentModule === 'maintenance'`):**\n- `/equipment` - Listagem e cadastro de equipamentos\n- `/maintenance-checklists` - Checklists de manutenção\n- `/maintenance-plans` - Planos de manutenção\n- `/maintenance-schedule` - Calendário de manutenções\n\n**Sidebar:**\n- Mostrar itens condicionalmente baseado em `currentModule`\n\n### 8.3 Mobile\n\n**Execução de Manutenção:**\n- `/mobile/qr-scanner` já existe\n- Quando escanear QR de equipamento:\n  - Resolver equipmentId\n  - Criar WO de manutenção\n  - Executar checklist de manutenção\n  - Similar ao fluxo de Clean, mas com dados de equipamento\n\n---\n\n## 9. PRÓXIMOS PASSOS\n\n1. ✅ **Criar schema de manutenção** em `shared/schema.ts`\n2. ✅ **Atualizar Storage Layer** com métodos de manutenção\n3. ✅ **Criar rotas API REST** para equipamentos e planos\n4. ✅ **Implementar páginas frontend** de manutenção\n5. ✅ **Testar isolamento** entre Clean e Manutenção\n6. ✅ **Push schema** e validar em desenvolvimento\n7. ✅ **Documentar** arquitetura final\n\n---\n\n## 10. RESUMO EXECUTIVO\n\n### Estado Atual\n- OPUS Clean funciona baseado em **ZONAS/LOCAIS**\n- Checklists vinculados a zonas\n- Cleaning activities programam trabalhos por zona\n\n### Estado Alvo (Manutenção)\n- OPUS Manutenção funciona baseado em **EQUIPAMENTOS**\n- Checklists vinculados a equipamentos (ou tipos)\n- Maintenance plans programam trabalhos por equipamento\n- Histórico de manutenções rastreável por equipamento\n\n### Isolamento\n- Clean e Manutenção **NÃO se misturam**\n- Compartilham: customers, sites, zones, work_orders (com `module`)\n- Específicos:\n  - Clean: `cleaning_activities`, checklists por zona\n  - Manutenção: `equipment`, `maintenance_plans`, checklists por equipamento\n\n**Zero impacto no OPUS Clean!** ✅\n","size_bytes":11706},"client/src/components/mobile-header.tsx":{"content":"import { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useModule, MODULE_CONFIGS } from \"@/contexts/ModuleContext\";\nimport { ArrowLeft, Wrench, Building } from \"lucide-react\";\nimport { useLocation } from \"wouter\";\n\ninterface MobileHeaderProps {\n  title: string;\n  subtitle?: string;\n  showBack?: boolean;\n  backUrl?: string;\n  actions?: React.ReactNode;\n}\n\nexport function MobileHeader({ title, subtitle, showBack = false, backUrl = \"/mobile\", actions }: MobileHeaderProps) {\n  const [, setLocation] = useLocation();\n  const { currentModule, moduleConfig, hasMultipleModules, canAccessModule } = useModule();\n\n  // Se o usuário não tem acesso ao módulo atual, não renderizar nada (proteção extra)\n  if (!canAccessModule(currentModule)) {\n    return null;\n  }\n\n  const handleBack = () => {\n    setLocation(backUrl);\n  };\n\n  return (\n    <div className={`sticky top-0 z-50 shadow-md ${\n      currentModule === 'maintenance'\n        ? 'bg-gradient-to-r from-orange-500 to-amber-600'\n        : 'bg-gradient-to-r from-blue-600 to-cyan-600'\n    }`}>\n      <div className=\"px-4 py-3\">\n        {/* Linha 1: Navegação e Ações */}\n        <div className=\"flex items-center justify-between mb-2\">\n          <div className=\"flex items-center gap-2\">\n            {showBack && (\n              <Button\n                variant=\"ghost\"\n                size=\"sm\"\n                onClick={handleBack}\n                className=\"text-white hover:bg-white/20 p-2\"\n                data-testid=\"button-back\"\n              >\n                <ArrowLeft className=\"w-5 h-5\" />\n              </Button>\n            )}\n          </div>\n          <div className=\"flex items-center gap-2\">\n            {actions}\n          </div>\n        </div>\n\n        {/* Linha 2: Título e Indicador de Módulo */}\n        <div className=\"flex items-start justify-between gap-3\">\n          <div className=\"flex-1 min-w-0\">\n            <h1 className=\"text-xl font-bold text-white truncate\" data-testid=\"text-page-title\">\n              {title}\n            </h1>\n            {subtitle && (\n              <p className=\"text-sm text-white/90 mt-1\" data-testid=\"text-page-subtitle\">\n                {subtitle}\n              </p>\n            )}\n          </div>\n\n          {/* Indicador de Módulo Ativo */}\n          <Badge \n            variant=\"secondary\"\n            className={`flex items-center gap-1.5 px-3 py-1.5 shrink-0 ${\n              currentModule === 'maintenance'\n                ? 'bg-white text-orange-600 border-orange-300'\n                : 'bg-white text-blue-600 border-blue-300'\n            }`}\n            data-testid=\"badge-current-module\"\n          >\n            {currentModule === 'maintenance' ? (\n              <Wrench className=\"w-3.5 h-3.5\" />\n            ) : (\n              <Building className=\"w-3.5 h-3.5\" />\n            )}\n            <span className=\"text-xs font-semibold\">\n              {currentModule === 'maintenance' ? 'Manutenção' : 'Clean'}\n            </span>\n          </Badge>\n        </div>\n      </div>\n    </div>\n  );\n}\n","size_bytes":3078},"client/src/hooks/useUserModules.ts":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { ModuleType } from \"@/contexts/ModuleContext\";\n\ninterface UserModulesResponse {\n  modules: ModuleType[];\n  defaultModule: ModuleType;\n}\n\n/**\n * Hook para buscar e validar os módulos que o usuário tem permissão de acessar\n */\nexport function useUserModules() {\n  const { user, isAuthenticated } = useAuth();\n\n  const { data, isLoading, error } = useQuery<UserModulesResponse>({\n    queryKey: ['/api/auth/user-modules'],\n    enabled: !!user && isAuthenticated,\n    staleTime: 5 * 60 * 1000, // 5 minutos\n  });\n\n  // Normalizar: garantir que sempre tenha pelo menos um módulo\n  const rawModules = data?.modules || [];\n  const allowedModules: ModuleType[] = rawModules.length > 0 ? rawModules : ['clean'];\n  const defaultModule: ModuleType = data?.defaultModule || 'clean';\n  const hasMultipleModules = allowedModules.length > 1;\n  const hasSingleModule = allowedModules.length === 1;\n\n  /**\n   * Verifica se o usuário tem permissão para acessar um módulo específico\n   */\n  const canAccessModule = (module: ModuleType): boolean => {\n    if (!data) return false;\n    return allowedModules.includes(module);\n  };\n\n  /**\n   * Retorna o módulo que deve ser usado (valida se o atual é permitido)\n   */\n  const getValidModule = (currentModule: ModuleType): ModuleType => {\n    if (canAccessModule(currentModule)) {\n      return currentModule;\n    }\n    return defaultModule;\n  };\n\n  return {\n    allowedModules,\n    defaultModule,\n    hasMultipleModules,\n    hasSingleModule,\n    canAccessModule,\n    getValidModule,\n    isLoading,\n    error,\n  };\n}\n","size_bytes":1652},"client/src/pages/module-selection.tsx":{"content":"import { useEffect, useState } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Building, Wrench, Loader2 } from \"lucide-react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { useModule } from \"@/contexts/ModuleContext\";\nimport { useAuth } from \"@/hooks/useAuth\";\n\ninterface Customer {\n  id: string;\n  name: string;\n  isActive: boolean;\n  modules: string[];\n}\n\nexport default function ModuleSelection() {\n  const [, setLocation] = useLocation();\n  const { setModule } = useModule();\n  const [isLoading, setIsLoading] = useState(false);\n  const { user } = useAuth();\n\n  const companyId = user?.companyId || \"company-opus-default\";\n  const isCustomerUser = user?.userType === 'customer_user';\n  const userCustomerId = user?.customerId;\n\n  // Get available modules for the user\n  const { data: modulesData, isLoading: isLoadingModules } = useQuery<{ modules: string[]; defaultModule: string }>({\n    queryKey: [\"/api/auth/user-modules\"],\n  });\n\n  // Get all customers for the user's company (only for admin/opus users)\n  const { data: allCustomers = [], isLoading: isLoadingCustomers } = useQuery<Customer[]>({\n    queryKey: [\"/api/companies\", companyId, \"customers\"],\n    enabled: !isCustomerUser && !!companyId,\n  });\n\n  const availableModules = modulesData?.modules || [];\n  const activeCustomers = (allCustomers as Customer[]).filter(c => c.isActive);\n\n  useEffect(() => {\n    // If user only has access to one module, redirect automatically\n    if (availableModules.length === 1) {\n      const module = availableModules[0] as 'clean' | 'maintenance';\n      handleModuleSelect(module);\n    }\n  }, [availableModules]);\n\n  // Check if user is authenticated\n  useEffect(() => {\n    if (!user) {\n      setLocation(\"/login\");\n    }\n  }, [user, setLocation]);\n\n  const handleModuleSelect = async (module: 'clean' | 'maintenance') => {\n    setIsLoading(true);\n    setModule(module);\n    \n    // For customer_user, use their own customer ID\n    if (isCustomerUser && userCustomerId) {\n      localStorage.setItem('opus:activeClientId', userCustomerId);\n      setTimeout(() => setLocation(\"/\"), 300);\n      return;\n    }\n\n    // For admin/opus users, find a customer with the selected module\n    const customersWithModule = activeCustomers.filter(customer => \n      customer.modules.includes(module)\n    );\n\n    if (customersWithModule.length > 0) {\n      // Select the first customer that has the module\n      const selectedCustomer = customersWithModule[0];\n      localStorage.setItem('opus:activeClientId', selectedCustomer.id);\n      console.log(`[MODULE SELECTION] Módulo ${module} selecionado. Cliente ativo: ${selectedCustomer.name}`);\n    } else {\n      console.warn(`[MODULE SELECTION] Nenhum cliente encontrado com o módulo ${module}`);\n    }\n    \n    // Small delay for better UX\n    setTimeout(() => {\n      setLocation(\"/\");\n    }, 300);\n  };\n\n  if (isLoadingModules) {\n    return (\n      <div className=\"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 flex items-center justify-center\">\n        <div className=\"text-center\">\n          <Loader2 className=\"h-12 w-12 animate-spin text-blue-600 mx-auto mb-4\" />\n          <p className=\"text-slate-600\">Carregando módulos...</p>\n        </div>\n      </div>\n    );\n  }\n\n  // If user only has one module, show loading while redirecting\n  if (availableModules.length === 1) {\n    return (\n      <div className=\"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 flex items-center justify-center\">\n        <div className=\"text-center\">\n          <Loader2 className=\"h-12 w-12 animate-spin text-blue-600 mx-auto mb-4\" />\n          <p className=\"text-slate-600\">Redirecionando...</p>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-slate-50 via-slate-100 to-slate-200 flex items-center justify-center p-4 md:p-8\">\n      <div className=\"w-full max-w-6xl\">\n        {/* Header */}\n        <div className=\"text-center mb-16\" data-testid=\"header-module-selection\">\n          <h1 className=\"text-5xl md:text-6xl font-bold text-slate-900 mb-4 tracking-tight\">\n            Plataforma OPUS\n          </h1>\n          <p className=\"text-xl text-slate-600 font-medium\">\n            Selecione o módulo que deseja acessar\n          </p>\n        </div>\n\n        {/* Module Cards Grid */}\n        <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12 max-w-5xl mx-auto\">\n          {/* OPUS Clean Card */}\n          {availableModules.includes('clean') && (\n            <div \n              onClick={() => !isLoading && handleModuleSelect('clean')}\n              className=\"group relative\"\n              data-testid=\"card-module-clean\"\n            >\n              <Card className=\"relative overflow-hidden border-2 border-slate-200 hover:border-blue-400 shadow-lg hover:shadow-2xl transition-all duration-500 cursor-pointer bg-white\">\n                {/* Gradient Background Effect */}\n                <div className=\"absolute inset-0 bg-gradient-to-br from-blue-50/50 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500\" />\n                \n                <CardContent className=\"relative p-10 md:p-12 text-center\">\n                  {/* Icon */}\n                  <div className=\"mb-8 flex justify-center\">\n                    <div className=\"w-32 h-32 rounded-full bg-gradient-to-br from-blue-100 to-blue-200 group-hover:from-blue-200 group-hover:to-blue-300 transition-all duration-500 flex items-center justify-center shadow-md group-hover:shadow-xl group-hover:scale-110\">\n                      <Building className=\"h-16 w-16 text-blue-600\" strokeWidth={2.5} />\n                    </div>\n                  </div>\n\n                  {/* Title */}\n                  <h2 className=\"text-3xl md:text-4xl font-bold text-blue-900 mb-4\" data-testid=\"text-module-clean-title\">\n                    OPUS Clean\n                  </h2>\n\n                  {/* Description */}\n                  <p className=\"text-lg text-slate-600 mb-8 font-medium\" data-testid=\"text-module-clean-description\">\n                    Gestão de Limpeza e Facilities\n                  </p>\n\n                  {/* Button */}\n                  <Button\n                    disabled={isLoading}\n                    className=\"w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-7 text-lg rounded-xl shadow-md hover:shadow-xl transition-all duration-300 transform hover:scale-105\"\n                    data-testid=\"button-select-clean\"\n                  >\n                    {isLoading ? (\n                      <>\n                        <Loader2 className=\"mr-2 h-6 w-6 animate-spin\" />\n                        Carregando...\n                      </>\n                    ) : (\n                      'Acessar OPUS Clean'\n                    )}\n                  </Button>\n                </CardContent>\n              </Card>\n            </div>\n          )}\n\n          {/* OPUS Manutenção Card */}\n          {availableModules.includes('maintenance') && (\n            <div \n              onClick={() => !isLoading && handleModuleSelect('maintenance')}\n              className=\"group relative\"\n              data-testid=\"card-module-maintenance\"\n            >\n              <Card className=\"relative overflow-hidden border-2 border-slate-200 hover:border-orange-400 shadow-lg hover:shadow-2xl transition-all duration-500 cursor-pointer bg-white\">\n                {/* Gradient Background Effect */}\n                <div className=\"absolute inset-0 bg-gradient-to-br from-orange-50/50 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500\" />\n                \n                <CardContent className=\"relative p-10 md:p-12 text-center\">\n                  {/* Icon */}\n                  <div className=\"mb-8 flex justify-center\">\n                    <div className=\"w-32 h-32 rounded-full bg-gradient-to-br from-orange-100 to-orange-200 group-hover:from-orange-200 group-hover:to-orange-300 transition-all duration-500 flex items-center justify-center shadow-md group-hover:shadow-xl group-hover:scale-110\">\n                      <Wrench className=\"h-16 w-16 text-orange-600\" strokeWidth={2.5} />\n                    </div>\n                  </div>\n\n                  {/* Title */}\n                  <h2 className=\"text-3xl md:text-4xl font-bold text-orange-900 mb-4\" data-testid=\"text-module-maintenance-title\">\n                    OPUS Manutenção\n                  </h2>\n\n                  {/* Description */}\n                  <p className=\"text-lg text-slate-600 mb-8 font-medium\" data-testid=\"text-module-maintenance-description\">\n                    Gestão de Manutenção\n                  </p>\n\n                  {/* Button */}\n                  <Button\n                    disabled={isLoading}\n                    className=\"w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-7 text-lg rounded-xl shadow-md hover:shadow-xl transition-all duration-300 transform hover:scale-105\"\n                    data-testid=\"button-select-maintenance\"\n                  >\n                    {isLoading ? (\n                      <>\n                        <Loader2 className=\"mr-2 h-6 w-6 animate-spin\" />\n                        Carregando...\n                      </>\n                    ) : (\n                      'Acessar OPUS Manutenção'\n                    )}\n                  </Button>\n                </CardContent>\n              </Card>\n            </div>\n          )}\n        </div>\n\n        {/* Footer */}\n        <div className=\"text-center text-base text-slate-500 font-medium\" data-testid=\"text-footer\">\n          Sistema modular de gestão de facilities\n        </div>\n      </div>\n    </div>\n  );\n}\n","size_bytes":9804},"DOCUMENTATION.md":{"content":"# OPUS - Documentação Técnica Completa\n\n**Última atualização**: 04 de Novembro de 2025  \n**Versão**: 1.0\n\n---\n\n## 📋 Índice\n\n1. [Visão Geral do Sistema](#visão-geral-do-sistema)\n2. [Arquitetura Técnica](#arquitetura-técnica)\n3. [Modelo de Dados](#modelo-de-dados)\n4. [Funcionalidades Principais](#funcionalidades-principais)\n5. [Estrutura do Código](#estrutura-do-código)\n6. [Fluxos de Funcionamento](#fluxos-de-funcionamento)\n7. [Guia de Desenvolvimento](#guia-de-desenvolvimento)\n8. [Changelog](#changelog)\n\n---\n\n## 🎯 Visão Geral do Sistema\n\n### O que é OPUS?\n\nOPUS é uma plataforma modular de gestão de facilities que oferece soluções para diferentes áreas operacionais:\n\n- **OPUS Clean**: Gestão de limpeza e facilities\n- **OPUS Manutenção**: Gestão de manutenção e equipamentos\n\n### Características Principais\n\n- ✅ **Multi-tenant**: Suporta múltiplas empresas, clientes, locais e zonas\n- ✅ **Multi-módulo**: Arquitetura modular com isolamento completo de dados\n- ✅ **Web + Mobile**: Interface administrativa web e aplicativos móveis\n- ✅ **QR Code Based**: Execução de tarefas e solicitações públicas via QR codes\n- ✅ **Real-time Analytics**: Dashboards e relatórios em tempo real\n- ✅ **SSO Integration**: Suporte a Microsoft Entra ID e autenticação local\n\n---\n\n## 🏗️ Arquitetura Técnica\n\n### Stack Tecnológica\n\n#### Frontend\n- **Framework**: React 18 + TypeScript\n- **Build Tool**: Vite\n- **Roteamento**: Wouter\n- **State Management**: TanStack Query v5\n- **UI Components**: shadcn/ui (Radix UI + Tailwind CSS)\n- **Forms**: React Hook Form + Zod\n- **Icons**: Lucide React\n\n#### Backend\n- **Runtime**: Node.js\n- **Framework**: Express.js\n- **Language**: TypeScript\n- **ORM**: Drizzle ORM\n- **Database**: PostgreSQL (Neon Serverless)\n- **Auth**: JWT + Passport.js + Bcrypt\n- **Security**: Helmet, CORS, Rate Limiting\n\n### Arquitetura em Camadas\n\n```\n┌─────────────────────────────────────────┐\n│         Frontend (React + Vite)         │\n│  - Pages, Components, Contexts, Hooks   │\n└──────────────────┬──────────────────────┘\n                   │ HTTP/REST API\n┌──────────────────┴──────────────────────┐\n│       Backend (Express + TypeScript)    │\n│  - Routes (API Endpoints)               │\n│  - Storage Interface (Data Layer)       │\n│  - Auth Middleware                      │\n└──────────────────┬──────────────────────┘\n                   │ Drizzle ORM\n┌──────────────────┴──────────────────────┐\n│      Database (PostgreSQL/Neon)         │\n│  - Tables, Relations, Indexes           │\n└─────────────────────────────────────────┘\n```\n\n### Estrutura de Diretórios\n\n```\nproject-root/\n├── client/                     # Frontend\n│   ├── src/\n│   │   ├── components/         # Componentes reutilizáveis\n│   │   │   ├── layout/         # Header, Sidebar, etc.\n│   │   │   └── ui/             # shadcn components\n│   │   ├── contexts/           # React Contexts\n│   │   │   ├── AuthContext.tsx         # Autenticação\n│   │   │   ├── ClientContext.tsx       # Cliente ativo\n│   │   │   └── ModuleContext.tsx       # Módulo ativo\n│   │   ├── hooks/              # Custom hooks\n│   │   ├── lib/                # Utilitários\n│   │   │   └── queryClient.ts  # TanStack Query config\n│   │   ├── pages/              # Páginas da aplicação\n│   │   ├── App.tsx             # Root component + rotas\n│   │   └── index.css           # Estilos globais + tema\n│   └── index.html\n├── server/                     # Backend\n│   ├── auth.ts                 # Estratégias de autenticação\n│   ├── index.ts                # Entry point\n│   ├── routes.ts               # Definição de rotas API\n│   ├── storage.ts              # Interface de dados\n│   └── vite.ts                 # Integração Vite\n├── shared/                     # Código compartilhado\n│   └── schema.ts               # Schema Drizzle + tipos\n└── db/                         # Migrations (geradas)\n```\n\n---\n\n## 📊 Modelo de Dados\n\n### Hierarquia Multi-Tenant\n\n```\nCompanies (Empresas)\n    ↓\nCustomers (Clientes)\n    ↓\nSites (Locais)\n    ↓\nZones (Zonas)\n```\n\n### Principais Tabelas\n\n#### 1. **companies** (Empresas)\nRepresenta a empresa proprietária do sistema (ex: OPUS).\n\n```typescript\n{\n  id: string (PK)\n  name: string\n  cnpj: string (unique)\n  isActive: boolean\n  createdAt: timestamp\n}\n```\n\n#### 2. **customers** (Clientes)\nClientes que utilizam o sistema (ex: FAURECIA, TECNOFIBRA).\n\n```typescript\n{\n  id: string (PK)\n  companyId: string (FK → companies)\n  name: string\n  tradeName: string\n  cnpj: string (unique)\n  modules: text[] // ['clean', 'maintenance']\n  isActive: boolean\n  createdAt: timestamp\n}\n```\n\n**Campo Crítico**: `modules` - Define quais módulos o cliente tem acesso.\n\n#### 3. **sites** (Locais)\nLocalidades físicas do cliente.\n\n```typescript\n{\n  id: string (PK)\n  customerId: string (FK → customers)\n  name: string\n  address: string\n  isActive: boolean\n  createdAt: timestamp\n}\n```\n\n#### 4. **zones** (Zonas)\nÁreas específicas dentro de um local (ex: \"Térreo - Recepção\").\n\n```typescript\n{\n  id: string (PK)\n  siteId: string (FK → sites)\n  customerId: string (FK → customers)\n  module: 'clean' | 'maintenance' // ISOLAMENTO POR MÓDULO\n  name: string\n  floor: string\n  isActive: boolean\n  createdAt: timestamp\n}\n```\n\n**Campo Crítico**: `module` - Isola zonas por módulo.\n\n#### 5. **users** (Usuários)\nTodos os usuários do sistema.\n\n```typescript\n{\n  id: string (PK)\n  email: string (unique)\n  password: string (hashed)\n  name: string\n  role: 'admin' | 'manager' | 'operator' | 'viewer'\n  userType: 'opus_user' | 'customer_user'\n  assignedClientId: string (FK → customers) // Para customer_user\n  authProvider: 'local' | 'microsoft'\n  modules: text[] // Para opus_user apenas\n  isActive: boolean\n  createdAt: timestamp\n}\n```\n\n**Regra Importante**:\n- `opus_user`: módulos definidos em `users.modules`\n- `customer_user`: módulos herdados de `customers.modules` (via `assignedClientId`)\n\n#### 6. **service_types** (Tipos de Serviço)\nCategorias principais de serviços (ex: \"Limpeza Geral\", \"Manutenção Preventiva\").\n\n```typescript\n{\n  id: string (PK)\n  customerId: string (FK → customers)\n  module: 'clean' | 'maintenance' // ISOLAMENTO POR MÓDULO\n  name: string\n  description: string\n  code: string (unique)\n  isActive: boolean\n  createdAt: timestamp\n}\n```\n\n#### 7. **service_categories** (Categorias de Serviço)\nSubcategorias de serviços.\n\n```typescript\n{\n  id: string (PK)\n  typeId: string (FK → service_types)\n  customerId: string (FK → customers)\n  module: 'clean' | 'maintenance' // ISOLAMENTO POR MÓDULO\n  name: string\n  description: string\n  code: string\n  isActive: boolean\n  createdAt: timestamp\n}\n```\n\n#### 8. **work_orders** (Ordens de Serviço)\nCore do sistema - registros de trabalho.\n\n```typescript\n{\n  id: string (PK)\n  customerId: string (FK → customers)\n  siteId: string (FK → sites)\n  zoneId: string (FK → zones)\n  module: 'clean' | 'maintenance' // ISOLAMENTO POR MÓDULO\n  orderType: 'programmed' | 'internal_corrective' | 'public_corrective'\n  status: 'pending' | 'in_progress' | 'completed' | 'cancelled'\n  priority: 'low' | 'medium' | 'high' | 'urgent'\n  title: string\n  description: string\n  assignedUserId: string (FK → users)\n  scheduledDate: timestamp\n  completedAt: timestamp\n  slaDeadline: timestamp\n  createdAt: timestamp\n}\n```\n\n#### 9. **qr_codes** (QR Codes)\nCódigos QR para execução e solicitações.\n\n```typescript\n{\n  id: string (PK)\n  customerId: string (FK → customers)\n  siteId: string (FK → sites)\n  zoneId: string (FK → zones)\n  module: 'clean' | 'maintenance' // ISOLAMENTO POR MÓDULO\n  qrType: 'execution' | 'public'\n  code: string (unique)\n  isActive: boolean\n  createdAt: timestamp\n}\n```\n\n**Tipos**:\n- `execution`: Para equipes internas executarem ordens\n- `public`: Para usuários finais solicitarem serviços\n\n#### 10. **equipment** (Equipamentos - Manutenção)\nEquipamentos gerenciados no módulo de manutenção.\n\n```typescript\n{\n  id: string (PK)\n  customerId: string (FK → customers)\n  siteId: string (FK → sites)\n  zoneId: string (FK → zones)\n  name: string\n  description: string\n  serialNumber: string\n  manufacturer: string\n  model: string\n  isActive: boolean\n  createdAt: timestamp\n}\n```\n\n#### 11. **equipment_tags** (Tags de Equipamento)\nSistema de tags para categorização flexível.\n\n```typescript\n{\n  id: string (PK)\n  customerId: string (FK → customers)\n  module: 'clean' | 'maintenance' // ISOLAMENTO POR MÓDULO\n  name: string\n  description: string\n  createdAt: timestamp\n}\n```\n\n#### 12. **maintenance_plans** (Planos de Manutenção)\nPlanos de manutenção programada.\n\n```typescript\n{\n  id: string (PK)\n  customerId: string (FK → customers)\n  name: string\n  description: string\n  frequency: 'daily' | 'weekly' | 'shift_based' | 'monthly' | 'quarterly' | 'semi_annual' | 'annual'\n  shift: 'morning' | 'afternoon' | 'night' (para shift_based)\n  dayOfWeek: number (para weekly)\n  dayOfMonth: number (para monthly)\n  isActive: boolean\n  createdAt: timestamp\n}\n```\n\n### Relações Principais\n\n```\ncompanies 1───N customers\ncustomers 1───N sites\nsites 1───N zones\ncustomers 1───N users (customer_user)\ncustomers 1───N service_types\nservice_types 1───N service_categories\ncustomers 1───N work_orders\nsites 1───N work_orders\nzones 1───N work_orders\nusers 1───N work_orders (assigned)\n```\n\n---\n\n## ⚙️ Funcionalidades Principais\n\n### 1. Multi-Tenancy Hierárquico\n\n**Estrutura**: Companies → Customers → Sites → Zones\n\n**Isolamento de Dados**:\n- Cada cliente vê apenas seus dados\n- Filtragem automática por `customerId` em todas as queries\n- Validação backend em todas as operações CRUD\n\n**Implementação**:\n```typescript\n// Frontend: ClientContext.tsx\nconst { activeClientId } = useClient();\n\n// Backend: routes.ts\nconst customerId = req.user.userType === 'customer_user' \n  ? req.user.assignedClientId \n  : req.query.customerId;\n```\n\n### 2. Sistema de Módulos\n\n**Módulos Disponíveis**:\n- `clean`: OPUS Clean (limpeza e facilities)\n- `maintenance`: OPUS Manutenção (equipamentos)\n\n**Isolamento Total**:\n- Tabelas com campo `module`: zones, service_types, service_categories, work_orders, qr_codes, equipment_tags, etc.\n- Filtragem automática por módulo ativo\n- Validação de acesso em cada rota\n\n**Controle de Acesso**:\n```typescript\n// Customer modules (nível cliente)\ncustomer.modules = ['clean', 'maintenance']\n\n// User modules (herança)\nif (user.userType === 'customer_user') {\n  userModules = customer.modules // Herda do cliente\n} else {\n  userModules = user.modules // Próprio\n}\n```\n\n**Proteção de Rotas**:\n- Frontend: `ModuleContext` auto-corrige módulo inválido\n- Backend: Valida módulo em operações de create/update\n- UI: Esconde/mostra seletor de módulo baseado em permissões\n\n**Implementação Frontend**:\n```typescript\n// ModuleContext.tsx\nuseEffect(() => {\n  if (!availableModules.includes(currentModule)) {\n    setCurrentModule(availableModules[0] || 'clean');\n  }\n}, [activeClientId, availableModules]);\n```\n\n**Implementação Backend** (Exemplo: service-categories):\n```typescript\n// CREATE\nconst newCategory = {\n  ...data,\n  module: currentModule, // Módulo ativo\n  customerId\n};\n\n// READ\nWHERE customerId = ? AND module = ?\n```\n\n### 3. Autenticação e Autorização\n\n#### Provedores de Auth\n- **Local**: Email + senha (Bcrypt)\n- **Microsoft SSO**: Entra ID (OpenID Connect)\n\n#### Tipos de Usuário\n\n**opus_user** (Usuário OPUS):\n- Pertence à empresa OPUS\n- Pode acessar múltiplos clientes (seleção via dropdown)\n- Módulos definidos em `users.modules`\n- Roles: admin, manager, viewer\n\n**customer_user** (Usuário do Cliente):\n- Pertence a um cliente específico (`assignedClientId`)\n- Acesso fixo ao seu cliente\n- Módulos herdados de `customers.modules`\n- Roles: admin, manager, operator, viewer\n\n#### Roles e Permissões\n\n```typescript\nRole: 'admin'\n  - Acesso total ao sistema\n  - Configurações, usuários, relatórios\n\nRole: 'manager'\n  - Gestão operacional\n  - Criação de ordens, acompanhamento\n\nRole: 'operator'\n  - Execução de tarefas\n  - Mobile app, QR scanning\n\nRole: 'viewer'\n  - Somente leitura\n  - Dashboards, relatórios\n```\n\n#### Fluxo de Autenticação\n\n```\n1. Login → POST /api/auth/login\n2. Validação (local ou Microsoft)\n3. Geração de JWT token\n4. Frontend armazena token\n5. Requisições incluem: Authorization: Bearer <token>\n6. Backend valida token em middleware\n```\n\n**Middleware**: `requireAuth` em todas as rotas protegidas.\n\n### 4. Sistema de QR Codes\n\n#### Tipos de QR Code\n\n**Execution QR** (Execução Interna):\n- Para equipes internas\n- Vinculado a zona específica\n- Escanear → Listar ordens da zona → Executar\n\n**Public QR** (Solicitação Pública):\n- Para usuários finais\n- Qualquer pessoa pode escanear\n- Escanear → Formulário → Gera ordem corretiva\n\n#### Fluxo de Uso\n\n```\nQR Code Execution:\n1. Operador escaneia QR\n2. Sistema identifica zona\n3. Lista ordens pendentes da zona\n4. Operador seleciona e executa\n5. Preenche checklist (se houver)\n6. Finaliza com foto/assinatura\n\nQR Code Public:\n1. Usuário escaneia QR público\n2. Abre formulário de solicitação\n3. Descreve problema + foto\n4. Submit\n5. Sistema cria work_order (public_corrective)\n6. Notifica equipe responsável\n```\n\n### 5. Gestão de Ordens de Serviço\n\n#### Tipos de Ordem\n\n```typescript\n'programmed'           // Programadas (calendário)\n'internal_corrective'  // Corretivas internas\n'public_corrective'    // Solicitações públicas (via QR)\n```\n\n#### Status Lifecycle\n\n```\npending → in_progress → completed\n           ↓\n        cancelled\n```\n\n#### SLA e Prioridades\n\n**Prioridades**:\n- `urgent`: Crítico, resolver ASAP\n- `high`: Alta prioridade\n- `medium`: Prioridade média\n- `low`: Pode aguardar\n\n**SLA**: \n- Configurável por categoria de serviço\n- Campo `slaDeadline` calcula prazo\n- Dashboard mostra % conformidade\n\n#### Reabertura de Ordens\n\n- Ordens completadas podem ser reabertas\n- Histórico mantido em comentários\n- Útil para retrabalho ou problemas recorrentes\n\n### 6. Sistema de Tags (Equipamentos)\n\n**Objetivo**: Categorização flexível de equipamentos.\n\n**Funcionamento**:\n```typescript\n// Tag examples\ntags = [\"Cafeteira\", \"Ar Condicionado\", \"Impressora\"]\n\n// Equipment association\nequipment.tags = [tagId1, tagId2]\n\n// Maintenance template targeting\ntemplate.targetType = 'tag_based'\ntemplate.targetTagIds = [tagId1]\n// Aplica template a TODOS equipamentos com essa tag\n```\n\n**Vantagens**:\n- Gestão em massa de equipamentos similares\n- Templates reutilizáveis\n- Facilita manutenção preventiva\n\n### 7. Geração Automática de Ordens Mensais\n\n**Estratégia Dual**:\n\n1. **Visualização Virtual** (Calendar):\n   - Frontend calcula ordens futuras baseado em `maintenance_plans`\n   - Mostra 12 meses no calendário\n   - Sem overhead no banco\n\n2. **Persistência Deferred** (Database):\n   - Scheduler roda último dia do mês às 23:00\n   - Gera ordens do mês seguinte no banco\n   - Apenas próximo mês persiste\n\n**Implementação**:\n```typescript\n// server/index.ts\ncron.schedule('0 23 L * *', async () => {\n  // Gera ordens para próximo mês\n  await generateMonthlyWorkOrders();\n});\n```\n\n### 8. Dashboard e Analytics\n\n**Métricas Principais**:\n- Total de ordens (por status, prioridade)\n- Taxa de conclusão no prazo (SLA)\n- Distribuição por local/zona\n- Tempo médio de conclusão\n- Tendências (gráficos de linha)\n\n**Metas Dashboard**:\n- Configuráveis por cliente\n- Tipos: completion_rate, response_time, satisfaction\n- Indicadores visuais (verde/amarelo/vermelho)\n\n**Implementação**:\n- Queries em tempo real (PostgreSQL)\n- TanStack Query com cache\n- Recharts para visualização\n\n---\n\n## 📂 Estrutura do Código\n\n### Frontend Architecture\n\n#### Contexts (Estado Global)\n\n**AuthContext.tsx**:\n```typescript\n// Gerencia autenticação\n{\n  user: User | null\n  login(email, password)\n  loginWithMicrosoft()\n  logout()\n  isLoading: boolean\n}\n```\n\n**ClientContext.tsx**:\n```typescript\n// Gerencia cliente ativo (para opus_user)\n{\n  activeClientId: string | null\n  setActiveClientId(id: string)\n  availableClients: Customer[]\n}\n```\n\n**ModuleContext.tsx**:\n```typescript\n// Gerencia módulo ativo\n{\n  currentModule: 'clean' | 'maintenance'\n  setCurrentModule(module)\n  availableModules: string[]\n}\n\n// Auto-correção quando módulo inválido\nuseEffect(() => {\n  if (!availableModules.includes(currentModule)) {\n    setCurrentModule(availableModules[0]);\n  }\n}, [activeClientId, availableModules]);\n```\n\n#### Custom Hooks\n\n**useUserModules.ts**:\n```typescript\n// Busca módulos do usuário\nfunction useUserModules() {\n  return useQuery({\n    queryKey: ['/api/auth/user-modules'],\n    // Retorna módulos baseado em userType\n  });\n}\n```\n\n#### Pages (Rotas Principais)\n\n```\n/                        → Dashboard\n/work-orders             → Lista de ordens\n/work-orders/:id         → Detalhes da ordem\n/sites                   → Gestão de locais\n/zones                   → Gestão de zonas\n/services                → Gestão de serviços\n/equipment               → Gestão de equipamentos (maintenance)\n/maintenance-plans       → Planos de manutenção (maintenance)\n/qr-codes                → Gestão de QR codes\n/users                   → Gestão de usuários\n/settings                → Configurações\n/login                   → Autenticação\n/mobile/*                → Rotas mobile\n```\n\n#### Components Structure\n\n```\ncomponents/\n├── layout/\n│   ├── header.tsx          # Cabeçalho com logout\n│   └── sidebar.tsx         # Menu lateral + module selector\n└── ui/                     # shadcn components\n    ├── button.tsx\n    ├── dialog.tsx\n    ├── form.tsx\n    └── ... (30+ components)\n```\n\n### Backend Architecture\n\n#### Routes (server/routes.ts)\n\n**Padrão de Organização**:\n```typescript\n// Auth\nPOST   /api/auth/login\nPOST   /api/auth/login/microsoft\nPOST   /api/auth/logout\nGET    /api/auth/user\nGET    /api/auth/user-modules\n\n// Customers\nGET    /api/customers\nPOST   /api/customers\nGET    /api/customers/:id\nPUT    /api/customers/:id\nDELETE /api/customers/:id\n\n// Sites\nGET    /api/customers/:customerId/sites\nPOST   /api/customers/:customerId/sites\nPUT    /api/customers/:customerId/sites/:id\nDELETE /api/customers/:customerId/sites/:id\n\n// Work Orders\nGET    /api/customers/:customerId/work-orders\nPOST   /api/customers/:customerId/work-orders\nGET    /api/work-orders/:id\nPUT    /api/work-orders/:id\nDELETE /api/work-orders/:id\n```\n\n**Middleware Stack**:\n```typescript\napp.use(helmet());              // Security headers\napp.use(cors());                // CORS\napp.use(rateLimiter);           // Rate limiting\napp.use(express.json());        // JSON parser\napp.use(session());             // Session\napp.use(passport.initialize()); // Auth\n```\n\n#### Storage Layer (server/storage.ts)\n\n**Interface Pattern**:\n```typescript\ninterface IStorage {\n  // Users\n  getUsers(filters): Promise<User[]>\n  getUserById(id): Promise<User>\n  createUser(data): Promise<User>\n  updateUser(id, data): Promise<User>\n  deleteUser(id): Promise<void>\n  \n  // Work Orders\n  getWorkOrders(filters): Promise<WorkOrder[]>\n  // ... CRUD methods\n  \n  // Etc for all entities\n}\n```\n\n**Implementação PostgreSQL**:\n```typescript\nclass PostgresStorage implements IStorage {\n  async getWorkOrders(filters) {\n    return await db\n      .select()\n      .from(workOrders)\n      .where(and(\n        eq(workOrders.customerId, filters.customerId),\n        eq(workOrders.module, filters.module)\n      ));\n  }\n}\n```\n\n### Shared Schema (shared/schema.ts)\n\n**Estrutura**:\n```typescript\n// 1. Enums\nexport const moduleEnum = pgEnum('module', ['clean', 'maintenance']);\nexport const userRoleEnum = pgEnum('user_role', ['admin', 'manager', 'operator', 'viewer']);\n\n// 2. Tables\nexport const customers = pgTable('customers', { ... });\nexport const sites = pgTable('sites', { ... });\nexport const zones = pgTable('zones', { ... });\nexport const workOrders = pgTable('work_orders', { ... });\n\n// 3. Relations\nexport const customersRelations = relations(customers, ({ many }) => ({\n  sites: many(sites),\n  users: many(users),\n  workOrders: many(workOrders)\n}));\n\n// 4. Zod Schemas\nexport const insertCustomerSchema = createInsertSchema(customers).omit({ id: true });\nexport type InsertCustomer = z.infer<typeof insertCustomerSchema>;\nexport type Customer = typeof customers.$inferSelect;\n```\n\n---\n\n## 🔄 Fluxos de Funcionamento\n\n### Fluxo 1: Login e Seleção de Módulo\n\n```\n1. Usuário acessa /login\n2. Escolhe método (email/password ou Microsoft SSO)\n3. Backend valida credenciais\n4. Gera JWT token\n5. Frontend armazena token + user data\n6. Redirect para /\n\n7. AuthContext carrega user\n8. ClientContext carrega clientes disponíveis\n9. ModuleContext carrega módulos do usuário\n   - customer_user: herda de customer.modules\n   - opus_user: usa user.modules\n\n10. Se opus_user: mostra dropdown de clientes\n11. Se customer_user: cliente fixo\n\n12. Sidebar verifica módulos disponíveis:\n    - Se 1 módulo: esconde seletor\n    - Se 2+ módulos: mostra dropdown\n\n13. Usuário seleciona módulo (se disponível)\n14. Sistema filtra dados pelo módulo ativo\n```\n\n### Fluxo 2: Criar Ordem de Serviço Programada\n\n```\n1. Manager acessa /work-orders\n2. Clica \"Nova Ordem\"\n3. Dialog abre\n\n4. Preenche form:\n   - Tipo: \"Programada\"\n   - Local: [dropdown filtrado por cliente]\n   - Zona: [dropdown filtrado por local + módulo]\n   - Categoria: [dropdown filtrado por cliente + módulo]\n   - Título, Descrição\n   - Data agendada\n   - Prioridade\n   - Operador: [dropdown de users com role operator]\n\n5. Submit form\n\n6. Frontend valida (Zod)\n7. POST /api/customers/:id/work-orders\n   {\n     ...formData,\n     module: currentModule, // Adiciona módulo\n     orderType: 'programmed',\n     status: 'pending'\n   }\n\n8. Backend valida:\n   - Usuário tem permissão?\n   - Cliente existe?\n   - Zona pertence ao cliente?\n   - Módulo da zona === módulo enviado?\n\n9. Se OK:\n   - Calcula slaDeadline (baseado em categoria)\n   - Insere no banco\n   - Retorna ordem criada\n\n10. Frontend:\n    - Invalida cache\n    - Fecha dialog\n    - Mostra toast \"Ordem criada!\"\n    - Lista atualiza automaticamente\n```\n\n### Fluxo 3: Execução via QR Code (Mobile)\n\n```\n1. Operador abre app mobile\n2. Navega para /mobile/scanner\n3. Escaneia QR code (execution)\n\n4. App decodifica: qrCode.id\n5. GET /api/qr-codes/:id/scan\n   - Backend retorna: qrCode + zone + pending work orders\n\n6. App mostra lista de ordens pendentes da zona\n7. Operador seleciona uma ordem\n\n8. Carrega checklist (se houver)\n9. Operador preenche checklist:\n   - Marca itens como OK/NOK\n   - Adiciona observações\n   - Tira fotos\n\n10. Operador clica \"Finalizar\"\n\n11. App envia:\n    PUT /api/work-orders/:id\n    {\n      status: 'completed',\n      completedAt: now(),\n      checklistData: [...],\n      photos: [...]\n    }\n\n12. Backend:\n    - Valida operador\n    - Atualiza ordem\n    - Armazena checklist\n    - Upload de fotos\n\n13. App mostra \"Ordem finalizada!\"\n14. Retorna para lista de ordens\n```\n\n### Fluxo 4: Solicitação Pública via QR Code\n\n```\n1. Usuário final escaneia QR público (celular comum)\n2. Abre URL: /public/qr/:code\n\n3. Frontend:\n   - Não requer login\n   - GET /api/public/qr/:code\n   - Carrega info da zona\n\n4. Mostra formulário:\n   - \"O que está acontecendo?\"\n   - Descrição (textarea)\n   - Anexar foto (opcional)\n\n5. Usuário preenche e envia\n\n6. POST /api/public/requests\n   {\n     qrCodeId,\n     description,\n     photo\n   }\n\n7. Backend:\n   - Identifica zona pelo QR\n   - Cria work_order:\n     - orderType: 'public_corrective'\n     - status: 'pending'\n     - priority: 'medium' (default)\n     - assignedUserId: null (atribuir depois)\n\n8. Retorna: \"Solicitação enviada! Protocolo: #12345\"\n\n9. Manager vê nova ordem no dashboard\n10. Atribui operador\n11. Operador resolve\n```\n\n### Fluxo 5: Auto-correção de Módulo Inválido\n\n```\nCenário: Usuário está em OPUS Clean, troca para cliente que só tem Manutenção\n\n1. Usuário no cliente FAURECIA (clean)\n2. currentModule = 'clean' (localStorage)\n\n3. Usuário muda para \"Teste de manutenção\" (só maintenance)\n4. ClientContext.setActiveClientId('teste-manutencao-id')\n\n5. ModuleContext detecta mudança:\n   useEffect(() => {\n     // availableModules agora = ['maintenance']\n     // currentModule = 'clean' (não está em availableModules)\n     \n     if (!availableModules.includes(currentModule)) {\n       setCurrentModule('maintenance'); // AUTO-CORREÇÃO\n       localStorage.setItem('opus:currentModule', 'maintenance');\n     }\n   }, [activeClientId, availableModules]);\n\n6. UI atualiza:\n   - Sidebar muda cor (laranja)\n   - Menu mostra opções de manutenção\n   - Dados filtrados por module='maintenance'\n\n7. Usuário vê apenas dados de manutenção\n```\n\n---\n\n## 🛠️ Guia de Desenvolvimento\n\n### Adicionar Nova Funcionalidade\n\n#### 1. Definir o Schema (shared/schema.ts)\n\n```typescript\n// 1. Criar tabela\nexport const myNewTable = pgTable('my_new_table', {\n  id: varchar('id').primaryKey(),\n  customerId: varchar('customer_id').references(() => customers.id),\n  module: moduleEnum('module').notNull().default('clean'), // Se modular\n  name: varchar('name').notNull(),\n  isActive: boolean('is_active').default(true),\n  createdAt: timestamp('created_at').default(sql`now()`),\n});\n\n// 2. Definir relações\nexport const myNewTableRelations = relations(myNewTable, ({ one }) => ({\n  customer: one(customers, {\n    fields: [myNewTable.customerId],\n    references: [customers.id],\n  }),\n}));\n\n// 3. Criar Zod schemas\nexport const insertMyNewTableSchema = createInsertSchema(myNewTable).omit({ \n  id: true, \n  createdAt: true \n});\nexport type InsertMyNewTable = z.infer<typeof insertMyNewTableSchema>;\nexport type MyNewTable = typeof myNewTable.$inferSelect;\n```\n\n#### 2. Atualizar Storage (server/storage.ts)\n\n```typescript\n// Interface\ninterface IStorage {\n  // ... existing methods\n  getMyNewTables(filters: { customerId: string, module?: string }): Promise<MyNewTable[]>\n  createMyNewTable(data: InsertMyNewTable): Promise<MyNewTable>\n  updateMyNewTable(id: string, data: Partial<InsertMyNewTable>): Promise<MyNewTable>\n  deleteMyNewTable(id: string): Promise<void>\n}\n\n// Implementation\nclass PostgresStorage implements IStorage {\n  async getMyNewTables(filters) {\n    const conditions = [eq(myNewTable.customerId, filters.customerId)];\n    if (filters.module) {\n      conditions.push(eq(myNewTable.module, filters.module));\n    }\n    return await db.select().from(myNewTable).where(and(...conditions));\n  }\n  \n  async createMyNewTable(data) {\n    const id = nanoid();\n    const [result] = await db.insert(myNewTable).values({ id, ...data }).returning();\n    return result;\n  }\n  \n  async updateMyNewTable(id, data) {\n    const [result] = await db.update(myNewTable).set(data).where(eq(myNewTable.id, id)).returning();\n    return result;\n  }\n  \n  async deleteMyNewTable(id) {\n    await db.delete(myNewTable).where(eq(myNewTable.id, id));\n  }\n}\n```\n\n#### 3. Criar Rotas (server/routes.ts)\n\n```typescript\n// GET all\napp.get('/api/customers/:customerId/my-new-tables', requireAuth, async (req, res) => {\n  try {\n    const { customerId } = req.params;\n    const { module } = req.query;\n    \n    // Validar acesso\n    if (req.user.userType === 'customer_user' && req.user.assignedClientId !== customerId) {\n      return res.status(403).json({ error: 'Forbidden' });\n    }\n    \n    const items = await storage.getMyNewTables({ \n      customerId, \n      module: module as string \n    });\n    res.json(items);\n  } catch (error) {\n    res.status(500).json({ error: 'Internal server error' });\n  }\n});\n\n// POST create\napp.post('/api/customers/:customerId/my-new-tables', requireAuth, async (req, res) => {\n  try {\n    const { customerId } = req.params;\n    \n    // Validar body\n    const validatedData = insertMyNewTableSchema.parse(req.body);\n    \n    // Adicionar customerId\n    const newItem = await storage.createMyNewTable({\n      ...validatedData,\n      customerId\n    });\n    \n    res.status(201).json(newItem);\n  } catch (error) {\n    res.status(400).json({ error: error.message });\n  }\n});\n\n// PUT update\napp.put('/api/customers/:customerId/my-new-tables/:id', requireAuth, async (req, res) => {\n  try {\n    const { id } = req.params;\n    const validatedData = insertMyNewTableSchema.partial().parse(req.body);\n    \n    const updated = await storage.updateMyNewTable(id, validatedData);\n    res.json(updated);\n  } catch (error) {\n    res.status(400).json({ error: error.message });\n  }\n});\n\n// DELETE\napp.delete('/api/customers/:customerId/my-new-tables/:id', requireAuth, async (req, res) => {\n  try {\n    const { id } = req.params;\n    await storage.deleteMyNewTable(id);\n    res.status(204).send();\n  } catch (error) {\n    res.status(500).json({ error: error.message });\n  }\n});\n```\n\n#### 4. Criar Frontend Page (client/src/pages/my-new-feature.tsx)\n\n```typescript\nimport { useState } from \"react\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { useClient } from \"@/contexts/ClientContext\";\nimport { useModule } from \"@/contexts/ModuleContext\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Button } from \"@/components/ui/button\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Plus } from \"lucide-react\";\n\nexport default function MyNewFeature() {\n  const { activeClientId: customerId } = useClient();\n  const { currentModule } = useModule();\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  \n  // Query\n  const { data: items = [], isLoading } = useQuery({\n    queryKey: ['/api/customers', customerId, 'my-new-tables', { module: currentModule }],\n    enabled: !!customerId,\n  });\n  \n  // Create mutation\n  const createMutation = useMutation({\n    mutationFn: (data: any) => \n      apiRequest('POST', `/api/customers/${customerId}/my-new-tables`, {\n        ...data,\n        module: currentModule // IMPORTANTE: adicionar módulo\n      }),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/customers', customerId, 'my-new-tables'] });\n      setIsDialogOpen(false);\n      toast({ title: 'Item criado com sucesso!' });\n    },\n    onError: () => {\n      toast({ title: 'Erro ao criar item', variant: 'destructive' });\n    },\n  });\n  \n  return (\n    <div>\n      <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\n        <DialogTrigger asChild>\n          <Button data-testid=\"button-create-item\">\n            <Plus className=\"w-4 h-4 mr-2\" />\n            Novo Item\n          </Button>\n        </DialogTrigger>\n        <DialogContent className=\"max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>Novo Item</DialogTitle>\n          </DialogHeader>\n          {/* Form here */}\n        </DialogContent>\n      </Dialog>\n      \n      {/* List items */}\n      {isLoading ? <p>Carregando...</p> : (\n        <div>\n          {items.map(item => (\n            <div key={item.id}>{item.name}</div>\n          ))}\n        </div>\n      )}\n    </div>\n  );\n}\n```\n\n#### 5. Registrar Rota (client/src/App.tsx)\n\n```typescript\nimport MyNewFeature from \"@/pages/my-new-feature\";\n\nfunction App() {\n  return (\n    <Route path=\"/my-new-feature\" component={MyNewFeature} />\n  );\n}\n```\n\n#### 6. Adicionar ao Menu (client/src/components/layout/sidebar.tsx)\n\n```typescript\n// Adicionar ao array de menuItems\n{\n  label: 'Minha Feature',\n  icon: Star, // Escolher ícone\n  path: '/my-new-feature',\n  modules: ['clean', 'maintenance'], // ou ['maintenance'] se exclusivo\n}\n```\n\n#### 7. Push Schema para Database\n\n```bash\nnpm run db:push\n# Ou se houver warning de data loss:\nnpm run db:push --force\n```\n\n### Checklist de Desenvolvimento\n\n- [ ] Schema definido em `shared/schema.ts`\n- [ ] Relações criadas\n- [ ] Zod schemas exportados\n- [ ] Storage interface atualizada\n- [ ] Storage implementation criada\n- [ ] Rotas backend criadas com validação\n- [ ] Frontend page criada\n- [ ] Queries/mutations implementadas\n- [ ] Forms validados com Zod\n- [ ] Dialogs com `max-h-[90vh] overflow-y-auto`\n- [ ] `data-testid` em elementos interativos\n- [ ] Module filtering aplicado (se relevante)\n- [ ] Rota registrada em App.tsx\n- [ ] Menu item adicionado (se aplicável)\n- [ ] Database migrada (`npm run db:push`)\n- [ ] Testado em ambos os módulos (se relevante)\n\n### Padrões de Código\n\n#### Naming Conventions\n\n```typescript\n// Components: PascalCase\nMyComponent.tsx\n\n// Files: kebab-case\nmy-feature-page.tsx\n\n// Variables: camelCase\nconst myVariable = 'value';\n\n// Constants: SCREAMING_SNAKE_CASE\nconst API_BASE_URL = '/api';\n\n// Types/Interfaces: PascalCase\ntype MyType = { ... }\ninterface IMyInterface { ... }\n\n// Database tables: snake_case\nexport const my_table = pgTable('my_table', { ... });\n\n// API routes: kebab-case\nGET /api/my-feature-items\n```\n\n#### Folder Organization\n\n```\nclient/src/pages/\n  - dashboard.tsx         # Main dashboards\n  - work-orders.tsx       # Entity listing\n  - work-order-detail.tsx # Single entity\n  - settings.tsx          # Config pages\n  \nclient/src/components/\n  - layout/               # Layout components\n  - ui/                   # shadcn primitives\n  - (feature-specific)    # Apenas se reutilizável\n```\n\n#### Import Order\n\n```typescript\n// 1. React\nimport { useState } from 'react';\n\n// 2. Third-party\nimport { useQuery } from '@tanstack/react-query';\n\n// 3. UI Components\nimport { Button } from '@/components/ui/button';\n\n// 4. Contexts/Hooks\nimport { useClient } from '@/contexts/ClientContext';\n\n// 5. Utils\nimport { apiRequest } from '@/lib/queryClient';\n\n// 6. Types\nimport type { MyType } from '@shared/schema';\n```\n\n---\n\n## 💾 Database Backup\n\n### Dumps Disponíveis\n\nO sistema possui dumps atualizados do banco de dados PostgreSQL:\n\n- **database_full_dump.sql** (476 KB) - Schema + Dados completo\n- **database_schema.sql** (57 KB) - Apenas estrutura\n- **database_data.sql** (420 KB) - Apenas dados\n\n**Detalhes**: Consulte [DATABASE_DUMP_INFO.md](./DATABASE_DUMP_INFO.md) para instruções completas de restauração e informações sobre as 35 tabelas do sistema.\n\n### Como Criar Novo Dump\n\n```bash\n# Dump completo\npg_dump $DATABASE_URL --no-owner --no-privileges > database_full_dump.sql\n\n# Apenas schema\npg_dump $DATABASE_URL --schema-only --no-owner --no-privileges > database_schema.sql\n\n# Apenas dados\npg_dump $DATABASE_URL --data-only --no-owner --no-privileges > database_data.sql\n```\n\n**Nota**: Arquivos `.sql` já estão no `.gitignore` para proteção de dados sensíveis.\n\n---\n\n## 📝 Changelog\n\n### 04/11/2025 - Database Dump Completo\n\n**Feature**: Criação de dump completo do banco de dados PostgreSQL.\n\n**Arquivos Gerados**:\n- `database_full_dump.sql` - Dump completo (schema + dados)\n- `database_schema.sql` - Apenas estrutura das 35 tabelas\n- `database_data.sql` - Apenas dados\n- `DATABASE_DUMP_INFO.md` - Documentação completa do dump\n\n**Estatísticas**:\n- 35 tabelas no total\n- 12+ tipos ENUM definidos\n- Schema completo do sistema multi-módulo\n\n**Uso**:\n- Backup de segurança\n- Restauração de ambiente\n- Migração entre instâncias\n- Documentação da estrutura de dados\n\n---\n\n### 04/11/2025 - Correção: Module Assignment em Service Categories/Types\n\n**Problema**: Ao criar categorias ou tipos de serviço no módulo de Manutenção, o sistema não enviava o campo `module`, resultando em uso do valor padrão `'clean'`.\n\n**Solução Implementada**:\n- Atualizado `onSubmitType` em `service-settings.tsx` para incluir `module: currentModule` ao criar tipo de serviço\n- Atualizado `onSubmitCategory` em `service-settings.tsx` para incluir `module: currentModule` ao criar categoria de serviço\n\n**Arquivos Modificados**:\n- `client/src/pages/service-settings.tsx`\n\n**Impacto**:\n- Categorias e tipos criados em Manutenção agora são corretamente atribuídos ao módulo `'maintenance'`\n- Filtros por módulo funcionam corretamente\n- Isolamento de dados mantido entre módulos\n\n---\n\n### 03/11/2025 - Melhorias de UX em Dialogs\n\n**Problema**: Dialogs em telas menores não permitiam scroll, cortando conteúdo.\n\n**Solução Implementada**:\n- Adicionado `max-h-[90vh] overflow-y-auto` a 8+ dialogs no sistema\n- Formulários longos agora têm scroll interno\n- Reset automático de forms ao fechar dialogs\n\n**Arquivos Modificados**:\n- `client/src/pages/service-settings.tsx`\n- `client/src/pages/users.tsx`\n- `client/src/pages/sites.tsx`\n- (outros)\n\n**Padrão Estabelecido**:\nTodos os novos dialogs devem usar:\n```tsx\n<DialogContent className=\"max-h-[90vh] overflow-y-auto\">\n```\n\n---\n\n### 02/11/2025 - Fix: ClientContext LocalStorage Bug\n\n**Problema**: useEffect no ClientContext resetava `activeClientId` toda vez que o usuário fazia login, impedindo fluxo de seleção de módulo.\n\n**Solução Implementada**:\n- Removido useEffect problemático que resetava localStorage\n- Mantido apenas lógica de inicialização no mounting\n\n**Arquivos Modificados**:\n- `client/src/contexts/ClientContext.tsx`\n\n**Impacto**:\n- Fluxo de login → seleção de módulo funciona corretamente\n- localStorage persistente entre reloads\n\n---\n\n### 01/11/2025 - Implementação: Module Inheritance System\n\n**Feature**: Sistema de herança de módulos para customer_user.\n\n**Implementação**:\n- `customer_user` agora herda módulos do registro do cliente (`customers.modules`)\n- `opus_user` continua usando `users.modules`\n- Endpoint `/api/auth/user-modules` retorna módulos corretos baseado em `userType`\n- Frontend valida e desabilita checkboxes de módulos não disponíveis ao criar usuários\n\n**Arquivos Criados**:\n- `client/src/hooks/useUserModules.ts`\n\n**Arquivos Modificados**:\n- `server/routes.ts` (endpoint user-modules)\n- `client/src/pages/users.tsx` (validação de módulos)\n\n**Validação**:\n- Backend valida se módulos selecionados estão disponíveis no cliente\n- Frontend desabilita checkboxes de módulos indisponíveis\n\n---\n\n## 🔐 Segurança\n\n### Práticas Implementadas\n\n1. **Password Hashing**: Bcrypt com salt rounds adequados\n2. **JWT Tokens**: Signed tokens para sessões\n3. **CORS**: Configurado para domínios permitidos\n4. **Helmet**: Headers de segurança HTTP\n5. **Rate Limiting**: Proteção contra brute force\n6. **SQL Injection**: Drizzle ORM previne (parameterized queries)\n7. **XSS**: React escapa output automaticamente\n8. **CSRF**: Token-based auth mitiga\n9. **Input Validation**: Zod valida todos os inputs\n\n### Variáveis de Ambiente\n\n```bash\n# Database\nDATABASE_URL=postgresql://...\nPGHOST=...\nPGPORT=5432\nPGUSER=...\nPGPASSWORD=...\nPGDATABASE=...\n\n# Auth\nJWT_SECRET=your-secret-key\n\n# Microsoft SSO (opcional)\nMS_CLIENT_ID=...\nMS_CLIENT_SECRET=...\nMS_TENANT_ID=...\n```\n\n**IMPORTANTE**: Nunca commitar secrets no código. Usar secrets do Replit.\n\n---\n\n## 🚀 Deploy\n\n### Replit Deployment\n\nO projeto está configurado para deploy no Replit. O sistema já está configurado com:\n\n- PostgreSQL database (Neon)\n- Environment secrets\n- Workflow: `npm run dev`\n\n### Processo de Deploy\n\n1. Garantir que todos os secrets estão configurados\n2. Executar `npm run db:push` para sincronizar schema\n3. Clicar em \"Deploy\" na interface do Replit\n4. Selecionar tipo de deployment (autoscale recomendado)\n\n---\n\n## 📚 Referências Técnicas\n\n### Bibliotecas Principais\n\n- **React**: https://react.dev\n- **TypeScript**: https://www.typescriptlang.org\n- **Vite**: https://vitejs.dev\n- **TanStack Query**: https://tanstack.com/query\n- **Drizzle ORM**: https://orm.drizzle.team\n- **shadcn/ui**: https://ui.shadcn.com\n- **Tailwind CSS**: https://tailwindcss.com\n- **Wouter**: https://github.com/molefrog/wouter\n\n### Documentação Interna\n\n- **replit.md**: Resumo do projeto e preferências\n- **shared/schema.ts**: Fonte da verdade para tipos de dados\n- **DOCUMENTATION.md**: Este arquivo (documentação completa)\n\n---\n\n## 🎯 Roadmap Futuro\n\n### Funcionalidades Planejadas\n\n- [ ] Módulo OPUS Controle de Acesso\n- [ ] Módulo OPUS Recepção\n- [ ] Notificações push (mobile)\n- [ ] Chat em tempo real (work orders)\n- [ ] Exportação de relatórios (PDF/Excel)\n- [ ] Integração com WhatsApp (solicitações)\n- [ ] Dashboard customizável (drag & drop)\n- [ ] Multi-idioma (i18n)\n\n### Melhorias Técnicas\n\n- [ ] Testes automatizados (Jest + Testing Library)\n- [ ] CI/CD pipeline\n- [ ] Monitoring e logging estruturado\n- [ ] Performance optimization (lazy loading, code splitting)\n- [ ] PWA support (offline-first)\n- [ ] WebSocket para updates em tempo real\n\n---\n\n## 👥 Suporte\n\nPara questões técnicas ou bugs, documentar neste arquivo na seção Changelog.\n\n---\n\n**Fim da Documentação**\n","size_bytes":41568},"client/src/pages/equipment-tags.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { Plus, Edit, Trash2, Tag } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport Header from \"@/components/layout/header\";\nimport { useClient } from \"@/contexts/ClientContext\";\nimport { useModule } from \"@/contexts/ModuleContext\";\nimport type { EquipmentTag } from \"@shared/schema\";\n\nconst equipmentTagSchema = z.object({\n  name: z.string().min(1, \"Nome é obrigatório\"),\n  description: z.string().optional(),\n});\n\nexport default function EquipmentTags() {\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [editingTag, setEditingTag] = useState<any>(null);\n  const { toast } = useToast();\n  const { activeClientId: customerId } = useClient();\n  const { currentModule } = useModule();\n\n  useEffect(() => {\n    if (customerId) {\n      queryClient.invalidateQueries({ queryKey: [\"/api/customers\"] });\n    }\n  }, [customerId]);\n\n  const { data: equipmentTags = [], isLoading } = useQuery<EquipmentTag[]>({\n    queryKey: [\"/api/customers\", customerId, \"equipment-tags\", { module: currentModule }],\n    enabled: !!customerId,\n  });\n\n  const tagForm = useForm({\n    resolver: zodResolver(equipmentTagSchema),\n    defaultValues: {\n      name: \"\",\n      description: \"\",\n    },\n  });\n\n  const createTagMutation = useMutation({\n    mutationFn: (data: any) => apiRequest(\"POST\", `/api/customers/${customerId}/equipment-tags`, data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/customers\", customerId, \"equipment-tags\"] });\n      setIsDialogOpen(false);\n      tagForm.reset();\n      toast({ title: \"Tag criada com sucesso!\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro ao criar tag\", variant: \"destructive\" });\n    },\n  });\n\n  const updateTagMutation = useMutation({\n    mutationFn: ({ id, data }: { id: string; data: any }) => \n      apiRequest(\"PUT\", `/api/customers/${customerId}/equipment-tags/${id}`, data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/customers\", customerId, \"equipment-tags\"] });\n      setIsDialogOpen(false);\n      setEditingTag(null);\n      tagForm.reset();\n      toast({ title: \"Tag atualizada com sucesso!\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro ao atualizar tag\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteTagMutation = useMutation({\n    mutationFn: (id: string) => apiRequest(\"DELETE\", `/api/customers/${customerId}/equipment-tags/${id}`),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/customers\", customerId, \"equipment-tags\"] });\n      toast({ title: \"Tag excluída com sucesso!\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro ao excluir tag\", variant: \"destructive\" });\n    },\n  });\n\n  const handleSubmit = (data: z.infer<typeof equipmentTagSchema>) => {\n    const payload = {\n      ...data,\n      customerId,\n      module: currentModule,\n      isActive: true,\n    };\n\n    if (editingTag) {\n      updateTagMutation.mutate({ id: editingTag.id, data: payload });\n    } else {\n      createTagMutation.mutate(payload);\n    }\n  };\n\n  const handleEdit = (tag: any) => {\n    setEditingTag(tag);\n    tagForm.reset({\n      name: tag.name,\n      description: tag.description || \"\",\n    });\n    setIsDialogOpen(true);\n  };\n\n  const handleDelete = (id: string) => {\n    if (window.confirm(\"Tem certeza que deseja excluir esta tag?\")) {\n      deleteTagMutation.mutate(id);\n    }\n  };\n\n  const handleOpenDialog = () => {\n    setEditingTag(null);\n    tagForm.reset({\n      name: \"\",\n      description: \"\",\n    });\n    setIsDialogOpen(true);\n  };\n\n  return (\n    <div className=\"flex flex-col h-screen bg-gray-50 dark:bg-gray-900\">\n      <Header title=\"Tags de Equipamentos\" />\n      <main className=\"flex-1 overflow-y-auto p-6\">\n        <div className=\"max-w-6xl mx-auto space-y-6\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <h1 className=\"text-3xl font-bold text-gray-900 dark:text-gray-100\">\n                Tags de Equipamentos\n              </h1>\n              <p className=\"text-sm text-gray-600 dark:text-gray-400 mt-1\">\n                Gerencie tags para categorizar e identificar equipamentos\n              </p>\n            </div>\n          </div>\n\n          <Card>\n            <CardHeader>\n              <div className=\"flex items-center justify-between\">\n                <div className=\"flex items-center gap-2\">\n                  <Tag className=\"h-5 w-5 text-blue-600\" />\n                  <CardTitle>Tags de Equipamentos</CardTitle>\n                </div>\n                <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\n                  <DialogTrigger asChild>\n                    <Button \n                      onClick={handleOpenDialog}\n                      className=\"bg-blue-600 hover:bg-blue-700\"\n                      data-testid=\"button-create-tag\"\n                    >\n                      <Plus className=\"h-4 w-4 mr-2\" />\n                      Nova Tag\n                    </Button>\n                  </DialogTrigger>\n                  <DialogContent>\n                    <DialogHeader>\n                      <DialogTitle>\n                        {editingTag ? \"Editar Tag\" : \"Nova Tag\"}\n                      </DialogTitle>\n                    </DialogHeader>\n                    <Form {...tagForm}>\n                      <form onSubmit={tagForm.handleSubmit(handleSubmit)} className=\"space-y-4\">\n                        <FormField\n                          control={tagForm.control}\n                          name=\"name\"\n                          render={({ field }) => (\n                            <FormItem>\n                              <FormLabel>Nome</FormLabel>\n                              <FormControl>\n                                <Input \n                                  placeholder=\"Ex: Máquina de Café\" \n                                  {...field} \n                                  data-testid=\"input-tag-name\"\n                                />\n                              </FormControl>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n                        <FormField\n                          control={tagForm.control}\n                          name=\"description\"\n                          render={({ field }) => (\n                            <FormItem>\n                              <FormLabel>Descrição (Opcional)</FormLabel>\n                              <FormControl>\n                                <Textarea \n                                  placeholder=\"Descrição da tag\" \n                                  {...field} \n                                  data-testid=\"input-tag-description\"\n                                />\n                              </FormControl>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n                        <div className=\"flex justify-end gap-2\">\n                          <Button \n                            type=\"button\" \n                            variant=\"outline\" \n                            onClick={() => setIsDialogOpen(false)}\n                            data-testid=\"button-cancel\"\n                          >\n                            Cancelar\n                          </Button>\n                          <Button \n                            type=\"submit\"\n                            className=\"bg-blue-600 hover:bg-blue-700\"\n                            data-testid=\"button-save-tag\"\n                          >\n                            {editingTag ? \"Atualizar\" : \"Criar\"}\n                          </Button>\n                        </div>\n                      </form>\n                    </Form>\n                  </DialogContent>\n                </Dialog>\n              </div>\n            </CardHeader>\n            <CardContent>\n              {isLoading ? (\n                <div className=\"text-center py-8 text-gray-500\">Carregando...</div>\n              ) : equipmentTags.length === 0 ? (\n                <div className=\"text-center py-8 text-gray-500\">\n                  Nenhuma tag cadastrada ainda.\n                </div>\n              ) : (\n                <Table>\n                  <TableHeader>\n                    <TableRow>\n                      <TableHead>Nome</TableHead>\n                      <TableHead>Descrição</TableHead>\n                      <TableHead>Módulo</TableHead>\n                      <TableHead className=\"text-right\">Ações</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {equipmentTags.map((tag: any) => (\n                      <TableRow key={tag.id} data-testid={`row-tag-${tag.id}`}>\n                        <TableCell className=\"font-medium\" data-testid={`text-tag-name-${tag.id}`}>\n                          {tag.name}\n                        </TableCell>\n                        <TableCell className=\"text-gray-600 dark:text-gray-400\" data-testid={`text-tag-description-${tag.id}`}>\n                          {tag.description || \"-\"}\n                        </TableCell>\n                        <TableCell>\n                          <Badge \n                            variant={tag.module === 'maintenance' ? 'default' : 'secondary'}\n                            className={tag.module === 'maintenance' ? 'bg-purple-600' : 'bg-blue-600'}\n                          >\n                            {tag.module === 'maintenance' ? 'Manutenção' : 'Limpeza'}\n                          </Badge>\n                        </TableCell>\n                        <TableCell className=\"text-right\">\n                          <div className=\"flex justify-end gap-2\">\n                            <Button\n                              variant=\"ghost\"\n                              size=\"sm\"\n                              onClick={() => handleEdit(tag)}\n                              data-testid={`button-edit-tag-${tag.id}`}\n                            >\n                              <Edit className=\"h-4 w-4\" />\n                            </Button>\n                            <Button\n                              variant=\"ghost\"\n                              size=\"sm\"\n                              onClick={() => handleDelete(tag.id)}\n                              data-testid={`button-delete-tag-${tag.id}`}\n                            >\n                              <Trash2 className=\"h-4 w-4 text-red-600\" />\n                            </Button>\n                          </div>\n                        </TableCell>\n                      </TableRow>\n                    ))}\n                  </TableBody>\n                </Table>\n              )}\n            </CardContent>\n          </Card>\n        </div>\n      </main>\n    </div>\n  );\n}\n","size_bytes":11723},"README.md":{"content":"# OPUS - Sistema de Gestão de Facilities\n\nSistema modular de gestão de facilities com módulos Clean (limpeza) e Manutenção, desenvolvido com React, TypeScript, Express e PostgreSQL.\n\n## 🚀 Quick Start\n\n### Pré-requisitos\n\n- Node.js 18+ \n- PostgreSQL 14+\n- npm ou yarn\n\n### Instalação\n\n1. **Clone o repositório**\n```bash\ngit clone <repository-url>\ncd opus-facilities\n```\n\n2. **Instale as dependências**\n```bash\nnpm install\n```\n\n3. **Configure o banco de dados**\n\nCrie um banco PostgreSQL e configure a variável de ambiente:\n\n```bash\nexport DATABASE_URL=\"postgresql://user:password@localhost:5432/opus_db\"\n```\n\n4. **Importe o dump do banco**\n```bash\npsql $DATABASE_URL < database_dump_final.sql\n```\n\nOu, se preferir criar do zero:\n\n```bash\nnpm run db:push\n```\n\n5. **Inicie o servidor de desenvolvimento**\n```bash\nnpm run dev\n```\n\nO sistema estará disponível em `http://localhost:5000`\n\n## 📁 Estrutura do Projeto\n\n```\nopus-facilities/\n├── client/              # Frontend React + TypeScript\n│   ├── src/\n│   │   ├── components/  # Componentes reutilizáveis\n│   │   ├── contexts/    # Contextos React (Auth, Module, Client)\n│   │   ├── hooks/       # Hooks customizados\n│   │   ├── lib/         # Utilitários e configurações\n│   │   └── pages/       # Páginas da aplicação\n│   └── public/          # Arquivos estáticos\n├── server/              # Backend Express + TypeScript\n│   ├── routes.ts        # Rotas da API\n│   ├── auth.ts          # Autenticação e autorização\n│   ├── storage.ts       # Interface de persistência\n│   └── index.ts         # Entry point do servidor\n├── shared/              # Código compartilhado\n│   └── schema.ts        # Esquema do banco (Drizzle ORM)\n└── database_dump_final.sql  # Dump completo do banco\n```\n\n## 🎯 Funcionalidades Principais\n\n### OPUS Clean (Módulo de Limpeza)\n- Gestão de ordens de serviço de limpeza\n- QR Codes para execução de tarefas\n- Checklists configuráveis\n- Solicitações públicas de serviço\n- Dashboards e relatórios\n\n### OPUS Manutenção (Módulo de Manutenção)\n- Gestão de equipamentos\n- Planos de manutenção (preventiva, preditiva, corretiva)\n- Checklists de manutenção reutilizáveis\n- Ordens de serviço automáticas\n- Calendário de atividades\n\n### Multi-tenancy\n- Suporte a múltiplas empresas\n- Hierarquia: Empresas > Locais > Zonas\n- Isolamento completo de dados por módulo\n- Controle de acesso baseado em funções (RBAC)\n\n### Autenticação\n- Login com email/senha\n- Integração com Microsoft SSO (Entra ID)\n- Gerenciamento de sessões\n- Proteção de rotas\n\n## 🔧 Scripts Disponíveis\n\n```bash\nnpm run dev          # Inicia servidor de desenvolvimento\nnpm run build        # Build para produção\nnpm run db:push      # Sincroniza schema com banco de dados\nnpm run db:studio    # Interface visual do banco (Drizzle Studio)\n```\n\n## 📚 Documentação Completa\n\nPara documentação técnica detalhada, arquitetura, fluxos e changelog, consulte:\n- [DOCUMENTATION.md](./DOCUMENTATION.md) - Documentação técnica completa\n- [replit.md](./replit.md) - Resumo do projeto e preferências\n\n## 🔐 Variáveis de Ambiente\n\n```bash\n# Banco de Dados\nDATABASE_URL=postgresql://user:password@localhost:5432/opus_db\n\n# Sessão (gere uma chave aleatória segura)\nSESSION_SECRET=your-super-secret-session-key\n\n# Microsoft SSO (opcional)\nMICROSOFT_CLIENT_ID=your-client-id\nMICROSOFT_CLIENT_SECRET=your-client-secret\nMICROSOFT_TENANT_ID=your-tenant-id\n```\n\n## 🎨 Tecnologias Utilizadas\n\n### Frontend\n- React 18\n- TypeScript\n- Vite\n- TailwindCSS + shadcn/ui\n- Wouter (routing)\n- TanStack Query (data fetching)\n- Radix UI (componentes acessíveis)\n\n### Backend\n- Node.js + Express\n- TypeScript\n- Drizzle ORM\n- PostgreSQL\n- Passport.js (autenticação)\n- JWT + bcrypt (segurança)\n\n## 👥 Sistema de Permissões\n\nO sistema possui controle granular de permissões baseado em funções:\n\n- **Administrador**: Acesso total ao sistema\n- **Gestor**: Gerenciamento de ordens de serviço e usuários\n- **Supervisor**: Visualização e atribuição de tarefas\n- **Colaborador**: Execução de tarefas atribuídas\n\nCada função possui permissões específicas definidas em `server/auth.ts`\n\n## 📱 Acesso Mobile\n\nO sistema possui interface otimizada para mobile, acessível através do mesmo URL. Colaboradores podem:\n- Visualizar ordens de serviço atribuídas\n- Escanear QR Codes\n- Executar checklists\n- Adicionar comentários e fotos\n- Marcar tarefas como concluídas\n\n## 🐛 Troubleshooting\n\n### Erro de conexão com banco de dados\nVerifique se a variável `DATABASE_URL` está configurada corretamente e se o PostgreSQL está rodando.\n\n### Erro ao fazer db:push\nUse `npm run db:push --force` se houver conflitos no schema.\n\n### Porta 5000 já em uso\nAltere a porta no arquivo `server/index.ts` ou pare o processo que está usando a porta 5000.\n\n## 📄 Licença\n\nPropriedade do Grupo OPUS. Todos os direitos reservados.\n\n## 📞 Suporte\n\nPara suporte técnico ou dúvidas, entre em contato com a equipe de desenvolvimento.\n\n---\n\n**Desenvolvido com ❤️ pelo Grupo OPUS**\n","size_bytes":5205},"client/src/hooks/use-module-theme.ts":{"content":"import { useModule } from \"@/contexts/ModuleContext\";\n\n/**\n * Hook para obter classes CSS dinâmicas baseadas no módulo ativo\n * Design predominantemente BRANCO com cor do módulo como identificação sutil\n */\nexport function useModuleTheme() {\n  const { currentModule } = useModule();\n  \n  const isClean = currentModule === 'clean';\n  const isMaintenance = currentModule === 'maintenance';\n  \n  return {\n    // Cores primárias do módulo (apenas para identificação)\n    primary: isClean ? 'blue' : 'orange',\n    primaryHex: isClean ? '#3B82F6' : '#F97316',\n    \n    // Gradientes MODERNOS - predominantemente branco com detalhes sofisticados\n    gradients: {\n      // Gradiente sutil para backgrounds de páginas\n      page: 'bg-gradient-to-br from-white via-slate-50/40 to-slate-100/20',\n      \n      // Gradiente muito leve para sections\n      section: 'bg-gradient-to-b from-white to-slate-50/30',\n      \n      // Gradiente para headers (cor do módulo)\n      header: isClean\n        ? 'bg-gradient-to-r from-blue-600 to-blue-700'\n        : 'bg-gradient-to-r from-orange-600 to-orange-700',\n        \n      // Gradiente sutil para cards especiais (glassmorphism)\n      glass: isClean\n        ? 'bg-gradient-to-br from-white/95 via-blue-50/30 to-white/90 backdrop-blur-sm'\n        : 'bg-gradient-to-br from-white/95 via-orange-50/30 to-white/90 backdrop-blur-sm',\n        \n      // Gradiente para cards destacados (muito sutil)\n      cardAccent: isClean\n        ? 'bg-gradient-to-br from-white to-blue-50/20'\n        : 'bg-gradient-to-br from-white to-orange-50/20',\n        \n      // Gradiente para stats cards (cor do módulo)\n      stat: isClean\n        ? 'bg-gradient-to-br from-blue-500 to-blue-600'\n        : 'bg-gradient-to-br from-orange-500 to-orange-600',\n        \n      // Gradiente para hover effects\n      hover: isClean\n        ? 'hover:bg-gradient-to-br hover:from-white hover:to-blue-50/30'\n        : 'hover:bg-gradient-to-br hover:from-white hover:to-orange-50/30',\n    },\n    \n    // Sombras neutras (sem cor)\n    shadows: {\n      // Sombra sutil para cards - CINZA, não colorida\n      card: 'shadow-lg shadow-slate-200/50 hover:shadow-slate-300/60',\n        \n      // Sombra para botões - apenas no hover\n      button: isClean\n        ? 'hover:shadow-md hover:shadow-blue-500/20'\n        : 'hover:shadow-md hover:shadow-orange-500/20',\n        \n      // Sombra intensa - CINZA\n      intense: 'shadow-xl shadow-slate-300/40',\n    },\n    \n    // Botões - cor do módulo apenas no primário\n    buttons: {\n      primary: isClean\n        ? 'bg-blue-600 hover:bg-blue-700 text-white transition-all duration-200'\n        : 'bg-orange-600 hover:bg-orange-700 text-white transition-all duration-200',\n        \n      outline: isClean\n        ? 'border border-blue-600 hover:bg-blue-50 text-blue-600 transition-all duration-200'\n        : 'border border-orange-600 hover:bg-orange-50 text-orange-600 transition-all duration-200',\n    },\n    \n    // Badges/Tags - cor sutil do módulo\n    badges: {\n      primary: isClean\n        ? 'bg-blue-50 text-blue-700 border border-blue-200'\n        : 'bg-orange-50 text-orange-700 border border-orange-200',\n        \n      light: isClean\n        ? 'bg-blue-50/50 text-blue-600'\n        : 'bg-orange-50/50 text-orange-600',\n    },\n    \n    // Cards MODERNOS com gradientes sutis\n    cards: {\n      // Card padrão - BRANCO limpo com borda sutil\n      modern: 'bg-white border border-slate-200 rounded-xl shadow-sm hover:shadow-md transition-all duration-200',\n      \n      // Card com gradiente muito sutil\n      gradient: isClean\n        ? 'bg-gradient-to-br from-white to-blue-50/20 border border-slate-200 rounded-xl shadow-sm hover:shadow-md transition-all duration-300'\n        : 'bg-gradient-to-br from-white to-orange-50/20 border border-slate-200 rounded-xl shadow-sm hover:shadow-md transition-all duration-300',\n        \n      // Card glassmorphism - moderno e sofisticado\n      glass: isClean\n        ? 'bg-gradient-to-br from-white/95 via-blue-50/20 to-white/90 backdrop-blur-sm border border-slate-200/60 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300'\n        : 'bg-gradient-to-br from-white/95 via-orange-50/20 to-white/90 backdrop-blur-sm border border-slate-200/60 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300',\n        \n      // Card de destaque - cor do módulo\n      featured: isClean\n        ? 'bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-xl shadow-lg border border-blue-400/20'\n        : 'bg-gradient-to-br from-orange-500 to-orange-600 text-white rounded-xl shadow-lg border border-orange-400/20',\n    },\n    \n    // Cores de texto - cor do módulo para destaques\n    text: {\n      primary: isClean ? 'text-blue-600' : 'text-orange-600',\n      light: isClean ? 'text-blue-500' : 'text-orange-500',\n      dark: isClean ? 'text-blue-700' : 'text-orange-700',\n    },\n    \n    // Bordas - cor do módulo apenas para destaque\n    borders: {\n      primary: isClean ? 'border-blue-500' : 'border-orange-500',\n      light: isClean ? 'border-blue-200' : 'border-orange-200',\n      accent: isClean ? 'border-l-4 border-l-blue-500' : 'border-l-4 border-l-orange-500',\n    },\n    \n    // Backgrounds - cor do módulo muito sutil\n    backgrounds: {\n      light: isClean ? 'bg-blue-50/50' : 'bg-orange-50/50',\n      lighter: isClean ? 'bg-blue-50/30' : 'bg-orange-50/30',\n      primary: isClean ? 'bg-blue-600' : 'bg-orange-600',\n    },\n    \n    // Hover effects - neutro\n    hover: {\n      card: 'hover:border-slate-300 hover:shadow-md',\n    },\n    \n    // Animações especiais\n    animations: {\n      shimmer: 'relative overflow-hidden before:absolute before:inset-0 before:-translate-x-full before:animate-[shimmer_2s_infinite] before:bg-gradient-to-r before:from-transparent before:via-white/10 before:to-transparent',\n      pulse: isClean\n        ? 'animate-pulse bg-blue-100/30'\n        : 'animate-pulse bg-orange-100/30',\n    }\n  };\n}\n","size_bytes":5967},"client/src/components/ui/modern-card.tsx":{"content":"import { useModuleTheme } from \"@/hooks/use-module-theme\";\nimport { cn } from \"@/lib/utils\";\n\ninterface ModernCardProps {\n  children: React.ReactNode;\n  className?: string;\n  variant?: 'default' | 'gradient' | 'glass' | 'featured';\n  hover?: boolean;\n  shimmer?: boolean;\n}\n\n/**\n * Card ultra-moderno 2025 com glassmorphism e cores dinâmicas por módulo\n */\nexport function ModernCard({ \n  children, \n  className, \n  variant = 'default',\n  hover = true,\n  shimmer = false \n}: ModernCardProps) {\n  const theme = useModuleTheme();\n  \n  let baseClasses = '';\n  \n  switch (variant) {\n    case 'gradient':\n      baseClasses = theme.cards.gradient;\n      break;\n    case 'glass':\n      baseClasses = theme.cards.glass;\n      break;\n    case 'featured':\n      baseClasses = theme.cards.featured;\n      break;\n    default:\n      baseClasses = theme.cards.modern;\n  }\n  \n  return (\n    <div className={cn(\n      baseClasses,\n      hover && variant !== 'glass' && theme.hover.card,\n      shimmer && theme.animations.shimmer,\n      className\n    )}>\n      {children}\n    </div>\n  );\n}\n\ninterface ModernCardHeaderProps {\n  children: React.ReactNode;\n  className?: string;\n  icon?: React.ReactNode;\n}\n\nexport function ModernCardHeader({ children, className, icon }: ModernCardHeaderProps) {\n  const theme = useModuleTheme();\n  \n  return (\n    <div className={cn(\n      \"px-6 py-4 border-b\",\n      theme.borders.primary,\n      className\n    )}>\n      <div className=\"flex items-center gap-3\">\n        {icon && (\n          <div className={cn(\n            \"p-2 rounded-lg\",\n            theme.backgrounds.light\n          )}>\n            {icon}\n          </div>\n        )}\n        <div className={cn(\"font-semibold text-lg\", theme.text.dark)}>\n          {children}\n        </div>\n      </div>\n    </div>\n  );\n}\n\ninterface ModernCardContentProps {\n  children: React.ReactNode;\n  className?: string;\n}\n\nexport function ModernCardContent({ children, className }: ModernCardContentProps) {\n  return (\n    <div className={cn(\"p-6\", className)}>\n      {children}\n    </div>\n  );\n}\n","size_bytes":2058},"client/src/components/ui/modern-page-header.tsx":{"content":"import { useModuleTheme } from \"@/hooks/use-module-theme\";\nimport { cn } from \"@/lib/utils\";\nimport { LucideIcon } from \"lucide-react\";\n\ninterface ModernPageHeaderProps {\n  title: string;\n  description?: string;\n  icon?: LucideIcon;\n  actions?: React.ReactNode;\n  stats?: Array<{\n    label: string;\n    value: string | number;\n    icon?: LucideIcon;\n    trend?: 'up' | 'down';\n  }>;\n}\n\n/**\n * Header de página ultra-moderno 2025 com gradientes e glassmorphism\n */\nexport function ModernPageHeader({ \n  title, \n  description, \n  icon: Icon, \n  actions,\n  stats \n}: ModernPageHeaderProps) {\n  const theme = useModuleTheme();\n  \n  return (\n    <div className={cn(\n      \"relative overflow-hidden\",\n      theme.gradients.page\n    )}>\n      {/* Conteúdo */}\n      <div className=\"relative px-6 py-8\">\n        <div className=\"max-w-7xl mx-auto\">\n          {/* Título e ações */}\n          <div className=\"flex items-center justify-between mb-6\">\n            <div className=\"flex items-center gap-4\">\n              {Icon && (\n                <div className={cn(\n                  \"p-3 rounded-2xl backdrop-blur-xl\",\n                  theme.gradients.stat,\n                  theme.shadows.button,\n                  \"text-white\"\n                )}>\n                  <Icon className=\"w-8 h-8\" />\n                </div>\n              )}\n              <div>\n                <h1 className={cn(\n                  \"text-4xl font-bold bg-clip-text text-transparent\",\n                  theme.gradients.header\n                )}>\n                  {title}\n                </h1>\n                {description && (\n                  <p className=\"text-slate-600 mt-1 text-lg\">\n                    {description}\n                  </p>\n                )}\n              </div>\n            </div>\n            \n            {actions && (\n              <div className=\"flex items-center gap-3\">\n                {actions}\n              </div>\n            )}\n          </div>\n          \n          {/* Stats cards */}\n          {stats && stats.length > 0 && (\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n              {stats.map((stat, idx) => {\n                const StatIcon = stat.icon;\n                return (\n                  <div\n                    key={idx}\n                    className={cn(\n                      \"backdrop-blur-xl bg-white/80 rounded-xl p-4 border\",\n                      theme.borders.light,\n                      theme.shadows.card,\n                      \"transition-all duration-300 hover:scale-105\"\n                    )}\n                  >\n                    <div className=\"flex items-center justify-between mb-2\">\n                      <span className=\"text-sm text-slate-600 font-medium\">\n                        {stat.label}\n                      </span>\n                      {StatIcon && (\n                        <StatIcon className={cn(\"w-4 h-4\", theme.text.primary)} />\n                      )}\n                    </div>\n                    <div className=\"flex items-end gap-2\">\n                      <span className={cn(\n                        \"text-2xl font-bold\",\n                        theme.text.dark\n                      )}>\n                        {stat.value}\n                      </span>\n                      {stat.trend && (\n                        <span className={cn(\n                          \"text-xs font-medium\",\n                          stat.trend === 'up' ? 'text-green-600' : 'text-red-600'\n                        )}>\n                          {stat.trend === 'up' ? '↑' : '↓'}\n                        </span>\n                      )}\n                    </div>\n                  </div>\n                );\n              })}\n            </div>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n","size_bytes":3793}},"version":2}